[{"content":"接口说明 仪器厂商 罗氏E601\n仪器型号 罗氏E601\n通讯方式 双向\n仪器类型 医院名称 程序名称 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：串口☑|网口|监听文件|数据库|其他 连接方式：HL7协议|ASTM协议☑|监听文件|数据库|其他 仪器接口说明 增加稀释倍数上传 串口盒子配置 波特率： 9600 数据位：8 停止位： 1 校验位： N 数据格式 项目通道号 修改记录 序号 日期 操作人 说明 1 2025-04-29 10:57:07\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 /// 名称: MI.MIFCOBASE601 /// 描述: Cobas 6000 仪器接口 New Mode /// 通讯方式：双向 /// 编写者:liuzf /// 编写日期: 20150827 /// MIFCOBASE601(MachID) //仪器结果 s MachID=$g(MachID) S ^TMPMACH10(MachID,104)=$H i \u0026#39;$l(MachID) q s ItemDeli=$li(^dbo.BTMIMachineParameterD(MachID),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(MachID),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(MachID),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(MachID),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(MachID),10) //端口号 //控制字符 s stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4),lf=$c(10),cr=$c(13),nak=$c(21),etb=$c(23) //s stx=\u0026#34;[\u0026#34;,etx=\u0026#34;]\u0026#34; s AllRecord=\u0026#34;\u0026#34; S ^TMPMACH10(MachID,102)=$H i $$Start^MI.MIF000(MachID) q f d Main i $$Stop^MI.MIF000(MachID) q c Port q Main SET $ZTRAP=\u0026#34;ERR\u0026#34; r *R:10 e d q .d ORDER i $c(R)=-1 w nak,*-3 i $c(R)\u0026#39;=enq q d Trace^MI.MIF000(MachID,\u0026#34;ENQ\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) d ACK f r *R:10 q:$c(R)=eot q:R=-1 d .i $c(R)\u0026#39;=stx q .s record=$$Read^MI.MIF000(MachID,\u0026#34;\u0026#34;,lf) q:\u0026#39;$l(record) .d Trace^MI.MIF000(MachID,record,\u0026#34;H\u0026lt;--M\u0026#34;) .d ACK .s record=$e(record,1,$l(record)-1) .i $l(record,etb)\u0026gt;1 s AllRecord=$g(AllRecord)_$p($e(record,2,$l(record)-1),etb,1) .i $l(record,etx)\u0026gt;1 s AllRecord=$g(AllRecord)_$p($e(record,2,$l(record)-1),etx,1) .d Result d Trace^MI.MIF000(MachID,$s($c(R)=eot:\u0026#34;EOT\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) d ORDER q Last\t; file result if exist d Trace^MI.MIF000(MachID,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;Result\u0026#34;) i $l(epis),$l(result) d Save^MI.MIF000(MachID,epis,result,date,time,QC) s (epis,result,date,time,QC)=\u0026#34;\u0026#34; q Result //s num=$o(^TMP(mi,\u0026#34;\u0026#34;),-1)+1 //s ^TMP(mi,num)=AllRecord s headstr=\u0026#34;\u0026#34; f k=1:1:$l(AllRecord,cr) d .s record=$p(AllRecord,cr,k) .i $e(record,1)=\u0026#34;H\u0026#34; d q ..s (sample,epis,surname,rec,res,result,date,time,QC)=\u0026#34;\u0026#34; ..s headstr=\u0026#34;1\u0026#34;_record .i $e(record,1)=\u0026#34;Q\u0026#34; d q ..;Q|1|^^ 55163517^0^5066^1^^S1^SC||ALL||||||||A ..S sampleID=$P($P(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,3) ..S sampleInfo=$P($P(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4,9) ..S labno=$TR(sampleID,\u0026#34; *\u0026#34;) ..s rack=$tr($p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,5),\u0026#34; \u0026#34;) ..s pos=$tr($p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,6),\u0026#34; \u0026#34;) ..;s retVal=$$ReceiveLabno^MI.MIF000(MachID,labno,rack_pos) ..;i retVal\u0026#39;=1 Quit ..i $l(labno) S ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,labno)=sampleID_$C(2)_sampleInfo_$c(2)_rack_$c(2)_pos // .i $e(record,1)=\u0026#34;O\u0026#34; d q ..;-------双向取条码号--- ..s epis=$tr($p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) ..i \u0026#39;$l(epis) s epis=$tr($p($p(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) . ; result record .i $e(record,1)=\u0026#34;R\u0026#34; d q ..;R|1|^^^50/1/not|3.38|ng/ml||N||F|||||E11 ..;R|2|^^^64//not|2.00|IU/L||LL||F|||||E22 ..s code=$p($p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4),\u0026#34;/\u0026#34;,1) ..s res=$p(record,\u0026#34;|\u0026#34;,4) ..i res[\u0026#34;^\u0026#34; s res=$p(res,\u0026#34;^\u0026#34;,2) ..s res=$tr(res,\u0026#34; \u0026#34;) ..s Flag=$p(record,\u0026#34;|\u0026#34;,7) ..i Flag=\u0026#34;LL\u0026#34; s res=\u0026#34;\u0026lt;\u0026#34;_res ..i Flag=\u0026#34;HH\u0026#34; s res=\u0026#34;\u0026gt;\u0026#34;_res ..i $l(code),$l(res) s result=result_code_ResultDeli_res_ItemDeli .; last record .i $e(record,1)=\u0026#34;L\u0026#34; d Last i $l(AllRecord) s AllRecord=$p(AllRecord,cr,$l(AllRecord,cr)) q ORDER ;ORDER LIST ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,epis i \u0026#39;$d(^TMP($zn)) q i \u0026#39;$d(^TMP($zn,$j)) q s labno=\u0026#34;\u0026#34; f s labno=$o(^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,labno)) q:labno=\u0026#34;\u0026#34; d .s requestData=^(labno) .s sampleID=$P(requestData,$C(2),1) .s sampleInfo=$P(requestData,$C(2),2) .s $p(headstr,\u0026#34;|\u0026#34;,11)=\u0026#34;TSDWN^REPLY\u0026#34; .s headstr=headstr_cr .//20140403 .s rackid=$p(requestData,$c(2),3) .s posid=$p(requestData,$c(2),4) .///保存位置号20110621 huhm .//d SetTSMachPos^MIF000(mi,labno,rackid,posid) .// .d ScanOne^MI.MIF000(MachID,labno) .s patstr=$$PATDET(labno)_cr .s tcx=\u0026#34;\u0026#34;,episx=labno .//s ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID,labno,49)=\u0026#34;\u0026#34; .//s ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID,labno,50)=\u0026#34;\u0026#34; .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID,labno,chl)) q:chl=\u0026#34;\u0026#34; d ..;i chl=\u0026#34;148\u0026#34; d ...;s tcx=tcx_\u0026#34;^^^\u0026#34;_chl_\u0026#34;^20\\\u0026#34; ..;e s tcx=tcx_\u0026#34;^^^\u0026#34;_chl_\u0026#34;^\\\u0026#34; ..s XSBS=$g(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID,labno,chl)) ..d Trace^MI.MIF000(MachID,chl_\u0026#34;项目稀释\u0026#34;_XSBS_\u0026#34;倍\u0026#34;,\u0026#34;稀释倍数\u0026#34;) ..s tcx=tcx_\u0026#34;^^^\u0026#34;_chl_\u0026#34;^\u0026#34;_XSBS_\u0026#34;\\\u0026#34; .s tcx=$e(tcx,1,$l(tcx)-1) .s SpecimenDR=\u0026#34;\u0026#34; .s VisNumDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $l(VisNumDR) s SpecimenDR=$lg(^dbo.RPVisitNumberD(VisNumDR),56) .S specimenTypeID=\u0026#34;1\u0026#34;,specimenType=\u0026#34;血\u0026#34; .I $L(SpecimenDR) D ..S specimenType=$lg($g(^dbo.BTSpecimenD(SpecimenDR)),3) .//标本类型代码,1=血清/血浆,2=尿,3=脑脊液,4=supmt,5=其他 .S specimenID=$S(specimenType[\u0026#34;血\u0026#34;:1,specimenType[\u0026#34;尿\u0026#34;:2,specimenType[\u0026#34;脑脊液\u0026#34;:3,1:1) .///O|1| CEA-10|0^5012^2^^S1^SC|^^^49^|R||||||N||||1|||||||20140324140016|||F .S ordstr=\u0026#34;O|1|\u0026#34;_sampleID_\u0026#34;|\u0026#34;_sampleInfo_\u0026#34;|\u0026#34; .S ordstr=ordstr_tcx_\u0026#34;|R||\u0026#34;_$TR($ZD($P($H,\u0026#34;,\u0026#34;,1),3),\u0026#34;-\u0026#34;)_$TR($ZT($P($H,\u0026#34;,\u0026#34;,2),1),\u0026#34;:\u0026#34;)_\u0026#34;||||N||||\u0026#34;_specimenID_\u0026#34;||||||||||O|||||\u0026#34;_cr .///L .s endstr=\u0026#34;L|1|N\u0026#34;_cr .s str=headstr_patstr_ordstr_endstr .d Send(labno,str) k ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;) q PATDET(epis) ; set patient details record s retstr=\u0026#34;P|1\u0026#34; q retstr Send(epis,str) ; send list of orders if exists w enq,*-3 d Trace^MI.MIF000(MachID,\u0026#34;ENQ\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q d Trace^MI.MIF000(MachID,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) i $c(R)=enq q i $c(R)\u0026#39;=ack w eot,*-3 d Trace^MI.MIF000(MachID,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q i $l(str)\u0026gt;241 d .s str1=$e(str,1,241) .s ret=$$SEND(str1,1) .s str2=\u0026#34;2\u0026#34;_$e(str,242,$l(str)) .s ret=$$SEND(str2,0) e d .s ret=$$SEND(str,0) //f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q //d Trace^MI.MIF000(MachID,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;2H\u0026lt;--M\u0026#34;) w eot,*-3 d Trace^MI.MIF000(MachID,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q h 0.2 q ERR h 10 s ^TMPMachErr(+MachID,$j)=$ZERROR_\u0026#34;.错误代码:\u0026#34;_$ECODE q SEND(str,flag) ; send string to instrument i flag=1 d .s str=str_etb .s chsum=$$CHSUM(str) e d .s str=str_etx .s chsum=$$CHSUM(str) w stx,str,chsum,cr,lf,*-3 d Trace^MI.MIF000(MachID,str_chsum,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:6 r *R:1 i ($c(R)=ack)!($c(R)=eot) q i $c(R)=ack d Trace^MI.MIF000(MachID,\u0026#34;ACK\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 i $c(R)=eot d Trace^MI.MIF000(MachID,\u0026#34;EOT\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 i $c(R)=-1 w nak,*-3 d Trace^MI.MIF000(MachID,R,\u0026#34;H\u0026lt;--M\u0026#34;) q 1 ///w $$CHSUM^MI.MIFCOBASE601(\u0026#34;3O^0101001N01300043225^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^M^^^20200115^1.021^59M^\u0026#34;) CHSUM(x) ; calculate check sum n (x) s z=0 f y=1:1:$l(x) s z=z+$a(x,y) s z=$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#256\\16+1)_$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#16+1) q z ///发送回应符到仪器 ACK h 0.2 s ack=$c(6) w ack,*-3 d Trace^MI.MIF000(MachID,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q NEXTTRAY(tray) q tray ","date":"2025-09-02T00:00:00Z","image":"https://work.717170.xyz/img/title.jpg","permalink":"https://work.717170.xyz/p/%E7%BD%97%E6%B0%8Fe601-20250902171037/","title":"罗氏E601"},{"content":"接口说明 仪器厂商 罗氏流水线\n仪器型号 IT3000\n通讯方式 主动上传\n仪器类型 生化发光流水线 医院名称 厦门翔安医院 程序名称 MI.MIFIT3000 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：监听文件 连接方式：抓取RESULT结果文件和SEEN处理文件 .hl7文件，上传ORDERS .hl7文件 仪器接口说明 罗氏流水线与lis交互分为处理文件 SEEN 和结果文件 RESULT 两种以及血清图片，处理文件过多，lis读取文件和解析文件同时进行，造成结果文件无法及时解析，造成仪器传了结果但是未及时读取造成无法及时发报告。针对这一问题，详细在问题处理中无法及时读取文件处理造成获取结果过慢记录。 接口中包含多种功能，包含血清图片，自动核收，报警信息存储等。详细在仪器个性功能中展示。 数据格式 修改记录 序号 日期 操作人 说明 1 2025-04-03 10:15:50\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848 849 850 851 852 853 854 855 856 857 858 859 860 861 862 863 864 865 866 867 868 869 870 871 872 873 874 875 876 877 878 879 880 881 882 883 884 885 886 887 888 889 890 891 892 893 894 895 896 897 898 899 900 901 902 903 904 905 906 907 908 909 910 911 912 913 914 915 916 917 918 919 920 921 922 923 924 925 926 927 928 929 930 931 932 933 934 935 936 937 938 939 940 941 942 943 944 945 946 947 948 949 950 951 952 953 954 955 956 957 958 959 960 961 962 963 964 965 966 967 968 969 970 971 972 973 974 975 976 977 978 979 980 981 982 983 984 985 986 987 988 989 990 991 992 993 994 995 996 997 998 999 1000 1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 1011 1012 1013 1014 1015 1016 1017 1018 1019 1020 1021 1022 1023 1024 1025 1026 1027 1028 1029 1030 1031 1032 1033 1034 1035 1036 1037 1038 1039 1040 1041 1042 1043 1044 1045 1046 1047 1048 1049 1050 1051 1052 1053 1054 1055 1056 1057 1058 1059 1060 1061 1062 1063 1064 1065 1066 1067 1068 1069 1070 1071 1072 1073 1074 1075 1076 1077 1078 1079 1080 1081 1082 1083 1084 1085 1086 1087 1088 1089 1090 1091 1092 1093 1094 1095 1096 1097 1098 1099 1100 1101 1102 1103 1104 1105 1106 1107 1108 1109 1110 1111 1112 1113 1114 1115 1116 1117 1118 1119 1120 1121 1122 1123 1124 1125 /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;Z:\\\\ResultExport\\\\\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFLICA800\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.csv\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;Z:\\\\Imports\\\\\u0026#34;}] Class MI.MIFIT3000N1 Extends %RegisteredObject { /// D ##class(MI.MIFInfinity).fileMTHD(\u0026#34;7\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#\u0026#34;,\u0026#34;\u0026#34;) /// seen: [VT]#enter#MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR] /// result: [VT]#enter#MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR] /// D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) /// seen: D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;[VT]#enter#MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]\u0026#34;,\u0026#34;\u0026#34;) /// result:D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;[VT]#enter#MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]\u0026#34;,\u0026#34;\u0026#34;) /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\Results,E:\\\\Temp\\\\Temp\\\\Interface\\\\Seens\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFXAIT3000\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.hl7\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoMAll,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealImage,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\ORDERS\\\\\u0026#34;}] /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\Results,E:\\\\Temp\\\\Temp\\\\Interface\\\\Seens\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFXAIT3000\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.hl7\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoMAll,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\ORDERS\\\\\u0026#34;}] /// D ##class(MI.MIFIT300N).fileMTHD(\u0026#34;34\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|LIS||HOST||20250317162926||ORU^R01^ORU_R01|20250317162926573175|P|2.5|||AL|ER[13][10]PID|1||0000486028||^郑龙怡||20000126|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^感染性疾病科[13][10]ORC|SC|1003777033|||CM||||20250317160618[13][10]OBR|1|1003777033|||||||||||||||||||||||F[13][10]OBX|1|NM|TRAB^TRAB||\u0026lt;0.800|||LIMTL|||F|||20250317170643|E1^MU1-e801-1-2@5503[13][10]NTE|1||LIMTL[13][10]NTE|1||LIMTL[13][10]\u0026#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(\u0026#34;34\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|LIS||HOST||20250320102229||ORU^R01^ORU_R01|20250320102229442999|P|2.5|||AL|ER[13][10]PID|1||0000481255||^杨建利||19880623|M[13][10]PV1|1|U||||||||109|||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003782597|||CM||||20250320084145||||||||109[13][10]OBR|1|1003782597|||||||||||||||||||||||F[13][10]OBX|1|NM|GLU^GLU||8.830||||||F|||20250320100301|C2^MU1-c702-2-2@5607[13][10]OBX|2|NM|UREA^UREA||4.330||||||F|||20250320100306|C2^MU1-c702-2-1@5607[13][10]OBX|3|NM|UA^UA||434.900||||||F|||20250320100254|C2^MU1-c702-2-2@5607[13][10]OBX|4|NM|TP^TP||79.900||||||F|||20250320095858|C1^MU1-c702-1-1@5607[13][10]OBX|5|NM|ALB^ALB||46.000||||||F|||20250320095348|C1^MU1-c702-1-2@5607[13][10]OBX|6|NM|TBIL^TBIL||6.000||||||F|||20250320095923|C1^MU1-c702-1-1@5607[13][10]OBX|7|NM|DBIL^DBIL||1.800||||||F|||20250320095901|C1^MU1-c702-1-1@5607[13][10]OBX|8|NM|ALT^ALT||107.000||||||F|||20250320095900|C1^MU1-c702-1-2@5607[13][10]OBX|9|NM|AST^AST||62.300||||||F|||20250320095909|C1^MU1-c702-1-1@5607[13][10]OBX|10|NM|RGT^RGT||68.800||||||F|||20250320100259|C2^MU1-c702-2-1@5607[13][10]OBX|11|NM|ALP^ALP||83.700||||||F|||20250320095907|C1^MU1-c702-1-2@5607[13][10]OBX|12|NM|TRIGL^TRIGL||8.810||||||F|||20250320100304|C2^MU1-c702-2-2@5607[13][10]OBX|13|NM|TC^TC||4.910||||||F|||20250320100257|C2^MU1-c702-2-2@5607[13][10]OBX|14|NM|SCRE^SCRE||66.400||||||F|||20250320100313|C2^MU1-c702-2-1@5607[13][10]OBX|15|NM|9CYSC^CYSC_NEW||0.89||||||F|||20250320095916|C1^MU1-c702-1-1@5607[13][10]OBX|16|NM|9HDL^HDL_NEW||0.69||||||F|||20250320095914|C1^MU1-c702-1-2@5607[13][10]OBX|17|NM|9LDL^LDL_NEW||2.06||||||F|||20250320095921|C1^MU1-c702-1-2@5607[13][10]OBX|18|ST|XYZL^DM_SERQ||Z:脂血||||||F|||20250320083356[13][10]\u0026#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(\u0026#34;34\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|LIS||HOST||20250320151725||ORU^R01^ORU_R01|20250320151725880554|P|2.5|||AL|ER[13][10]PID|1||0000095425||^姚程成||19980712|M[13][10]PV1|1|U|||||||||||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003784045|||CM||||20250320104114[13][10]OBR|1|1003784045|||||||||||||||||||||||F[13][10]OBX|1|NM|TP^TP||73.600||||||F|||20250320115059|C1^MU1-c702-1-1@5095[13][10]OBX|2|NM|ALB^ALB||49.600||||||F|||20250320114553|C1^MU1-c702-1-2@5095[13][10]OBX|3|NM|TBIL^TBIL||16.400||||||F|||20250320115110|C1^MU1-c702-1-1@5095[13][10]OBX|4|NM|DBIL^DBIL||4.400||||||F|||20250320115056|C1^MU1-c702-1-1@5095[13][10]OBX|5|NM|ALT^ALT||18.100||||||F|||20250320115057|C1^MU1-c702-1-2@5095[13][10]OBX|6|NM|AST^AST||22.900||||||F|||20250320115103|C1^MU1-c702-1-1@5095[13][10]OBX|7|NM|RGT^RGT||8.900||||||F|||20250320115522|C2^MU1-c702-2-1@5095[13][10]OBX|8|NM|ALP^ALP||78.100||||||F|||20250320115105|C1^MU1-c702-1-2@5095[13][10]\u0026#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(\u0026#34;34\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|LIS||HOST||20250321083434||ACK^^ACK|20250321083434378641|P|2.5|||NE|NE[13][10]EQU||^^^c702^^SAMPLEEVENT^SEEN|20250321083434[13][10]SAC|||1003775669|1003775669||20250321083433|01||P|c702|5719@4[13][10]\u0026#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(\u0026#34;34\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|LIS||HOST||20250328191032||ORU^R01^ORU_R01|20250328191032737830|P|2.5|||AL|ER[13][10]PID|1||0000531818||^郑苹||19811117|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^心血管内科[13][10]ORC|SC|1003802907|||CM||||20250328191358[13][10]OBR|1|1003802907|||||||||||||||||||||||F[13][10]OBX|1|NM|U-CR^U-CR||5924.00||||||F|||20250328200846|C2^MU1-c702-2-1@4003|||||||||5924.00[13][10]OBX|2|NM|UR-MALB^UR-MALB||15.30|||OBS.RR|||F|||20250328200852|C2^MU1-c702-2-2@4003|||||||||15.30[13][10]NTE|1||OBS.RR[13][10]\u0026#34;) /// 非流水线分区代码 Parameter FQCode = \u0026#34;WANTAI,XINCHANYE,LINJIAN,XIEGUANG\u0026#34;; ClassMethod fileMTHD(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),record=$g(record),epis=$g(epis),filename=$g(filename),P4=$g(P4),P5=$g(P5),P6=$g(P6),P7=$g(P7),P8=$g(P8),P9=$g(P9),P10=$g(P10),P11=$g(P11),P12=$g(P12),P13=$g(P13),Sessions=$g(Sessions) i filename[\u0026#34;Results\u0026#34; j ..ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) q \u0026#34;\u0026#34; e d ..ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) q \u0026#34;\u0026#34; } ClassMethod ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;0\u0026#34; s HospitalDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),4) i \u0026#39;$l(record) q \u0026#34;0\u0026#34; i filename[\u0026#34;Seens\u0026#34; d Trace^MI.MIF000(mi,record,\u0026#34;SeensRecord\u0026#34;) e i filename[\u0026#34;Results\u0026#34; d Trace^MI.MIF000(mi,record,\u0026#34;ResultsRecord\u0026#34;) e d Trace^MI.MIF000(mi,record,\u0026#34;AllRecord\u0026#34;) s recordbak=record\t//仪器数据备份 s commandName=\u0026#34;\u0026#34;\t//前处理名称初始化 s commandchild=\u0026#34;\u0026#34; //前处理命令初始化 s DealDateStr=\u0026#34;\u0026#34; //MSH 时间初始化 s (sample,result,date,time,QC)=\u0026#34;\u0026#34; //解析多行合并数据 f i=1:1:$l(recordbak,\u0026#34;[13][10]\u0026#34;){ s record=$p(recordbak,\u0026#34;[13][10]\u0026#34;,i) ;d Trace^MI.MIF000(mi,record,\u0026#34;解析行数据\u0026#34;) i \u0026#39;$l(record) q s type=$p(record,\u0026#34;|\u0026#34;,1)\t//取出消息头命令类型 //解析MSH命令 i type=\u0026#34;MSH\u0026#34;{ s DateStr=$p(record,\u0026#34;|\u0026#34;,7)\t//取日期串 i $l(DateStr)=14 s DealDateStr=$e(DateStr,1,8)_\u0026#34;,\u0026#34;_(($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60))\t//解析保存日期串 } //解析EQU命令\t包含前处理后处理指令，根据指令记录对应事件 i type=\u0026#34;EQU\u0026#34;{ //前处理名称\tRSA1 流水线处理信息，e801、P501_701\t仪器处理信息 s commandName=$p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4) //获取前处理命令，SEEN 上机事件，RESULT 前处理分区事件，RSA1 未知事件，ARCHIVE 归档事件 s commandchild=$p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,7) ;d Trace^MI.MIF000(mi,commandchild,\u0026#34;前处理命令\u0026#34;) } //解析SAC命令\t根据EQU命令重获取到的前处理事件，进行LIS相关处理 //本接口包括 SEEN 自动核收，ARCHIVE 记录归档位置 i type=\u0026#34;SAC\u0026#34;{ s epis=$p(record,\u0026#34;|\u0026#34;,5)\t//取出流水号 s machCode=$p(record,\u0026#34;|\u0026#34;,11)\t//取出前处理分区信息或仪器信息 s positioninfo=$p(record,\u0026#34;|\u0026#34;,12)\t//取出位置信息 //前处理SEEN 自动核收 i commandchild=\u0026#34;SEEN\u0026#34;{ ;d Trace^MI.MIF000(mi,\u0026#34;分区信息，标本号:\u0026#34;_epis_\u0026#34;的样本所在分区:\u0026#34;_machCode_\u0026#34; \u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) i commandName=\u0026#34;RSA1\u0026#34; j ..SaveRecord(epis,\u0026#34;分区位置:\u0026#34;_machCode_\u0026#34;-\u0026#34;_positioninfo,mi,\u0026#34;100\u0026#34;)\t//前处理分区 e j ..SaveRecord(epis,\u0026#34;上机位置:\u0026#34;_commandName_\u0026#34;-\u0026#34;_positioninfo,mi,\u0026#34;6\u0026#34;)\t//上机 try{d ..ZDHS(mi,epis,machCode,positioninfo)}catch ex{d Trace^MI.MIF000(mi,ex.Data,\u0026#34;自动核收提示\u0026#34;)}\t//自动核收 i commandName=\u0026#34;RSA1\u0026#34; d .i (\u0026#34;,\u0026#34;_..#FQCode_\u0026#34;,\u0026#34;)\u0026#39;[(\u0026#34;,\u0026#34;_machCode_\u0026#34;,\u0026#34;) d\t//$TS$ 只有流水线仪器记录分区架子号 ..j ..SaveRackNo(epis,machCode_\u0026#34;-\u0026#34;_positioninfo,mi,\u0026#34;分区\u0026#34;) e j ..SaveRackNo(epis,commandName_\u0026#34;-\u0026#34;_positioninfo,mi,\u0026#34;上机\u0026#34;) } //前处理RESULT 处理分区信息 i commandchild=\u0026#34;RESULT\u0026#34;{ s curMachName=machCode\t//通过仪器对照码取仪器 //此处存标本全部分区预处理的位置号\t针对非流水线标本分拣 i commandName=\u0026#34;RSA1\u0026#34; j ..SaveRecord(epis,\u0026#34;分区位置:\u0026#34;_positioninfo,mi,\u0026#34;100\u0026#34;)\t//前处理分区 i commandName=\u0026#34;RSA1\u0026#34; j ..SaveRackNo(epis,positioninfo,mi,\u0026#34;分区\u0026#34;) } //前处理ARCHIVE 处理归档信息 i commandchild=\u0026#34;ARCHIVE\u0026#34;{ s curMachName=machCode\t//通过仪器对照码取仪器 //此处存标本全部审核报告的位置号 ;d Trace^MI.MIF000(mi,\u0026#34;归档信息，标本号:\u0026#34;_epis_\u0026#34;的样本所在仪器:\u0026#34;_curMachName_\u0026#34; \u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ;d Trace^MI.MIF000(mi,epis_\u0026#34;执行记录分类信息:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) i commandName=\u0026#34;RSA1\u0026#34; d .j ..SaveRackNo(epis,positioninfo,mi,\u0026#34;归档\u0026#34;)\t//保存归档信息到架子号 .j ..SaveRecord(epis,\u0026#34;冰箱归档位置:\u0026#34;_positioninfo,mi,\u0026#34;62\u0026#34;)\t//冰箱归档 e d .j ..SaveRackNo(epis,positioninfo,mi,\u0026#34;归档中\u0026#34;)\t//保存归档信息到架子号 .j ..SaveRecord(epis,\u0026#34;归档中位置:\u0026#34;_positioninfo,mi,\u0026#34;62\u0026#34;)\t//归档 ;d Trace^MI.MIF000(mi,epis_\u0026#34;记录归档信息完成\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) } } //解析质控数据,P业务数据，Q质控数据 i type=\u0026#34;ORC\u0026#34;{ s epis=$p(record,\u0026#34;|\u0026#34;,3) } i type=\u0026#34;OBR\u0026#34;{ s epis=$p(record,\u0026#34;|\u0026#34;,3) } //仪器报警信息 i type=\u0026#34;NTE\u0026#34;{ s WaringStr=$p(record,\u0026#34;|\u0026#34;,4) s WaringCode=$p(WaringStr,\u0026#34; \u0026#34;,2) ;d Trace^MI.MIF000(mi,\u0026#34;仪器报警信息:\u0026#34;_WaringStr,\u0026#34;H\u0026lt;--M\u0026#34;) //保存仪器报警信息到组内报告评价 ;d ..SaveResultWarned(epis,WaringStr,mi) } try{j ##class(MI.Special.Record).RecordData(epis,recordbak,\u0026#34;LSLSXGET\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 i type=\u0026#34;OBX\u0026#34;{ s machCode=$p(record,\u0026#34;|\u0026#34;,16)\t//仪器信息和架子号信息 s code=$p($p(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1) s res=$p(record,\u0026#34;|\u0026#34;,6) s CallThePolice=$p(record,\u0026#34;|\u0026#34;,9)\t//项目报警信息 s res=..ConvertResult(code,res)\t//结果特殊转换 i $l(CallThePolice) d .s result=result_code_$c(92)_res_$c(92)_$c(92)_CallThePolice_$c(44)\t//YHR 20250328 将报警信息存入到其他结果字段 .try{j ..SaveResultWarned(epis,\u0026#34;存在仪器报警信息\u0026#34;,mi,\u0026#34;41\u0026#34;)}catch{}\t//YHR 20250329 存储报警信息标志，此处41为常规生化工作小组$TS$ e s result=result_code_$c(92)_res_$c(44) } } i $l(result) d Trace^MI.MIF000(mi,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;H\u0026lt;--M\u0026#34;) //统一保存结果 i $l(epis),$l(result){ i $l(DealDateStr){\t//如果记录到时间，则根据仪器时间存储结果。 s date=$p(DealDateStr,\u0026#34;,\u0026#34;,1) s time=$p(DealDateStr,\u0026#34;,\u0026#34;,2) i $l(date)\u0026#39;=8 s date=\u0026#34;\u0026#34;,time=\u0026#34;\u0026#34; } d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) } q \u0026#34;\u0026#34; } /// 结果特殊转换 /// $TS$ /// W ##CLASS(MI.MIFIT3000N1).ConvertResult(\u0026#34;9PA\u0026#34;,\u0026#34;\u0026lt;0.070\u0026#34;) ClassMethod ConvertResult(code, res) { i code=\u0026#34;9PA\u0026#34; d .i $e(res)=\u0026#34;\u0026lt;\u0026#34;,+$e(res,2,*)=\u0026#34;.07\u0026#34; d ..s res=\u0026#34;\u0026lt;70\u0026#34; q res } /// 报警信息转换 ClassMethod ConvertPoliceInfo(WaringCode) { s WaringStr=\u0026#34;\u0026#34; i WaringCode=\u0026#34;5\u0026#34; s WaringStr=\u0026#34;\u0026gt;ABS(超出ABS)\u0026#34; i WaringCode=\u0026#34;43\u0026#34; s WaringStr=\u0026#34;Cal.E(校准结果异常)\u0026#34; i WaringCode=\u0026#34;2\u0026#34; s WaringStr=\u0026#34;\u0026gt;Cuvet(反应杯空白异常)\u0026#34; i WaringCode=\u0026#34;42\u0026#34; s WaringStr=\u0026#34;Edit(实验结果已被编辑)\u0026#34; i WaringCode=\u0026#34;23\u0026#34; s WaringStr=\u0026#34;\u0026gt;ISE(超出ISE范围)\u0026#34; i WaringCode=\u0026#34;19\u0026#34; s WaringStr=\u0026#34;ISE.E(ISE电压级错误)\u0026#34; i WaringCode=\u0026#34;56\u0026#34; s WaringStr=\u0026#34;\u0026gt;Kin(Prozone错误2/运动不稳)\u0026#34; i WaringCode=\u0026#34;10\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; i WaringCode=\u0026#34;11\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; i WaringCode=\u0026#34;6\u0026#34; s WaringStr=\u0026#34;\u0026gt;Prozone(Prozone错误1)\u0026#34; i WaringCode=\u0026#34;4\u0026#34; s WaringStr=\u0026#34;Reag.S(试剂不足)\u0026#34; i WaringCode=\u0026#34;44\u0026#34; s WaringStr=\u0026#34;\u0026gt;Rept(高出原倍复查范围)\u0026#34; i WaringCode=\u0026#34;45\u0026#34; s WaringStr=\u0026#34;\u0026lt;Rept(低于原倍复查范围)\u0026#34; i WaringCode=\u0026#34;46\u0026#34; s WaringStr=\u0026#34;Samp.？(高出ABS最大值)\u0026#34; i WaringCode=\u0026#34;68\u0026#34; s WaringStr=\u0026#34;Samp.B(样本中有气泡)\u0026#34; i WaringCode=\u0026#34;72\u0026#34; s WaringStr=\u0026#34;Samp.C(样本中有凝块)\u0026#34; i WaringCode=\u0026#34;26\u0026#34; s WaringStr=\u0026#34;\u0026gt;Test(高出线性范围)\u0026#34; i WaringCode=\u0026#34;27\u0026#34; s WaringStr=\u0026#34;\u0026lt;Test(低于线性范围)\u0026#34; q WaringStr } /// 记录标本日志 /// D ##class(MI.MIFRS600).SaveRecord(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode, curWorkGroupMachineDR) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s OperateTypeCode=$g(OperateTypeCode) i \u0026#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,\u0026#34;,\u0026#34;,2),\u0026#34;\u0026#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,\u0026#34;\u0026#34;) } /// 保存报告表报警信息标志 /// D ##class(MI.MIFIT3000N1).SaveResultWarned(\u0026#34;1003803130\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;41\u0026#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI, curWorkGroupMachineDR) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) i \u0026#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) i $l(conclusion)\u0026gt;20 s conclusion=$e(conclusion,1,20)_\u0026#34;...\u0026#34; s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } /// 保存评价信息(标本质量) /// D ##class(MI.MIFRS600).SaveConclusion(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveConclusion(labno, conclusion, predealMI, curWorkGroupMachineDR, IsPrint) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s IsPrint=$g(IsPrint) i IsPrint\u0026#39;=1 s IsPrint=\u0026#34;0\u0026#34;\t//1 打印主评价，0 不打印次评价 i \u0026#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i IsPrint=1 d ......i $l(objrep.MajorConclusion) s objrep.MajorConclusion=objrep.MajorConclusion_\u0026#34;,\u0026#34;_conclusion ......e s objrep.MajorConclusion=conclusion ......e d ......i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_\u0026#34;,\u0026#34;_conclusion ......e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i IsPrint=1 d ..s objrep.MajorConclusion=conclusion .e s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } /// 保存归档,分类信息,架子号,新增保存类型和参数工作小组ID，针对仪器不在对应的工作小组也可以保存架子号。 /// D ##class(MI.Special.Common).SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) /// D ##class(MI.Special.Common).SaveRackNo(\u0026#34;1003775669\u0026#34;,\u0026#34;c702-5719@4\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;上机\u0026#34;) ClassMethod SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) { s labno=$g(labno) s positioninfo=$g(positioninfo) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),typename=$g(typename) i \u0026#39;$L(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $l(typename) s positioninfo=typename_\u0026#34;:\u0026#34;_positioninfo s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo) j ..SaveRecord(labno,\u0026#34;架子号位置更新:\u0026#34;_objrep.RackNo_\u0026#34;--\u0026gt;\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;)\t//架子号更新 .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,\u0026#34;-1^存\u0026#34;_typename_\u0026#34;信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i $l(objrep.RackNo) j ..SaveRecord(labno,\u0026#34;架子号位置更新:\u0026#34;_objrep.RackNo_\u0026#34;--\u0026gt;\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;)\t//架子号更新 .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q hasFindRep } /// 保存标本图片 /// D ##class(MI.MIFRS600).SaveImageMTHD(\u0026#34;57\u0026#34;,\u0026#34;1000100990\u0026#34;,\u0026#34;P\u0026#34;,\u0026#34;/iLISLIS080/demo.png\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) /// D ##class(MI.MIFIT3000N1).SaveImageMTHD(\u0026#34;34\u0026#34;,\u0026#34;1003783657_01\u0026#34;,\u0026#34;1003783657_01\u0026#34;,\u0026#34;/iLISLIS032/20250321/1003783657_01.jpg\u0026#34;,\u0026#34;C:\\LISDATA\\DATA\\1003783657_01.jpg\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s ^YHR(\u0026#34;MI.MIFIT3000\u0026#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=\u0026#34;1\u0026#34; s epis=$p(epis,\u0026#34;_\u0026#34;,1) s ImageClass=\u0026#34;P\u0026#34;_+$p(ImageClass,\u0026#34;_\u0026#34;,2) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=\u0026#34;\u0026#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=\u0026#34;\u0026#34; f s RowID=$o(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=\u0026#34;\u0026#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i \u0026#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=\u0026#34;SerumQ\u0026#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= \u0026#34;-1^保存报告图片失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_\u0026#34;:\u0026#34;_ImageClass_\u0026#34;:\u0026#34;_FileName,\u0026#34;H\u0026lt;--M\u0026#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=\u0026#34;\u0026#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // w ##class(MI.MIFRS600).GetFtpMTHD(\u0026#34;24\u0026#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = \u0026#34;labno,labnoInfo,patInfo\u0026#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(\u0026#34;MI.MIFIT3000N1\u0026#34;,\u0026#34;QryLabInfo\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; s LabnoList=\u0026#34;\u0026#34; s VisitNumberDR=\u0026#34;\u0026#34; s OutPutNum=0 //*--------------------------------\u0026gt;*申请项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate)) q:(AddDate=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;6) d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime)) q:(AddTime=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;6) d ..s OutPutNum=OutPutNum+1 ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i \u0026#39;$l(EpisNo) q ..i \u0026#39;$l(labno) q ..i \u0026#39;$d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno)) q ..s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..s ReceiveTime=$lg($g(^dbo.RPVisitNumberD(VisitNumberDR)),67) ..i ((+$p($h,\u0026#34;,\u0026#34;,2))-ReceiveTime\u0026gt;=-2)\u0026amp;\u0026amp;((+$p($h,\u0026#34;,\u0026#34;,2))-ReceiveTime\u0026lt;5) d Trace^MI.MIF000(mi,labno_\u0026#34;标本接收时间低于5秒不上传\u0026#34;,\u0026#34;等待上传\u0026#34;) q ..//得到通道号 ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@C\u0026#34;\t//重新获取通道号 避免因为接收造成漏项目 ..;s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..;s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;|@U\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;申请上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;C@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** //*--------------------------------\u0026gt;*复查结果上传 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;|@U\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;复查上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;U@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** //*--------------------------------\u0026gt;*取消项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@R\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;取消上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;R@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=labno_\u0026#34;,\u0026#34;_\u0026#34;DM_OVER\u0026#34;_\u0026#34;@C\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;审核上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;T@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=\u0026#34;labno,labnoInfo,patInfo\u0026#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=\u0026#34;\u0026#34; { Set AtEnd=1 Set Row=\u0026#34;\u0026#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 获取申请名称和内容 /// 申请名称： /// 发送申请：order_2012051718302501_9999999901NW.HL7 /// 取消申请：order_2012051718302501_9999999901CA.HL7 /// 项目复查：order_2012051718302501_9999999901XO.HL7 /// w ##class(MI.MIFRS600).GetLisOrderMTHD(\u0026#34;8\u0026#34;,\u0026#34;POS@C@1\u0026#34;,\u0026#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08 -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34; ,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) /// w ##class(MI.MIFIT300N).GetLabnoInfoN(\u0026#34;34\u0026#34;,\u0026#34;1003779663,DM_OVER@C\u0026#34;,\u0026#34;2025-03-18□19:07:07,IT3000,,,,急诊内科,测试医生(勿选）,检验管理员,0000243381,陈耀明,1,急诊,,34,,1003779663,2025-03-18□18:24,,,,,眩晕,,,,2025-03-18□18:24,,,19900920\u0026#34;) ClassMethod GetLabnoInfoN(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s VT=\u0026#34;[11]\u0026#34;,FS=\u0026#34;[28]\u0026#34;,CR=\u0026#34;[13]\u0026#34; s labNo=$p(patInfo,\u0026#34;,\u0026#34;,16) s Sampleno=$p(patInfo,\u0026#34;,\u0026#34;,3) //i labNo=\u0026#34;74623177\u0026#34; s ^TMP(\u0026#34;zlzit3000d\u0026#34;)=$lb(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s location=$p(patInfo,\u0026#34;,\u0026#34;,6) s docName=$p(patInfo,\u0026#34;,\u0026#34;,7) s regNo=$p(patInfo,\u0026#34;,\u0026#34;,9) s patName=$p(patInfo,\u0026#34;,\u0026#34;,10) s sex=$p(patInfo,\u0026#34;,\u0026#34;,11) i sex=\u0026#34;1\u0026#34; s sex=\u0026#34;M\u0026#34; i sex=\u0026#34;2\u0026#34; s sex=\u0026#34;F\u0026#34; i (sex\u0026#39;=\u0026#34;M\u0026#34;)\u0026amp;\u0026amp;(sex\u0026#39;=\u0026#34;F\u0026#34;) s sex=\u0026#34;U\u0026#34; s birthDate=$p(patInfo,\u0026#34;,\u0026#34;,29) s collectTime=$p(patInfo,\u0026#34;,\u0026#34;,17) ;2017-08-14 11:57 s collectTime=$tr(collectTime,\u0026#34;- :\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;00\u0026#34; s status=$p(labnoInfo,\u0026#34;@\u0026#34;,2) s labnoInfo=$p(labnoInfo,\u0026#34;@\u0026#34;,1) s curTime=$zd($h,8)_$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;,\u0026#34;\u0026#34;) s PatType=$p(patInfo,\u0026#34;,\u0026#34;,12) s Wardno=$p(patInfo,\u0026#34;,\u0026#34;,27) s Diagnose=$p(patInfo,\u0026#34;,\u0026#34;,22) S patTypeFlag=\u0026#34;RO\u0026#34; //门诊=RO,住院=RI,体检=RC,急诊=RS I PatType=\u0026#34;住院\u0026#34; { S patTypeFlag=\u0026#34;RI\u0026#34; } I PatType=\u0026#34;门诊\u0026#34; { S patTypeFlag=\u0026#34;RO\u0026#34; } I PatType=\u0026#34;急诊\u0026#34; { S patTypeFlag=\u0026#34;RS\u0026#34; } I PatType=\u0026#34;体检\u0026#34; { S patTypeFlag=\u0026#34;RC\u0026#34; } I PatType=\u0026#34;干诊\u0026#34; { S patTypeFlag=\u0026#34;RC\u0026#34; } s AssayNo=..GetReportAssayNoMTHD(mi,labNo) s MSN=\u0026#34;MSH|^~\\\u0026amp;|DHC-LIS|IT3000|||||OML^O21|\u0026#34;_$tr($zdt($h,3),\u0026#34; \u0026#34;\u0026#34;:\u0026#34;\u0026#34;-\u0026#34;)_\u0026#34;SND\u0026#34;_labNo_\u0026#34;|P|2.3|||NE|NE||\u0026#34; s PID=\u0026#34;PID|1||\u0026#34;_regNo_\u0026#34;|\u0026#34;_docName_\u0026#34;|^\u0026#34;_patName_\u0026#34;||\u0026#34;_birthDate_\u0026#34;|\u0026#34;_sex //_location s PV1=\u0026#34;PV1|||?|||||||||||||||||\u0026#34; s DG1=\u0026#34;DG1|||00000^default|||F\u0026#34; ;s IN1=\u0026#34;IN1|||China-Bank\u0026#34; ;s ORC=\u0026#34;ORC|NW|\u0026#34;_labNo_\u0026#34;|\u0026#34;_regNo_\u0026#34;||||R||\u0026#34;_$zd($h,8)_$tr($zt($h),\u0026#34;:\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;|\u0026#34;_docName s orcF1=\u0026#34;NW\u0026#34;,orcF2=\u0026#34;\u0026#34; i status=\u0026#34;R\u0026#34; s orcF1=\u0026#34;CA\u0026#34; i status=\u0026#34;U\u0026#34; s orcF1=\u0026#34;XO\u0026#34; s orcF2=\u0026#34;SC\u0026#34; s ORC=\u0026#34;ORC|\u0026#34;_orcF1_\u0026#34;|\u0026#34;_labNo_\u0026#34;|\u0026#34;_AssayNo_\u0026#34;||\u0026#34;_orcF2_\u0026#34;||\u0026#34;_patTypeFlag_\u0026#34;|\u0026#34;_location_\u0026#34;|\u0026#34;_..GetReceiveDateTime(labNo) //change by sch20210421 //s:orcF1\u0026#39;=\u0026#34;XO\u0026#34; ORC=\u0026#34;ORC|\u0026#34;_orcF1_\u0026#34;|\u0026#34;_labNo_\u0026#34;|\u0026#34;_AssayNo_\u0026#34;||\u0026#34;_orcF2_\u0026#34;||\u0026#34;_patFLAG_\u0026#34;||\u0026#34;_$tr($zdt($h,3),\u0026#34; \u0026#34;\u0026#34;:\u0026#34;\u0026#34;-\u0026#34;) //_\u0026#34;|\u0026#34;_docName //\u0026#34;_regNo_\u0026#34; ;s NTE=\u0026#34; NTE||I|Code: C1 Comment: Sample comment 1|\u0026#34; s obrF1=\u0026#34;A\u0026#34; i status=\u0026#34;U\u0026#34; s obrF1=\u0026#34;G\u0026#34; //OBR||2012081501||ROCHE_AFP|||20120814160023|||9999|A s OBR=\u0026#34;OBR||\u0026#34;_labNo_\u0026#34;||GLU|||||||\u0026#34;_obrF1 //\u0026#34;_collectTime_\u0026#34; ;s OBX=\u0026#34;OBX|2|ST|AHBS^6012^||45.290^Instrument flag!|mol/L| - ^^||5221^1||F|||20170816152751|356^COBAS8000B:E602C2|DATOS_PRJ^16-8月 -17^^|\u0026#34; s OBRs=\u0026#34;\u0026#34; i $p(labnoInfo,\u0026#34;@\u0026#34;,1)=\u0026#34;POS\u0026#34; d .s OBRs=\u0026#34;OBR||\u0026#34;_labNo_\u0026#34;||POS|||\u0026#34;_collectTime_\u0026#34;||||\u0026#34;_obrF1 e d .d GetOBRs //s orderTxt=VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS s orderTxt=VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS q orderTxt GetOBRs s items=$tr($p(labnoInfo,\u0026#34;,\u0026#34;,2),\u0026#34;|\u0026#34;,\u0026#34;\u0026#34;) f i=1:1:$l(items,\u0026#34;+\u0026#34;) d .s item=$p(items,\u0026#34;+\u0026#34;,i) .s splitStr=$p(OBR,\u0026#34;|\u0026#34;,5) .s curOBR=$p(OBR,splitStr,1)_item_$p(OBR,splitStr,2) .s OBRs=OBRs_curOBR_CR q } // w ##Class(MI.MIFIT3000).GetReportAssayNoMTHD(8,\u0026#34;1905074122\u0026#34;) ClassMethod GetReportAssayNoMTHD(mi, labno, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { S mi= $G(mi) S labno= $G(labno) i \u0026#39;$l(labno) q \u0026#34;\u0026#34; i \u0026#39;$l(mi) q \u0026#34;\u0026#34; s (orderno,VisitNumberDR)=\u0026#34;\u0026#34; s labno=\u0026#34;\u0026#34;_labno s WGMDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i \u0026#39;$l(WGMDR) q \u0026#34;\u0026#34; S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) s orderno=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WGMDR,\u0026#34;\u0026#34;)) i \u0026#39;$l(orderno) q \u0026#34;\u0026#34; s reportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WGMDR,orderno,\u0026#34;\u0026#34;)) s AssayNo =$lg($g(^dbo.RPVisitNumberReportD(reportDR)),8) Q AssayNo } /// W ##class(MI.MIFIT300N).GetReceiveDateTime(\u0026#34;1003775372\u0026#34;) ClassMethod GetReceiveDateTime(Labnum) { q:\u0026#39;$l(Labnum) \u0026#34;\u0026#34; s VisitnumberDR=\u0026#34;\u0026#34;,ReceiveDate=\u0026#34;\u0026#34;,ReceiveTime=\u0026#34;\u0026#34;,ReceiveDateTime=\u0026#34;\u0026#34; s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,\u0026#34;\u0026#34;_Labnum,\u0026#34;\u0026#34;)) s:$l(VisitnumberDR) ReceiveDate=$lg(^dbo.RPVisitNumberD(VisitnumberDR),66) s:$l(VisitnumberDR) ReceiveTime=$lg(^dbo.RPVisitNumberD(VisitnumberDR),67) s:$l(ReceiveDate)\u0026amp;$l(ReceiveTime) ReceiveDateTime=ReceiveDate_$tr($zt(ReceiveTime),\u0026#34;:\u0026#34;) q ReceiveDateTime } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) /// w ##Class(MI.MIFIT3000N1).GetLabnoInfo(34,\u0026#34;8000001003\u0026#34;) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=\u0026#34;\u0026#34; s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) q:chl=\u0026#34;\u0026#34; d .s tcx=tcx_chl_\u0026#34;+\u0026#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno) i $l(tcx) s tcx=labno_\u0026#34;,\u0026#34;_tcx_\u0026#34;|\u0026#34; d Trace^MI.MIF000(mi,tcx,\u0026#34;H--\u0026gt;M\u0026#34;) d Trace^MI.MIF000(56,\u0026#34;共\u0026#34;_$l(tcx,\u0026#34;+\u0026#34;)_\u0026#34;个项目。\u0026#34;_tcx,\u0026#34;H--\u0026gt;M\u0026#34;) //YHR 20230816 将上传信息存入罗氏infinity仪器 q tcx } /// w ##Class(MI.MIFRS600).GetPatInfo(57,9000001912) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) i $l(Instrument) s Instrument=$tr(Instrument,\u0026#34;,\u0026#34;,\u0026#34;^\u0026#34;) s Sampleno=$lg(RPVisitNumberData,6) //病案号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; s WardnoDR=$lg(RPVisitNumberData,26) ;病区 i $l(WardnoDR) s Wardno=$lg($g(^dbo.BTWardD(WardnoDR)),3) s RetString=\u0026#34;\u0026#34; s RetString=$tr(Sampleda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Instrument,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sampleno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sampletype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Feetype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Srcdepno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Srcdocno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Userno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Patno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Patna,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sex,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Pattype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Bedno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Patage,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Ageunit,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reqno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reqda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Reportda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Printflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Resultflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Errflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Diagnose,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Description,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reserve,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Patnamn,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Getda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Wardno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(BarCode,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(BirthDate,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;) q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,\u0026#34;S\u0026#34;,filename) q } /********************************************自动核收开始****************************************************/ /// 仪器主键，条码号，前处理标本分区标识，仪器信息(位置) /// w ##class(MI.MIFIT3000N1).ZDHS(\u0026#34;34\u0026#34;,\u0026#34;8000000352\u0026#34;,\u0026#34;WANTAI\u0026#34;) /// w ##class(MI.MIFIT300N).ZDHS(\u0026#34;34\u0026#34;,\u0026#34;1003779663\u0026#34;,\u0026#34;RSA1\u0026#34;) ClassMethod ZDHS(mi, Labno, MachineCode, positioninfo) { s mi=$g(mi),Labno=$g(Labno),machCode=$g(MachineCode),positioninfo=$g(positioninfo) i \u0026#39;$l(Labno) q \u0026#34;\u0026#34; /*----------\u0026gt;判断该标本是否已接收未核收 开始\u0026lt;----------*/ s QuitFlag=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##class(LIS.Util.Common).IndexData(Labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) s QuitFlag=1 i QuitFlag=1 q \u0026#34;\u0026#34; /*----------\u0026gt;判断该标本是否已接收未核收 结束\u0026lt;----------*/ s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)\t//得到当前仪器关联工作小组信息 s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13)\t//得到仪器工作小组的核收类型 //AcceptFlag为1认为是前处理工作小组，如果是前处理小组，就认为上前处理\t本接口未设置前处理工作小组，未对此流程进行测试 i AcceptFlag=\u0026#34;1\u0026#34; d QCLZDHS e d ZDHS q \u0026#34;\u0026#34; ZDHS d Trace^MI.MIF000(mi,\u0026#34;上仪器,标本号:\u0026#34;_Labno_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,分区位置:\u0026#34;_MachineCode_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;自动核收\u0026#34;) //根据前处理标本分区进行分区自动核收，并且根据分区代码是否核收进行区分 //本接口认为 默认认为罗氏流水线核收，如果分区代码中包含 【BHS】则认为标本不核收，此块代码将仪器传过来的分区代码进行归类 //本接口关联标本分区， WANTAI 万泰--\u0026gt;W，XINCHANYE 新产业--\u0026gt;X，LINJIAN 临检凝血--\u0026gt;L，XIEGUANG 携光--\u0026gt;R，罗氏--\u0026gt;Y，不核收--\u0026gt;N s HsFlag=\u0026#34;Y\u0026#34;,WorkGroupMachineDR=\u0026#34;\u0026#34; i (MachineCode[\u0026#34;WANTAI\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;WANTAI\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;W\u0026#34; .s WorkGroupMachineDR=48\t//未核收且分区是WANTAI i (MachineCode[\u0026#34;XINCHANYE\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;XINCHANYE\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;X\u0026#34; .s WorkGroupMachineDR=50\t//未核收且分区是XINCHANYE i (MachineCode[\u0026#34;LINJIAN\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;LINJIAN\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;L\u0026#34; .s WorkGroupMachineDR=9\t//未核收且分区是LINJIAN i (MachineCode[\u0026#34;XIEGUANG\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;XIEGUANG\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;R\u0026#34; .s WorkGroupMachineDR=67\t//未核收且分区是XIEGUANG i (MachineCode[\u0026#34;BHS_\u0026#34;) d\t;BHS_WANTAI .S MachineCode=$REPLACE(MachineCode,\u0026#34;BHS_\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;N\u0026#34; i MachineCode=\u0026#34;C_C8K886\u0026#34; s MachineCode=\u0026#34;C801\u0026#34; i MachineCode=\u0026#34;C_C8K77\u0026#34; s MachineCode=\u0026#34;C701\u0026#34; i MachineCode=\u0026#34;C8K886\u0026#34; s MachineCode=\u0026#34;C801\u0026#34; i MachineCode=\u0026#34;C8K77\u0026#34; s MachineCode=\u0026#34;C701\u0026#34; i HsFlag=\u0026#34;Y\u0026#34; d .s WorkGroupMachineDR=41\t//未核收且分区不包含BHS_\t默认核收到罗氏流水线 i \u0026#39;$l(WorkGroupMachineDR) q s ret=..ReceiveLabNoByWGM(WorkGroupMachineDR,Labno,$zd(+$h,8)) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) i ret\u0026#39;=\u0026#34;1\u0026#34; d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR\t//自动核收出错显示再对应的工作组 .s SendRet=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收失败\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_Labno_\u0026#34;前处理核收失败:\u0026#34;_ret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) j ..SaveRecord(Labno,\u0026#34;自动核收:\u0026#34;_ret,\u0026#34;\u0026#34;,\u0026#34;14\u0026#34;,WorkGroupMachineDR) q ret QCLZDHS d Trace^MI.MIF000(mi,\u0026#34;上前处理，鉴定号:\u0026#34;_Labno_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;DealInfo\u0026#34;) d Trace^MI.MIF000(mi,\u0026#34;执行核收到前处理\u0026#34;,\u0026#34;DealInfo\u0026#34;) //此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,Labno,\u0026#34;\u0026#34;) d Trace^MI.MIF000(mi,Labno_\u0026#34;核收到前处理返回信息:\u0026#34;_dealret,\u0026#34;DealInfo\u0026#34;) //记录位置信息到报告位置号 d ..SaveRackNo(Labno,positioninfo,mi) i dealret[\u0026#34;标本已核收\u0026#34; q i dealret=\u0026#34;1\u0026#34; d .//写标本操作日志 .d ..SaveRecord(Labno,machCode,mi,\u0026#34;5\u0026#34;) e d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_CurWorkGroupDR .s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收失败\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_Labno_\u0026#34;前处理核收失败:\u0026#34;_dealret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) .//写标本操作日志 .d ..SaveRecord(Labno,dealret,mi,\u0026#34;100\u0026#34;) q } /// Others w ##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(\u0026#34;3\u0026#34;,\u0026#34;1000004476\u0026#34;,\u0026#34;20191105\u0026#34;) /// 按工作小组核收医嘱 /// INPUT: MachID:仪器主键，LabNo：条码号，TransmitDate：上机日期（不传默认当天） /// OutPut: RetValue:1成功 ClassMethod ReceiveLabNoByWGM(WorkGroupMachineDR As %String, LabNo As %String, TransmitDate, RackNo, RuleCode) As %String { s WorkGroupMachineDR=$g(WorkGroupMachineDR) s LabNo=$g(LabNo) s TransmitDate=$g(TransmitDate) s RuleCode=$g(RuleCode) s RackNo=$g(RackNo) s NowDate=$zd($h,8) s RetValue=1 i \u0026#39;$l(TransmitDate) s TransmitDate=NowDate i \u0026#39;$l(WorkGroupMachineDR) q 100 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s WorkGroupMachineName=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) s DepartmentDR=$lg(^dbo.BTWorkGroupD(WorkGroupDR),4) s HospitalDR=$lg(^dbo.BTDepartmentD(DepartmentDR),4) s WorkGroupMachineDesc=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s IndexOperateType=##class(LIS.Util.Common).IndexData(\u0026#34;H\u0026#34;) s AutoDR=$O(^dbo.RPWGMachineAutoI(\u0026#34;IndexOperateType\u0026#34;,IndexOperateType,WorkGroupMachineDR,\u0026#34;\u0026#34;)) i \u0026#39;$l(AutoDR) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未设置自动核收\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未设置自动核收！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未设置自动核收！\u0026#34; } s MachineAutoData=$g(^dbo.RPWGMachineAutoD(AutoDR)) s IsOpen=$LG(MachineAutoData,4) i IsOpen\u0026#39;=1 { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未开启自动核收\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未开启自动核收！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未开启自动核收！\u0026#34; } s CurrentDate = $p($h,\u0026#34;,\u0026#34;,1) s Currenttime = $p($h,\u0026#34;,\u0026#34;,2) //开始时间 s StartDate=$lg(MachineAutoData,5) i $l(StartDate) s StartDate= $zdh(StartDate,8) s StartTime=$lg(MachineAutoData,6) //结束时间 s EndDate=$lg(MachineAutoData,7) i $l(EndDate) s EndDate= $zdh(EndDate,8) s EndTime=$lg(MachineAutoData,8) //时间类型 s TimeType=$lg(MachineAutoData,9) i TimeType=\u0026#34;CT\u0026#34; //连续 { i (CurrentDate\u0026lt;StartDate)||(($l(StartTime))\u0026amp;\u0026amp;(CurrentDate=StartDate)\u0026amp;\u0026amp;(Currenttime\u0026lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期未生效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期未生效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期未生效！\u0026#34; } i (CurrentDate\u0026gt;EndDate)||(($l(EndTime))\u0026amp;\u0026amp;(CurrentDate=EndDate)\u0026amp;\u0026amp;(Currenttime\u0026gt;EndTime) ) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期已失效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期已失效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期已失效！\u0026#34; } } i TimeType=\u0026#34;TS\u0026#34; //时间段 { i (CurrentDate\u0026lt;StartDate)||(($l(StartTime))\u0026amp;\u0026amp;(Currenttime\u0026lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期未生效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期未生效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期未生效！\u0026#34; } i (CurrentDate\u0026gt;EndDate)||(($l(EndTime))\u0026amp;\u0026amp;(Currenttime\u0026gt;EndTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期已失效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期已失效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期已失效！\u0026#34; } } s AcceptUserDR=\u0026#34;\u0026#34; i $l(AutoDR) s AcceptUserDR=$LG($g(^dbo.RPWGMachineAutoD(AutoDR)),10) i \u0026#39;$l(AcceptUserDR) d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR .s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未设置负责人\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未设置核收负责人！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) i \u0026#39;$l(AcceptUserDR) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未设置核收负责人！\u0026#34; s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///判断医嘱是否核收 S AcceptFlag=0 s IsSpecialFlag=0 s CheckItemList=\u0026#34;\u0026#34; s PreReportDR=\u0026#34;\u0026#34; k TestSetList s LabNoType=##Class(LISSP.DHCRPVisitNumber).GetLabNoType(LabNo) s WebNamespace=##Class(OTH.SYSParameter).GetWebNamespace() i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo))){ s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo),\u0026#34;\u0026#34;)) S TestSetDR=\u0026#34;\u0026#34; f { s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR,\u0026#34;\u0026#34;)) i $l(RowID){ s TestSetGroup=\u0026#34;Default\u0026#34; //工作小组下分组类型 s WGMDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),5) i \u0026#39;$l(WGMDR) s CheckItemList=TestSetDR_CheckItemList S AccpetReportDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11) I $L(AccpetReportDR) s AccpetWGMDR=$LG($G(^dbo.RPVisitNumberReportD(AccpetReportDR)),4) I $LG($g(^dbo.BTWorkGroupMachineD(AccpetWGMDR)),13)\u0026#39;=1 continue s AcceptFlag=0 I $L(WGMDR) S AcceptFlag=$LG($g(^dbo.BTWorkGroupMachineD(WGMDR)),13) //是否是前处理小组 I AcceptFlag=1 S PreReportDR= $LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11),IsSpecialFlag=1 I AcceptFlag=1,$D(^dbo.BTTestSetWorkGroupMachineI(\u0026#34;IndexMaster\u0026#34;,TestSetDR,WorkGroupMachineDR)) { //处理报告分组信息 i $d(^dbo.BTWorkGroupMachineRuleTSI(\u0026#34;IndexTestSet\u0026#34;,TestSetDR)) { s WorkGroupMachineRuleDR=\u0026#34;\u0026#34; f{ s WorkGroupMachineRuleDR=$o(^dbo.BTWorkGroupMachineRuleTSI(\u0026#34;IndexTestSet\u0026#34;,TestSetDR,WorkGroupMachineRuleDR)) q:WorkGroupMachineRuleDR=\u0026#34;\u0026#34; s GroupWGMDR=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),4) s IsShow=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),5) i WorkGroupMachineDR\u0026#39;=GroupWGMDR continue i IsShow=\u0026#34;1\u0026#34; continue s TestSetGroup=WorkGroupMachineRuleDR } } s TestSetList(TestSetGroup,TestSetDR)=\u0026#34;\u0026#34; } } } } s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo),\u0026#34;\u0026#34;)) //前处理标本核收 i IsSpecialFlag=1 { I \u0026#39;$D(TestSetList) s RetValue=\u0026#34;-1^无可核收医嘱\u0026#34; q RetValue s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) Set $ZTrap = \u0026#34;ErrorHandle\u0026#34; TSTART s MajorConclusion=\u0026#34;\u0026#34;,OldEpi=\u0026#34;\u0026#34;,MiniConclusion=\u0026#34;\u0026#34; i $l(PreReportDR) s MajorConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),40),MiniConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),41),OldEpi=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),8) s maxEpis=OldEpi s TestSetGroup=\u0026#34;\u0026#34; f{ s TestSetGroup=$o(TestSetList(TestSetGroup)) q:TestSetGroup=\u0026#34;\u0026#34; s objVisitNumberReport=##class(dbo.RPVisitNumberReport).%New() s objVisitNumberReport.VisitNumberDR=VisitNumberDR s objVisitNumberReport.TransmitDate=TransmitDate s objVisitNumberReport.WorkGroupMachineDR=WorkGroupMachineDR S objVisitNumberReport.MajorConclusion=MajorConclusion s objVisitNumberReport.MinorConclusion=MiniConclusion S OrderNo=1 if $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,\u0026#34;1\u0026#34;)) { s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,\u0026#34;\u0026#34;),-1) s OrderNo=(OrderNo +1) } s AssayNo=\u0026#34;\u0026#34; s objVisitNumberReport.OrderNo=OrderNo i ((CommDirection=\u0026#34;UP\u0026#34;)||(CommDirection=\u0026#34;BI\u0026#34;)) s AssayNo=LabNo i \u0026#39;$l(AssayNo) s AssayNo=maxEpis s objVisitNumberReport.AccessionNo=\u0026#34;\u0026#34; ///细菌分离号 s objVisitNumberReport.AssayNo=AssayNo s objVisitNumberReport.EpisodeNo=maxEpis i $l(maxEpis) s ^DHCLABWGMEPSIDERECORD(\u0026#34;WGM\u0026#34;,WorkGroupMachineDR,TransmitDate,maxEpis)=\u0026#34;\u0026#34; s objVisitNumberReport.AcceptDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s objVisitNumberReport.AcceptTime=$p($h,\u0026#34;,\u0026#34;,2) s objVisitNumberReport.AcceptUserDR=AcceptUserDR i $l(RackNo) s objVisitNumberReport.RackNo=RackNo s objVisitNumberReport.Status=1 //报告状态(1登记，2初审，3审核，4复查，5取消审核，6作废，O其他) s ret=objVisitNumberReport.%Save() If ($SYSTEM.Status.IsOK(ret)) {s RetValue=1 } Else {s err=\u0026#34;报告生成失败:\u0026#34;_$SYSTEM.Status.GetErrorText(ret) s RetValue=\u0026#34;-1^\u0026#34;_err q } I \u0026#39;$D(TestSetList(TestSetGroup)) s RetValue=\u0026#34;-1^无可核收医嘱\u0026#34; q s TestSetDR=\u0026#34;\u0026#34; F { s TestSetDR=$o(TestSetList(TestSetGroup,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR,\u0026#34;\u0026#34;)) i $l(RowID){ //修改标本医嘱核收工作小组 s objTestSets=##class(dbo.RPVisitNumberTestSet).%OpenId(RowID) s objTestSets.VisitNumberReportDR=objVisitNumberReport.RowID s objTestSets.WorkGroupMachineDR=WorkGroupMachineDR s sc=objTestSets.%Save() If (\u0026#39;$SYSTEM.Status.IsOK(sc)) { s RetValue=$SYSTEM.Status.GetErrorText(sc) Quit } //按医嘱生成报告项目结果 s RetValue=##Class(LISSP.DHCRPVisitNumberReport).SaveReportTestCode(objVisitNumberReport.RowID,TestSetDR) i RetValue\u0026#39;=1 q } } } i RetValue\u0026#39;=1 TROLLBACK Quit RetValue //删除前处理报告 i $l(PreReportDR),\u0026#39;$d(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,PreReportDR)){ s sc=##class(dbo.RPVisitNumberReport).%DeleteId(PreReportDR) If (\u0026#39;$SYSTEM.Status.IsOK(sc)){s RetValue=\u0026#34;删除报告信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc) } } i RetValue\u0026#39;=1 TROLLBACK Quit RetValue TCOMMIT i $l(WorkGroupMachineDR),$l(maxEpis) s ret=##Class(HIS.DHCCommon).SaveWorkGroupMachineEpis(WorkGroupMachineDR,TransmitDate,maxEpis,\u0026#34;\u0026#34;) } else { //普通标本核收 s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) s Flag=1\t//YHR 20250319 仪器自动核收标志，为1的话，不影响工作小组手动核收序号 s Param=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P0\u0026gt;H\u0026lt;/P0\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P1\u0026gt;\u0026#34;_LabNo_\u0026#34;\u0026lt;/P1\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P3\u0026gt;\u0026#34;_maxEpis_\u0026#34;\u0026lt;/P3\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P4\u0026gt;\u0026#34;_AcceptUserDR_\u0026#34;\u0026lt;/P4\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P8\u0026gt;\u0026#34;_WorkGroupMachineDR_\u0026#34;\u0026lt;/P8\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P12\u0026gt;\u0026#34;_RackNo_\u0026#34;\u0026lt;/P12\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P14\u0026gt;@@1@@\u0026#34;_Flag_\u0026#34;\u0026lt;/P14\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s Sessions=AcceptUserDR_\u0026#34;^\u0026#34;_WorkGroupDR_\u0026#34;^^^\u0026#34;_HospitalDR b ;a KSZDHS s ret=##Class(LISSP.DHCRPVisitNumber).ReceiveVisitNumber(LabNo,Param,Sessions) i $p(ret,\u0026#34;^\u0026#34;,1)\u0026#39;=\u0026#34;1\u0026#34; s RetValue=ret } q RetValue ErrorHandle TROLLBACK s RetValue=\u0026#34;-1^错误\u0026#34;_$tr($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE Quit RetValue } /// Creator： YHR /// CreatDate： 20250320 /// Description： 通过编号规则获取工作小组最大流水号 /// Table： dbo.RPVisitNumberReport /// Input： 工作小组，日期(只能获取当天的，编号规则隔天后会刷新) /// Output： 无 /// Return： 失败:\u0026#34;\u0026#34; 成功:流水号 /// Others\t【原】w ##Class(LIS.Common.DHCVisitNumber).GetMaxMiEpisodeNo(\u0026#34;41\u0026#34;,\u0026#34;20250319\u0026#34;) /// k ^TMP(\u0026#34;MI.MIFIT3000N1.1\u0026#34;,\u0026#34;WGMEpis\u0026#34;,\u0026#34;41\u0026#34;) /// w ##Class(MI.MIFIT3000N1).GetMaxMiEpisodeNo(\u0026#34;41\u0026#34;,\u0026#34;20250319\u0026#34;) ClassMethod GetMaxMiEpisodeNo(WorkGroupMachineDR As %String, TransmitDate As %String) As %String { S TransmitDate=$g(TransmitDate) S WorkGroupMachineDR=$G(WorkGroupMachineDR) S RetValue=\u0026#34;\u0026#34; i \u0026#39;$l(WorkGroupMachineDR) q RetValue i \u0026#39;$l(TransmitDate) s TransmitDate=$zd($h,8) s TransmitDate=$tr(TransmitDate,\u0026#34;-\u0026#34;) //记录该工作小组当天最大的流水号，如果有记录，则优先判断是否核收成功，如果未核收成功仍旧使用该号码 i $d(^TMP($zn,\u0026#34;WGMEpis\u0026#34;,WorkGroupMachineDR,TransmitDate)) d .s JLEpis=$g(^TMP($zn,\u0026#34;WGMEpis\u0026#34;,WorkGroupMachineDR,TransmitDate)) .i \u0026#39;$l(JLEpis) q .i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,JLEpis,TransmitDate)) d ..s RetValue=JLEpis i $l(RetValue) q RetValue //通过编号规则获取当天流水号，编号规则代码设置为工作小组同样代码，通过代码获取工作小组对应的编号规则 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) //YHR 20230810 罗氏流水线规则 i $l(ZDHSEpis) d .i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ..s RetValue=ZDHSEpis .e d ..f Num=1:1:1000 d\t//避免死循环，每次进行一千次增号判断 ...s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) ...i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ....s RetValue=ZDHSEpis ....s Num=1001 i $l(RetValue) s ^TMP($zn,\u0026#34;WGMEpis\u0026#34;,WorkGroupMachineDR,TransmitDate)=RetValue q RetValue //未查询到编号规则，则获取当前工作小组最大流水号 s Parameter=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P0\u0026gt;\u0026#34;_TransmitDate_\u0026#34;\u0026lt;/P0\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s WGMEpisNo=##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(WorkGroupMachineDR,Parameter) //YHR 20250317 获取最大流水号报错问题处理 i $l(WGMEpisNo) s RetValue=WGMEpisNo q RetValue } /********************************************自动核收结束****************************************************/ } 个性化功能记录 本节点无特殊功能，可直接在其他接口使用类似功能。\n自动核收功能 将自动核收单独出来。标准版方法为（##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM），标板使用的功能，是通过仪器对应的工作小组进行核收，流水线仪器为了方便维护以及后续的拓展。此处将仪器主键入参改为了工作小组主键入参。\n修改获取流水号逻辑。标本从仪器开始流水号那里获取，如果多个仪器就会造成维护多个不用的仪器。基于标准版有编号规则维护功能，在此基础上，将获取流水号的逻辑放在了这里。具体方法参考 通过编号规则获取自动核收对应的流水号。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 /// Others w ##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(\u0026#34;3\u0026#34;,\u0026#34;1000004476\u0026#34;,\u0026#34;20191105\u0026#34;) /// 按工作小组核收医嘱 /// INPUT: MachID:仪器主键，LabNo：条码号，TransmitDate：上机日期（不传默认当天） /// OutPut: RetValue:1成功 ClassMethod ReceiveLabNoByWGM(WorkGroupMachineDR As %String, LabNo As %String, TransmitDate, RackNo, RuleCode) As %String { s WorkGroupMachineDR=$g(WorkGroupMachineDR) s LabNo=$g(LabNo) s TransmitDate=$g(TransmitDate) s RuleCode=$g(RuleCode) s RackNo=$g(RackNo) s NowDate=$zd($h,8) s RetValue=1 i \u0026#39;$l(TransmitDate) s TransmitDate=NowDate i \u0026#39;$l(WorkGroupMachineDR) q 100 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s WorkGroupMachineName=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) s DepartmentDR=$lg(^dbo.BTWorkGroupD(WorkGroupDR),4) s HospitalDR=$lg(^dbo.BTDepartmentD(DepartmentDR),4) s WorkGroupMachineDesc=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s IndexOperateType=##class(LIS.Util.Common).IndexData(\u0026#34;H\u0026#34;) s AutoDR=$O(^dbo.RPWGMachineAutoI(\u0026#34;IndexOperateType\u0026#34;,IndexOperateType,WorkGroupMachineDR,\u0026#34;\u0026#34;)) i \u0026#39;$l(AutoDR) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未设置自动核收\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未设置自动核收！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未设置自动核收！\u0026#34; } s MachineAutoData=$g(^dbo.RPWGMachineAutoD(AutoDR)) s IsOpen=$LG(MachineAutoData,4) i IsOpen\u0026#39;=1 { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未开启自动核收\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未开启自动核收！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未开启自动核收！\u0026#34; } s CurrentDate = $p($h,\u0026#34;,\u0026#34;,1) s Currenttime = $p($h,\u0026#34;,\u0026#34;,2) //开始时间 s StartDate=$lg(MachineAutoData,5) i $l(StartDate) s StartDate= $zdh(StartDate,8) s StartTime=$lg(MachineAutoData,6) //结束时间 s EndDate=$lg(MachineAutoData,7) i $l(EndDate) s EndDate= $zdh(EndDate,8) s EndTime=$lg(MachineAutoData,8) //时间类型 s TimeType=$lg(MachineAutoData,9) i TimeType=\u0026#34;CT\u0026#34; //连续 { i (CurrentDate\u0026lt;StartDate)||(($l(StartTime))\u0026amp;\u0026amp;(CurrentDate=StartDate)\u0026amp;\u0026amp;(Currenttime\u0026lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期未生效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期未生效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期未生效！\u0026#34; } i (CurrentDate\u0026gt;EndDate)||(($l(EndTime))\u0026amp;\u0026amp;(CurrentDate=EndDate)\u0026amp;\u0026amp;(Currenttime\u0026gt;EndTime) ) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期已失效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期已失效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期已失效！\u0026#34; } } i TimeType=\u0026#34;TS\u0026#34; //时间段 { i (CurrentDate\u0026lt;StartDate)||(($l(StartTime))\u0026amp;\u0026amp;(Currenttime\u0026lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期未生效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期未生效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期未生效！\u0026#34; } i (CurrentDate\u0026gt;EndDate)||(($l(EndTime))\u0026amp;\u0026amp;(Currenttime\u0026gt;EndTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期已失效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期已失效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期已失效！\u0026#34; } } s AcceptUserDR=\u0026#34;\u0026#34; i $l(AutoDR) s AcceptUserDR=$LG($g(^dbo.RPWGMachineAutoD(AutoDR)),10) i \u0026#39;$l(AcceptUserDR) d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR .s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未设置负责人\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未设置核收负责人！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) i \u0026#39;$l(AcceptUserDR) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未设置核收负责人！\u0026#34; s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///判断医嘱是否核收 S AcceptFlag=0 s IsSpecialFlag=0 s CheckItemList=\u0026#34;\u0026#34; s PreReportDR=\u0026#34;\u0026#34; k TestSetList s LabNoType=##Class(LISSP.DHCRPVisitNumber).GetLabNoType(LabNo) s WebNamespace=##Class(OTH.SYSParameter).GetWebNamespace() i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo))){ s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo),\u0026#34;\u0026#34;)) S TestSetDR=\u0026#34;\u0026#34; f { s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR,\u0026#34;\u0026#34;)) i $l(RowID){ s TestSetGroup=\u0026#34;Default\u0026#34; //工作小组下分组类型 s WGMDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),5) i \u0026#39;$l(WGMDR) s CheckItemList=TestSetDR_CheckItemList S AccpetReportDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11) I $L(AccpetReportDR) s AccpetWGMDR=$LG($G(^dbo.RPVisitNumberReportD(AccpetReportDR)),4) I $LG($g(^dbo.BTWorkGroupMachineD(AccpetWGMDR)),13)\u0026#39;=1 continue s AcceptFlag=0 I $L(WGMDR) S AcceptFlag=$LG($g(^dbo.BTWorkGroupMachineD(WGMDR)),13) //是否是前处理小组 I AcceptFlag=1 S PreReportDR= $LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11),IsSpecialFlag=1 I AcceptFlag=1,$D(^dbo.BTTestSetWorkGroupMachineI(\u0026#34;IndexMaster\u0026#34;,TestSetDR,WorkGroupMachineDR)) { //处理报告分组信息 i $d(^dbo.BTWorkGroupMachineRuleTSI(\u0026#34;IndexTestSet\u0026#34;,TestSetDR)) { s WorkGroupMachineRuleDR=\u0026#34;\u0026#34; f{ s WorkGroupMachineRuleDR=$o(^dbo.BTWorkGroupMachineRuleTSI(\u0026#34;IndexTestSet\u0026#34;,TestSetDR,WorkGroupMachineRuleDR)) q:WorkGroupMachineRuleDR=\u0026#34;\u0026#34; s GroupWGMDR=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),4) s IsShow=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),5) i WorkGroupMachineDR\u0026#39;=GroupWGMDR continue i IsShow=\u0026#34;1\u0026#34; continue s TestSetGroup=WorkGroupMachineRuleDR } } s TestSetList(TestSetGroup,TestSetDR)=\u0026#34;\u0026#34; } } } } s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo),\u0026#34;\u0026#34;)) //前处理标本核收 i IsSpecialFlag=1 { I \u0026#39;$D(TestSetList) s RetValue=\u0026#34;-1^无可核收医嘱\u0026#34; q RetValue s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) Set $ZTrap = \u0026#34;ErrorHandle\u0026#34; TSTART s MajorConclusion=\u0026#34;\u0026#34;,OldEpi=\u0026#34;\u0026#34;,MiniConclusion=\u0026#34;\u0026#34; i $l(PreReportDR) s MajorConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),40),MiniConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),41),OldEpi=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),8) s maxEpis=OldEpi s TestSetGroup=\u0026#34;\u0026#34; f{ s TestSetGroup=$o(TestSetList(TestSetGroup)) q:TestSetGroup=\u0026#34;\u0026#34; s objVisitNumberReport=##class(dbo.RPVisitNumberReport).%New() s objVisitNumberReport.VisitNumberDR=VisitNumberDR s objVisitNumberReport.TransmitDate=TransmitDate s objVisitNumberReport.WorkGroupMachineDR=WorkGroupMachineDR S objVisitNumberReport.MajorConclusion=MajorConclusion s objVisitNumberReport.MinorConclusion=MiniConclusion S OrderNo=1 if $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,\u0026#34;1\u0026#34;)) { s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,\u0026#34;\u0026#34;),-1) s OrderNo=(OrderNo +1) } s AssayNo=\u0026#34;\u0026#34; s objVisitNumberReport.OrderNo=OrderNo i ((CommDirection=\u0026#34;UP\u0026#34;)||(CommDirection=\u0026#34;BI\u0026#34;)) s AssayNo=LabNo i \u0026#39;$l(AssayNo) s AssayNo=maxEpis s objVisitNumberReport.AccessionNo=\u0026#34;\u0026#34; ///细菌分离号 s objVisitNumberReport.AssayNo=AssayNo s objVisitNumberReport.EpisodeNo=maxEpis i $l(maxEpis) s ^DHCLABWGMEPSIDERECORD(\u0026#34;WGM\u0026#34;,WorkGroupMachineDR,TransmitDate,maxEpis)=\u0026#34;\u0026#34; s objVisitNumberReport.AcceptDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s objVisitNumberReport.AcceptTime=$p($h,\u0026#34;,\u0026#34;,2) s objVisitNumberReport.AcceptUserDR=AcceptUserDR i $l(RackNo) s objVisitNumberReport.RackNo=RackNo s objVisitNumberReport.Status=1 //报告状态(1登记，2初审，3审核，4复查，5取消审核，6作废，O其他) s ret=objVisitNumberReport.%Save() If ($SYSTEM.Status.IsOK(ret)) {s RetValue=1 } Else {s err=\u0026#34;报告生成失败:\u0026#34;_$SYSTEM.Status.GetErrorText(ret) s RetValue=\u0026#34;-1^\u0026#34;_err q } I \u0026#39;$D(TestSetList(TestSetGroup)) s RetValue=\u0026#34;-1^无可核收医嘱\u0026#34; q s TestSetDR=\u0026#34;\u0026#34; F { s TestSetDR=$o(TestSetList(TestSetGroup,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR,\u0026#34;\u0026#34;)) i $l(RowID){ //修改标本医嘱核收工作小组 s objTestSets=##class(dbo.RPVisitNumberTestSet).%OpenId(RowID) s objTestSets.VisitNumberReportDR=objVisitNumberReport.RowID s objTestSets.WorkGroupMachineDR=WorkGroupMachineDR s sc=objTestSets.%Save() If (\u0026#39;$SYSTEM.Status.IsOK(sc)) { s RetValue=$SYSTEM.Status.GetErrorText(sc) Quit } //按医嘱生成报告项目结果 s RetValue=##Class(LISSP.DHCRPVisitNumberReport).SaveReportTestCode(objVisitNumberReport.RowID,TestSetDR) i RetValue\u0026#39;=1 q } } } i RetValue\u0026#39;=1 TROLLBACK Quit RetValue //删除前处理报告 i $l(PreReportDR),\u0026#39;$d(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,PreReportDR)){ s sc=##class(dbo.RPVisitNumberReport).%DeleteId(PreReportDR) If (\u0026#39;$SYSTEM.Status.IsOK(sc)){s RetValue=\u0026#34;删除报告信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc) } } i RetValue\u0026#39;=1 TROLLBACK Quit RetValue TCOMMIT i $l(WorkGroupMachineDR),$l(maxEpis) s ret=##Class(HIS.DHCCommon).SaveWorkGroupMachineEpis(WorkGroupMachineDR,TransmitDate,maxEpis,\u0026#34;\u0026#34;) } else { //普通标本核收 s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) s Flag=1\t//YHR 20250319 仪器自动核收标志，为1的话，不影响工作小组手动核收序号 s Param=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P0\u0026gt;H\u0026lt;/P0\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P1\u0026gt;\u0026#34;_LabNo_\u0026#34;\u0026lt;/P1\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P3\u0026gt;\u0026#34;_maxEpis_\u0026#34;\u0026lt;/P3\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P4\u0026gt;\u0026#34;_AcceptUserDR_\u0026#34;\u0026lt;/P4\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P8\u0026gt;\u0026#34;_WorkGroupMachineDR_\u0026#34;\u0026lt;/P8\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P12\u0026gt;\u0026#34;_RackNo_\u0026#34;\u0026lt;/P12\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P14\u0026gt;@@1@@\u0026#34;_Flag_\u0026#34;\u0026lt;/P14\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s Sessions=AcceptUserDR_\u0026#34;^\u0026#34;_WorkGroupDR_\u0026#34;^^^\u0026#34;_HospitalDR s ret=##Class(LISSP.DHCRPVisitNumber).ReceiveVisitNumber(LabNo,Param,Sessions) i $p(ret,\u0026#34;^\u0026#34;,1)\u0026#39;=\u0026#34;1\u0026#34; s RetValue=ret } q RetValue ErrorHandle TROLLBACK s RetValue=\u0026#34;-1^错误\u0026#34;_$tr($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE Quit RetValue } 通过编号规则获取自动核收对应的流水号 本方法通过维护编号规则，编号规则代码与工作小组代码相同时，从编号规则获取对应工作小组流水号。\n避免核收失败流水号浪费造成跳号情况，本方法做出以下处理。\n1.先进行判断编号规则当前号是否在对应工作小组有报告，如果没有的话则还使用当前的流水号再次进行核收，如果有的话，则进入到下一个获取流水号的逻辑。\n2.通过编号规则获取下一个流水号，并进行最大1000次的判断循环取号，避免号重复核收失败。\n3.如果未通过编号规则获取到流水号，获取失败或者没有维护对应的编号规则，则获取当前工作小组最大流水号\n1 [[\u0026#34;0\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;2\u0026#34;,\u0026#34;3\u0026#34;,\u0026#34;4\u0026#34;,\u0026#34;5\u0026#34;,\u0026#34;6\u0026#34;,\u0026#34;7\u0026#34;,\u0026#34;8\u0026#34;,\u0026#34;9\u0026#34;],[\u0026#34;0\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;2\u0026#34;,\u0026#34;3\u0026#34;,\u0026#34;4\u0026#34;,\u0026#34;5\u0026#34;,\u0026#34;6\u0026#34;,\u0026#34;7\u0026#34;,\u0026#34;8\u0026#34;,\u0026#34;9\u0026#34;],[\u0026#34;0\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;2\u0026#34;,\u0026#34;3\u0026#34;,\u0026#34;4\u0026#34;,\u0026#34;5\u0026#34;,\u0026#34;6\u0026#34;,\u0026#34;7\u0026#34;,\u0026#34;8\u0026#34;,\u0026#34;9\u0026#34;],[\u0026#34;0\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;2\u0026#34;,\u0026#34;3\u0026#34;,\u0026#34;4\u0026#34;,\u0026#34;5\u0026#34;,\u0026#34;6\u0026#34;,\u0026#34;7\u0026#34;,\u0026#34;8\u0026#34;,\u0026#34;9\u0026#34;] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 /// Creator： YHR /// CreatDate： 20250320 /// Description： 通过编号规则获取工作小组最大流水号 /// Table： dbo.RPVisitNumberReport /// Input： 工作小组，日期(只能获取当天的，编号规则隔天后会刷新) /// Output： 无 /// Return： 失败:\u0026#34;\u0026#34; 成功:流水号 /// Others\t【原】w ##Class(LIS.Common.DHCVisitNumber).GetMaxMiEpisodeNo(\u0026#34;41\u0026#34;,\u0026#34;20250319\u0026#34;) /// k ^TMP(\u0026#34;MI.MIFIT3000N1.1\u0026#34;,\u0026#34;WGMEpis\u0026#34;,\u0026#34;41\u0026#34;) /// w ##Class(MI.MIFIT3000N1).GetMaxMiEpisodeNo(\u0026#34;41\u0026#34;,\u0026#34;20250403\u0026#34;) ClassMethod GetMaxMiEpisodeNo(WorkGroupMachineDR As %String, TransmitDate As %String) As %String { S TransmitDate=$g(TransmitDate) S WorkGroupMachineDR=$G(WorkGroupMachineDR) S RetValue=\u0026#34;\u0026#34; i \u0026#39;$l(WorkGroupMachineDR) q RetValue i \u0026#39;$l(TransmitDate) s TransmitDate=$zd($h,8) s TransmitDate=$tr(TransmitDate,\u0026#34;-\u0026#34;) s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) //记录该工作小组当天最大的流水号，如果有记录，则优先判断是否核收成功，如果未核收成功仍旧使用该号码 i $d(^dbo.SYSRuleNoBaseI(\u0026#34;IndexCode\u0026#34;,WorkGroupMachineCode)) d .s RuleNoBasDR=$o(^dbo.SYSRuleNoBaseI(\u0026#34;IndexCode\u0026#34;,WorkGroupMachineCode,\u0026#34;\u0026#34;)) .s JLEpis=$lg($g(^dbo.SYSRuleNoBaseD(RuleNoBasDR)),5) .i \u0026#39;$l(JLEpis) q .i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,JLEpis,TransmitDate)) d ..s RetValue=JLEpis i $l(RetValue) q RetValue //通过编号规则获取当天流水号，编号规则代码设置为工作小组同样代码，通过代码获取工作小组对应的编号规则 s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) //YHR 20230810 罗氏流水线规则 i $l(ZDHSEpis) d .i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ..s RetValue=ZDHSEpis .e d ..f Num=1:1:1000 d\t//避免死循环，每次进行一千次增号判断 ...s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) ...i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ....s RetValue=ZDHSEpis ....s Num=1001 i $l(RetValue) q RetValue //未查询到编号规则，则获取当前工作小组最大流水号 s Parameter=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P0\u0026gt;\u0026#34;_TransmitDate_\u0026#34;\u0026lt;/P0\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s WGMEpisNo=##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(WorkGroupMachineDR,Parameter) //YHR 20250317 获取最大流水号报错问题处理 i $l(WGMEpisNo) s RetValue=WGMEpisNo q RetValue } 记录标本操作日志 记录仪器对于标本的操作日志，比如自动核收，上机，归档等信息\n示例：j ..SaveRecord(epis,\u0026ldquo;归档中位置:\u0026quot;_positioninfo,mi,\u0026ldquo;62\u0026rdquo;)\t//归档\n此处62为操作表的Code，操作表为 dbo.BTOperatorType​\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /// 记录标本日志 /// D ##class(MI.MIFRS600).SaveRecord(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode, curWorkGroupMachineDR) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s OperateTypeCode=$g(OperateTypeCode) i \u0026#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,\u0026#34;,\u0026#34;,2),\u0026#34;\u0026#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,\u0026#34;\u0026#34;) } 存储报警信息标志 将报警信息存放到报告表中结果报警信息（ResultWarned）中，该字段为自动审核存储报警信息使用，未验证是否冲突。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /// 保存报告表报警信息标志 /// D ##class(MI.MIFIT3000N1).SaveResultWarned(\u0026#34;1003803130\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;41\u0026#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI, curWorkGroupMachineDR) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) i \u0026#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) i $l(conclusion)\u0026gt;20 s conclusion=$e(conclusion,1,20)_\u0026#34;...\u0026#34; s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } 基于此功能增加报告列表报警信息展示功能\n报警信息存储记录展示 仪器保存到报告表中结果报警信息后，在报告列表进行展示。只有非审核状态标本有此标志，其他状态显示报警信息标志。\nd ##Class(%ResultSet).RunQuery(\u0026ldquo;LIS.WS.BLL.DHCRPReportManage\u0026rdquo;,\u0026ldquo;QryWorkList\u0026rdquo;,\u0026ldquo;NoAuth\u0026rdquo;,\u0026ldquo;2022-11-16\u0026rdquo;,\u0026rdquo;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026ldquo;15\u0026rdquo;,\u0026ldquo;N^^0\u0026rdquo;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026ldquo;8280402^1\u0026rdquo;)\n后台增加输出结果报警信息字段\n1 s ResultWarned=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),49)\t//YHR 20250329 报警信息 1 if (row.ResultWarned != null \u0026amp;\u0026amp; row.ResultWarned.length \u0026gt; 0 \u0026amp;\u0026amp; !row.Status.includes(\u0026#34;3\u0026#34;) ) retInfo = retInfo + \u0026#39;\u0026lt;img src=\u0026#34;../../resource/easyui/themes/icons/abnresult.gif\u0026#34; title=\u0026#34;\u0026#39; + escapeHtml(row.ResultWarned) + \u0026#39;\u0026#34; /\u0026gt;\u0026#39;;\t//YHR 20250329 报告列表显示报警信息 对于报警信息进行转义\n1 2 3 4 5 6 7 8 function escapeHtml(unsafe) { return unsafe .replace(/\u0026amp;/g, \u0026#34;\u0026amp;amp;\u0026#34;) .replace(/\u0026lt;/g, \u0026#34;\u0026amp;lt;\u0026#34;) .replace(/\u0026gt;/g, \u0026#34;\u0026amp;gt;\u0026#34;) .replace(/\u0026#34;/g, \u0026#34;\u0026amp;quot;\u0026#34;) .replace(/\u0026#39;/g, \u0026#34;\u0026amp;#039;\u0026#34;); } 报告处理增加筛选功能 可以快速对于含有报警信息的报告进行快速筛选\n1 \u0026lt;div listranslate=\u0026#34;title~Display expedited report^html~U\u0026amp;报告处理\u0026#34; class=\u0026#34;HISUITheme2\u0026#34; onclick=\u0026#34;SearchReportList(\u0026#39;8\u0026#39;)\u0026#34; style=\u0026#34;background-color: #FFF3E1; color: #AC5919; border: 1px solid #CF8A3B; display: inline-block; border-radius: 4px; width: 16px; height: 16px; text-align: center; line-height: 17px; font-size: 13px; vertical-align: top; cursor: pointer;\u0026#34; onmouseover=\u0026#34;this.style.cursor=\u0026#39;pointer\u0026#39;\u0026#34; title=\u0026#34;展示含有报警信息报告\u0026#34;\u0026gt;警\u0026lt;/div\u0026gt; 1 \u0026lt;div listranslate=\u0026#34;title~Display expedited report^html~U\u0026amp;报告处理\u0026#34; class=\u0026#34;HISUITheme\u0026#34; onclick=\u0026#34;SearchReportList(\u0026#39;8\u0026#39;)\u0026#34; style=\u0026#34;background-color: #dd3838; color: #FFF; border: 1px solid #e91b1b; display: inline-block; border-radius: 4px; width: 16px; height: 16px; text-align: center; line-height: 17px; font-size: 13px; vertical-align: top; cursor: pointer;\u0026#34; onmouseover=\u0026#34;this.style.cursor=\u0026#39;pointer\u0026#39;\u0026#34; title=\u0026#34;展示含有报警信息报告\u0026#34;\u0026gt;警\u0026lt;/div\u0026gt; 1 2 3 4 5 6 else if (Flag == \u0026#34;8\u0026#34;) {\t//YHR 20250331 增加报警信息筛选 //查询已处理危急值 if (obj.ResultWarned.length != 0) { rows.push(obj); } } 存放报警信息或者评价信息 根据科室实际要求来，本接口只是将报警信息存放到其他结果字段，此方法只是扩展补充，将报警信息存放到主评价或者次评价\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 /// 保存评价信息(仪器报警信息等提示信息) /// 条码号或者流水号，存储信息，仪器主键，工作小组(仪器和工作小组非关联使用)，是否打印(1 主评价，0 次评价) /// D ##class(MI.Special.Common).SaveAlarmInformation(\u0026#34;1003791311\u0026#34;,\u0026#34;Lymphopenia：淋巴细胞减少；Anemia：贫血；Reticulocytosis：网织红细胞增多\u0026#34;,\u0026#34;3\u0026#34;) /// D ##class(MI.Special.Common).SaveAlarmInformation(\u0026#34;8000001163\u0026#34;,\u0026#34;Monocytosis：单核细胞增加，Microcytosis：小红细胞症，Anemia：贫血，HGB Defect?：HGB异常？，IG present：幼稚粒细胞存在\u0026#34;,\u0026#34;77\u0026#34;) ClassMethod SaveAlarmInformation(labno, conclusion, predealMI, curWorkGroupMachineDR, IsPrint) { s labno=$g(labno),conclusion=$g(conclusion),predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),IsPrint=$g(IsPrint) i \u0026#39;$l(predealMI),\u0026#39;$l(curWorkGroupMachineDR) q \u0026#34;\u0026#34; i IsPrint\u0026#39;=1 s IsPrint=\u0026#34;0\u0026#34;\t//1 打印主评价，0 不打印次评价 i \u0026#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....;i Status=\u0026#34;3\u0026#34; q\t//审核后的标本存储报警信息，测试用 .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i IsPrint=1 d ......i $l(objrep.MajorConclusion) s objrep.MajorConclusion=objrep.MajorConclusion_\u0026#34;,\u0026#34;_conclusion ......e s objrep.MajorConclusion=conclusion .....e d ......i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_\u0026#34;,\u0026#34;_conclusion ......e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i IsPrint=1 d ..s objrep.MajorConclusion=conclusion .e s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) try{D ##class(MI.Special.Common).SaveResultWarned(labno,conclusion,predealMI, curWorkGroupMachineDR)}catch{}\t//保存至报告表报警信息 q \u0026#34;1\u0026#34; } 存储架子号信息以及标本操作日志记录 标本在流水线上有分区，上机，标本位置变化和标本归档等操作。之前查询标本位置需要在仪器软件上进行搜索查看，基于流水线本身会传输标本在流水线上的相关信息，因此对于这些信息解析。并将这些信息，存放至标本操作日志，将标本当前位置存放至架子号。\n本初增加额外的标本操作类型，101，架子号更新，避免仪器传错信息，仍旧可以有地方记录查看。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 /// 保存归档,分类信息,架子号,新增保存类型和参数工作小组ID，针对仪器不在对应的工作小组也可以保存架子号。 /// D ##class(MI.Special.Common).SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) /// D ##class(MI.Special.Common).SaveRackNo(\u0026#34;1003775669\u0026#34;,\u0026#34;c702-5719@4\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;上机\u0026#34;) /// D ##class(MI.Special.Common).SaveRackNo(\u0026#34;1003807721\u0026#34;,\u0026#34;新产业-NA024-2\u0026#34;,\u0026#34;45\u0026#34;,\u0026#34;上机\u0026#34;) ClassMethod SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) { s labno=$g(labno) s positioninfo=$g(positioninfo) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),typename=$g(typename) i \u0026#39;$L(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $l(typename) s positioninfo=typename_\u0026#34;:\u0026#34;_positioninfo s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i typename[\u0026#34;上机\u0026#34; try{j ..SaveRecord(labno,positioninfo,mi,\u0026#34;6\u0026#34;)}catch{} .....i $l(objrep.RackNo),objrep.RackNo\u0026#39;=positioninfo try{j ..SaveRecord(labno,\u0026#34;架子号位置更新:\u0026#34;_objrep.RackNo_\u0026#34;--\u0026gt;\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;)}catch{}\t//架子号更新 .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,\u0026#34;-1^存\u0026#34;_typename_\u0026#34;信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i typename[\u0026#34;上机\u0026#34; try{j ..SaveRecord(labno,positioninfo,mi,\u0026#34;6\u0026#34;)}catch{} .i $l(objrep.RackNo),objrep.RackNo\u0026#39;=positioninfo try{j ..SaveRecord(labno,\u0026#34;架子号位置更新:\u0026#34;_objrep.RackNo_\u0026#34;--\u0026gt;\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;)}catch{}\t//架子号更新 .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q hasFindRep } 存储标本图片 罗氏流水线有血清标本图片，图片命名格式为条码号_第几个，比如1003783657_01，标本重复上线时会出现多个标本图片的情况，此处抓图将多个图片都抓取，按照P1，P2保存至标本图片表，如果找不到哦啊对应标本，则存入仪器图片表。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /// 保存标本图片 /// D ##class(MI.MIFRS600).SaveImageMTHD(\u0026#34;57\u0026#34;,\u0026#34;1000100990\u0026#34;,\u0026#34;P\u0026#34;,\u0026#34;/iLISLIS080/demo.png\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) /// D ##class(MI.MIFIT3000N1).SaveImageMTHD(\u0026#34;34\u0026#34;,\u0026#34;1003783657_01\u0026#34;,\u0026#34;1003783657_01\u0026#34;,\u0026#34;/iLISLIS032/20250321/1003783657_01.jpg\u0026#34;,\u0026#34;C:\\LISDATA\\DATA\\1003783657_01.jpg\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s ^YHR(\u0026#34;MI.MIFIT3000\u0026#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=\u0026#34;1\u0026#34; s epis=$p(epis,\u0026#34;_\u0026#34;,1) s ImageClass=\u0026#34;P\u0026#34;_+$p(ImageClass,\u0026#34;_\u0026#34;,2) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=\u0026#34;\u0026#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=\u0026#34;\u0026#34; f s RowID=$o(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=\u0026#34;\u0026#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i \u0026#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=\u0026#34;SerumQ\u0026#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= \u0026#34;-1^保存报告图片失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_\u0026#34;:\u0026#34;_ImageClass_\u0026#34;:\u0026#34;_FileName,\u0026#34;H\u0026lt;--M\u0026#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=\u0026#34;\u0026#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } 基于此功能附加功能\n血清标本显示 抓取血清图片后，会有多张图片的情况，将最新的图片显示在最上边\n修改方法 \u0026ldquo;LIS.WS.BLL.DHCRPVisitNumberReport\u0026rdquo;,\u0026ldquo;QryReportImage\u0026rdquo;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 k ^LISVisitNumberImage(\u0026#34;Data\u0026#34;) //获取条码标本质量图形信息 i $d(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;))) D .s SERUMID=\u0026#34;\u0026#34; .f S SERUMID=$O(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),SERUMID)) q:SERUMID=\u0026#34;\u0026#34; d ..S SERUMQRowID=$O(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),SERUMID,\u0026#34;\u0026#34;)) ..S (FileName,MachineParameterDR,Caption,DisplayRatio,Height,Width,Sequence,ImageClassDesc) = \u0026#34;\u0026#34; ..S StrData=$g(^dbo.RPVisitNumberImageD(SERUMQRowID)) ..s RowID=SERUMQRowID ..s ImageClassDesc = $lg(StrData,4) ..s FileName = ftp_$lg(StrData,5) ..s ThumbnailWidth=\u0026#34;\u0026#34;,ThumbnailHeight=\u0026#34;\u0026#34;,ThumbnailDeg=\u0026#34;\u0026#34; ..s Caption = \u0026#34;SerumQ\u0026#34; ..s IsImageRes=\u0026#34;\u0026#34; ..s IsExistImgRes=\u0026#34;\u0026#34; ..s Time=$p($h,\u0026#34;,\u0026#34;,2) ..s FileName=FileName //_\u0026#34;?Version=\u0026#34;_Time //解决图片缓存问题 ..Set Data=$lb(ImageClassDesc,ImageOrder,FileName,MachineParameterDR,Caption,DisplayRatio,Height,Width,Sequence,RowID,IsImageRes,ThumbnailWidth,ThumbnailHeight,ThumbnailDeg) ..s ^LISVisitNumberImage(\u0026#34;Data\u0026#34;,ImageClassDesc)=Data ..;d OutputRow /*----------\u0026gt;设置血清标本只显示最新的开始\u0026lt;----------*/ i $d(^LISVisitNumberImage(\u0026#34;Data\u0026#34;)) d .s ImageClassDesc=$o(^LISVisitNumberImage(\u0026#34;Data\u0026#34;,\u0026#34;\u0026#34;),-1) .s Data=$g(^LISVisitNumberImage(\u0026#34;Data\u0026#34;,ImageClassDesc)) .s Caption=$lg(Data,5) .s ImageClassDescNext=$o(^LISVisitNumberImage(\u0026#34;Data\u0026#34;,ImageClassDesc),-1) .i $l(ImageClassDescNext) s $li(Data,5)=Caption_\u0026#34;-\u0026#34;_ImageClassDesc .i \u0026#39;$l(Sequence) s Sequence=999 .i \u0026#39;$l(RowID) q .s ^TMP($zn,repid,$j,Sequence,RowID)=Data k ^LISVisitNumberImage(\u0026#34;Data\u0026#34;) /*----------\u0026gt;设置血清标本只显示最新的结束\u0026lt;----------*/ 特殊处理记录 本节点为该仪器接口特殊处理的部分，可以参考实际修改使用\n监听配置，有多条监听配置 主监听配置会获取仪器主键，其他的无法获取只能写死，主键有根据项目实际情况修改\n自动核收调用核收方法，按照工作小组主键入参。 自动核收前处理 由于自动核收功能包括罗氏本流水线自动核收，同时还带有分拣功能，对于免疫标本和临检标本分区和自动核收。本部分为特殊处理部分。\n本部分分为两块，一块为接收时上传维护，此部分与科室进行核对维护，另一部分为接收分区标识，根据仪器分区进行核收。（注：未通过检验自己维护的项目分区进行核收，一部分是减少调用增加处理速度，另一部分是根据仪器分区，方便科室对应分区找到对应工作小组的标本。）\n1.生化的标本都会立马拔盖上机去做，对于其他的标本，比如免疫和临检的标本，涉及到是否拔盖和分区的逻辑。仪器分别该标本类型，则需要通过检验上传对应条码的相关信息，因此，在流水线工作组中，对应医嘱维护不同的检测项目，在接收的时候就会获取流水线的医嘱对应的项目，在上传通道号维护对应的标识。\n2.标本上机仪器回传分区标识进行自动核收\n优先判断是否已接收未核收，如果已经核收则直接退出。\n根据前处理标本分区标识进行自动核收（此标识跟仪器进行核对不同的分区标识），通过不同的标识获取对应的工作小组，或者BHS_标识只记录分区不进行核收。核收失败进行弹窗提示。\n记录自动核收操作日志。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 /// 仪器主键，条码号，前处理标本分区标识，仪器信息(位置) /// w ##class(MI.MIFIT3000N1).ZDHS(\u0026#34;34\u0026#34;,\u0026#34;8000000352\u0026#34;,\u0026#34;WANTAI\u0026#34;) /// w ##class(MI.MIFIT300N).ZDHS(\u0026#34;34\u0026#34;,\u0026#34;1003779663\u0026#34;,\u0026#34;RSA1\u0026#34;) ClassMethod ZDHS(mi, Labno, MachineCode, positioninfo) { s mi=$g(mi),Labno=$g(Labno),machCode=$g(MachineCode),positioninfo=$g(positioninfo) i \u0026#39;$l(Labno) q \u0026#34;\u0026#34; /*----------\u0026gt;判断该标本是否已接收未核收 开始\u0026lt;----------*/ s QuitFlag=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##class(LIS.Util.Common).IndexData(Labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) s QuitFlag=1 i QuitFlag=1 q \u0026#34;\u0026#34; /*----------\u0026gt;判断该标本是否已接收未核收 结束\u0026lt;----------*/ s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)\t//得到当前仪器关联工作小组信息 s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13)\t//得到仪器工作小组的核收类型 //AcceptFlag为1认为是前处理工作小组，如果是前处理小组，就认为上前处理\t本接口未设置前处理工作小组，未对此流程进行测试 i AcceptFlag=\u0026#34;1\u0026#34; d QCLZDHS e d ZDHS q \u0026#34;\u0026#34; ZDHS d Trace^MI.MIF000(mi,\u0026#34;上仪器,标本号:\u0026#34;_Labno_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,分区位置:\u0026#34;_MachineCode_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;自动核收\u0026#34;) //根据前处理标本分区进行分区自动核收，并且根据分区代码是否核收进行区分 //本接口认为 默认认为罗氏流水线核收，如果分区代码中包含 【BHS】则认为标本不核收，此块代码将仪器传过来的分区代码进行归类 //本接口关联标本分区， WANTAI 万泰--\u0026gt;W，XINCHANYE 新产业--\u0026gt;X，LINJIAN 临检凝血--\u0026gt;L，XIEGUANG 携光--\u0026gt;R，罗氏--\u0026gt;Y，不核收--\u0026gt;N s HsFlag=\u0026#34;Y\u0026#34;,WorkGroupMachineDR=\u0026#34;\u0026#34; i (MachineCode[\u0026#34;WANTAI\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;WANTAI\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;W\u0026#34; .s WorkGroupMachineDR=48\t//未核收且分区是WANTAI i (MachineCode[\u0026#34;XINCHANYE\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;XINCHANYE\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;X\u0026#34; .s WorkGroupMachineDR=50\t//未核收且分区是XINCHANYE i (MachineCode[\u0026#34;LINJIAN\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;LINJIAN\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;L\u0026#34; .s WorkGroupMachineDR=9\t//未核收且分区是LINJIAN i (MachineCode[\u0026#34;XIEGUANG\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;XIEGUANG\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;R\u0026#34; .s WorkGroupMachineDR=67\t//未核收且分区是XIEGUANG i (MachineCode[\u0026#34;BHS_\u0026#34;) d\t;BHS_WANTAI .S MachineCode=$REPLACE(MachineCode,\u0026#34;BHS_\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;N\u0026#34; i MachineCode=\u0026#34;C_C8K886\u0026#34; s MachineCode=\u0026#34;C801\u0026#34; i MachineCode=\u0026#34;C_C8K77\u0026#34; s MachineCode=\u0026#34;C701\u0026#34; i MachineCode=\u0026#34;C8K886\u0026#34; s MachineCode=\u0026#34;C801\u0026#34; i MachineCode=\u0026#34;C8K77\u0026#34; s MachineCode=\u0026#34;C701\u0026#34; i HsFlag=\u0026#34;Y\u0026#34; d .s WorkGroupMachineDR=41\t//未核收且分区不包含BHS_\t默认核收到罗氏流水线 i \u0026#39;$l(WorkGroupMachineDR) q s ret=..ReceiveLabNoByWGM(WorkGroupMachineDR,Labno,$zd(+$h,8)) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) i ret\u0026#39;=\u0026#34;1\u0026#34; d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR\t//自动核收出错显示再对应的工作组 .s SendRet=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收失败\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_Labno_\u0026#34;前处理核收失败:\u0026#34;_ret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) j ..SaveRecord(Labno,\u0026#34;自动核收:\u0026#34;_ret,\u0026#34;\u0026#34;,\u0026#34;14\u0026#34;,WorkGroupMachineDR) q ret QCLZDHS d Trace^MI.MIF000(mi,\u0026#34;上前处理，鉴定号:\u0026#34;_Labno_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;DealInfo\u0026#34;) d Trace^MI.MIF000(mi,\u0026#34;执行核收到前处理\u0026#34;,\u0026#34;DealInfo\u0026#34;) //此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,Labno,\u0026#34;\u0026#34;) d Trace^MI.MIF000(mi,Labno_\u0026#34;核收到前处理返回信息:\u0026#34;_dealret,\u0026#34;DealInfo\u0026#34;) //记录位置信息到报告位置号 d ..SaveRackNo(Labno,positioninfo,mi) i dealret[\u0026#34;标本已核收\u0026#34; q i dealret=\u0026#34;1\u0026#34; d .//写标本操作日志 .d ..SaveRecord(Labno,machCode,mi,\u0026#34;5\u0026#34;) e d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_CurWorkGroupDR .s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收失败\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_Labno_\u0026#34;前处理核收失败:\u0026#34;_dealret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) .//写标本操作日志 .d ..SaveRecord(Labno,dealret,mi,\u0026#34;100\u0026#34;) q } 特殊结果的转换 仪器某些结果需要进行转换，固定的大部分都可以通过仪器维护对应项目的系数进行转换，但是对于包含\u0026gt;\u0026lt;的无法进行转换，因此需要在接口里进行特殊处理。\n！！！注：系数为除法\n1 2 3 4 5 6 7 8 9 10 /// 结果特殊转换 /// $TS$ /// W ##CLASS(MI.MIFIT3000N1).ConvertResult(\u0026#34;9PA\u0026#34;,\u0026#34;\u0026lt;0.070\u0026#34;) ClassMethod ConvertResult(code, res) { i code=\u0026#34;9PA\u0026#34; d .i $e(res)=\u0026#34;\u0026lt;\u0026#34;,+$e(res,2,*)=\u0026#34;.07\u0026#34; d ..s res=\u0026#34;\u0026lt;70\u0026#34; q res } 报警信息转换 本接口未使用报警信息转换，仪器传过来的报警信息就是转换后的报警信息，此处只是作为记录。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 /// 报警信息转换 ClassMethod ConvertPoliceInfo(WaringCode) { s WaringStr=\u0026#34;\u0026#34; i WaringCode=\u0026#34;5\u0026#34; s WaringStr=\u0026#34;\u0026gt;ABS(超出ABS)\u0026#34; i WaringCode=\u0026#34;43\u0026#34; s WaringStr=\u0026#34;Cal.E(校准结果异常)\u0026#34; i WaringCode=\u0026#34;2\u0026#34; s WaringStr=\u0026#34;\u0026gt;Cuvet(反应杯空白异常)\u0026#34; i WaringCode=\u0026#34;42\u0026#34; s WaringStr=\u0026#34;Edit(实验结果已被编辑)\u0026#34; i WaringCode=\u0026#34;23\u0026#34; s WaringStr=\u0026#34;\u0026gt;ISE(超出ISE范围)\u0026#34; i WaringCode=\u0026#34;19\u0026#34; s WaringStr=\u0026#34;ISE.E(ISE电压级错误)\u0026#34; i WaringCode=\u0026#34;56\u0026#34; s WaringStr=\u0026#34;\u0026gt;Kin(Prozone错误2/运动不稳)\u0026#34; i WaringCode=\u0026#34;10\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; i WaringCode=\u0026#34;11\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; i WaringCode=\u0026#34;6\u0026#34; s WaringStr=\u0026#34;\u0026gt;Prozone(Prozone错误1)\u0026#34; i WaringCode=\u0026#34;4\u0026#34; s WaringStr=\u0026#34;Reag.S(试剂不足)\u0026#34; i WaringCode=\u0026#34;44\u0026#34; s WaringStr=\u0026#34;\u0026gt;Rept(高出原倍复查范围)\u0026#34; i WaringCode=\u0026#34;45\u0026#34; s WaringStr=\u0026#34;\u0026lt;Rept(低于原倍复查范围)\u0026#34; i WaringCode=\u0026#34;46\u0026#34; s WaringStr=\u0026#34;Samp.？(高出ABS最大值)\u0026#34; i WaringCode=\u0026#34;68\u0026#34; s WaringStr=\u0026#34;Samp.B(样本中有气泡)\u0026#34; i WaringCode=\u0026#34;72\u0026#34; s WaringStr=\u0026#34;Samp.C(样本中有凝块)\u0026#34; i WaringCode=\u0026#34;26\u0026#34; s WaringStr=\u0026#34;\u0026gt;Test(高出线性范围)\u0026#34; i WaringCode=\u0026#34;27\u0026#34; s WaringStr=\u0026#34;\u0026lt;Test(低于线性范围)\u0026#34; q WaringStr } 新增标本操作日志记录类型 新增两个操作类型\n100\t前处理分区\n101\t架子号更新\n主动上传特殊处理 包含申请项目上传，复查项目上传，回退项目上传和审核项目上传\n申请状态为C，复查状态为U，回退状态为R，审核状态为T\n申请状态和审核状态进行分批上传，分别同时超过10个就先输出这10个，再次查询时再进行新的查询\n申请为重新获取项目，避免漏项目，如果要提升速度，则修改为获取上传表通道号，复查为获取上传表通道号(跟踪后发现也为发送全部为空的数据，并不是只复查需要复查的项目)，回退项目为获取标本对应医嘱所关联的工作小组布局和组合套布局（要求输入全部的项目才能完全删除仪器不做的项目，只传部分的话只删除上传的项目），审核上传为固定的通道项目\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = \u0026#34;labno,labnoInfo,patInfo\u0026#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(\u0026#34;MI.MIFIT3000N1\u0026#34;,\u0026#34;QryLabInfo\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; s LabnoList=\u0026#34;\u0026#34; s VisitNumberDR=\u0026#34;\u0026#34; s OutPutNum=0 //*--------------------------------\u0026gt;*申请项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate)) q:(AddDate=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;6) d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime)) q:(AddTime=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;6) d ..s OutPutNum=OutPutNum+1 ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i \u0026#39;$l(EpisNo) q ..i \u0026#39;$l(labno) q ..i \u0026#39;$d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno)) q ..s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..s ReceiveTime=$lg($g(^dbo.RPVisitNumberD(VisitNumberDR)),67) ..i ((+$p($h,\u0026#34;,\u0026#34;,2))-ReceiveTime\u0026gt;=-2)\u0026amp;\u0026amp;((+$p($h,\u0026#34;,\u0026#34;,2))-ReceiveTime\u0026lt;5) d Trace^MI.MIF000(mi,labno_\u0026#34;标本接收时间低于5秒不上传\u0026#34;,\u0026#34;等待上传\u0026#34;) q ..//得到通道号 ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@C\u0026#34;\t//重新获取通道号 避免因为接收造成漏项目 ..;GetLabnoInfoDelete ..;s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..;s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;|@U\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;申请上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;C@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 //*--------------------------------\u0026gt;*复查结果上传 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//控制输出文本的内容 ..s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;|@U\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;复查上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;U@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 //*--------------------------------\u0026gt;*取消项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//控制输出文本的内容 ..;s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@R\u0026#34; ..s TCList=..GetLabnoInfoDelete(mi,labno) ..s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;@R\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;取消上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;R@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 //*--------------------------------\u0026gt;*审核项目 s OutPutNum=0 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate)) q:(AddDate=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;10) d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate,AddTime)) q:(AddTime=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;10) d ..s OutPutNum=OutPutNum+1 ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//控制输出文本的内容 ..s labnoInfo=labno_\u0026#34;,\u0026#34;_\u0026#34;DM_OVER\u0026#34;_\u0026#34;@C\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;审核上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;T@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=\u0026#34;labno,labnoInfo,patInfo\u0026#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=\u0026#34;\u0026#34; { Set AtEnd=1 Set Row=\u0026#34;\u0026#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } 基于此的特殊处理操作\n回退和审核更新状态 基于复查更新状态进行功能扩展 原方法为d ##class(LIS.WS.BLL.DHCMachineUploadManage).UploadByWGM(\u0026quot;8000000413\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;41\u0026quot;,\u0026quot;U\u0026quot;)​\n回退时设置状态为R，上传通道号为END（接收时如果上传表中有数据，则不进行重新上传，避免接收和核收重复上传，基于此过滤判断通道号为END，通道号为END时则重新进行上传。）\n审核时设置通道号为DM_OVER\n拒收调用方法位置 LISSP.DHCRPVisitNumber\u0026ndash;RejectVisitNumber\n审核和复审时调用方法位置 LISSP.DHCRPVisitNumberReport\u0026ndash;SaveResult\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 /// 按小组重置上传列表 /// d ##class(MI.MIFIT3000N1).UploadByWGM(\u0026#34;8000000413\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;41\u0026#34;,\u0026#34;R\u0026#34;) /// d ##class(MI.MIFIT3000N1).UploadByWGM(\u0026#34;8000000413\u0026#34;,\u0026#34;\u0026#34;,41,\u0026#34;T\u0026#34;) /// d ##class(MI.MIFIT3000N1).UploadByWGM(\u0026#34;8000000413\u0026#34;,\u0026#34;\u0026#34;,41,\u0026#34;U\u0026#34;) ClassMethod UploadByWGM(Labno, TestSetDR, WorkGroupMachineDR, SendStatus) As %String { s Labno=$g(Labno),TestSetDR=$g(TestSetDR),WorkGroupMachineDR=$g(WorkGroupMachineDR) i \u0026#39;$l(Labno) q 100 i \u0026#39;$l(TestSetDR),\u0026#39;$l(WorkGroupMachineDR),SendStatus\u0026#39;=\u0026#34;R\u0026#34; q 100 i SendStatus=\u0026#34;R\u0026#34;,\u0026#39;$d(^dbo.RPMachineUploadI(\u0026#34;IndexVisitNumber\u0026#34;,Labno)) q i SendStatus=\u0026#34;R\u0026#34; { s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexVisitNumber\u0026#34;,Labno,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .s UploadDR=\u0026#34;\u0026#34; f s UploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexVisitNumber\u0026#34;,Labno,MachineDR,UploadDR)) q:UploadDR=\u0026#34;\u0026#34; d ..S obj=##class(dbo.RPMachineUpload).%OpenId(UploadDR) ..s obj.MachineParameterDR=MachineDR ..s obj.VisitNumber=Labno ..s obj.SendStatus=SendStatus ..s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) ..s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) ..s obj.TCList=\u0026#34;END\u0026#34; ..s ret=obj.%Save() }else{ s ReplaceWGMDRData=\u0026#34;3,41\u0026#34; s QuitFlag=0 for i=1:1:$l(ReplaceWGMDRData,\u0026#34;,\u0026#34;) q:QuitFlag=\u0026#34;1\u0026#34; d .i WorkGroupMachineDR=$p(ReplaceWGMDRData,\u0026#34;,\u0026#34;,i) d ..s WorkGroupMachineDR=\u0026#34;96\u0026#34; ..s QuitFlag=1 i SendStatus=\u0026#34;T\u0026#34; { s ReplaceWGMDRData=\u0026#34;1,3,41\u0026#34;\t//屏蔽所有，这里维护所有可以上传的工作小组 s WorkGroupMachineDRBAK=WorkGroupMachineDR s WorkGroupMachineDR=\u0026#34;\u0026#34; s QuitFlag=0 for i=1:1:$l(ReplaceWGMDRData,\u0026#34;,\u0026#34;) q:QuitFlag=\u0026#34;1\u0026#34; d .i WorkGroupMachineDRBAK=$p(ReplaceWGMDRData,\u0026#34;,\u0026#34;,i) d ..s WorkGroupMachineDR=\u0026#34;96\u0026#34; ..s QuitFlag=1 s WorkGroupMachineDR=\u0026#34;96\u0026#34;\t//所有的审核都发送归档标志 } s SendStatus=$g(SendStatus) s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) I $L(WorkGroupMachineDR) d .D UploadTC } q \u0026#34;1\u0026#34; UploadTC s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; q 100 s ret=100 s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.BTMIMachineParameterI(\u0026#34;IndexWorkGroupMachine\u0026#34;,WorkGroupMachineDR,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .s miCommDirection=$lg(^dbo.BTMIMachineParameterD(MachineDR),11) .i miCommDirection\u0026#39;=\u0026#34;UP\u0026#34;,miCommDirection\u0026#39;=\u0026#34;LS\u0026#34; q .d ScanOne^MI.MIF000(MachineDR,Labno) .s TCList=\u0026#34;\u0026#34; .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachineDR,Labno,chl)) q:chl=\u0026#34;\u0026#34; d ..s TCList=TCList_chl_\u0026#34;\\\u0026#34; .s TCList=$e(TCList,1,$l(TCList)-1) .i \u0026#39;$l(TCList),SendStatus\u0026#39;=\u0026#34;T\u0026#34; s ret=Labno_\u0026#34;没有上传项目\u0026#34; q .s RowID=\u0026#34;\u0026#34; .i $d(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno))) S RowID=$O(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) //q .I $L(RowID) S obj=##class(dbo.RPMachineUpload).%OpenId(RowID) .E s obj=##class(dbo.RPMachineUpload).%New() .//i $L(obj.SendStatus),obj.SendStatus\u0026#39;=\u0026#34;C\u0026#34; Q //已读取标本不再上传 .s obj.MachineParameterDR=MachineDR .s obj.VisitNumber=Labno .s obj.SendStatus=\u0026#34;C\u0026#34; .i $l(SendStatus) s obj.SendStatus=SendStatus .s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) .s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) .i SendStatus=\u0026#34;T\u0026#34; s TCList=\u0026#34;DM_OVER\u0026#34; .s obj.TCList=TCList .s ret=obj.%Save() q 0 } 标本上传处理修改显示 由于仪器和实际工作的工作小组不在一个位置，造成如果为上传成功时，重新上传查询不到标本，修改页面查询query逻辑 \u0026ldquo;LIS.WS.BLL.DHCMachineUploadManage\u0026rdquo;,\u0026ldquo;QrySampleStatus\u0026rdquo;,\n1 2 3 i MachineDR=\u0026#34;34\u0026#34; d .s WorkGroupMachineDRs=\u0026#34;41,3,48,50,67,7,9\u0026#34; e s WorkGroupMachineDRs=WorkGroupMachineDR 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 QryLSData s WorkGroupMachineDRs=\u0026#34;41,3,48,50,67,7,9\u0026#34; //按仪器或者小组查询 f date=SttDate:1:EndDate d .s Curdate=$TR($ZD(date,3),\u0026#34;-\u0026#34;) .f i=1:1:$L(SendStatus,\u0026#34;,\u0026#34;) d ..s CurSendStatus=$P(SendStatus,\u0026#34;,\u0026#34;,i) ..i \u0026#39;$l(iWorkGroupMachineDR) d ...s Time=\u0026#34;\u0026#34; f s Time=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(CurSendStatus),Curdate,Time)) q:Time=\u0026#34;\u0026#34; d ....s RowID=\u0026#34;\u0026#34; f s RowID=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(CurSendStatus),Curdate,Time,RowID)) q:RowID=\u0026#34;\u0026#34; d .....s loadData=$g(^dbo.RPMachineUploadD(RowID)) .....s VisitNumber=$lg(loadData,3) .....s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(VisitNumber),\u0026#34;\u0026#34;)) .....s VisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) .....i $l(iVisitNumber),VisitNumber\u0026#39;[iVisitNumber q .....f j=1:1:$l(WorkGroupMachineDRs,\u0026#34;,\u0026#34;) d ......s WorkGroupMachineDRsj=$p(WorkGroupMachineDRs,\u0026#34;,\u0026#34;,j) ......i \u0026#39;$l(WorkGroupMachineDRsj) q ......s order=\u0026#34;\u0026#34; ......f s order=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDRsj,order)) q:order=\u0026#34;\u0026#34; d .......s ReportDR=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDRsj,order,\u0026#34;\u0026#34;)) .......d InsertData q 问题处理记录 本节点为接口使用过程中踩过的雷和遇到过的问题以及处理方案\n无法及时读取文件处理造成获取结果过慢 1.修改监听配置，允许同一台电脑上存在多个监听。（新版本监听支持，本接口对应使用软件在附件中）\n监听中存在两个配置，AllowMultiOpen（是否允许多开，1允许，0不允许，默认不允许） 和OpenMessageService（多开版本维护为0，如果是1的话会造成系统崩溃！！！如果是正常在用电脑，其中一个维护为1就可以，其他的一定要设置为0） 在监听配置中，配置多个监听读取。本接口配置多个监听，主监听读取结果，额外配置两个，一个读取流水线处理文件，一个读取图片和上传信息（！！！这两个功能一定要在一起，上传参数 \u0026quot;UPPreDealClass\u0026quot;:\u0026quot;PreDeal.DealDemoM,PreDeal\u0026quot; 配置后，就一定会主动上传文件，所以一定一定一定再一起！！！）\n2.使用job线程处理。监听固定调用对应接口的fileMTHD方法，读取结果与系统其他方法没有交互，因此将具体的处理方法另外写了方法 ResultDo ，通过文件名包含路径进行判断，如果是结果RESULT文件，用job调用存储结果，如果是处理SEEN文件，用do调用处理结果。加快解析读取结果速度。\n仪器未获取到项目问题 1.读取结果不能及时时，进行了监听配置配置多个监听，最开始是为了分工明确，设置了四个监听，一个用来读取结果RESULT，一个用来读取处理文件SEEN，一个用来上传信息，一个用来读取图片。读取图片的配置和上传信息的配置处理类是同一个，读取图片多了一个额外的读取图片路径。\n最开始认为，读取图片的配置，不配置上传信息的路径，就不会进行上传。后面科室经常说会有漏标本漏项目的情况，经过多次排查核对日志后，发现被读取图片配置的监听上传了文件，因为没有配置上传路径，将上传的文件存在了监听对应的根路径。后面修改为上传信息和读取图片合为一个监听，最终为三个监听，一个读取结果，一个读取处理文件，一个上传信息+读取图片。\n2.修改后仍旧有漏项目的情况，确定仪器电脑只有三个监听，三个监听的日志都有认真排查。后面使用获取调用webservice的ip方法 w ##Class(LIS.Util.Common).GetClientIP()，查询到有其他电脑配置了监听，造成被其他电脑抢走了。\n3.上传过快造成未接收完标本已经上传，造成漏项目问题，判断接收5s内不上传。遇到偶发问题，上传时间与接收时间为0甚至上传时间比接收时间早1s，判断是事务未完成已经发送。设置上传时间大于-2秒不上传。\n报警信息过长保存到其他结果字段时造成无法保存仪器结果 报警信息存放在结果说明字段，会将结果说明字段发送给临床医生，很多医院要求报警信息不发送给临床医生，因此将报警信息存放至其他结果字段。然而其他结果字段，在dbo.RPMachineResult仪器结果表和dbo.RPMachineResultLog仪器结果日志表中字段OtherRes设置长度较短，就会造成存储时报错但是前台没有任何提示。扩长后可以正常的对应到结果。\n如果仪器维护报警结果不传输，如果没有结果，其他结果也不会赋值，因此要根据实际进行判断，如果有报警信息但是没有结果，设置结果为ERR，报警信息就可以正常的保存显示。\n同时存在大量标本，查询速度过慢，造成堆积无法正常上传项目 批量手工登记，造成同时存在超多标本等待上传，由于主动上传查询query中，包含申请项目上传，复查项目上传，回退项目上传和审核项目上传，造成查询速度过慢\n监听查询等待时间为60s，如果超过时间认为查询超时，就不再等待进行上传，会提示查询错误超过50次。因此对于接口进行处理，申请项目上传分批上传，超过10个就停止查询直接输出。\n‍\n","date":"2025-09-02T00:00:00Z","image":"https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-20250902171037/assets/image-20250403125731-kgqb3bk_hu_b500dc94302cab34.png","permalink":"https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-20250902171037/","title":"罗氏流水线IT3000"},{"content":"接口说明 仪器厂商 罗氏流水线RS600\n仪器型号 罗氏流水线RS600\n通讯方式 单向|双向|主动上传☑\n仪器类型 医院名称 程序名称 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：串口|网口|监听文件☑|数据库|其他 连接方式：HL7协议|ASTM协议|监听文件☑|数据库|其他 仪器接口说明 对于数据上传增加业务内容修改，仅作参考 串口盒子配置 波特率： 9600 数据位：8 停止位： 1 校验位： N 仪器图片 仪器配置 数据格式 项目通道号 修改记录 序号 日期 操作人 说明 1 2025-08-29 14:23:27\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;Z:\\\\ResultExport\\\\\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFLICA800\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.csv\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;Z:\\\\Imports\\\\\u0026#34;}] Class MI.MIFRS600 Extends %RegisteredObject { /// D ##class(MI.MIFInfinity).fileMTHD(\u0026#34;7\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#\u0026#34;,\u0026#34;\u0026#34;) /// seen: [VT]#enter#MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR] /// result: [VT]#enter#MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR] /// D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) /// seen: D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;[VT]#enter#MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]\u0026#34;,\u0026#34;\u0026#34;) /// result:D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;[VT]#enter#MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]\u0026#34;,\u0026#34;\u0026#34;) ClassMethod fileMTHD(mi, record, epis, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;0\u0026#34; s HospitalDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),4) i \u0026#39;$l(record) q \u0026#34;0\u0026#34; i \u0026#39;$d(^TMPLIS(\u0026#34;RS600\u0026#34;,mi,\u0026#34;ERR\u0026#34;)) s ^TMPLIS(\u0026#34;RS600\u0026#34;,mi,\u0026#34;ERR\u0026#34;)=\u0026#34;\u0026#34; d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) s miold=mi s recordbak=record //仪器临时结果映射 s TMPMachResMap=\u0026#34;\u0026#34; //解析多行合并数据 f i=1:1:$l(recordbak,\u0026#34;#enter#\u0026#34;) d .s record=$p(recordbak,\u0026#34;#enter#\u0026#34;,i) .d Trace^MI.MIF000(mi,\u0026#34;解析行数据:\u0026#34;_record,\u0026#34;H\u0026lt;--M\u0026#34;) .i \u0026#39;$l(record) q .s mi=miold .//识别前处理上机信息 .//取出第一位命令类型 .s type=$p(record,\u0026#34;|\u0026#34;,1) .//解析EQU命令 .i type=\u0026#34;EQU\u0026#34; d ..//前处理Seen命令 ..s commandchild=$p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,7) ..d Trace^MI.MIF000(mi,\u0026#34;前处理命令为:\u0026#34;_commandchild,\u0026#34;H\u0026lt;--M\u0026#34;) .//解析SAC命令 .i type=\u0026#34;SAC\u0026#34; d ..//解析上前处理信息 ..//取出流水号 ..s epis=$p(record,\u0026#34;|\u0026#34;,5) ..//取出前处理或仪器信息 ..s machCode=$p(record,\u0026#34;|\u0026#34;,11) ..//取出位置信息 ..s positioninfo=$p(record,\u0026#34;|\u0026#34;,12) ..//-----------------------------------------------------------------------------------------------\u0026gt;根据前处理命令处理 ..i commandchild=\u0026#34;SEEN\u0026#34; d //自动核收 ...//得到当前工作小组 ...s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) ...s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) ...s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) ...//得到仪器工作小组的核收类型 ...s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13) ...//如果是前处理小组，就认为上前处理 ...//************************************************************************************************ ...i AcceptFlag=\u0026#34;1\u0026#34; d ....d Trace^MI.MIF000(mi,\u0026#34;上前处理，鉴定号:\u0026#34;_epis_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ....d Trace^MI.MIF000(mi,\u0026#34;执行核收到前处理\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) ....//此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 ....s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,epis,\u0026#34;\u0026#34;) ....d Trace^MI.MIF000(mi,epis_\u0026#34;核收到前处理返回信息:\u0026#34;_dealret,\u0026#34;H\u0026lt;--M\u0026#34;) ....//记录位置信息到报告位置号 ....d ..SaveRackNo(epis,positioninfo,mi) ....i dealret[\u0026#34;标本已核收\u0026#34; q ....i dealret=\u0026#34;1\u0026#34; d .....//写标本操作日志 .....d ..SaveRecord(epis,machCode,mi,\u0026#34;5\u0026#34;) ....e d .....s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .....s perUser = \u0026#34;WG-\u0026#34;_CurWorkGroupDR .....s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_epis_\u0026#34;前处理核收失败:\u0026#34;_dealret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) .....//写标本操作日志 .....d ..SaveRecord(epis,dealret,mi,\u0026#34;100\u0026#34;) .....//************************************************************************************************ ...e d ....d Trace^MI.MIF000(mi,\u0026#34;上仪器，鉴定号:\u0026#34;_epis_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ....//核收操作，记录位置号5984@1 ....//标本操作，类型：已上机，备注：C8000A 5984@1 ....//上机提示（仪器项目上传日志，增加流水号索引） ....//此处调核收逻辑核收到仪器，标本从前处理小组进入仪器的小组 ....s dealret=##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(mi,epis,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;LSHS\u0026#34;) ....;s RetLL=$$SaveLastMachine^MI.MIF000(mi,epis,\u0026#34;1\u0026#34;) ....;d Trace^MI.MIF000(mi,RetLL,\u0026#34;最后仪器\u0026#34;) ....d Trace^MI.MIF000(mi,epis_\u0026#34;核收到仪器返回:\u0026#34;_dealret,\u0026#34;H\u0026lt;--M\u0026#34;) ....d Trace^MI.MIF000(mi,epis_\u0026#34;执行记录位置号:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ....//不管接收是否成功，记录位置信息到报告位置号 ....d ..SaveRackNo(epis,\u0026#34;已上机:\u0026#34;_positioninfo,mi) ....d Trace^MI.MIF000(mi,epis_\u0026#34;记录位置号完成\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) ....i dealret[\u0026#34;标本已核收\u0026#34; q ....i dealret=\u0026#34;1\u0026#34; d .....//写标本操作日志 .....d ..SaveRecord(epis,\u0026#34;仪器:\u0026#34;_curMachName_\u0026#34;,位置:\u0026#34;_positioninfo_\u0026#34;核收\u0026#34;,mi,\u0026#34;5\u0026#34;) .....d ..SaveRecord(epis,\u0026#34;已上流水线:\u0026#34;_positioninfo,mi,\u0026#34;5\u0026#34;) ....e d .....s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .....s perUser = \u0026#34;WG-\u0026#34;_CurWorkGroupDR .....s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_epis_\u0026#34;前处理核收失败:\u0026#34;_dealret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) .....//写标本操作日志 .....d ..SaveRecord(epis,dealret,mi,\u0026#34;100\u0026#34;) ..//-----------------------------------------------------------------------------------------------\u0026gt;根据前处理命令处理 ..i commandchild=\u0026#34;RESULT\u0026#34; d //处理分类信息 ...//通过仪器对照码取仪器 ...s curMachName=machCode ...//此处存标本全部审核报告的位置号 ...d Trace^MI.MIF000(mi,\u0026#34;分类信息，标本号:\u0026#34;_epis_\u0026#34;的样本所在仪器:\u0026#34;_curMachName_\u0026#34; \u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ...d Trace^MI.MIF000(mi,epis_\u0026#34;执行记录分类信息:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ...//保存分类信息到架子号 ...d ..SaveCARCH(epis,curMachName_\u0026#34;: \u0026#34;_positioninfo,mi,curMachName) ...d Trace^MI.MIF000(mi,epis_\u0026#34;记录分类信息完成\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) ...//写标本操作日志 ...d ..SaveRecord(epis,\u0026#34;上机位置:\u0026#34;_positioninfo,mi,\u0026#34;6\u0026#34;) ..//-----------------------------------------------------------------------------------------------\u0026gt;根据前处理命令处理 ..i commandchild=\u0026#34;ARCHIVE\u0026#34; d //处理归档信息 ...//通过仪器对照码取仪器 ...s curMachName=machCode ...//此处存标本全部审核报告的位置号 ...d Trace^MI.MIF000(mi,\u0026#34;归档信息，标本号:\u0026#34;_epis_\u0026#34;的样本所在仪器:\u0026#34;_curMachName_\u0026#34; \u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ...d Trace^MI.MIF000(mi,epis_\u0026#34;执行记录分类信息:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ...//保存归档信息到架子号 ...d ..SaveCARCH(epis,\u0026#34;归档:\u0026#34;_positioninfo,mi,\u0026#34;归档\u0026#34;) ...d Trace^MI.MIF000(mi,epis_\u0026#34;记录归档信息完成\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) ...//写标本操作日志 ...d ..SaveRecord(epis,\u0026#34;归档位置:\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;) .//-----------------------------------------------------------------------------------------------\u0026gt;处理结果数据 .//解析质控数据,P业务数据，Q质控数据 .i (type[\u0026#34;MSH\u0026#34;) d ..s ^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;MSH\u0026#34;)=$p(record,\u0026#34;|\u0026#34;,10) ..//取日期串 ..s DateStr=$p(record,\u0026#34;|\u0026#34;,7) ..//解析保存日期串 ..i $l(DateStr)=14 s ^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;DATE\u0026#34;)=$e(DateStr,1,8)_\u0026#34;,\u0026#34;_(($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60)) .i type=\u0026#34;OBR\u0026#34; s ^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;OBR\u0026#34;)=$p(record,\u0026#34;|\u0026#34;,3) .i type=\u0026#34;ORC\u0026#34; s ^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;ORC\u0026#34;)=$p(record,\u0026#34;|\u0026#34;,3) .//仪器警告 .i type=\u0026#34;NTE\u0026#34; d\t..s WaringStr=$p(record,\u0026#34;|\u0026#34;,4) ..d Trace^MI.MIF000(mi,\u0026#34;仪器报警信息:\u0026#34;_WaringStr,\u0026#34;H\u0026lt;--M\u0026#34;) ..s WaringCode=$p(WaringStr,\u0026#34; \u0026#34;,2) ..i $l(WaringCode) d ...i WaringCode=\u0026#34;5\u0026#34; s WaringStr=\u0026#34;\u0026gt;ABS(超出ABS)\u0026#34; ...e i WaringCode=\u0026#34;43\u0026#34; s WaringStr=\u0026#34;Cal.E(校准结果异常)\u0026#34; ...e i WaringCode=\u0026#34;2\u0026#34; s WaringStr=\u0026#34;\u0026gt;Cuvet(反应杯空白异常)\u0026#34; ...e i WaringCode=\u0026#34;42\u0026#34; s WaringStr=\u0026#34;Edit(实验结果已被编辑)\u0026#34; ...e i WaringCode=\u0026#34;23\u0026#34; s WaringStr=\u0026#34;\u0026gt;ISE(超出ISE范围)\u0026#34; ...e i WaringCode=\u0026#34;19\u0026#34; s WaringStr=\u0026#34;ISE.E(ISE电压级错误)\u0026#34; ...e i WaringCode=\u0026#34;56\u0026#34; s WaringStr=\u0026#34;\u0026gt;Kin(Prozone错误2/运动不稳)\u0026#34; ...e i WaringCode=\u0026#34;10\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; ...e i WaringCode=\u0026#34;11\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; ...e i WaringCode=\u0026#34;6\u0026#34; s WaringStr=\u0026#34;\u0026gt;Prozone(Prozone错误1)\u0026#34; ...e i WaringCode=\u0026#34;4\u0026#34; s WaringStr=\u0026#34;Reag.S(试剂不足)\u0026#34; ...e i WaringCode=\u0026#34;44\u0026#34; s WaringStr=\u0026#34;\u0026gt;Rept(高出原倍复查范围)\u0026#34; ...e i WaringCode=\u0026#34;45\u0026#34; s WaringStr=\u0026#34;\u0026lt;Rept(低于原倍复查范围)\u0026#34; ...e i WaringCode=\u0026#34;46\u0026#34; s WaringStr=\u0026#34;Samp.？(高出ABS最大值)\u0026#34; ...e i WaringCode=\u0026#34;68\u0026#34; s WaringStr=\u0026#34;Samp.B(样本中有气泡)\u0026#34; ...e i WaringCode=\u0026#34;72\u0026#34; s WaringStr=\u0026#34;Samp.C(样本中有凝块)\u0026#34; ...e i WaringCode=\u0026#34;26\u0026#34; s WaringStr=\u0026#34;\u0026gt;Test(高出线性范围)\u0026#34; ...e i WaringCode=\u0026#34;27\u0026#34; s WaringStr=\u0026#34;\u0026lt;Test(低于线性范围)\u0026#34; ..//保存仪器报警信息到组内报告评价 ..d ..SaveResultWarned(epis,WaringStr,mi) .d ##class(MI.Special.RecordGlobal).RecordData(epis,recordbak,\u0026#34;MI.MIFRS600\u0026#34;,1,10)\t//YHR 20230828 记录十天的数据 .i type=\u0026#34;OBX\u0026#34; d ..s (sample,result,date,time,QC)=\u0026#34;\u0026#34; ..s epis=^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;OBR\u0026#34;) ..s machCode=$p($p($p($p(record,\u0026#34;|\u0026#34;,16),\u0026#34;^\u0026#34;,1),\u0026#34;:\u0026#34;,1),\u0026#34;^\u0026#34;,1) ..d Trace^MI.MIF000(mi,\u0026#34;解析仪器对照码:\u0026#34;_machCode,\u0026#34;H\u0026lt;--M\u0026#34;) ..//通过仪器对照码取仪器 ..s code=$p($p(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1) ;AHBS^6012 ..s reswaring=$p($p(record,\u0026#34;|\u0026#34;,6),\u0026#34;^\u0026#34;,2) ..s res=$p($p(record,\u0026#34;|\u0026#34;,6),\u0026#34;^\u0026#34;,1) ;[\u0026#34;\u0026#34;一般|-1阴性+定量|1阳性+定量|0临界值] ..s CallThePolice=$p($p(record,\u0026#34;|\u0026#34;,9),\u0026#34;^\u0026#34;,2) ..i $l(CallThePolice) d ...try{d ..SaveAlarmInformation(mi,epis,CallThePolice)}catch {} //YHR 20230828 保存报警信息 ..//i res=-1 s res=\u0026#34;阴性\u0026#34;_$c(92)_$p($p(record,\u0026#34;|\u0026#34;,6),\u0026#34;^\u0026#34;,2)_$c(92)_$c(92)_reswaring ..//e i res=1 s res=\u0026#34;阳性\u0026#34;_$c(92)_$p($p(record,\u0026#34;|\u0026#34;,6),\u0026#34;^\u0026#34;,2)_$c(92)_$c(92)_reswaring ..//e i res=0 s res=\u0026#34;临界值\u0026#34;_$c(92)_$p($p(record,\u0026#34;|\u0026#34;,6),\u0026#34;^\u0026#34;,2)_$c(92)_$c(92)_reswaring ..//e s res=\u0026#34;临界值\u0026#34;_$c(92)_$c(92)_$c(92)_reswaring ..i res=\u0026#34;SORTED\u0026#34; q ..i res=\u0026#34;N/I\u0026#34; q ..//标本质量数据当做仪器报警，不让自动审核 ..i code=\u0026#34;SQ-D\u0026#34; d ...//保存仪器报警信息到报告评价 ...//d ..SaveResultWarned(epis,res,mi) ...d ..SaveQuality(epis,res,mi) ..//计算肾小球滤过率 ..i code=\u0026#34;8690\u0026#34; d ...s x1=\u0026#34;Cur\u0026#34; ...s x2=##class(MI.Special.GetSxqlgl).GeteGFRResultLast(mi,epis,res) ...i $l(x2) s result=result_x1_$c(92)_x2_$c(44) ..s result=result_code_$c(92)_res_$c(44) ..d Trace^MI.MIF000(mi,epis_\u0026#34;:\u0026#34;_result,\u0026#34;H\u0026lt;--M\u0026#34;) ..d Trace^MI.MIF000(mi,\u0026#34;按对照仪器保存数据:\u0026#34;_machCode,\u0026#34;H\u0026lt;--M\u0026#34;) ..//统一保存结果 ..i $l(epis),$l(result) d ...d Trace^MI.MIF000(mi,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;H\u0026lt;--M\u0026#34;) ...s DateStr=\u0026#34;\u0026#34; ...i $d(^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;DATE\u0026#34;)) s DateStr=^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;DATE\u0026#34;) ...i $l(DateStr) d ....s date=$p(DateStr,\u0026#34;,\u0026#34;,1) ....s time=$p(DateStr,\u0026#34;,\u0026#34;,2) ...d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) q \u0026#34;1\u0026#34; } // 记录标本日志 // D ##class(MI.MIFRS600).SaveRecord(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi) s OperateTypeCode=$g(OperateTypeCode) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,\u0026#34;,\u0026#34;,2),\u0026#34;\u0026#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,\u0026#34;\u0026#34;) } // 保存仪器报警信息 // D ##class(MI.MIFRS600).SaveResultWarned(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.ResultWarned) s objrep.ResultWarned=objrep.ResultWarned_\u0026#34;,\u0026#34;_conclusion .....e s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存仪器报警信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } // 保存仪器报警信息(标本质量) // D ##class(MI.MIFRS600).SaveQuality(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveQuality(labno, conclusion, predealMI) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_\u0026#34;,\u0026#34;_conclusion .....e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } // 保存架子号 // D ##class(MI.MIFRS600).SaveRackNo(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveRackNo(labno, positioninfo, mi) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s CanDoTS=0 .....i $d(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,ReportDR)) d ......s TestSetDR=\u0026#34;\u0026#34; f s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,ReportDR,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; d .......i $d(^dbo.BTTestSetWorkGroupMachineI(\u0026#34;IndexWorkGroupMachine\u0026#34;,curWorkGroupMachineDR,TestSetDR)) d ........s CanDoTS=1 .....i CanDoTS=0 q .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,\u0026#34;-1^存位置信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } // 保存归档和分类信息 // D ##class(MI.MIFRS600).SaveCARCH(\u0026#34;1000100990\u0026#34;,\u0026#34;2@2\u0026#34;,57,\u0026#34;归档\u0026#34;) ClassMethod SaveCARCH(labno, positioninfo, mi, typename) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo) d ......i $p(objrep.RackNo,\u0026#34;-\u0026gt;\u0026#34;,*)[typename d .......s positioninfo=$p(objrep.RackNo,typename,1)_positioninfo ......e d .......s positioninfo=objrep.RackNo_\u0026#34;-\u0026gt;\u0026#34;_positioninfo .....s objrep.RackNo=positioninfo .....s objrep.LastMachineLName=\u0026#34;\u0026#34; .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,\u0026#34;-1^存\u0026#34;_typename_\u0026#34;信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0 d Trace^MI.MIF000(mi,labno_\u0026#34;:没有找到\u0026#34;_typename_\u0026#34;的报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } // D ##class(MI.MIFRS600).SaveImageMTHD(\u0026#34;8\u0026#34;,\u0026#34;1000001727\u0026#34;,\u0026#34;07\u0026#34;,\u0026#34;/LIS/IT3000/20180823/SerumQ0001_orig_64_1000001727_8170_4_0__04.jpg\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) // 保存标本图片 // D ##class(MI.MIFRS600).SaveImageMTHD(\u0026#34;57\u0026#34;,\u0026#34;1000100990\u0026#34;,\u0026#34;P\u0026#34;,\u0026#34;/iLISLIS080/demo.png\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //s ^TMP(\u0026#34;zlzi\u0026#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=\u0026#34;1\u0026#34; i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=\u0026#34;\u0026#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=\u0026#34;\u0026#34; f s RowID=$o(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=\u0026#34;\u0026#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i \u0026#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=\u0026#34;SerumQ\u0026#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= \u0026#34;-1^保存报告图片失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_\u0026#34;:\u0026#34;_ImageClass_\u0026#34;:\u0026#34;_FileName,\u0026#34;H\u0026lt;--M\u0026#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=\u0026#34;\u0026#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // w ##class(MI.MIFRS600).GetFtpMTHD(\u0026#34;24\u0026#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = \u0026#34;labno,labnoInfo,patInfo\u0026#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(\u0026#34;MI.MIFRS600\u0026#34;,\u0026#34;QryLabInfo\u0026#34;,\u0026#34;57\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; s LabnoList=\u0026#34;\u0026#34; s VisitNumberDR=\u0026#34;\u0026#34; //*--------------------------------\u0026gt;*申请项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i \u0026#39;$l(EpisNo) q ..i \u0026#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..b ;VisitNumberDR ..i \u0026#39;$l(VisitNumberDR) q ..;i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=\u0026#34;0\u0026#34; ..i TestType=\u0026#34;0\u0026#34; d ...b ;1 ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@C\u0026#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ...s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ...d Trace^MI.MIF000(mi,txtInfo,\u0026#34;上传信息\u0026#34;) ...d OutputRow ...//文本双向上传结束****************************************************** ////*--------------------------------\u0026gt;*复查结果上传 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..b ;F101 ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i \u0026#39;$l(EpisNo) q ..i \u0026#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..b ;VisitNumberDR ..i \u0026#39;$l(VisitNumberDR) q ..i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=\u0026#34;0\u0026#34; ..i TestType=\u0026#34;0\u0026#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ...s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;|@U\u0026#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ...s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ...d Trace^MI.MIF000(mi,txtInfo,\u0026#34;上传信息\u0026#34;) ...d OutputRow ...//文本双向上传结束****************************************************** //*--------------------------------\u0026gt;*取消项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..b ;101 ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i \u0026#39;$l(EpisNo) q ..i \u0026#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..b ;VisitNumberDR ..i \u0026#39;$l(VisitNumberDR) q ..;i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=\u0026#34;0\u0026#34; ..i TestType=\u0026#34;0\u0026#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@R\u0026#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ...s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ...d Trace^MI.MIF000(mi,txtInfo,\u0026#34;上传信息\u0026#34;) ...d OutputRow ...//文本双向上传结束****************************************************** Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=\u0026#34;labno,labnoInfo,patInfo\u0026#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=\u0026#34;\u0026#34; { Set AtEnd=1 Set Row=\u0026#34;\u0026#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 获取申请名称和内容 /// 申请名称： /// 发送申请：order_2012051718302501_9999999901NW.HL7 /// 取消申请：order_2012051718302501_9999999901CA.HL7 /// 项目复查：order_2012051718302501_9999999901XO.HL7 /// w ##class(MI.MIFRS600).GetLisOrderMTHD(\u0026#34;8\u0026#34;,\u0026#34;POS@C@1\u0026#34;,\u0026#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08 -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34; ,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod GetLabnoInfoN(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s VT=\u0026#34;[11]\u0026#34;,FS=\u0026#34;[28]\u0026#34;,CR=\u0026#34;[13]\u0026#34; s labNo=$p(patInfo,\u0026#34;,\u0026#34;,16) s Sampleno=$p(patInfo,\u0026#34;,\u0026#34;,3) //i labNo=\u0026#34;74623177\u0026#34; s ^TMP(\u0026#34;zlzit3000d\u0026#34;)=$lb(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s location=$p(patInfo,\u0026#34;,\u0026#34;,6) s docName=$p(patInfo,\u0026#34;,\u0026#34;,7) s regNo=$p(patInfo,\u0026#34;,\u0026#34;,9) s patName=$p(patInfo,\u0026#34;,\u0026#34;,10) s sex=$p(patInfo,\u0026#34;,\u0026#34;,11) i sex=\u0026#34;1\u0026#34; s sex=\u0026#34;M\u0026#34; i sex=\u0026#34;2\u0026#34; s sex=\u0026#34;F\u0026#34; i (sex\u0026#39;=\u0026#34;M\u0026#34;)\u0026amp;\u0026amp;(sex\u0026#39;=\u0026#34;F\u0026#34;) s sex=\u0026#34;U\u0026#34; s birthDate=$p(patInfo,\u0026#34;,\u0026#34;,29) s collectTime=$p(patInfo,\u0026#34;,\u0026#34;,17) ;2017-08-14 11:57 s collectTime=$tr(collectTime,\u0026#34;- :\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;00\u0026#34; s status=$p(labnoInfo,\u0026#34;@\u0026#34;,2) s labnoInfo=$p(labnoInfo,\u0026#34;@\u0026#34;,1) s curTime=$zd($h,8)_$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;,\u0026#34;\u0026#34;) s PatType=$p(patInfo,\u0026#34;,\u0026#34;,12) s Wardno=$p(patInfo,\u0026#34;,\u0026#34;,27) s Diagnose=$p(patInfo,\u0026#34;,\u0026#34;,22) S patTypeFlag=\u0026#34;RO\u0026#34; //门诊=RO,住院=RI,体检=RC,急诊=RS I PatType=\u0026#34;住院\u0026#34; { S patTypeFlag=\u0026#34;RI\u0026#34; } I PatType=\u0026#34;门诊\u0026#34; { S patTypeFlag=\u0026#34;RO\u0026#34; } I PatType=\u0026#34;急诊\u0026#34; { S patTypeFlag=\u0026#34;RS\u0026#34; } I PatType=\u0026#34;体检\u0026#34; { S patTypeFlag=\u0026#34;RC\u0026#34; } I PatType=\u0026#34;干诊\u0026#34; { S patTypeFlag=\u0026#34;RC\u0026#34; } s MSN=\u0026#34;MSH|^\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|\u0026#34;_curTime_\u0026#34;||OML^O21|\u0026#34;_curTime_\u0026#34;_\u0026#34;_labNo_\u0026#34;|P|2.3|||ER|ER||8859/1\u0026#34; i status=\u0026#34;S\u0026#34; s MSN=\u0026#34;MSH|^\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|\u0026#34;_curTime_\u0026#34;||RESULTS|\u0026#34;_curTime_\u0026#34;_\u0026#34;_labNo_\u0026#34;|P|2.3|||ER|ER||8859/1\u0026#34; s PID=\u0026#34;PID|1||\u0026#34;_Sampleno_\u0026#34;||\u0026#34;_\u0026#34;^\u0026#34;_patName_\u0026#34;||\u0026#34;_birthDate_\u0026#34;|\u0026#34;_sex s PV1=\u0026#34;PV1|||\u0026#34;_Wardno_\u0026#34;||||||||||||||||^^^^^^^^\u0026#34;_location_\u0026#34;|\u0026#34; s DG1=\u0026#34;DG1|||\u0026#34;_Diagnose s orcF1=\u0026#34;NW\u0026#34;,orcF2=\u0026#34;\u0026#34; i status=\u0026#34;R\u0026#34; s orcF1=\u0026#34;CA\u0026#34; //i status=\u0026#34;U\u0026#34; s orcF1=\u0026#34;XO\u0026#34; s orcF2=\u0026#34;SC\u0026#34; i status=\u0026#34;U\u0026#34; s orcF1=\u0026#34;XO\u0026#34; s orcF2=\u0026#34;RP\u0026#34; s ORC=\u0026#34;ORC|\u0026#34;_orcF1_\u0026#34;|\u0026#34;_labNo_\u0026#34;|||||\u0026#34;_patTypeFlag_\u0026#34;||\u0026#34;_curTime_\u0026#34;||\u0026#34;_docName_\u0026#34;|\u0026#34;_Wardno_\u0026#34;|||||||\u0026#34; s obrF1=\u0026#34;A\u0026#34; i status=\u0026#34;U\u0026#34; s obrF1=\u0026#34;G\u0026#34; s OBR=\u0026#34;OBR||\u0026#34;_labNo_\u0026#34;||AA|||\u0026#34;_collectTime_\u0026#34;||||\u0026#34;_obrF1\ts OBRs=\u0026#34;\u0026#34; i $p(labnoInfo,\u0026#34;@\u0026#34;,1)=\u0026#34;POS\u0026#34; d .s OBRs=\u0026#34;OBR||\u0026#34;_labNo_\u0026#34;||POS|||\u0026#34;_collectTime_\u0026#34;||||\u0026#34;_obrF1 e d .d GetOBRs\t//s orderTxt=VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS s orderTxt=VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS q orderTxt GetOBRs s items=$tr($p(labnoInfo,\u0026#34;,\u0026#34;,2),\u0026#34;|\u0026#34;,\u0026#34;\u0026#34;) f i=1:1:$l(items,\u0026#34;+\u0026#34;) d .s item=$p(items,\u0026#34;+\u0026#34;,i) .s splitStr=$p(OBR,\u0026#34;|\u0026#34;,5) .s curOBR=$p(OBR,splitStr,1)_item_$p(OBR,splitStr,2) .s OBRs=OBRs_curOBR_CR q } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=\u0026#34;\u0026#34; s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) q:chl=\u0026#34;\u0026#34; d .s tcx=tcx_chl_\u0026#34;+\u0026#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno) i $l(tcx) s tcx=labno_\u0026#34;,\u0026#34;_tcx_\u0026#34;|\u0026#34; d Trace^MI.MIF000(mi,tcx,\u0026#34;H--\u0026gt;M\u0026#34;) d Trace^MI.MIF000(56,\u0026#34;共\u0026#34;_$l(tcx,\u0026#34;+\u0026#34;)_\u0026#34;个项目。\u0026#34;_tcx,\u0026#34;H--\u0026gt;M\u0026#34;) //YHR 20230816 将上传信息存入罗氏infinity仪器 q tcx } /// w ##Class(MI.MIFRS600).GetPatInfo(57,9000001912) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName\ts SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) i $l(Instrument) s Instrument=$tr(Instrument,\u0026#34;,\u0026#34;,\u0026#34;^\u0026#34;) s Sampleno=$lg(RPVisitNumberData,6) //病案号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; s WardnoDR=$lg(RPVisitNumberData,26) ;病区 i $l(WardnoDR) s Wardno=$lg($g(^dbo.BTWardD(WardnoDR)),3) s RetString=\u0026#34;\u0026#34; s RetString=$tr(Sampleda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Instrument,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sampleno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sampletype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Feetype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Srcdepno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Srcdocno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Userno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Patno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Patna,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sex,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Pattype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Bedno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Patage,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Ageunit,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reqno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reqda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Reportda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Printflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Resultflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Errflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Diagnose,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Description,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reserve,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Patnamn,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Getda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Wardno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(BarCode,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(BirthDate,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;) q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,\u0026#34;S\u0026#34;,filename) q } /// 流水号特殊处理 /// w ##class(MI.MIFRS600).GetEpis() ClassMethod GetEpis() { s sign=1 while sign=1 { s maxEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByRowIDMTHD(\u0026#34;5\u0026#34;) //YHR 20230810 罗氏流水线规则 s ret=$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,67,maxEpis)) i ret\u0026#39;=0 s sign=1 e d s sign=0 } q maxEpis } /// 保存报警提示信息 /// YHR 20230828 /// w ##Class(MI.MIFRS600).SaveAlarmInformation(57,9000001960,\u0026#34;CSCSCS\u0026#34;) ClassMethod SaveAlarmInformation(mi, epis, expertRules) { s mi=$g(mi) s epis=$g(epis) s expertRules=$g(expertRules) s ReportDR=$$GetReportID(mi,epis) s obj=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) s obj.MinorConclusion=expertRules s ret=obj.%Save() q ret GetReportID(mi,epis) i $l(epis)\u0026lt;10 d .s AssayNo=epis e d .s AssayNo=$$GetEpisByLabno(mi,epis) s WGMachineID=$lg(^dbo.BTMIMachineParameterD(mi),6) s WGMachineID1=$lg(^dbo.BTMIMachineParameterD(mi),6) s ReportID=\u0026#34;\u0026#34; i $D(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,AssayNo)) d .s TransmitDate=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,AssayNo,\u0026#34;\u0026#34;)) .s ReportID=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,AssayNo,TransmitDate,\u0026#34;\u0026#34;)) q ReportID GetEpisByLabno(mi,Epis) ;Index IndexVisitNumber On VisitNumber [ SqlName = Index_VisitNumber, Type = index, Unique ]; ;Index IndexReportID On (VisitNumberDR, WorkGroupMachineDR, OrderNo) [ SqlName = Index_ReportID, Type = index, Unique ]; s ret=\u0026#34;\u0026#34;,mi=$g(mi),Epis=$g(Epis) i \u0026#39;$l(mi) q Epis s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis,\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1)) d ..s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1,\u0026#34;\u0026#34;)) ..s ret=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),8) q ret } } 附录 仪器文档提取数据格式 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 第十章LIS 10.1Order格式 [VT] MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||OML^O21|20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR] PID|1||00943729|9009|^Test||19811002|F[CR] PV1|||041||||||||||||||||^^^^^^^^产六科|[CR] DG1|||宫内孕37+5天[CR] ORC|NW|121092103669|||||RI||20210922075000|医保|10001|041|||||||[CR] OBR||121092103669||YLCSC|||||||A[CR] OBR||121092103669||ATPO|||||||A[CR] OBR||121092103669||FT4|||||||A[CR] OBR||121092103669||TSH|||||||A[CR] [FS] [CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 OML^O21：message type Order的消息类型，Order发送必须用OML^O21 20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复） 00943729：病人的门诊或住院号 9009：样本号 ^Test：病人姓名 19811002：出生年月日 F：性别（F = Female；M = Male；U = Unknown） 宫内孕37+5天：临床诊断(如果有代码就用临床诊断得代码，没有就用文字描述) NW：Action code (NW:新建；XO：修改；CA：删除) 121092103669：条码号 RI：病人类别（门诊；住院；急诊；体检……） 20180201101033：时间戳(精确到秒无需毫秒) 医保：病人收费类别 10001：申请医生代码 041：申请科室代码 121092103669：条码号 YLCSC：测试项目代号 10.2Result格式 [VT] MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||RESULTS |20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR] PID|1||00943729|9009|^Test||19811002|F[CR] PV1|||041||||||||||||||||^^^^^^^^产六科|[CR] DG1|||宫内孕37+5天[CR] ORC|NW|121092103669|9009||||RI||20210922075000|医保|10001|041|||||||[CR] OBR||121092103669||YLCSC|||||||A[CR] OBX|1|NM|YLCSC||1.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||ATPO|||||||A[CR] OBX|1|NM|ATPO||2.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||FT4|||||||A[CR] OBX|1|NM|FT4||3.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||TSH|||||||A[CR] OBX|1|NM|TSH||6.1||||||F|||20210922101033|c6000^E11[CR] [FS] [CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 RESULTS：message type Order的消息类型，结果回传必须用RESULTS 20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复） 00943729：病人的门诊或住院号 9009：样本号 ^Test：病人姓名 19811002：出生年月日 F：性别（F = Female；M = Male；U = Unknown） NW：Action code (NW:新建；XO：修改；CA：删除) 121092103669：条码号 RI：病人类别（门诊；住院；急诊；体检……） 20210922075000：时间戳(精确到秒无需毫秒) 医保：病人收费类别 10001：申请医生代码 041：申请科室代码 121092103669：条码号 NM：Value Type (NM = Numeric；ST = String data) YLCSC：测试项目代号 1.1：项目测试结果 c6000^E11：分析仪名称和模块名称 10.3Seen格式 01前处理条码扫描消息格式 [VT] MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR] SAC|||0800150242|0800150242||20220908183340|01||P|MILESTON1|0@0[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^SEEN：消息类型 0800150242：条码号 MILESTON1：前处理名称 0@0：架子号和位置号 20220908183340：消息产生的时间 02前处理分类Distribution消息格式 [VT] MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^RESULT|20220908183340|SORTED[CR] SAC|||0800150242|0800150242||20220908183340|01||R|c6000|0@0[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^RESULT：消息类型 0800150242：条码号 MILESTON1：前处理名称 c6000：分析仪名称 0@0：架子号和位置号 20220908183340：消息产生的时间 03前处理归档消息格式 [VT] MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^ARCHIVE|20220908183340|SORTED[CR] SAC|||0800150242|0800150242||20220908183340|01||R|MILESTON1|23@1[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^ARCHIVE：消息类型 0800150242：条码号 MILESTON1：前处理名称 23@1：架子号和位置号 20220908183340：消息产生的时间 特殊处理 标本拒收更改标本上传状态为R\nLISSP.DHCRPVisitNumber——RejectVisitNumber\n1 2 3 4 5 s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexVisitNumber\u0026#34;,fLabno,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .S RowID=$O(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,fLabno,\u0026#34;\u0026#34;)) //q .S obj=##class(dbo.RPMachineUpload).%OpenId(RowID) .s obj.SendStatus=\u0026#34;R\u0026#34; .s ret=obj.%Save() 更新拒收状态后回传文件之后删除该条上传信息，避免签收会无法签收\nMI.MachineUpload——SetSendFlag\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 /// Description:： 记录上传标志 /// Table： /// Input： 仪器DR,检验号,标记(C:创建 S:发送 F:失败),Comments:备注信息 /// Output： 无 /// Return： 1:成功 其他:失败 /// w ##Class(MI.MachineUpload).SetSendFlag(6,1001367,\u0026#34;S\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SetSendFlag(MachineDR, Labno, SendStatus, Comments) As %String { s MachineDR=$g(MachineDR),Labno=$g(Labno),SendStatus=$g(SendStatus) s Labno=$p(Labno,\u0026#34;^\u0026#34;,1) s RowID=$o(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(SendStatus) s SendStatus=\u0026#34;C\u0026#34; i \u0026#39;$l(RowID) q 100 s TCList=$lg($g(^dbo.RPMachineUploadD(RowID)),7) s oldSendStatus=$lg($g(^dbo.RPMachineUploadD(RowID)),4) i oldSendStatus=\u0026#34;R\u0026#34; k ^dbo.RPMachineUploadD(RowID) s obj=##class(dbo.RPMachineUpload).%OpenId(RowID) s obj.SendStatus=SendStatus s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) s ret=obj.%Save() q ret } 签收标本特殊处理，避免造成同一医嘱在不同主动上传仪器生成上传标本\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 /// Description:： 上传标本记录 /// Table： /// Input： 标本号,检验套DR,工作小组 /// Output： 无 /// Return： 1:成功 其他:失败 /// w ##Class(MI.MachineUpload).Upload(\u0026#34;1000100990\u0026#34;,39,57) ClassMethod Upload(Labno, TestSetDR, WorkGroupMachineDR) As %String { s Labno=$g(Labno),TestSetDR=$g(TestSetDR),WorkGroupMachineDR=$g(WorkGroupMachineDR) i \u0026#39;$l(Labno) q 100 i \u0026#39;$l(TestSetDR),\u0026#39;$l(WorkGroupMachineDR) q 100 //接收或核收操作标识 s RecFlag=\u0026#34;C\u0026#34; i $l(WorkGroupMachineDR) s RecFlag=\u0026#34;H\u0026#34; //无工作小组认为是核收操作，不增加入参 s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) I $L(WorkGroupMachineDR) d .D UploadTC E D //不传工作小组时遍历关联的所有主动上传仪器 .S LinkWGMDR=\u0026#34;\u0026#34; F S LinkWGMDR=$O(^dbo.BTTestSetWorkGroupMachineI(\u0026#34;IndexMaster\u0026#34;,TestSetDR,LinkWGMDR)) Q:LinkWGMDR=\u0026#34;\u0026#34; D ..S WorkGroupMachineDR=LinkWGMDR ..//标本接收医院 ..s VisHosDR=$LG($G(^dbo.RPVisitNumberD(VisitNumberDR)),78) ..//工作小组所在医院 ..s CKWGDR=$LG($G(^dbo.BTWorkGroupMachineD(LinkWGMDR)),4) ..s CkDepartDR=$LG($G(^dbo.BTWorkGroupD(CKWGDR)),4) ..S CkHosDR=$LG($G(^dbo.BTDepartmentD(CkDepartDR)),4) ..I CkHosDR\u0026#39;=VisHosDR Q //非本医院标本不生成工单 ..D UploadTCN q 1 UploadTC s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///临时处理老年医院流水线标本上传 //i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; s ^DHCUploadAll(Labno)=WorkGroupMachineDR i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; q 100 //装载列表接收不生成工单 i CommDirection=\u0026#34;LS\u0026#34;,RecFlag=\u0026#34;C\u0026#34; q 100 s ret=100 s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.BTMIMachineParameterI(\u0026#34;IndexWorkGroupMachine\u0026#34;,WorkGroupMachineDR,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .s miCommDirection=$lg(^dbo.BTMIMachineParameterD(MachineDR),11) .i miCommDirection\u0026#39;=\u0026#34;UP\u0026#34;,miCommDirection\u0026#39;=\u0026#34;LS\u0026#34; q .d ScanOne^MI.MIF000(MachineDR,Labno) .s TCList=\u0026#34;\u0026#34; .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachineDR,Labno,chl)) q:chl=\u0026#34;\u0026#34; d ..s TCList=TCList_chl_\u0026#34;\\\u0026#34; .s TCList=$e(TCList,1,$l(TCList)-1) .i \u0026#39;$l(TCList) s ret=Labno_\u0026#34;没有上传项目\u0026#34; q .s RowID=\u0026#34;\u0026#34; .i $d(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno))) S RowID=$O(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) //q .I $L(RowID) S obj=##class(dbo.RPMachineUpload).%OpenId(RowID) .e s obj=##class(dbo.RPMachineUpload).%New() .i $L(obj.SendStatus),obj.SendStatus\u0026#39;=\u0026#34;C\u0026#34; Q //已读取标本不再上传 .s obj.MachineParameterDR=MachineDR .s obj.VisitNumber=Labno .s obj.SendStatus=\u0026#34;C\u0026#34; .s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) .s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) .s obj.TCList=TCList .s ret=obj.%Save() q UploadTCN s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///临时处理老年医院流水线标本上传 //i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; s ^DHCUploadAll(Labno)=WorkGroupMachineDR i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; q 100 //装载列表接收不生成工单 i CommDirection=\u0026#34;LS\u0026#34;,RecFlag=\u0026#34;C\u0026#34; q 100 s ret=100 s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.BTMIMachineParameterI(\u0026#34;IndexWorkGroupMachine\u0026#34;,WorkGroupMachineDR,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .i MachineDR\u0026#39;=57 q //上传标本信息接收标本特殊处理 .s miCommDirection=$lg(^dbo.BTMIMachineParameterD(MachineDR),11) .i miCommDirection\u0026#39;=\u0026#34;UP\u0026#34;,miCommDirection\u0026#39;=\u0026#34;LS\u0026#34; q .d ScanOne^MI.MIF000(MachineDR,Labno) .s TCList=\u0026#34;\u0026#34; .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachineDR,Labno,chl)) q:chl=\u0026#34;\u0026#34; d ..s TCList=TCList_chl_\u0026#34;\\\u0026#34; .s TCList=$e(TCList,1,$l(TCList)-1) .i \u0026#39;$l(TCList) s ret=Labno_\u0026#34;没有上传项目\u0026#34; q .s RowID=\u0026#34;\u0026#34; .i $d(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno))) S RowID=$O(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) //q .I $L(RowID) S obj=##class(dbo.RPMachineUpload).%OpenId(RowID) .i $L(obj.SendStatus),obj.SendStatus\u0026#39;=\u0026#34;C\u0026#34; d ..s obj.SendStatus=\u0026#34;C\u0026#34; ..s ret=obj.%Save() //签收强制重新上传 .e d ..s obj=##class(dbo.RPMachineUpload).%New() ..s obj.MachineParameterDR=MachineDR ..s obj.VisitNumber=Labno ..s obj.SendStatus=\u0026#34;C\u0026#34; ..s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) ..s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) ..s obj.TCList=TCList ..s ret=obj.%Save() q } 通过规则设置流水号\n1 2 3 4 5 6 7 8 9 i \u0026#39;$l(RuleCode) { s RuleCode=$lg($g(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR)),2) } // 罗氏流水线流水号通过规则生成流水号 i RuleCode=\u0026#34;LSHS\u0026#34; d .s maxEpis=##class(MI.MIFRS600).GetEpis() //YHR 20230810 罗氏流水线规则 e d .s maxEpis=##Class(LIS.Common.DHCVisitNumber).GetRuleCodeEpisodeNo(RuleCode,.SYSRuleNoBaseDR) 增加项目，删除项目，复查项目生成工单\nLISSP.DHCRPVisitNumberReport\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 /// Creator： 杨浩然 /// CreatDate： 20230714 /// Description:： 主动上传生成项目工单 /// Table： /// Input： 标本号，工作小组ID，报告ID，项目ID主键，工单类型（R 删除，U 复查，C 增加） /// Output： 成功1 /// Return： 生成上传工单 /// Others w ##class(LIS.Common.DHCVisitNumber).GenerateUploadRecordMTHD(\u0026#34;1000100990\u0026#34;,\u0026#34;67\u0026#34;,\u0026#34;59396\u0026#34;,\u0026#34;^61^284\u0026#34;,\u0026#34;U\u0026#34;) ClassMethod GenerateUploadRecordMTHD(Labno, WorkGroupMachineDR, ReportDR, RepeatTCList, SendStatus, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s Labno=$g(Labno),WorkGroupMachineDR=$G(WorkGroupMachineDR) s ^TMP(\u0026#34;CreateUploadRecordMTHD\u0026#34;)=$LB(Labno, WorkGroupMachineDR) s Labno=$g(Labno),ReportDR=$g(ReportDR),WorkGroupMachineDR=$g(WorkGroupMachineDR),RepeatTCList=$g(RepeatTCList),SendStatus=$g(SendStatus) i \u0026#39;$l(Labno) q 100 i \u0026#39;$l(ReportDR) q 100 i \u0026#39;$l(WorkGroupMachineDR) q 100 i \u0026#39;$l(SendStatus) q 100 s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///临时处理老年医院流水线标本上传 //i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; s ^DHCUploadAll(Labno)=WorkGroupMachineDR i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; q 100 s ret=100 s TCList=\u0026#34;\u0026#34; s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.BTMIMachineParameterI(\u0026#34;IndexWorkGroupMachine\u0026#34;,WorkGroupMachineDR,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .;i $d(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,Labno)) q .s miCommDirection=$lg(^dbo.BTMIMachineParameterD(MachineDR),11) .i miCommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; q .f i=1:1:$l(RepeatTCList,\u0026#34;^\u0026#34;) d ..s TestCodeID=$p(RepeatTCList,\u0026#34;^\u0026#34;,i) ..i TestCodeID=\u0026#34;\u0026#34; q ..//如果是复查或者删除项目则判断该项目是不是该报告的 ..i (SendStatus=\u0026#34;U\u0026#34;)||(SendStatus=\u0026#34;R\u0026#34;) d ...i $d(^dbo.RPVisitNumberReportResultI(\u0026#34;IndexReportItem\u0026#34;,ReportDR,TestCodeID)) d ....i $d(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexUPChannel\u0026#34;,MachineDR,TestCodeID)) d .....s UPChannel=$o(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexUPChannel\u0026#34;,MachineDR,TestCodeID,\u0026#34;\u0026#34;)) .....i UPChannel=-100000000000000 q .....b ;102 .....s TCList=TCList_UPChannel_\u0026#34;\\\u0026#34; ..e i SendStatus=\u0026#34;C\u0026#34; d ...i $d(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexUPChannel\u0026#34;,MachineDR,TestCodeID)) d ....s UPChannel=$o(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexUPChannel\u0026#34;,MachineDR,TestCodeID,\u0026#34;\u0026#34;)) ....i UPChannel=-100000000000000 q ....b ;102 ....s TCList=TCList_UPChannel_\u0026#34;\\\u0026#34; .b ;101 .s TCList=$e(TCList,1,$l(TCList)-1) .i \u0026#39;$l(TCList) s ret=Labno_\u0026#34;没有上传项目\u0026#34; q .S RowID=\u0026#34;\u0026#34; .i $d(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno))) s RowID=$O(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) .I $L(RowID) s obj=##class(dbo.RPMachineUpload).%OpenId(RowID) .e s obj=##class(dbo.RPMachineUpload).%New() .s obj.MachineParameterDR=MachineDR .s obj.VisitNumber=Labno .s obj.SendStatus=SendStatus .s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) .s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) .s obj.TCList=TCList .s ret=obj.%Save() Q ret } 增加 AddReportTCRes\n1 S ret=##class(LIS.Common.DHCVisitNumber).GenerateUploadRecordMTHD(LabNo,WGMDR,ReportDR,RepeatTCList,\u0026#34;C\u0026#34;) 删除 DeleteReportTC\n1 S ret=##class(LIS.Common.DHCVisitNumber).GenerateUploadRecordMTHD(LabNo,WGMDR,ReportDR,RepeatTCList,\u0026#34;R\u0026#34;) 复查 RepeatReportTC\n1 S ret=##class(LIS.Common.DHCVisitNumber).CreateUploadRecordMTHD(LabNo,WGMDR,ReportDR,RepeatTCList) 编号规则\n1 [[\u0026#34;\u0026#34;1\u0026#34;\u0026#34;],[\u0026#34;\u0026#34;0\u0026#34;\u0026#34;,\u0026#34;\u0026#34;1\u0026#34;\u0026#34;,\u0026#34;\u0026#34;2\u0026#34;\u0026#34;,\u0026#34;\u0026#34;3\u0026#34;\u0026#34;,\u0026#34;\u0026#34;4\u0026#34;\u0026#34;,\u0026#34;\u0026#34;5\u0026#34;\u0026#34;,\u0026#34;\u0026#34;6\u0026#34;\u0026#34;,\u0026#34;\u0026#34;7\u0026#34;\u0026#34;,\u0026#34;\u0026#34;8\u0026#34;\u0026#34;,\u0026#34;\u0026#34;9\u0026#34;\u0026#34;],[\u0026#34;\u0026#34;0\u0026#34;\u0026#34;,\u0026#34;\u0026#34;1\u0026#34;\u0026#34;,\u0026#34;\u0026#34;2\u0026#34;\u0026#34;,\u0026#34;\u0026#34;3\u0026#34;\u0026#34;,\u0026#34;\u0026#34;4\u0026#34;\u0026#34;,\u0026#34;\u0026#34;5\u0026#34;\u0026#34;,\u0026#34;\u0026#34;6\u0026#34;\u0026#34;,\u0026#34;\u0026#34;7\u0026#34;\u0026#34;,\u0026#34;\u0026#34;8\u0026#34;\u0026#34;,\u0026#34;\u0026#34;9\u0026#34;\u0026#34;],[\u0026#34;\u0026#34;0\u0026#34;\u0026#34;,\u0026#34;\u0026#34;1\u0026#34;\u0026#34;,\u0026#34;\u0026#34;2\u0026#34;\u0026#34;,\u0026#34;\u0026#34;3\u0026#34;\u0026#34;,\u0026#34;\u0026#34;4\u0026#34;\u0026#34;,\u0026#34;\u0026#34;5\u0026#34;\u0026#34;,\u0026#34;\u0026#34;6\u0026#34;\u0026#34;,\u0026#34;\u0026#34;7\u0026#34;\u0026#34;,\u0026#34;\u0026#34;8\u0026#34;\u0026#34;,\u0026#34;\u0026#34;9\u0026#34;\u0026#34;],[\u0026#34;\u0026#34;0\u0026#34;\u0026#34;,\u0026#34;\u0026#34;1\u0026#34;\u0026#34;,\u0026#34;\u0026#34;2\u0026#34;\u0026#34;,\u0026#34;\u0026#34;3\u0026#34;\u0026#34;,\u0026#34;\u0026#34;4\u0026#34;\u0026#34;,\u0026#34;\u0026#34;5\u0026#34;\u0026#34;,\u0026#34;\u0026#34;6\u0026#34;\u0026#34;,\u0026#34;\u0026#34;7\u0026#34;\u0026#34;,\u0026#34;\u0026#34;8\u0026#34;\u0026#34;,\u0026#34;\u0026#34;9\u0026#34;\u0026#34;]] ","date":"2025-09-02T00:00:00Z","image":"https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-20250902171037/assets/image-20230713171820668-20250317141249-oljkc64_hu_daf2493c3e2552.png","permalink":"https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-20250902171037/","title":"罗氏流水线RS600"},{"content":"接口说明 仪器厂商 新产业X8\n仪器型号 新产业X8\n通讯方式 单向|双向☑|主动上传\n仪器类型 免疫 医院名称 程序名称 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：串口|网口☑|监听文件|数据库|其他 连接方式：HL7协议☑\u0026ndash;OBR多行|ASTM协议|监听文件|数据库|其他 仪器接口说明 本接口采用HL7协议接口，ASTM接口缺少架子号信息，附录ASTM协议接口 串口盒子配置 波特率： 9600 数据位：8 停止位： 1 校验位： N 仪器图片 仪器配置 数据格式 项目通道号 修改记录 序号 日期 操作人 说明 1 2025-08-28 17:08:21\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 MIFSnibeLisNew(mi) ///仪器名称: 新产业流水线 ///仪器型号: SnibeLis ///仪器厂商: 新产业 ///通信协议: HL7 ///交互方式: 双 向 ///接 口: TCP/IP,RS232 ///备 注: 仪器配置:选择HL7协议,散点图选择:位图 S mi=$G(mi) S ^TMPMACH10(mi,104)=$H Q:\u0026#39;$L(mi) s par11=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s par10=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s par4=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),17) //端口号 S mi1=mi S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23) S sb=$C(11),eb=$C(28),cr=$C(13) S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=\u0026#34;\u0026#34;,kk=1 S $ZT=\u0026#34;ErrHandler\u0026#34;,$EC=\u0026#34;\u0026#34; S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType)=\u0026#34;\u0026#34; S ^TMPMACH10(mi,102)=$H Q:$$Start^MI.MIF000(mi) s par4=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 s IP=$li(^dbo.BTMIMachineParameterD(mi),9) s Port=$li(^dbo.BTMIMachineParameterD(mi),10) s LinkTime=0 s Device=\u0026#34;|TCP|\u0026#34;_Port F { try{ ;d Trace^MI.MIF000(mi,$ZA,\u0026#34;ZA\u0026#34;) i (($ZA=\u0026#34;28674\u0026#34;)) { try{d WAck }catch ex{ s exception=\u0026#34;错误:\u0026#34;_ex.Location_\u0026#34;^\u0026#34;_ex.Data_ex.Name d Trace^MI.MIF000(mi,exception,\u0026#34;读取或写入异常，重启服务端\u0026#34;) close par4 d Trace^MI.MIF000(mi,\u0026#34;仪器断开连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;blockConnect\u0026#34;) ;h 2 open Device:(IP:Port:/IOTABLE=\u0026#34;GB18030\u0026#34;):20 use Device d Trace^MI.MIF000(mi,\u0026#34;重新连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;reConnect\u0026#34;) s LinkTime=0 continue } } //未启动客户端/服务端0，客户端断开连接标志20484，无客户端连接20480，有客户端连接28674，连接并建立数据传输28672 //lis断开 i $ZA=\u0026#34;0\u0026#34; { ;h 2 open Device:(IP:Port:/IOTABLE=\u0026#34;GB18030\u0026#34;):20 use Device d Trace^MI.MIF000(mi,\u0026#34;lis断开连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;lisReConnect\u0026#34;) //throw ##class(%Exception.General).%New(\u0026#34;ConnectError\u0026#34;,\u0026#34;D\u0026#34;,,\u0026#34;重新连接失败\u0026#34;) } //仪器断开，或者无数据1min，重启tcp ;i (($ZA=\u0026#34;20484\u0026#34;)||(LinkTime=6)) { i 0,(($ZA=\u0026#34;20484\u0026#34;)) { close par4 d Trace^MI.MIF000(mi,\u0026#34;仪器断开连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;blockConnect\u0026#34;) ;h 2 open Device:(IP:Port:/IOTABLE=\u0026#34;GB18030\u0026#34;):20 use Device d Trace^MI.MIF000(mi,\u0026#34;重新连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;reConnect\u0026#34;) s LinkTime=0 continue } //连接无数据传输，main每执行6次，即1min，重启tcp i $ZA=\u0026#34;28674\u0026#34; s LinkTime=$i(LinkTime) //正常传输了，就清空计数 i $ZA=\u0026#34;28672\u0026#34; d .s LinkTime=0 . d Main }catch ex{ s exception=\u0026#34;错误:\u0026#34;_ex.Location_\u0026#34;^\u0026#34;_ex.Data_ex.Name d Trace^MI.MIF000(mi,exception,\u0026#34;读取或写入异常，重启服务端\u0026#34;) close par4 d Trace^MI.MIF000(mi,\u0026#34;仪器断开连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;blockConnect\u0026#34;) ;h 2 open Device:(IP:Port:/IOTABLE=\u0026#34;GB18030\u0026#34;):20 use Device d Trace^MI.MIF000(mi,\u0026#34;重新连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;reConnect\u0026#34;) s LinkTime=0 continue } Q:$$Stop^MI.MIF000(mi) } C par4 q WAck s ack=$c(6) ;_$c(94)_$c(82)_$c(48)_$c(49) w ack,*-3 q /* Q:$$Start^MI.MIF000(mi) F { D Main Q:$$Stop^MI.MIF000(mi) } C par4 Q*/ ErrHandler h 10 d Trace^MI.MIF000(mi,$TR($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) Q Main SET $ZTRAP=\u0026#34;ErrHandler\u0026#34;,$EC=\u0026#34;\u0026#34; R *R:10 Q:\u0026#39;$TEST //如果超时则退出 Q:$c(R)\u0026#39;=sb //以sb开头 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType,msgType,barcode,mshStr,Posi,qrdStr,MachineFlag,mid)=\u0026#34;\u0026#34; S startTime=$P($H,\u0026#34;,\u0026#34;,2) K PLIST S index=1 F { S curTime=$P($H,\u0026#34;,\u0026#34;,2) Q:curTime\u0026gt;(startTime+300) //5分钟内没有处理完则退出循环 Q:$$Stop^MI.MIF000(mi) R *R:10 Q:\u0026#39;$TEST //如果超时则退出 I $L($G(PLIST(index)))\u0026gt;=32700 { //32767 S index=+$O(PLIST(\u0026#34;\u0026#34;),-1)+1 S PLIST(index)=\u0026#34;\u0026#34; } I $C(R)\u0026#39;=eb,$C(R)\u0026#39;=cr { S PLIST(index)=$G(PLIST(index))_$C(R) } I $C(R)=cr { //解析一条记录 D Record K PLIST S index=1 } Q:$C(R)=eb //循环读取,当为eb的时候则退出 } D Trace^MI.MIF000(mi,result,\u0026#34;result\u0026#34;) D Save Q Record S index=\u0026#34;\u0026#34; S segmentType=\u0026#34;\u0026#34;,dataTye=\u0026#34;\u0026#34;,graphType=\u0026#34;\u0026#34;,base64Stream=\u0026#34;\u0026#34; S isImage=0,isBinary=0 F { S index=$O(PLIST(index)) Q:\u0026#39;$L(index) S record=$TR($G(PLIST(index)),cr) Continue:\u0026#39;$L(record) D Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) I index=1 { S segmentType=$P(record,\u0026#34;|\u0026#34;,1) I segmentType=\u0026#34;MSH\u0026#34; { //信息头信息 S mshStr=record //消息类型 S msgType=$P($P(record,\u0026#34;|\u0026#34;,9),\u0026#34;^\u0026#34;,1) //ORU,ACK,QRY,QCK,DSR I msgType=\u0026#34;OUL\u0026#34; { D SendACK(mi,record,\u0026#34;AA\u0026#34;,0,\u0026#34;Message accepted\u0026#34;) } I msgType=\u0026#34;ORM\u0026#34; { } S resultType=$P(record,\u0026#34;|\u0026#34;,11) S dateStr=$P(record,\u0026#34;|\u0026#34;,10) I dateStr?14N { S date=$ZDH($E(dateStr,1,4)_\u0026#34;-\u0026#34;_$E(dateStr,5,6)_\u0026#34;-\u0026#34;_$E(dateStr,7,8),3) S time=$ZTH($E(dateStr,9,10)_\u0026#34;:\u0026#34;_$E(dateStr,11,12)_\u0026#34;:\u0026#34;_$E(dateStr,13,14),1) } } I segmentType=\u0026#34;PID\u0026#34; { //患者信息 } I segmentType=\u0026#34;PVI\u0026#34; { //就诊信息 } I segmentType=\u0026#34;SPM\u0026#34; { //标本信息 s ResultFlag=$P(record,\u0026#34;|\u0026#34;,12)\t//P:病人样本,Q:质控品 S epis=$P($P(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,1) s QCepis=$P($P(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,3) i ResultFlag=\u0026#34;Q\u0026#34; d .s epis=QCepis } I segmentType=\u0026#34;ORC\u0026#34; { //日期信息 S dataTye=$P(record,\u0026#34;|\u0026#34;,3) //NM (numeric) 表示数字值，用于定量项目, //ST (string) 表示字符串值，用于定性项目 } I segmentType=\u0026#34;OBX\u0026#34; { S channel=$P(record,\u0026#34;|\u0026#34;,4) S value=$P(record,\u0026#34;|\u0026#34;,6) s MachID=$P(record,\u0026#34;|\u0026#34;,19) s result=channel_par10_value_par11 } //根据条码号获取LIS标本 I segmentType=\u0026#34;QPD\u0026#34; { S barcode=$P($P(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1) //QPD| TSREQ ||20251122553^1556^N0002^2|2 ;s barcode=$P(record,\u0026#34;^\u0026#34;,1) s qrdStr=$P(record,\u0026#34;|\u0026#34;,4) s RackNo=$p(qrdStr,\u0026#34;^\u0026#34;,3)_\u0026#34;-\u0026#34;_$p(qrdStr,\u0026#34;^\u0026#34;,4) s positioninfo=\u0026#34;新产业-\u0026#34;_RackNo try{j ##class(MI.Special.Common).SaveRackNo(barcode, positioninfo, mi, \u0026#34;上机\u0026#34;)}catch{}\t//YHR 202050330 仪器上机上传架子号增加上机标志 D Trace^MI.MIF000(mi,barcode_\u0026#34;$$\u0026#34;_RackNo,\u0026#34;barcode\u0026#34;) d SendORR(mi,record,\u0026#34;AA\u0026#34;,0,\u0026#34;Message accepted\u0026#34;,mshStr,barcode) } } I dataTye=\u0026#34;ED\u0026#34;,index\u0026gt;1,$L(base64Stream) { D base64Stream.Write($P(record,\u0026#34;|\u0026#34;,1)) } } Q Save ; file result if exist i $l(epis),$l(result) d .d Trace^MI.MIF000(mi,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;结果\u0026#34;) .d Save^MI.MIF000(mi,epis,result,date,time,QC) q SendACK(mi,mshStr,ackType=\u0026#34;AA\u0026#34;,errCode=0,errDesc=\u0026#34;Message accepted\u0026#34;) //send \u0026#39;ack\u0026#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(\u0026#39;$l(mi))||(\u0026#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,\u0026#34;\u0026#34;) //Q:$l(mshStr,\u0026#34;|\u0026#34;)\u0026lt;21 ret S ret=0 S msgRoutine=$P(mshStr,\u0026#34;|\u0026#34;,9) S seq=$P(mshStr,\u0026#34;|\u0026#34;,10) S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|SnibeMiddleware||LIS||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,6,$l(mshStr)) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;ACK^\u0026#34;_msgRoutine W sb,mshStr,cr,\u0026#34;MSA|\u0026#34;_ackType_\u0026#34;|\u0026#34;_seq_\u0026#34;|\u0026#34;_errDesc_\u0026#34;|||\u0026#34;_errCode_\u0026#34;|\u0026#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=\u0026#34;AA\u0026#34;:\u0026#34;ACK\u0026#34;,ackType=\u0026#34;AE\u0026#34;:\u0026#34;Error\u0026#34;,ackType=\u0026#34;AR\u0026#34;:\u0026#34;NAK\u0026#34;,1:\u0026#34;NULL\u0026#34;),\u0026#34;H--\u0026gt;M\u0026#34;) Q ret SendORR(mi,record, AckType=\u0026#34;AA\u0026#34;,ErrCode=0,ErrDesc=\u0026#34;Message accepted\u0026#34;,mshStr,epis) N (mi,record,AckType,ErrCode,ErrDesc,mshStr,epis,qrdStr) s mi=$g(mi),record=$g(record),AckType=$g(AckType),ErrCode=$g(ErrCode),ErrDesc=$g(ErrDesc),mshStr=$g(mshStr),epis=$g(epis),qrdStr=$g(qrdStr) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(\u0026#39;$l(mi))||(\u0026#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,\u0026#34;\u0026#34;) S ret=0 S seq=$P(mshStr,\u0026#34;|\u0026#34;,10) S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|LIS||SnibeMiddleware||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,7,$l(mshStr)) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;OML^O33\u0026#34; s isRecieve=epis s wgDR=\u0026#34;\u0026#34; s wgDR=$lg(^dbo.BTMIMachineParameterD(mi),6) D Trace^MI.MIF000(mi,wgDR_\u0026#34;||\u0026#34;_epis,\u0026#34;EpisNo\u0026#34;) ;\u0026amp;sql(SELECT EpisodeNo into :isRecieve FROM dbo.RP_VisitNumberReport where AssayNo=:epis and WorkGroupMachineDR=:wgDR) s flag=\u0026#34;AA\u0026#34; s MSACode=seq D Trace^MI.MIF000(mi,isRecieve,\u0026#34;isRecieve is \u0026#34;) s PatInfomation=\u0026#34;\u0026#34; s PatInfomation=$$GetPatInfo(epis,mi) D Trace^MI.MIF000(mi,PatInfomation,\u0026#34;PatInfomation is\u0026#34;) s (RegNo,Name,Birth,Species,PatType,LOC,BedNo,Fee,Srcdocno,PatAge,AgeUnitDR,Diagnose,Sampletype,Collecter,Userno,Urgent)=\u0026#34;\u0026#34; if $l(PatInfomation){ s RegNo=$p(PatInfomation,\u0026#34;,\u0026#34;,9) s Name=$p(PatInfomation,\u0026#34;,\u0026#34;,10) s Birth=$p(PatInfomation,\u0026#34;,\u0026#34;,29) s Species=$p(PatInfomation,\u0026#34;,\u0026#34;,11) s PatType=$p(PatInfomation,\u0026#34;,\u0026#34;,12) s LOC=$p(PatInfomation,\u0026#34;,\u0026#34;,6) s BedNo=$p(PatInfomation,\u0026#34;,\u0026#34;,13) s Fee=$p(PatInfomation,\u0026#34;,\u0026#34;,5) s Srcdocno=$p(PatInfomation,\u0026#34;,\u0026#34;,7) s PatAge=$p(PatInfomation,\u0026#34;,\u0026#34;,14) s AgeUnitDR=$p(PatInfomation,\u0026#34;,\u0026#34;,15) s Diagnose=$p(PatInfomation,\u0026#34;,\u0026#34;,22) s Sampletype=$p(PatInfomation,\u0026#34;,\u0026#34;,4) s Collecter=$p(PatInfomation,\u0026#34;,\u0026#34;,31) s Userno=$p(PatInfomation,\u0026#34;,\u0026#34;,8) s Urgent=$p(PatInfomation,\u0026#34;,\u0026#34;,32) } s PID=\u0026#34;PID|1|\u0026#34;_RegNo_\u0026#34;||\u0026#34;_Name_\u0026#34;||\u0026#34;_Birth_\u0026#34;|\u0026#34;_Species_\u0026#34;||||||||||||||汉族||||||中国|||||||||||\u0026#34;_PatAge_\u0026#34;^\u0026#34;_AgeUnitDR s PV1=\u0026#34;PV1|1|\u0026#34;_PatType_\u0026#34;|\u0026#34;_LOC_\u0026#34;^^^||||\u0026#34;_Srcdocno s DG1=\u0026#34;DG1|1|\u0026#34;_Diagnose s SPM=\u0026#34;SPM|1|\u0026#34;_qrdStr_\u0026#34;||\u0026#34;_Sampletype_\u0026#34;|||||||P|||\u0026#34;_Collecter_\u0026#34;^\u0026#34;_Userno_\u0026#34;^^^|||\u0026#34;_$TR($ZDT($H,8),\u0026#34; :\u0026#34;)_\u0026#34;|\u0026#34;_$TR($ZDT($H,8),\u0026#34; :\u0026#34;) s ORC=\u0026#34;ORC|NW||||||\u0026#34;_Urgent_\u0026#34;||\u0026#34;_$TR($ZDT($H,8),\u0026#34; :\u0026#34;)_\u0026#34;|||\u0026#34;_Srcdocno s curTime=$zd($h,8)_$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;,\u0026#34;\u0026#34;) s randomNumber=1000+$r(1000) s TestCodeDate=\u0026#34;\u0026#34; s TestCodeDate=$$SearchTestItem(mi,epis) s TcNum=$p(TestCodeDate,\u0026#34;@\u0026#34;,2) s TestCodeDate=$p(TestCodeDate,\u0026#34;@\u0026#34;,1) s OBR=TestCodeDate S TMPORDER=sb_mshStr_cr_PID_cr_PV1_cr_DG1_cr_SPM_cr_ORC_cr_OBR_cr_eb_cr w sb,mshStr,cr,PID,cr,PV1,cr,DG1,cr,SPM,cr,ORC,cr,OBR,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,TMPORDER,\u0026#34;H-\u0026gt;M\u0026#34;) Q ret SearchTestItem(mi,epis) S tcx=\u0026#34;\u0026#34;,tc=\u0026#34;\u0026#34;,Num=1,TcNum=1 d ScanOneON^MI.MIF000(mi,epis) i $d(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,epis)){ f { s tc=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,epis,tc)) q:tc=\u0026#34;\u0026#34; s tcx=tcx_\u0026#34;OBR|\u0026#34;_Num_\u0026#34;|||\u0026#34;_tc_cr s TcNum=TcNum+1 s Num=Num+1 } } Q tcx_\u0026#34;@\u0026#34;_TcNum GetPatInfo(labno,mi) s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 b ;09 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s CollectUserDR=$lg(RPVisitNumberData,53),CollectUser=\u0026#34;\u0026#34; i $l(CollectUserDR) s CollectUser=$lg($g(^dbo.SYSUserD(CollectUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; ;i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) S SpecimenDR=$lg(RPVisitNumberData,56) i $l(SpecimenDR) s Sampletype=$lg($g(^dbo.BTSpecimenD(SpecimenDR)),3) s Urgent=$lg(RPVisitNumberData,50) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;PerkinElme\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) s Sampleno=labno //检测号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Collecter=CollectUser s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; ;病区 s RetString=\u0026#34;\u0026#34; s EpisodeNo=\u0026#34;\u0026#34; //s Diagnose=\u0026#34;\u0026#34; s RetString=Sampleda_\u0026#34;,\u0026#34;_Instrument_\u0026#34;,\u0026#34;_Sampleno_\u0026#34;,\u0026#34;_Sampletype_\u0026#34;,\u0026#34;_Feetype_\u0026#34;,\u0026#34;_Srcdepno_\u0026#34;,\u0026#34;_Srcdocno_\u0026#34;,\u0026#34;_Userno_\u0026#34;,\u0026#34; s RetString=RetString_Patno_\u0026#34;,\u0026#34;_Patna_\u0026#34;,\u0026#34;_Sex_\u0026#34;,\u0026#34;_Pattype_\u0026#34;,\u0026#34;_Bedno_\u0026#34;,\u0026#34;_Patage_\u0026#34;,\u0026#34;_AgeUnitDR_\u0026#34;,\u0026#34;_Reqno_\u0026#34;,\u0026#34;_Reqda_\u0026#34;,\u0026#34; s RetString=RetString_Reportda_\u0026#34;,\u0026#34;_Printflag_\u0026#34;,\u0026#34;_Resultflag_\u0026#34;,\u0026#34;_Errflag_\u0026#34;,\u0026#34;_Diagnose_\u0026#34;,\u0026#34;_Description_\u0026#34;,\u0026#34;_Reserve_\u0026#34;,\u0026#34; s RetString=RetString_Patnamn_\u0026#34;,\u0026#34;_Getda_\u0026#34;,\u0026#34;_Wardno_\u0026#34;,\u0026#34;_BarCode_\u0026#34;,\u0026#34;_BirthDate_\u0026#34;,\u0026#34;_EpisodeNo_\u0026#34;,\u0026#34;_Collecter_\u0026#34;,\u0026#34;_Urgent q RetString //双向上传医嘱信息,wwh,2015-11-05,未测试 UPDATERackNo(mi, RackNo, labno) i \u0026#39;$l(labno) q \u0026#34;\u0026#34; i \u0026#39;$l(mi) q \u0026#34;\u0026#34; i \u0026#39;$l(RackNo) q \u0026#34;\u0026#34; s WGMDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i \u0026#39;$l(WGMDR) q \u0026#34;\u0026#34; //dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,122580,53,\u0026#34;\u0026#34;) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,\u0026#34; \u0026#34;_labno,\u0026#34;\u0026#34;)) s orderno=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WGMDR,\u0026#34;\u0026#34;)) i \u0026#39;$l(orderno) q \u0026#34;\u0026#34; s RPVisitNumberReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WGMDR,orderno,\u0026#34;\u0026#34;)) s ret=\u0026#34;100\u0026#34; i \u0026#39;$l(RPVisitNumberReportDR) q ret b ///更新 标本报告的位置号 s objRPVisitNumberReport=##Class(dbo.RPVisitNumberReport).%OpenId(RPVisitNumberReportDR) S objRPVisitNumberReport.RackNo=RackNo s ret=objRPVisitNumberReport.%Save() S err=\u0026#34;\u0026#34; i \u0026#39;($SYSTEM.Status.IsOK(ret)){ s err=\u0026#34;更新标本组合套信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(ret) } i $g(err)\u0026#39;=\u0026#34;\u0026#34; s ret=err q ret GetMachID(machCode) s ret=\u0026#34;\u0026#34; s machCode=$c(32)_$zcvt(machCode,\u0026#34;U\u0026#34;) s machid=$o(^dbo.BTMIMachineParameterI(\u0026#34;IndexDeviceCode\u0026#34;,1,machCode,\u0026#34;\u0026#34;)) s ret= machid q ret 附录 ASTM协议接口 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 MIFIM4000(mi) s MachID=$g(mi) S ^TMPMACH10(mi,104)=$H i \u0026#39;$l(MachID) q s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),17) s stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4),lf=$c(10),cr=$c(13),nak=$c(21),etb=$c(23) s del=\u0026#34;|\u0026#34; //s stx=\u0026#34;[\u0026#34;,etx=\u0026#34;]\u0026#34; S ^TMPMACH10(mi,102)=$H SET $ZTRAP=\u0026#34;ErrHandler\u0026#34;,iError=0 i $$Start^MI.MIF000(mi) q f d Main i $$Stop^MI.MIF000(mi) q c Port q ErrHandler s iError=+$g(iError)+1 i iError\u0026gt;100 s ret=$$Stop^MI.MIF000(mi) q d Trace^MI.MIF000(mi,$tr($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) h 10 q Main r *R:10 e d q i $c(R)=enq d .d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) .d ACK .f r *R:5 q:R=-1 q:$c(R)=eot d ..i $c(R)\u0026#39;=stx q ..d ACK ..s record=$$Read^MI.MIF000(mi,\u0026#34;\u0026#34;,etx,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,2) q:\u0026#39;$l(record) ..s record=$e(record,1,$l(record)-1) ..d Trace^MI.MIF000(mi,$tr(record,$c(13,3),\u0026#34; \u0026#34;),\u0026#34;H\u0026lt;--M\u0026#34;) ..d ACK ..s (sample,epis,surname,result,date,time,QC)=\u0026#34;\u0026#34; ..f i=1:1:$l(record,$c(13)) d ...s rec=$p(record,$c(13),i) ...i $e(rec)=\u0026#34;H\u0026#34; d q ....// ...i $e(rec)=\u0026#34;Q\u0026#34; d q ....s epis=$p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,2) ....i $l(epis) s ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,epis)=\u0026#34;\u0026#34; ...i $e(rec)=\u0026#34;P\u0026#34; d q ....// ...i $e(rec)=\u0026#34;O\u0026#34; d q ....s epis=$tr($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34; \u0026#34;) ...i $e(rec)=\u0026#34;R\u0026#34; d q ....s x1=$p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4) ....s x2=$tr($p(rec,\u0026#34;|\u0026#34;,4),\u0026#34; \u0026#34;) ....s x3=$$Change(mi,epis,x1,x2) ....s x3=\u0026#34;\u0026#34; ....d Trace^MI.MIF000(mi,mi_\u0026#34;$$\u0026#34;_epis_\u0026#34;$$\u0026#34;_x1_\u0026#34;$$\u0026#34;_x2_\u0026#34;$$\u0026#34;_x3,\u0026#34;判断\u0026#34;) ....;s x3=\u0026#34;\u0026#34; ....i $l(x1),$l(x2) s result=result_x1_$c(92)_x2_$c(92)_x3_$c(44) ...i $e(rec)=\u0026#34;L\u0026#34; d Last ..i ($c(R)=etx)||($c(R)=eot) d ...d Trace^MI.MIF000(mi,$s($c(R)=etx:\u0026#34;ETX\u0026#34;,$c(R)=eot:\u0026#34;EOT\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) ...d ACK .d ORDER .;d Trace^MI.MIF000(mi,$s($c(R)=eot:\u0026#34;EOT\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) q Last ; file result if exists d Trace^MI.MIF000(mi,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;Result\u0026#34;) i $l(epis),$l(result) d Save^MI.MIF000(mi,epis,result,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,QC) q /// d Change^MI.MIFIM4000(21,\u0026#34;*/4915176*\u0026#34;,\u0026#34;HBsAg\u0026#34;,1) Change(mi,epis,code,res) //BTMI_MachineTestCode s res1=\u0026#34;\u0026#34; s MTCDR=$o(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexResultChannel\u0026#34;,mi,code,\u0026#34;\u0026#34;)) i \u0026#39;$l(MTCDR) q \u0026#34;\u0026#34; s TestcodeDR=$lg($g(^dbo.BTMIMachineTestCodeD(MTCDR)),3) s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,epis,\u0026#34;\u0026#34;)) b ;a101 i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; s OrderNO=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,21,\u0026#34;\u0026#34;)) s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,21,OrderNO,\u0026#34;\u0026#34;)) i \u0026#39;$l(ReportDR) q \u0026#34;\u0026#34; s ResultDR=$o(^dbo.RPVisitNumberReportResultI(\u0026#34;IndexReportItem\u0026#34;,ReportDR,TestcodeDR,\u0026#34;\u0026#34;)) b ;102 i \u0026#39;$l(ResultDR) q \u0026#34;\u0026#34; s RefRanges=$lg($g(^dbo.RPVisitNumberReportResultD(ResultDR)),12) b ;a103 i \u0026#39;$l(RefRanges) q \u0026#34;\u0026#34; s (Min,Max)=\u0026#34;\u0026#34; i RefRanges[\u0026#34;-\u0026#34; d .s Min=$p(RefRanges,\u0026#34;-\u0026#34;,1) .s Max=$p(RefRanges,\u0026#34;-\u0026#34;,2) i ((res\u0026lt;Min)||(res\u0026gt;Max)) d .s res1=\u0026#34;阳性\u0026#34; e s res1=\u0026#34;阴性\u0026#34; b ;res1 q res1 ORDER ; create list of orders if exists s epis=\u0026#34;\u0026#34; f s epis=$o(^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,epis)) q:epis=\u0026#34;\u0026#34; d .i $l(epis)\u0026gt;5 d ScanOne^MI.MIF000(mi,epis) .i $l(epis)\u0026lt;=5 d ScanOneEpis^MI.MIF000(mi,epis) .s PatInfomation=$$GetPatInfo(epis,mi) .s Name=$p(PatInfomation,\u0026#34;,\u0026#34;,10) .s Species=$p(PatInfomation,\u0026#34;,\u0026#34;,11) .i Species=\u0026#34;1\u0026#34; s Species=\u0026#34;M\u0026#34; .i Species=\u0026#34;2\u0026#34; s Species=\u0026#34;F\u0026#34; .s Sampleno=$p(PatInfomation,\u0026#34;,\u0026#34;,3) .s line=$o(^TMPTMIF(mi,10,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(mi,10,line)=\u0026#34;H|\\^\u0026amp;||PSWD|Maglumi User|||||Lis||P|E1394-97|\u0026#34; .s line=$o(^TMPTMIF(mi,10,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(mi,10,line)=\u0026#34;P|1|\u0026#34;_Sampleno_\u0026#34;|||\u0026#34;_Name_\u0026#34;|||\u0026#34;_Species .s tc=\u0026#34;\u0026#34; f N=1:1 s tc=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,epis,tc)) q:tc=\u0026#34;\u0026#34; d ..;O|1|0956832800||^^^ALD|R ..s line=$o(^TMPTMIF(mi,10,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(mi,10,line)=\u0026#34;O|\u0026#34;_1_\u0026#34;|\u0026#34;_epis_\u0026#34;||^^^\u0026#34;_tc_\u0026#34;|R\u0026#34; .s line=$o(^TMPTMIF(mi,10,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(mi,10,line)=\u0026#34;L|1|N\u0026#34; //_$s(N\u0026gt;1:\u0026#34;F\u0026#34;,1:\u0026#34;I\u0026#34;) .k ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,epis) .d Send q GetEpisByLabno(mi,Epis) //通过检验号获取流水号 ;Index IndexVisitNumber On VisitNumber [ SqlName = Index_VisitNumber, Type = index, Unique ]; ;Index IndexReportID On (VisitNumberDR, WorkGroupMachineDR, OrderNo) [ SqlName = Index_ReportID, Type = index, Unique ]; s GetEpisFlag=0\t//获取最后一个 0 ，获取所有的 1 s ret=\u0026#34;\u0026#34;,mi=$g(mi),Epis=$g(Epis) i \u0026#39;$l(mi) q Epis s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i GetEpisFlag=0 d .i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis)) d ..s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis,\u0026#34;\u0026#34;)) ..i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1)) d ...s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1,\u0026#34;\u0026#34;),-1) ...s ret=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),8) i GetEpisFlag=1 d .i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis)) d ..s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis,\u0026#34;\u0026#34;)) ..s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ...s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d ....s ret=ret_\u0026#34;,\u0026#34;_$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),8) i \u0026#39;$l(ret) s ret=Epis q ret Send ; send list of orders if exists w enq,*-3 f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q i $c(R)=enq q i $c(R)\u0026#39;=ack w eot,*-3 q s x=\u0026#34;\u0026#34; f FRAME=1:1 s x=$O(^TMPTMIF(mi,10,x)) q:x=\u0026#34;\u0026#34; q:$$SEND(^TMPTMIF(mi,10,x)) i x=\u0026#34;\u0026#34; k ^TMPTMIF(mi,10) w eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q SEND(str) ; send string to instrument s str=str_cr_etx,chsum=$$CHSUM(str) w stx,str,chsum,cr,lf,*-3 d Trace^MI.MIF000(mi,str_chsum,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:6 r *R:1 i ($c(R)=ack)!($c(R)=eot) q i $c(R)=ack d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 i $c(R)=eot d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 1 d Trace^MI.MIF000(mi,R,\u0026#34;H\u0026lt;--M\u0026#34;) q 2 CHSUM(x) ; calculate check sum n (x) s z=0 f y=1:1:$l(x) s z=z+$a(x,y) s z=$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#256\\16+1)_$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#16+1) q z ACK ; send \u0026#39;ack\u0026#39; to instrument w ack,*-3 d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q GetPatInfo(labno,mi) s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,\u0026#34;\u0026#34;_labno,\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName\ts SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),2) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) ;s Sampleno=labno //检测号 s Sampleno=$$GetEpisByLabno(mi,labno) s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; ;病区 s RetString=\u0026#34;\u0026#34; s EpisodeNo=\u0026#34;\u0026#34; s Diagnose=\u0026#34;\u0026#34; s RetString=Sampleda_\u0026#34;,\u0026#34;_Instrument_\u0026#34;,\u0026#34;_Sampleno_\u0026#34;,\u0026#34;_Sampletype_\u0026#34;,\u0026#34;_Feetype_\u0026#34;,\u0026#34;_Srcdepno_\u0026#34;,\u0026#34;_Srcdocno_\u0026#34;,\u0026#34;_Userno_\u0026#34;,\u0026#34; s RetString=RetString_Patno_\u0026#34;,\u0026#34;_Patna_\u0026#34;,\u0026#34;_Sex_\u0026#34;,\u0026#34;_Pattype_\u0026#34;,\u0026#34;_Bedno_\u0026#34;,\u0026#34;_Patage_\u0026#34;,\u0026#34;_Ageunit_\u0026#34;,\u0026#34;_Reqno_\u0026#34;,\u0026#34;_Reqda_\u0026#34;,\u0026#34; s RetString=RetString_Reportda_\u0026#34;,\u0026#34;_Printflag_\u0026#34;,\u0026#34;_Resultflag_\u0026#34;,\u0026#34;_Errflag_\u0026#34;,\u0026#34;_Diagnose_\u0026#34;,\u0026#34;_Description_\u0026#34;,\u0026#34;_Reserve_\u0026#34;,\u0026#34; s RetString=RetString_Patnamn_\u0026#34;,\u0026#34;_Getda_\u0026#34;,\u0026#34;_Wardno_\u0026#34;,\u0026#34;_BarCode_\u0026#34;,\u0026#34;_BirthDate_\u0026#34;,\u0026#34;_EpisodeNo q RetString Test ; create list of orders if exists s ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,\u0026#34;*/4914066*\u0026#34;)=\u0026#34;\u0026#34; s mi=\u0026#34;21\u0026#34; s epis=\u0026#34;\u0026#34; f s epis=$o(^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,epis)) q:epis=\u0026#34;\u0026#34; d .i $l(epis)\u0026gt;5 d ScanOne^MI.MIF000(mi,epis) .b ;a102 .i $l(epis)\u0026lt;=5 d ScanOneEpis^MI.MIF000(mi,epis) .s line=$o(^TMPTMIF(mi,10,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(mi,10,line)=\u0026#34;H|\\^\u0026amp;||PSWD|Maglumi User|||||Lis||P|E1394-97|\u0026#34; .s line=$o(^TMPTMIF(mi,10,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(mi,10,line)=\u0026#34;P|1|\u0026#34; .b ;a101 .s tc=\u0026#34;\u0026#34; f N=1:1 s tc=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,epis,tc)) q:tc=\u0026#34;\u0026#34; d ..;O|1|0956832800||^^^ALD|R ..s line=$o(^TMPTMIF(mi,10,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(mi,10,line)=\u0026#34;O|\u0026#34;_1_\u0026#34;|\u0026#34;_epis_\u0026#34;||^^^\u0026#34;_tc_\u0026#34;|R\u0026#34; .s line=$o(^TMPTMIF(mi,10,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(mi,10,line)=\u0026#34;L|1|N\u0026#34; //_$s(N\u0026gt;1:\u0026#34;F\u0026#34;,1:\u0026#34;I\u0026#34;) .k ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,epis) .d Send q ","date":"2025-09-02T00:00:00Z","image":"https://work.717170.xyz/img/title.jpg","permalink":"https://work.717170.xyz/p/%E6%96%B0%E4%BA%A7%E4%B8%9Ax8-20250902225652/","title":"新产业X8"},{"content":"上机请求双向 HL7 协议接口双向 回传多行 DSP 回传信息时要求有 DSP 字段，且 DSP 字段前 28 行为患者信息，第 29 行之后为检测项目信息。\n示例接口(亚辉龙 3000) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 /// 名称: MI.MIFI3000 /// 描述: 深圳亚辉龙iFlash3000 双向仪器接口 MIFI3000(mi) S mi=$G(mi) Q:\u0026#39;$L(mi) s par11=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s par10=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s par4=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 S mi1=mi S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23) S sb=$C(11),eb=$C(28),cr=$C(13) S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=\u0026#34;\u0026#34;,kk=1 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType)=\u0026#34;\u0026#34; Q:$$StartUTF8^MI.MIF000(mi) F { D Main Q:$$Stop^MI.MIF000(mi) } C par4 Q Main S $ZT=\u0026#34;ErrHandler\u0026#34;,$EC=\u0026#34;\u0026#34; R *R:10 Q:\u0026#39;$TEST //如果超时则退出 Q:$c(R)\u0026#39;=sb //以sb开头 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType,msgType,barcode,mshStr)=\u0026#34;\u0026#34; S startTime=$P($H,\u0026#34;,\u0026#34;,2) K PLIST S index=1 F { S curTime=$P($H,\u0026#34;,\u0026#34;,2) Q:curTime\u0026gt;(startTime+300) //5分钟内没有处理完则退出循环 Q:$$Stop^MI.MIF000(mi) R *R:10 Q:\u0026#39;$TEST //如果超时则退出 I $L($G(PLIST(index)))\u0026gt;=32700 { //32767 S index=+$O(PLIST(\u0026#34;\u0026#34;),-1)+1 S PLIST(index)=\u0026#34;\u0026#34; } I $C(R)\u0026#39;=eb,$C(R)\u0026#39;=cr { S PLIST(index)=$G(PLIST(index))_$C(R) } I $C(R)=cr { //解析一条记录 D Record K PLIST S index=1 } Q:$C(R)=eb //循环读取,当为eb的时候则退出 } D Save Q Record K ^TMPMACHINEEPIS(mi) S index=\u0026#34;\u0026#34; S segmentType=\u0026#34;\u0026#34;,dataTye=\u0026#34;\u0026#34;,graphType=\u0026#34;\u0026#34; S isImage=0,isBinary=0 F { S index=$O(PLIST(index)) Q:\u0026#39;$L(index) S record=$TR($G(PLIST(index)),cr) Continue:\u0026#39;$L(record) D Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) I index=1 { S segmentType=$P(record,\u0026#34;|\u0026#34;,1) ;消息段(数据类型) MSH\tMSA PID OBR OBX ORD QRF ERR QAK DSP DSC I segmentType=\u0026#34;MSH\u0026#34; { //信息头信息 S mshStr=record //消息类型 S msgType=$P($P(record,\u0026#34;|\u0026#34;,9),\u0026#34;^\u0026#34;,1) //ORU,ACK,QRY,QCK,DSR I msgType=\u0026#34;ORU\u0026#34; { D SendACK(mi,record,\u0026#34;AA\u0026#34;,0,\u0026#34;Message accepted\u0026#34;) } I msgType=\u0026#34;ORM\u0026#34; { } I msgType=\u0026#34;QRY\u0026#34; { D SendQryACK(mi,record,\u0026#34;AA\u0026#34;,0,\u0026#34;Message accepted\u0026#34;) } S resultType=$P(record,\u0026#34;|\u0026#34;,11) } I segmentType=\u0026#34;PID\u0026#34; { //患者信息 } I segmentType=\u0026#34;PVI\u0026#34; { //就诊信息 } I segmentType=\u0026#34;OBR\u0026#34; { //医嘱信息 S epis=$P(record,\u0026#34;|\u0026#34;,3) S:\u0026#39;$l(epis) epis=$P(record,\u0026#34;|\u0026#34;,4) S dateStr=$P(record,\u0026#34;|\u0026#34;,8) I dateStr?14N { S date=$ZDH($E(dateStr,1,4)_\u0026#34;-\u0026#34;_$E(dateStr,5,6)_\u0026#34;-\u0026#34;_$E(dateStr,7,8),3) S time=$ZTH($E(dateStr,9,10)_\u0026#34;:\u0026#34;_$E(dateStr,11,12)_\u0026#34;:\u0026#34;_$E(dateStr,13,14),1) } S code=$P($P(record,\u0026#34;|\u0026#34;,5),\u0026#34;^\u0026#34;,1) } I segmentType=\u0026#34;OBX\u0026#34; { S dataTye=$P(record,\u0026#34;|\u0026#34;,3) //NM (numeric) 表示数字值，用于定量项目, //ST (string) 表示字符串值，用于定性项目 S channel=$P(record,\u0026#34;|\u0026#34;,4) S channel=$P(channel,\u0026#34;^\u0026#34;,1) S value=$P(record,\u0026#34;|\u0026#34;,6) I $L(channel),dataTye\u0026#39;=\u0026#34;ED\u0026#34;,dataTye\u0026#39;=\u0026#34;IS\u0026#34; { S result=result_channel_par10_value_par11 } } //根据条码号获取LIS标本 I segmentType=\u0026#34;QRD\u0026#34; { S barcode=$P(record,\u0026#34;|\u0026#34;,9) //QRD|20161208150935|R|D|1|||RD|16120703726|OTH|||T| I $L(barcode) { S ^TMPMACHINEEPIS(mi,\u0026#34;B\u0026#34;,barcode,\u0026#34;MSH\u0026#34;)=mshStr S ^TMPMACHINEEPIS(mi,\u0026#34;B\u0026#34;,barcode,\u0026#34;QRD\u0026#34;)=record } } //根据查询条件获取LIS标本 I segmentType=\u0026#34;QRF\u0026#34; { S tRecord=record S record=$TR(record,\u0026#34; \u0026#34;) S qryStartDate=$P(record,\u0026#34;|\u0026#34;,3) S qryEndDate=$P(record,\u0026#34;|\u0026#34;,4) S sampleIdStart=$P(record,\u0026#34;|\u0026#34;,5) S sampleIdEnd=$P(record,\u0026#34;|\u0026#34;,6) S:\u0026#39;$L(qryStartDate) qryStartDate=qryEndDate S:\u0026#39;$L(qryEndDate) qryEndDate=qryStartDate S:\u0026#39;$L(sampleIdStart) sampleIdStart=sampleIdEnd S:\u0026#39;$L(sampleIdEnd) sampleIdEnd=sampleIdStart //通过样本号段查询 QRF|iFlash3000|||1|9|RCT|COR|ALL|| I sampleIdStart?1.N,sampleIdEnd?1.N { F sampleId=sampleIdStart:1:sampleIdEnd { S ^TMPMACHINEEPIS(mi,\u0026#34;S\u0026#34;,sampleId,\u0026#34;MSH\u0026#34;)=mshStr S ^TMPMACHINEEPIS(mi,\u0026#34;S\u0026#34;,sampleId,\u0026#34;QRF\u0026#34;)=tRecord } } //通过时间段查询\tQRF|iFlash3000|20160122080000|20160122120000|||RCT|COR|ALL|| I qryStartDate?1.N,qryEndDate?1.N { F qryDate=qryStartDate:1:qryEndDate { S ^TMPMACHINEEPIS(mi,\u0026#34;D\u0026#34;,qryDate,\u0026#34;MSH\u0026#34;)=mshStr S ^TMPMACHINEEPIS(mi,\u0026#34;D\u0026#34;,qryDate,\u0026#34;QRF\u0026#34;)=tRecord } } } } } //根本样本号获取条码号 S sampleId=\u0026#34;\u0026#34; F { S sampleId=$O(^TMPMACHINEEPIS(mi,\u0026#34;B\u0026#34;,sampleId)) Q:\u0026#39;$L(sampleId) //暂不处理 } //根本日期获取条码号 S qryDate=\u0026#34;\u0026#34; F { S qryDate=$O(^TMPMACHINEEPIS(mi,\u0026#34;D\u0026#34;,qryDate)) Q:\u0026#39;$L(qryDate) //暂不处理 } //上传标本 S barcode=\u0026#34;\u0026#34;,barcodeIndex=0 F { S barcode=$O(^TMPMACHINEEPIS(mi,\u0026#34;B\u0026#34;,barcode)) Q:\u0026#39;$L(barcode) S mshStr=$G(^TMPMACHINEEPIS(mi,\u0026#34;B\u0026#34;,barcode)) S barcodeIndex=barcodeIndex+1 I $O(^TMPMACHINEEPIS(mi,\u0026#34;B\u0026#34;,barcode))=\u0026#34;\u0026#34; { S barcodeIndex=\u0026#34;\u0026#34; //最后一个为空 } S mshStr=$G(^TMPMACHINEEPIS(mi,\u0026#34;B\u0026#34;,barcode,\u0026#34;MSH\u0026#34;)) S qrdStr=$G(^TMPMACHINEEPIS(mi,\u0026#34;B\u0026#34;,barcode,\u0026#34;QRD\u0026#34;)) S qrfStr=$G(^TMPMACHINEEPIS(mi,\u0026#34;B\u0026#34;,barcode,\u0026#34;QRF\u0026#34;)) I \u0026#39;$L(qrdStr) { S qrdStr=\u0026#34;QRD|\u0026#34;_$TR($ZDT($H,8),\u0026#34; :\u0026#34;)_\u0026#34;|R|D|1|||RD||OTH|||T|\u0026#34; } I \u0026#39;$L(qrfStr) { S qrfStr=\u0026#34;QRF|iFlash3000|||||RCT|COR|ALL||\u0026#34; } S $P(qrdStr,\u0026#34;|\u0026#34;,9)=\u0026#34;\u0026#34; S ret=$$SendOrder(mi,mshStr,qrdStr,qrfStr,barcode,barcodeIndex) } K ^TMPMACHINEEPIS(mi) Q Save D Trace^MI.MIF000(mi,epis_\u0026#34;^\u0026#34;_result,\u0026#34;Test\u0026#34;) I $l(epis),$l(result) { S QC=\u0026#34;\u0026#34; ;S result=$$TransResult(mi,result) D Save^MI.MIF000(mi,epis,result,date,time,QC) } S (sample,epis,surname,rec,res,result,date,time,QC,resultType)=\u0026#34;\u0026#34; Q SendACK(mi,mshStr,ackType=\u0026#34;AA\u0026#34;,errCode=0,errDesc=\u0026#34;Message accepted\u0026#34;) //send \u0026#39;ack\u0026#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(\u0026#39;$l(mi))||(\u0026#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,\u0026#34;\u0026#34;) //Q:$l(mshStr,\u0026#34;|\u0026#34;)\u0026lt;21 ret S ret=0 S msgRoutine=$P($P(mshStr,\u0026#34;|\u0026#34;,9),\u0026#34;^\u0026#34;,2) S seq=$P(mshStr,\u0026#34;|\u0026#34;,10) S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|LIS|||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,6,$l(mshStr)) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;ACK^\u0026#34;_msgRoutine W sb,mshStr,cr,\u0026#34;MSA|\u0026#34;_ackType_\u0026#34;|\u0026#34;_seq_\u0026#34;|\u0026#34;_errDesc_\u0026#34;|||\u0026#34;_errCode_\u0026#34;|\u0026#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=\u0026#34;AA\u0026#34;:\u0026#34;ACK\u0026#34;,ackType=\u0026#34;AE\u0026#34;:\u0026#34;Error\u0026#34;,ackType=\u0026#34;AR\u0026#34;:\u0026#34;NAK\u0026#34;,1:\u0026#34;NULL\u0026#34;),\u0026#34;H--\u0026gt;M\u0026#34;) Q ret SendQryACK(mi,mshStr,ackType=\u0026#34;AA\u0026#34;,errCode=0,errDesc=\u0026#34;Message accepted\u0026#34;) //send \u0026#39;ack\u0026#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(\u0026#39;$l(mi))||(\u0026#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,\u0026#34;\u0026#34;) S ret=0 S msgRoutine=$P($P(mshStr,\u0026#34;|\u0026#34;,9),\u0026#34;^\u0026#34;,2) S seq=$P(mshStr,\u0026#34;|\u0026#34;,10) S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|LIS|||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,6,$l(mshStr)) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;QCK^\u0026#34;_msgRoutine W sb,mshStr,cr,\u0026#34;MSA|\u0026#34;_ackType_\u0026#34;|\u0026#34;_seq_\u0026#34;|\u0026#34;_errDesc_\u0026#34;|||\u0026#34;_errCode_\u0026#34;|\u0026#34;,cr,\u0026#34;ERR|0|\u0026#34;,cr,\u0026#34;QAK|SR|OK|\u0026#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=\u0026#34;AA\u0026#34;:\u0026#34;QACK\u0026#34;,ackType=\u0026#34;AE\u0026#34;:\u0026#34;Error\u0026#34;,ackType=\u0026#34;AR\u0026#34;:\u0026#34;QNAK\u0026#34;,1:\u0026#34;NULL\u0026#34;),\u0026#34;H--\u0026gt;M\u0026#34;) Q ret ErrHandler h 10 D Trace^MI.MIF000(mi,$TR($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) Q //双向上传医嘱信息,wwh,2015-11-05 SendOrder(mi,mshStr,qrdStr,qrfStr,barcode,DSC) N (mi,mshStr,qrdStr,qrfStr,barcode,DSC) S mi=$G(mi),mshStr=$G(mshStr),barcode=$G(barcode),DSC=$G(DSC),qrdStr=$G(qrdStr),qrfStr=$G(qrfStr) S sb=$C(11),eb=$C(28),cr=$C(13) I \u0026#39;$L(barcode) { D Trace^MI.MIF000(mi,\u0026#34;条码号为空\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } I $ZCVT(barcode,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;) { //条码扫描错误 D Trace^MI.MIF000(mi,\u0026#34;条码扫描错误,机器未识别\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } S labno=barcode S workGroupMachineDR=$LG($G(^dbo.BTMIMachineParameterD(mi)),6) S visiNumberDR=$O(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) I \u0026#39;$L(visiNumberDR) { D Trace^MI.MIF000(mi,\u0026#34;在检验系统未找到条码:\u0026#34;_labno_\u0026#34;对应的标本信息,确定条码正确或标本已经接收?\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } S visNumberObj=##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR) I \u0026#39;$L(visNumberObj) { D Trace^MI.MIF000(mi,\u0026#34;在检验系统未找到条码:\u0026#34;_labno_\u0026#34;对应的标本信息,确定条码正确或标本已经接收?\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } D Trace^MI.MIF000(mi,labno,\u0026#34;Upload Start\u0026#34;) K ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno) D ScanOne^MI.MIF000(mi,labno) S result=\u0026#34;\u0026#34; S chlStr=\u0026#34;\u0026#34; S chl=\u0026#34;\u0026#34;,chlCnt=29 F { S chl=$O(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) Q:\u0026#39;$L(chl) S chlStr=chlStr_\u0026#34;DSP|\u0026#34;_chlCnt_\u0026#34;||\u0026#34;_chl_\u0026#34;^^^|||\u0026#34;_cr S chlCnt=chlCnt+1 ;S result=result_chl_$C(92)_\u0026#34;?\u0026#34;_$C(44) } I \u0026#39;$L(chlStr) { D Trace^MI.MIF000(mi,\u0026#34;在检验系统未找到条码:\u0026#34;_labno_\u0026#34;对应的化验项目信息,确定医嘱或项目维护正确?\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } D Save^MI.MIF000(mi,labno,result,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) S specimenDR=$LG($G(^dbo.RPVisitNumberD(visiNumberDR)),56) S specimenName=\u0026#34;\u0026#34; S:$L(specimenDR) specimenName=$LG($G(^dbo.BTSpecimenD(specimenDR)),3) S sampleType=\u0026#34;其他\u0026#34; I $L(specimenName),\u0026#34;,血清,血浆,尿液,脑脊液,\u0026#34;[(\u0026#34;,\u0026#34;_specimenName_\u0026#34;,\u0026#34;) { S sampleType=specimenName } S birdthday=visNumberObj.BirthDate S:$L(birdthday)=8 birdthday=birdthday_\u0026#34;000000\u0026#34; S:\u0026#39;$L(mshStr) mshStr=\u0026#34;MSH|^~\\\u0026amp;|YHLO|iFlash3000|||20161208150935||QRY^Q02|18|P|2.3.1||||||ASCII|||\u0026#34; S mshSeq=$P(mshStr,\u0026#34;|\u0026#34;,10) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;DSR^Q03\u0026#34; S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|LIS|||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,6,$l(mshStr)) S episode=\u0026#34;\u0026#34; S workGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) //##Class(MI.Instrument).GetWorkGroupMachineRowId(mi) I $L(workGroupMachineDR) { S OrderNo=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,visiNumberDR,workGroupMachineDR,\u0026#34;\u0026#34;)) I $L(OrderNo) { S reportDR=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,visiNumberDR,workGroupMachineDR,OrderNo,\u0026#34;\u0026#34;)) S episode=\u0026#34;\u0026#34; //##Class(LIS.Core.Report).GetEpisodeNumber(reportDR) i $l(reportDR) s Assayno=$lg($g(^dbo.RPVisitNumberReportD(reportDR)),6) } } S order=mshStr_cr //\u0026#34;MSH|^~\\\u0026amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||\u0026#34;_cr S order=order_\u0026#34;MSA|AA|\u0026#34;_mshSeq_\u0026#34;|Message accepted|||0|\u0026#34;_cr S order=order_\u0026#34;ERR|0|\u0026#34;_cr S order=order_\u0026#34;QAK|SR|OK|\u0026#34;_cr S order=order_qrdStr_cr //\u0026#34;QRD|20160122110540|R|D|1|||RD||OTH|||T|\u0026#34;_cr S order=order_qrfStr_cr //\u0026#34;QRF|iFlash3000|||||RCT|COR|ALL||\u0026#34;_cr S order=order_\u0026#34;DSP|1||\u0026#34;_visNumberObj.RegNo_\u0026#34;|||\u0026#34;_cr\t//住院号 S order=order_\u0026#34;DSP|2||\u0026#34;_visNumberObj.BedNo_\u0026#34;|||\u0026#34;_cr\t//床号 S order=order_\u0026#34;DSP|3||\u0026#34;_visNumberObj.SurName_\u0026#34;|||\u0026#34;_cr\t//病人姓名 /* S order=order_\u0026#34;DSP|1||\u0026#34;_visNumberObj.RegNo_\u0026#34;|||\u0026#34;_cr\t//住院号 S order=order_\u0026#34;DSP|2||\u0026#34;_episode_\u0026#34;|||\u0026#34;_cr\t//床号 //S order=order_\u0026#34;DSP|3||\u0026#34;_visNumberObj.SurName_\u0026#34;|||\u0026#34;_cr\t//病人姓名 S order=order_\u0026#34;DSP|3||\u0026#34;_episode_\u0026#34;|||\u0026#34;_cr\t//病人姓名 */ S order=order_\u0026#34;DSP|4||\u0026#34;_birdthday_\u0026#34;|||\u0026#34;_cr\t//出生日期 S order=order_\u0026#34;DSP|5||\u0026#34;_$S(visNumberObj.SpeciesDR=1:\u0026#34;M\u0026#34;,visNumberObj.SpeciesDR=2:\u0026#34;F\u0026#34;,1:\u0026#34;O\u0026#34;)_\u0026#34;|||\u0026#34;_cr\t//性别 S order=order_\u0026#34;DSP|6|||||\u0026#34;_cr\t//血型 S order=order_\u0026#34;DSP|7|||||\u0026#34;_cr\t//种族 S order=order_\u0026#34;DSP|8|||||\u0026#34;_cr\t//地址 S order=order_\u0026#34;DSP|9|||||\u0026#34;_cr\t//邮编 S order=order_\u0026#34;DSP|10|||||\u0026#34;_cr\t//家庭电话 S order=order_\u0026#34;DSP|11|||||\u0026#34;_cr\t//样本位 S order=order_\u0026#34;DSP|12|||||\u0026#34;_cr\t//样本采集时间 S order=order_\u0026#34;DSP|13|||||\u0026#34;_cr\t//未用 S order=order_\u0026#34;DSP|14|||||\u0026#34;_cr\t//未用 S order=order_\u0026#34;DSP|15|||||\u0026#34;_cr\t//病人类别 S order=order_\u0026#34;DSP|16|||||\u0026#34;_cr\t//医保帐号 S order=order_\u0026#34;DSP|17|||||\u0026#34;_cr\t//收费类型 S order=order_\u0026#34;DSP|18|||||\u0026#34;_cr\t//民族 S order=order_\u0026#34;DSP|19|||||\u0026#34;_cr\t//籍贯 S order=order_\u0026#34;DSP|20|||||\u0026#34;_cr\t//国家 S order=order_\u0026#34;DSP|21||\u0026#34;_barcode_\u0026#34;|||\u0026#34;_cr\t//*样本条码 S order=order_\u0026#34;DSP|22||\u0026#34;_barcode_\u0026#34;|||\u0026#34;_cr\t//*样本编号 S order=order_\u0026#34;DSP|23|||||\u0026#34;_cr\t//送检时间 S order=order_\u0026#34;DSP|24||\u0026#34;_$S(visNumberObj.Urgent=1:\u0026#34;Y\u0026#34;,1:\u0026#34;N\u0026#34;)_\u0026#34;|||\u0026#34;_cr\t//*是否急诊 S order=order_\u0026#34;DSP|25|||||\u0026#34;_cr\t//未用 S order=order_\u0026#34;DSP|26||\u0026#34;_sampleType_\u0026#34;|||\u0026#34;_cr\t//*样本类型(血清,血浆,尿液,脑脊液,其他) S order=order_\u0026#34;DSP|27|||||\u0026#34;_cr\t//送检医生 S order=order_\u0026#34;DSP|28|||||\u0026#34;_cr\t//送检科室 S order=order_chlStr S order=order_\u0026#34;DSC|\u0026#34;_DSC_\u0026#34;|\u0026#34;_cr W sb,order,eb,cr,*-3 D Trace^MI.MIF000(mi,sb_order_eb_cr,\u0026#34;H--\u0026gt;M\u0026#34;) //$TR($ZDT($H,8),\u0026#34; :\u0026#34;) Q 0 //d Test^MI.MIFIFLASH3000N(\u0026#34;22\u0026#34;,9000000266) Test(mi,barcode) N (mi,barcode) S mi=$G(mi),barcode=$G(barcode) S mshStr=\u0026#34;MSH|^~\\\u0026amp;|YHLO|iFlash3000|||20160122110540||QRY^Q02|14|P|2.3.1||||||ASCII|||\u0026#34; S DSC=\u0026#34;\u0026#34; S qrdStr=\u0026#34;QRD|20160122110540|R|D|1|||RD|BarCode1|OTH|||T|\u0026#34; S qrfStr=\u0026#34;QRF|iFlash3000|||||RCT|COR|ALL||\u0026#34; S sb=\u0026#34;\u0026lt;SB\u0026gt;\u0026#34;,eb=\u0026#34;\u0026lt;EB\u0026gt;\u0026#34;,cr=\u0026#34;\u0026lt;CR\u0026gt;\u0026#34; I \u0026#39;$L(barcode) { W \u0026#34;条码号为空\u0026#34;,! Q 1 } I $ZCVT(barcode,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;) { //条码扫描错误 W \u0026#34;条码扫描错误,机器未识别\u0026#34;,! Q 1 } S labno=barcode S workGroupMachineDR=$LG($G(^dbo.BTMIMachineParameterD(mi)),6) S visiNumberDR=$O(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) I \u0026#39;$L(visiNumberDR) { W \u0026#34;条码未接收\u0026#34;,! Q 1 } I \u0026#39;$L(visiNumberDR) { W \u0026#34;在检验系统未找到条码:\u0026#34;_labno_\u0026#34;对应的标本信息,确定条码正确或标本已经接收?\u0026#34;,! Q 1 } S visNumberObj=##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR) I \u0026#39;$L(visNumberObj) { W \u0026#34;在检验系统未找到条码:\u0026#34;_labno_\u0026#34;对应的标本信息,确定条码正确或标本已经接收?\u0026#34;,! Q 1 } K ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno) D ScanOne^MI.MIF000(mi,labno) S chlStr=\u0026#34;\u0026#34; b ;a102 S chl=\u0026#34;\u0026#34;,chlCnt=29 F { S chl=$O(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) Q:\u0026#39;$L(chl) S chlStr=chlStr_\u0026#34;DSP|\u0026#34;_chlCnt_\u0026#34;||\u0026#34;_chl_\u0026#34;^^^|||\u0026#34;_cr S chlCnt=chlCnt+1 } I \u0026#39;$L(chlStr) { W \u0026#34;在检验系统未找到条码:\u0026#34;_labno_\u0026#34;对应的化验项目信息,确定医嘱或项目维护正确?\u0026#34;,! Q 1 } S specimenDR=$LG($G(^dbo.RPVisitNumberD(visiNumberDR)),56) S specimenName=\u0026#34;\u0026#34; S:$L(specimenDR) specimenName=$LG($G(^dbo.BTSpecimenD(specimenDR)),3) S sampleType=\u0026#34;其他\u0026#34; I $L(specimenName),\u0026#34;,血清,血浆,尿液,脑脊液,\u0026#34;[(\u0026#34;,\u0026#34;_specimenName_\u0026#34;,\u0026#34;) { S sampleType=specimenName } S birdthday=visNumberObj.BirthDate S:$L(birdthday)=8 birdthday=birdthday_\u0026#34;000000\u0026#34; S mshSeq=$P(mshStr,\u0026#34;|\u0026#34;,10) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;DSR^Q03\u0026#34; S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|LIS|||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,6,$l(mshStr)) S order=mshStr_cr //\u0026#34;MSH|^~\\\u0026amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||\u0026#34;_cr S order=order_\u0026#34;MSA|AA|\u0026#34;_mshSeq_\u0026#34;|Message accepted|||0|\u0026#34;_cr S order=order_\u0026#34;ERR|0|\u0026#34;_cr S order=order_\u0026#34;QAK|SR|OK|\u0026#34;_cr S order=order_qrdStr_cr //\u0026#34;QRD|20160122110540|R|D|1|||RD||OTH|||T|\u0026#34;_cr S order=order_qrfStr_cr //\u0026#34;QRF|iFlash3000|||||RCT|COR|ALL||\u0026#34;_cr S order=order_\u0026#34;DSP|1||\u0026#34;_visNumberObj.RegNo_\u0026#34;|||\u0026#34;_cr\t//住院号 S order=order_\u0026#34;DSP|2||\u0026#34;_visNumberObj.BedNo_\u0026#34;|||\u0026#34;_cr\t//床号 S order=order_\u0026#34;DSP|3||\u0026#34;_visNumberObj.SurName_\u0026#34;|||\u0026#34;_cr\t//病人姓名 b ;a101 S order=order_\u0026#34;DSP|4||\u0026#34;_birdthday_\u0026#34;|||\u0026#34;_cr\t//出生日期 S order=order_\u0026#34;DSP|5||\u0026#34;_$S(visNumberObj.SpeciesDR=1:\u0026#34;M\u0026#34;,visNumberObj.SpeciesDR=2:\u0026#34;F\u0026#34;,1:\u0026#34;O\u0026#34;)_\u0026#34;|||\u0026#34;_cr\t//性别 S order=order_\u0026#34;DSP|6|||||\u0026#34;_cr\t//血型 S order=order_\u0026#34;DSP|7|||||\u0026#34;_cr\t//种族 S order=order_\u0026#34;DSP|8|||||\u0026#34;_cr\t//地址 S order=order_\u0026#34;DSP|9|||||\u0026#34;_cr\t//邮编 S order=order_\u0026#34;DSP|10|||||\u0026#34;_cr\t//家庭电话 S order=order_\u0026#34;DSP|11|||||\u0026#34;_cr\t//样本位 S order=order_\u0026#34;DSP|12|||||\u0026#34;_cr\t//样本采集时间 S order=order_\u0026#34;DSP|13|||||\u0026#34;_cr\t//未用 S order=order_\u0026#34;DSP|14|||||\u0026#34;_cr\t//未用 S order=order_\u0026#34;DSP|15|||||\u0026#34;_cr\t//病人类别 S order=order_\u0026#34;DSP|16|||||\u0026#34;_cr\t//医保帐号 S order=order_\u0026#34;DSP|17|||||\u0026#34;_cr\t//收费类型 S order=order_\u0026#34;DSP|18|||||\u0026#34;_cr\t//民族 S order=order_\u0026#34;DSP|19|||||\u0026#34;_cr\t//籍贯 S order=order_\u0026#34;DSP|20|||||\u0026#34;_cr\t//国家 S order=order_\u0026#34;DSP|21||\u0026#34;_barcode_\u0026#34;|||\u0026#34;_cr\t//*样本条码 S order=order_\u0026#34;DSP|22||\u0026#34;_barcode_\u0026#34;|||\u0026#34;_cr\t//*样本编号 S order=order_\u0026#34;DSP|23|||||\u0026#34;_cr\t//送检时间 S order=order_\u0026#34;DSP|24||\u0026#34;_$S(visNumberObj.Urgent=1:\u0026#34;Y\u0026#34;,1:\u0026#34;N\u0026#34;)_\u0026#34;|||\u0026#34;_cr\t//*是否急诊 S order=order_\u0026#34;DSP|25|||||\u0026#34;_cr\t//未用 S order=order_\u0026#34;DSP|26||\u0026#34;_sampleType_\u0026#34;|||\u0026#34;_cr\t//*样本类型(血清,血浆,尿液,脑脊液,其他) S order=order_\u0026#34;DSP|27|||||\u0026#34;_cr\t//送检医生 S order=order_\u0026#34;DSP|28|||||\u0026#34;_cr\t//送检科室 S order=order_chlStr S order=order_\u0026#34;DSC|\u0026#34;_DSC_\u0026#34;|\u0026#34;_cr W sb,order,eb,cr,! Q 0 TransResult(miRowId,result) N (miRowId,result) S miRowId=$G(miRowId),result=$G(result),newRes=\u0026#34;\u0026#34; F i=1:1:$L(result,\u0026#34;,\u0026#34;) { S chlStr=$P(result,\u0026#34;,\u0026#34;,i) Continue:\u0026#39;$L(chlStr) S chl=$P(chlStr,\u0026#34;\\\u0026#34;,1) S val=$P(chlStr,\u0026#34;\\\u0026#34;,2) Continue:\u0026#39;$L(chl) S res=val I chl\u0026gt;97,chl\u0026lt;102,val\u0026#39;[\u0026#34;?\u0026#34; { S res=$$GetQuaResult(miRowId,chl,val) } S newRes=newRes_chl_$C(92)_res_$C(44) } Q:$L(newRes) newRes Q result GetQuaResult(miRowId,chl,res) N (miRowId,chl,res) S miRowId=$G(miRowId),chl=$G(chl),res=$G(res) S:res?1\u0026#34;.\u0026#34;1.N res=\u0026#34;0\u0026#34;_res S orgRes=res S resPrefix=$E(res,1) S:\u0026#34;\u0026lt;\u0026gt;\u0026#34;\u0026#39;[resPrefix resPrefix=\u0026#34;\u0026#34; I $L(resPrefix) { S res=$P(res,resPrefix,2) } Q:\u0026#39;$L(chl) orgRes Q:(res\u0026#39;?0.N1.\u0026#34;.\u0026#34;1.N)\u0026amp;\u0026amp;(res\u0026#39;?1.N) orgRes S tcRefRowId=$O(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexResultChannel\u0026#34;,miRowId,##Class(LIS.Util.Common).IndexData(chl),\u0026#34;\u0026#34;)) Q:\u0026#39;$L(tcRefRowId) orgRes S tcRowId=$LG($G(^dbo.BTMIMachineTestCodeD(tcRefRowId)),3) Q:\u0026#39;$L(tcRowId) orgRes S orderNo=$O(^dbo.BTTestCodeRangesI(\u0026#34;IndexMaster\u0026#34;,tcRowId,\u0026#34;\u0026#34;)) Q:\u0026#39;$L(orderNo) orgRes S rangeDR=$O(^dbo.BTTestCodeRangesI(\u0026#34;IndexMaster\u0026#34;,tcRowId,orderNo,\u0026#34;\u0026#34;)) Q:\u0026#39;$L(rangeDR) orgRes S rangeObj=##Class(dbo.BTTestCodeRanges).%OpenId(rangeDR) Q:\u0026#39;$L(rangeObj) orgRes I res\u0026gt;=rangeObj.ValueHigh { I resPrefix=\u0026#34;\u0026lt;\u0026#34; { Q orgRes } Q \u0026#34;阳性(\u0026#34;_orgRes_\u0026#34;)\u0026#34; } ELSE { I resPrefix=\u0026#34;\u0026gt;\u0026#34; { Q orgRes } } Q \u0026#34;阴性(\u0026#34;_orgRes_\u0026#34;)\u0026#34; 回传三行 DSP 双向要求回传三行 DSP 信息，DSP1 为患者信息，DSP2 为标本信息，DSP3 为检测项目信息。\n示例接口(美康生化) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 MIFCL600OI(mi) ///仪器名称:\t血细胞分析流水线 ///仪器型号:\t迈瑞HL7 ///仪器厂商:\t迈瑞 ///通信协议:\tHL7 ///交互方式:\t双 向 ///接 口:\tTCP/IP,RS232 ///备 注:\t仪器配置:选择HL7协议,散点图选择:位图 S mi=$G(mi) Q:\u0026#39;$L(mi) s par11=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s par10=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s par4=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23) S sb=$C(11),eb=$C(28),cr=$C(13) S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=\u0026#34;\u0026#34;,kk=1 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType)=\u0026#34;\u0026#34; S $ZT=\u0026#34;ErrHandler\u0026#34;,$EC=\u0026#34;\u0026#34; Q:$$Start^MI.MIF000(mi) s IP=$li(^dbo.BTMIMachineParameterD(mi),9) s Port=$li(^dbo.BTMIMachineParameterD(mi),10) s LinkTime=0 s Device=\u0026#34;|TCP|\u0026#34;_Port F { try{ ;d Trace^MI.MIF000(mi,$ZA,\u0026#34;ZA\u0026#34;) //未启动客户端/服务端0，客户端断开连接标志20484，无客户端连接20480，有客户端连接28674，连接并建立数据传输28672 //lis断开 i $ZA=\u0026#34;0\u0026#34; { h 2 open Device:(IP:Port:/IOTABLE=\u0026#34;GB18030\u0026#34;):20 use Device d Trace^MI.MIF000(mi,\u0026#34;lis断开连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;lisReConnect\u0026#34;) //throw ##class(%Exception.General).%New(\u0026#34;ConnectError\u0026#34;,\u0026#34;D\u0026#34;,,\u0026#34;重新连接失败\u0026#34;) } //仪器断开，或者无数据1min，重启tcp i (($ZA=\u0026#34;20484\u0026#34;)) { close par4 d Trace^MI.MIF000(mi,\u0026#34;仪器断开连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;blockConnect\u0026#34;) h 2 open Device:(IP:Port:/IOTABLE=\u0026#34;GB18030\u0026#34;):20 use Device d Trace^MI.MIF000(mi,\u0026#34;重新连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;reConnect\u0026#34;) s LinkTime=0 continue } //连接无数据传输，main每执行6次，即1min，重启tcp i $ZA=\u0026#34;28674\u0026#34; s LinkTime=$i(LinkTime) //正常传输了，就清空计数 i $ZA=\u0026#34;28672\u0026#34; s LinkTime=0 d Main }catch ex{ s exception=\u0026#34;错误:\u0026#34;_ex.Location_\u0026#34;^\u0026#34;_ex.Data_ex.Name d Trace^MI.MIF000(mi,exception,\u0026#34;读取或写入异常，重启服务端\u0026#34;) } Q:$$Stop^MI.MIF000(mi) } C par4 Q Main R *R:10 Q:\u0026#39;$TEST\t//如果超时则退出 Q:$c(R)\u0026#39;=sb //以sb开头 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType,msgType,barcode,mshStr)=\u0026#34;\u0026#34; S startTime=$P($H,\u0026#34;,\u0026#34;,2) K PLIST S index=1 F { S curTime=$P($H,\u0026#34;,\u0026#34;,2) Q:curTime\u0026gt;(startTime+300) //5分钟内没有处理完则退出循环 Q:$$Stop^MI.MIF000(mi) R *R:10 Q:\u0026#39;$TEST\t//如果超时则退出 I $L($G(PLIST(index)))\u0026gt;=32700 { //32767 S index=+$O(PLIST(\u0026#34;\u0026#34;),-1)+1 S PLIST(index)=\u0026#34;\u0026#34; } I $C(R)\u0026#39;=eb,$C(R)\u0026#39;=cr { S PLIST(index)=$G(PLIST(index))_$C(R) } I $C(R)=cr { //解析一条记录 D Record K PLIST S index=1 } Q:$C(R)=eb //循环读取,当为eb的时候则退出 } D Trace^MI.MIF000(mi,result,\u0026#34;result\u0026#34;) D Save Q Record S index=\u0026#34;\u0026#34; S segmentType=\u0026#34;\u0026#34;,dataTye=\u0026#34;\u0026#34;,graphType=\u0026#34;\u0026#34;,base64Stream=\u0026#34;\u0026#34; S isImage=0,isBinary=0 s OldgraphDataDIFF=\u0026#34;\u0026#34; s OldgraphDataBaso=\u0026#34;\u0026#34; F { S index=$O(PLIST(index)) Q:\u0026#39;$L(index) S record=$TR($G(PLIST(index)),cr) Continue:\u0026#39;$L(record) D Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) I index=1 { S segmentType=$P(record,\u0026#34;|\u0026#34;,1) I segmentType=\u0026#34;MSH\u0026#34; {\t//信息头信息 S mshStr=record //消息类型 S msgType=$P($P(record,\u0026#34;|\u0026#34;,9),\u0026#34;^\u0026#34;,1) //ORU,ACK,QRY,QCK,DSR I msgType=\u0026#34;ORU\u0026#34; { D SendACK(mi,record,\u0026#34;AA\u0026#34;,0,\u0026#34;Message accepted\u0026#34;) } I msgType=\u0026#34;ORM\u0026#34; { } S resultType=$P(record,\u0026#34;|\u0026#34;,11) } I segmentType=\u0026#34;PID\u0026#34; {\t//患者信息 } I segmentType=\u0026#34;PVI\u0026#34; {\t//就诊信息 } I segmentType=\u0026#34;OBR\u0026#34; {\t//医嘱信息 S epis=$P(record,\u0026#34;|\u0026#34;,2) S:\u0026#39;$l(epis) epis=$P(record,\u0026#34;|\u0026#34;,3) S code=$P($P(record,\u0026#34;|\u0026#34;,5),\u0026#34;^\u0026#34;,1) I code=\u0026#34;00003\u0026#34; {\t//LJ QCR } } I segmentType=\u0026#34;OBX\u0026#34; { S dataTye=$P(record,\u0026#34;|\u0026#34;,3) //NM (numeric) 表示数字值，用于定量项目, //ST (string) 表示字符串值，用于定性项目 S channel=$P(record,\u0026#34;|\u0026#34;,4) S channel=$P(channel,\u0026#34;^\u0026#34;,1) //s:\u0026#39;$l(channel) channel=$P(record,\u0026#34;|\u0026#34;,5) S value=$P(record,\u0026#34;|\u0026#34;,5) i value[\u0026#34;\u0026lt;\u0026#34; s value=$tr(value,\u0026#34;\u0026lt;\u0026#34;) i value[\u0026#34;\u0026gt;\u0026#34; s value=$tr(value,\u0026#34;\u0026gt;\u0026#34;) I channel=\u0026#34;SI\u0026#34; {\t//value=浊度(L)^溶血(H)^黄疸(I) S:$l($P(value,\u0026#34;^\u0026#34;,2)) result=result_channel_\u0026#34;H\u0026#34;_par10_$P(value,\u0026#34;^\u0026#34;,2)_par11 S:$l($P(value,\u0026#34;^\u0026#34;,3)) result=result_channel_\u0026#34;I\u0026#34;_par10_$P(value,\u0026#34;^\u0026#34;,3)_par11 S value=$P(value,\u0026#34;^\u0026#34;,1) } I dataTye=\u0026#34;ST\u0026#34; { S value=$S(value=\u0026#34;ò?D?\u0026#34;:\u0026#34;阴性\u0026#34;,value=\u0026#34;??D?\u0026#34;:\u0026#34;阳性\u0026#34;,1:value) } I $L(channel),dataTye\u0026#39;=\u0026#34;ED\u0026#34;,dataTye\u0026#39;=\u0026#34;IS\u0026#34; { S result=result_channel_par10_value_par11 } I dataTye=\u0026#34;IS\u0026#34; {\tI channel=\u0026#34;05001\u0026#34;,resultType=\u0026#34;Q\u0026#34; {\t//质控浓度 S epis=value } } S graphTypeDesc=$ZCVT($P($P(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,2),\u0026#34;U\u0026#34;) I dataTye=\u0026#34;ED\u0026#34; {\t//图形数据 I $ZCVT($P(value,\u0026#34;^\u0026#34;,2),\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Image\u0026#34;,\u0026#34;U\u0026#34;) { S isImage=1 //位图数据 } I $ZCVT($P(value,\u0026#34;^\u0026#34;,3),\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Octer-stream\u0026#34;,\u0026#34;U\u0026#34;) { S isBinary=1\t//二进制数据(需要绘图) } S graphType=channel I channel=\u0026#34;15050\u0026#34; {\t//二进制数据 S graphType=\u0026#34;RBC\u0026#34; } I channel=\u0026#34;15056\u0026#34; {\t//位图数据 S graphType=\u0026#34;RBC\u0026#34; } I channel=\u0026#34;15100\u0026#34; {\t//二进制数据 S graphType=\u0026#34;PLT\u0026#34; } I channel=\u0026#34;15116\u0026#34; {\t//位图数据 S graphType=\u0026#34;PLT\u0026#34; } I channel=\u0026#34;15200\u0026#34; {\t//位图数据 S graphType=\u0026#34;WBC-DIFFBMP\u0026#34; } I channel=\u0026#34;15201\u0026#34; {\t//二进制数据 S (isImage,isBinary)=0\t//暂时不处理二进制数据 S graphType=\u0026#34;WBC-DIFF\u0026#34; } I channel=\u0026#34;15202\u0026#34; {\t//二进制数据 S (isImage,isBinary)=0\t//暂时不处理二进制数据 S graphType=\u0026#34;WBC-DIFF\u0026#34; } I channel=\u0026#34;15250\u0026#34; {\t//位图数据 S graphType=\u0026#34;BASOBMP\u0026#34; } I channel=\u0026#34;15251\u0026#34; {\t//二进制数据 S (isImage,isBinary)=0\t//暂时不处理二进制数据 S graphType=\u0026#34;BASO\u0026#34; } I channel=\u0026#34;15300\u0026#34; {\t//位图数据 S graphType=\u0026#34;RET\u0026#34; } I channel=\u0026#34;15306\u0026#34; {\t//二进制数据 S (isImage,isBinary)=0\t//暂时不处理二进制数据 S graphType=\u0026#34;RET\u0026#34; } I channel=\u0026#34;15301\u0026#34; {\t//位图数据 S graphType=\u0026#34;PLT-0\u0026#34; } I channel=\u0026#34;15302\u0026#34; {\t//位图数据 S graphType=\u0026#34;RET-EXT\u0026#34; } I channel=\u0026#34;15350\u0026#34; {\t//位图数据 S graphType=\u0026#34;NRBC\u0026#34; } I channel=\u0026#34;15354\u0026#34; {\t//二进制数据 S (isImage,isBinary)=0\t//暂时不处理二进制数据 S graphType=\u0026#34;NRBC\u0026#34; } S graphData=$P(value,\u0026#34;^\u0026#34;,5) S graphDataType=$P(value,\u0026#34;^\u0026#34;,4) I $ZCVT(graphDataType,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Base64\u0026#34;,\u0026#34;U\u0026#34;) { D Trace^MI.MIF000(mi,graphData,graphType) i graphType[\u0026#34;RBC\u0026#34; d .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;RBC\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;Histogram#RBC#RBC######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RBC#RBC######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!\u0026#34;_$lb(epis,mi),\u0026#34;绘图：RBC\u0026#34;) i graphType[\u0026#34;PLT\u0026#34; d .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;PLT\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;Histogram#PLT#PLT######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#PLT#RBC######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!\u0026#34;_$lb(epis,mi),\u0026#34;绘图：PLT\u0026#34;) i graphType[\u0026#34;WBC\u0026#34; d .//s OldgraphDataDIFF=graphData .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;WBC-DIFF\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#DIFF#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#DIFF#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!\u0026#34;_$lb(epis,mi),\u0026#34;绘图：wbc\u0026#34;) i graphType[\u0026#34;WNB\u0026#34; d .s OldgraphDataBaso=graphData .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;BASO\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#WNB#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#Baso#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) } } } I segmentType=\u0026#34;ORC\u0026#34; {\t//就诊信息 S barcode=$P(record,\u0026#34;|\u0026#34;,4) //S:$ZCVT(barcode,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;) barcode=\u0026#34;\u0026#34; //条码扫描错误 //I $L(barcode) { //双向 //} Invalid 条码扫描错误 d SendORR(mi,record,\u0026#34;AA\u0026#34;,0,\u0026#34;Message accepted\u0026#34;,mshStr,barcode) } I segmentType=\u0026#34;QRD\u0026#34; {\t//就诊信息 S barcode=$P(record,\u0026#34;|\u0026#34;,9) s qrdStr=record //S:$ZCVT(barcode,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;) barcode=\u0026#34;\u0026#34; //条码扫描错误 //I $L(barcode) { //双向 //} Invalid 条码扫描错误 //mi,mshStr,qrdStr,qrfStr,barcode } I segmentType=\u0026#34;QRF\u0026#34; {\t//就诊信息 ;S barcode=$P(record,\u0026#34;|\u0026#34;,9) s qrfStr=record //S:$ZCVT(barcode,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;) barcode=\u0026#34;\u0026#34; //条码扫描错误 //I $L(barcode) { //双向 //} Invalid 条码扫描错误 //mi,mshStr,qrdStr,qrfStr,barcode d SendDSP(mi,mshStr,qrdStr,qrfStr,barcode) } } //I dataTye=\u0026#34;ED\u0026#34;,index\u0026gt;1,$L(base64Stream) { //D base64Stream.Write($P(record,\u0026#34;|\u0026#34;,1)) //i graphType=\u0026#34;WBC-DIFFBMP\u0026#34; d //.s ^LISDrawImageTask($h,mi,epis_\u0026#34;WBC-DIFF\u0026#34;)=$lb(epis,OldgraphDataDIFF,mi,\u0026#34;MI.MIFBC6800BI\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#DIFF#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) //i graphType=\u0026#34;BASOBMP\u0026#34; d //.s ^LISDrawImageTask($h,mi,epis_\u0026#34;BASO\u0026#34;)=$lb(epis,OldgraphDataBaso,mi,\u0026#34;MI.MIFBC6800BI\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#Baso#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) //s miCode=$lg(^dbo.BTMIMachineParameterD(mi),2) //i graphType=\u0026#34;WBC-DIFF\u0026#34; d //.D Trace^MI.MIF000(mi,miCode_\u0026#34;:\u0026#34;_epis_\u0026#34;:\u0026#34;_graphType,\u0026#34;SaveImage\u0026#34;) //.s ret=##Class(MI.Common.MIFBase).SaveBase64ToMachine(mi,epis,graphType,base64Stream,epis_\u0026#34;-\u0026#34;_graphType,miCode) //} } Q /// D SendDSP^MI.MIFMEIKANG(63,\u0026#34;MSH|^~\\\u0026amp;|HOST|Unkown□Device|FMIS||20240410153949||QRY^Q02|2|P|2.3.1||||0||ANSI||\u0026#34;,\u0026#34;QRD|20240410153949|BC|D|0|||RD|1000860681||Rack^Pos|N|T\u0026#34;,\u0026#34;QRF|Unkown□Device|20240410000000|20240410235959|||RCT|COR|ALL|\u0026#34;,\u0026#34;1000860681\u0026#34;) SendDSP(mi,mshStr,qrdStr,qrfStr,barcode) N (mi,mshStr,qrdStr,qrfStr,barcode) S mi=$G(mi),mshStr=$G(mshStr),barcode=$G(barcode),qrdStr=$G(qrdStr),qrfStr=$G(qrfStr) D Trace^MI.MIF000(mi,\u0026#34;开始上传\u0026#34;,\u0026#34;Upload\u0026#34;) D Trace^MI.MIF000(mi,mshStr,\u0026#34;Upload\u0026#34;) D Trace^MI.MIF000(mi,qrdStr,\u0026#34;Upload\u0026#34;) D Trace^MI.MIF000(mi,qrfStr,\u0026#34;Upload\u0026#34;) b ;a102 S sb=$C(11),eb=$C(28),cr=$C(13) I \u0026#39;$L(barcode) { D Trace^MI.MIF000(mi,\u0026#34;条码号为空\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } I $ZCVT(barcode,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;) { //条码扫描错误 D Trace^MI.MIF000(mi,\u0026#34;条码扫描错误,机器未识别\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } S labno=barcode S workGroupMachineDR=$LG($G(^dbo.BTMIMachineParameterD(mi)),6) S visiNumberDR=$O(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) I \u0026#39;$L(visiNumberDR) { D Trace^MI.MIF000(mi,\u0026#34;在检验系统未找到条码:\u0026#34;_labno_\u0026#34;对应的标本信息,确定条码正确或标本已经接收?\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } S visNumberObj=##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR) I \u0026#39;$L(visNumberObj) { D Trace^MI.MIF000(mi,\u0026#34;在检验系统未找到条码:\u0026#34;_labno_\u0026#34;对应的标本信息,确定条码正确或标本已经接收?\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } D Trace^MI.MIF000(mi,labno,\u0026#34;Upload Start\u0026#34;) K ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno) D ScanOne^MI.MIF000(mi,labno) S result=\u0026#34;\u0026#34; S chlStr=\u0026#34;\u0026#34; S chl=\u0026#34;\u0026#34;,chlCnt=0 F { S chl=$O(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) Q:\u0026#39;$L(chl) S chlStr=chlStr_chl_\u0026#34;^\u0026#34; S chlCnt=chlCnt+1 ;S result=result_chl_$C(92)_\u0026#34;?\u0026#34;_$C(44) } I \u0026#39;$L(chlStr) { D Trace^MI.MIF000(mi,\u0026#34;在检验系统未找到条码:\u0026#34;_labno_\u0026#34;对应的化验项目信息,确定医嘱或项目维护正确?\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } i $l(chlStr){ s chlStr=$e(chlStr,1,*-1) } /* F { S chl=$O(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) Q:\u0026#39;$L(chl) S chlStr=chlStr_\u0026#34;DSP|\u0026#34;_chlCnt_\u0026#34;||\u0026#34;_chl_\u0026#34;^^^|||\u0026#34;_cr S chlCnt=chlCnt+1 ;S result=result_chl_$C(92)_\u0026#34;?\u0026#34;_$C(44) } I \u0026#39;$L(chlStr) { D Trace^MI.MIF000(mi,\u0026#34;在检验系统未找到条码:\u0026#34;_labno_\u0026#34;对应的化验项目信息,确定医嘱或项目维护正确?\u0026#34;,\u0026#34;Upload Error\u0026#34;) Q 1 } */ D Save^MI.MIF000(mi,labno,result,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) S specimenDR=$LG($G(^dbo.RPVisitNumberD(visiNumberDR)),56) S specimenName=\u0026#34;\u0026#34; S:$L(specimenDR) specimenName=$LG($G(^dbo.BTSpecimenD(specimenDR)),3) S sampleType=\u0026#34;其他\u0026#34; I $L(specimenName),\u0026#34;,血清,血浆,尿液,脑脊液,\u0026#34;[(\u0026#34;,\u0026#34;_specimenName_\u0026#34;,\u0026#34;) { S sampleType=specimenName } S birdthday=visNumberObj.BirthDate S:$L(birdthday)=8 birdthday=birdthday_\u0026#34;000000\u0026#34; S:\u0026#39;$L(mshStr) mshStr=\u0026#34;MSH|^~\\\u0026amp;|YHLO|iFlash3000|||20161208150935||QRY^Q02|18|P|2.3.1||||||ASCII|||\u0026#34; S mshSeq=$P(mshStr,\u0026#34;|\u0026#34;,10) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;DSR^Q03\u0026#34; S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|LIS|||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,6,$l(mshStr)) S episode=\u0026#34;\u0026#34; S workGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) //##Class(MI.Instrument).GetWorkGroupMachineRowId(mi) I $L(workGroupMachineDR) { S OrderNo=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,visiNumberDR,workGroupMachineDR,\u0026#34;\u0026#34;)) I $L(OrderNo) { S reportDR=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,visiNumberDR,workGroupMachineDR,OrderNo,\u0026#34;\u0026#34;)) S episode=\u0026#34;\u0026#34; //##Class(LIS.Core.Report).GetEpisodeNumber(reportDR) i $l(reportDR) s Assayno=$lg($g(^dbo.RPVisitNumberReportD(reportDR)),6) } } s Date=$h s datetime=$tr($zd($p(Date,\u0026#34;,\u0026#34;,1),3),\u0026#34;-\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;\u0026#34;_$tr($zt($p(Date,\u0026#34;,\u0026#34;,2),1),\u0026#34;:\u0026#34;,\u0026#34;\u0026#34;)\t//时间 s JZHWZ=$p(qrdStr,\u0026#34;|\u0026#34;,11)\t//架子号位置 S order=mshStr_cr //\u0026#34;MSH|^~\\\u0026amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||\u0026#34;_cr S order=order_\u0026#34;MSA|OK|\u0026#34;_mshSeq_\u0026#34;||||0\u0026#34;_cr S order=order_\u0026#34;DSP|1||\u0026#34;_visNumberObj.RegNo_\u0026#34;|\u0026#34;_episode_\u0026#34;|\u0026#34;_visNumberObj.SurName_\u0026#34;|||||||||||||||||||||||||\u0026#34;_cr\tS order=order_\u0026#34;DSP|2|\u0026#34;_barcode_\u0026#34;|\u0026#34;_barcode_\u0026#34;||N||\u0026#34;_datetime_\u0026#34;||1|\u0026#34;_JZHWZ_\u0026#34;||N||\u0026#34;_datetime_\u0026#34;||||||||\u0026#34;_datetime_\u0026#34;||||||||||||||||||||||||\u0026#34;_cr\ts order=order_\u0026#34;DSP|3|\u0026#34;_chlCnt_\u0026#34;|\u0026#34;_chlStr_cr W sb,order,eb,cr,*-3 b ;a101 D Trace^MI.MIF000(mi,sb_order_eb_cr,\u0026#34;H--\u0026gt;M\u0026#34;) //$TR($ZDT($H,8),\u0026#34; :\u0026#34;) Q 0 Save D Trace^MI.MIF000(mi,epis_\u0026#34;^\u0026#34;_result,\u0026#34;Test\u0026#34;) I $l(epis),$l(result) { S QC=\u0026#34;\u0026#34; D Save^MI.MIF000(mi,epis,result,date,time,QC) } S (sample,epis,surname,rec,res,result,date,time,QC,resultType)=\u0026#34;\u0026#34; Q SendACK(mi,mshStr,ackType=\u0026#34;AA\u0026#34;,errCode=0,errDesc=\u0026#34;Message accepted\u0026#34;) //send \u0026#39;ack\u0026#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(\u0026#39;$l(mi))||(\u0026#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,\u0026#34;\u0026#34;) //Q:$l(mshStr,\u0026#34;|\u0026#34;)\u0026lt;21 ret S ret=0 S msgRoutine=$P($P(mshStr,\u0026#34;|\u0026#34;,9),\u0026#34;^\u0026#34;,2) S seq=$P(mshStr,\u0026#34;|\u0026#34;,10) S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|LIS|||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,6,$l(mshStr)) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;ACK^\u0026#34;_msgRoutine W sb,mshStr,cr,\u0026#34;MSA|\u0026#34;_ackType_\u0026#34;|\u0026#34;_seq_\u0026#34;|\u0026#34;_errDesc_\u0026#34;|||\u0026#34;_errCode_\u0026#34;|\u0026#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=\u0026#34;AA\u0026#34;:\u0026#34;ACK\u0026#34;,ackType=\u0026#34;AE\u0026#34;:\u0026#34;Error\u0026#34;,ackType=\u0026#34;AR\u0026#34;:\u0026#34;NAK\u0026#34;,1:\u0026#34;NULL\u0026#34;),\u0026#34;H--\u0026gt;M\u0026#34;) Q ret ErrHandler D Trace^MI.MIF000(mi,$TR($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) h 3 Q //保存直方图 SaveHistogram(mi,epis,graphType,graphOrder,base64Stream) N (mi,epis,graphType,graphOrder,base64Stream) S mi=$G(mi),epis=$G(epis),graphType=$G(graphType),graphOrder=$G(graphOrder),base64Stream=$G(base64Stream) Q:\u0026#39;$L(mi) 1 Q:\u0026#39;$L(epis) 1 Q:\u0026#39;$L(base64Stream) 1 Q:\u0026#39;$L(graphType) 1 S:\u0026#39;$L(graphOrder) graphOrder=0 S glBinaryStream=##Class(%GlobalBinaryStream).%New() While \u0026#39;base64Stream.AtEnd { S base64=base64Stream.Read() S binary=$system.Encryption.Base64Decode(base64) D glBinaryStream.Write(binary) } S charStream=##Class(%GlobalCharacterStream).%New() S maxDot=0 While \u0026#39;glBinaryStream.AtEnd { S char=glBinaryStream.Read(1) S ascValue=$ASCII(char)_\u0026#34;,\u0026#34; S maxDot=maxDot+1 D charStream.Write(ascValue) } D charStream.Write(\u0026#34;0\u0026#34;) K glBinaryStream S title=graphType S foreColor=12 S:graphType=\u0026#34;PLT\u0026#34; foreColor=10 S top=10 S left=10 S width=300 S height=150 S (label,maxValue,memo)=\u0026#34;\u0026#34; S error=##Class(MI.Instrument).SaveHistogram(charStream,mi,epis,graphType,graphOrder,label,title,maxDot,maxValue,memo,foreColor,top,left,width,height) I $L(error) { D Trace^MI.MIF000(mi,$TR(error,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;),\u0026#34;Graph Error\u0026#34;) } K charStream Q 0 SendORR(mi,record, AckType=\u0026#34;AA\u0026#34;,ErrCode=0,ErrDesc=\u0026#34;Message accepted\u0026#34;,mshStr,epis) N (mi,record,AckType,ErrCode,ErrDesc,mshStr,epis) s mi=$g(mi),record=$g(record),AckType=$g(AckType),ErrCode=$g(ErrCode),ErrDesc=$g(ErrDesc),mshStr=$g(mshStr),epis=$g(epis) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(\u0026#39;$l(mi))||(\u0026#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,\u0026#34;\u0026#34;) S ret=0 S seq=$P(mshStr,\u0026#34;|\u0026#34;,10) S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|LIS||||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,7,$l(mshStr)) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;ORR^O02\u0026#34; s isRecieve=\u0026#34;\u0026#34; s wgDR=\u0026#34;\u0026#34; s wgDR=$lg(^dbo.BTMIMachineParameterD(mi),6) //\u0026amp;sql(SELECT EpisodeNo into :isRecieve FROM dbo.RP_VisitNumberReport where AssayNo=:epis and WorkGroupMachineDR=:wgDR) s isRecieve=epis //##class(HIS.DHCReportPrint).GetReportAssayNoMTHD(mi,epis) s flag=\u0026#34;AA\u0026#34; s MSACode=seq D Trace^MI.MIF000(mi,isRecieve,\u0026#34;isRecieve is \u0026#34;) i ($l(isRecieve)\u0026lt;1) { s flag=\u0026#34;AR\u0026#34; } i $ZCVT(epis,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;){ s flag=\u0026#34;AR\u0026#34; } s MSA=\u0026#34;MSA|\u0026#34;_flag_\u0026#34;|\u0026#34;_MSACode i flag=\u0026#34;AR\u0026#34;{ S TMPCORDE=sb_mshStr_cr_MSA_cr_eb_cr W sb,mshStr,cr,MSA,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,TMPCORDE,\u0026#34;H-\u0026gt;M\u0026#34;) }else{ s PatInfomation=\u0026#34;\u0026#34; s PatInfomation=$$GetPatInfo(epis,mi) D Trace^MI.MIF000(mi,PatInfomation,\u0026#34;PatInfomation is\u0026#34;) s (RegNo,Name,Birth,Species,PatType,LOC,BedNo,Fee,Srcdocno,PatAge)=\u0026#34;\u0026#34; if $l(PatInfomation){ s RegNo=$p(PatInfomation,\u0026#34;,\u0026#34;,9) s Name=$p(PatInfomation,\u0026#34;,\u0026#34;,10) s Birth=$p(PatInfomation,\u0026#34;,\u0026#34;,29) s Species=$p(PatInfomation,\u0026#34;,\u0026#34;,11) i Species=\u0026#34;1\u0026#34; s Species=\u0026#34;Male\u0026#34; i Species=\u0026#34;2\u0026#34; s Species=\u0026#34;Fmale\u0026#34; s PatType=$p(PatInfomation,\u0026#34;,\u0026#34;,12) s LOC=$p(PatInfomation,\u0026#34;,\u0026#34;,6) s BedNo=$p(PatInfomation,\u0026#34;,\u0026#34;,13) s Fee=$p(PatInfomation,\u0026#34;,\u0026#34;,5) s Srcdocno=$p(PatInfomation,\u0026#34;,\u0026#34;,7) s PatAge=$p(PatInfomation,\u0026#34;,\u0026#34;,14) } s PID=\u0026#34;PID|1||\u0026#34;_RegNo_\u0026#34;^^^^MR||\u0026#34;_Name_\u0026#34;||\u0026#34;_Birth_\u0026#34;|\u0026#34;_Species s PV1=\u0026#34;PV1|1|\u0026#34;_PatType_\u0026#34;|\u0026#34;_LOC_\u0026#34;^^\u0026#34;_BedNo_\u0026#34;|||||||||||||||||\u0026#34;_Fee s ORC=\u0026#34;ORC|AF||\u0026#34;_epis s curTime=$zd($h,8)_$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;,\u0026#34;\u0026#34;) s randomNumber=1000+$r(1000) s OBR=\u0026#34;OBR|1|\u0026#34;_epis_\u0026#34;||00001^Automated Count^99MRC||\u0026#34;_curTime_randomNumber_\u0026#34;||||\u0026#34;_Srcdocno_\u0026#34;||||||||||||||HM||||||||Bill\u0026#34; s TestCodeDate=\u0026#34;\u0026#34; s TestCodeDate=$$SearchTestItem(mi,epis) s OBX=\u0026#34;OBX|1|IS|08003^Test Mode^99MRC||\u0026#34;_TestCodeDate_\u0026#34;||||||F\u0026#34;_cr_ \u0026#34;OBX|2|IS|01002^Ref Group^99MRC||Child||||||F\u0026#34;_cr_ \u0026#34;OBX|3|NM|30525-0^Age^LN||\u0026#34;_PatAge_\u0026#34;|yr|||||F\u0026#34;_cr_ \u0026#34;OBX|4|ST|01001^Remark^99MRC||\u0026#34;_PatType_\u0026#34;||||||F\u0026#34;_cr_ \u0026#34;OBX|5|ST|08005^SerialNumber^99MRC||\u0026#34;_isRecieve_\u0026#34;||||||F\u0026#34;_cr_ \u0026#34;OBX|6|IS|01007^Sample Type^99MRC||Venous blood||||||\u0026#34;_cr_ \u0026#34;OBX|7|IS|01008^Patient Area^99MRC||A - 501||||||F\u0026#34;_cr_ \u0026#34;OBX|8|ST|01009^Custom patient info 1^99MRC||Nothing||||||F\u0026#34;_cr_ \u0026#34;OBX|9|ST|01010^Custom patient info 2^99MRC||Nothing||||||F\u0026#34;_cr_ \u0026#34;OBX|10|ST|01011^Custom patient info 3^99MRC||Nothing||||||F\u0026#34; S TMPORDER=sb_mshStr_cr_MSA_cr_PID_cr_PV1_cr_ORC_cr_OBR_cr_OBX_cr_eb_cr w sb,mshStr,cr,MSA,cr,PID,cr,PV1,cr,ORC,cr,OBR,cr,OBX,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,TMPORDER,\u0026#34;H-\u0026gt;M\u0026#34;) } Q ret SearchTestItem(mi,epis) S tcx=\u0026#34;\u0026#34;,tc=\u0026#34;\u0026#34; d ScanOne^MI.MIF000(mi,epis) i $d(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,epis)){ f { s tc=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,epis,tc)) q:tc=\u0026#34;\u0026#34; i \u0026#39;$l(tcx){ s tcx=tc }else{ s tcx=tcx_\u0026#34;+\u0026#34;_tc } } } Q tcx GetPatInfo(labno,mi) s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,\u0026#34; \u0026#34;_labno,\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),2) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) s Sampleno=labno //检测号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; ;病区 s RetString=\u0026#34;\u0026#34; s EpisodeNo=\u0026#34;\u0026#34; s Diagnose=\u0026#34;\u0026#34; s RetString=Sampleda_\u0026#34;,\u0026#34;_Instrument_\u0026#34;,\u0026#34;_Sampleno_\u0026#34;,\u0026#34;_Sampletype_\u0026#34;,\u0026#34;_Feetype_\u0026#34;,\u0026#34;_Srcdepno_\u0026#34;,\u0026#34;_Srcdocno_\u0026#34;,\u0026#34;_Userno_\u0026#34;,\u0026#34; s RetString=RetString_Patno_\u0026#34;,\u0026#34;_Patna_\u0026#34;,\u0026#34;_Sex_\u0026#34;,\u0026#34;_Pattype_\u0026#34;,\u0026#34;_Bedno_\u0026#34;,\u0026#34;_Patage_\u0026#34;,\u0026#34;_Ageunit_\u0026#34;,\u0026#34;_Reqno_\u0026#34;,\u0026#34;_Reqda_\u0026#34;,\u0026#34; s RetString=RetString_Reportda_\u0026#34;,\u0026#34;_Printflag_\u0026#34;,\u0026#34;_Resultflag_\u0026#34;,\u0026#34;_Errflag_\u0026#34;,\u0026#34;_Diagnose_\u0026#34;,\u0026#34;_Description_\u0026#34;,\u0026#34;_Reserve_\u0026#34;,\u0026#34; s RetString=RetString_Patnamn_\u0026#34;,\u0026#34;_Getda_\u0026#34;,\u0026#34;_Wardno_\u0026#34;,\u0026#34;_BarCode_\u0026#34;,\u0026#34;_BirthDate_\u0026#34;,\u0026#34;_EpisodeNo q RetString //双向上传医嘱信息,wwh,2015-11-05,未测试 SendOrder(mi,mshStr,record) N (mi,mshStr,record) S mi=$G(mi),mshStr=$G(mshStr),record=$G(record) Q:\u0026#39;$L(mi) 1 Q:\u0026#39;$D(^TMIF(mi)) 1 S barcode=$P(record,\u0026#34;|\u0026#34;,4) I \u0026#39;$L(barcode) { D Trace^MI.MIF000(mi,\u0026#34;条码号为空\u0026#34;,\u0026#34;Order\u0026#34;) Q 1 } I $ZCVT(barcode,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;) {\t//条码扫描错误 D Trace^MI.MIF000(mi,\u0026#34;条码扫描错误,机器未识别\u0026#34;,\u0026#34;Order\u0026#34;) Q 1 } I \u0026#39;$D(^TEPI(barcode)) { D Trace^MI.MIF000(mi,\u0026#34;在检验系统未找到条码:\u0026#34;_barcode_\u0026#34;对应的标本信息,确定条码正确或标本已经接收?\u0026#34;,\u0026#34;Order\u0026#34;) Q 1 } K uploadList S tsCode=\u0026#34;\u0026#34;,uploadList=0 F { S tsCode=$O(^TEPI(barcode,1,tsCode)) Q:\u0026#39;$L(tsCode) Q:\u0026#39;$D(^TMIF(mi,0,tsCode)) S tsDesc=$P($G(^TTAB(\u0026#34;TS\u0026#34;,tsCode)),\u0026#34;\\\u0026#34;,1) S tsCnt=$O(^TEPI(barcode,1,tsCode,\u0026#34;\u0026#34;)) Q:\u0026#39;$L(tsCnt) S status=$P($G(^TEPI(barcode,1,tsCode,tsCnt)),\u0026#34;\\\u0026#34;,31) I status=\u0026#34;A\u0026#34; { D Trace^MI.MIF000(mi,\u0026#34;条码扫:\u0026#34;_barcode_\u0026#34;,医嘱:\u0026#34;_tsCode_\u0026#34;||\u0026#34;_tsDesc_\u0026#34;,不是登记状态,不再上传\u0026#34;,\u0026#34;Order\u0026#34;)\tContinue } S channel=$$GetTestSetChannel(tsCode) I \u0026#39;$L(channel) { D Trace^MI.MIF000(mi,\u0026#34;条码扫:\u0026#34;_barcode_\u0026#34;,医嘱:\u0026#34;_tsCode_\u0026#34;||\u0026#34;_tsDesc_\u0026#34;,未找到通道号\u0026#34;,\u0026#34;Order\u0026#34;)\tContinue } Continue:$D(uploadList(tsCode)) S uploadList(tsCode)=channel S uploadList=$I(uploadList) } I +$G(uploadList)\u0026lt;1 { D Trace^MI.MIF000(mi,\u0026#34;条码扫:\u0026#34;_barcode_\u0026#34;未找可上传的医嘱\u0026#34;,\u0026#34;Order\u0026#34;) Q 1 } //1,仪器发送过来的请求信息: //MSH|^~\\\u0026amp;||Mindray|||20081120174836||ORM^O01|4|P|2.3.1||||||UNICODE //ORC|RF||SampleID1||IP S order=\u0026#34;\u0026#34; S msh=\u0026#34;MSH|^~\\\u0026amp;|LIS||||\u0026#34;_$TR($ZDT($H,8),\u0026#34; :\u0026#34;)_\u0026#34;||ORR^O02|1|P|2.3.1||||||UNICODE\u0026#34; //huifu: //MSH|^~\\\u0026amp;|LIS||||20081120174836||ORR^O02|1|P|2.3.1||||||UNICODE //MSA|AA|4 //PID|1||ChartNo^^^^MR||^FName||19810506|NT //PV1|1|E|内科^^Bn4|||||||||||||||||NewCharge //ORC|AF|SampleID1||| //OBR|1|SampleID1||||20060506||||tester|||Diagnose content...|20060504||||||||20080821||HM||||审核者||||检验者 //OBX|1|IS|08001^Take Mode^99MRC||A||||||F //OBX|2|IS|08002^Blood Mode^99MRC||W||||||F //OBX|3|IS|08003^Test Mode^99MRC||CBC||||||F //OBX|4|IS|01002^Ref Group^99MRC||XXXX||||||F //OBX|5|NM|30525-0^Age^LN||1|hr|||||F //OBX|6|ST|01001^Remark^99MRC||remark content...||||||F ///未找到检测时: //MSH|^~\\\u0026amp;|LIS||||20081120174836||ORR^O02|1|P|2.3.1||||||UNICODE //MSA|AR|9 Q 0 GetTestSetChannel(tsCode) N (tsCode) S tsCode=$G(tsCode) Q \u0026#34;\u0026#34; 回传多行 OBX 示例接口(迈瑞 BC7500) 将患者信息和项目信息存入 OBX 回传仪器\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 MIFCL600OI(mi) ///仪器名称:\t血细胞分析流水线 ///仪器型号:\t迈瑞HL7 ///仪器厂商:\t迈瑞 ///通信协议:\tHL7 ///交互方式:\t双 向 ///接 口:\tTCP/IP,RS232 ///备 注:\t仪器配置:选择HL7协议,散点图选择:位图 S mi=$G(mi) Q:\u0026#39;$L(mi) s par11=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s par10=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s par4=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23) S sb=$C(11),eb=$C(28),cr=$C(13) S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=\u0026#34;\u0026#34;,kk=1 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType)=\u0026#34;\u0026#34; S $ZT=\u0026#34;ErrHandler\u0026#34;,$EC=\u0026#34;\u0026#34; Q:$$StartUTF8^MI.MIF000(mi) s IP=$li(^dbo.BTMIMachineParameterD(mi),9) s Port=$li(^dbo.BTMIMachineParameterD(mi),10) s LinkTime=0 s Device=\u0026#34;|TCP|\u0026#34;_Port F { try{ ;d Trace^MI.MIF000(mi,$ZA,\u0026#34;ZA\u0026#34;) //未启动客户端/服务端0，客户端断开连接标志20484，无客户端连接20480，有客户端连接28674，连接并建立数据传输28672 //lis断开 i $ZA=\u0026#34;0\u0026#34; { h 2 open Device:(IP:Port:/IOTABLE=\u0026#34;GB18030\u0026#34;):20 use Device d Trace^MI.MIF000(mi,\u0026#34;lis断开连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;lisReConnect\u0026#34;) //throw ##class(%Exception.General).%New(\u0026#34;ConnectError\u0026#34;,\u0026#34;D\u0026#34;,,\u0026#34;重新连接失败\u0026#34;) } //仪器断开，或者无数据1min，重启tcp i (($ZA=\u0026#34;20484\u0026#34;)) { close par4 ;d Trace^MI.MIF000(mi,\u0026#34;仪器断开连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;blockConnect\u0026#34;) h 2 open Device:(IP:Port:/IOTABLE=\u0026#34;GB18030\u0026#34;):20 use Device ;d Trace^MI.MIF000(mi,\u0026#34;重新连接\u0026#34;_$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;reConnect\u0026#34;) s LinkTime=0 continue } //连接无数据传输，main每执行6次，即1min，重启tcp i $ZA=\u0026#34;28674\u0026#34; s LinkTime=$i(LinkTime) //正常传输了，就清空计数 i $ZA=\u0026#34;28672\u0026#34; s LinkTime=0 d Main }catch ex{ s exception=\u0026#34;错误:\u0026#34;_ex.Location_\u0026#34;^\u0026#34;_ex.Data_ex.Name d Trace^MI.MIF000(mi,exception,\u0026#34;读取或写入异常，重启服务端\u0026#34;) } Q:$$Stop^MI.MIF000(mi) } C par4 Q Main R *R:10 Q:\u0026#39;$TEST\t//如果超时则退出 Q:$c(R)\u0026#39;=sb //以sb开头 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType,msgType,barcode,mshStr)=\u0026#34;\u0026#34; S startTime=$P($H,\u0026#34;,\u0026#34;,2) K PLIST S index=1 F { S curTime=$P($H,\u0026#34;,\u0026#34;,2) Q:curTime\u0026gt;(startTime+300) //5分钟内没有处理完则退出循环 Q:$$Stop^MI.MIF000(mi) R *R:10 Q:\u0026#39;$TEST\t//如果超时则退出 I $L($G(PLIST(index)))\u0026gt;=32700 { //32767 S index=+$O(PLIST(\u0026#34;\u0026#34;),-1)+1 S PLIST(index)=\u0026#34;\u0026#34; } I $C(R)\u0026#39;=eb,$C(R)\u0026#39;=cr { S PLIST(index)=$G(PLIST(index))_$C(R) } I $C(R)=cr { //解析一条记录 D Record K PLIST S index=1 } Q:$C(R)=eb //循环读取,当为eb的时候则退出 } D Trace^MI.MIF000(mi,result,\u0026#34;result\u0026#34;) D Save Q Record S index=\u0026#34;\u0026#34; S segmentType=\u0026#34;\u0026#34;,dataTye=\u0026#34;\u0026#34;,graphType=\u0026#34;\u0026#34;,base64Stream=\u0026#34;\u0026#34; S isImage=0,isBinary=0 s OldgraphDataDIFF=\u0026#34;\u0026#34; s OldgraphDataBaso=\u0026#34;\u0026#34; s (Bracket,TestTube)=\u0026#34;\u0026#34; F { S index=$O(PLIST(index)) Q:\u0026#39;$L(index) S record=$TR($G(PLIST(index)),cr) Continue:\u0026#39;$L(record) D Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) I index=1 { S segmentType=$P(record,\u0026#34;|\u0026#34;,1) I segmentType=\u0026#34;MSH\u0026#34; {\t//信息头信息 S mshStr=record //消息类型 S msgType=$P($P(record,\u0026#34;|\u0026#34;,9),\u0026#34;^\u0026#34;,1) //ORU,ACK,QRY,QCK,DSR I msgType=\u0026#34;ORU\u0026#34; { D SendACK(mi,record,\u0026#34;AA\u0026#34;,0,\u0026#34;Message accepted\u0026#34;) } I msgType=\u0026#34;ORM\u0026#34; { } S resultType=$P(record,\u0026#34;|\u0026#34;,11) } I segmentType=\u0026#34;PID\u0026#34; {\t//患者信息 } I segmentType=\u0026#34;PVI\u0026#34; {\t//就诊信息 } I segmentType=\u0026#34;OBR\u0026#34; {\t//医嘱信息 S epis=$P(record,\u0026#34;|\u0026#34;,3) S:\u0026#39;$l(epis) epis=$P(record,\u0026#34;|\u0026#34;,4) i epis[\u0026#34;Inv\u0026#34; d\t//Inv.082526_6-8 .s epis=$tr($tr(epis,\u0026#34;Inv.\u0026#34;,\u0026#34;\u0026#34;),\u0026#34;_\u0026#34;,\u0026#34;\u0026#34;)\t//YHR 20230819 仪器未识别到条码改为架子号获取信息 /*------自动核收-------*/\t//YHR 20230910 迈瑞BC7500自动核收 ;try{s ret=##class(MI.Special.AutomaticReceipt).ZDHS(mi,epis)}catch{} S code=$P($P(record,\u0026#34;|\u0026#34;,5),\u0026#34;^\u0026#34;,1) I code=\u0026#34;00003\u0026#34; {\t//LJ QCR } } I segmentType=\u0026#34;OBX\u0026#34; { S dataTye=$P(record,\u0026#34;|\u0026#34;,3) //NM (numeric) 表示数字值，用于定量项目, //ST (string) 表示字符串值，用于定性项目 S channel=$P(record,\u0026#34;|\u0026#34;,4) s InformationID=$p(channel,\u0026#34;^\u0026#34;,1) S channel=$P(channel,\u0026#34;^\u0026#34;,2) //s:\u0026#39;$l(channel) channel=$P(record,\u0026#34;|\u0026#34;,5) S value=$P(record,\u0026#34;|\u0026#34;,6) ;i value[\u0026#34;\u0026lt;\u0026#34; s value=$tr(value,\u0026#34;\u0026lt;\u0026#34;) ;i value[\u0026#34;\u0026gt;\u0026#34; s value=$tr(value,\u0026#34;\u0026gt;\u0026#34;) s value=$tr(value,\u0026#34; \u0026#34;) I channel=\u0026#34;FR-CRP\u0026#34; { i value\u0026gt;10 d .s channel1=\u0026#34;FCRP\u0026#34; .s channel2=\u0026#34;Fhs-CRP\u0026#34; .s value1=value .s value2=\u0026#34;\u0026gt;10\u0026#34; i value\u0026lt;10 d .s channel1=\u0026#34;FCRP\u0026#34; .s channel2=\u0026#34;Fhs-CRP\u0026#34; .s value1=\u0026#34;\u0026lt;10\u0026#34; .s value2=value i value=10 d .s channel1=\u0026#34;FCRP\u0026#34; .s channel2=\u0026#34;Fhs-CRP\u0026#34; .s value1=value .s value2=value S result=result_channel1_par10_value1_par11 S result=result_channel2_par10_value2_par11 } I channel=\u0026#34;SI\u0026#34; {\t//value=浊度(L)^溶血(H)^黄疸(I) S:$l($P(value,\u0026#34;^\u0026#34;,2)) result=result_channel_\u0026#34;H\u0026#34;_par10_$P(value,\u0026#34;^\u0026#34;,2)_par11 S:$l($P(value,\u0026#34;^\u0026#34;,3)) result=result_channel_\u0026#34;I\u0026#34;_par10_$P(value,\u0026#34;^\u0026#34;,3)_par11 S value=$P(value,\u0026#34;^\u0026#34;,1) } I dataTye=\u0026#34;ST\u0026#34; { S value=$S(value=\u0026#34;ò?D?\u0026#34;:\u0026#34;阴性\u0026#34;,value=\u0026#34;??D?\u0026#34;:\u0026#34;阳性\u0026#34;,1:value) i InformationID=\u0026#34;01012\u0026#34; d .s Bracket=$P(record,\u0026#34;|\u0026#34;,6) .s ^TMPBC7500(\u0026#34;Bracket\u0026#34;)=Bracket i $l($g(^TMPBC7500(\u0026#34;Bracket\u0026#34;))),InformationID=\u0026#34;01013\u0026#34; d .s TestTube=$P(record,\u0026#34;|\u0026#34;,6) .s RackNo=\u0026#34;上机:\u0026#34;_$g(^TMPBC7500(\u0026#34;Bracket\u0026#34;))_\u0026#34;-\u0026#34;_TestTube .k ^TMPBC7500(\u0026#34;Bracket\u0026#34;) .try{s ret=##class(MI.Special.SaveInformation).SaveRackNo(mi,epis, RackNo)}catch{}\t//YHR 20230914 保存架子号 } I $L(channel),dataTye\u0026#39;=\u0026#34;ED\u0026#34;,dataTye\u0026#39;=\u0026#34;IS\u0026#34; { S result=result_channel_par10_value_par11 } I dataTye=\u0026#34;IS\u0026#34; {\tI channel=\u0026#34;05001\u0026#34;,resultType=\u0026#34;Q\u0026#34; {\t//质控浓度 S epis=value } i $d(^LISPolice(\u0026#34;BC7500\u0026#34;,InformationID)) d .s WarningMessage=$g(^LISPolice(\u0026#34;BC7500\u0026#34;,InformationID)) .try{s ret=##Class(MI.Special.SaveInformation).SaveAlarmInformation(mi,epis,WarningMessage)}catch{}\t//YHR 20230914 保存报警信息 } S graphTypeDesc=$ZCVT($P($P(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,2),\u0026#34;U\u0026#34;) I dataTye=\u0026#34;ED\u0026#34; {\t//图形数据 I $ZCVT($P(value,\u0026#34;^\u0026#34;,2),\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Image\u0026#34;,\u0026#34;U\u0026#34;) { S isImage=1 //位图数据 } I $ZCVT($P(value,\u0026#34;^\u0026#34;,3),\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Octer-stream\u0026#34;,\u0026#34;U\u0026#34;) { S isBinary=1\t//二进制数据(需要绘图) } S graphType=channel I channel=\u0026#34;15050\u0026#34; {\t//二进制数据 S graphType=\u0026#34;RBC\u0026#34; } I channel=\u0026#34;15056\u0026#34; {\t//位图数据 S graphType=\u0026#34;RBC\u0026#34; } I channel=\u0026#34;15100\u0026#34; {\t//二进制数据 S graphType=\u0026#34;PLT\u0026#34; } I channel=\u0026#34;15116\u0026#34; {\t//位图数据 S graphType=\u0026#34;PLT\u0026#34; } I channel=\u0026#34;15200\u0026#34; {\t//位图数据 S graphType=\u0026#34;WBC-DIFFBMP\u0026#34; } I channel=\u0026#34;15201\u0026#34; {\t//二进制数据 S (isImage,isBinary)=0\t//暂时不处理二进制数据 S graphType=\u0026#34;WBC-DIFF\u0026#34; } I channel=\u0026#34;15202\u0026#34; {\t//二进制数据 S (isImage,isBinary)=0\t//暂时不处理二进制数据 S graphType=\u0026#34;WBC-DIFF\u0026#34; } I channel=\u0026#34;15250\u0026#34; {\t//位图数据 S graphType=\u0026#34;BASOBMP\u0026#34; } I channel=\u0026#34;15251\u0026#34; {\t//二进制数据 S (isImage,isBinary)=0\t//暂时不处理二进制数据 S graphType=\u0026#34;BASO\u0026#34; } I channel=\u0026#34;15300\u0026#34; {\t//位图数据 S graphType=\u0026#34;RET\u0026#34; } I channel=\u0026#34;15306\u0026#34; {\t//二进制数据 S (isImage,isBinary)=0\t//暂时不处理二进制数据 S graphType=\u0026#34;RET\u0026#34; } I channel=\u0026#34;15301\u0026#34; {\t//位图数据 S graphType=\u0026#34;PLT-0\u0026#34; } I channel=\u0026#34;15302\u0026#34; {\t//位图数据 S graphType=\u0026#34;RET-EXT\u0026#34; } I channel=\u0026#34;15350\u0026#34; {\t//位图数据 S graphType=\u0026#34;NRBC\u0026#34; } I channel=\u0026#34;15354\u0026#34; {\t//二进制数据 S (isImage,isBinary)=0\t//暂时不处理二进制数据 S graphType=\u0026#34;NRBC\u0026#34; } S graphData=$P(value,\u0026#34;^\u0026#34;,5) S graphDataType=$P(value,\u0026#34;^\u0026#34;,4) I $ZCVT(graphDataType,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Base64\u0026#34;,\u0026#34;U\u0026#34;) { D Trace^MI.MIF000(mi,graphData,graphType) /* i graphType[\u0026#34;RBC Histogram\u0026#34; d .s charStream=##class(%GlobalCharacterStream).%New() .d charStream.Write(graphData) .s ret=##Class(MI.TEST.TEST).SaveBase64ToMachine(mi,epis,\u0026#34;RBC\u0026#34;,charStream,epis_\u0026#34;RBC.bmp\u0026#34;,\u0026#34;BC7500\u0026#34;) .D Trace^MI.MIF000(mi,ret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：RBC Histogram\u0026#34;) i graphType[\u0026#34;PLT Histogram\u0026#34; d .s charStream=##class(%GlobalCharacterStream).%New() .d charStream.Write(graphData) .s ret=##Class(MI.TEST.TEST).SaveBase64ToMachine(mi,epis,\u0026#34;PLT\u0026#34;,charStream,epis_\u0026#34;PLT.bmp\u0026#34;,\u0026#34;BC7500\u0026#34;) .D Trace^MI.MIF000(mi,ret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：PLT Histogram\u0026#34;) i graphType[\u0026#34;WBC DIFF Scattergram\u0026#34; d .s charStream=##class(%GlobalCharacterStream).%New() .d charStream.Write(graphData) .s ret=##Class(MI.TEST.TEST).SaveBase64ToMachine(mi,epis,\u0026#34;DIFF\u0026#34;,charStream,epis_\u0026#34;DIFF.bmp\u0026#34;,\u0026#34;BC7500\u0026#34;) .D Trace^MI.MIF000(mi,ret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：WBC DIFF Scattergram\u0026#34;) i graphType[\u0026#34;WNB Scattergram\u0026#34; d .s charStream=##class(%GlobalCharacterStream).%New() .d charStream.Write(graphData) .s ret=##Class(MI.TEST.TEST).SaveBase64ToMachine(mi,epis,\u0026#34;Baso\u0026#34;,charStream,epis_\u0026#34;Baso.bmp\u0026#34;,\u0026#34;BC7500\u0026#34;) .D Trace^MI.MIF000(mi,ret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：WNB Scattergram\u0026#34;) */ i graphType[\u0026#34;RBC Histogram\u0026#34; d .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;RBC\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;Histogram#RBC#RBC######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RBC#RBC######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：RBC Histogram\u0026#34;) i graphType[\u0026#34;PLT Histogram\u0026#34; d .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;PLT\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;Histogram#PLT#PLT######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#PLT#RBC######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：PLT Histogram\u0026#34;) i graphType[\u0026#34;WBC DIFF\u0026#34; d .//s OldgraphDataDIFF=graphData .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;WBC-DIFF\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#DIFF#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#DIFF#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：WBC DIFF\u0026#34;) i graphType[\u0026#34;WNB Scattergram\u0026#34; d .s OldgraphDataBaso=graphData .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;BASO\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#WNB#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#Baso#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：WNB Scattergram\u0026#34;) i graphType[\u0026#34;RET Scattergram\u0026#34; d .s OldgraphDataBaso=graphData .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;BASO\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RET#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RET#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：RET Scattergram\u0026#34;) i graphType[\u0026#34;PLT-O Scattergram\u0026#34; d .s OldgraphDataBaso=graphData .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;BASO\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RET#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#PLTO#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：PLT-O Scattergram\u0026#34;) i graphType[\u0026#34;RET-EXT Scattergram\u0026#34; d .s OldgraphDataBaso=graphData .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;BASO\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RET#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RETEXT#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：RET-EXT Scattergram\u0026#34;) i graphType[\u0026#34;RBCVHF Scattergram\u0026#34; d .s OldgraphDataBaso=graphData .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;BASO\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RET#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RBCVHF#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：RBCVHF Scattergram\u0026#34;) i graphType[\u0026#34;RBCSCT Scattergram\u0026#34; d .s OldgraphDataBaso=graphData .//s ^LISDrawImageTask($h,mi,epis_\u0026#34;BASO\u0026#34;)=$lb(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RET#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() .s tret=tretObj.DrawImage(epis,graphData,mi,\u0026#34;MI.MIFLISMonitorTest\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#RBCSCT#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) .D Trace^MI.MIF000(mi,tret_\u0026#34;!!\u0026#34;_epis_\u0026#34;$$\u0026#34;_mi,\u0026#34;绘图：RBCSCT Scattergram\u0026#34;) } } } I segmentType=\u0026#34;ORC\u0026#34; {\t//就诊信息 S barcode=$P(record,\u0026#34;|\u0026#34;,4) /*------自动核收-------*/\t//YHR 20230910 迈瑞BC7500自动核收 ;try{s ret=##class(MI.Special.AutomaticReceipt).ZDHS(mi,barcode)}catch{} //S:$ZCVT(barcode,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;) barcode=\u0026#34;\u0026#34; //条码扫描错误 //I $L(barcode) { //双向 //} Invalid 条码扫描错误 d SendORR(mi,record,\u0026#34;AA\u0026#34;,0,\u0026#34;Message accepted\u0026#34;,mshStr,barcode) } } //I dataTye=\u0026#34;ED\u0026#34;,index\u0026gt;1,$L(base64Stream) { //D base64Stream.Write($P(record,\u0026#34;|\u0026#34;,1)) //i graphType=\u0026#34;WBC-DIFFBMP\u0026#34; d //.s ^LISDrawImageTask($h,mi,epis_\u0026#34;WBC-DIFF\u0026#34;)=$lb(epis,OldgraphDataDIFF,mi,\u0026#34;MI.MIFBC6800BI\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#DIFF#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) //i graphType=\u0026#34;BASOBMP\u0026#34; d //.s ^LISDrawImageTask($h,mi,epis_\u0026#34;BASO\u0026#34;)=$lb(epis,OldgraphDataBaso,mi,\u0026#34;MI.MIFBC6800BI\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#Baso#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal\u0026#34;) //s miCode=$lg(^dbo.BTMIMachineParameterD(mi),2) //i graphType=\u0026#34;WBC-DIFF\u0026#34; d //.D Trace^MI.MIF000(mi,miCode_\u0026#34;:\u0026#34;_epis_\u0026#34;:\u0026#34;_graphType,\u0026#34;SaveImage\u0026#34;) //.s ret=##Class(MI.Common.MIFBase).SaveBase64ToMachine(mi,epis,graphType,base64Stream,epis_\u0026#34;-\u0026#34;_graphType,miCode) //} } Q Save D Trace^MI.MIF000(mi,epis_\u0026#34;^\u0026#34;_result,\u0026#34;Test\u0026#34;) I $l(epis),$l(result) { S QC=\u0026#34;\u0026#34; D Save^MI.MIF000(mi,epis,result,date,time,QC) } S (sample,epis,surname,rec,res,result,date,time,QC,resultType)=\u0026#34;\u0026#34; Q SendACK(mi,mshStr,ackType=\u0026#34;AA\u0026#34;,errCode=0,errDesc=\u0026#34;Message accepted\u0026#34;) //send \u0026#39;ack\u0026#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(\u0026#39;$l(mi))||(\u0026#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,\u0026#34;\u0026#34;) //Q:$l(mshStr,\u0026#34;|\u0026#34;)\u0026lt;21 ret S ret=0 S msgRoutine=$P($P(mshStr,\u0026#34;|\u0026#34;,9),\u0026#34;^\u0026#34;,2) S seq=$P(mshStr,\u0026#34;|\u0026#34;,10) S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|LIS|||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,6,$l(mshStr)) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;ACK^\u0026#34;_msgRoutine W sb,mshStr,cr,\u0026#34;MSA|\u0026#34;_ackType_\u0026#34;|\u0026#34;_seq_\u0026#34;|\u0026#34;_errDesc_\u0026#34;|||\u0026#34;_errCode_\u0026#34;|\u0026#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=\u0026#34;AA\u0026#34;:\u0026#34;ACK\u0026#34;,ackType=\u0026#34;AE\u0026#34;:\u0026#34;Error\u0026#34;,ackType=\u0026#34;AR\u0026#34;:\u0026#34;NAK\u0026#34;,1:\u0026#34;NULL\u0026#34;),\u0026#34;H--\u0026gt;M\u0026#34;) Q ret ErrHandler D Trace^MI.MIF000(mi,$TR($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) h 3 Q //保存直方图 SaveHistogram(mi,epis,graphType,graphOrder,base64Stream) N (mi,epis,graphType,graphOrder,base64Stream) S mi=$G(mi),epis=$G(epis),graphType=$G(graphType),graphOrder=$G(graphOrder),base64Stream=$G(base64Stream) Q:\u0026#39;$L(mi) 1 Q:\u0026#39;$L(epis) 1 Q:\u0026#39;$L(base64Stream) 1 Q:\u0026#39;$L(graphType) 1 S:\u0026#39;$L(graphOrder) graphOrder=0 S glBinaryStream=##Class(%GlobalBinaryStream).%New() While \u0026#39;base64Stream.AtEnd { S base64=base64Stream.Read() S binary=$system.Encryption.Base64Decode(base64) D glBinaryStream.Write(binary) } S charStream=##Class(%GlobalCharacterStream).%New() S maxDot=0 While \u0026#39;glBinaryStream.AtEnd { S char=glBinaryStream.Read(1) S ascValue=$ASCII(char)_\u0026#34;,\u0026#34; S maxDot=maxDot+1 D charStream.Write(ascValue) } D charStream.Write(\u0026#34;0\u0026#34;) K glBinaryStream S title=graphType S foreColor=12 S:graphType=\u0026#34;PLT\u0026#34; foreColor=10 S top=10 S left=10 S width=300 S height=150 S (label,maxValue,memo)=\u0026#34;\u0026#34; S error=##Class(MI.Instrument).SaveHistogram(charStream,mi,epis,graphType,graphOrder,label,title,maxDot,maxValue,memo,foreColor,top,left,width,height) I $L(error) { D Trace^MI.MIF000(mi,$TR(error,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;),\u0026#34;Graph Error\u0026#34;) } K charStream Q 0 SendORR(mi,record, AckType=\u0026#34;AA\u0026#34;,ErrCode=0,ErrDesc=\u0026#34;Message accepted\u0026#34;,mshStr,epis) N (mi,record,AckType,ErrCode,ErrDesc,mshStr,epis) s mi=$g(mi),record=$g(record),AckType=$g(AckType),ErrCode=$g(ErrCode),ErrDesc=$g(ErrDesc),mshStr=$g(mshStr),epis=$g(epis) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(\u0026#39;$l(mi))||(\u0026#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,\u0026#34;\u0026#34;) S ret=0 S seq=$P(mshStr,\u0026#34;|\u0026#34;,10) S mshStr=$P(mshStr,\u0026#34;|\u0026#34;,1,2)_\u0026#34;|LIS||||\u0026#34;_$P(mshStr,\u0026#34;|\u0026#34;,7,$l(mshStr)) S $P(mshStr,\u0026#34;|\u0026#34;,9)=\u0026#34;ORR^O02\u0026#34; s isRecieve=\u0026#34;\u0026#34; s wgDR=\u0026#34;\u0026#34; s wgDR=$lg(^dbo.BTMIMachineParameterD(mi),6) //\u0026amp;sql(SELECT EpisodeNo into :isRecieve FROM dbo.RP_VisitNumberReport where AssayNo=:epis and WorkGroupMachineDR=:wgDR) s isRecieve=epis //##class(HIS.DHCReportPrint).GetReportAssayNoMTHD(mi,epis) s flag=\u0026#34;AA\u0026#34; s MSACode=seq D Trace^MI.MIF000(mi,isRecieve,\u0026#34;isRecieve is \u0026#34;) i ($l(isRecieve)\u0026lt;1) { s flag=\u0026#34;AR\u0026#34; } i $ZCVT(epis,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;){ s flag=\u0026#34;AR\u0026#34; } s MSA=\u0026#34;MSA|\u0026#34;_flag_\u0026#34;|\u0026#34;_MSACode i flag=\u0026#34;AR\u0026#34;{ S TMPCORDE=sb_mshStr_cr_MSA_cr_eb_cr W sb,mshStr,cr,MSA,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,TMPCORDE,\u0026#34;H-\u0026gt;M\u0026#34;) }else{ s PatInfomation=\u0026#34;\u0026#34; s PatInfomation=$$GetPatInfo(epis,mi) D Trace^MI.MIF000(mi,PatInfomation,\u0026#34;PatInfomation is\u0026#34;) s (RegNo,Name,Birth,Species,PatType,LOC,BedNo,Fee,Srcdocno,PatAge)=\u0026#34;\u0026#34; if $l(PatInfomation){ s RegNo=$p(PatInfomation,\u0026#34;,\u0026#34;,9) s Name=$p(PatInfomation,\u0026#34;,\u0026#34;,10) s Birth=$p(PatInfomation,\u0026#34;,\u0026#34;,29) s Species=$p(PatInfomation,\u0026#34;,\u0026#34;,11) i Species=\u0026#34;1\u0026#34; s Species=\u0026#34;男\u0026#34; i Species=\u0026#34;2\u0026#34; s Species=\u0026#34;女\u0026#34; s PatType=$p(PatInfomation,\u0026#34;,\u0026#34;,12) s LOC=$p(PatInfomation,\u0026#34;,\u0026#34;,6) s BedNo=$p(PatInfomation,\u0026#34;,\u0026#34;,13) s Fee=$p(PatInfomation,\u0026#34;,\u0026#34;,5) s Srcdocno=$p(PatInfomation,\u0026#34;,\u0026#34;,7) s PatAge=$p(PatInfomation,\u0026#34;,\u0026#34;,14) } s PID=\u0026#34;PID|1||\u0026#34;_RegNo_\u0026#34;^^^^MR||\u0026#34;_Name_\u0026#34;^\u0026#34;_Name_\u0026#34;||\u0026#34;_Birth_\u0026#34;|\u0026#34;_Species s PV1=\u0026#34;PV1|1|\u0026#34;_PatType_\u0026#34;|\u0026#34;_LOC_\u0026#34;^^\u0026#34;_BedNo_\u0026#34;|||||||||||||||||\u0026#34;_Fee s ORC=\u0026#34;ORC|AF||\u0026#34;_epis s curTime=$zd($h,8)_$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;,\u0026#34;\u0026#34;) s randomNumber=1000+$r(1000) s OBR=\u0026#34;OBR|1|\u0026#34;_epis_\u0026#34;||00001^Automated Count^99MRC||\u0026#34;_curTime_randomNumber_\u0026#34;||||\u0026#34;_Srcdocno_\u0026#34;||||||||||||||HM||||||||Bill\u0026#34; s TestCodeDate=\u0026#34;\u0026#34; s TestCodeDate=$$SearchTestItem(mi,epis) s OBX=\u0026#34;OBX|1|IS|08003^Test Mode^99MRC||\u0026#34;_TestCodeDate_\u0026#34;||||||F\u0026#34;_cr_ \u0026#34;OBX|2|IS|01002^Ref Group^99MRC||Child||||||F\u0026#34;_cr_ \u0026#34;OBX|3|NM|30525-0^Age^LN||\u0026#34;_PatAge_\u0026#34;|yr|||||F\u0026#34;_cr_ \u0026#34;OBX|4|ST|01001^Remark^99MRC||\u0026#34;_PatType_\u0026#34;||||||F\u0026#34;_cr_ \u0026#34;OBX|5|ST|08005^SerialNumber^99MRC||\u0026#34;_isRecieve_\u0026#34;||||||F\u0026#34;_cr_ \u0026#34;OBX|6|IS|01007^Sample Type^99MRC||Venous blood||||||\u0026#34;_cr_ \u0026#34;OBX|7|IS|01008^Patient Area^99MRC||A - 501||||||F\u0026#34;_cr_ \u0026#34;OBX|8|ST|01009^Custom patient info 1^99MRC||Nothing||||||F\u0026#34;_cr_ \u0026#34;OBX|9|ST|01010^Custom patient info 2^99MRC||Nothing||||||F\u0026#34;_cr_ \u0026#34;OBX|10|ST|01011^Custom patient info 3^99MRC||Nothing||||||F\u0026#34; S TMPORDER=sb_mshStr_cr_MSA_cr_PID_cr_PV1_cr_ORC_cr_OBR_cr_OBX_cr_eb_cr w sb,mshStr,cr,MSA,cr,PID,cr,PV1,cr,ORC,cr,OBR,cr,OBX,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,TMPORDER,\u0026#34;H-\u0026gt;M\u0026#34;) } Q ret SearchTestItem(mi,epis) S tcx=\u0026#34;\u0026#34;,tc=\u0026#34;\u0026#34; d ScanOne^MI.MIF000(mi,epis) i $d(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,epis)){ f { s tc=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,epis,tc)) q:tc=\u0026#34;\u0026#34; i \u0026#39;$l(tcx){ s tcx=tc }else{ s tcx=tcx_\u0026#34;+\u0026#34;_tc } } } Q tcx GetPatInfo(labno,mi) s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,\u0026#34;\u0026#34;_labno,\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),2) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) s Sampleno=labno //检测号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; ;病区 s RetString=\u0026#34;\u0026#34; s EpisodeNo=\u0026#34;\u0026#34; s Diagnose=\u0026#34;\u0026#34; s RetString=Sampleda_\u0026#34;,\u0026#34;_Instrument_\u0026#34;,\u0026#34;_Sampleno_\u0026#34;,\u0026#34;_Sampletype_\u0026#34;,\u0026#34;_Feetype_\u0026#34;,\u0026#34;_Srcdepno_\u0026#34;,\u0026#34;_Srcdocno_\u0026#34;,\u0026#34;_Userno_\u0026#34;,\u0026#34; s RetString=RetString_Patno_\u0026#34;,\u0026#34;_Patna_\u0026#34;,\u0026#34;_Sex_\u0026#34;,\u0026#34;_Pattype_\u0026#34;,\u0026#34;_Bedno_\u0026#34;,\u0026#34;_Patage_\u0026#34;,\u0026#34;_Ageunit_\u0026#34;,\u0026#34;_Reqno_\u0026#34;,\u0026#34;_Reqda_\u0026#34;,\u0026#34; s RetString=RetString_Reportda_\u0026#34;,\u0026#34;_Printflag_\u0026#34;,\u0026#34;_Resultflag_\u0026#34;,\u0026#34;_Errflag_\u0026#34;,\u0026#34;_Diagnose_\u0026#34;,\u0026#34;_Description_\u0026#34;,\u0026#34;_Reserve_\u0026#34;,\u0026#34; s RetString=RetString_Patnamn_\u0026#34;,\u0026#34;_Getda_\u0026#34;,\u0026#34;_Wardno_\u0026#34;,\u0026#34;_BarCode_\u0026#34;,\u0026#34;_BirthDate_\u0026#34;,\u0026#34;_EpisodeNo q RetString //双向上传医嘱信息,wwh,2015-11-05,未测试 SendOrder(mi,mshStr,record) N (mi,mshStr,record) S mi=$G(mi),mshStr=$G(mshStr),record=$G(record) Q:\u0026#39;$L(mi) 1 Q:\u0026#39;$D(^TMIF(mi)) 1 S barcode=$P(record,\u0026#34;|\u0026#34;,4) I \u0026#39;$L(barcode) { D Trace^MI.MIF000(mi,\u0026#34;条码号为空\u0026#34;,\u0026#34;Order\u0026#34;) Q 1 } I $ZCVT(barcode,\u0026#34;U\u0026#34;)=$ZCVT(\u0026#34;Invalid\u0026#34;,\u0026#34;U\u0026#34;) {\t//条码扫描错误 D Trace^MI.MIF000(mi,\u0026#34;条码扫描错误,机器未识别\u0026#34;,\u0026#34;Order\u0026#34;) Q 1 } I \u0026#39;$D(^TEPI(barcode)) { D Trace^MI.MIF000(mi,\u0026#34;在检验系统未找到条码:\u0026#34;_barcode_\u0026#34;对应的标本信息,确定条码正确或标本已经接收?\u0026#34;,\u0026#34;Order\u0026#34;) Q 1 } K uploadList S tsCode=\u0026#34;\u0026#34;,uploadList=0 F { S tsCode=$O(^TEPI(barcode,1,tsCode)) Q:\u0026#39;$L(tsCode) Q:\u0026#39;$D(^TMIF(mi,0,tsCode)) S tsDesc=$P($G(^TTAB(\u0026#34;TS\u0026#34;,tsCode)),\u0026#34;\\\u0026#34;,1) S tsCnt=$O(^TEPI(barcode,1,tsCode,\u0026#34;\u0026#34;)) Q:\u0026#39;$L(tsCnt) S status=$P($G(^TEPI(barcode,1,tsCode,tsCnt)),\u0026#34;\\\u0026#34;,31) I status=\u0026#34;A\u0026#34; { D Trace^MI.MIF000(mi,\u0026#34;条码扫:\u0026#34;_barcode_\u0026#34;,医嘱:\u0026#34;_tsCode_\u0026#34;||\u0026#34;_tsDesc_\u0026#34;,不是登记状态,不再上传\u0026#34;,\u0026#34;Order\u0026#34;)\tContinue } S channel=$$GetTestSetChannel(tsCode) I \u0026#39;$L(channel) { D Trace^MI.MIF000(mi,\u0026#34;条码扫:\u0026#34;_barcode_\u0026#34;,医嘱:\u0026#34;_tsCode_\u0026#34;||\u0026#34;_tsDesc_\u0026#34;,未找到通道号\u0026#34;,\u0026#34;Order\u0026#34;)\tContinue } Continue:$D(uploadList(tsCode)) S uploadList(tsCode)=channel S uploadList=$I(uploadList) } I +$G(uploadList)\u0026lt;1 { D Trace^MI.MIF000(mi,\u0026#34;条码扫:\u0026#34;_barcode_\u0026#34;未找可上传的医嘱\u0026#34;,\u0026#34;Order\u0026#34;) Q 1 } //1,仪器发送过来的请求信息: //MSH|^~\\\u0026amp;||Mindray|||20081120174836||ORM^O01|4|P|2.3.1||||||UNICODE //ORC|RF||SampleID1||IP S order=\u0026#34;\u0026#34; S msh=\u0026#34;MSH|^~\\\u0026amp;|LIS||||\u0026#34;_$TR($ZDT($H,8),\u0026#34; :\u0026#34;)_\u0026#34;||ORR^O02|1|P|2.3.1||||||UNICODE\u0026#34; //huifu: //MSH|^~\\\u0026amp;|LIS||||20081120174836||ORR^O02|1|P|2.3.1||||||UNICODE //MSA|AA|4 //PID|1||ChartNo^^^^MR||^FName||19810506|NT //PV1|1|E|内科^^Bn4|||||||||||||||||NewCharge //ORC|AF|SampleID1||| //OBR|1|SampleID1||||20060506||||tester|||Diagnose content...|20060504||||||||20080821||HM||||审核者||||检验者 //OBX|1|IS|08001^Take Mode^99MRC||A||||||F //OBX|2|IS|08002^Blood Mode^99MRC||W||||||F //OBX|3|IS|08003^Test Mode^99MRC||CBC||||||F //OBX|4|IS|01002^Ref Group^99MRC||XXXX||||||F //OBX|5|NM|30525-0^Age^LN||1|hr|||||F //OBX|6|ST|01001^Remark^99MRC||remark content...||||||F ///未找到检测时: //MSH|^~\\\u0026amp;|LIS||||20081120174836||ORR^O02|1|P|2.3.1||||||UNICODE //MSA|AR|9 Q 0 GetTestSetChannel(tsCode) N (tsCode) S tsCode=$G(tsCode) Q \u0026#34;\u0026#34; 8-血细胞（迈瑞7500））H-046-011151-00-7.0 labXpert 通信协议（中文）.pdf\nASTM 协议接口双向 一次性发送按照字符数多次发送 限制每次发送字数不能超过 241 个字数，在回传时要根据回传的字符数进行分割\n示例接口(日立 008) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 //// MI.MIFABH7600BI /// 名称: MI.MIFDXC800BI /// 描述: DXC800 仪器接口 /// 通讯方式：双向,半双工 /// 编写者:liuzf /// 编写日期: 20150827 MIFABH7600BI(mi) ; 3/17/04 ; ASTM protocol - H7600 s mi=$g(mi) S ^TMPMACH10(mi,104)=$H i \u0026#39;$l(mi) q s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 //控制字符 s stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4) s lf=$c(10),cr=$c(13),nak=$c(21),(result,epis)=\u0026#34;\u0026#34;,etb=$c(23) S ^TMPMACH10(mi,102)=$H i $$Start^MI.MIF000(mi) q f d Main i $$Stop^MI.MIF000(mi) q c Port q ErrHandler h 10 d Trace^MI.MIF000(mi,$TR($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) s iERR=+$g(iERR)+1 i iERR\u0026gt;30 s ret=$$Stop^MI.MIF000(mi) Q Main SET $ZTRAP=\u0026#34;ErrHandler\u0026#34; S iERR=0 r *R:10 e d q .d BUILD .//自动上传 .d BUILD2 i $c(R)=enq d .s AllRecord=\u0026#34;\u0026#34; .d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) .d ACK .f r *R:10 q:$c(R)=eot d ..i $c(R)\u0026#39;=stx q ..s record=$$Read^MI.MIF000(mi,\u0026#34;\u0026#34;,lf) q:\u0026#39;$l(record) ..s record=$e(record,2,$l(record)-1) ..d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) ..s AllRecord=AllRecord_$p(record,etb,1) ..d ACK .d Trace^MI.MIF000(mi,$s($c(R)=eot:\u0026#34;EOT\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) .;i $c(R)=eot,$l(AllRecord) d .i $l(AllRecord) d ..s (mid,sample,epis,surname,rec,res,result,date,time,QC,Pflag,code)=\u0026#34;\u0026#34; ..f i=1:1:$l(AllRecord,cr) d ...s rec=$p(AllRecord,cr,i) ...d Trace^MI.MIF000(mi,rec,\u0026#34;rec\u0026#34;) ...s type=$tr($p(rec,\u0026#34;|\u0026#34;),\u0026#34; \u0026#34;) ...i type=\u0026#34;H\u0026#34; d q ....s (mid,sample,epis,surname,rec,res,result,date,time,QC,racksid,rackno,code)=\u0026#34;\u0026#34; ...i type=\u0026#34;Q\u0026#34; d q ....;Q|1|^^0/*************/1/5527/5/R1/R||||||||||A\u0026#34;_$c(13)_\u0026#34; ....s temstr=$p(rec,\u0026#34;|\u0026#34;,3) ....s temlabno=$p(temstr,\u0026#34;^\u0026#34;,3) ....;s temlabno=$tr($P(temstr,\u0026#34;/\u0026#34;,2),\u0026#34;*\u0026#34;) ....;i \u0026#39;$l(temlabno) q ....;s racksid=$tr($p(temstr,\u0026#34;/\u0026#34;,4),\u0026#34; \u0026#34;) ....;s rackno=$tr($p(temstr,\u0026#34;/\u0026#34;,5),\u0026#34; \u0026#34;) ....;S temlabno=$tr(temlabno,\u0026#34; \u0026#34;) ....;s temlabno=$tr($P(temstr,\u0026#34;/\u0026#34;,2),\u0026#34;*\u0026#34;) ....;i \u0026#39;$l(temlabno) q ....s racksid=$p(temstr,\u0026#34;^\u0026#34;,5) ....s rackno=$p(temstr,\u0026#34;^\u0026#34;,6) ....s ^TMP($zn,$j,\u0026#34;temlabnoInfo\u0026#34;,temlabno)=$p(temstr,\u0026#34;^\u0026#34;,4,9) ....d Trace^MI.MIF000(mi,temlabno,\u0026#34;temlabno\u0026#34;) ....;s temlabno=9000001621 ....i \u0026#39;$l(temlabno) q ....s ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,temlabno)=racksid_\u0026#34;^\u0026#34;_rackno ...//------------------------------------ ...i type=\u0026#34;O\u0026#34; d q ....s epis=$tr($p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,2),\u0026#34; \u0026#34;) ....if epis=\u0026#34;\u0026#34; s epis=+$tr($p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) ....s qcid=$tr($p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,2),\u0026#34; \u0026#34;) ....s qcid=$tr(qcid,\u0026#34;-\u0026#34;) ....s QCStat=$tr($p(rec,\u0026#34;|\u0026#34;,4),\u0026#34; \u0026#34;) ....s SpecStat=$tr($p(rec,\u0026#34;|\u0026#34;,6),\u0026#34; \u0026#34;) ....i SpecStat=\u0026#34;S\u0026#34; s epis=epis //s epis=\u0026#34;E\u0026#34;_epis ....i QCStat=\u0026#34;Q\u0026#34; s QC=\u0026#34;\\\u0026#34;_qcid,epis=qcid ....;s QC=$$findQC^MIF000(mi,epis) ....s datex=$p(rec,\u0026#34;|\u0026#34;,23) ....//s date=$e(datex,5,6)_\u0026#34;/\u0026#34;_$e(datex,7,8)_\u0026#34;/\u0026#34;_$e(datex,1,4) ;,date=$$intdate^SSUTIL4(date) ....//s time=$e(datex,9,10)_\u0026#34;:\u0026#34;_$e(datex,11,12)_\u0026#34;:\u0026#34;_$e(datex,13,14) ;,time=$$inttime^SSUTIL4(time1) ...//-------------------- ...i type=\u0026#34;R\u0026#34; d q ....s code=$tr($p($p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4),\u0026#34;/\u0026#34;,1),\u0026#34; \u0026#34;) ....s mid1=$p(rec,\u0026#34;|\u0026#34;,14) ....//DaiYi 20111226 ....If mid1=\u0026#34;ISE1\u0026#34; Set mid1=\u0026#34;\u0026#34; ....;If mid1=\u0026#34;D1\u0026#34; Set mid1=\u0026#34;\u0026#34; ....;If mid1\u0026#39;=\u0026#34;\u0026#34;,QC\u0026#39;=\u0026#34;\u0026#34; Set QC=$$findQC^MIF000(mi,epis_mid1) ....;If mid1\u0026#39;=\u0026#34;\u0026#34;,QC\u0026#39;=\u0026#34;\u0026#34; Set epis=epis_mid1 ....If mid1\u0026#39;=\u0026#34;\u0026#34; s mid=mid1 ....s res=$p(rec,\u0026#34;|\u0026#34;,4) ...i type=\u0026#34;C\u0026#34; d q ....//-----FLAG---DaiYi 2010-07-12 ....s resFlag=$p(rec,\u0026#34;|\u0026#34;,4) ....If resFlag=0 Set resFlag=\u0026#34;\u0026#34; ....If resFlag=26 Set resFlag=\u0026#34;$\u0026#34; ....If resFlag=5 Set resFlag=\u0026#34;Z\u0026#34; ....If resFlag=43 Set resFlag=\u0026#34;!\u0026#34; ....If resFlag=1 Set resFlag=\u0026#34;A\u0026#34; ....If resFlag=2 Set resFlag=\u0026#34;Q\u0026#34; ....If resFlag=3 Set resFlag=\u0026#34;V\u0026#34; ....If resFlag=4 Set resFlag=\u0026#34;T\u0026#34; ....If resFlag=6 Set resFlag=\u0026#34;P\u0026#34; ....If resFlag=7 Set resFlag=\u0026#34;I\u0026#34; ....If resFlag=8 Set resFlag=\u0026#34;J\u0026#34; ....If resFlag=9 Set resFlag=\u0026#34;K\u0026#34; ....If resFlag=10 Set resFlag=\u0026#34;W\u0026#34; ....If resFlag=11 Set resFlag=\u0026#34;F\u0026#34; ....If resFlag=12 Set resFlag=\u0026#34;H\u0026#34; ....If resFlag=13 Set resFlag=\u0026#34;U\u0026#34; ....If resFlag=14 Set resFlag=\u0026#34;S\u0026#34; ....If resFlag=15 Set resFlag=\u0026#34;Y\u0026#34; ....If resFlag=16 Set resFlag=\u0026#34;G\u0026#34; ....If resFlag=17 Set resFlag=\u0026#34;B\u0026#34; ....If resFlag=18 Set resFlag=\u0026#34;N\u0026#34; ....If resFlag=19 Set resFlag=\u0026#34;L\u0026#34; ....If resFlag=20 Set resFlag=\u0026#34;E\u0026#34; ....If resFlag=21 Set resFlag=\u0026#34;R\u0026#34; ....If resFlag=22 Set resFlag=\u0026#34;D\u0026#34; ....If resFlag=23 Set resFlag=\u0026#34;\u0026amp;\u0026#34; ....If resFlag=24 Set resFlag=\u0026#34;Z\u0026#34; ....If resFlag=25 Set resFlag=\u0026#34;M\u0026#34; ....If resFlag=27 Set resFlag=\u0026#34;$\u0026#34; ....If resFlag=28 Set resFlag=\u0026#34;@\u0026#34; ....If resFlag=29 Set resFlag=\u0026#34;#\u0026#34; ....If resFlag=30 Set resFlag=\u0026#34;#\u0026#34; ....If resFlag=31 Set resFlag=\u0026#34;#\u0026#34; ....If resFlag=32 Set resFlag=\u0026#34;#\u0026#34; ....If resFlag=33 Set resFlag=\u0026#34;#\u0026#34; ....If resFlag=34 Set resFlag=\u0026#34;#\u0026#34; ....If resFlag=35 Set resFlag=\u0026#34;+\u0026#34; ....If resFlag=36 Set resFlag=\u0026#34;+\u0026#34; ....If resFlag=37 Set resFlag=\u0026#34;%\u0026#34; ....If resFlag=38 Set resFlag=\u0026#34;O\u0026#34; ....If resFlag=39 Set resFlag=\u0026#34;X\u0026#34; ....If resFlag=42 Set resFlag=\u0026#34;\u0026#39;\u0026#34; ....If resFlag=43 Set resFlag=\u0026#34;!\u0026#34; ....If resFlag=44 Set resFlag=\u0026#34;=\u0026#34; ....If resFlag=45 Set resFlag=\u0026#34;=\u0026#34; ....If resFlag=46 Set resFlag=\u0026#34;\u0026gt;\u0026#34; ....If resFlag=51 Set resFlag=\u0026#34;:\u0026#34; ....If resFlag=52 Set resFlag=\u0026#34;;\u0026#34; ....If resFlag=53 Set resFlag=\u0026#34;/\u0026#34; ....If resFlag=55 Set resFlag=\u0026#34;r\u0026#34; ....If resFlag=62 Set resFlag=\u0026#34;g\u0026#34; ....If resFlag=63 Set resFlag=\u0026#34;a\u0026#34; ....If resFlag=64 Set resFlag=\u0026#34;b\u0026#34; ....If resFlag=65 Set resFlag=\u0026#34;p\u0026#34; ....If resFlag=66 Set resFlag=\u0026#34;q\u0026#34; ....If resFlag=67 Set resFlag=\u0026#34;h\u0026#34; ....If resFlag=68 Set resFlag=\u0026#34;k\u0026#34; ....If resFlag=69 Set resFlag=\u0026#34;m\u0026#34; ....If resFlag=70 Set resFlag=\u0026#34;f\u0026#34; ....If resFlag=71 Set resFlag=\u0026#34;d\u0026#34; ....If resFlag=72 Set resFlag=\u0026#34;e\u0026#34; ....If resFlag=74 Set resFlag=\u0026#34;y\u0026#34; ....If resFlag=75 Set resFlag=\u0026#34;t\u0026#34; ....If resFlag=76 Set resFlag=\u0026#34;s\u0026#34; ....If resFlag=77 Set resFlag=\u0026#34;c\u0026#34; ....If resFlag=86 Set resFlag=\u0026#34;u\u0026#34; ....If resFlag=87 Set resFlag=\u0026#34;n\u0026#34; ....If resFlag=93 Set resFlag=\u0026#34;z\u0026#34; ....If resFlag=94 Set resFlag=\u0026#34;]\u0026#34; ....If resFlag=95 Set resFlag=\u0026#34;[\u0026#34; ....If resFlag=96 Set resFlag=\u0026#34;[\u0026#34; ....If resFlag=97 Set resFlag=\u0026#34;}\u0026#34; ....If resFlag=98 Set resFlag=\u0026#34;v\u0026#34; ....If resFlag=99 Set resFlag=\u0026#34;w\u0026#34; ....If resFlag=100 Set resFlag=\u0026#34;\u0026lt;\u0026#34; ....If resFlag=101 Set resFlag=\u0026#34;￥\u0026#34; ....;s result=result_code_ResultDeli_res_$c(92,92,92)_resFlag_$c(44) ....s result=result_code_ResultDeli_res_ItemDeli ....//------------------------------------------------ ...i type=\u0026#34;L\u0026#34; d Last q q Last\t; file result if exist s AllRecord=\u0026#34;\u0026#34; d BUILD d Trace^MI.MIF000(mi,mi,\u0026#34;1H\u0026lt;--M\u0026#34;) d Trace^MI.MIF000(mi,result,\u0026#34;1H\u0026lt;--M\u0026#34;) //s epis=9775 i $l(epis),$l(result) d Save^MI.MIF000(mi,epis,result,date,time,QC) s (epis,result,date,time,QC)=\u0026#34;\u0026#34; q BUILD i \u0026#39;$d(^TMP($zn)) q i \u0026#39;$d(^TMP($zn,$j)) q s labno=\u0026#34;\u0026#34; f s labno=$o(^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,labno)) q:labno=\u0026#34;\u0026#34; d .;根据预置条码号取得检验条码号 .;s ^aai200(763,labno)=\u0026#34;\u0026#34; .//s labno1=$$GetLabNo^CHDhcLabDoEpis(labno) .//s ^aai200(764,labno)=labno1_\u0026#34;,\u0026#34;_labno_\u0026#34;,\u0026#34;_mi .//----判断日志条码和系统条码是否一样---- .//If labno=labno1 Quit .//-------------------------------------- .d ScanOne^MI.MIF000(mi,labno) .s tcx=\u0026#34;\u0026#34; .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) q:chl=\u0026#34;\u0026#34; d ..s tcx=tcx_\u0026#34;^^^\u0026#34;_$p(chl,\u0026#34;_\u0026#34;,1)_\u0026#34;^\\\u0026#34; .s tcx=$e(tcx,1,$l(tcx)-1) .;s xx=$$extdate2^SSUTIL4($h),date=$p(xx,\u0026#34;/\u0026#34;,3)_$p(xx,\u0026#34;/\u0026#34;,2)_$p(xx,\u0026#34;/\u0026#34;,1) .;s xx=$$exttime^SSUTIL4($p($h,\u0026#34;,\u0026#34;,2)),time=$p(xx,\u0026#34;:\u0026#34;,1)_$p(xx,\u0026#34;:\u0026#34;,2)_\u0026#34;00\u0026#34; .s temepis=\u0026#34;\u0026#34; .s str=\u0026#34;1H|\\^\u0026amp;|||host^1|||||LST008AS|TSDWN^REPLY|P|1\u0026#34;_cr .//s str=str_\u0026#34;P|1|||||||M||||||48^Y\u0026#34;_cr .s str=str_\u0026#34;P|1|||||||||||||\u0026#34;_cr .s samtype=\u0026#34;1\u0026#34; .s racksid=$p(^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,labno),\u0026#34;^\u0026#34;,1) .;s rackno=$p(^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,labno),\u0026#34;^\u0026#34;,2) .s temlabnoInfo=^TMP($zn,$j,\u0026#34;temlabnoInfo\u0026#34;,labno) .i labno=\u0026#34;N\u0026#34; s labno=\u0026#34;\u0026#34; .;d SetTSMachine(mi,labno,racksid,rackno) .s str=str_\u0026#34;O|1|\u0026#34;_labno_\u0026#34;|\u0026#34;_temlabnoInfo_\u0026#34;|\u0026#34; .s str=str_tcx_\u0026#34;|R||\u0026#34;_$tr($tr($zdt($h,8),\u0026#34; \u0026#34;),\u0026#34;:\u0026#34;)_\u0026#34;||||A||||1||||||||||O\u0026#34;_cr .;s str=str_\u0026#34;O|1|40045259602|0^00001^1^^S1^SC|^^^601^\\^^^1011^dec\\1012^400|R||20000630131236||||A||||1||||||||||O\u0026#34;_cr .s str=str_\u0026#34;C|1|I|comment1^comment2^comment3^comment4^comment5|G\u0026#34;_cr .s str=str_\u0026#34;L|1|N\u0026#34;_cr .d Send(labno,str) .k ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;) .k ^TMP($zn,$j,\u0026#34;temlabnoInfo\u0026#34;) q //读取自动上传的标本 BUILD2 K ^TMP($zn,$j) s LabnoList=\u0026#34;\u0026#34; S AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s ^TMP(\u0026#34;MI\u0026#34;,1)=AddDate s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d .s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) .s Labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) .//H 1 //每隔2S处理一个标本上传 .S SIMAck=$$BUILD3() .I SIMAck=0 D ..s err=##Class(MI.MachineUpload).SetSendFlag(mi,Labno,\u0026#34;S\u0026#34;,\u0026#34;\u0026#34;) //成功 .E D ..s err=##Class(MI.MachineUpload).SetSendFlag(mi,Labno,\u0026#34;F\u0026#34;,\u0026#34;\u0026#34;) //失败 q BUILD3() ; S episx=Labno,Labno=$P(Labno,\u0026#34;-\u0026#34;,1),suffix=\u0026#34;\u0026#34;,RetAck=1 s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q 1 s WorkGPMiDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR, \u0026#34;\u0026#34;)) i WorkGPMiDR=\u0026#34;\u0026#34; q 1 s RptOrder=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR, WorkGPMiDR,\u0026#34;\u0026#34;)) i RptOrder=\u0026#34;\u0026#34; q 1 s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR, WorkGPMiDR,RptOrder,\u0026#34;\u0026#34;)) i ReportDR=\u0026#34;\u0026#34; q 1 s EpisodeNo=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),8) i EpisodeNo=\u0026#34;\u0026#34; q 1 s epis=EpisodeNo d ScanOne^MI.MIF000(mi,Labno) ;创建上传化验项目列表 i \u0026#39;$D(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,Labno)) q 1 s tcx=\u0026#34;\u0026#34; s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,Labno,chl)) q:chl=\u0026#34;\u0026#34; d ..s tcx=tcx_\u0026#34;^^^\u0026#34;_$p(chl,\u0026#34;_\u0026#34;,1)_\u0026#34;/\\\u0026#34; s tcx=$e(tcx,1,$l(tcx)-1) s date=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s time=$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;) s str=\u0026#34;1H|\\^\u0026amp;|||H7600^1|||||host|TSDWN^REPLY|P|1\u0026#34;_cr s str=str_\u0026#34;P|1\u0026#34;_cr s str=str_\u0026#34;O|1|\u0026#34;_epis_\u0026#34;^^1^^|R1|\u0026#34; s str=str_tcx_\u0026#34;|R||\u0026#34;_date_time_\u0026#34;||||N||||||||^^^^||||||O\u0026#34;_cr s str=str_\u0026#34;L|1|N\u0026#34;_cr d Send(epis,str) Q 0 //给检验号赋仪器和位置号 SetTSMachine(mi,labno,rack,pos) n (mi,labno,rack,pos) s mi=$g(mi),labno=$g(labno),rack=$g(rack),pos=$g(pos) If $Data(^DHCSndLabNo(labno)) Set ^DHCSndLabNo(labno)=labno_\u0026#34;\\\u0026#34;_rack_\u0026#34;-\u0026#34;_pos_\u0026#34;\\\u0026#34; q ORDER ; create list of orders if exists ; ^DHCMIFLoadList(mi,\u0026#34;PEND\u0026#34;,flowno) 暂时存储上传医嘱列表 s ord=\u0026#34;\u0026#34; f s ord=$o(^DHCMIFLoadList(mi,\u0026#34;PEND\u0026#34;,ord)) q:ord=\u0026#34;\u0026#34; d .s rectemp=$g(^DHCMIFLoadList(mi,\u0026#34;PEND\u0026#34;,ord)) .s epis=ord .s (str,tcs,date,time)=\u0026#34;\u0026#34; .;化验项目列表 .f i=1:1:$l(rectemp,\u0026#34;,\u0026#34;) d ..s tc=$p(rectemp,\u0026#34;,\u0026#34;,i) ..q:tc=\u0026#34;\u0026#34; ..s tcs=tcs_\u0026#34;^^^\u0026#34;_tc_\u0026#34;/\\\u0026#34; .s tcs=$e(tcs,1,$l(tcs)-1) .;日期时间 .s date=$p($h,\u0026#34;/\u0026#34;,3)_$p($h,\u0026#34;/\u0026#34;,2)_$p($h,\u0026#34;/\u0026#34;,1) .s xx=$p($h,\u0026#34;,\u0026#34;,2),time=$p(xx,\u0026#34;:\u0026#34;,1)_$p(xx,\u0026#34;:\u0026#34;,2)_\u0026#34;00\u0026#34; .;s xx=$$extdate2^SSUTIL4($h),date=$p(xx,\u0026#34;/\u0026#34;,3)_$p(xx,\u0026#34;/\u0026#34;,2)_$p(xx,\u0026#34;/\u0026#34;,1) .;s xx=$$exttime^SSUTIL4($p($h,\u0026#34;,\u0026#34;,2)),time=$p(xx,\u0026#34;:\u0026#34;,1)_$p(xx,\u0026#34;:\u0026#34;,2)_\u0026#34;00\u0026#34; .s str=\u0026#34;1H|\\^\u0026amp;|||HOST^1|||||1-99999|TSDWN^REPLY|P|1\u0026#34;_cr .s str=str_\u0026#34;P|1\u0026#34;_cr .s str=str_\u0026#34;O|1|\u0026#34;_epis_\u0026#34;^ ^1^^|R1|\u0026#34; .s str=str_tcs_\u0026#34;|R||\u0026#34;_date_time_\u0026#34;||||N||||||||^^^^||||||O\u0026#34;_cr .s str=str_\u0026#34;L|1|N\u0026#34;_cr .d Send(epis,str) .s ^DHCMIFLoadList(mi,\u0026#34;TRAN\u0026#34;,epis)=$g(^DHCMIFLoadList(mi,\u0026#34;PEND\u0026#34;,epis)) ;保存已传输数据 .k ^DHCMIFLoadList(mi,\u0026#34;PEND\u0026#34;,epis) ;删除待传输数据 q Send(epis,str) ; send list of orders if exists h 0.5 ;w enq,*-3 d trace^MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) w enq,*-3 d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q d Trace^MI.MIF000(mi,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;1H\u0026lt;--M\u0026#34;) i $c(R)=enq q i $c(R)\u0026#39;=ack w eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q i $l(str)\u0026gt;240 d .s str1=$e(str,1,240) .s ret=$$SEND(str1,1) .s strS=$e(str,241,$l(str)) .i $l(strS)\u0026gt;240 d ..s str2=\u0026#34;2\u0026#34;_$e(strS,1,240) ..s ret=$$SEND(str2,1) ..s strS1=$e(strS,241,$l(strS)) ..i $l(strS1)\u0026gt;240 d ...s str3=\u0026#34;3\u0026#34;_$e(strS1,1,240) ...s ret=$$SEND(str3,1) ...s str4=\u0026#34;4\u0026#34;_$e(strS1,241,$l(strS1)) ...s ret=$$SEND(str4,0) ..e d ...s str3=\u0026#34;3\u0026#34;_$e(strS1,241,$l(strS1)) ...s ret=$$SEND(str3,0) .e d ..s str2=\u0026#34;2\u0026#34;_$e(str,241,$l(str)) ..s ret=$$SEND(str2,0) e d .s ret=$$SEND(str,0) ;f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q ;d trace^MIF000(mi,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;2H\u0026lt;--M\u0026#34;) w eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q Sendold(epis,str) ; send list of orders if exists w enq,*-3 d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q d Trace^MI.MIF000(mi,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;1H\u0026lt;--M\u0026#34;) i $c(R)=enq q i $c(R)\u0026#39;=ack w eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q i $l(str)\u0026gt;241 d .s str1=$e(str,1,241) .s ret=$$SEND(str1,1) .s str2=\u0026#34;2\u0026#34;_$e(str,242,$l(str)) .s ret=$$SEND(str2,0) e d .s ret=$$SEND(str,0) w eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q SEND(str,flag) ; send string to instrument i flag=1 d .s str=str_etb .s chsum=$$CHSUM(str) e d .s str=str_etx .s chsum=$$CHSUM(str) w stx,str,chsum,cr,lf,*-3 d Trace^MI.MIF000(mi,str_chsum,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:6 r *R:1 i ($c(R)=ack)!($c(R)=eot) q i $c(R)=ack d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 i $c(R)=eot d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 i $c(R)=-1 w nak,*-3 d Trace^MI.MIF000(mi,R,\u0026#34;H\u0026lt;--M\u0026#34;) q 1 CHSUM(x) ; calculate check sum n (x) s z=0 f y=1:1:$l(x) s z=z+$a(x,y) s z=$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#256\\16+1)_$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#16+1) q z ACK ; send \u0026#39;ack\u0026#39; to instrument w ack,*-3 d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q NEXTTRAY(tray) q tray 通过收到 ACK 发送多条数据 示例接口(贝克曼 DXH900) 标准的 ASTM 发送等收到 ACK 后继续回传下一条信息\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 MIFDXH800I(MachID) s MachID=$g(MachID) S ^TMPMACH10(MachID,104)=$H i \u0026#39;$l(MachID) q s ItemDeli=$li(^dbo.BTMIMachineParameterD(MachID),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(MachID),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(MachID),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(MachID),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(MachID),17) //端口号 //控制字符 s stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4),lf=$c(10),cr=$c(13),nak=$c(21) //s stx=\u0026#34;[\u0026#34;,etx=\u0026#34;]\u0026#34; S ^TMPMACH10(MachID,102)=$H i $$Start^MI.MIF000(MachID) q f d Main i $$Stop^MI.MIF000(MachID) q c Port q ///结果采集和数据分解 Main r *R:10 e d q .d ORDER i $c(R)\u0026#39;=enq q d Trace^MI.MIF000(MachID,\u0026#34;ENQ\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) d ACK s (Epis,Result,Date,Time,QC)=\u0026#34;\u0026#34; f r *R:10 q:$c(R)=eot q:R=-1 d .i $c(R)\u0026#39;=stx q .s Record=$$Read^MI.MIF000(MachID,\u0026#34;\u0026#34;,lf) q:\u0026#39;$l(Record) .d Trace^MI.MIF000(MachID,Record,\u0026#34;H\u0026lt;--M\u0026#34;) .d ACK .i $e(Record,2)=\u0026#34;C\u0026#34; d q ..//报警信息 ..s PoliceInfo=$p(Record,\u0026#34;|\u0026#34;,4) ..i $l(PoliceInfo),$d(^LISPolice(\u0026#34;DXH900\u0026#34;,PoliceInfo)) d ...s InputInfo=$g(^LISPolice(\u0026#34;DXH900\u0026#34;,PoliceInfo)) ...d Trace^MI.MIF000(MachID,PoliceInfo_\u0026#34;$$\u0026#34;_InputInfo,\u0026#34;报警信息\u0026#34;) ...try{s ret=##Class(MI.Special.Common).SaveAlarmInformation(MachID,Epis,InputInfo)}catch{} .i $e(Record,2)=\u0026#34;Q\u0026#34; d q ..//询问信息 ..s QEpis=$tr($p(Record,\u0026#34;|\u0026#34;,3),\u0026#34;!\u0026#34;) ..;d Trace^MI.MIF000(MachID,QEpis,\u0026#34;QEpis\u0026#34;) ..S ^TMPQUERY(MachID,1)=QEpis ..i $l(QEpis) s ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,QEpis)=\u0026#34;\u0026#34; .i $e(Record,2)=\u0026#34;H\u0026#34; d q ..//结果头信息 ..d Last s (Epis,Result,Date,Time,QC)=\u0026#34;\u0026#34; .i $e(Record,2)=\u0026#34;P\u0026#34; d q ..//病人信息 .i $e(Record,2)=\u0026#34;O\u0026#34; d q ..s Epis=$tr($p($p(Record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) ..s QC=$tr($p(Record,\u0026#34;|\u0026#34;,12),\u0026#34; \u0026#34;) ..s:\u0026#39;$l(Epis) Epis=$tr($p($p(Record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) ..//判断是否是质控编号 ..//s QC=$$findQC^MIF000(mi,epis) .i $e(Record,2)=\u0026#34;R\u0026#34; d q ..//结果信息 ..s Chl=$tr($tr($p($p(Record,\u0026#34;|\u0026#34;,3),\u0026#34;!\u0026#34;,4),\u0026#34; \u0026#34;),\u0026#34;@\u0026#34;) ..//s ResStus=$tr($p($p(Record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,11),\u0026#34; \u0026#34;) ..s Res=$p($tr($p(Record,\u0026#34;|\u0026#34;,4),\u0026#34; \u0026#34;),\u0026#34;!\u0026#34;,1) ..//i ResStus\u0026#39;=\u0026#34;F\u0026#34; q //判断结果状态 ..i $l(Chl),$l(Res) s Result=Result_Chl_ResultDeli_Res_ItemDeli .//绘图 .i $e(Record,2)=\u0026#34;M\u0026#34; d q ..//结果信息 ..s Chl=$tr($p($p(Record,\u0026#34;|\u0026#34;,3),\u0026#34;!\u0026#34;,4),\u0026#34; \u0026#34;) ..s Res=$P($tr($p(Record,\u0026#34;|\u0026#34;,4),\u0026#34; |\u0026#34;),\u0026#34;!\u0026#34;,1) ..s Chl=$p(Chl,\u0026#34;.\u0026#34;,1) ..i Chl=\u0026#34;WBC\u0026#34; d ...s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() ...s tret=tretObj.DrawImage(Epis,Res,MachID,\u0026#34;MI.MIFDXH800\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;Histogram#WBCF.bmp#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.ImageDealDXH800,LIS.Mach.ImageDeal\u0026#34;) ...d Trace^MI.MIF000(MachID,tret,\u0026#34;绘图返回\u0026#34;) ..i Chl=\u0026#34;Plt\u0026#34; d ...s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() ...s tret=tretObj.DrawImage(Epis,Res,MachID,\u0026#34;MI.MIFDXH800\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;Histogram#PLT.bmp#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.ImageDealDXH800,LIS.Mach.ImageDeal\u0026#34;) ...d Trace^MI.MIF000(MachID,tret,\u0026#34;绘图返回\u0026#34;) ..i Chl=\u0026#34;RBC\u0026#34; d ...s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() ...s tret=tretObj.DrawImage(Epis,Res,MachID,\u0026#34;MI.MIFDXH800\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;Histogram#RBCH.bmp#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.ImageDealDXH800,LIS.Mach.ImageDeal\u0026#34;) ...d Trace^MI.MIF000(MachID,tret,\u0026#34;绘图返回\u0026#34;) ..i Chl=\u0026#34;5PD1\u0026#34; d ...s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() ...s tret=tretObj.DrawImage(Epis,Res,MachID,\u0026#34;MI.MIFDXH800\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#5PD1.bmp#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.ImageDealDXH800,LIS.Mach.ImageDeal\u0026#34;) ...d Trace^MI.MIF000(MachID,tret,\u0026#34;绘图返回\u0026#34;) ..i Chl=\u0026#34;NRBC1\u0026#34; d ...s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New() ...s tret=tretObj.DrawImage(Epis,Res,MachID,\u0026#34;MI.MIFDXH800\u0026#34;,\u0026#34;-1\u0026#34;,\u0026#34;DiffPlot#NRBC1.bmp#######10#10#320#138\u0026#34;,\u0026#34;LIS.Mach.ImageDeal.ImageDealDXH800,LIS.Mach.ImageDeal\u0026#34;) ...d Trace^MI.MIF000(MachID,tret,\u0026#34;绘图返回\u0026#34;) .i $e(Record,2)=\u0026#34;L\u0026#34; d Last q d Trace^MI.MIF000(MachID,$s($c(R)=eot:\u0026#34;EOT\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) d ORDER q ///保存结果 Last ; file result if exist i $l(Epis),$l(Result) d Save^MI.MIF000(MachID,Epis,Result,Date,Time,QC) q ///上传项目 ORDER s date=$tr($zdt($p($h,\u0026#34;,\u0026#34;,1),3),\u0026#34;-\u0026#34;)_$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;) s ^TMPQUERY(MachID,2)=$d(^TMP($zn,$j)) i \u0026#39;$d(^TMP($zn,$j)) q ;d Trace^MI.MIF000(MachID,\u0026#34;准备上传,清除缓存\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) k ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID) k ^TMPQUERY(MachID,4) s Epis=\u0026#34;\u0026#34; f s Epis=$o(^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,Epis)) q:Epis=\u0026#34;\u0026#34; d .d ScanOne^MI.MIF000(MachID,Epis) .;d PATDET(Epis) .s LSH=\u0026#34;\u0026#34; .s LSH=$$CHANGEEPIS(MachID,Epis) .d Trace^MI.MIF000(MachID,Epis,\u0026#34;Epis\u0026#34;) .s TCx=\u0026#34;\u0026#34;,Episx=Epis .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID,Epis,chl)) q:chl=\u0026#34;\u0026#34; d ..s TCx=TCx_\u0026#34;!!!\u0026#34;_chl .;s TCx=TCx_\u0026#34;\\\u0026#34; .i TCx[\u0026#34;CDR\u0026#34; s TCx=\u0026#34;!!!CDR\u0026#34; .s sam=\u0026#34;Sam\u0026#34; .s pat=\u0026#34;219!King!Eric!T\u0026#34; .s F=\u0026#34;F\u0026#34; .s FA=\u0026#34;Fairview!952-121-1123\u0026#34; .s ^TMPQUERY(MachID,3)=TCx .i $l(TCx) d ..s line=$o(^TMPTMIF(MachID,22,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(MachID,22,line)=\u0026#34;H|\\!~|||LISHOST|||||||P|LIS2-A|\u0026#34;_date ..s line=$o(^TMPTMIF(MachID,22,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(MachID,22,line)=\u0026#34;P|1||\u0026#34;_LSH ..;s line=$o(^TMPTMIF(MachID,22,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(MachID,22,line)=\u0026#34;O|1|\u0026#34;_Episx_\u0026#34;|\u0026#34;_Pos_\u0026#34;|\u0026#34;_tcx_\u0026#34;|R||||||A||||Whole blood|||||||||||\u0026#34; ..;s line=$o(^TMPTMIF(MachID,22,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(MachID,22,line)=\u0026#34;O|1|\u0026#34;_Episx_\u0026#34;||\u0026#34;_TCx_\u0026#34;|R|\u0026#34;_date_\u0026#34;|\u0026#34;_date_\u0026#34;|||\u0026#34;_sam_\u0026#34;|A||||Whole blood|\u0026#34;_pat_\u0026#34;|||||||||\u0026#34;_F_\u0026#34;||\u0026#34;_FA ..s line=$o(^TMPTMIF(MachID,22,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(MachID,22,line)=\u0026#34;O|1|\u0026#34;_Episx_\u0026#34;||\u0026#34;_TCx_\u0026#34;|R|\u0026#34;_date_\u0026#34;|\u0026#34;_date_\u0026#34;|||\u0026#34;_sam_\u0026#34;|A||||Whole blood\u0026#34; ..s line=$o(^TMPTMIF(MachID,22,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(MachID,22,line)=\u0026#34;L|1|N\u0026#34; .e d ..s line=$o(^TMPTMIF(MachID,22,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(MachID,22,line)=\u0026#34;Q|1|^\u0026#34;_Epis_\u0026#34;||^^^ALL||||||||X\u0026#34; k ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;) k ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID) q:\u0026#39;$d(^TMPTMIF(MachID,22)) m ^TMPQUERY(MachID,4)=^TMPTMIF(MachID,22) d Send k ^TMPTMIF(MachID,22) q ///病人基本信息 PATDET(Epis) ; set patient details record s line=$o(^TMPTMIF(MachID,22,\u0026#34;\u0026#34;),-1)+1,^TMPTMIF(MachID,22,line)=\u0026#34;P|1|\u0026#34;_+$h_\u0026#34;||||||U||||||||||||||||||||||||||\u0026#34; q ///发送检测项目 Send w enq,*-3 d Trace^MI.MIF000(MachID,\u0026#34;ENQ\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q d Trace^MI.MIF000(MachID,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) i $c(R)=enq q i $c(R)\u0026#39;=ack w eot,*-3 d Trace^MI.MIF000(MachID,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q //q:$$SEND(\u0026#34;1H|\\^\u0026amp;\u0026#34;) ;q:$$SEND(\u0026#34;1H|\\^\u0026amp;|||LIS||||||||LIS2-A|\u0026#34;_date) s x=\u0026#34;\u0026#34; f FRAME=1:1 s x=$O(^TMPQUERY(MachID,4,x)) q:x=\u0026#34;\u0026#34; q:$$SEND(FRAME#8_^TMPQUERY(MachID,4,x)) w eot,*-3 d Trace^MI.MIF000(MachID,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) k ^TMPTMIF(MachID,22) q ///发送字符串 SEND(str) s str=str_cr_etx,chsum=$$CHSUM(str) w stx,str,chsum,cr,lf,*-3 d Trace^MI.MIF000(MachID,str_chsum,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:6 r *R:1 i ($c(R)=ack)!($c(R)=eot) q i $c(R)=ack d Trace^MI.MIF000(MachID,\u0026#34;ACK\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 i $c(R)=eot d Trace^MI.MIF000(MachID,\u0026#34;EOT\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 d Trace^MI.MIF000(MachID,R,\u0026#34;H\u0026lt;--M\u0026#34;) q 1 ///生成校验码 CHSUM(x) n (x) s z=0 f y=1:1:$l(x) s z=z+$a(x,y) s z=$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#256\\16+1)_$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#16+1) q z ///发送回应符到仪器 ACK w ack,*-3 d Trace^MI.MIF000(MachID,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q CHANGEEPIS(mi,epis) //根据流水号找检测号 S DATA=$zd($h,8) s mi=$g(mi),epis=$g(epis) s VisitNumberReportDR=\u0026#34;\u0026#34; b ;//^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,TransmitDate, WorkGroupMachineDR, EpisodeNo) i \u0026#39;$l(mi) q epis i \u0026#39;$l(epis) q epis s WorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i \u0026#39;$l(WorkGroupMachineDR) q epis s VisitNumberReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexAcceptDate\u0026#34;,WorkGroupMachineDR,DATA,\u0026#34; \u0026#34;_epis,\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberReportDR) q epis s LSH=$lg($g(^dbo.RPVisitNumberReportD(VisitNumberReportDR)),8) i \u0026#39;$l(LSH) q epis B ;LSH Q LSH //// w $$GetName^MI.MIFBECKImage(70,3003497773) //// 取病人姓名按拼音输出,\u0026#34;^\u0026#34;分隔 GetName(MachID,epis) s epis = $g(epis),MachID=$g(MachID) s SurName=\u0026#34;\u0026#34; i $l(epis)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s SurName=$lg(RPVisitNumberData,13) i SurName\u0026#39;=\u0026#34;\u0026#34; s SurName=$$GetCNCODE(SurName,3,\u0026#34;^\u0026#34;) q SurName /// Description:返回汉字的编码信息 /// Input：\tHANZI:汉字 /// FLAG:返回何种编码(1:ASC码,2:汉字,3:拼音,4:首拼,5:四角码6:五笔码7:区位码8:笔划数9:郑码) /// SPLIT:分割符(可以为空) /// Output： /// 非0:返回编码信息:ASC码^汉字^拼音^首拼^四角码^五笔码^区位码^笔划数^郑码 /// 0：未找到编码信息 /// CreatDate:2011-06-08 /// w ##class(web.DHCINSUPort).GetCNCODE(\u0026#34;东华\u0026#34;,4,\u0026#34;^\u0026#34;) /// w ##class(web.DHCINSUPort).GetCNCODE(\u0026#34;东华\u0026#34;,4,\u0026#34;\u0026#34;) GetCNCODE(HANZIS,FLAG, SPLIT) s Rtnstr=\u0026#34;0\u0026#34; q:$g(HANZIS)=\u0026#34;\u0026#34; Rtnstr s Rtnstr=\u0026#34;\u0026#34; f i=1:1:$l(HANZIS) d .s HANZI=$EXTRACT(HANZIS,i) .s ASCIICODE=$ASCII(HANZI) .i $D(^DHCCharacterEncoding(\u0026#34;0\u0026#34;,\u0026#34;ASCII\u0026#34;,ASCIICODE))\u0026#39;=0 d ..s rowid=$o(^DHCCharacterEncoding(\u0026#34;0\u0026#34;,\u0026#34;ASCII\u0026#34;,ASCIICODE,\u0026#34;\u0026#34;)) ..s tmpstr=\u0026#34;\u0026#34; ..s:FLAG=\u0026#34;\u0026#34; tmpstr=$g(^DHCCharacterEncoding(rowid)) ..s:FLAG\u0026#39;=\u0026#34;\u0026#34; tmpstr=$p(^DHCCharacterEncoding(rowid),\u0026#34;^\u0026#34;,FLAG) ..i Rtnstr=\u0026#34;\u0026#34; d ...s Rtnstr=tmpstr ..e d ...s Rtnstr=Rtnstr_SPLIT_tmpstr .e d ..s:Rtnstr=\u0026#34;\u0026#34; Rtnstr=\u0026#34;?\u0026#34; ..s Rtnstr=Rtnstr_SPLIT_\u0026#34;?\u0026#34; q Rtnstr 通过文件请求双向 上机生成请求文件请求 示例代码(爱康 Aigel400) 仪器上机扫条码后生成请求文件，通过监听读取文件，解析数据后回传文件，此处需特殊解析设置。将仪器配置为主动上传模式，解析数据时，将主动上传信息从 C 变为 X，QryLabInfo 循环读取为 X 的标本，从而实现文件双向。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 /* 双向比较特殊，需要配置两台仪器，一台用于接收，一台用于双向上传 */ /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;D:\\\\OUTPUT\\\\\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFAigel400\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.txt\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoMAll,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;\u0026#34;},{\u0026#34;MachID\u0026#34;:\u0026#34;41\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;D:\\\\Aigel400\\\\Data\\\\\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFAigel400\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;regexImport.dat\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoMAll,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;D:\\\\Aigel400\\\\Data\\\\\u0026#34;}] Class MI.MIFAigel400 Extends %RegisteredObject { /// H|\\^\u0026amp;|||Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|||||||P|4|20230503095046[13][10]P|1|12|[13][10]O|1|12^^^^^^|69449292212011757621|^^^ABO/RhD血型定型试剂卡|R|20230503094655||||||||||||||||||Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|C|[13][10]R|1|^^^ABO/RhD血型定型试剂卡|-A=-^-B=4+^-D=3+^control=-^Ac=3+^Bc=-^B/Rh+|||N||F||A1|20230503091546|20230503094655|Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|[13][10]L|1|N[13][10] /// H|\\^\u0026amp;|||Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|||||||P|4|20230602161519[13][10]P|1|102|[13][10]O|1|102^^^^^^|69449292211011587452|^^^抗人球蛋白检测卡(抗筛)|R|20230602094910||||||||||||||||||Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|F|[13][10]R|1|^^^抗人球蛋白检测卡(抗筛)|IgG=-^C3d=-^Ctl=-^-|||N||F||A1|20230602091802|20230602094910|Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|[13][10]L|1|N[13][10] /// d ##class(MI.MIFAigel300).fileMTHD(28,\u0026#34;H|\\^\u0026amp;|||Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|||||||P|4|20230503095046[13][10]P|1|12|[13][10]O|1|12^^^^^^|69449292212011757621|^^^ABO/RhD血型定型试剂卡|R|20230503094655||||||||||||||||||Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|C|[13][10]R|1|^^^ABO/RhD血型定型试剂卡|-A=-^-B=4+^-D=3+^control=-^Ac=3+^Bc=-^B/Rh+|||N||F||A1|20230503091546|20230503094655|Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|[13][10]L|1|N[13][10]\u0026#34;) ClassMethod fileMTHD(mi, record, epis, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q s (sample,epis,result,date,time,QC)=\u0026#34;\u0026#34; i \u0026#39;$l(record) q \u0026#34;\u0026#34; d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) i P3\u0026#39;[\u0026#34;Import\u0026#34; d Result e d Upload q \u0026#34;\u0026#34; Upload s AllEpis=\u0026#34;\u0026#34; f i=1:1:$l(record,\u0026#34;[13][10]\u0026#34;) d .s rec=$p(record,\u0026#34;[13][10]\u0026#34;,i) .s rtype=$e(rec,1) .i rtype=\u0026#34;H\u0026#34; d ..s ASTMH=rec ..d Trace^MI.MIF000(mi,ASTMH,\u0026#34;ASTMH\u0026#34;) ..s ^LISAigel400(\u0026#34;DATA\u0026#34;)=ASTMH .i rtype=\u0026#34;Q\u0026#34; d ..s epis=$p(rec,\u0026#34;|\u0026#34;,3) ..i \u0026#39;$l(AllEpis) s AllEpis=epis ..e s AllEpis=AllEpis_\u0026#34;^\u0026#34;_epis i $l(AllEpis) d .s ^LISAigel400(\u0026#34;Epis\u0026#34;,1)=AllEpis d Trace^MI.MIF000(mi,AllEpis,\u0026#34;AllEpis\u0026#34;) s ^LISAigel400(\u0026#34;OutFlag\u0026#34;)=1 ;d ##Class(MI.MachineUpload).SetSendFlag(mi,\u0026#34;9000000256\u0026#34;,\u0026#34;X\u0026#34;,\u0026#34;\u0026#34;) q \u0026#34;\u0026#34; Result f i=1:1:$l(record,\u0026#34;[13][10]\u0026#34;) d .s rec=$p(record,\u0026#34;[13][10]\u0026#34;,i) .s rtype=$e(rec,1) .i rtype=\u0026#34;O\u0026#34; d ..s epis=$P($P(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,1) .i rtype=\u0026#34;R\u0026#34; d ..s TestSet=$p($P(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4) ..i TestSet[\u0026#34;ABO\u0026#34; d ...s allres=$p($P(rec,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,9) ...s code1=\u0026#34;ABO\u0026#34; s res1=$P(allres,\u0026#34;/\u0026#34;,1)_\u0026#34;型\u0026#34; ...s code2=\u0026#34;Rh\u0026#34; s res2=$p(allres,\u0026#34;/\u0026#34;,2) ...i res2[\u0026#34;+\u0026#34; s res2=\u0026#34;阳性\u0026#34; ...i res2[\u0026#34;-\u0026#34; s res2=\u0026#34;阴性\u0026#34; ...s result=code1_\u0026#34;\\\u0026#34;_res1_\u0026#34;,\u0026#34;_code2_\u0026#34;\\\u0026#34;_res2_\u0026#34;,\u0026#34; ..i TestSet[\u0026#34;交叉配血\u0026#34; d ...s code1=\u0026#34;JCPX\u0026#34; s res1=$p($P(rec,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,3) ...i res1=\u0026#34;+\u0026#34; s res1=\u0026#34;阳性\u0026#34; ...i res1=\u0026#34;-\u0026#34; s res1=\u0026#34;阴性\u0026#34; ...s result=code1_\u0026#34;\\\u0026#34;_res1_\u0026#34;,\u0026#34; ..i TestSet[\u0026#34;不规则抗体筛查\u0026#34; d ...s code1=\u0026#34;KRQDB\u0026#34; s res1=$p($P(rec,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,3) ...i res1[\u0026#34;=\u0026#34; d ....s res1=$p(res1,\u0026#34;=\u0026#34;,2) ...i res1=\u0026#34;+\u0026#34; s res1=\u0026#34;阳性\u0026#34; ...i res1=\u0026#34;-\u0026#34; s res1=\u0026#34;阴性\u0026#34; ...s result=code1_\u0026#34;\\\u0026#34;_res1_\u0026#34;,\u0026#34; d Trace^MI.MIF000(mi,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;AllResult\u0026lt;--M\u0026#34;) i $l(epis),$l(result) d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) q \u0026#34;\u0026#34; } ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, FullName, SaveImageRetName, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //通过OtherPara配置取图的在这里通过epis和ImageClass的图片名字提取出流水号和图片类别 s mi=$g(mi) s epis=$g(epis) s ImageClass=$g(ImageClass) s FileName=$g(FileName) s FullName=$g(FullName) s SaveImageRetName=$g(SaveImageRetName) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; d ##Class(MI.Common.MIFBase).Trace(mi,epis_\u0026#34;:\u0026#34;_ImageClass_\u0026#34;:\u0026#34;_FileName,\u0026#34;H\u0026lt;--M\u0026#34;) s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=\u0026#34;\u0026#34; //加上当前时间，防止浏览器缓存 s FileName=FileName_\u0026#34;?\u0026#34;_$p($h,\u0026#34;,\u0026#34;,2) //OtherPara用^分隔第四位指定SaveImageRetName的话在这里改FileName为新名称。同时让方法返回新图片名字 s NewFileName=\u0026#34;\u0026#34; i SaveImageRetName=\u0026#34;SaveImageRetName\u0026#34; d .//图片新名字 .s NewFileName=epis_\u0026#34;-\u0026#34;_ImageClass_\u0026#34;-\u0026#34; .//路径新名字 .s NewPathName=\u0026#34;\u0026#34; .s SPLen=$l(FileName,\u0026#34;/\u0026#34;) .f ii=1:1:SPLen d ..i ii\u0026lt;SPLen d ...s NewPathName=NewPathName_$p(FileName,\u0026#34;/\u0026#34;,ii)_\u0026#34;/\u0026#34; ..i ii=SPLen d ...s NewFileName=NewFileName_$p(FileName,\u0026#34;/\u0026#34;,ii) .s NewPathName=NewPathName_NewFileName .s FileName=NewPathName //最后返回NewFileName s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) //返回值控制图片名称模式 i SaveImageRetName=\u0026#34;SaveImageRetName\u0026#34; d .s ret=NewFileName q ret } // w ##class(MI.XN9000).GetFtpMTHD(\u0026#34;7\u0026#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = \u0026#34;labno,labnoInfo,patInfo\u0026#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(\u0026#34;MI.MIFAigel400\u0026#34;,\u0026#34;QryLabInfo\u0026#34;,\u0026#34;41\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; s LabnoList=\u0026#34;\u0026#34; s VisitNumberDR=\u0026#34;\u0026#34; s AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s DeleteFlag=0 i $d(^LISAigel400(\u0026#34;Epis\u0026#34;,1)) d .s DeleteFlag=1 .b ;MiUploadDR .s labno=$g(^LISAigel400(\u0026#34;Epis\u0026#34;,1)) .;s EpisNo=$$getEpis^MI.MIF000(labno,mi) .;i \u0026#39;$l(EpisNo) q .i \u0026#39;$l(labno) q .//测试类型0：文本，1：数据库 .s TestType=\u0026#34;0\u0026#34; .i TestType=\u0026#34;0\u0026#34; d ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s txtInfo=..GetLabnoInfo(mi,labno) ..;s filename=\u0026#34;L\u0026#34;_$e($zd($p($h,\u0026#34;,\u0026#34;,1),8),3,8)_\u0026#34;_\u0026#34;_labno_\u0026#34;.txt\u0026#34; ..s filename=\u0026#34;Servers.dat\u0026#34; ..s labno1=$p(labno,\u0026#34;^\u0026#34;,1) ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno1,0,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;上传信息\u0026#34;) ..d OutputRow ..//文本双向上传结束****************************************************** i DeleteFlag=1 k ^LISAigel400(\u0026#34;Epis\u0026#34;,1) Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=\u0026#34;labno,labnoInfo,patInfo\u0026#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=\u0026#34;\u0026#34; { Set AtEnd=1 Set Row=\u0026#34;\u0026#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// w ##Class(MI.MIFAigel400).GetLabnoInfo(41,\u0026#34;9000000256^9000000258\u0026#34;) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) d Trace^MI.MIF000(mi,labno,\u0026#34;labno\u0026#34;) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; s tcx=\u0026#34;\u0026#34; s ASTMH=$g(^LISAigel400(\u0026#34;DATA\u0026#34;)) s (ASTMP,ASTMO,ASTMPO)=\u0026#34;\u0026#34; for i=1:1:$l(labno,\u0026#34;^\u0026#34;) d .s labnoi=$p(labno,\u0026#34;^\u0026#34;,i) .s ASTMP=\u0026#34;P|1|\u0026#34;_labnoi_\u0026#34;|\u0026#34; .s ASTMO=$$GetASTMO(mi,labnoi) .s ASTMPO=ASTMPO_ASTMP_\u0026#34;[13]\u0026#34;_ASTMO_\u0026#34;[13]\u0026#34; s ASTML=\u0026#34;L|1|N\u0026#34; i $l(ASTMP,ASTMO) d .s tcx=ASTMH_\u0026#34;[13]\u0026#34;_ASTMPO_ASTML q tcx GetASTMO(mi,VisitNumber) s patInfo=..GetPatInfo(mi,VisitNumber) s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) //获取项目通道号 d ScanOne^MI.MIF000(mi,VisitNumber) s ASTMO=\u0026#34;\u0026#34; s str=\u0026#34;\u0026#34; s Num=0 s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,VisitNumber,chl)) q:chl=\u0026#34;\u0026#34; d .s Num=Num+1 .s str=\u0026#34;O|\u0026#34;_Num_\u0026#34;|\u0026#34;_VisitNumber_\u0026#34;^\u0026#34;_PatName_\u0026#34;^^^^|||^^^^\u0026#34;_chl .i \u0026#39;$l(ASTMO) s ASTMO=str .e s ASTMO=ASTMO_\u0026#34;[13]\u0026#34;_str q ASTMO } /// w ##Class(MI.MIFKRD).GetLabnoInfo(22,\u0026#34;9000000253\u0026#34;) ClassMethod GetLabnoInfoBak(mi, labno) As %String { s OutFlag=$g(^LISAigel400(\u0026#34;OutFlag\u0026#34;)) s tcx=\u0026#34;\u0026#34; i OutFlag=1 d .s ASTMH=$g(^LISAigel400(\u0026#34;DATA\u0026#34;)) .s ASTMP=\u0026#34;P|1|001\u0026#34; .s ASTMO1=\u0026#34;O|1|001^测试^^^^|||^^^^ABO/RhD血型抗原检测卡\u0026#34; .s ASTMO2=\u0026#34;O|2|001^测试^^^^|||^^^^ABO正反定型及Rh(D/C/E)血型检测卡\u0026#34; .s ASTMO3=\u0026#34;O|3|001^测试^^^^|||^^^^抗人球蛋白检测卡(IgG+C3d)不规则抗体筛查\u0026#34; .s ASTMO4=\u0026#34;O|1|001^测试^^^^|||^^^^O|4|001^测试^^^^|||^^^^抗人球蛋白检测卡(抗IgG+C3d)交叉配血\u0026#34; .s ASTMO5=\u0026#34;O|1|001^测试^^^^|||^^^^Rh血型抗原检测卡\u0026#34; .s ASTML=\u0026#34;L|1|N\u0026#34; .s tcx=ASTMH_\u0026#34;[13]\u0026#34;_ASTMP_\u0026#34;[13]\u0026#34;_ASTMO1_\u0026#34;[13]\u0026#34;_ASTMO2_\u0026#34;[13]\u0026#34;_ASTMO3_\u0026#34;[13]\u0026#34;_ASTMO4_\u0026#34;[13]\u0026#34;_ASTMO5_\u0026#34;[13]\u0026#34;_ASTML q tcx s mi=$g(mi),labno=$g(labno) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=\u0026#34;\u0026#34; s str=\u0026#34;\u0026#34; s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) q:chl=\u0026#34;\u0026#34; d .s str=str_chl_\u0026#34;[9]\u0026#34; s tcx=labno_\u0026#34;[9]\u0026#34;_str q tcx } /// w ##Class(MI.MIFLISMonitorTest).GetPatInfo(6,1001367) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) s Sampleno=labno //检测号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; ;病区 s RetString=\u0026#34;\u0026#34; s RetString=Sampleda_\u0026#34;,\u0026#34;_Instrument_\u0026#34;,\u0026#34;_Sampleno_\u0026#34;,\u0026#34;_Sampletype_\u0026#34;,\u0026#34;_Feetype_\u0026#34;,\u0026#34;_Srcdepno_\u0026#34;,\u0026#34;_Srcdocno_\u0026#34;,\u0026#34;_Userno_\u0026#34;,\u0026#34; s RetString=RetString_Patno_\u0026#34;,\u0026#34;_Patna_\u0026#34;,\u0026#34;_Sex_\u0026#34;,\u0026#34;_Pattype_\u0026#34;,\u0026#34;_Bedno_\u0026#34;,\u0026#34;_Patage_\u0026#34;,\u0026#34;_Ageunit_\u0026#34;,\u0026#34;_Reqno_\u0026#34;,\u0026#34;_Reqda_\u0026#34;,\u0026#34; s RetString=RetString_Reportda_\u0026#34;,\u0026#34;_Printflag_\u0026#34;,\u0026#34;_Resultflag_\u0026#34;,\u0026#34;_Errflag_\u0026#34;,\u0026#34;_Diagnose_\u0026#34;,\u0026#34;_Description_\u0026#34;,\u0026#34;_Reserve_\u0026#34;,\u0026#34; s RetString=RetString_Patnamn_\u0026#34;,\u0026#34;_Getda_\u0026#34;,\u0026#34;_Wardno_\u0026#34;,\u0026#34;_BarCode q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,\u0026#34;S\u0026#34;,filename) q } } 私有协议接口双向 类 ASTM 双向回复 ACK 示例接口(万泰 Wan200) W1N1111222222222222222200334S555555556666abcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghij 2 1141123\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 MIFCARIS200BI(mi) s mi=$g(mi) S ^TMPMACH10(mi,104)=$H i \u0026#39;$l(mi) q s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),17) //端口号 //控制字符 SET $ZTRAP=\u0026#34;ErrHandler\u0026#34; S iERR=0 s stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4) s lf=$c(10),cr=$c(13),nak=$c(21),(result,epis)=\u0026#34;\u0026#34;,etb=$c(23) S ^TMPMACH10(mi,102)=$H i $$Start^MI.MIF000(mi) q f d Main i $$Stop^MI.MIF000(mi) q c Port q ErrHandler h 10 d Trace^MI.MIF000(mi,$TR($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) s iERR=+$g(iERR)+1 i iERR\u0026gt;30 s ret=$$Stop^MI.MIF000(mi) Q Main r *R:10 e d q .d BUILD i $c(R)=enq d .s record1=\u0026#34;\u0026#34; .d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) .d ACK .f r *R:10 q:$c(R)=eot d ..i $c(R)\u0026#39;=stx q ..s record=$$Read^MI.MIF000(mi,\u0026#34;\u0026#34;,etx) q:\u0026#39;$l(record) ..d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) ..d ACK ..s (sample,epis,surname,result,date,time,QC)=\u0026#34;\u0026#34; ..//\u0026#34;D1N15 15 xx500015S 1 1 3975631111.05 12016121020170223165831\u0026#34;_$C(3) ..s Type=$e(record,1) ..//请求 ..i Type=\u0026#34;R\u0026#34; d q ...s epis=$tr($e(record,4,19),\u0026#34; \u0026#34;) ...i $l(epis) s ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,epis)=record ..//结果 D1N7008□□11□□□□□□□□□□□□□□□800383S□□□□□□□□1□□□T□□□□□ ..// D1N7001□□□1□□□□□□900023407700382S□□□□□□□□1□□□N□□□□□□□□□□□□□ ..i Type=\u0026#34;D\u0026#34; d q ...s ResultType=$e(record,3) ...i ResultType=\u0026#34;C\u0026#34; d ....s epis=$tr($e(record,8,16),\u0026#34; \u0026#34;) ...e d ....s epis=$tr($e(record,17,27),\u0026#34; \u0026#34;) ...s code=$tr($e(record,126,128),\u0026#34; \u0026#34;) ...i code=28 s code=$tr($e(record,45,46),\u0026#34; \u0026#34;)_code ...s res=$tr($e(record,137,142),\u0026#34; \u0026#34;) ...;try{s res1=##class(MI.Special.JudgeResult).IsYang(mi,epis,code,res)}catch{s res1=\u0026#34;\u0026#34;} ...s PoliceInfo=$e(record,157,172) ...try{s ret=$$GetPolice(PoliceInfo)}catch{} ...s resFuHao=\u0026#34;\u0026#34; ...i $d(^LISCaris200(\u0026#34;Data\u0026#34;,43)) s resFuHao=\u0026#34;\u0026lt;\u0026#34; ...i $d(^LISCaris200(\u0026#34;Data\u0026#34;,42)) s resFuHao=\u0026#34;\u0026gt;\u0026#34; ...k ^LISCaris200(\u0026#34;Data\u0026#34;) ...i $l(resFuHao) s res=resFuHao_res ...i $l(code),$l(res) s result=result_code_$c(92)_res_$c(92)_res1_$c(44) ...d Trace^MI.MIF000(mi,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;Result\u0026#34;) ...i $l(epis),$l(result) d Save^MI.MIF000(mi,epis,result,date,time,QC) .d Trace^MI.MIF000(mi,$s($c(R)=eot:\u0026#34;EOT\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) .d BUILD q GetPolice(PoliceInfo) s str=$$scale(PoliceInfo,\u0026#34;16\u0026#34;,\u0026#34;2\u0026#34;) k ^LISCaris200(\u0026#34;Data\u0026#34;) s strLong=$l(str) f i=1:1:strLong d .s stri=$e(str,i) .i stri=1 d ..s ^LISCaris200(\u0026#34;Data\u0026#34;,strLong+1-i)=1 q \u0026#34;\u0026#34; /// 进制转换，将snum从scale1进制转换为scale2进制 scale(snum, scale1, scale2) // 转十进制 s snum=$g(snum) s tnum=0 s numlong=$l(snum) f i=1:1:$L(snum) d .s numi=$e(snum,i) .s numi=$$Sixteen2Ten(numi) .s tnum=tnum+(numi*(scale1**(numlong-i))) // 转scale2进制 s tnum=$g(tnum) s num=\u0026#34;\u0026#34; s GoTo=1 while (GoTo=1){ s pnum1=tnum s tnum=$p(tnum/scale2,\u0026#34;.\u0026#34;,1) s pnum2=pnum1#scale2 s pnum2=$$Ten2Sixteen(pnum2) i tnum\u0026lt;scale2 d .s num=tnum_pnum2_num .s GoTo=0 e s num=pnum2_num if (tnum=0)||\u0026#39;$l(tnum) s GoTo=0 } q num Ten2Sixteen(pnum2) i pnum2=10 s pnum2=\u0026#34;A\u0026#34; i pnum2=11 s pnum2=\u0026#34;B\u0026#34; i pnum2=12 s pnum2=\u0026#34;C\u0026#34; i pnum2=13 s pnum2=\u0026#34;D\u0026#34; i pnum2=14 s pnum2=\u0026#34;E\u0026#34; i pnum2=15 s pnum2=\u0026#34;F\u0026#34; q pnum2 Sixteen2Ten(numi) i (numi=\u0026#34;A\u0026#34;)||(numi=\u0026#34;a\u0026#34;) s numi=10 i (numi=\u0026#34;B\u0026#34;)||(numi=\u0026#34;b\u0026#34;) s numi=11 i (numi=\u0026#34;C\u0026#34;)||(numi=\u0026#34;c\u0026#34;) s numi=12 i (numi=\u0026#34;D\u0026#34;)||(numi=\u0026#34;d\u0026#34;) s numi=13 i (numi=\u0026#34;E\u0026#34;)||(numi=\u0026#34;e\u0026#34;) s numi=14 i (numi=\u0026#34;F\u0026#34;)||(numi=\u0026#34;f\u0026#34;) s numi=15 q numi //W1N11112222222222222222aa\u0026#34; BUILD i \u0026#39;$d(^TMP($zn)) q i \u0026#39;$d(^TMP($zn,$j)) q s labno=\u0026#34;\u0026#34; f s labno=$o(^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,labno)) q:labno=\u0026#34;\u0026#34; d .d ScanOne^MI.MIF000(mi,labno) .s tcx=\u0026#34;\u0026#34;,tcNum=0 .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) q:chl=\u0026#34;\u0026#34; d ..s AutoDil=1 ///自动稀释倍数 ..i $l(chl)=1 s tcx=tcx_\u0026#34; \u0026#34;_chl_AutoDil ..i $l(chl)=2 s tcx=tcx_\u0026#34; \u0026#34;_chl_AutoDil ..i $l(chl)=3 s tcx=tcx_chl_AutoDil ..s tcNum=tcNum+1 .//组串 .s tStr=$g(^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,labno)) .s TNUM=$e($p($h,\u0026#34;,\u0026#34;,2),2,5) . .//\u0026#34;W1N1111222222222222222200334S555555556666abcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghij 2 1141123\u0026#34; .s str=\u0026#34;W1N\u0026#34;_TNUM_$e(tStr,4,19)_\u0026#34; S 1 \u0026#34; .s Commend=\u0026#34; \u0026#34; .//i $l(tcNum)=1 s str=str_Commend_\u0026#34; \u0026#34;_tcNum .//i $l(tcNum)=2 s str=str_Commend_tcNum .s str=str_Commend_\u0026#34; \u0026#34;_tcNum_tcx .d Send(str) k ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;) q Send(str) ; send list of orders if exists w enq,*-3 d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q d Trace^MI.MIF000(mi,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) i $c(R)=enq q i $c(R)\u0026#39;=ack w eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q q:$$SEND(str) w eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q SEND(str) ; send string to instrument s str=str,chsum=$$CHSUM(str_etx) w stx,str,etx,chsum,*-3 d Trace^MI.MIF000(mi,str_chsum,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:6 r *R:1 i ($c(R)=ack)!($c(R)=eot) q i $c(R)=ack d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 i $c(R)=eot d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 d Trace^MI.MIF000(mi,R,\u0026#34;H\u0026lt;--M\u0026#34;) q 1 CHSUM(x) ; calculate check sum n (x) s z=0 f y=1:1:$l(x) s z=z+$a(x,y) s z=$zh(z) //转16进制 i $l(z)=3 s z=\u0026#34;0\u0026#34;_z q z aa(val) s ret = \u0026#34;\u0026#34; f j=1:1:$l(val) d .s ascii = $a($e(val,j)) .if ascii\u0026lt;16 set ret = ret_\u0026#34;0\u0026#34;_$zh(ascii) .else set ret = ret_$zh(ascii) q ret ACK ; send \u0026#39;ack\u0026#39; to instrument w ack,*-3 d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q NEXTTRAY(tray) q tray 安图协议 示例接口(安图 2000) {10,0,[S]41,1,0,[S]0,[S]BL07,3,[S]100,1,[S]112,1,[S]113,1}\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 MIFAUTOLUMOA2000(mi) ///仪器名称:\t全自动化学发光测定仪 ///仪器型号:\tA2000 ///仪器厂商:\tAutoLumo ///通信协议:\t自定义V0.07 ///交互方式:\t双向 ///接 口:\tRS232 ///编 写 者:\twwh ///编写日期:\t2015-11-05 ///备 注:\t仪器配置:系统设置--\u0026gt;LIS通信设置 ///\t仪器也可读取文件,文件路径log/LisData/,文件内容与通信协议中一致 ///接口版本:\tV0.0.1 ///更新日志: ///-1.更新日期: ///---更 新 者: ///---更新备注: s mi=$g(mi) i \u0026#39;$l(mi) q s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 //控制字符 S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23) S sb=$C(11),eb=$C(28),cr=$C(13) S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=\u0026#34;\u0026#34;,kk=1 s ^TMPMACHDATA1(mi,10)=mi S leftBrace=\u0026#34;{\u0026#34;,rightBrace=\u0026#34;}\u0026#34; i $$Start^MI.MIF000(mi) q f d Main i $$Stop^MI.MIF000(mi) q s ^TMPMACH10(mi,50)=$h c Port q /* S mi=$G(mi) Q:\u0026#39;$L(mi) Q:$$select^LVBMIMP(mi) F j=1:1:PLIST { S @(\u0026#34;par\u0026#34;_j)=PLIST(j) } S mi1=$P($G(par36),\u0026#34;,\u0026#34;,1) S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23) S sb=$C(11),eb=$C(28),cr=$C(13) S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=\u0026#34;\u0026#34;,kk=1 S $ZT=\u0026#34;ErrHandler\u0026#34;,$EC=\u0026#34;\u0026#34; S leftBrace=\u0026#34;{\u0026#34;,rightBrace=\u0026#34;}\u0026#34; S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType)=\u0026#34;\u0026#34; Q:$$start^MIF000() F { D Main Q:$$stop^MIF000() } C par4 Q */ Main S $ZT=\u0026#34;ErrHandler\u0026#34;,$EC=\u0026#34;\u0026#34; S record=$$Read^MI.MIF000(mi,leftBrace,rightBrace) Q:\u0026#39;$l(record) d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) S (epis,result,date,time,QC,data)=\u0026#34;\u0026#34; S cmd=$P(record,\u0026#34;,\u0026#34;,1) I cmd=\u0026#34;1\u0026#34; {\t//获取指定样本编号和指定病历号的样本详细测试请求数据 S instrumentId=$P(record,\u0026#34;,\u0026#34;,2)\t//系统标识 S:instrumentId[\u0026#34;[S]\u0026#34; instrumentId=$P(instrumentId,\u0026#34;[S]\u0026#34;,2) S sampleId=$P(record,\u0026#34;,\u0026#34;,3)\t//测试请求ID S epis=sampleId S:epis[\u0026#34;[S]\u0026#34; epis=$P(epis,\u0026#34;[S]\u0026#34;,2) K PLIST S error=$$BuildItems(mi,epis) I $L(error) { S ack=\u0026#34;{2,1,\u0026#34;_sampleId_\u0026#34;}\u0026#34; D ACK(mi,ack) ;D trace^MIF000(mi,error,\u0026#34;Error\u0026#34;) Q } S tc=\u0026#34;\u0026#34;,items=\u0026#34;\u0026#34; F { S tc=$O(PLIST(tc)) Q:\u0026#39;$L(tc) S itemDiluFactor=$G(PLIST(tc)) S:\u0026#39;$L(itemDiluFactor) itemDiluFactor=1\t//稀释倍数,机器内部稀释,必须在该测试项目的支持范围内 S items=items_\u0026#34;[S]\u0026#34;_tc_\u0026#34;,\u0026#34;_itemDiluFactor_\u0026#34;,\u0026#34; } S itemCount=+$G(PLIST) S items=$E(items,1,$L(items)-1) S dilutionFactor=1\t//稀释倍数 S isEmergency=0\t//是否急诊:0=普通,1=急诊 S medicareId=\u0026#34;[S]\u0026#34;\t//病案号 S secondName=\u0026#34;[S]\u0026#34;\t//姓 S firstName=\u0026#34;[S]\u0026#34;\t//名 S sex=\u0026#34;\u0026#34;\t//性别 0:女 1:男 S age=\u0026#34;\u0026#34;\t//年龄:整数 S location=\u0026#34;[S]\u0026#34;\t//科室 S ward=\u0026#34;[S]\u0026#34;\t//病区 S bed=\u0026#34;[S]\u0026#34;\t//床号 S reqDoctor=\u0026#34;[S]\u0026#34;\t//送检医生 S reqDate=\u0026#34;\u0026#34;\t//送检日期(格式:YYYY/MM/DD) S receiveUser=\u0026#34;[S]\u0026#34;\t//检验人员 S remark=\u0026#34;[S]\u0026#34;\t//备注 S ack=\u0026#34;{2,0,\u0026#34;_sampleId_\u0026#34;,\u0026#34;_dilutionFactor_\u0026#34;,\u0026#34;_isEmergency_\u0026#34;,\u0026#34;_medicareId_\u0026#34;,\u0026#34; S ack=ack_secondName_\u0026#34;,\u0026#34;_firstName_\u0026#34;,\u0026#34;_sex_\u0026#34;,\u0026#34;_age_\u0026#34;,\u0026#34;_location_\u0026#34;,\u0026#34;_ward_\u0026#34;,\u0026#34; S ack=ack_bed_\u0026#34;,\u0026#34;_reqDoctor_\u0026#34;,\u0026#34;_reqDate_\u0026#34;,\u0026#34;_receiveUser_\u0026#34;,\u0026#34;_remark_\u0026#34;,\u0026#34; S ack=ack_itemCount_\u0026#34;,\u0026#34;_items_\u0026#34;}\u0026#34; D ACK(mi,ack) Q } I cmd=\u0026#34;3\u0026#34; {\t//获取分配给指定仪器所有患者测试样本的个数 S instrumentId=$P(record,\u0026#34;,\u0026#34;,2)\t//系统标识 S:instrumentId[\u0026#34;[S]\u0026#34; instrumentId=$P(instrumentId,\u0026#34;[S]\u0026#34;,2) S sampleTotal=\u0026#34;0\u0026#34; S ack=\u0026#34;{4,1}\u0026#34;\t//暂时不处理 D ACK(mi,ack) Q } I cmd=\u0026#34;5\u0026#34; {\t//按测试模式发送结果到LIS //{5,[S]A2000,[S]41,[S]132,47925,970200L,183.145F} S instrumentId=$P(record,\u0026#34;,\u0026#34;,2)\t//系统标识 S:instrumentId[\u0026#34;[S]\u0026#34; instrumentId=$P(instrumentId,\u0026#34;[S]\u0026#34;,2) S sampleId=$P(record,\u0026#34;,\u0026#34;,5)\t//测试请求ID S sampleNo=$P(record,\u0026#34;,\u0026#34;,3)\t//测试样本编号 S itemId=$P(record,\u0026#34;,\u0026#34;,4)\t//测试项目编号 S medicareId=\u0026#34;[S]\u0026#34;\t//病案号 //{6,0,47925,[S]41,[S],[S]132} S ack=\u0026#34;{6,0,\u0026#34;_sampleId_\u0026#34;,\u0026#34;_sampleNo_\u0026#34;,\u0026#34;_medicareId_\u0026#34;,\u0026#34;_itemId_\u0026#34;}\u0026#34; D ACK(mi,ack) S epis=sampleNo //sampleId S:epis[\u0026#34;[S]\u0026#34; epis=$P(epis,\u0026#34;[S]\u0026#34;,2) // 2017-09-13 WxC 质控标示特殊处理 ;I \u0026#34;H1,L1,P1,C1\u0026#34;[epis S epis=\u0026#34;liver1\u0026#34; ;I \u0026#34;H2,L2,P2,C2\u0026#34;[epis S epis=\u0026#34;liver2\u0026#34; ;I \u0026#34;M1,G1\u0026#34;[epis S epis=\u0026#34;HEV1\u0026#34; ;I \u0026#34;M2,G2\u0026#34;[epis S epis=\u0026#34;HEV2\u0026#34; // S channel=itemId S:channel[\u0026#34;[S]\u0026#34; channel=$P(channel,\u0026#34;[S]\u0026#34;,2) S valueL=$P(record,\u0026#34;,\u0026#34;,6)\t//RLU((检测结果相对发光值) S valueL=$P(valueL,\u0026#34;L\u0026#34;,1) S valueF=$P(record,\u0026#34;,\u0026#34;,7)\t//浓度值或S/CO值 S valueF=$P(valueF,\u0026#34;F\u0026#34;,1) S:valueF[\u0026#34;[S]\u0026#34; valueF=$tr(valueF,\u0026#34;[S]\u0026#34;,\u0026#34;\u0026#34;) Q:\u0026#39;$L(channel) S result=\u0026#34;\u0026#34; //S result=result_channel_\u0026#34;-L\u0026#34;_$C(par10)_valueL_$C(par11) //S result=result_channel_\u0026#34;-F\u0026#34;_$C(par10)_valueF_$C(par11) S result=result_channel_ResultDeli_valueF_ItemDeli D Save Q } I cmd=\u0026#34;7\u0026#34; {\t//按样本模式发送结果到LIS //{7,[S]A2000,101,[S]41,3,[S]132,970200L,183.145F,[S]112,673200L,13.15F,[S]113,1378200L,13.5F S instrumentId=$P(record,\u0026#34;,\u0026#34;,2)\t//系统标识 S:instrumentId[\u0026#34;[S]\u0026#34; instrumentId=$P(instrumentId,\u0026#34;[S]\u0026#34;,2) S sampleId=$P(record,\u0026#34;,\u0026#34;,3)\t//样本ID S sampleNo=$P(record,\u0026#34;,\u0026#34;,4)\t//测试样本编号 S itemCount=+$P(record,\u0026#34;,\u0026#34;,5)\t//测试样本包含的测试个数 S items=$P(record,\u0026#34;,\u0026#34;,6,$L(record,\u0026#34;,\u0026#34;)) S medicareId=\u0026#34;[S]\u0026#34;\t//病案号 //{8,0,101,[S]41,[S] S ack=\u0026#34;{8,0,\u0026#34;_sampleId_\u0026#34;,\u0026#34;_sampleNo_\u0026#34;,\u0026#34;_medicareId_\u0026#34;}\u0026#34; D ACK(mi,ack) S epis=sampleId S:epis[\u0026#34;[S]\u0026#34; epis=$P(epis,\u0026#34;[S]\u0026#34;,2) // 2017-09-13 WxC 质控标示特殊处理 I \u0026#34;H1,L1,P1,C1\u0026#34;[epis S epis=\u0026#34;liver1\u0026#34; I \u0026#34;H2,L2,P2,C2\u0026#34;[epis S epis=\u0026#34;liver2\u0026#34; I \u0026#34;M1,G1\u0026#34;[epis S epis=\u0026#34;HEV1\u0026#34; I \u0026#34;M2,G2\u0026#34;[epis S epis=\u0026#34;HEV2\u0026#34; // S result=\u0026#34;\u0026#34; F itemIndex=1:3:$L(items,\u0026#34;,\u0026#34;) { S itemId=$P(items,\u0026#34;,\u0026#34;,itemIndex)\t//测试项目编号 S channel=itemId S:channel[\u0026#34;[S]\u0026#34; channel=$P(channel,\u0026#34;[S]\u0026#34;,2) Continue:\u0026#39;$L(channel) S valueL=$P(items,\u0026#34;,\u0026#34;,itemIndex+1)\t//RLU((检测结果相对发光值) S valueL=$P(valueL,\u0026#34;L\u0026#34;,1) S valueF=$P(items,\u0026#34;,\u0026#34;,itemIndex+2)\t//浓度值或S/CO值 S valueF=$P(valueF,\u0026#34;F\u0026#34;,1) S:valueF[\u0026#34;[S]\u0026#34; valueF=$tr(valueF,\u0026#34;[S]\u0026#34;,\u0026#34;\u0026#34;) //S result=result_channel_\u0026#34;-L\u0026#34;_$C(par10)_valueL_$C(par11) //S result=result_channel_\u0026#34;-F\u0026#34;_$C(par10)_valueF_$C(par11) S result=result_channel_ResultDeli_valueF_ItemDeli } D Save Q } I cmd=\u0026#34;9\u0026#34; {\t//双向 //{9,[S]A2000,[S]41} S instrumentId=$P(record,\u0026#34;,\u0026#34;,2)\t//系统标识 S:instrumentId[\u0026#34;[S]\u0026#34; instrumentId=$P(instrumentId,\u0026#34;[S]\u0026#34;,2) S sampleId=$P(record,\u0026#34;,\u0026#34;,3)\t//样本ID S epis=sampleId S:epis[\u0026#34;[S]\u0026#34; epis=$P(epis,\u0026#34;[S]\u0026#34;,2) ///2016-04-13 WXC 扫条码转换仪器 ///D SetTSMachine^MIF000(mi,epis) ;s Err=##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(mi,epis,\u0026#34;\u0026#34;) ;d Trace^MI.MIF000(mi,Err,\u0026#34;核收到仪器返回\u0026#34;) s Err=\u0026#34;\u0026#34; s RetLL=$$SaveLastMachine^MI.MIF000(mi,epis) d Trace^MI.MIF000(mi,RetLL,\u0026#34;保存最后仪器\u0026#34;) K PLIST S error=$$BuildItems(mi,epis) I $L(error) { S ack=\u0026#34;{10,1,\u0026#34;_sampleId_\u0026#34;}\u0026#34; D ACK(mi,ack) d Trace^MI.MIF000(mi,error,\u0026#34;Error\u0026#34;) Q } S tc=\u0026#34;\u0026#34;,items=\u0026#34;\u0026#34; F { S tc=$O(PLIST(tc)) Q:\u0026#39;$L(tc) S itemDiluFactor=$G(PLIST(tc)) S:\u0026#39;$L(itemDiluFactor) itemDiluFactor=1\t//稀释倍数,机器内部稀释,必须在该测试项目的支持范围内 S items=items_\u0026#34;[S]\u0026#34;_tc_\u0026#34;,\u0026#34;_itemDiluFactor_\u0026#34;,\u0026#34; } S items=$E(items,1,$L(items)-1) S dilutionFactor=1\t//稀释因子 S isEmergency=0\t//是否急诊:0=普通,1=急诊 S specimen=\u0026#34;[S]\u0026#34;_$$GetSpecimen(epis)\t//样本类型:字符串,如果仪器不能识别则默认为血清 S itemCount=+$G(PLIST) //{10,0,[S]41,1,0,[S],3,[S]132,1,[S]112,1,[S]113,1} S ack=\u0026#34;{10,0,[S]\u0026#34;_sampleId_\u0026#34;,\u0026#34;_dilutionFactor_\u0026#34;,\u0026#34;_isEmergency_\u0026#34;,\u0026#34;_specimen_\u0026#34;,\u0026#34;_itemCount_\u0026#34;,\u0026#34;_items_\u0026#34;}\u0026#34; D Trace^MI.MIF000(mi,ack,\u0026#34;ack\u0026lt;--M\u0026#34;) D ACK(mi,ack) Q } I cmd=\u0026#34;11\u0026#34; {\t//连接LIS系统开始通信 S instrumentId=$P(record,\u0026#34;,\u0026#34;,2)\t//系统标识 S:instrumentId[\u0026#34;[S]\u0026#34; instrumentId=$P(instrumentId,\u0026#34;[S]\u0026#34;,2) S lisCommVersion=$P(record,\u0026#34;,\u0026#34;,3)\t//LIS通信模块版本号 S lisVersion=\u0026#34;[S]V0.0.1\u0026#34;\t//LIS系统版本号 S ack=\u0026#34;{12,0,\u0026#34;_lisVersion_\u0026#34;}\u0026#34; D ACK(mi,ack) Q } I cmd=\u0026#34;15\u0026#34; {\t//快速获取指定样本架编号测试请求数据 S instrumentId=$P(record,\u0026#34;,\u0026#34;,2)\t//系统标识 S:instrumentId[\u0026#34;[S]\u0026#34; instrumentId=$P(instrumentId,\u0026#34;[S]\u0026#34;,2) S rackId=$P(record,\u0026#34;,\u0026#34;,3)\t//样本架编号 S position=$P(record,\u0026#34;,\u0026#34;,4)\t//样本位置号 S ack=\u0026#34;{16,1,\u0026#34;_rackId_\u0026#34;,\u0026#34;_position_\u0026#34;0,[S]}\u0026#34;\t//不处理此模式 D ACK(mi,ack) Q } Q ErrHandler h 10 d Trace^MI.MIF000(mi,$TR($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) Q GetSpecimen(Labno) n (Labno) s Labno=$G(Labno) i \u0026#39;$l(Labno) q \u0026#34;\u0026#34; s SpecName=\u0026#34;\u0026#34; s SpecDR=\u0026#34;\u0026#34; \u0026amp;sql(SELECT SpecimenDR into :SpecDR FROM dbo.RP_VisitNumber WHERE VisitNumber=:Labno) i SQLCODE q \u0026#34;\u0026#34; q:SpecDR=\u0026#34;\u0026#34; \u0026#34;\u0026#34; \u0026amp;sql(select IName into :SpecName from dbo.BT_Specimen where RowID=:SpecDR) q SpecName //构建测试项目,返回错误代码 BuildItems(mi,epis) N (mi,epis,PLIST) K PLIST S mi=$G(mi),epis=$G(epis) Q:\u0026#39;$L(mi) \u0026#34;仪器代码为空\u0026#34; Q:\u0026#39;$L(epis) \u0026#34;标本号为空\u0026#34; //Q:\u0026#39;$D(^TMIF(mi)) \u0026#34;仪器代码错误\u0026#34; //Q:\u0026#39;$D(^TEPI(epis)) \u0026#34;在LIS系统未找到样本号:\u0026#34;_epis_\u0026#34;,确定样本号正确或已经在LIS系统接收\u0026#34; S error=\u0026#34;\u0026#34;,PLIST=0 K ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$J,mi,epis) d ScanOneNew^MI.MIF000(mi,epis) K PLIST S tc=\u0026#34;\u0026#34; F { S tc=$O(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$J,mi,epis,tc)) Q:\u0026#39;$L(tc) S tc=$P(tc,\u0026#34;-\u0026#34;,1) Continue:\u0026#39;$L(tc) Continue:$D(PLIST(tc)) S PLIST(tc)=\u0026#34;\u0026#34; S PLIST=$I(PLIST) } Q:+$G(PLIST)\u0026lt;1 \u0026#34;未找到样本号:\u0026#34;_epis_\u0026#34;需要上传的项目,确定样本为登记状态且所开医嘱已经正确维护到仪器\u0026#34; Q \u0026#34;\u0026#34; ACK(mi,data) N (mi,data) S mi=$G(mi),data=$G(data) Q:\u0026#39;$L(mi) \u0026#34;\u0026#34; Q:\u0026#39;$L(data) \u0026#34;\u0026#34; //Q:\u0026#39;$D(^TMIF(mi)) \u0026#34;\u0026#34; W data,*-3 d Trace^MI.MIF000(mi,data,\u0026#34;H--\u0026gt;M\u0026#34;) Q \u0026#34;\u0026#34; Save d Trace^MI.MIF000(mi,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;Result\u0026#34;) I $l(epis),$l(result) { //S QC=$$findQC^MIF000(mi,epis) d Save^MI.MIF000(mi,epis,result,date,time,QC) //file^MIF000(mi,sample,epis,surname,result,date,time,QC,mi1) } S (epis,rec,res,result,date,time,QC,resultType)=\u0026#34;\u0026#34; Q 主动上传双向 通过监听文件双向 不同路径回传患者信息和检测项目信息 示例接口(希森美康 XN1000) 通过配置监听 UPPreDealClass 字段“PreDeal.DealStandSysmexImage,PreDeal“，通过 M 进行编写上传信息，会同时上传两个文件，一个文件传患者信息，一个文件传标本项目。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 ///[{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;1000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;D:\\\\Laboman6.0\\\\2\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;D:\\\\Laboman6.0\\\\1\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;D:\\\\Laboman6.0\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFXN1000\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.CDF\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealStandSysmexImage,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;D:\\\\Laboman6.0\\\\1,D:\\\\Laboman6.0\u0026#34;,\u0026#34;IsCombineLines\u0026#34;:\u0026#34;1\u0026#34;}] /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;1000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;C:\\\\Laboman\\\\2\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;C:\\\\Laboman\\\\1\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;C:\\\\Laboman\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFXN1000\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.CDF\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealStandSysmexImage,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;C:\\\\Laboman\\\\1,C:\\\\Laboman\u0026#34;,\u0026#34;IsCombineLines\u0026#34;:\u0026#34;1\u0026#34;}] Class MI.MIFXN1000 Extends %RegisteredObject { // D ##class(MI.MIFLISMonitorTest).fileMTHD(\u0026#34;38\u0026#34;,\u0026#34;1,BASO#,1,0.02,,,,,\u0026#34;,\u0026#34;1\u0026#34;) // mi:仪器主键 // record:一个数据行合并提交用#enter#分割多行数据 // epis:流水号，前处理提取出了的画 // fileNameOrColName:读文件的是文件全名，数据库的是数据库查询的列名用~分割 // [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;D:\\\\Result\\\\2\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;D:\\\\Result\\\\1\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;D:\\\\Result\\\\\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFXEMSYS\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.cdf\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoMAll,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealImage,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;\u0026#34;}] ClassMethod fileMTHD(mi, record As %String(MAXLEN=99999999), epis, fileNameOrColName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; i \u0026#39;$l(record) q \u0026#34;\u0026#34; //多行数据 s recordbak=record //返回值 s retcode=\u0026#34;\u0026#34; //解析多行合并数据，按#enter#分隔，监听config开启与否合并提交都支持 d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) s (sample,result,date,time,QC,image,retimage,imageR,retimageR,imageres,Ipcode,IpName,conclusion)=\u0026#34;\u0026#34; f i=1:1:$l(record,\u0026#34;#enter#\u0026#34;) d .S resVal=$p(record,\u0026#34;#enter#\u0026#34;,i) .//0,2020-12-10,00:00:00,40,XS500,17944,35,[13][10] .//1,RDW-SD,1,41.60,,,,,[13][10]1,WBC,1,4.15,,,,,[13][10] .//3,,HPLT,C:\\Laboman4.0\\XS500\\gram\\20201210\\0000000040_201210153004_HPLT.gif,1[13][10] .s type=$p(resVal,\u0026#34;,\u0026#34;,1) .i type=0 s epis=$p(resVal,\u0026#34;,\u0026#34;,4) .i type=1 d ..s code=$p(resVal,\u0026#34;,\u0026#34;,2),res=$p(resVal,\u0026#34;,\u0026#34;,4) ..s result=result_code_$c(92)_res_$c(44) .i type=3 d ..s image=$p(resVal,\u0026#34;,\u0026#34;,3) ..s retimage=$p(resVal,\u0026#34;,\u0026#34;,4) ..s imageR=imageR_image_\u0026#34;,\u0026#34; ..s retimageR=retimageR_retimage_\u0026#34;,\u0026#34; .i type=4 d //记录仪器报警信息,Ipcode 信息代码,IpName 信息内容 ..s Ipcode=$p(resVal,\u0026#34;,\u0026#34;,3) ..s IpName=$p(resVal,\u0026#34;,\u0026#34;,4) ..//s conclusion=conclusion_Ipcode_\u0026#34;^\u0026#34;_IpName ..i $l(conclusion) s conclusion=conclusion_\u0026#34;，\u0026#34;_Ipcode_\u0026#34;：\u0026#34;_IpName ..e s conclusion=Ipcode_\u0026#34;：\u0026#34;_IpName .i type=9 d ..s imageR=$e(imageR,1,$l(imageR)-1) ..s retimageR=$e(retimageR,1,$l(retimageR)-1) ..d conversion ..s imageres=\u0026#34;getimage#\u0026#34;_epis_\u0026#34;#\u0026#34;_imageR_\u0026#34;#\u0026#34;_retimageR ..d Trace^MI.MIF000(mi,imageres,\u0026#34;H\u0026lt;--M\u0026#34;) ..d Trace^MI.MIF000(mi,epis_\u0026#34;:\u0026#34;_result,\u0026#34;提示\u0026#34;) ..i $l(epis),$l(conclusion) d ...s epis1=\u0026#34;\u0026#34; ...i $l(epis)\u0026lt;6 s epis1=$$ChangeEpisnew^MI.MIF000(mi,epis,\u0026#34;\u0026#34;) ...i $l(epis)\u0026gt;6 s epis1=epis ...d Trace^MI.MIF000(mi,epis1_\u0026#34;:\u0026#34;_conclusion,\u0026#34;报警信息\u0026#34;) ...i $l(epis1) d ##Class(MI.Common.MIFBase).SaveMajorConclusion(epis1, conclusion, mi) ..i $l(conclusion) s result=result_\u0026#34;BJ\u0026#34;_$c(92)_conclusion_$c(44) ..i $l(epis),$l(result) d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) q imageres conversion i imageR=\u0026#34;HPLT\u0026#34; s imageR=\u0026#34;PLT\u0026#34; i imageR=\u0026#34;HRBC\u0026#34; s imageR=\u0026#34;RBC\u0026#34; i imageR=\u0026#34;HWBC\u0026#34; s imageR=\u0026#34;DIFF\u0026#34; i imageR=\u0026#34;SBASO\u0026#34; s imageR=\u0026#34;Baso\u0026#34; q } // D ##class(MI.MIFLISMonitorTest)SaveImageMTHD(\u0026#34;7\u0026#34;,\u0026#34;9999\u0026#34;, \u0026#34;\u0026#34;,\u0026#34;175\u0026#34;) // mi:仪器 // epis：流水号，如果是监听图片模式该位置放图片名称，自己在保存前提取流水 // ImageClass:图片类别，如果是监听图片模式该位置放图片名称，自己在保存前提取图片类型 // FileName:保存在文件服务的相对路径，默认不动 // FullName:文件全路径，如果是监听图片模式该位置放图片全路径名称，满足有的图片名称无法得到流水和图片类别的情况 ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, FullName, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //通过OtherPara配置取图的在这里通过epis和ImageClass的图片名字提取出流水号和图片类别 s mi=$g(mi) s epis=$g(epis) s ImageClass=$g(ImageClass) s FileName=$g(FileName) s FullName=$g(FullName) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; d Trace^MI.MIF000(mi,epis_\u0026#34;:\u0026#34;_ImageClass_\u0026#34;:\u0026#34;_FileName,\u0026#34;H\u0026lt;--M\u0026#34;) s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=\u0026#34;\u0026#34; s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // 返回给监听当前上传文件路径名称，默认不要动 // w ##class(MI.MIFLISMonitorTest).GetFtpMTHD(\u0026#34;7\u0026#34;) // mi:仪器 ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = \u0026#34;labno,labnoInfo,patInfo\u0026#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(\u0026#34;MI.MIFXN1000\u0026#34;,\u0026#34;QryLabInfo\u0026#34;,\u0026#34;11\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; s LabnoList=\u0026#34;\u0026#34; s AddDate=\u0026#34;\u0026#34; f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,\u0026#34;C\u0026#34;,AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,\u0026#34;C\u0026#34;,AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,\u0026#34;C\u0026#34;,AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..//ref ..s labnoInfo=..GetLabnoInfo(mi,labno) ..//cdf ..s patInfo=..GetPatInfo(mi,labno) ..d OutputRow Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set Data=$lb(labno,labnoInfo,patInfo) Set ColFields=\u0026#34;labno,labnoInfo,patInfo\u0026#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=\u0026#34;\u0026#34; { Set AtEnd=1 Set Row=\u0026#34;\u0026#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// w ##Class(MI.XN9000).GetLabnoInfo(2,1709040020) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) //s ^TMPLIS(800,mi, labno)=\u0026#34;\u0026#34; i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //获取项目通道号 i $e(labno)=\u0026#34;*\u0026#34; q \u0026#34;\u0026#34; d ScanOne^MI.MIF000(mi,labno) s tcx=\u0026#34;\u0026#34; s num=1 s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) q:chl=\u0026#34;\u0026#34; d .s tcx=tcx_chl_\u0026#34;+\u0026#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno) i $l(tcx) s tcx=labno_\u0026#34;,\u0026#34;_tcx_\u0026#34;|\u0026#34; i $l(tcx) d Trace^MI.MIF000(mi,tcx,\u0026#34;工单\u0026#34;) q tcx } /// w ##Class(MI.MIFLISMonitorTest).GetPatInfo(6,1001367) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$tr($lg(RPVisitNumberData,3),\u0026#34; \u0026#34;) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$tr($lg(RPVisitNumberData,28),\u0026#34; \u0026#34;) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; //i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) s Sampleno=labno //检测号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d .s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,\u0026#34;\u0026#34;)) .s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,\u0026#34;\u0026#34;)) .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,\u0026#34;\u0026#34;)) .s EpisodeNo=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),8) .s BarCode=EpisodeNo s Patna=$tr(PatName,\u0026#34; \u0026#34;) ;病人姓名 //b ;1 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; ;病区 s RetString=\u0026#34;\u0026#34; s RetString=Sampleda_\u0026#34;,\u0026#34;_Instrument_\u0026#34;,\u0026#34;_Sampleno_\u0026#34;,\u0026#34;_Sampletype_\u0026#34;,\u0026#34;_Feetype_\u0026#34;,\u0026#34;_Srcdepno_\u0026#34;,\u0026#34;_Srcdocno_\u0026#34;,\u0026#34;_Userno_\u0026#34;,\u0026#34; s RetString=RetString_Patno_\u0026#34;,\u0026#34;_Patna_\u0026#34;,\u0026#34;_Sex_\u0026#34;,\u0026#34;_Pattype_\u0026#34;,\u0026#34;_Bedno_\u0026#34;,\u0026#34;_Patage_\u0026#34;,\u0026#34;_Ageunit_\u0026#34;,\u0026#34;_Reqno_\u0026#34;,\u0026#34;_Reqda_\u0026#34;,\u0026#34; s RetString=RetString_Reportda_\u0026#34;,\u0026#34;_Printflag_\u0026#34;,\u0026#34;_Resultflag_\u0026#34;,\u0026#34;_Errflag_\u0026#34;,\u0026#34;_Diagnose_\u0026#34;,\u0026#34;_Description_\u0026#34;,\u0026#34;_Reserve_\u0026#34;,\u0026#34; s RetString=RetString_Patnamn_\u0026#34;,\u0026#34;_Getda_\u0026#34;,\u0026#34;_Wardno_\u0026#34;,\u0026#34;_BarCode q RetString } // 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,\u0026#34;S\u0026#34;,filename) q } /// w ##Class(MI.MIFX1800IA).QueryCDF(-6,\u0026#34;2015-09-10\u0026#34;) ClassMethod QueryCDF(mi, date) As %String { s mi=$g(mi),date=$g(date) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; i $l(date) s date=$tr(date,\u0026#34;-\u0026#34;) e s date=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s retList=\u0026#34;\u0026#34; s cnt=0 s time=\u0026#34;\u0026#34; f s time=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,\u0026#34; S\u0026#34;,date,time)) q:time=\u0026#34;\u0026#34; d .s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,\u0026#34; S\u0026#34;,date,time,\u0026#34;\u0026#34;)) .s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) .s datetime=date_\u0026#34; \u0026#34;_$zt(time,2) .s filename=\u0026#34;\u0026#34; .s cnt=cnt+1 .i cnt\u0026gt;300 q .s retList=retList_$c(9)_cnt_$c(9)_datetime_$c(9)_labno_$c(9)_labno_$c(9)_filename_$c(2) s retList=$e(retList,1,$l(retList)-1) q retList } } 同一路径回传文件上传一个或多个文件 示例接口(贝克曼流水线) 通过配置监听 UPPreDealClass 字段“PreDeal.DealDemoM,PreDeal”，通过 M 进行编写上传信息，只输出一次 OutPut 就可以生成一个文件，通过输出两次 OutPut 修改第二次 OutPut 内容可以在同一路径回传两个不同的文件。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;2000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;C:\\\\Inetpub\\\\UL\\\\\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFRemisolN\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.hpr,.ok\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;C:\\\\Inetpub\\\\DL\\\\\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoMALL,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;}] Class MI.MIFRemisolN Extends %RegisteredObject { /// D ##class(MI.MIFBeckmanRemisol).fileMTHD(\u0026#34;38\u0026#34;,\u0026#34;1,BASO#,1,0.02,,,,,\u0026#34;,\u0026#34;1\u0026#34;) /// mi:仪器主键 /// record:一个数据行合并提交用#enter#分割多行数据 /// epis:流水号，前处理提取出了的画 /// fileNameOrColName:读文件的是文件全名，数据库的是数据库查询的列名用~分割 /// D ##class(MI.MIFRemisolN).fileMTHD(\u0026#34;1\u0026#34;,\u0026#34;H|\\^\u0026amp;|||REMISOL||||||UPLOAD_SIGN=0\\INTERPRETATION_FLAG=1\\INSTRUMENT_FLAG=1|P|1|20231207134318[13][10]Q|1|^ssss||||||||||O[13][10]L|1[13][10]\u0026#34;) /// D ##class(MI.MIFRemisolN).fileMTHD(\u0026#34;24\u0026#34;,\u0026#34;H|\\^\u0026amp;|||Lb1k□V1.5.5||||||UPLOAD_SIGN=1\\INTERPRETATION_FLAG=0\\INSTRUMENT_FLAG=1|P|1|20241011155213[13][10]P|1||0000000072||彭均秀^||19480902|F|||||||||||||||||普外科门诊[13][10]O|1|24101100017^0020^01|||RO|20241011155213|20241011155213||||||||S|||UV[13][10]R|1|^^^GLU^^2286\\2286^1598\\1609^^0|7.05^M|||N||R||||20241011102518|AU5800[13][10]R|2|^^^LIPEM^^^^^0|0|||N||R||||20241011102518|AU5800[13][10]R|3|^^^ICTER^^^^^0|0|||N||R||||20241011102518|AU5800[13][10]R|4|^^^HEMOL^^^^^0|0|||N||R||||20241011102518|AU5800[13][10]L|1[13][10]\u0026#34;) ClassMethod fileMTHD(mi, record As %String(MAXLEN=99999999), epis, fileNameOrColName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; i \u0026#39;$l(record) q \u0026#34;\u0026#34; s (Code,result,date,time,res,QC)=\u0026#34;\u0026#34; d Trace^MI.MIF000(mi,record,\u0026#34;record\u0026#34;) for i=1:1:$l(record,\u0026#34;[13][10]\u0026#34;) d .s rec=$p(record,\u0026#34;[13][10]\u0026#34;,i) .i \u0026#39;$l(rec) q .d Trace^MI.MIF000(mi,rec,\u0026#34;rec\u0026#34;) .S type=$e(rec,1,1) .i type=\u0026#34;O\u0026#34; d q ..s epis=$tr($p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) .i type=\u0026#34;R\u0026#34; d q ..s code=$tr($p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4),\u0026#34; \u0026#34;) ..S res=$p(rec,\u0026#34;|\u0026#34;,4) ..s ResNoes=$p(res,\u0026#34;^\u0026#34;,2) ..s ResNoes=##class(MI.MIFRemisolN).ConvertResNoes(ResNoes) ..s res=$tr($p(res,\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;,\u0026#34;\u0026#34;) ..s resKZJG=##class(MI.MIFRemisolN).ConvertresKZJG(mi,epis,code,res) ..s result=result_code_$c(92)_res_$c(92)_resKZJG_$c(92)_ResNoes_$c(44) .i type=\u0026#34;L\u0026#34; d q ..d Trace^MI.MIF000(mi,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;Result\u0026#34;) ..i $l(epis),$l(result) d Save^MI.MIF000(mi,epis,result,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) q \u0026#34;\u0026#34; } /// 获取扩展结果 ClassMethod ConvertresKZJG(mi, epis, code, res) { s code=$g(code),res=$g(res) s OutPut=\u0026#34;\u0026#34; s Labno=$$GetLabnoByEpis(mi,epis) i $l(Labno),$d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Labno)) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Labno,\u0026#34;\u0026#34;)) .s Age=$lg($g(^dbo.RPVisitNumberD(VisitNumberDR)),18) s Age=$g(Age) i \u0026#39;$l(code),\u0026#39;$l(res) q OutPut i code=\u0026#34;BNP\u0026#34;,0 d\t// BNP N端脑钠肽前体 .i \u0026#39;$l(Age) q .i Age\u0026lt;=50 d ..i res\u0026lt;=450 s OutPut=\u0026#34;正常\u0026#34; ..i res\u0026gt;450,res\u0026lt;=600 s OutPut=\u0026#34;急性心衰\u0026#34; ..i res\u0026gt;600 s OutPut=\u0026#34;慢性心衰\u0026#34; .i ((Age\u0026gt;50)\u0026amp;\u0026amp;(Age\u0026lt;=75)) d ..i res\u0026lt;=900 s OutPut=\u0026#34;正常\u0026#34; ..i res\u0026gt;900 s OutPut=\u0026#34;急性心衰\u0026#34; .i Age\u0026gt;75 d ..i res\u0026lt;=1800 s OutPut=\u0026#34;正常\u0026#34; ..i res\u0026gt;1800 s OutPut=\u0026#34;急性心衰\u0026#34; i code=\u0026#34;25OHD\u0026#34; d\t// 25羟维生素D .i res\u0026lt;=20 s OutPut=\u0026#34;缺乏\u0026#34; .i res\u0026gt;20,res\u0026lt;=30 s OutPut=\u0026#34;不足\u0026#34; .i res\u0026gt;30,res\u0026lt;=100 s OutPut=\u0026#34;充足\u0026#34; .i res\u0026gt;100 s OutPut=\u0026#34;超上限\u0026#34; q OutPut GetLabnoByEpis(mi,Epis) s ret=Epis,mi=$g(mi) s date=$zd($h,8) i \u0026#39;$l(mi) q Epis s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i \u0026#39;$l(WGMachineID) q Epis i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,date,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis))) { s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,date,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis),\u0026#34;\u0026#34;),-1) S VisitNumberDR=$LG($G(^dbo.RPVisitNumberReportD(ReportDR)),2) s ret=$lg(^dbo.RPVisitNumberD(VisitNumberDR),2) } q ret } /// 转换报警信息 ClassMethod ConvertResNoes(ResNoes) { s ResNoes=$g(ResNoes) s OutPut=\u0026#34;\u0026#34; i \u0026#39;$l(ResNoes) q OutPut i $d(^LISPolice(\u0026#34;BKMLSX\u0026#34;,ResNoes)) d .s OutPut=$g(^LISPolice(\u0026#34;BKMLSX\u0026#34;,ResNoes)) i $l(ResNoes),\u0026#39;$l(OutPut) s OutPut=\u0026#34;旗标:\u0026#34;_ResNoes q OutPut } /// D ##class(MI.MIFBeckmanRemisol)SaveImageMTHD(\u0026#34;7\u0026#34;,\u0026#34;9999\u0026#34;, \u0026#34;\u0026#34;,\u0026#34;175\u0026#34;) /// mi:仪器 /// epis：流水号，如果是监听图片模式该位置放图片名称，自己在保存前提取流水 /// ImageClass:图片类别，如果是监听图片模式该位置放图片名称，自己在保存前提取图片类型 /// FileName:保存在文件服务的相对路径，默认不动 /// FullName:文件全路径，如果是监听图片模式该位置放图片全路径名称，满足有的图片名称无法得到流水和图片类别的情况 ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, FullName, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //通过OtherPara配置取图的在这里通过epis和ImageClass的图片名字提取出流水号和图片类别 s mi=$g(mi) s epis=$g(epis) s ImageClass=$g(ImageClass) //解析流水号和图片类别 s Name=epis s epis=$p(Name,\u0026#34;_\u0026#34;,1) s ImageClass=$p(Name,\u0026#34;_\u0026#34;,2) s ImageClass=$p(ImageClass,\u0026#34;.\u0026#34;,1) s FileName=$g(FileName) s FullName=$g(FullName) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; d ##Class(MI.Common.MIFBase).Trace(mi,epis_\u0026#34;:\u0026#34;_ImageClass_\u0026#34;:\u0026#34;_FileName,\u0026#34;H\u0026lt;--M\u0026#34;) s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=\u0026#34;\u0026#34; //加上当前时间，防止浏览器缓存 s FileName=FileName_\u0026#34;?\u0026#34;_$p($h,\u0026#34;,\u0026#34;,2) s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } /// 返回给监听当前上传文件路径名称，默认不要动 /// w ##class(MI.MIFBeckmanRemisol).GetFtpMTHD(\u0026#34;7\u0026#34;) /// mi:仪器 ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = \u0026#34;labno,labnoInfo,patInfo\u0026#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(\u0026#34;MI.MIFRemisolN\u0026#34;,\u0026#34;QryLabInfo\u0026#34;,\u0026#34;24\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //*--------------------------------\u0026gt;*申请项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-8,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..//20秒以内的先不上传，防止没接收完 ..i (AddDate=$zd($h,8)),(($p($h,\u0026#34;,\u0026#34;,2)-AddTime)\u0026lt;20) q ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..s labnoInfo=..GetLabnoInfo(mi,labno) ..s patInfo=\u0026#34;\u0026#34; ..s FileName=$zd($h,8)+$p($h,\u0026#34;,\u0026#34;,2)_MiUploadDR ..//输出hpr文件 ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(FileName_\u0026#34;.hpr\u0026#34;,labnoInfo,labno,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,FileName_\u0026#34;.hpr\u0026#34;_\u0026#34;$$\u0026#34;_labno_\u0026#34;$$\u0026#34;_labnoInfo,\u0026#34;上传信息\u0026#34;) ..d OutputRow ..//输出OK文件 ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(FileName_\u0026#34;.OK\u0026#34;,patInfo,labno,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,FileName_\u0026#34;.OK\u0026#34;_\u0026#34;$$\u0026#34;_labno_\u0026#34;$$\u0026#34;_patInfo,\u0026#34;上传信息\u0026#34;) ..d OutputRow /* //*--------------------------------\u0026gt;*复查项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-8,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..//20秒以内的先不上传，防止没接收完 ..i (AddDate=$zd($h,8)),(($p($h,\u0026#34;,\u0026#34;,2)-AddTime)\u0026lt;20) q ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..s labnoInfo=..GetLabnoInfo(mi,labno) ..s patInfo=\u0026#34;\u0026#34; ..s FileName=$zd($h,8)+$p($h,\u0026#34;,\u0026#34;,2)_MiUploadDR ..//输出hpr文件 ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(FileName_\u0026#34;.hpr\u0026#34;,labnoInfo,labno,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,FileName_\u0026#34;.hpr\u0026#34;_\u0026#34;$$\u0026#34;_labno_\u0026#34;$$\u0026#34;_labnoInfo,\u0026#34;上传信息\u0026#34;) ..d OutputRow ..//输出OK文件 ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(FileName_\u0026#34;.OK\u0026#34;,patInfo,labno,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,FileName_\u0026#34;.OK\u0026#34;_\u0026#34;$$\u0026#34;_labno_\u0026#34;$$\u0026#34;_patInfo,\u0026#34;上传信息\u0026#34;) ..d OutputRow */ Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=\u0026#34;labno,labnoInfo,patInfo\u0026#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=\u0026#34;\u0026#34; { Set AtEnd=1 Set Row=\u0026#34;\u0026#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 得到标本信息 /// w ##class(MI.MIFRemisolN).GetLabnoInfo(24,\u0026#34;24092600054\u0026#34;) ClassMethod GetLabnoInfo(miRowId, labno) As %String { S miRowId=$G(miRowId),labno=$G(labno) K PLIST Q:\u0026#39;$L(miRowId)||\u0026#39;$L(labno) 0 K ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$J,miRowId,labno) S visitNumberDR=$O(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) Q:\u0026#39;$L(visitNumberDR) 1 S visitNumberData=$G(^dbo.RPVisitNumberD(visitNumberDR)) Q:\u0026#39;$L(visitNumberData) 2 D ScanOne^MI.MIF000(miRowId,labno) S chl=\u0026#34;\u0026#34;,chlList=\u0026#34;\u0026#34;,hcg5d=\u0026#34;\u0026#34;,chlCnt=0 F { S chl=$O(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$J,miRowId,labno,chl)) i $l(chl)\u0026#39;=0 { S:$E(chl,1)=\u0026#34;A\u0026#34; chlCnt=chlCnt+1 S:chl=\u0026#34;A179\u0026#34; hcg5d=chl Continue:chl=\u0026#34;A179\u0026#34; S chlList=chlList_\u0026#34;^^^\u0026#34;_chl_\u0026#34;\\\u0026#34; } else { Q:\u0026#39;$L(chl) } } I $L(hcg5d) { I (chlCnt\u0026#39;=2)\u0026amp;\u0026amp;(chlCnt\u0026#39;=3)\u0026amp;\u0026amp;(chlCnt\u0026#39;=4) { S hcg5d=\u0026#34;A178\u0026#34; } S chlList=chlList_\u0026#34;^^^\u0026#34;_hcg5d_\u0026#34;\\\u0026#34; } S chlList=$E(chlList,1,$L(chlList)-1) Q:\u0026#39;$L(chlList) 3 S locationDR=$LG(visitNumberData,22),location=\u0026#34;\u0026#34; S:$L(locationDR) location=$LG($G(^dbo.BTLocationD(locationDR)),3) S doctorDR=$LG(visitNumberData,23),doctor=\u0026#34;\u0026#34;,doctorCode=\u0026#34;\u0026#34; I $L(doctorDR) { S doctor=$LG($G(^dbo.BTDoctorD(doctorDR)),3) S doctorCode=$LG($G(^dbo.BTDoctorD(doctorDR)),2) } S receiveDate=$LG(visitNumberData,66) S receiveTime=$LG(visitNumberData,67) S receiveUserDR=$LG(visitNumberData,68),receiveUser=\u0026#34;\u0026#34; S:$L(receiveUserDR) receiveUser=$LG($G(^dbo.SYSUserD(receiveUserDR)),3) S patientId=$LG(visitNumberData,3) S surName=$LG(visitNumberData,13) S givenName=$LG(visitNumberData,14) S patName=surName_givenName S:surName=givenName patName=surName S speciesDR=$LG(visitNumberData,15),species=\u0026#34;\u0026#34;,speciesCode=\u0026#34;\u0026#34; I $L(speciesDR) { S species=$LG($G(^dbo.BTSpeciesD(speciesDR)),3) S speciesCode=$LG($G(^dbo.BTSpeciesD(speciesDR)),2) } S admTypeDR=$LG(visitNumberData,4),admType=\u0026#34;\u0026#34; S:$L(admTypeDR) admType=$LG($g(^dbo.BTAdmissionTypeD(admTypeDR)),3) S bed=$LG(visitNumberData,27) S age=$LG(visitNumberData,18) S ageUnitDR=$LG(visitNumberData,19),ageUnit=\u0026#34;\u0026#34;,ageUnitCode=\u0026#34;\u0026#34; I $L(ageUnitDR) { S ageUnit=$LG($g(^dbo.BTAgeUnitD(ageUnitDR)),3) S ageUnitCode=$LG($g(^dbo.BTAgeUnitD(ageUnitDR)),2) } S collectDate=$LG(visitNumberData,51) S collectTime=$LG(visitNumberData,52) S collectDateTime=collectDate_##Class(LIS.Core.Util).CvtClientTime(collectTime,\u0026#34;HHMMSS\u0026#34;) S diagnosis=$LG(visitNumberData,28) S birthday=$LG(visitNumberData,16) S:\u0026#34;MF\u0026#34;\u0026#39;[speciesCode speciesCode=\u0026#34;\u0026#34; S:\u0026#34;YMD\u0026#34;\u0026#39;[ageUnitCode ageUnitCode=\u0026#34;\u0026#34; S PLIST=0 S PLIST($I(PLIST))=\u0026#34;H|\\^\u0026amp;|||LIS^1|||||REMISOL||P|1|\u0026#34;_$ZD($H,8)_$TR($ZT($P($H,\u0026#34;,\u0026#34;,2),1),\u0026#34;:\u0026#34;) S patRecord=\u0026#34;P|1||||||||||||||||||||||||||||||||||\u0026#34; S $P(patRecord,\u0026#34;|\u0026#34;,4)=patientId s givenName=\u0026#34;\u0026#34; S $P(patRecord,\u0026#34;|\u0026#34;,6)=surName_\u0026#34;^\u0026#34;_givenName_\u0026#34;^^^\u0026#34; S $P(patRecord,\u0026#34;|\u0026#34;,8)=birthday_\u0026#34;^\u0026#34;_age_\u0026#34;^\u0026#34;_ageUnitCode S $P(patRecord,\u0026#34;|\u0026#34;,9)= speciesCode S $P(patRecord,\u0026#34;|\u0026#34;,14)= doctorCode S $P(patRecord,\u0026#34;|\u0026#34;,22)= diagnosis //诊断 S $P(patRecord,\u0026#34;|\u0026#34;,26)=location S PLIST($I(PLIST))=patRecord S order=\u0026#34;O|1|\u0026#34;_labno_\u0026#34;||\u0026#34;_chlList_\u0026#34;|||||||||||||||||||||\u0026#34; S specType=..GetSpecimen(labno) //S specTypeId=\u0026#34;S\u0026#34; // 样品类型，如血清、血浆、尿液等。0-血清，1-血浆，2-尿液，3-脑脊液，4-胃液，5-胸水，6-腹水，7-其他: I specType[\u0026#34;血清\u0026#34; { S specTypeId=\u0026#34;0\u0026#34; } ELSEIF specType[\u0026#34;血浆\u0026#34; { S specTypeId=\u0026#34;1\u0026#34; } ELSEIF specType[\u0026#34;尿\u0026#34; { S specTypeId=\u0026#34;2\u0026#34; } ELSEIF specType[\u0026#34;脑脊液\u0026#34; { S specTypeId=\u0026#34;3\u0026#34; } ELSEIF specType[\u0026#34;胃液\u0026#34; { S specTypeId=\u0026#34;4\u0026#34; } ELSEIF specType[\u0026#34;胸水\u0026#34; { S specTypeId=\u0026#34;5\u0026#34; } ELSEIF specType[\u0026#34;腹水\u0026#34; { S specTypeId=\u0026#34;6\u0026#34; } ELSE { S specTypeId=\u0026#34;7\u0026#34; } S $P(order,\u0026#34;|\u0026#34;,6)=\u0026#34;R\u0026#34; //priority:R=Routine,S=Stat S $P(order,\u0026#34;|\u0026#34;,8)=collectDateTime S $P(order,\u0026#34;|\u0026#34;,12)=\u0026#34;A\u0026#34; //Action Code: A=Add,C=Clear,Q=Control S $P(order,\u0026#34;|\u0026#34;,16)=specTypeId S PLIST($I(PLIST))=order S PLIST($I(PLIST))=\u0026#34;L|1|\u0026#34; s del=\u0026#34;[13][10]\u0026#34; s ret=\u0026#34;\u0026#34; s seq=\u0026#34;\u0026#34; f s seq=$o(PLIST(seq)) q:seq=\u0026#34;\u0026#34; d .s ret=ret_PLIST(seq)_del Q ret } /// 得到标本类型 ClassMethod GetSpecimen(labno As %String) As %String { s ret=\u0026#34;\u0026#34; s labno=\u0026#34; \u0026#34;_labno i \u0026#39;$d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno)) q ret s RowId=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) s obj=##class(dbo.RPVisitNumber).%OpenId(RowId) s spDr=obj.SpecimenDR s spDesc=\u0026#34;\u0026#34; i $l(spDr) d .s objSp=##class(dbo.BTSpecimen).%OpenId(spDr) .s spDesc=objSp.IName .s ret=spDesc q ret } /// w ##Class(MI.MIFBeckmanRemisol).GetPatInfo(6,1001367) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) s Sampleno=labno //检测号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; ;病区 s RetString=\u0026#34;\u0026#34; s RetString=Sampleda_\u0026#34;,\u0026#34;_Instrument_\u0026#34;,\u0026#34;_Sampleno_\u0026#34;,\u0026#34;_Sampletype_\u0026#34;,\u0026#34;_Feetype_\u0026#34;,\u0026#34;_Srcdepno_\u0026#34;,\u0026#34;_Srcdocno_\u0026#34;,\u0026#34;_Userno_\u0026#34;,\u0026#34; s RetString=RetString_Patno_\u0026#34;,\u0026#34;_Patna_\u0026#34;,\u0026#34;_Sex_\u0026#34;,\u0026#34;_Pattype_\u0026#34;,\u0026#34;_Bedno_\u0026#34;,\u0026#34;_Patage_\u0026#34;,\u0026#34;_Ageunit_\u0026#34;,\u0026#34;_Reqno_\u0026#34;,\u0026#34;_Reqda_\u0026#34;,\u0026#34; s RetString=RetString_Reportda_\u0026#34;,\u0026#34;_Printflag_\u0026#34;,\u0026#34;_Resultflag_\u0026#34;,\u0026#34;_Errflag_\u0026#34;,\u0026#34;_Diagnose_\u0026#34;,\u0026#34;_Description_\u0026#34;,\u0026#34;_Reserve_\u0026#34;,\u0026#34; s RetString=RetString_Patnamn_\u0026#34;,\u0026#34;_Getda_\u0026#34;,\u0026#34;_Wardno_\u0026#34;,\u0026#34;_BarCode q RetString } // 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,\u0026#34;S\u0026#34;,filename) q } /// 保存图片Base64串到仪器 /// mi:仪器主键(*必填) /// epis:流水号(*必填) /// ImageClass:图片类别(*必填) /// base64Stream:图片的Base64流(*必填) /// fileName:文件名 /// ftpFfolderName:文件服务的文件夹名称 /// w ##Class(MI.MIFBeckmanRemisol).SaveBase64ToMachineTest() ClassMethod SaveBase64ToMachineTest() { s charStream=##class(%GlobalCharacterStream).%New() d charStream.Write(\u0026#34;Qk02fQAAAAAAADYEAAAoAAAAsAAAALAAAAABAAgAAAAAAAB5AAB0EgAAdBIAAAAAAAAAAAAAAAAAAAAAgAAAgAAAAICAAIAAAACAAIAAgIAAAICAgADA3MAA8MqmAKo/KgD/PyoAAF8qAFVfKgCqXyoA/18qAAB/KgBVfyoAqn8qAP9/KgAAnyoAVZ8qAKqfKgD/nyoAAL8qAFW/KgCqvyoA/78qAADfKgBV3yoAqt8qAP/fKgAA/yoAVf8qAKr/KgD//yoAAABVAFUAVQCqAFUA/wBVAAAfVQBVH1UAqh9VAP8fVQAAP1UAVT9VAKo/VQD/P1UAAF9VAFVfVQCqX1UA/19VAAB/VQBVf1UAqn9VAP9/VQAAn1UAVZ9VAKqfVQD/n1UAAL9VAFW/VQCqv1UA/79VAADfVQBV31UAqt9VAP/fVQAA/1UAVf9VAKr/VQD//1UAAAB/AFUAfwCqAH8A/wB/AAAffwBVH38Aqh9/AP8ffwAAP38AVT9/AKo/fwD/P38AAF9/AFVffwCqX38A/19/AAB/fwBVf38Aqn9/AP9/fwAAn38AVZ9/AKqffwD/n38AAL9/AFW/fwCqv38A/79/AADffwBV338Aqt9/AP/ffwAA/38AVf9/AKr/fwD//38AAACqAFUAqgCqAKoA/wCqAAAfqgBVH6oAqh+qAP8fqgAAP6oAVT+qAKo/qgD/P6oAAF+qAFVfqgCqX6oA/1+qAAB/qgBVf6oAqn+qAP9/qgAAn6oAVZ+qAKqfqgD/n6oAAL+qAFW/qgCqv6oA/7+qAADfqgBV36oAqt+qAP/fqgAA/6oAVf+qAKr/qgD//6oAAADUAFUA1ACqANQA/wDUAAAf1ABVH9QAqh/UAP8f1AAAP9QAVT/UAKo/1AD/P9QAAF/UAFVf1ACqX9QA/1/UAAB/1ABVf9QAqn/UAP9/1AAAn9QAVZ/UAKqf1AD/n9QAAL/UAFW/1ACqv9QA/7/UAADf1ABV39QAqt/UAP/f1AAA/9QAVf/UAKr/1AD//9QAVQD/AKoA/wAAH/8AVR//AKof/wD/H/8AAD//AFU//wCqP/8A/z//AABf/wBVX/8Aql//AP9f/wAAf/8AVX//AKp//wD/f/8AAJ//AFWf/wCqn/8A/5//AAC//wBVv/8Aqr//AP+//wAA3/8AVd//AKrf/wD/3/8AVf//AKr//wD/zMwA/8z/AP//MwD//2YA//+ZAP//zAAAfwAAVX8AAKp/AAD/fwAAAJ8AAFWfAACqnwAA/58AAAC/AABVvwAAqr8AAP+/AAAA3wAAVd8AAKrfAAD/3wAAVf8AAKr/AAAAACoAVQAqAKoAKgD/ACoAAB8qAFUfKgCqHyoA/x8qAAA/KgBVPyoA8Pv/AKSgoACAgIAAAAD/AAD/AAAA//8A/wAAAP8A/wD//wAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\u0026#34;) d charStream.Write(\u0026#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADx8fHx8fEAAADxAAAA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPHxAPHx8fEAAPEA8QAA8QDxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QDxAADx8fHx8fHx8fHxAPHx8QAA8fEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8fHxAPHx8fHx8fHx8fEA8QDxAAAAAADxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPEA8fHx8QDx8fHx8fHx8fEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPEA8QAAAADx8fHx8fHx8QDx8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QAA8fHx8fEA8fHx8fHxAPEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QDxAAAAAPHx8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPEAAPHx8fHxAPEA8fEA8fEAAPE\u0026#34;) d charStream.Write(\u0026#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAAAAAPEAAPEA8QAA8QDxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QDx8QDx8QAA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8fHx8QAAAPEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAADx8fEA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAADxAAAAAPEAAAAAAPEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QAA8fEA8fHxAAAAAADxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QAAAAAAAADxAADxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADx8QAA8QAAAAAA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPEA8fEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPEAAPEA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAPEA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\u0026#34;) d charStream.Write(\u0026#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAgICAAACAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAgAAAgAAAgIAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAgICAAAAAgAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAC+gACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAgIAAgAAAPoCAAIAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgD6APr6AvoAAgACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAICAgICAAACAPr6AAIAAgACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIA+voAAgAAAgD6AAAA+gIAAgAAAgIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAAD6AAACAAIAAAIAAgAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgD6AAAAAPr6AgL6AAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAPoC+gAC+gAAAgAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAvoAAAD6AgAC+gD6+gD6AgIAAgIAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD6+gIAAPr6+gD6+gL6AAD6AAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAAACAPoA+gD6+vr6AgL6AAICAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPoAAAACAvoCAgD6AvoCAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAL6APoCAgAC+vr6+gICAAAAAgACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+gACAgAAAgIAAAACAgACAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD6+gAC+gIC+voC+gIAAAD6AAIAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgIAAvr6+gAAAgICAgD6AAACAPoCAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPoAAgD6+voCAvr6AvoAAgIAAgACAAAAAAAAAAAAAAAAAAAAAAAAAAA\u0026#34;) d charStream.Write(\u0026#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAICAAACAAACAgD6+gIA+voC+gACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+gIAAAICAAIAAAL6AvoAAgIAAgAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAgIA+gAAAgL6+vr6+gACAAICAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAQABAQAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAAIA+gAA+voCAPoAAgIA+gACAAICAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAEAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAvoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAQAAAAABAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD6+gICAgIAAPr6+gAAAAAAAAIAAgAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICAAACAAAAAAL6AgICAAACAgAAAAIAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAABAAABAAAAAAABAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAL6AgACAgD6AAIA+gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICAAAAAAAAAgACAgIAAAIAAAACAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAABAAAAAAD5AQAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAICAAIAAPoAAgL6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAAAAAAAAAQAAAAABAAEAAAABAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAD6AAAAAAAAAAAAAAAAAgACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAABAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAgAAAAIAAgAAAgAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAQEAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAgAAAAIAAAAAAAAAAgIAAAAA+gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAA+QAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgACAPoAAAIAAAAAAAAAAAIAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAEAAQABAQAAAAEBAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAACAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAEAAQABAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+QAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAD5AAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP0AAAAAAAAAAAAAAgAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAEBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAICAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\u0026#34;) d charStream.Write(\u0026#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAQAAAAAAAAABAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFBQAFAAAAAAD9AAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgAAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD9AAAFBQAFAAX9AAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAABgAAAAAGAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAFBf0ABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAYGAAAABgYGAAAAAAAGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUFAAUAAAUAAAAFAAAFBQUAAAAAAAAAAAAAAAAAAAYAAAAABgAAAAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUFAAUAAAUABQAAAAUFAAAAAAAFAAAAAAAAAAAAAAAAAAAAAP4GBgYGBv4AAAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQUFBQD9AAAFBQAAAP0AAAUAAP0AAAUFAAAAAAAAAAAAAAAAAP4GAAAABgb+BgYABgAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAF/QX9BQAFBf0AAAAABQAAAAAAAAAAAAAAAAAABgD+BgAABgYGAP4GBgYAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/QAFBQD9/f0ABQAFBf0AAAAFAAAAAAAAAAAAAAAAAAAABgb+AAD+BgYGBv4GAP4G/gYGAAAGBgYAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFBQD9AAX9/QAABQAFBQAAAP0ABQAAAAAAAAYABgAGAAb+Bgb+AP4ABgb+/v4GBgAGAAAGAAYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAP0F/QD9Bf39AP39AAAAAAAFAAAAAAAAAAAABgYABgYGAP7+/v4GBgb+Bv4ABgAABgAGBgYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAFAAX9/f39AAX9AAUF/QUAAAAAAAAAAAAABgAAAAAABgYGBv4G/v7+/v7+/v7+/v7+AAYGBgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUF/QX9AP39BQAFAP39/QUA/QAAAAAAAAAGAAAAAAAGAP4GBv7+/v7+/v7+/v7+/gYGBgb+BgD+AAAAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUFBQX9AAUABQUABf0AAP0AAAX9AAAFAAAAAAAGBgYABv7+/v7+AAb+/v7+/v7+/v7+/v4GBv4GAAb+AAAGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAA/QUFAAX9/QX9AP0FBQAA/QAAAAAAAAAAAAYGAAD+AAD+/v7+/v7+/v7+/v7+/v7+Bv4GBgYAAAAGBgAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAX9Bf39AAD9BQAA/QD9/QAABQAFAAYAAAAABgAG/gYG/v7+/v7+/v7+/v7+/v7+/v4GBv7+AAYGBgAAAAYGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAF/QAF/\u0026#34;) d charStream.Write(\u0026#34;QUF/QAFBf0AAAAFAAAAAAAAAAAAAAAAAAAAAP7+/gb+/v7+/v7+/v7+/v7+/v7+/v4GAAYGAAAGBgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/f0A/QD9AAAFBQAABQAAAAAAAAAAAAAAAAAABgAGAP4G/v7+/v7+/v7+/v7+/v7+/v7+/v4G/gAGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAA/QUAAAAFAAD9BQAABQAAAAAAAAAAAAAAAAYABgYGBgb+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/gAABgYGAAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP0FAAUABQAA/QX9BQAFBQAAAAAAAAAAAAAAAAAAAAAG/v7+/gb+/v7+/v7+/v7+/v7+/v7+/v7+/gYGBgYGBgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQUAAAD9/QX9BQAAAAAABQAAAAAAAAAAAAYGAAAAAAYA/gD+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v4ABgYAAAYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUFAAAAAAAAAAAABgYAAAYA/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v4GAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUFAAAABQAAAAAAAAAAAAUAAAAAAAAABgAAAAYAAAb+/gYGBv7+/v7+/v7+/v7+/v7+/v7+Bv7+/v4GBgAAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAFAAAAAAAAAAAABgYGAAAGBgYGBv7+/v7+/v7+/v7+/v7+/v4G/v7+BgAABgYGAAYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAAABgYGBv7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/gYA/gAG/gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYG/v7+/v7+/v7+/v7+/v7+/v7+Bgb+AAYGAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYABgAG/v4G/gb+/v7+/v7+/v7+/v7+BgAGBgAGAAYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYABv4G/v4A/v7+/v4G/v7+/v7+/gb+BgAABgYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYABgAA/v7+/v7+BgYA/v4GBv4GBv4GAAYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYABgYAAP7+/v4G/v4GBgYGBgYGBgYAAAAAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYABgYABgYABgYAAAb+/gAGBgYABgYGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgAGBgYAAAYGBgAGAAYABgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAAABgAAAAAABgAGBgAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAAAAAYAAAAGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\u0026#34;) d charStream.Write(\u0026#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\u0026#34;) d charStream.Write(\u0026#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\u0026#34;) d charStream.Write(\u0026#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=\u0026#34;) s mi=16 s epis=999 s ret=##Class(MI.Common.MIFBase).SaveBase64ToMachine(mi,epis,\u0026#34;DIFF\u0026#34;,charStream,epis_\u0026#34;-DIFF.bmp\u0026#34;,\u0026#34;ZLZ\u0026#34;) i ret\u0026#39;=1 d Trace^MI.MIF000(mi,\u0026#34;错误\u0026#34;_ret,\u0026#34;H\u0026lt;--M\u0026#34;) q ret } /// 转移标本 /// w ##Class(MI.MIFRemisolN).TransMachineGroup(1,9000000071,\u0026#34;DXI800\u0026#34;) /// w ##Class(MI.MIFRemisolN).TransMachineGroup(1,9000000071,\u0026#34;AU5800\u0026#34;) ClassMethod TransMachineGroup(mi, epis, machineName) { s ret=\u0026#34;\u0026#34; i $l(epis)\u0026lt;7 d .s epis=$$GetLabnoByEpis(mi,epis) s date=$zd($h,8) s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,epis,\u0026#34;\u0026#34;)),ReportDR=\u0026#34;\u0026#34; i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1)) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1,\u0026#34;\u0026#34;),-1) //----------------------转移标本 i machineName=\u0026#34;AU5800\u0026#34; d .s TransMachineGroupDR=61 .s ParamList=TransMachineGroupDR_\u0026#34;^@\u0026#34;_ReportDR .s ret=##Class(LISSP.DHCRPVisitNumberReport).TransMachineGroup(ParamList,\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P0\u0026gt;\u0026lt;/P0\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34;,\u0026#34;8280^18^0^2^1\u0026#34;,\u0026#34;\u0026#34;) .;i ret[\u0026#34;流水号已存在\u0026#34; d\t//YHR 20230101 如果流水号冲突是否获取最大流水号保证转移成功 ..s objReport=##class(dbo.RPVisitNumberReport).%OpenId(ReportDR) ..s NewEpis=##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(TransMachineGroupDR,\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P0\u0026gt;\u0026#34;_$zd($h,3)_\u0026#34;\u0026lt;/P0\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34;,$c(0)) ..s objReport.EpisodeNo=NewEpis ..s sc=objReport.%Save() ..s ret=##Class(LISSP.DHCRPVisitNumberReport).TransMachineGroup(ParamList,\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P0\u0026gt;\u0026lt;/P0\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34;,\u0026#34;8280^18^0^2^1\u0026#34;,\u0026#34;\u0026#34;) i machineName=\u0026#34;DXI800\u0026#34; d .s TransMachineGroupDR=71 .s ParamList=TransMachineGroupDR_\u0026#34;^@\u0026#34;_ReportDR .s ret=##Class(LISSP.DHCRPVisitNumberReport).TransMachineGroup(ParamList,\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P0\u0026gt;\u0026lt;/P0\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34;,\u0026#34;8280^18^0^2^1\u0026#34;,\u0026#34;\u0026#34;) .;i ret[\u0026#34;流水号已存在\u0026#34; d ..s objReport=##class(dbo.RPVisitNumberReport).%OpenId(ReportDR) ..s NewEpis=##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(TransMachineGroupDR,\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P0\u0026gt;\u0026#34;_$zd($h,3)_\u0026#34;\u0026lt;/P0\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34;,$c(0)) ..s objReport.EpisodeNo=NewEpis ..s sc=objReport.%Save() ..s ret=##Class(LISSP.DHCRPVisitNumberReport).TransMachineGroup(ParamList,\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P0\u0026gt;\u0026lt;/P0\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34;,\u0026#34;8280^18^0^2^1\u0026#34;,\u0026#34;\u0026#34;) q ret GetLabnoByEpis(mi,Epis) s ret=\u0026#34;\u0026#34;,mi=$g(mi) s date=$zd($h,8) i \u0026#39;$l(mi) q Epis s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i \u0026#39;$l(WGMachineID) q Epis i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,date,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis))) { s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,date,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis),\u0026#34;\u0026#34;),-1) S VisitNumberDR=$LG($G(^dbo.RPVisitNumberReportD(ReportDR)),2) s ret=$lg(^dbo.RPVisitNumberD(VisitNumberDR),2) } q ret } } 通过串口网口主动上传 上传和下载为不同的串口或端口 示例代码(西门子流水线) 仪器为两个接口，一个接口上传，一个接口接收数据解析数据。上传数据为在 main 调用 Build2 方法循环调用读取 dbo.RPMachineUpload 表中的数据。\n接收数据 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 MIFNYSIMRec(mi) ; 7/17/14 ; ASTM protocol - 西门子流水线(MCR) s mi=$g(mi) i \u0026#39;$l(mi) q s ^TMPMACHDATA1(mi,11)=mi s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),17) //端口号 S $ECODE=\u0026#34;\u0026#34; //捕获运行时错误,并显示 //控制字符 S stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4) S lf=$c(10),cr=$c(13),nak=$c(21),(result,epis)=\u0026#34;\u0026#34;,etb=$c(23) s isDebug=1,iError=0 s ^TMPMACHDATA1(mi,10)=mi i $$StartUTF8^MI.MIF000(mi) q f d Main i $$Stop^MI.MIF000(mi) q s ^TMPMACH10(mi,50)=$h c Port q Main ;s ^MIFSIMENSTRecive=$zdt($h,3) S $ZT=\u0026#34;RuntimeError\u0026#34; r *R:10 e d q .;d BUILD2 i $c(R)\u0026#39;=enq Q s AllRecord=\u0026#34;\u0026#34; d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) d ACK f r *R:10 q:$c(R)=eot d .i $c(R)\u0026#39;=stx q .s record=$$Read^MI.MIF000(mi,\u0026#34;\u0026#34;,lf) q:\u0026#39;$l(record) .s record=$e(record,2,$l(record)-1) .d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) .i $l(record,etb)\u0026gt;1 s AllRecord=AllRecord_$p($e(record,1,$l(record)-1),etb,1) .i $l(record,etx)\u0026gt;1 s AllRecord=AllRecord_$p($e(record,1,$l(record)-1),etx,1) .d ACK .s type=$tr($p(record,\u0026#34;|\u0026#34;,1),\u0026#34; \u0026#34;) .i type=\u0026#34;M\u0026#34; d q ..s Intype=$tr($p($p(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) ..s Inlabno=$tr($p($p(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,2),\u0026#34; \u0026#34;) ..d Trace^MI.MIF000(mi,Inlabno,\u0026#34;Inlabno\u0026#34;) ..try{s ret=##class(MI.Special.AutomaticReceipt).ZDHS(mi,Inlabno)}catch{}\t//YHR 20230910 生化流水线自动核收 d Trace^MI.MIF000(mi,$s($c(R)=eot:\u0026#34;EOT\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) s k=1 d Trace^MI.MIF000(mi,AllRecord,\u0026#34;AllRecord\u0026#34;) i $c(R)=eot,$l(AllRecord) d .s (mid,sample,epis,surname,rec,res,result,date,time,QC,flag,machiecode)=\u0026#34;\u0026#34; .f i=1:1:$l(AllRecord,cr) d ..s rec=$p(AllRecord,cr,i) ..s type=$tr($p(rec,\u0026#34;|\u0026#34;),\u0026#34; \u0026#34;) ..i type=\u0026#34;H\u0026#34; d q ..i type=\u0026#34;M\u0026#34; d q ...s Intype=$tr($p($p(rec,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) ...s Inlabno=$tr($p($p(rec,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,2),\u0026#34; \u0026#34;) ...d Trace^MI.MIF000(mi,Inlabno,\u0026#34;Inlabno\u0026#34;) ...;try{s ret=##class(MI.Special.AutomaticReceipt).ZDHS(mi,Inlabno)}catch{}\t//YHR 20230910 生化流水线自动核收 ..i type=\u0026#34;O\u0026#34; d q ...s epis=$tr($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34; \u0026#34;) ..i type=\u0026#34;R\u0026#34; d q ...s code=$p($p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4),\u0026#34;/\u0026#34;,1) ...s flag=$p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,8) ...s machiecode=$p($p(rec,\u0026#34;|\u0026#34;,14),\u0026#34;_\u0026#34;,1) ...i machiecode=\u0026#34;CentaurXP\u0026#34;,flag\u0026#39;=\u0026#34;DOSE\u0026#34; Q ...//R|1|^^^Glu^Neat^1.0^^^N|7.70|||||||^batch|20191116093550||Advia2400_1【13】【3】C2 ...s MachID=$P($p(rec,\u0026#34;|\u0026#34;,14),$C(13),1) ...s res=$p(rec,\u0026#34;|\u0026#34;,4) ...I res=\u0026#34;No Result\u0026#34; s res=\u0026#34;\u0026#34; ...i \u0026#39;$l(code) q ...i \u0026#39;$l(res) q ...s result=result_code_ResultDeli_res_ItemDeli ...s DateStr=$p(rec,\u0026#34;|\u0026#34;,13) ...s:\u0026#39;$L(DateStr) DateStr=$p(rec,\u0026#34;|\u0026#34;,12) ...i $l(DateStr) d ....s date=$zdh($e(DateStr,1,4)_\u0026#34;-\u0026#34;_$e(DateStr,5,6)_\u0026#34;-\u0026#34;_$e(DateStr,7,8),3) ....s time=($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60+$e(DateStr,13,14)) ..s k=k+1 ..i type=\u0026#34;L\u0026#34; d Last q q Last ;s resultmi=40 d Trace^MI.MIF000(mi,mi,\u0026#34;仪器rowid\u0026#34;) d Trace^MI.MIF000(mi,date_\u0026#34;^\u0026#34;_time_\u0026#34;^\u0026#34;_epis_\u0026#34;^:\u0026#34;_result,\u0026#34;Save in SIMENS\u0026#34;) i $l(epis),$l(result) d Save^MI.MIF000(mi,epis,result,date,time,QC) s (epis,result,date,time,QC)=\u0026#34;\u0026#34; ///标本核收 ; i $l(epis),\u0026#39;$d(^DHCUploadAllBAK(\u0026#34;B\u0026#34;,epis)) s retVal=$$ReceiveLabno^MI.MIF000(28,epis,\u0026#34;\u0026#34;) q RuntimeError h 10 s iError=iError+1 d Trace^MI.MIF000(mi,\u0026#34;Error Code:\u0026#34;_$ECODE_\u0026#34;,Error:\u0026#34;_$ZERROR,\u0026#34;Runtime Error\u0026#34;) i iError\u0026gt;100 s ret=$$Stop^MI.MIF000(mi) Q ///CreateDate： 20140717 ///Description： 构建医嘱列表 ///Table DHC_LoadSpecimen ///Input：\t///Output：\t///Return：\t///Others：DHCLoadSpecimen(0,\u0026#34;DateTime\u0026#34;,\u0026#34;TDMTS\u0026#34;,\u0026#34;C\u0026#34;,62301,42467,\u0026#34;T623010010\u0026#34;,\u0026#34;T101\u0026#34;,1) /// ^DHCLoadSpecimen({DHC_LoadSpecimen.DLSP_LabNo},{DHC_LoadSpecimen.DLSP_TS},{DHC_LoadSpecimen.DLSP_TSCNT},\u0026#34;TC\u0026#34;,{DLST_TestCode}) /// ^DHCLoadSpecimen({DLSP_LabNo},{DLSP_TS},{DLSP_TSCNT}) /// W $$BUILD2^DEBUG BUILD2 i $d(^DHCENQ(1)) d .d SendENQ .k ^DHCENQ Q //wwh,20140812,不上传标本 K ^TMP($zn,$j) I \u0026#39;$D(^DHCLoadSpecimen(0,\u0026#34;DateTime\u0026#34;,mi,\u0026#34;C\u0026#34;,+$h)) H 10 Q S SIMTT=\u0026#34;\u0026#34; F S SIMTT=$o(^DHCLoadSpecimen(0,\u0026#34;DateTime\u0026#34;,mi,\u0026#34;C\u0026#34;,+$h,SIMTT)) Q:SIMTT=\u0026#34;\u0026#34; D .S SIMEpis=\u0026#34;\u0026#34; F S SIMEpis=$o(^DHCLoadSpecimen(0,\u0026#34;DateTime\u0026#34;,mi,\u0026#34;C\u0026#34;,+$h,SIMTT,SIMEpis)) Q:SIMEpis=\u0026#34;\u0026#34; D ..S SIMTS=\u0026#34;\u0026#34; F S SIMTS=$O(^DHCLoadSpecimen(0,\u0026#34;DateTime\u0026#34;,mi,\u0026#34;C\u0026#34;,+$h,SIMTT,SIMEpis,SIMTS)) Q:SIMTS=\u0026#34;\u0026#34; D ...S epis=SIMEpis ...S SIMAck=$$BUILD() ...;;;I (SIMAck=3)!(SIMAck=6) D ...I SIMAck=0 D ....;;S err=$$UpdSendStatus^DHCLABLoadSpecimen(mi,epis,1,SIMTS) ....S err=$$UpdSendStatus^DHCLABLoadSpecimen(mi,epis,1) ...E D ....S err=$$UpdSendStatus^DHCLABLoadSpecimen(mi,epis,0) Q BUILD() S episx=epis,epis=$P(epis,\u0026#34;-\u0026#34;,1),suffix=\u0026#34;\u0026#34;,RetAck=1 S ^TMPsim(1)=epis I $l(epis),\u0026#39;$D(^TEPI(epis,1)) S suffix=$E(epis,$L(epis)),epis=$E(epis,1,$L(epis)-1) I $L(epis),\u0026#39;$D(^TEPI(epis,1)) Q S ^TMPsim(2)=epis_\u0026#34;,\u0026#34;_mi_\u0026#34;,\u0026#34;_suffix ;;;S err=$$CreateTCList^MIF000(mi,epis,SIMTS) ;创建上传医嘱列表 S err=$$CreateTCList^MIF000(mi,epis) ;创建上传医嘱列表 M ^TMPCHL(7)=^TMP(\u0026#34;MIF-SINGLE\u0026#34;,$j) Q:\u0026#39;$D(^TMP(\u0026#34;MIF-SINGLE\u0026#34;,$j,mi,epis_suffix)) M ^TMPCHL(2)=^TMP(\u0026#34;MIF-SINGLE\u0026#34;,$j) S (surn,givn,sex,dob,date,urno,age,loc)=\u0026#34;\u0026#34; ; check for entered/pre-entered patient details K PLIST I \u0026#39;$$select^LVBEPVIS(epis,\u0026#34;Y\u0026#34;) D .F j=\u0026#34;surn;3\u0026#34;,\u0026#34;givn;4\u0026#34;,\u0026#34;sex;5\u0026#34;,\u0026#34;dob;6\u0026#34;,\u0026#34;date;12\u0026#34;,\u0026#34;urno;20\u0026#34;,\u0026#34;age;26\u0026#34;,\u0026#34;loc;66\u0026#34; S @($P(j,\u0026#34;;\u0026#34;))=$g(PLIST($p(j,\u0026#34;;\u0026#34;,2))) K PLIST S sex=$P(sex,$c(1),1) s:sex=\u0026#34;\u0026#34; sex=\u0026#34;M\u0026#34; S urno=$p(urno,$c(1),1) I givn=surn s givn=\u0026#34;\u0026#34; S diag=$P($G(^TEPI(epis,8)),\u0026#34;\\\u0026#34;,15) ;;; 诊断 S SpecType=$$GetSpecType(epis) ;;; 标本 I $l(epis),$D(^TEPI(epis)) D .D scanone^MIF000(mi,epis) ;^TMP(\u0026#34;MIF-SINGLE\u0026#34;,208912,\u0026#34;AH7471\u0026#34;,\u0026#34;A611071030\u0026#34;,1)= .S tcx=\u0026#34;\u0026#34; .S chl=\u0026#34;\u0026#34; F S chl=$o(^TMP(\u0026#34;MIF-SINGLE\u0026#34;,$j,mi,epis,chl)) Q:chl=\u0026#34;\u0026#34; D ..;s tcs=tcs_\u0026#34;^^^\u0026#34;_chl_\u0026#34;/\\\u0026#34; ..S tcx=tcx_\u0026#34;^^^\u0026#34;_chl_\u0026#34;^0\\\u0026#34; .S tcx=$e(tcx,1,$L(tcx)-1) .I \u0026#39;$L(tcx) S tcx=\u0026#34;^^^^^^0\u0026#34; .S xx=$$extdate2^SSUTIL4($h),date=$p(xx,\u0026#34;/\u0026#34;,3)_$p(xx,\u0026#34;/\u0026#34;,2)_$p(xx,\u0026#34;/\u0026#34;,1) .S xx=$$exttime^SSUTIL4($p($h,\u0026#34;,\u0026#34;,2)),time=$p(xx,\u0026#34;:\u0026#34;,1)_$p(xx,\u0026#34;:\u0026#34;,2)_\u0026#34;00\u0026#34; .S temepis=\u0026#34;\u0026#34; .;1H|\\^\u0026amp;|||BSLIS^V3.00|||||||P|1\u0026lt;CR\u0026gt; .S str=\u0026#34;1H|\\^\u0026amp;|||BSLIS^V3.00|||||host|TSDWN^REPLY|P|1\u0026#34;_cr ;头信息 .;2P|1|0010332409|0010332409||Doe^JohnlSmith||19150826|F|||||||||||||||||5500|||||||||\u0026lt;CR\u0026gt; .S str=str_\u0026#34;2P|1\u0026#34;_cr ;病人信息 .S str=str_\u0026#34;2P|1\u0026#34;_cr .I epis=\u0026#34;N\u0026#34; s epis=\u0026#34;\u0026#34; .;3O|1|112448100||^^^TP^^^0\\^^^ALB^^^0|R||20110826112206||||A|hep|lipemic||Serum||||||||||Q\u0026lt;CR\u0026gt; .S str=str_\u0026#34;3O|1|\u0026#34;_epis_\u0026#34;||\u0026#34;_tcx_\u0026#34;|R||\u0026#34;_date_time_\u0026#34;||||A|hep|lipemic||\u0026#34;_SpecType_\u0026#34;||||||||||\u0026#34; .S str=str_\u0026#34;Q\u0026#34;_cr .;4L|1\u0026lt;CR\u0026gt; .S str=str_\u0026#34;4L|1|\u0026#34;_cr .S RetAck=$$Send(epis,str) .K ^TMIF(\u0026#34;MIF_SINGLE\u0026#34;,$j,mi,epis) S ^TMPsim(mi,$H,epis)=str_\u0026#34;||\u0026#34;_RetAck Q RetAck Send(epis,str) ; send list of orders if exists W enq,*-3 d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) S ret=1 F j=1:1:10 R *R:1 I $c(R)=ack!($c(R)=enq) Q d Trace^MI.MIF000(mi,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;1H\u0026lt;--M\u0026#34;) I $c(R)=enq Q ret I $c(R)\u0026#39;=ack W eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) Q ret I $L(str)\u0026gt;241 D .S str1=$e(str,1,241) .S ret=$$SEND(str1,1) .S str2=\u0026#34;2\u0026#34;_$E(str,242,$L(str)) .S ret=$$SEND(str2,0) E D .S ret=$$SEND(str,0) ;f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q ;d Trace^MI.MIF000(mi,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;2H\u0026lt;--M\u0026#34;) W eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) Q ret SEND(str,flag) ; send string to instrument I flag=1 D .S str=str_etb .S chsum=$$CHSUM(str) E D .S str=str_etx .S chsum=$$CHSUM(str) W stx,str,chsum,cr,lf,*-3 d Trace^MI.MIF000(mi,str_chsum,\u0026#34;H--\u0026gt;M\u0026#34;) F j=1:1:6 R *R:1 I ($c(R)=ack)!($c(R)=eot) Q I $c(R)=ack d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) Q 0 I $c(R)=eot d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) Q 0 I $c(R)=-1 W nak,*-3 d Trace^MI.MIF000(mi,R,\u0026#34;H\u0026lt;--M\u0026#34;) Q 1 CHSUM(x) ; calculate check sum n (x) s z=0 f y=1:1:$l(x) s z=z+$a(x,y) s z=$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#256\\16+1)_$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#16+1) q z ACK ; send \u0026#39;ack\u0026#39; to instrument w ack,*-3 d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q NEXTTRAY(tray) q tray /// GetSpecType(labno) n (labno) s labno=$g(labno) s spdr=$o(^TEPI(labno,4,\u0026#34;\u0026#34;)) s RetVal=\u0026#34;SE\u0026#34; s spec=\u0026#34;\u0026#34; i $l(spdr),$d(^TTAB(\u0026#34;SPEC\u0026#34;,spdr)) s spec=$p(^TTAB(\u0026#34;SPEC\u0026#34;,spdr),\u0026#34;\\\u0026#34;,1) i spec[\u0026#34;血\u0026#34; s RetVal=\u0026#34;SE\u0026#34; i spec[\u0026#34;尿\u0026#34; s RetVal=\u0026#34;UR\u0026#34; q RetVal SendENQ ; send list of orders if exists W enq,*-3 d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) //r *R:10 e d q //.d Trace^MI.MIF000(mi,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;1H\u0026lt;--M\u0026#34;) F j=1:1:10 R *R:1 I $c(R)=ack!($c(R)=enq) d .d Trace^MI.MIF000(mi,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;1H\u0026lt;--M\u0026#34;) I $c(R)=enq Q I $c(R)\u0026#39;=ack W eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q 发送数据 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 MIFNYSIMSend(mi) ; 7/17/14 ; ASTM protocol - 西门子流水线(MCR) s mi=$g(mi) i \u0026#39;$l(mi) q s ^TMPMACHDATA1(mi,11)=mi s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 //控制字符 s isDebug=1,iError=100 S stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4) S lf=$c(10),cr=$c(13),nak=$c(21),(result,epis)=\u0026#34;\u0026#34;,etb=$c(23) s ^TMPMACHDATA1(mi,10)=mi i $$Start^MI.MIF000(mi) q f d Main i $$Stop^MI.MIF000(mi) q s ^TMPMACH10(mi,50)=$h c Port q Main S $ZT=\u0026#34;RuntimeError\u0026#34;,$ECODE=\u0026#34;\u0026#34; //捕获运行时错误,并显示 r *R:10 e d q .D BUILD2 i $c(R)=enq d .s AllRecord=\u0026#34;\u0026#34; .d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) .d ACK .f r *R:10 q:$c(R)=eot d ..i $c(R)\u0026#39;=stx q ..s record=$$Read^MI.MIF000(mi,\u0026#34;\u0026#34;,lf) q:\u0026#39;$l(record) ..s record=$e(record,2,$l(record)-1) ..d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) ..i $l(record,etb)\u0026gt;1 s AllRecord=AllRecord_$p($e(record,1,$l(record)-1),etb,1) ..i $l(record,etx)\u0026gt;1 s AllRecord=AllRecord_$p($e(record,1,$l(record)-1),etx,1) ..;s AllRecord=AllRecord_$p(record,etb,1) ..;s AllRecord=AllRecord_$p(record,etx,1) ..d ACK .d Trace^MI.MIF000(mi,$s($c(R)=eot:\u0026#34;EOT\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) .i $c(R)=eot,$l(AllRecord) d ..s (mid,sample,epis,surname,rec,res,result,date,time,QC)=\u0026#34;\u0026#34; ..f i=1:1:$l(AllRecord,cr) d ...s rec=$p(AllRecord,cr,i) ...s type=$tr($p(rec,\u0026#34;|\u0026#34;),\u0026#34; \u0026#34;) ...i type=\u0026#34;H\u0026#34; d q ...i type=\u0026#34;M\u0026#34; d q ....s Intype=$tr($p($p(rec,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) ....s Inlabno=$tr($p($p(rec,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,2),\u0026#34; \u0026#34;) ....d Trace^MI.MIF000(mi,Inlabno,\u0026#34;Inlabno\u0026#34;) ....try{s ret=##class(MI.Special.AutomaticReceipt).ZDHS(mi,Inlabno)}catch{}\t//YHR 20230910 生化流水线自动核收 ....i Intype=\u0026#34;I\u0026#34; d .....i $l(Inlabno)=0 q .....q:\u0026#39;$d(^TEPI(Inlabno)) .....s temts=\u0026#34;\u0026#34; f s temts=$o(^TEPI(Inlabno,1,temts)) q:temts=\u0026#34;\u0026#34; d ......;q:\u0026#39;$d(^TMIF(mi,0,temts)) ......s temtscnt=\u0026#34;\u0026#34; f s temtscnt=$o(^TEPI(Inlabno,1,temts,temtscnt)) q:temtscnt=\u0026#34;\u0026#34; d .......s:$P(^TEPI(Inlabno,1,temts,temtscnt),\u0026#34;\\\u0026#34;,27)=\u0026#34;\u0026#34; $P(^TEPI(Inlabno,1,temts,temtscnt),\u0026#34;\\\u0026#34;,27)=mi .......s:$P(^TEPI(Inlabno,1,temts,temtscnt),\u0026#34;\\\u0026#34;,36)=\u0026#34;\u0026#34; $P(^TEPI(Inlabno,1,temts,temtscnt),\u0026#34;\\\u0026#34;,36)=$P(^TEPI(Inlabno,1,temts,temtscnt),\u0026#34;\\\u0026#34;,60) ...i type=\u0026#34;O\u0026#34; d q ....s epis=$tr($p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) ....s qcid=$tr($p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,2),\u0026#34; \u0026#34;) ....s qcid=$tr(qcid,\u0026#34;-\u0026#34;) ....s QCStat=$tr($p(rec,\u0026#34;|\u0026#34;,4),\u0026#34; \u0026#34;) ....s SpecStat=$tr($p(rec,\u0026#34;|\u0026#34;,6),\u0026#34; \u0026#34;) ....i SpecStat=\u0026#34;S\u0026#34; s epis=\u0026#34;E\u0026#34;_epis ....i QCStat=\u0026#34;Q\u0026#34; s QC=\u0026#34;\\\u0026#34;_qcid,epis=qcid ....s datex=$p(rec,\u0026#34;|\u0026#34;,23) ....s date=$e(datex,5,6)_\u0026#34;/\u0026#34;_$e(datex,7,8)_\u0026#34;/\u0026#34;_$e(datex,1,4),date=$$intdate^SSUTIL4(date) ....s time1=$e(datex,9,10)_\u0026#34;:\u0026#34;_$e(datex,11,12)_\u0026#34;:\u0026#34;_$e(datex,13,14),time1=$$inttime^SSUTIL4(time1) ...i type=\u0026#34;R\u0026#34; d q ....s code=$p($p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4),\u0026#34;/\u0026#34;,1) ....s flag=$p($p(rec,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,8) ....s mid1=$p(rec,\u0026#34;|\u0026#34;,14) ....i mid1\u0026#39;=\u0026#34;\u0026#34; s mid=mid1 ....s res=$p(rec,\u0026#34;|\u0026#34;,4) ....s ^Test(i)=res_\u0026#34;\\\u0026#34;_flag ....i mid1[\u0026#34;CentaurXP\u0026#34;,$l(code),$l(res) D .....i flag=\u0026#34;DOSE\u0026#34; d ......s result=result_code_$c(par10)_res_$c(par11) //....E D ....i $l(code),$l(res) D .....s result=result_code_$c(par10)_res_$c(par11) ... //i type=\u0026#34;L\u0026#34; d Last q D BUILD2 q Last\t; file result if exist s AllRecord=\u0026#34;\u0026#34; i time1=\u0026#34;\u0026#34; s time1=$p($h,\u0026#34;,\u0026#34;,2) s time=time1 S date=$P($H,\u0026#34;,\u0026#34;,1),time=$P($H,\u0026#34;,\u0026#34;,2) i $l(epis),$l(result) d Save^MI.MIF000(mi,epis,result,date,time,QC) q RuntimeError h 10 s iError=iError+1 d Trace^MI.MIF000(mi,\u0026#34;Error Code:\u0026#34;_$ECODE_\u0026#34;,Error:\u0026#34;_$ZERROR,\u0026#34;Runtime Error\u0026#34;) D:isDebug Log(mi,\u0026#34;Error Code:\u0026#34;_$ECODE_\u0026#34;,Error:\u0026#34;_$ZERROR) i iError\u0026gt;100 s ret=$$Stop^MI.MIF000(mi) Q ///CreateDate： 20140717 ///Description： 构建医嘱列表 ///Table DHC_LoadSpecimen ///Input：\t///Output： ///Return：\t///Others：DHCLoadSpecimen(0,\u0026#34;DateTime\u0026#34;,\u0026#34;TDMTS\u0026#34;,\u0026#34;C\u0026#34;,62301,42467,\u0026#34;T623010010\u0026#34;,\u0026#34;T101\u0026#34;,1) /// ^DHCLoadSpecimen({DHC_LoadSpecimen.DLSP_LabNo},{DHC_LoadSpecimen.DLSP_TS},{DHC_LoadSpecimen.DLSP_TSCNT},\u0026#34;TC\u0026#34;,{DLST_TestCode}) /// ^DHCLoadSpecimen({DLSP_LabNo},{DLSP_TS},{DLSP_TSCNT}) /// W $$BUILD2^DEBUG BUILD2 K ^TMP($zn,$j) s LabnoList=\u0026#34;\u0026#34; S AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d .s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) .s Labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) .;H 1 //每隔2S处理一个标本 .D:isDebug Log(mi,\u0026#34;BUILD2|labno=\u0026#34;_Labno) .S SIMAck=$$BUILD() .I SIMAck=0 D ..s err=##Class(MI.MachineUpload).SetSendFlag(mi,Labno,\u0026#34;S\u0026#34;,\u0026#34;\u0026#34;) .E D ..D:isDebug Log(mi,\u0026#34;BUILD2|Fail:labno=\u0026#34;_Labno) ..//Q:tryTimes\u0026lt;4 //失败3次才更新失败状态 ..s err=##Class(MI.MachineUpload).SetSendFlag(mi,Labno,\u0026#34;F\u0026#34;,\u0026#34;\u0026#34;) s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d .s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) .s Labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) .;H 1 //每隔2S处理一个标本 .D:isDebug Log(mi,\u0026#34;BUILD2|labno=\u0026#34;_Labno) .S SIMAck=$$BUILD() .I SIMAck=0 D ..s err=##Class(MI.MachineUpload).SetSendFlag(mi,Labno,\u0026#34;S\u0026#34;,\u0026#34;\u0026#34;) .E D ..D:isDebug Log(mi,\u0026#34;BUILD2|Fail:labno=\u0026#34;_Labno) ..//Q:tryTimes\u0026lt;4 //失败3次才更新失败状态 ..s err=##Class(MI.MachineUpload).SetSendFlag(mi,Labno,\u0026#34;F\u0026#34;,\u0026#34;\u0026#34;) ///老年医院流水线上传所有集中接收标本 //s Labno=\u0026#34;\u0026#34; f s Labno=$o(^DHCUploadAll(Labno)) Q:Labno=\u0026#34;\u0026#34; d //.s WorkGroupMachineDR=$g(^DHCUploadAll(Labno)) //.S SIMAck=$$SendSorting(WorkGroupMachineDR) //.I SIMAck\u0026#39;=0 s ^DHCUploadAllBAK(\u0026#34;F\u0026#34;,Labno)=^DHCUploadAll(Labno) //.e s ^DHCUploadAllBAK(\u0026#34;S\u0026#34;,Labno)=^DHCUploadAll(Labno) //.s ^DHCUploadAllBAK(\u0026#34;B\u0026#34;,Labno)=^DHCUploadAll(Labno) //.k ^DHCUploadAll(Labno) Q JudgeUrgent d Trace^MI.MIF000(mi,urgent,\u0026#34;urgentJu\u0026#34;) i urgent=1 d .s urgent=\u0026#34;S\u0026#34; .d Trace^MI.MIF000(mi,urgent,\u0026#34;urgentJUS\u0026#34;) e d .s urgent=\u0026#34;R\u0026#34; BUILD() S episx=Labno,Labno=$P(Labno,\u0026#34;-\u0026#34;,1),suffix=\u0026#34;\u0026#34;,RetAck=1 S (surn,givn,sex,dob,date,urno,age,loc)=\u0026#34;\u0026#34; s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q s VisitNumberData = $g(^dbo.RPVisitNumberD(VisitNumberDR)) S urno=$p(urno,$c(1),1) I givn=surn s givn=\u0026#34;\u0026#34; s SName=$lg(VisitNumberData,13) s GName=$lg(VisitNumberData,13) S diag=$lg(VisitNumberData,28) ;;; 诊断 S SpecType=$$GetSpecType(VisitNumberDR) ;;; 标本 s debtor=$lg(VisitNumberData,3) ;登记号 s admtype=$lg(VisitNumberData,4) ;就诊类型 s urgent=$lg(VisitNumberData,50) ;是否加急 d Trace^MI.MIF000(mi,urgent,\u0026#34;urgent\u0026#34;) D JudgeAdmType D JudgeUrgent s SpeciesDR = $lg(VisitNumberData,15) //s Species = $s($l(SpeciesDR):$lg(^dbo.BTSpeciesD(SpeciesDR),3),1:\u0026#34;\u0026#34;) s Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$LG($G(^dbo.BTSpeciesD(SpeciesDR)),2) ;性别 ;S Species=SpeciesDR ;性别 s DOB= $lg(VisitNumberData,16) ;出生日期 ;s DOB=\u0026#34;20000202\u0026#34; s LocationDR = $lg(VisitNumberData,22) s Location = $s($l(LocationDR):$lg($g(^dbo.BTLocationD(LocationDR)),3),1:\u0026#34;\u0026#34;) s Loc=Location ;科室 s TSName=\u0026#34;\u0026#34; //多条医嘱信息合并 s TSName = \u0026#34;\u0026#34; s TestSetDR = \u0026#34;\u0026#34; for { s TestSetDR = $o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; i $l(TSName) s TSName=TSName_\u0026#34;+\u0026#34;_$lg($g(^dbo.BTTestSetD(TestSetDR)),3) e s TSName=$lg(^dbo.BTTestSetD(TestSetDR),3) } d ScanOne^MI.MIF000(mi,Labno) ;创建上传化验项目列表 i \u0026#39;$D(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,Labno)) q 1 S tcx=\u0026#34;\u0026#34; S chl=\u0026#34;\u0026#34; F S chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,Labno,chl)) Q:chl=\u0026#34;\u0026#34; D .S tcx=tcx_\u0026#34;^^^\u0026#34;_chl_\u0026#34;^^^0\\\u0026#34; S tcx=$e(tcx,1,$L(tcx)-1) I \u0026#39;$L(tcx) S tcx=\u0026#34;^^^^^^0\u0026#34; S date=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) S time=$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;) S temepis=\u0026#34;\u0026#34; ;H|\\^\u0026amp;|||BSLIS^V3.00|||||||P|1\u0026lt;CR\u0026gt; S str=\u0026#34;H|\\^\u0026amp;|||BSLIS^V3.00|||||host|TSDWN^REPLY|P|1\u0026#34;_cr ;头信息 ;P|1|0010332409|0010332409||Doe^JohnlSmith||19150826|F|||||||||||||||||5500|||||||||\u0026lt;CR\u0026gt; //S str=str_\u0026#34;P|1|\u0026#34;_debtor_\u0026#34;|\u0026#34;_cr ;病人信息 s SName=##class(OTH.DHCINSUPort).GetPinYingCode(SName) S str=str_\u0026#34;P|1|\u0026#34;_debtor_\u0026#34;|||\u0026#34;_SName_\u0026#34;^^^||\u0026#34;_DOB_\u0026#34;|\u0026#34;_Species_\u0026#34;|||||||||||||||||\u0026#34;_Loc_\u0026#34;|||||||||\u0026#34;_cr ;病人信息 I Labno=\u0026#34;N\u0026#34; s Labno=\u0026#34;\u0026#34; ;O|1|112448100||^^^TP^^^0\\^^^ALB^^^0|R||20110826112206||||N|hep|lipemic||Serum||||||||||Q\u0026lt;CR\u0026gt; ;s SpecType=\u0026#34;Serum\u0026#34;\t//YHR 设置空白的为血类型 S str=str_\u0026#34;O|1|\u0026#34;_Labno_\u0026#34;||\u0026#34;_tcx_\u0026#34;|\u0026#34;_urgent_\u0026#34;||\u0026#34;_date_time_\u0026#34;||||A|hep|lipemic||\u0026#34;_SpecType_\u0026#34;|||\u0026#34;_TSName_\u0026#34;|\u0026#34;_admtype_\u0026#34;||||||\u0026#34; S str=str_\u0026#34;Q\u0026#34;_cr ;4L|1\u0026lt;CR\u0026gt; S str=str_\u0026#34;L|1|\u0026#34; S RetAck=$$Send(Labno,str) K ^TMIF(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,Labno) Q RetAck JudgeAdmType i admtype=1 s admtype=2 i admtype=2 s admtype=1 i admtype=8 s admtype=3 SendSorting(WorkGroupMachineDR) S episx=Labno,Labno=$P(Labno,\u0026#34;-\u0026#34;,1),suffix=\u0026#34;\u0026#34;,RetAck=1 S (surn,givn,sex,dob,date,urno,age,loc)=\u0026#34;\u0026#34; s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q s VisitNumberData = $g(^dbo.RPVisitNumberD(VisitNumberDR)) S urno=$p(urno,$c(1),1) I givn=surn s givn=\u0026#34;\u0026#34; s admtype=$lg(VisitNumberData,4) ;就诊类型 D JudgeAdmType s urgent=$lg(VisitNumberData,50) ;是否加急 D JudgeUrgent s SName=$lg(VisitNumberData,13) s GName=$lg(VisitNumberData,13) S diag=$lg(VisitNumberData,28) ;;; 诊断 S SpecType=$$GetSpecType(VisitNumberDR) ;;; 标本 s debtor=$lg(VisitNumberData,3) ;登记号 s SpeciesDR = $lg(VisitNumberData,15) //s Species = $s($l(SpeciesDR):$lg(^dbo.BTSpeciesD(SpeciesDR),3),1:\u0026#34;\u0026#34;) s Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$LG($G(^dbo.BTSpeciesD(SpeciesDR)),2) ;性别 s TSName = \u0026#34;\u0026#34; ;S Species=SpeciesDR ;性别 s DOB= $lg(VisitNumberData,16) ;出生日期 s LocationDR = $lg(VisitNumberData,22) s Location = $s($l(LocationDR):$lg($g(^dbo.BTLocationD(LocationDR)),3),1:\u0026#34;\u0026#34;) s Loc=Location ;科室 s TSName=\u0026#34;\u0026#34; //多条医嘱信息合并 s TestSetDR = \u0026#34;\u0026#34; for { s TestSetDR = $o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; i $l(TSName) s TSName=TSName_\u0026#34;+\u0026#34;_$lg($g(^dbo.BTTestSetD(TestSetDR)),3) e s TSName=$lg(^dbo.BTTestSetD(TestSetDR),3) } S tcx=\u0026#34;\u0026#34;,chl=\u0026#34;Sorting\u0026#34;_WorkGroupMachineDR S tcx=tcx_\u0026#34;^^^\u0026#34;_chl_\u0026#34;^^^0\\\u0026#34; S date=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) S time=$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;) S temepis=\u0026#34;\u0026#34; ;H|\\^\u0026amp;|||BSLIS^V3.00|||||||P|1\u0026lt;CR\u0026gt; S str=\u0026#34;H|\\^\u0026amp;|||BSLIS^V3.00|||||host|TSDWN^REPLY|P|1\u0026#34;_cr ;头信息 ;P|1|0010332409|0010332409||Doe^JohnlSmith||19150826|F|||||||||||||||||5500|||||||||\u0026lt;CR\u0026gt; //S str=str_\u0026#34;P|1|\u0026#34;_debtor_\u0026#34;|\u0026#34;_cr ;病人信息 S str=str_\u0026#34;P|1|\u0026#34;_debtor_\u0026#34;|||\u0026#34;_SName_\u0026#34;^\u0026#34;_GName_\u0026#34;^^||\u0026#34;_DOB_\u0026#34;|\u0026#34;_Species_\u0026#34;|||||||||||||||||\u0026#34;_Loc_\u0026#34;|||||||||\u0026#34;_cr ;病人信息 I Labno=\u0026#34;N\u0026#34; s Labno=\u0026#34;\u0026#34; ;O|1|112448100||^^^TP^^^0\\^^^ALB^^^0|R||20110826112206||||N|hep|lipemic||Serum||||||||||Q\u0026lt;CR\u0026gt; ;s SpecType=\u0026#34;Serum\u0026#34; S str=str_\u0026#34;O|1|\u0026#34;_Labno_\u0026#34;||\u0026#34;_tcx_\u0026#34;|\u0026#34;_urgent_\u0026#34;||\u0026#34;_date_time_\u0026#34;||||A|hep|lipemic||\u0026#34;_SpecType_\u0026#34;|||\u0026#34;_TSName_\u0026#34;|\u0026#34;_admtype_\u0026#34;||||||\u0026#34; S str=str_\u0026#34;Q\u0026#34;_cr ;4L|1\u0026lt;CR\u0026gt; S str=str_\u0026#34;L|1|\u0026#34; S RetAck=$$Send(Labno,str) Q RetAck Send(epis,str) ; send list of orders if exists W enq,*-3 d Trace^MI.MIF000(mi,\u0026#34;ENQ\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) S ret=1 F j=1:1:10 R *R:1 I $c(R)=ack!($c(R)=enq) Q d Trace^MI.MIF000(mi,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;1H\u0026lt;--M\u0026#34;) I $c(R)=enq Q ret I $c(R)\u0026#39;=ack W eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) Q ret F i=1:1:$L(str,cr) D .S temstr=$P(str,cr,i) .S temstr=i_temstr .I i=3,$L(temstr)\u0026gt;247 D ..S str1=$e(temstr,1,241) ..S ret=$$SEND(str1,1) ..s str2=i+1_$e(temstr,242,482) ..S ret=$$SEND(str2,1) ..s str2=i+1_$e(temstr,483,$l(temstr)) ..S ret=$$SEND(str2,0) ..S i=i+1 ..s temstr=$P(str,cr,4) ..S temstr=i+1_temstr ..S ret=$$SEND(temstr,0) .E D ..S ret=$$SEND(temstr,0) W eot,*-3 d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) Q ret SEND(str,flag) ; send string to instrument i flag=1 d .s str=str_etb .s chsum=$$CHSUM(str) e d .s str=str_cr_etx .s chsum=$$CHSUM(str) W stx,str,chsum,cr,lf,*-3 d Trace^MI.MIF000(mi,stx_str_chsum_cr_lf,\u0026#34;H--\u0026gt;M\u0026#34;) F j=1:1:6 R *R:1 I ($c(R)=ack)!($c(R)=eot) Q I $c(R)=ack d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) Q 0 I $c(R)=eot d Trace^MI.MIF000(mi,\u0026#34;EOT\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) Q 0 I $c(R)=-1 W nak,*-3 d Trace^MI.MIF000(mi,R,\u0026#34;H\u0026lt;--M\u0026#34;) Q 1 CHSUM(x) ; calculate check sum n (x) s z=0 f y=1:1:$l(x) s z=z+$a(x,y) s z=$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#256\\16+1)_$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#16+1) q z ACK ; send \u0026#39;ack\u0026#39; to instrument w ack,*-3 d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q NEXTTRAY(tray) q tray /// GetSpecType(VisitNumberDR) s VisitNumberDR=$g(VisitNumberDR) ;s RetVal=\u0026#34;SE\u0026#34; s RetVal=\u0026#34;Serum\u0026#34; s SpecimenDR = $lg(^dbo.RPVisitNumberD(VisitNumberDR),56) s SpecimenName = $s($l(SpecimenDR):$lg($g(^dbo.BTSpecimenD(SpecimenDR)),3),1:\u0026#34;\u0026#34;) i SpecimenName[\u0026#34;血\u0026#34; s RetVal=\u0026#34;Serum\u0026#34; i SpecimenName[\u0026#34;尿\u0026#34; s RetVal=\u0026#34;Urine\u0026#34; i SpecimenName[\u0026#34;血浆\u0026#34; s RetVal=\u0026#34;Plasma\u0026#34;\t//YHR 20230929 增加血浆代码 q RetVal Log(mi,info) N (mi,info) S mi=$G(mi),info=$G(info) Q:\u0026#39;$L(mi) 1 Q:\u0026#39;$D(^TMIF(mi)) 1 d Trace^MI.MIF000(mi,info,\u0026#34;DEBUG\u0026#34;) S curDate=$P($H,\u0026#34;,\u0026#34;,1),curTime=$P($H,\u0026#34;,\u0026#34;,2) S ^TMPSIMENS(mi,curDate,curTime)=info Q 0 通过数据库主动上传 ODBC连接数据库回插数据 示例代码(DL96A) 通过数据库连接，在QryLabInfo中拼串sql语句.Insert into liscontroller.lis_application (SPEC_NUM,BTBarcode,ASTBarcode,PATIENT_ID,MSPosition,PatientNo,FULL_NAME,FIRST_NAME,LAST_NAME,Birth,AGE,SEX,Purpose,WARD,Specimen,BedNo,Diagnosis,SpRequest,Medication,SuspectedBact,Doctor,AdviceNo,ApplyDate,SendDate,Collector,SPEC_DATE,CollectPosition,IdResult,Updated,UpdateDate,CARSS_ReadDate,StainType,StructVersion) values\n\u0026hellip;//(\u0026lsquo;9999\u0026rsquo;,\u0026lsquo;NULL\u0026rsquo;,\u0026lsquo;NULL\u0026rsquo;,\u0026lsquo;199732\u0026rsquo;,\u0026lsquo;NULL\u0026rsquo;,\u0026rsquo; \u0026lsquo;,\u0026lsquo;测试\u0026rsquo;,\u0026lsquo;NULL\u0026rsquo;,\u0026lsquo;NULL\u0026rsquo;,\u0026rsquo;\u0026rsquo;,\u0026lsquo;85y\u0026rsquo;,\u0026lsquo;f\u0026rsquo;,\u0026lsquo;普通细菌培养+药敏\u0026rsquo;,\u0026lsquo;三病室\u0026rsquo;,\u0026lsquo;痰\u0026rsquo;,\u0026lsquo;3\u0026rsquo;,\u0026rsquo; \u0026lsquo;,\u0026rsquo; \u0026lsquo;,\u0026rsquo; \u0026lsquo;,\u0026rsquo; \u0026lsquo;,\u0026lsquo;刘云\u0026rsquo;,\u0026rsquo; \u0026lsquo;,\u0026lsquo;NULL\u0026rsquo;,\u0026lsquo;2024/6/28 9:17\u0026rsquo;,\u0026lsquo;谢艳红\u0026rsquo;,\u0026lsquo;2024/6/29 11:17\u0026rsquo;,\u0026rsquo; \u0026lsquo;,\u0026lsquo;NULL\u0026rsquo;,\u0026lsquo;0\u0026rsquo;,\u0026lsquo;NULL\u0026rsquo;,\u0026lsquo;NULL\u0026rsquo;,\u0026lsquo;NULL\u0026rsquo;,\u0026lsquo;NULL\u0026rsquo;)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;DataBase\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;DSN=DL96A\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFDL96A\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;SELECT * FROM lis_result WHERE DATE(UpdateDate) = CURDATE()#ID#\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;}] /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;DataBase\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;DSN=DL96a\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFDL96A2\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;SELECT * FROM lis_result WHERE DATE(UpdateDate) = CURDATE()#ID#\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;}] Class MI.MIFDL96A Extends %RegisteredObject { // D ##class(MI.MIFDL96E02).fileMTHD(\u0026#34;22\u0026#34;,\u0026#34;4185~33122416~~~□肺炎链球菌(S.pneumoniae)□G+球菌□□[spn]□(优势菌2)~~~~~A;PEN;;＝8;耐药;;B;CLI;;≥8;耐药;;A;SXT;;≥8/152;耐药;;B;CRO;;＝1;敏感;;A;ERY;;≥16;耐药;;B;VA;;≤1;敏感;;B;LEV;;＝2;敏感;;B;TET;;＝32;耐药;;B;MRP;;≤0.25;敏感;;C;CXM;;≥4;耐药;;C;RIF;;≤0.5;敏感;;C;AMC;;≤1.0/0.5;敏感;;C;LNZ;;≤2;敏感;;~~~~~对左氧氟沙星敏感的菌株可预报其对吉米沙星和莫西沙星敏感。[13][10]对四环素敏感的菌株对多西环素和米诺环素也敏感。[13][10]利福平不单独用于抗菌治疗。[13][10]红霉素可预报阿奇霉素、克拉霉素和地红霉素的敏感和耐药性。[13][10]~~~~普通细菌培养+药敏~2020-12-25□8:33:23~2020-12-27□8:33:23~1~\u0026#34;,\u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;) ClassMethod fileMTHD(mi, record, epis, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q i \u0026#39;$l(record) q s ItemDeli=$c(92) //项目分隔符92 s ResultDeli=$c(44) //结果分隔符44 s AntDeli=\u0026#34;]\u0026#34; //抗生素分隔符] s SenDeli=\u0026#34;[\u0026#34; //药敏结果分隔符[ d Trace^MI.MIF000(mi,record,\u0026#34;record\u0026lt;--M\u0026#34;) s (sample,epis,surname,rec,res,fresult,date,time,QC,xBugs,AntLIST,expertRules)=\u0026#34;\u0026#34; //处理阴性结果 s epis=$tr($p(record,\u0026#34;~\u0026#34;,3),\u0026#34; \u0026#34;) s code=1 //7417~6987~3259~I-01,2E10405500,*□|~I-01,2E10405500,*□|~~□,I-01,2E10405500,大肠埃希菌(Escherichia□Coli),eco,-,0,□|~~I-01,2E10405500,DL-120□E2,eco,AMP,≥32μg/ml,A,R,≤8\u0026amp;16\u0026amp;≥32,Y|I-01,2E10405500,DL-120□E2,eco,GEN,≤1μg/ml,A,S,≤2\u0026amp;4\u0026amp;≥8,Y|I-01,2E10405500,DL-120□E2,eco,SAM,16/8μg/ml,B,I,≤8/4\u0026amp;16/8\u0026amp;≥32/16,Y|I-01,2E10405500,DL-120□E2,eco,TZP,≤4/4μg/ml,B,S,≤16/4\u0026amp;32/4-64/4\u0026amp;≥128/4,Y|I-01,2E10405500,DL-120□E2,eco,CSL,≤8/4μg/ml,O,S,≤16/8\u0026amp;32/16\u0026amp;≥64/32,Y|I-01,2E10405500,DL-120□E2,eco,CCV,≤1/4μg/ml,□,□,□\u0026amp;□\u0026amp;□,Y|I-01,2E10405500,DL-120□E2,eco,CTC,≤1/4μg/ml,□,□,□\u0026amp;□\u0026amp;□,Y|I-01,2E10405500,DL-120□E2,eco,CZO,≤2μg/ml,A,S,≤2\u0026amp;4\u0026amp;≥8,Y|I-01,2E10405500,DL-120□E2,eco,FEP,≤0.12μg/ml,B,S,≤2\u0026amp;4-8\u0026amp;≥16,Y|I-01,2E10405500,DL-120□E2,eco,FOX,≤8μg/ml,B,S,≤8\u0026amp;16\u0026amp;≥32,Y|I-01,2E10405500,DL-120□E2,eco,CXM,≤4μg/ml,B,S,≤8\u0026amp;16\u0026amp;≥32,Y|I-01,2E10405500,DL-120□E2,eco,CXM,≤4μg/ml,B,S,≤4\u0026amp;8-16\u0026amp;≥32,Y|I-01,2E10405500,DL-120□E2,eco,LVX,≤0.12μg/ml,B,S,≤0.5\u0026amp;1\u0026amp;≥2,Y|I-01,2E10405500,DL-120□E2,eco,SXT,≥8/152μg/ml,B,R,≤2/38\u0026amp;□\u0026amp;≥4/76,Y|I-01,2E10405500,DL-120□E2,eco,CTX,≤0.12μg/ml,B,S,≤1\u0026amp;2\u0026amp;≥4,Y|I-01,2E10405500,DL-120□E2,eco,IPM,≤0.25μg/ml,B,S,≤1\u0026amp;2\u0026amp;≥4,Y|I-01,2E10405500,DL-120□E2,eco,CAZ,≤0.5μg/ml,C,S,≤4\u0026amp;8\u0026amp;≥16,Y|I-01,2E10405500,DL-120□E2,eco,CHL,≤8μg/ml,C,S,≤8\u0026amp;16\u0026amp;≥32,Y|I-01,2E10405500,DL-120□E2,eco,MEM,≤0.06μg/ml,B,S,≤1\u0026amp;2\u0026amp;≥4,Y|I-01,2E10405500,DL-120□E2,eco,AMK,≤4μg/ml,B,S,≤4\u0026amp;8\u0026amp;≥16,Y|I-01,2E10405500,DL-120□E2,eco,NIT,≤16μg/ml,U,S,≤32\u0026amp;64\u0026amp;≥128,Y|I-01,2E10405500,DL-120□E2,eco,ETP,≤0.015μg/ml,B,S,≤0.5\u0026amp;1\u0026amp;≥2,Y|I-01,2E10405500,DL-120□E2,eco,MNO,≤1μg/ml,O,S,≤4\u0026amp;8\u0026amp;≥16,Y|I-01,2E10405500,DL-120□E2,eco,TGC,≤0.25μg/ml,□,S,≤1\u0026amp;2\u0026amp;\u0026gt;2,Y|I-01,2E10405500,DL-120□E2,eco,POL,≤1μg/ml,O,I,□\u0026amp;≤2\u0026amp;≥4,Y|I-01,2E10405500,DL-120□E2,eco,AZM,≤8μg/ml,□,R,□\u0026amp;□\u0026amp;□,Y|~I-01,2E10405500,MDR|~I-01,2E10405500*MDR：多重耐药菌株。*头孢西丁的折点基于至少8g□qd的给药方案。*头孢吡肟的敏感折点基于1g□q12h的给药方案。*亚胺培南的折点基于500mg□q6h或1g□q8h的给药方案。*厄他培南的折点基于1g□qd的给药方案。*多黏菌素B应与一种或多种活性抗生素联合使用，建议咨询感染诊治专家。*头孢呋辛（注射）的折点基于1.5g□q8h的给药方案。*氨苄西林的结果可用于预报阿莫西林的敏感性。*环丙沙星折点基于静脉注射400mg□q12h或口服500mg□q12h给药方案。*多黏菌素B应给予负荷剂量和最大推荐剂量。*治疗非复杂泌尿道以外感染的头孢唑林折点是基于2g□q8h的给药方案。*头孢噻肟的折点基于1g□q8h的给药方案。*美罗培南的折点基于1g□q8h的给药方案。*对于肺炎即使黏菌素或多黏菌素B全身给药，亦很可能无效。*此报告采用的折点标准来源为CLSIM100□2023，其中替加环素为EUCAST□2018，头孢哌酮/舒巴坦为CHINET技术要求□2022，哌拉西林/他唑巴坦为CLSIM100□2021。|~~~~~I-01,2E10405500,2024-04-23□09:56:15|~~~1~2024-04-23□10:53:54~□~□,I-01,2E10405500,大肠埃希菌(Escherichia□Coli),eco,G-杆菌,0,□|~I-01,2E10405500,MDR|~~~~ ///□,I-01,2E10405500,大肠埃希菌(Escherichia□Coli),eco,-,0,□| ///7602~0~4786~~~~~,A2,兽类气单胞菌(Aeromonas□bestiarum),□,44.12,□,aer,□,0,□|~~~~~~~~~~~1~2024-06-06□16:29:22~~□,□,4786+A2,兽类气单胞菌(Aeromonas□bestiarum),aer,-,0,□|~~~~~ //s xBugs=$p($p($p(record,\u0026#34;~\u0026#34;,7),\u0026#34;,\u0026#34;,4),\u0026#34;(\u0026#34;,1) s xBugs=$p($p(record,\u0026#34;~\u0026#34;,7),\u0026#34;,\u0026#34;,5) i $l(xBugs)\u0026gt;6 s xBugs=$p($p(record,\u0026#34;~\u0026#34;,9),\u0026#34;,\u0026#34;,4) d Trace^MI.MIF000(mi,xBugs,\u0026#34;xBugs\u0026#34;) s antStr=$p(record,\u0026#34;~\u0026#34;,9) s expertRules=$p($p($p(record,\u0026#34;~\u0026#34;,11),\u0026#34;*\u0026#34;,2,*),\u0026#34;|\u0026#34;,1) //s expertRules=$replace(expertRules,\u0026#34;*\u0026#34;,\u0026#34;$r$n\u0026#34;) d Trace^MI.MIF000(mi,expertRules,\u0026#34;expertRules\u0026#34;) i expertRules[\u0026#34;*\u0026#34; s expertRules=..RExpertRules(expertRules) s ^DL96A(\u0026#34;ZJGZ\u0026#34;,+$h,epis,code)=expertRules f i=1:1:$l(antStr,\u0026#34;|\u0026#34;) d .//I-01,2E10405500,DL-120□E2,eco,AMP,≥32μg/ml,A,R,≤8\u0026amp;16\u0026amp;≥32,Y .//I-2565,2R10131374,DL-120□STREP3,efa,AMP,=0.5μg/mL,A,S,≤8\u0026amp;□\u0026amp;≥16,Y .//efa,AMP,=0.5μg/mL,A,S,≤8\u0026amp;□\u0026amp;≥16,Y|I-2565,2R10131374,DL-120□STREP3, .s antList=$p(antStr,\u0026#34;|\u0026#34;,i) .s AntGroup=$p(antList,\u0026#34;,\u0026#34;,7) //抗生素分组 .s xANT=$tr($p(antList,\u0026#34;,\u0026#34;,5),\u0026#34; \u0026#34;) q:xANT=\u0026#34;\u0026#34; //抗生素 .s xMIC=$tr($p(antList,\u0026#34;,\u0026#34;,6),\u0026#34;μg/ml \u0026#34;) //MIC .s xRES=$tr($p(antList,\u0026#34;,\u0026#34;,8),\u0026#34; \u0026#34;) //耐药 .i xRES=\u0026#34;\u0026#34; s xRES=\u0026#34;/\u0026#34; .s AntLIST=AntLIST_xANT_AntDeli_xRES_AntDeli_xMIC_AntDeli_AntDeli_AntGroup_SenDeli d Trace^MI.MIF000(mi,AntLIST,\u0026#34;AntLIST\u0026lt;--M\u0026#34;) i $l(xBugs),$l(epis),$l(AntLIST) d .s fresult=xBugs_ItemDeli_AntLIST_ItemDeli_code_ResultDeli d Trace^MI.MIF000(mi,fresult,\u0026#34;fresult\u0026lt;--M\u0026#34;) i \u0026#39;$l(fresult) q 0 i \u0026#39;$l(epis) q 0 d Save^MI.MIF000(mi,epis,code_ItemDeli_xBugs_ItemDeli_ItemDeli_ItemDeli_ResultDeli,date,time,QC) d SaveAnt^MI.MIF000(mi,epis,fresult,date,time,QC) //h 3 //s ret=..SaveZJGZ(epis, mi, 1, expertRules) //对于专家规则在同表的，保证药敏结果先存生成报告，再存专家规则 0704 //d Trace^MI.MIF000(mi,ret,\u0026#34;专家规则保存ret\u0026#34;) s (fresult,date,time,QC,AntLIST)=\u0026#34;\u0026#34; q \u0026#34;\u0026#34; } /// w ##class(MI.MIFDL96A2).RExpertRules(\u0026#34;sadsa*da*dasds*sad \u0026#34;) /// 20240802 格式化专家规则 ClassMethod RExpertRules(expertRules As %String) As %String { s expertRules=$g(expertRules) i expertRules[\u0026#34;*\u0026#34; d .s expertRules=\u0026#34;1、\u0026#34;_expertRules .f i=2:1:$l(expertRules,\u0026#34;*\u0026#34;) d ..s expertRules=$p(expertRules,\u0026#34;*\u0026#34;,1)_\u0026#34; \u0026#34;_i_\u0026#34;、\u0026#34;_$p(expertRules,\u0026#34;*\u0026#34;,2,*) q expertRules } /// 保存专家规则 /// 20240704 /// w ##class(MI.MIFDL96A2).SaveZJGZ(\u0026#34;6633\u0026#34;,\u0026#34;40\u0026#34;,1,\u0026#34;多黏菌素B应与一种或多种活性抗生素联合使用，建议咨询感染诊治专家。*头孢噻肟的折点基于1g□q8h的给药方案。*亚胺培南的折点基于500mg□q6h或1g□q8h的给药方案。*美罗培南的折点基于1g□q8h的给药方案。*头孢唑啉的结果可预报非复杂性的泌尿系统感染的大肠埃希菌对口服头孢拉定、头孢地尼、头孢克罗、头孢丙烯、头孢泊肟、头孢呋辛的敏感性。*头孢西丁的折点基于至少8g□qd的给药方案。*仅肠沙门菌伤寒血清型和志贺菌属具有阿奇霉素的临床推荐折点。*氨苄西林的结果可用于预报阿莫西林的敏感性。*环丙沙星折点基于静脉注射400mg□q12h或口服500mg□q12h给药方案。*头孢吡肟的敏感折点基于1g□q12h的给药方案。*头孢呋辛（注射）的折点基于1.5g□q8h的给药方案。*治疗非复杂泌尿道感染的头孢唑林折点是基于1g□q12h的给药方案。*治疗非复杂泌尿道以外感染的头孢唑林折点是基于2g□q8h的给药方案。*多黏菌素B应给予负荷剂量和最大推荐剂量。*厄他培南的折点基于1g□qd的给药方案。*对于肺炎即使黏菌素或多黏菌素B全身给药，亦很可能无效。\u0026#34;) ClassMethod SaveZJGZ(epis, mi, isolate, ExpertRules) { s ^GYN(\u0026#34;Rule\u0026#34;,epis)=$lb(epis, mi, isolate, ExpertRules) //TestCodeDR 细菌一，细菌二，细菌三 570,586,575 s epis=$g(epis),mi=$g(mi),ExpertRules=$g(ExpertRules) s TestCodeDR=\u0026#34;\u0026#34; i isolate=1 s TestCodeDR=261 i \u0026#39;$l(mi) q 0 i \u0026#39;$l(epis) d Trace^MI.MIF000(mi,\u0026#34;流水号不能为空\u0026#34;,\u0026#34;保存检测结论返回\u0026#34;) q 0 //报告可能核收到微生物培养的四个小组 s WGM=\u0026#34;\u0026#34; i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,15,\u0026#34; \u0026#34;_epis)) s WGM=15 i \u0026#39;$l(WGM) q 0 s sc=0 s transmitDate=\u0026#34;\u0026#34; f s transmitDate=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGM,\u0026#34; \u0026#34;_epis,transmitDate)) q:transmitDate=\u0026#34;\u0026#34; d .s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGM,\u0026#34; \u0026#34;_epis,transmitDate,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d ..//IndexReportItem On (VisitNumberReportDR, TestCodeDR) ..i \u0026#39;$d(^dbo.RPVisitNumberReportResultI(\u0026#34;IndexReportItem\u0026#34;,ReportDR,TestCodeDR)) q ..s ResultDR=$o(^dbo.RPVisitNumberReportResultI(\u0026#34;IndexReportItem\u0026#34;,ReportDR,TestCodeDR,\u0026#34;\u0026#34;)) ..s objRep=##Class(dbo.RPVisitNumberReportResult).%OpenId(ResultDR) ..s EXPRlues=objRep.ExpertRule ..i EXPRlues=ExpertRules q //专家规则不再变化，不存 ..s objRep.ExpertRule=ExpertRules ..s sc=objRep.%Save() ..i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d Trace^MI.MIF000(mi,\u0026#34;保存检测结论失败\u0026#34;,\u0026#34;保存检测结论失败返回\u0026#34;) q ..d Trace^MI.MIF000(mi,ExpertRules,\u0026#34;保存检测结论成功返回\u0026#34;) q sc } // D ##class(MI.MIFDL96E02).SaveExpertRules(\u0026#34;26\u0026#34;, \u0026#34;52772\u0026#34;,\u0026#34;ceshi\u0026#34;, \u0026#34;1\u0026#34;) ClassMethod SaveExpertRules(mi, epis, expertRules, code, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) s expertRules=$g(expertRules) s code=$g(code) s (WorkGroupMachineDR,AcceptDate,ReportDr,TestCodeDR,ReportResultDR,CodeDR)=\u0026#34;\u0026#34; s WorkGroupMachineDR=$lg(^dbo.BTMIMachineParameterD(mi),6) //b ;1 s AcceptDate=\u0026#34;\u0026#34; f s AcceptDate=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexAcceptDate\u0026#34;,WorkGroupMachineDR,AcceptDate)) q:AcceptDate=\u0026#34;\u0026#34; d .s ReportDr=\u0026#34;\u0026#34; f s ReportDr=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexAcceptDate\u0026#34;,WorkGroupMachineDR,AcceptDate,##Class(LIS.Util.Common).IndexData(epis),ReportDr)) q:ReportDr=\u0026#34;\u0026#34; d ..s TestCodeDR=\u0026#34;\u0026#34; f s TestCodeDR=$o(^dbo.RPVisitNumberReportResultI(\u0026#34;IndexReportItem\u0026#34;,ReportDr,TestCodeDR)) q:TestCodeDR=\u0026#34;\u0026#34; d ...s ReportResultDR=\u0026#34;\u0026#34; f s ReportResultDR=$o(^dbo.RPVisitNumberReportResultI(\u0026#34;IndexReportItem\u0026#34;,ReportDr,TestCodeDR,ReportResultDR)) q:ReportResultDR=\u0026#34;\u0026#34; d ....s CodeDR=$lg(^dbo.RPVisitNumberReportResultD(ReportResultDR),3) ....b ;3 ....i (code+655=CodeDR) d .....//b ;2 .....s obj=##Class(dbo.RPVisitNumberReportResult).%OpenId(ReportResultDR) .....s obj.ExpertRule=expertRules .....s ret=obj.%Save() q \u0026#34;\u0026#34; } /// D ##class(MI.MIFLISMonitorTest)SaveImageMTHD(\u0026#34;7\u0026#34;,\u0026#34;9999\u0026#34;, \u0026#34;\u0026#34;,\u0026#34;175\u0026#34;) /// mi:仪器 /// epis：流水号，如果是监听图片模式该位置放图片名称，自己在保存前提取流水 /// ImageClass:图片类别，如果是监听图片模式该位置放图片名称，自己在保存前提取图片类型 /// FileName:保存在文件服务的相对路径，默认不动 /// FullName:文件全路径，如果是监听图片模式该位置放图片全路径名称，满足有的图片名称无法得到流水和图片类别的情况 ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, FullName, SaveImageRetName, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //通过OtherPara配置取图的在这里通过epis和ImageClass的图片名字提取出流水号和图片类别 s mi=$g(mi) s epis=$g(epis) s ImageClass=$g(ImageClass) s FileName=$g(FileName) s FullName=$g(FullName) s SaveImageRetName=$g(SaveImageRetName) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; d ##Class(MI.Common.MIFBase).Trace(mi,epis_\u0026#34;:\u0026#34;_ImageClass_\u0026#34;:\u0026#34;_FileName,\u0026#34;H\u0026lt;--M\u0026#34;) s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=\u0026#34;\u0026#34; //加上当前时间，防止浏览器缓存 s FileName=FileName_\u0026#34;?\u0026#34;_$p($h,\u0026#34;,\u0026#34;,2) //OtherPara用^分隔第四位指定SaveImageRetName的话在这里改FileName为新名称。同时让方法返回新图片名字 s NewFileName=\u0026#34;\u0026#34; i SaveImageRetName=\u0026#34;SaveImageRetName\u0026#34; d .//图片新名字 .;s NewFileName=epis_\u0026#34;-\u0026#34;_ImageClass_\u0026#34;-\u0026#34; .//路径新名字 .s NewPathName=\u0026#34;\u0026#34; .s SPLen=$l(FileName,\u0026#34;/\u0026#34;) .f ii=1:1:SPLen d ..i ii\u0026lt;SPLen d ...s NewPathName=NewPathName_$p(FileName,\u0026#34;/\u0026#34;,ii)_\u0026#34;/\u0026#34; ..i ii=SPLen d ...s NewFileName=NewFileName_$p(FileName,\u0026#34;/\u0026#34;,ii) .s NewPathName=NewPathName_NewFileName .s FileName=NewPathName //最后返回NewFileName s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) //返回值控制图片名称模式 i SaveImageRetName=\u0026#34;SaveImageRetName\u0026#34; d .s ret=NewFileName q ret } /// 返回给监听当前上传文件路径名称，默认不要动 /// w ##class(MI.MIFLISMonitorTest).GetFtpMTHD(\u0026#34;7\u0026#34;) /// mi:仪器 ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = \u0026#34;labno,labnoInfo,patInfo\u0026#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(\u0026#34;MI.MIFDL96A\u0026#34;,\u0026#34;QryLabInfo\u0026#34;,\u0026#34;56\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; s LabnoList=\u0026#34;\u0026#34; //控制输出Excel //s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(\u0026#34;D:\\\\OUT\\\\上传.xls\u0026#34;,\u0026#34;张三[0][1]男[0][1]28岁[0][1]\u0026#34;_$h,\u0026#34;900001\u0026#34;,\u0026#34;1\u0026#34;) //d OutputRow //Set qHandle=$lb(0,repid,0) //Quit $$$OK //控制输出Excel //查最近8天 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-8,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..//20秒以内的先不上传，防止没接收完 ..i (AddDate=$zd($h,8)),(($p($h,\u0026#34;,\u0026#34;,2)-AddTime)\u0026lt;20) q ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..//测试类型0：文本，1：数据库 ..s TestType=\u0026#34;1\u0026#34; ..i TestType=\u0026#34;0\u0026#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s txtInfo=labno_\u0026#34;^\u0026#34;_chl ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo($zd($h,8)_labno_\u0026#34;.order\u0026#34;,txtInfo,labno,\u0026#34;\u0026#34;) ...d OutputRow ...s labno=labnoOld_\u0026#34;^\u0026#34;_$zd($h,8)_labno_\u0026#34;.ok\u0026#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo($zd($h,8)_labno_\u0026#34;.ok\u0026#34;,txtInfo,labno,\u0026#34;\u0026#34;) ...d OutputRow ...//文本双向上传结束****************************************************** ..i TestType=\u0026#34;1\u0026#34; d ...//数据库双向上传开始****************************************************** ...//控制执行sql ...//Insert into liscontroller.lis_application (SPEC_NUM,BTBarcode,ASTBarcode,PATIENT_ID,MSPosition,PatientNo,FULL_NAME,FIRST_NAME,LAST_NAME,Birth,AGE,SEX,Purpose,WARD,Specimen,BedNo,Diagnosis,SpRequest,Medication,SuspectedBact,Doctor,AdviceNo,ApplyDate,SendDate,Collector,SPEC_DATE,CollectPosition,IdResult,Updated,UpdateDate,CARSS_ReadDate,StainType,StructVersion) values ...//(\u0026#39;9999\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;199732\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39; \u0026#39;,\u0026#39;测试\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;\u0026#39;,\u0026#39;85y\u0026#39;,\u0026#39;f\u0026#39;,\u0026#39;普通细菌培养+药敏\u0026#39;,\u0026#39;三病室\u0026#39;,\u0026#39;痰\u0026#39;,\u0026#39;3\u0026#39;,\u0026#39; \u0026#39;,\u0026#39; \u0026#39;,\u0026#39; \u0026#39;,\u0026#39; \u0026#39;,\u0026#39;刘云\u0026#39;,\u0026#39; \u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;2024/6/28 9:17\u0026#39;,\u0026#39;谢艳红\u0026#39;,\u0026#39;2024/6/29 11:17\u0026#39;,\u0026#39; \u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;0\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;NULL\u0026#39;) ...s PatInfo=..GetPatInfo(mi, labno) ...d Trace^MI.MIF000(mi,PatInfo,\u0026#34;PatInfo\u0026#34;) ...//2024-07-01 16:47:48,Mejer600-4,2406290091,,,mnwk-泌尿外科,刘乐,唐云,0000628089,周田香,2,住院,33,43,,2406290091,2024-06-29 11:15,,,,,肾积水伴肾输尿管结石,,,,2024-06-29 06:48,, ...s EPIS=$p(PatInfo,\u0026#34;,\u0026#34;,31) //鉴定号 ...s DTTime=$p(PatInfo,\u0026#34;,\u0026#34;,32) //核收时间 ...s Name=$p(PatInfo,\u0026#34;,\u0026#34;,10) //姓名 ...s Sex=$p(PatInfo,\u0026#34;,\u0026#34;,11) //性别 ...i Sex=\u0026#34;1\u0026#34; s Sex=\u0026#34;m\u0026#34; ...i Sex=\u0026#34;2\u0026#34; s Sex=\u0026#34;f\u0026#34; ...s Age=$p(PatInfo,\u0026#34;,\u0026#34;,14) //年龄 ...s MediNo=$p(PatInfo,\u0026#34;,\u0026#34;,29) //病案号 ...s Location=$p(PatInfo,\u0026#34;,\u0026#34;,6) //科室 ...i Location[\u0026#34;-\u0026#34; s Location=$p(Location,\u0026#34;-\u0026#34;,2) //jzwkszwk-脊柱外科 ...s Speciman=$p(PatInfo,\u0026#34;,\u0026#34;,30) //标本类型 ...s BedNo=$p(PatInfo,\u0026#34;,\u0026#34;,13) //床号 ...s Doctor=$p(PatInfo,\u0026#34;,\u0026#34;,7) //医生 ...s CollectUser=$p(PatInfo,\u0026#34;,\u0026#34;,8) //采集者 ...//s DTTime=$tr($zd($h,3),\u0026#34;-\u0026#34;,\u0026#34;/\u0026#34;)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2),1) //2024/6/28 9:17 $p($zt($h,1),\u0026#34;:\u0026#34;,1,*-1) ...s SqlStr=\u0026#34;Insert into liscontroller.lis_application (SPEC_NUM,BTBarcode,ASTBarcode,PATIENT_ID,MSPosition,PatientNo,FULL_NAME,FIRST_NAME,LAST_NAME,Birth,AGE,SEX,Purpose,WARD,Specimen,BedNo,Diagnosis,SpRequest,Medication,SuspectedBact,Doctor,AdviceNo,ApplyDate,SendDate,Collector,SPEC_DATE,CollectPosition,IdResult,Updated,UpdateDate,CARSS_ReadDate,StainType,StructVersion) values \u0026#34; ...s ValueStr=\u0026#34;(\u0026#39;\u0026#34;_EPIS_\u0026#34;\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;\u0026#34;_MediNo_\u0026#34;\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39; \u0026#39;,\u0026#39;\u0026#34;_Name_\u0026#34;\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;\u0026#39;,\u0026#39;\u0026#34;_Age_\u0026#34;\u0026#39;,\u0026#39;\u0026#34;_Sex_\u0026#34;\u0026#39;,\u0026#39;普通细菌培养+药敏\u0026#39;,\u0026#39;\u0026#34;_Location_\u0026#34;\u0026#39;,\u0026#39;\u0026#34;_Speciman_\u0026#34;\u0026#39;,\u0026#39;\u0026#34;_BedNo_\u0026#34;\u0026#39;,\u0026#39; \u0026#39;,\u0026#39; \u0026#39;,\u0026#39; \u0026#39;,\u0026#39; \u0026#39;,\u0026#39;\u0026#34;_Doctor_\u0026#34;\u0026#39;,\u0026#39; \u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;\u0026#34;_DTTime_\u0026#34;\u0026#39;,\u0026#39;\u0026#34;_CollectUser_\u0026#34;\u0026#39;,\u0026#39;\u0026#34;_DTTime_\u0026#34;\u0026#39;,\u0026#39; \u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;0\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;NULL\u0026#39;,\u0026#39;NULL\u0026#39;)\u0026#34; ...s SqlStr=SqlStr_ValueStr ...d Trace^MI.MIF000(mi,SqlStr,\u0026#34;SqlStr\u0026#34;) ...s ^DL96(\u0026#34;Send\u0026#34;,+$h,labno)=1 //上传标识置为1 ...//多条命令组装多个SQL语句输出.SQL包含$StoredProcedure就当存储过程执行 ...s Data=##class(MI.Common.MIFBase).DemoMOutDBInfo(\u0026#34;DSN=DL96A\u0026#34;,SqlStr,labno) ...d OutputRow ..//数据库双向上传结束****************************************************** Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=\u0026#34;labno,labnoInfo,patInfo\u0026#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=\u0026#34;\u0026#34; { Set AtEnd=1 Set Row=\u0026#34;\u0026#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=\u0026#34;\u0026#34; s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) q:chl=\u0026#34;\u0026#34; d .s tcx=tcx_chl_\u0026#34;+\u0026#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno) i $l(tcx) s tcx=labno_\u0026#34;,\u0026#34;_tcx_\u0026#34;|\u0026#34; q tcx } /// w ##Class(MI.MIFDL96A2).GetEPIS(\u0026#34;40\u0026#34;,\u0026#34;2407210719\u0026#34;) ClassMethod GetEPIS(mi, labno) As %String { //IndexReportID On (VisitNumberDR, WorkGroupMachineDR, OrderNo) s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s EPIS=\u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; s WGMDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WGMDR,\u0026#34;\u0026#34;)) s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WGMDR,OrderNo,\u0026#34;\u0026#34;)) s EPIS=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),6) s AcceptDate=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),9) s AcceptDate=$e(AcceptDate,1,4)_\u0026#34;-\u0026#34;_$e(AcceptDate,5,6)_\u0026#34;-\u0026#34;_$e(AcceptDate,7,8) s AcceptTime=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),10) S AcceptDT=AcceptDate_\u0026#34; \u0026#34;_$zt(AcceptTime,1) q EPIS_\u0026#34;^\u0026#34;_AcceptDT } /// w ##Class(MI.MIFDL96A2).GetPatInfo(\u0026#34;40\u0026#34;,\u0026#34;L0116440\u0026#34;) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s TransmitDate=$tr($zd($h,3),\u0026#34;-\u0026#34;) s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) // IndexEpisodeNo On (TransmitDate, WorkGroupMachineDR, EpisodeNo) s MedicalRecordNo=\u0026#34;\u0026#34;,SpecimenDR=\u0026#34;\u0026#34;,Specimen=\u0026#34;\u0026#34;,EPIS=\u0026#34;\u0026#34; s MedicalRecordNo=$lg(RPVisitNumberData,6) //病案号 s SpecimenDR=$lg(RPVisitNumberData,56) //标本类型 s EPIS=..GetEPIS(mi, labno) //鉴定号 s AcceptDT=$p(EPIS,\u0026#34;^\u0026#34;,2) s EPIS=$p(EPIS,\u0026#34;^\u0026#34;,1) i $l(SpecimenDR) s Specimen=$lg($g(^dbo.BTSpecimenD(SpecimenDR)),3) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) i Location[\u0026#34;ICU\u0026#34; s Location=\u0026#34;重症监护室\u0026#34; s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i AgeUnitDR=1 s AgeUnit=\u0026#34;y\u0026#34; i AgeUnitDR=2 s AgeUnit=\u0026#34;m\u0026#34; i AgeUnitDR=3 s AgeUnit=\u0026#34;d\u0026#34; i AgeUnitDR=4 s AgeUnit=\u0026#34;h\u0026#34; //i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) S Age=Age_AgeUnit s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$tr($lg(RPVisitNumberData,28),\u0026#34;,\u0026#34;,\u0026#34;，\u0026#34;) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) s Sampleno=labno //检测号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; ;病区 s RetString=\u0026#34;\u0026#34; s RetString=Sampleda_\u0026#34;,\u0026#34;_Instrument_\u0026#34;,\u0026#34;_Sampleno_\u0026#34;,\u0026#34;_Sampletype_\u0026#34;,\u0026#34;_Feetype_\u0026#34;,\u0026#34;_Srcdepno_\u0026#34;,\u0026#34;_Srcdocno_\u0026#34;,\u0026#34;_Userno_\u0026#34;,\u0026#34; s RetString=RetString_Patno_\u0026#34;,\u0026#34;_Patna_\u0026#34;,\u0026#34;_Sex_\u0026#34;,\u0026#34;_Pattype_\u0026#34;,\u0026#34;_Bedno_\u0026#34;,\u0026#34;_Patage_\u0026#34;,\u0026#34;_Ageunit_\u0026#34;,\u0026#34;_Reqno_\u0026#34;,\u0026#34;_Reqda_\u0026#34;,\u0026#34; s RetString=RetString_Reportda_\u0026#34;,\u0026#34;_Printflag_\u0026#34;,\u0026#34;_Resultflag_\u0026#34;,\u0026#34;_Errflag_\u0026#34;,\u0026#34;_Diagnose_\u0026#34;,\u0026#34;_Description_\u0026#34;,\u0026#34;_Reserve_\u0026#34;,\u0026#34; s RetString=RetString_Patnamn_\u0026#34;,\u0026#34;_Getda_\u0026#34;,\u0026#34;_Wardno_\u0026#34;,\u0026#34;_BarCode_\u0026#34;,\u0026#34;_MedicalRecordNo_\u0026#34;,\u0026#34;_Specimen_\u0026#34;,\u0026#34;_EPIS_\u0026#34;,\u0026#34;_AcceptDT q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,\u0026#34;S\u0026#34;,filename) q } } ","date":"2025-08-29T00:00:00Z","image":"https://work.717170.xyz/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-20250829163158/assets/image-20250110220839-bac5x44_hu_d00adb8c6a498193.png","permalink":"https://work.717170.xyz/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-20250829163158/","title":"双向接口程序整合"},{"content":" 通过接口测试仪器是否能传输到系统。\n如果日志中无传输日志则说明无传输，排查硬件问题。\n有传输的话则可根据传输日志解析。\n普通测试 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 MIFYHR(mi) s mi=$g(mi) S ^TMPMACH10(mi,104)=$H i \u0026#39;$l(mi) q s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 //控制字符 s stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4),etb=$c(23) s lf=$c(10),cr=$c(13),nak=$c(21),(AllRecord,result,epis)=\u0026#34;\u0026#34;,kk=1 s SB=$C(11),EB=$C(28),CR=$c(13) s MSH=\u0026#34;MSH|^~\\\u0026amp;|LIS||FUS100||20090424130516||ACK|ACK0000001|P|2.3\u0026#34; S ^TMPMACH10(mi,102)=$H i $$Start^MI.MIF000(mi) q f d Main i $$Stop^MI.MIF000(mi) q c Port q ErrHandler h 10 s iError=+$g(iError)+1 i iError\u0026gt;100 s ret=$$Stop^MI.MIF000(mi) q d Trace^MI.MIF000(mi,$tr($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) q Main SET $ZTRAP=\u0026#34;ErrHandler\u0026#34; S iERR=0 s record=$$Read^MI.MIF000(mi,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,2) i \u0026#39;$l(record) q ;s record=$tr(record,\u0026#34;*\u0026#34;,\u0026#34; \u0026#34;) d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) s (sample,epis,surname,result,date,time,QC)=\u0026#34;\u0026#34; //R0123□□□□□□□□□□□□□0101010005v s epis=$TR($E(record,4,18),\u0026#34; \u0026#34;) s code=$E(record,19,20) s res=$TR($E(record,25,28),\u0026#34;0\u0026#34;) s result=code_$c(92)_res_$c(44) ;i $l(result),$L(epis) Do Save^MI.MIF000(mi,epis,result,date,time,QC) q 要回复ACK版 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 MIFFUS3000HL7(mi) s mi=$g(mi) S ^TMPMACH10(mi,104)=$H i \u0026#39;$l(mi) q s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 //控制字符 s stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4),etb=$c(23) s lf=$c(10),cr=$c(13),nak=$c(21),(AllRecord,result,epis)=\u0026#34;\u0026#34;,kk=1 s SB=$C(11),EB=$C(28),CR=$c(13) s MSH=\u0026#34;MSH|^~\\\u0026amp;|LIS||FUS100||20090424130516||ACK|ACK0000001|P|2.3\u0026#34; S ^TMPMACH10(mi,102)=$H i $$Start^MI.MIF000(mi) q f d Main i $$Stop^MI.MIF000(mi) q c Port q ErrHandler h 10 s iError=+$g(iError)+1 i iError\u0026gt;100 s ret=$$Stop^MI.MIF000(mi) q d Trace^MI.MIF000(mi,$tr($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE,\u0026#34;Runtime Error\u0026#34;) q Main SET $ZTRAP=\u0026#34;ErrHandler\u0026#34; S iERR=0 s record=$$Read(mi,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,2) i \u0026#39;$l(record) q ;s record=$tr(record,\u0026#34;*\u0026#34;,\u0026#34; \u0026#34;) d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) ;d ACK s (sample,epis,surname,result,date,time,QC)=\u0026#34;\u0026#34; //R0123□□□□□□□□□□□□□0101010005v s epis=$TR($E(record,4,18),\u0026#34; \u0026#34;) s code=$E(record,19,20) s res=$TR($E(record,25,28),\u0026#34;0\u0026#34;) s result=code_$c(92)_res_$c(44) ;i $l(result),$L(epis) Do Save^MI.MIF000(mi,epis,result,date,time,QC) q /// Creator： Huhm /// CreatDate： 20150528 /// Description: 从通讯端口读取数据 /// Table： 无 /// Input： 仪器ID,开始符,结束符,是否保存所有数据,是否显示控制字符,超时时间值 /// Output： 无 /// Return： 0 /// Others： Read(mi,StartChar,EndChar,AllData,ControlChar,TimeOut) n (mi,StartChar,EndChar,AllData,ControlChar,TimeOut) s StartChar=$g(StartChar),EndChar=$g(EndChar),AllData=$g(AllData),ControlChar=$g(ControlChar),TimeOut=$g(TimeOut) s (Line,Flag)=0 i \u0026#39;$l(mi) q \u0026#34;\u0026#34; s:\u0026#39;TimeOut TimeOut=10 s:\u0026#39;$l(StartChar) Flag=1 SET $ZTRAP=\u0026#34;ErrRead\u0026#34;,$ECODE=\u0026#34;\u0026#34; //捕获错误开始 //循环读取一直读到字符包含结束字符 s Result=\u0026#34;\u0026#34; f r *x:TimeOut q:(\u0026#34;,\u0026#34;_EndChar_\u0026#34;,\u0026#34;)[(\u0026#34;,\u0026#34;_$c(x)_\u0026#34;,\u0026#34;) q:x=-1 i x d .d ACKE .//记录数据到globle .i $l($g(mi)),AllData=\u0026#34;Y\u0026#34; d ..i \u0026#39;Line s Line=$o(^TMPMACHDATA(mi,99,\u0026#34;\u0026#34;),-1)+1 ..s ^TMPMACHDATA(mi,99,Line)=$g(^TMPMACHDATA(mi,99,Line))_$c(x) .//读的字符没包含开始字符就退出，不累积到要的数据里 .i \u0026#39;Flag,(\u0026#34;,\u0026#34;_StartChar_\u0026#34;,\u0026#34;)[(\u0026#34;,\u0026#34;_$c(x)_\u0026#34;,\u0026#34;) s Flag=1 q .//是否要0-32的不可见字符 .i ControlChar=\u0026#34;Y\u0026#34;,x\u0026lt;32 q .//累积数据 .i Flag s Result=Result_$c(x) q Result ACK\t; send \u0026#39;ack\u0026#39; to instrument s ack=$c(6) w ack,*-3 d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q ACKE\t; send \u0026#39;ack\u0026#39; to instrument s ack=$c(6) w ack,*-3 ;d Trace^MI.MIF000(mi,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q ErrRead s Error=$ze s Max=200 s Date=$zd(+$h,3),Time=$zt($p($h,\u0026#34;,\u0026#34;,2)) s Num=$o(^TMPMACHDATA(+mi,98,\u0026#34;\u0026#34;),-1)+1,^TMPMACHDATA(+mi,98,Num)=Date_\u0026#34; \u0026#34;_Time_\u0026#34; : Read : \u0026#34;_Error f j=Num-Max:-1 q:\u0026#39;$d(^TMPMACHDATA(+mi,98,j)) k ^TMPMACHDATA(+mi,98,j) h 3 q \u0026#34;\u0026#34; ","date":"2025-08-29T00:00:00Z","image":"https://work.717170.xyz/img/title.jpg","permalink":"https://work.717170.xyz/p/%E9%80%9A%E7%94%A8%E4%BC%A0%E8%BE%93%E6%8E%A5%E5%8F%A3-20250829163158/","title":"通用传输接口"},{"content":"报警信息导入 ^LISPolice(MachineName,po)=ex\n导入到LISPolice的Global中，MachineName为仪器名称，po为仪器传过来的报警信息，ex为转换后展示的报警信息\n公共导入格式 1 2 3 s MachineName=\u0026#34;\u0026#34;\t;仪器型号 s police=\u0026#34;\u0026#34;\t;报警信息代码 s explain=\u0026#34;\u0026#34;\t;报警信息解释 公共导入方法 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /// 获取报警信息global /// d ##class(MI.Special.Tool).GetPoliceGlobal() ClassMethod GetPoliceGlobal() { //****MI.Special.PoliceInfo***//\t相关仪器报警信息存储记录 s MachineName=\u0026#34;\u0026#34;\t;仪器型号 s police=\u0026#34;\u0026#34;\t;报警信息代码 s explain=\u0026#34;\u0026#34;\t;报警信息解释 k ^LISPolice(MachineName) for i=1:1:$l(police,\u0026#34;$$\u0026#34;) d .s po=$p(police,\u0026#34;$$\u0026#34;,i) .s ex=$p(explain,\u0026#34;$$\u0026#34;,i) .i \u0026#39;$l(po) q .s ^LISPolice(MachineName,po)=ex q } 公共调用方法 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 /// Creator： yanghaoran /// CreatDate： 20240828 /// Description： 保存报警提示信息 /// Input： mi 仪器主键,epis 流水号,expertRules 报警信息,expertRulesType 报警信息仪器类型(存在值将报警信息进行转换，不存在则直接保存报警信息) /// SaveTypeData (分隔符^)保存类型(1:次评价不打印，2:主评价可打印)，为空默认为1 /// 是否保存未转换数据(1:保存，0:不保存)，为空默认为0 /// Output： /// DeBug:\tw ##Class(MI.Special.Common).SaveAlarmInformation(57,1200150259127,\u0026#34;CSCSCS\u0026#34;) /// DeBug:\tw ##Class(MI.Special.Common).SaveAlarmInformation(2,1892,\u0026#34;Basophilia：嗜碱性粒细胞增加；NRBC?：有核红细胞？；Anisocytosis：红细胞大小不均；Macrocytosis：大红细胞症；Hypochromia：低色素性；WBC_Abn_Scattergram：白细胞异常散点图；IG_Present：幼稚粒细胞存在；PLT_Abn_Distribution：血小板异常直方图；Blasts/Abn_Lympho?：原始细胞/异常淋巴细胞?\u0026#34;) /// DeBug:\tw ##Class(MI.Special.Common).SaveAlarmInformation(9,63,\u0026#34;13003\u0026#34;,\u0026#34;DMD7\u0026#34;) ClassMethod SaveAlarmInformation(mi, epis, expertRules, expertRulesType, SaveTypeData) { s mi=$g(mi) s epis=$g(epis) s expertRules=$g(expertRules) s SaveTypeData=$g(SaveTypeData) s SaveType=$p(SaveTypeData,\u0026#34;^\u0026#34;,1) i \u0026#39;$l(SaveType) s SaveType=1\t// 保存类型(1:次评价不打印，2:主评价可打印)，为空默认为1 s expertRulesIsSave=$p(SaveTypeData,\u0026#34;^\u0026#34;,2) i \u0026#39;$l(expertRulesIsSave) s expertRulesIsSave=\u0026#34;0\u0026#34;\t// 是否保存未转换数据(1:保存，0:不保存)，为空默认为0 s expertRulesType=$g(expertRulesType) // 配置信息 s Sep=\u0026#34;；\u0026#34;\t// 文本串分隔符 // 转换报警信息 i $l(expertRulesType) d .s InputInfo=\u0026#34;\u0026#34; .s PoliceInfo=expertRules .i $l(PoliceInfo),$d(^LISPolice(expertRulesType,PoliceInfo)) d ..s InputInfo=$g(^LISPolice(expertRulesType,PoliceInfo)) ..d Trace^MI.MIF000(mi,PoliceInfo_\u0026#34;$$\u0026#34;_InputInfo,\u0026#34;报警信息\u0026#34;) .i $l(InputInfo) d ..s expertRules=InputInfo .e d ..i expertRulesIsSave=0 d ...s expertRules=\u0026#34;\u0026#34; ...d Trace^MI.MIF000(mi,\u0026#34;转换报警信息失败。\u0026#34;,\u0026#34;报警信息异常\u0026#34;) ..e d ...d Trace^MI.MIF000(mi,\u0026#34;保存原始报警信息。\u0026#34;,\u0026#34;报警信息异常\u0026#34;) i \u0026#39;$l(expertRules) q \u0026#34;\u0026#34; s ReportDR=$$GetReportID(mi,epis) i \u0026#39;$l(ReportDR) q \u0026#34;\u0026#34; s obj=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) s TMPstr=obj.MinorConclusion i TMPstr\u0026#39;[expertRules d .i $l(TMPstr) d ..s Str=TMPstr_Sep_expertRules .e d ..s Str=expertRules .s Str=$$DislodgeRepetition(Str,Sep) .i SaveType=1 d ..s obj.MinorConclusion=Str\t//YHR 20230411 保存在报告次评价 不可打印 .i SaveType=2 d ..s obj.MinorConclusion=Str\t//YHR 20230411 保存在报告主评价 可打印 s ret=obj.%Save() D Trace^MI.MIF000(mi,ret_\u0026#34;$$\u0026#34;_expertRules,\u0026#34;SaveAlarmInformation\u0026#34;) q ret GetReportID(mi,AssayNo) // 根据仪器试验号获取报告ID s mi=$g(mi),AssayNo=$g(AssayNo) s ReportDR=\u0026#34;\u0026#34; i \u0026#39;$l(AssayNo) q ReportDR s WGMachineID=$lg(^dbo.BTMIMachineParameterD(mi),6) i $D(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,AssayNo)) d .s TransmitDate=$zd($p($h,\u0026#34;,\u0026#34;,1),8) .s ReportDR=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,AssayNo,TransmitDate,\u0026#34;\u0026#34;),-1) i $l(ReportDR) q ReportDR i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,AssayNo)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,AssayNo,\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1)) d ..s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1,\u0026#34;\u0026#34;),-1) q ReportDR DislodgeRepetition(Str,Sep) // 去除重复信息 s Sep=$g(Sep) i \u0026#39;$l(Sep) s Sep=\u0026#34;；\u0026#34; k ^LISTMPStr s ret=\u0026#34;\u0026#34; f p=1:1:$l(Str,Sep) d .s Strp=$p(Str,Sep,p) .i \u0026#39;$l(Strp) q .s ^LISTMPStr(\u0026#34;Data\u0026#34;,Strp)=\u0026#34;\u0026#34; s GStr=\u0026#34;\u0026#34; f s GStr=$o(^LISTMPStr(\u0026#34;Data\u0026#34;,GStr)) q:GStr=\u0026#34;\u0026#34; d .s ret=ret_Sep_GStr s ret=$e(ret,2,*) k ^LISTMPStr q ret } 万泰导入方法 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 /// 万泰获取报警信息，将字符串转换为16进制后，从后往前根据位数为1获取第几位报警信息 /// w ##class(MI.Special.JudgeResult).GetPolice(\u0026#34;42000100000\u0026#34;) ClassMethod GetPolice(PoliceInfo) { s str=##class(MI.Special.ScaleConversion).scaleconversion(PoliceInfo,\u0026#34;16\u0026#34;,\u0026#34;2\u0026#34;) k ^LISCaris200(\u0026#34;Data\u0026#34;) s strLong=$l(str) f i=1:1:strLong d .s stri=$e(str,i) .i stri=1 d ..s ^LISCaris200(\u0026#34;Data\u0026#34;,strLong+1-i)=1 q \u0026#34;\u0026#34; } /// w ##class(MI.Special.ScaleConversion).scaleconversion4(\u0026#34;42000100000\u0026#34;,\u0026#34;16\u0026#34;,\u0026#34;2\u0026#34;) /// 进制转换 ClassMethod scaleconversion(snum, scale1, scale2) { s cnum=..Sixteen2Ten(snum,scale1) s num=..Ten2Other(cnum,scale2) q num } /// w ##class(MI.Special.ScaleConversion).scaleconversion2() /// 十六进制转十进制 ClassMethod Sixteen2Ten(snum, scale) { s snum=$g(snum) s tnum=0 s numlong=$l(snum) f i=1:1:$L(snum) d .s numi=$e(snum,i) .s numi=$$Sixteen(numi) .s tnum=tnum+(numi*(scale**(numlong-i))) q tnum Sixteen(numi) i (numi=\u0026#34;A\u0026#34;)||(numi=\u0026#34;a\u0026#34;) s numi=10 i (numi=\u0026#34;B\u0026#34;)||(numi=\u0026#34;b\u0026#34;) s numi=11 i (numi=\u0026#34;C\u0026#34;)||(numi=\u0026#34;c\u0026#34;) s numi=12 i (numi=\u0026#34;D\u0026#34;)||(numi=\u0026#34;d\u0026#34;) s numi=13 i (numi=\u0026#34;E\u0026#34;)||(numi=\u0026#34;e\u0026#34;) s numi=14 i (numi=\u0026#34;F\u0026#34;)||(numi=\u0026#34;f\u0026#34;) s numi=15 q numi } /// w ##class(MI.Special.ScaleConversion).scaleconversion3(4535486513152,2) /// 十进制转其他进制 ClassMethod Ten2Other(snum, scale) { s snum=$g(snum) s tnum=\u0026#34;\u0026#34; s GoTo=1 while (GoTo=1){ s pnum1=snum s snum=$p(snum/scale,\u0026#34;.\u0026#34;,1) s pnum2=pnum1#scale s pnum2=$$Sixteen(pnum2) i snum\u0026lt;scale d .s tnum=snum_pnum2_tnum .s GoTo=0 e s tnum=pnum2_tnum if (snum=0)||\u0026#39;$l(snum) s GoTo=0 } q tnum Sixteen(pnum2) i pnum2=10 s pnum2=\u0026#34;A\u0026#34; i pnum2=11 s pnum2=\u0026#34;B\u0026#34; i pnum2=12 s pnum2=\u0026#34;C\u0026#34; i pnum2=13 s pnum2=\u0026#34;D\u0026#34; i pnum2=14 s pnum2=\u0026#34;E\u0026#34; i pnum2=15 s pnum2=\u0026#34;F\u0026#34; q pnum2 } 仪器报警信息记录 万泰Caris200 1 2 3 s MachineName=\u0026#34;Caris200\u0026#34; s police=\u0026#34;1$$2$$3$$4$$5$$6$$7$$8$$9$$10$$11$$12$$13$$14$$15$$16$$17$$18$$19$$20$$21$$22$$23$$24$$25$$26$$27$$28$$29$$30$$31$$32$$33$$38$$39$$40$$41$$42$$43$$44$$45$$46$$47$$48$$49$$50$$61$$62$$63$$\u0026#34; s explain=\u0026#34;Ｍ试剂吸取错误$$Ｒ１试剂吸取错误$$Ｒ２试剂吸取错误$$前処理液吸取错误$$无样本错误$$样本堵塞错误$$样本空吸错误$$样本分注错误$$无稀释液错误$$洗涤不良错误$$光学系统错误$$样本分注枪尖插取错误$$样本分注枪尖丢弃错误$$暗值错误$$测光错误$$免疫反应槽温度错误$$B/F1 预加热部温度错误$$B/F2 预加热部温度错误$$R1 针预加热部温度错误$$R2 针预加热部温度错误$$试剂有效期错误$$稀释液有效期错误$$PMT 部温度错误$$试剂冷藏仓温度错误$$稀释液冷藏仓温度错误$$时序超时$$未测试（样本架强制排出）$$反应杯搬送错误$$预激发液有效期错误$$预激发液加热部温度错误$$激发液加热部温度错误$$BF 盘温度错误$$校准曲线错误$$校准曲线有效期错误$$CV 偏离容许范围外错误$$无法计算浓度值错误$$标准曲线超出正常范围的错误$$动态范围超出正常范围外error／上限值超过$$动态范围超出正常范围外error／下限值超过$$管理值范围外error（Xbar 管理图）$$质控管理如无法判读$$数据编辑（手动稀释倍数修正）$$数据编辑（再计算）$$数据编辑（标准曲线计数修正）$$数据编辑（用修正过的标准曲线再次计算）$$数据编辑（质控管理浓度修正）$$测试信息异常错误$$混匀异常错误$$无法检测错误$$\u0026#34; 迈瑞BC7500 1 2 3 s MachineName=\u0026#34;BC7500\u0026#34; s police=\u0026#34;12000$$12001$$12002$$12003$$12004$$12005$$12006$$12007$$12008$$12009$$12010$$12011$$12012$$12013$$12014$$12015$$12016$$12017$$12018$$12019$$12020$$12021$$12022$$12023$$12024$$12025$$12026$$12027$$12028$$12029$$12030$$12031$$12032$$12033$$12034$$12035$$12036$$12037$$12038$$12039$$12040$$12041$$12042$$12043$$12044$$12053$$12054$$12055$$12056$$12057$$12058$$12059$$12060$$12061$$12062$$12063$$12064$$12065$$12066$$12067$$12068$$12069$$12070$$12071$$12072$$12073$$12074$$12075$$12076$$12080$$12081$$12082$$12083$$12084$$12085$$12086$$12087$$12088$$12089$$12090$$12091$$12092$$12093$$12094$$12095$$12096$$12097$$12098$$12099$$12101$$12102$$12103$$12104$$12105$$12109$$10379-6$$12021-1$$15150-6$$15180-3$$15192-8$$17790-7$$32208-1$$34165-1$$34188-3$$34525-6$$44017-2$$50670-9$$7796-6$$\u0026#34; s explain=\u0026#34;白细胞散点图异常$$白细胞直方图异常$$白细胞增加$$白细胞减少$$中性粒细胞增加$$中性粒细胞减少$$淋巴细胞增加$$淋巴细胞减少$$单核细胞增加$$嗜酸性粒细胞增加$$嗜碱性粒细胞增加$$白细胞异常$$红细胞增加$$红细胞分布异常$$贫血$$血红蛋白异常/干扰?$$血小板分布异常$$血小板增加$$血小板减少$$HGBandHCTCheckFailed$$核右移$$采样或吸样异常$$红细胞凝集$$红细胞,血红蛋白异常$$缺铁性$$红细胞,血红蛋白可疑$$DIFF通道数据采集错误$$DIFF通道数据分析错误$$有核红/血小板凝集?$$RBC通道数据采集错误$$RBC通道数据分析错误$$HGB异常$$PLT通道数据采集错误$$PLT通道数据分析错误$$BASO通道数据采集错误$$BASO通道数据分析错误$$白细胞增加(BASO)$$白细胞减少(BASO)$$RET通道数据采集错误$$RET通道数据分析错误$$RET散点图异常$$网织红过多$$NRBC通道数据采集错误$$NRBC通道数据分析错误$$NRBC散点图异常$$异常淋巴细胞/原始细胞?$$有核红细胞$$脂质颗粒?$$感染红细胞$$RBC系统故障$$堵孔$$HGB系统故障$$RBC分析异常$$RET系统故障$$HGB分析异常$$碎片?$$RBC直方图异常$$PLT系统故障$$PLT-O系统故障$$PLT-O分析异常$$PLT直方图异常$$PLT散点图异常$$大血小板$$巨大血小板$$系统故障$$状态受限$$三系减少$$大细胞性红细胞$$小细胞性红细胞$$CRP分析异常$$Crp全血细胞压积结果异常$$Crp更换乳胶批次未定标$$色谱图面积过高$$色谱图面积过低$$SA1c峰分离不佳$$HbA0峰异常$$峰数异常$$色谱图异常$$SA1c保留时间提前$$SA1c保留时间延迟$$HbA0保留时间提前$$HbA0保留时间延迟$$测量未完成$$信号异常$$HbE可疑$$HbD可疑$$HbS可见$$HbC可见$$血红蛋白变异体可疑$$吸样不足$$WNB分析异常$$WNB散点图异常$$白细胞碎片？$$吸样异常$$SAA分析异常$$红细胞双峰性$$CRP吸样异常$$红细胞大小不均$$低色素$$异常/异型淋巴细胞?$$核左移？$$小血小板$$未成熟细胞？$$出现有核红细胞$$红细胞溶血抵抗？$$原始细胞$$红细胞凝聚？$$血小板凝集?$$\u0026#34; 贝克曼DXH900 1 2 3 s MachineName=\u0026#34;DXH900\u0026#34; s police=\u0026#34;Abn Hemoglobin$$Cellular Inter$$Dimorphic Reds$$Giant Platelets$$Imm Grans$$Left Shift$$LY Blast$$MO Blast$$NE Blast$$NRBC$$RBC Frag/Micro$$Red Cell Aggl$$Sickled Cells$$Variant LY$$Abn Diff Pattern$$Abn NRBC Pattern$$Abn RBC Pattern$$Abn Retic Pattern$$Abn TNC Pattern$$Abn WBC Pattern$$Aged Sample$$AL2 Blank Voltage: N$$AL2 Blank Voltage: R$$Bubbles$$Carryover$$Cellular Inter$$Cover Opened$$Data Disc: D$$Data Disc: N$$Data Disc: R$$Excessive Debris: D$$Flow Cell Clog: D$$Flow Cell Clog: N$$Flow Cell Clog: R$$HGB Blank Shift$$HGB Inter: WBC$$High Event Rate: D$$High Event Rate: N$$High Event Rate: R$$High OP Events: D$$High RF Events: D$$Low AL2 Events: N$$Low DC Events: N$$Low Event Rate: D$$Low Event Rate: N$$Low Event Rate: R$$Low Events: D$$Low Events: N$$Low Events: R$$Low OP Events: D$$Low RMALS Events: D$$MCV Inter: PLT$$MCV Inter: WBC$$MO-NE Overlap$$NE-EO Overlap$$No Aspiration$$Non-blood Specimen$$NRBC Inter$$NRBC-LY Overlap$$Nucleated Cells$$Partial Aspiration$$Platelet Clumps$$PLT Carryover$$PLT Inter: Debris$$RBC-PLT Overlap$$Range Error$$RET Inter: Debris$$RET Inter: PLT$$RET-RBC Overlap$$System Event: D$$System Event: HGB$$System Event: N$$System Event: PLT$$System Event: R$$System Event: RBC$$System Event: TNC$$System Event: WBC$$TNC Carryover$$Undefined Pop: D$$Unknown Error$$WBC Carryover$$Anemia$$Basophilia$$Basophilia#$$Eosinophilia$$Eosinophilia#$$Erythrocytosis$$Hypochromia (1+, 2+, 3+)$$Leukocytosis$$Leukopenia$$Lymphocytosis$$Lymphocytosis#$$Lymphopenia$$Lymphopenia#$$Monocytosis$$Monocytosis#$$Neutropenia$$Neutropenia#$$Neutrophilia$$Neutrophilia#$$Anisocytosis (1+, 2+, 3+)$$Large Platelets$$Small Platelets$$Thrombocytopenia$$Thrombocytosis$$Macrocytosis (1+, 2+, 3+)$$Microcytosis (1+, 2+, 3+)$$Reticulocytosis$$Reticulocytosis#$$NRBCs Present\u0026#34; s explain=\u0026#34;Abnormal Hemoglobin$$细胞干涉$$二态红$$巨血小板$$未成熟粒细胞$$左移$$LY 原始细胞$$MO 原始细胞$$NE 原始细胞$$NRBC$$RBC Frag/Microcytes$$Red Cell Agglut$$镰状细胞$$变体淋巴细胞$$异常 Diff 模式$$异常 NRBC 模式$$异常 RBC 模式$$异常网织红细胞模式$$异常 TNC 模式$$异常 WBC 模式$$已老化的样品$$AL2 空白电压：次数$$AL2 空白电压：R$$气泡$$携带污染$$细胞干涉$$已打开盖板$$数据中断：D$$数据中断：次数$$数据中断：R$$过多的碎片：D$$流动室淤塞：D$$流动室淤塞：次数$$流动室淤塞：R$$HGB 空白偏移$$HGB 干涉：WBC$$高发生率：D$$高发生率：次数$$高发生率：R$$高 OP 颗粒：D$$高 RF 颗粒 D$$低 AL2 颗粒：次数$$低 DC 颗粒：次数$$低发生率：D$$低发生率：次数$$低发生率：R$$低颗粒：D$$低颗粒：次数$$低颗粒：R$$低 OP 颗粒：D$$低 RMALS 颗粒：D$$MCV 干涉：PLT$$MCV 干涉：WBC$$MO-NE 重叠$$NE-EO 重叠$$无吸样$$非血液标本$$NRBC 干扰$$NRBC-LY 重叠$$有核细胞$$部分吸样$$血小板凝块$$PLT 携带污染$$PLT 干涉：碎片$$RBC-PLT 重叠$$范围错误$$RET 干扰：碎片$$RET 干扰：PLT$$RET-RBC 重叠$$系统事件：D$$系统事件：HGB$$系统事件：次数$$系统事件：PLT$$系统事件：R$$系统事件：RBC$$系统事件：TNC$$系统事件：WBC$$TNC 携带污染$$未定义的弹出窗口：D$$未知错误$$WBC 携带污染$$贫血$$嗜碱性细胞增多$$嗜碱性细胞增多 #$$嗜酸性细胞增多$$嗜酸性细胞增多 #$$红血球增多$$血红蛋白过少 (1+, 2+, 3+)$$白血球增多$$白血球减少$$淋巴球增多$$淋巴球增多 #$$淋巴球减少$$淋巴球减少 #$$单核细胞增多$$单核细胞增多 #$$嗜中性白血球减少$$嗜中性白血球减少 #$$嗜中性白血球增多$$嗜中性白血球增多 #$$红细胞大小不等症 (1+, 2+, 3+)$$血小板过大$$血小板过小$$血小板减少$$血小板增多$$巨红细胞 (1+, 2+, 3+)$$小红细胞 (1+, 2+, 3+)$$网织红血球过多$$网织红血球过多 #$$存在 NRBC\u0026#34; 贝克曼AU5800 1 2 3 s MachineName=\u0026#34;AU5800\u0026#34; s police=\u0026#34;3000 Text Not Received (ANL \u0026lt;- DPR) (A)[A]$$3001 Text Not Received (UNT \u0026lt;- SMP) (A)[A]$$3002 Text Not Received (SMP \u0026lt;- UNT) (A)[A]$$3003 DPR Communication Error (A, B, C, D, E, F, G, H)[A, B, C, D, E]$$3004 SMP Communication Error (A, B, C, D, E, F, G, H)[A, B, C, D, E]$$3005 Unit Communication Error (A, B, C, D, E, F, G, H)[A, B, C, D, E]$$3006 Text ID Information Unmatched (A, B, C, D, E, F)[A]$$3007 Text Receive Error (A, B)[A]$$3020 Distributed Control Primary Station Error (A, B, C, D, E, F, G, H)[A, B, C, D, E]$$3021 Distributed Control Secondary Station Error (A, B, C, D, E, F, G, H)[A, B, C, D, E]$$3022 Motor Controller Error (A, B, C, D, E, F, G, H)[A, B, C, D, E]$$3023 Barcode Reader Communication Error (A, B, C, D, E, F, G, H)[A, B, C, D, E]$$3024 I/O Control Error (A, B, C, D, E, F, G, H)[A, B, C, D, E]$$3100 Inner S Transfer Unit (FA01) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3101 Inner S transfer unit (FA01) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3102 Inner S Transfer Unit (FA01) Error (Rotation) (A, B, C)[A, B, C, D, E]$$3103 Inner S Dispenser Unit (SA-S-IN) Error (A)[A, B, C, D, E]$$3104 Inner S Inside Wash Dispenser Unit (SA-W-IN) Error (A)[A, B, C, D, E]$$3110 Outer S Transfer Unit (FA11) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3111 Outer S Transfer Unit (FA11) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3112 Outer S Transfer Unit (FA11) Error (Rotation) (A, B, C)[A, B, C, D, E]$$3113 Outer S Dispenser Unit (SA-S-OUT) Error (A)[A, B, C, D, E]$$3114 Outer S Inside Wash Dispenser (SA-W-OUT) Error (A)[A, B, C, D, E]$$3115 S Transfer Unit (FA01/FA11) Initialize Error [A]$$3120 Cuvette Wash Unit (FB) Error (A)[A, B, C, D, E]$$3125 Cuvette Wash Water Dispensing Disabled (A)[A, B, C, D, E]$$3130 R1/S Mixing Unit (FC01) Error (Up-Down) (A)[A, B, C, D, E]$$3131 R1/S Mixing Unit (FC01) Error (Rotation) (A)[A, B, C, D, E]$$3132 R1/S Mixing Unit (FC01) Error (Mixing) (A)[A, B, C, D, E]$$3135 R2 Mixing Unit (FC11) Error (Up-Down) (A)[A, B, C, D, E]$$3136 R2 Mixing Unit (FC11) Error (Rotation) (A)[A, B, C, D, E]$$3137 R2 Mixing Unit (FC11) Error (Mixing) (A)[A, B, C, D, E]$$3140 Inner R1 Transfer Unit (FD01) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3141 Inner R1 Transfer Unit (FD01) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3142 Inner R1 Transfer Unit (FD01) Error (Rotation) (A, B, C)[A, B, C, D, E]$$3143 Inner R1 Dispenser Unit (SA-R1-IN) Error (A)[A, B, C, D, E]$$3144 Inside Wash Water Dispensing Disabled at Inner R1 Transfer (A)[A, B, C, D, E]$$3150 Outer R1 Transfer Unit (FD11) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3151 Outer R1 Transfer Unit (FD11) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3152 Outer R1 Transfer Unit (FD11) Error (Rotation) (A, B, C)[A, B, C, D, E]$$3153 Outer R1 Dispenser Unit (SA-R1-OUT) Error (A)[A, B, C, D, E]$$3154 Inside Wash Water Dispensing Disabled at Outer R1 Transfer (A)[A, B, C, D, E]$$3155 R1 Transfer Unit (FD01/FD11) Initialize Error [A]$$3160 Inner R2 Transfer Unit (FD21) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3161 Inner R2 Transfer Unit (FD21) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3162 Inner R2 Transfer Unit (FD21) Error (Rotation) (A, B, C)[A, B, C, D, E]$$3163 Inner R2 Dispenser Unit (SA-R2-IN) Error (A)[A, B, C, D, E]$$3164 Inside Wash Water Dispensing Disabled at Inner R2 Transfer (A)[A, B, C, D, E]$$3170 Outer R2 Transfer Unit (FD31) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3171 Outer R2 Transfer Unit (FD31) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3172 Outer R2 Transfer Unit (FD31) Error (Rotation) (A, B, C)[A, B, C, D, E]$$3173 Outer R2 Dispenser Unit (SA-R2-OUT) Error (A)[A, B, C, D, E]$$3174 Inside Wash Water Dispensing Disabled at Outer R2 Transfer (A)[A, B, C, D, E]$$3175 R2 Transfer Unit (FD21/FD31) Initialize Error [A, B, C, D, E]$$3180 R1 Refrigerator Unit (DA01) Error (A)[A, B, C, D, E]$$3181 R2 Refrigerator Unit (DA11) Error (A)[A, B, C, D, E]$$3190 Cuvette Wheel (GA) Error (Rotation) (A)[A, B, C, D, E]$$3192 Sample Shutter Unit (CJ01) Error (A)[A, B, C, D, E]$$3200 Photometry Controller Error 1 (A, B, C, D, E, F, G, H)[A]$$3201 Photometry Controller Error 2 (A, B, C, D, E, F, G, H)[A, B, C, D, E]$$3205 Thermal Control Error 1 (A, B, C, D, E, F, G, H)[A]$$3206 Thermal Control Error 2 (A, B, C, D, E, F, G, H)[A, B, C, D, E]$$3210 Cooling Unit (DB) Error (A)[A]$$3212 Temperature Controlled Bath Unit (GA) Temp. out of Range [A]$$3214 Cooling Unit (DB) Error (A)[A]$$3215 Sample Probe (FA) Error (Liquid Sensor) (A, B)[A, B, C, D, E]$$3216 Sample Probe (FA) Error (Liquid Sensor) (A, B)[A, B, C, D, E]$$3217 Sample Probe (FA) Error (Clot Sensor) (A, B)[A, B, C, D, E]$$3220 R1 Reagent Probe (FD01/FD11) Error (Liquid Sensor) (A, B)[A, B, C, D, E]$$3221 R1 Reagent Probe (FD01/FD11) Error (Liquid Sensor) (A, B)[A, B, C, D, E]$$3223 R2 Reagent Probe (FD21/FD31) Error (Liquid Sensor) (A, B)[A, B, C, D, E]$$3224 R2 Reagent Probe (FD21/FD31) Error (Liquid Sensor) (A, B)[A, B, C, D, E]$$3227 Second Washing Well Pouring Error (A)[A, B, C, D, E]$$3228 Second Washing Well Draining Error [A, B, C, D, E]$$3230 Sample Short (A, B, C, D, E, F, G, H, I, J, K)[A]$$3231 Sample Probe Clot Detect (A, B, C, D, E, F, G, H)[A]$$3232 Sample Probe Short Aspiration (A, B, C, D, E, F)$$3233 Sample Probe Detergent Short (A)[A]$$3234 Sample Probe Detergent Empty (A, B)[A]$$3235 Sample Probe Detergent Empty (A, B)[A]$$3236 Sample Probe W2 Detergent Empty (A)[A]$$3237 Sample Pre-Diluent Short (A)[A]$$3238 Sample Pre-Diluent Run Out (A, B, C, D, E, F, G)[A]$$3239 Sample Pre-Diluent Run Out (A, B, C, D, E, F, G)[A]$$3240 Sample Pre-Diluent Diluent Empty (A, B, C, D, E, F, G, H, I, J)[A]$$3241 Sample Pre-Diluent Diluent Empty (A, B, C, D, E, F, G, H, I, J)[A]$$3245 R1 Reagent Short (A, B)[A]$$3246 R1 Reagent Run Out (A, B, C, D, E, F, G)[A]$$3247 R1 Reagent Run Out (A, B, C, D, E, F, G)[A]$$3248 R1 Reagent Empty (A, B, C, D, E, F, G, H, I, J, K)[A]$$3249 R1 Reagent Empty (A, B, C, D, E, F, G, H, I, J, K)[A]$$3250 R1 Probe Detergent Short (A)[A]$$3251 R1 Probe Detergent Empty (A, B)[A]$$3252 R1 Probe Detergent Empty (A, B)[A]$$3253 R1 Probe W2 Detergent Short (A)[A]$$3254 R1 Probe cold water Supply Error (A)[A]$$3255 R2 Reagent Short (A, B)[A]$$3256 R2 Reagent Run Out (A, B, C, D, E, F, G)[A]$$3257 R2 Reagent Run Out (A, B, C, D, E, F, G)[A]$$3258 R2 Reagent Empty (A, B, C, D, E, F, G, H, I, J, K)[A]$$3259 R2 Reagent Empty (A, B, C, D, E, F, G, H, I, J, K)[A]$$3260 R2 Probe Detergent Short (A)[A]$$3261 R2 Probe Detergent Empty (A, B)[A]$$3262 R2 Probe Detergent Empty (A, B)[A]$$3263 R2 Probe W2 Detergent Short (A)[A]$$3264 R1 Probe cold water Supply Error (A)[A, B, C, D, E]$$3270 Detergent Empty [A]$$3271 Detergent Empty [A]$$3272 Detergent Overflow [A]$$3273 Detergent Overflow [A]$$3275 Vacuum Tank Weak Pressure [A]$$3276 Vacuum Tank Full [A]$$3277 Concentrated waste water tank Full [A]$$3278 Washing waste water tank Full [A]$$3280 Detergent Generation Unavailable [A]$$3285 Photometer Unit (GB) Error (A)[A, B, C, D, E]$$3286 Photometric Data Error (A, B)[A]$$3287 Lamp Off Error [A]$$3288 Lamp Dark Error (A)[A]$$3295 R1 Reagent Refrigerator Cover Open [A]$$3296 R1 Reagent Refrigerator Cover Open [A]$$3297 R2 Reagent Refrigerator Cover Open [A]$$3298 R2 Reagent Refrigerator Cover Open [A]$$3300 Rack Loading Unit (CB) Pusher Error (A, B)[A, B, C, D, E]$$3301 Rack Loading Unit (CB) Receiver Error (A, B)[A, B, C, D, E]$$3302 ID Reader Lever 1 (CC1) Error (A)[A, B, C, D, E]$$3303 ID Reader Lever 2 (CC2) Error (A)[A, B, C, D, E]$$3304 Rack Buffer Unit (CD) Error (X-Axis) (A)[A, B, C, D, E]$$3305 Rack Buffer Unit (CD) Lever Error (Up-Down) (A)[A, B, C, D, E]$$3306 Rack Buffer Unit (CD) Error (Y-Axis) (A)[A, B, C, D, E]$$3307 Passing Lane Rack Feed Unit (CE) Error (A)[A, B, C, D, E]$$3308 Dispensing Lane Rack Feed Unit (CE) Error (A)[A, B, C, D, E]$$3309 Unloading Rack Feed Unit (CF) Error (A)[A, B, C, D, E]$$3310 Rack Unloading Unit (CG) Lever Error (A)[A, B, C, D, E]$$3312 Recovery Rack Feed Unit (CL) Error (A)[A, B, C, D, E]$$3313 ANL Passing Lane Belt (CH01) Error (A, B)[A, B, C, D, E]$$3314 ANL Passing Lane Lever (CH02) Error (A, B)[A, B, C, D, E]$$3315 ANL Dispensing Lane Belt (CH01) Error (A, B)[A, B, C, D, E]$$3316 ANL Dispensing Lane Lever 1 (CH01) Error (A, B)[A, B, C, D, E]$$3317 ANL Dispensing Lane Lever 1 (CH01) Retraction Error (A, B)[A, B, C, D, E]$$3318 ANL Dispensing Lane Lever 2 (CH01) Error (A, B)[A, B, C, D, E]$$3319 ANL Dispensing Lane Lever 2 (CH01) Retraction Error (A, B)[A, B, C, D, E]$$3320 ANL Dispensing Lane Stopper (CH01) Error (A, B)[A, B, C, D, E]$$3321 ANL Rack Feed Belt (CH01) Error (A, B)[A, B, C, D, E]$$3322 ANL Recovery Lane Belt (CH11) Error (A, B)[A, B, C, D, E]$$3323 ANL Lane Changer Unit (CK) Error (A, B)[A, B, C, D, E]$$3324 ANL Lane Change Stopper (CK) Error (A, B)[A, B, C, D, E]$$3325 ISE Passing Lane Belt (CM01) Error (A)[A, B, C, D, E]$$3326 ISE Passing Lane Lever (CM01) Error (A)[A, B, C, D, E]$$3327 ISE Dispensing Lane Belt (CM01) Error (A)[A, B, C, D, E]$$3328 ISE Dispensing Lane Lever (CM01) Error (A)[A, B, C, D, E]$$3329 ISE Recovery Lane Belt (CM11) Error (A)[A, B, C, D, E]$$3331 Passing Lane Rack Step Error (A, B)[A, B, C, D, E]$$3332 Dispensing Lane Rack Step Error (A, B)[A, B, C, D, E]$$3333 Passing Lane Rack Jam (A, B)[A, B, C, D, E]$$3334 Dispensing Lane Rack Jam (A, B)[A, B, C, D, E]$$3335 Recovery Lane Rack Jam (A, B)[A, B, C, D, E]$$3336 Passing Lane Rack Step Prohibition Signal Detected (A)[A, B, C, D, E]$$3337 Dispensing Lane Rack Step Prohibition Signal Detected (A)[A, B, C, D, E]$$3338 Sampler Unit Rack Jam (A)[A, B, C, D, E]$$3340 Rack Type Reading Error (A)[A]$$3341 Rack Type Unmatched (A, B, C)[A]$$3342 Rack Feed Error (A, B, C)[A]$$3343 Rack Step Synchronization Error (A, B, C, D, E, F)[A, B, C, D, E]$$3344 Rack ID Barcode Reading Error (A, B, C)[A]$$3345 RB Incomplete$$3346 ACAL Incomplete$$3347 QC Incomplete$$3349 Rack Set Error (A)[A]$$3350 Rack Buffer Cover Open [A]$$3351 Rack Buffer Cover Open [A]$$3352 Rack Loading Stop [A]$$3353 Rack Loading Stop [A]$$3354 No Rack [A]$$3355 Rack ID Barcode Reading Error (A)$$3356 Priority Rack Cover Open [A]$$3357 No Priority Rack [A]$$3358 Recovery Rack ID Barcode Reading Error (A, B)[A]$$3360 Power Failure Detect [A]$$3361 Sample ID Barcode Reading Error (A)[A]$$3362 Maker Setting Parameter Error (A, B)[A]$$3363 Unit Communication Error (A)[A]$$3365 Replenishment Detergent Short [A]$$3366 Failed to Start Analysis$$3370 Cup Detect Error (A)$$3371 Passing Lane Initialization Error (A)[A]$$3372 Dispensing Lane Initialization Error (A)[A]$$3373 Rack Unloading Unit Full or No Rack Unloading Tray (A)[A]$$3374 No Priority Rack (A)[A]$$3375 Rack Existence on Passing Lane Feed Unit [A]$$3376 Rack Existence on Dispensing Lane Feed Unit [A]$$3377 Rack Existence on Recovery Rack Feed Unit [A]$$3378 Rack Unloading Unit Full (A)[A]$$3379 Rack Unloading Unit Full or No Tray [A]$$3380 No Rack Unloading Tray (A)[A]$$3381 Rack Existence at ID Reading Position (A)[A]$$3382 Rack Existence on Rack Transfer Unit (A)[A]$$3383 Rack Existence on Unloading Rack Feed Unit [A]$$3384 Rack Existence on Rack Buffer Unit (A)[A]$$3385 Rack Existence on ANL Passing Lane (A, B)[A]$$3386 Rack Existence on ANL Dispensing Lane (A, B)[A]$$3387 Rack Existence on ANL Recovery Lane (A, B)[A]$$3388 Rack Existence on ISE Passing Lane (A)[A]$$3389 Rack Existence on ISE Dispensing Lane (A)[A]$$3390 Rack Existence on ISE Recovery Lane (A)[A]$$3391 Rack Illegal Setting on Priority Rack Loading Unit (A)[A]$$3392 No Rack Unloading Tray (A)[A]$$3393 No Rack Loading Tray$$3401 LA rack feed unit (CN) Error (A)[A, B, C, D, E]$$3402 Rack unloading unit (CP) Error (A)[A, B, C, D, E]$$3406 Rack unloading unit (CP) Full (A)[A]$$3407 No Rack Unloading Tray (A)[A]$$3408 Rack ID Barcode Reading Error (A, B, C)[A]$$3409 LA rack carry-out operation is disabled (A, B)[A]$$3410 Rack unloading operation is disabled$$3411 Rack Illegal Setting on the lanes connected to LA (A)[A]$$3416 LA rack carry-in procedure Error (A)[A]$$3417 LA rack carry-out procedure Error (A)[A]$$3419 LA rack carry-out procedure Error (A)[A]$$3421 Rack Jam at carry-in from LA (A)[A]$$3422 Rack Jam at carry-out to LA (A)[A]$$3501 ISE Monitor Communication Error (A, B)[A]$$3502 ISE Sample Transfer Unit (FA21) Error (Up-Down) (A, B, C)[A, B, C, D, E]$$3503 ISE Sample Transfer Unit (FA21) Error (Rotation) (A, B, C)[A, B, C, D, E]$$3504 ISE Sample Probe (FA21) Level Sensor Error (A, B)[A, B, C, D, E]$$3505 ISE Sample Dispenser (SA21) Error (A)[A, B, C, D, E]$$3506 ISE Sample Probe Inside Wash Dispenser (SA31) Error (A)[A, B, C, D, E]$$3507 ISE Sample Dispenser Pressure Sensor (IAS11) Error (A)[A, B, C, D, E]$$3508 ISE Buffer Dispenser (SA01) Error (A, B)[A, B, C, D, E]$$3509 ISE Buffer Dispenser (SA01) Error (A, B)[A, B, C, D, E]$$3510 ISE Sample Pot Level Sensor Error (A, B)[A, B, C, D, E]$$3511 ISE Sample Pot Level Sensor Error (A, B)[A, B, C, D, E]$$3512 ISE Sample Pot Overflow (A, B)[A, B, C, D, E]$$3513 ISE Sample Pot Overflow (A, B)[A, B, C, D, E]$$3514 ISE Analog Power Supply Error (A, B)[A]$$3515 ISE Analog Power Supply Error (A, B)[A]$$3516 ISE Sample Syringe Priming Incomplete [A]$$3517 ISE Calibrator Illegal Setting [A]$$3518 ISE Drain Flow Cell Incomplete [A]$$3519 ISE Data Controller Error (A, B, C, D, E)[A]$$3520 ISE Data Controller Error (A, B, C, D, E)[A]$$3521 ISE Data Controller Error (A, B, C, D, E)[A]$$3522 ISE Mixing Motor Error (A, B)[A, B]$$3523 ISE Mixing Motor Error (A, B)[A, B]$$3524 ISE Roller Pump for MID Standard Solution Dispensing Error (A)[A, B]$$3525 ISE Roller Pump for MID Standard Solution Dispensing Error (A)[A, B]$$3526 ISE Roller Pump for Mixture Aspiration Error (A)[A, B]$$3527 ISE Roller Pump for Mixture Aspiration Error (A)[A, B]$$3528 ISE Controller Error (A)[A, B]$$3529 ISE Controller Error (A)[A, B]$$3530 ISE Sample Short (A, B, C, D, E, F, G, H, I, J)[A]$$3531 ISE Sample Probe Detergent Short (A)[A]$$3532 ISE Sample Probe Detergent Running Out (A)[A]$$3533 ISE Sample Probe Detergent Running Out (A)[A]$$3534 ISE Sample Probe Clot detect (A, B, C, D, E, F, G)[A]$$3535 Sample Probe False Aspiration Detected (A, B, C, D, E, F)[A]$$3536 ISE Buffer Solution Short (A)[A]$$3537 ISE MID Standard Solution Short (A)[A]$$3538 ISE Reference Solution Short (A)[A]$$3539 ISE Cleaning Solution Short [A]$$3540 IES Serum Standard Solution H Short [A]$$3541 IES Serum Standard Solution L Short [A]$$3542 IES Urine Standard Solution H Short [A]$$3543 IES Urine Standard Solution L Short [A]$$3544 ISE Na Selectivity Check Solution Short [A]$$3545 ISE K Selectivity Check Solution Short [A]$$3546 ISE Serum CRS Standard Solution H Short [A]$$3547 ISE Serum CRS Standard Solution M Short [A]$$3548 ISE Serum CRS Standard Solution L Short [A]$$3549 ISE Urine CRS Standard Solution H Short [A]$$3550 ISE Urine CRS Standard Solution M Short [A]$$3551 ISE Urine CRS Standard Solution L Short [A]$$3560 ISE Cover Open [A]$$3561 ISE Cover Open [A]$$3570 Check ISE Sample Probe Tip [A]$$3571 Concentration Calculation Disabled (A)[A]$$3572 Concentration Calculation Disabled (A)[A]$$3573 ISE Sequence Error (A, B, C, D, E)[A]$$3574 ISE Sequence Error (A, B, C, D, E)[A]$$3575 ISE MID Standard Solution Stability Error ( pre-calibration ) (A)[A]$$3576 ISE MID Standard Solution Stability Error ( pre-calibration ) (A)[A]$$3577 ISE MID Standard Solution Stability Error ( during calibration ) (A, B)[A]$$3578 ISE MID Standard Solution Stability Error ( during calibration ) (A, B)[A]$$3579 IES Serum Standard Solution H Stability Error (A)[A]$$3580 IES Serum Standard Solution H Stability Error (A)[A]$$3581 IES Serum Standard Solution L Stability Error (A)[A]$$3582 IES Serum Standard Solution L Stability Error (A)[A]$$3583 IES Urine Standard Solution H Stability Error (A)[A]$$3584 IES Urine Standard Solution H Stability Error (A)[A]$$3585 IES Urine Standard Solution L Stability Error (A)[A]$$3586 IES Urine Standard Solution L Stability Error (A)[A]$$3587 Na Concentration Low Error (A)[A]$$3588 Na Concentration Low Error (A)[A]$$3589 Na Concentration Low Error (A)[A]$$3600 Multi Reagent Switch (A, B, C, D, E)[A]$$3601 No Reagent Bottle for RB/ACAL (A, B, C)[A]$$3602 Reagent Short for RB/ACAL/QC (A, B, C)[A]$$3604 Reagent Refrigerator On Use [A]$$3605 RB/ACAL Sample Diluent Short (A, B)[A]$$3606 Check the Tip of Sample Probe (A)[A]$$3607 Check the Tip of R1 Reagent Probe (A)[A]$$3608 Check the Tip of R2 Reagent Probe (A)[A]$$3609 Sample Syringe Prime Incomplete [A]$$3610 Reagent Bottle Illegal Setting (A, B, C)[A]$$3611 Sample Probe Periodic Cleaning (A, B, C)[A]$$3620 Reagent ID Barcode Error (A, B)[A]$$3630 DI Water Short [A]$$3631 DI Water Empty [A]$$3632 DI Water Empty [A]$$3633 DI Water Overflow [A]$$3634 DI Water Supply Unavailable [A]$$3635 DI Water Supply Unavailable [A]$$3636 Master Detergent Empty [A]$$3637 Master Detergent Empty [A]$$3638 Master Detergent Supply Unavailable [A]$$3639 Master Detergent Overflow [A]$$3640 Reagent Probe Position Illegal (A, B)[A]$$3641 Photometry Error During a Cuvette Wash (A, B, C)[A]$$3901 ANL Program Error (A, B, C)[A, B]$$3902 ANL Program Error 1 (A, B, C, D)[A, B]$$3903 ANL Program Error 2 (A, B, C, D, E)[A, B]$$3904 ANL Program Error 3 (A, B, C, D, E, F)[A, B]$$3905 ANL Mechanical Error (A, B, C)[A, B, C, D, E]$$3906 ANL Mechanical Error 1 (A, B, C, D)[A, B, C, D, E]$$3907 ANL Mechanical Error 2 (A, B, C, D, E)[A, B, C, D, E]$$3908 ANL Mechanical Error 3 (A, B, C, D, E, F)[A, B, C, D, E]$$3909 ANL Debug Information 1 (A, B, C, D, E, F, G, H, I, J)$$3910 ANL Debug Information 2 (A, B, C, D, E, F)[A, B]$$3911 ANL Debug Information 3 (A, B, C, D, E, F, G, H, I, J)$$3912 ANL Debug Information 4 (A, B, C, D, E, F, G, H, I, J)$$5001 ANL PROGRAM DOWNLOAD COMPLETED$$5002 INITIALIZE$$5003 WARM UP$$5004 STANDBY$$5005 MEASURE START$$5006 LAST RACK$$5007 SHIFT TO PAUSE$$5008 SHIFT TO STOP MODE$$5009 PAUSE$$5010 STOP$$5011 SYSTEM END$$5012 W1 START (A)$$5013 W2 START (A)$$5014 PHOTOCAL START (A)$$5015 W1 END (A)$$5016 W2 END (A)$$5017 PHOTOCAL END (A)$$5018 PHOTOCAL FAILURE (A, B)$$5020 MEASURE END$$5021 SHIFT TO STOP$$5022 W1 FAILURE (A, B)$$5023 W2 FAILURE (A, B)$$5028 BLANK INDEX DELETED (A)$$5029 BLANK REACTION DATA DELETED (A)$$5030 BLANK QC INDEX DELETED (A)$$5031 INDEX UPDATED (A)$$5032 INDEX DELETED (A)$$5033 REACTION DATA DELETED (A)$$5034 QC INDEX DELETED (A)$$5041 ISE CALIBRATION START (A)$$5042 ISE SELECTIVITY CHECK SATRT (A)$$5043 ISE CRS CALIBRATION START (A)$$5044 ISE CLEANING START (A)$$5045 ISE CLEANING ENHANCED START (A)$$5046 ISE CALIBRATION END (A)$$5047 ISE SELECTIVITY CHECK END (A)$$5048 ISE CRS CALIBRATION END (A)$$5049 ISE CLEANING END (A)$$5050 ISE CLEANING ENHANCED END (A)$$5051 POWER ON$$5090 LOGIN (A, B)$$5091 LOGOUT (A, B)$$5092 LOGIN FAILURE (A)$$5093 PASSWORD CHANGE FAILURE (A)$$5101 NO REAGENT BOTTLE (A, B, C, D, E)$$5103 REAGENT ID READ ERROR (A, B, C)$$5104 REAGENT ID READ ERROR (A, B, C)$$5105 REAGENT ID NOT DEFINED (A, B, C, D)$$5106 ILLEGAL REAGENT TYPE (A, B, C)$$5107 R2 REAGENT FOUND IN THE R1 REFRIGERATOR (A, B, C, D)$$5108 R1 REAGENT FOUND IN THE R2 REFRIGERATOR (A, B, C, D)$$5109 ILLEGAL BOTTLE TYPE (A, B, C)$$5110 ILLEGAL REAGENT POSITION (A, B, C)$$5111 REAGENT EXPIRED (A, B, C, D)$$5112 DIFFERENT LOT NO. REAGENT FOUND (A, B, C, D)$$5114 REAGENT TYPE CONVERTED (A, B, C)$$5115 BOTTLE TYPE CONVERTED (A, B, C)$$5116 THE REAGENT VOLUME EXCEEDED THE LIMIT (A, B, C, D, E)$$5201 PHOTOCAL DATA ERROR (A)$$5202 CUVETTE MEAN CHECK ERROR (A)$$5203 PHOTOCAL LAMP CHECK ERROR (A)$$5251 INCUBATION BATH TEMPERATURE HIGH (A)$$5252 INCUBATION BATH TEMPERATURE LOW (A)$$5253 REAGENT REFRIGERATOR TEMPERATURE HIGH (A)$$5254 REAGENT REFRIGERATOR TEMPERATURE LOW (A)$$5301 PANIC VALUE (A, B, C, D, E, F)$$5302 HbA1c PRETREATMENT CHECK RANGE ERROR (A, B, C, D-E, F)$$5303 HbA1c% CALCULATION FAILED (A, B, C, D-E, F)$$5304 NO COLOR DATA (A, B, C, D-E, F)$$5305 NO BLANK DATA (A, B, C, D-E, F)$$5306 RB DATA ERROR (A, B, C, D, E, F)$$5307 CALIBRATION FACTOR RANGE OVER (A, B, C, D, E, F)$$5308 CALIBRATION FACTOR RANGE UNDER (A, B, C, D, E, F)$$5309 CALIBRATION OD RANGE OVER (A, B, C, D, E, F)$$5310 CALIBRATION OD RANGE UNDER (A, B, C, D, E, F)$$5311 CALIBRATION ERROR (A, B, C, D, E, F)$$5312 MULTIPOINT-CAL. OD SLOPE CHECK ERROR (A, B, C, D, E)$$5313 1/2 POINT-CAL. CORRECTION FACTOR ERROR (A, B, C, D, E)$$5314 QC DATA RANGE OVER (A, B, C, D, E, F)$$5315 QC DATA RANGE UNDER (A, B, C, D, E, F, G)$$5316 QC DATA MULTI-RULE CHECK ERROR (A, B, C, D, E, F)$$5317 QC DATA DEVIATION CHECK ERROR (A, B, C, D, E, F, G)$$5318 ISE CRS CALIBRATION FAILED (A)$$5319 HbA1c% LOT NO. UNMATCHED (A, B, C, D-E, F)$$5320 REACTION PROFILE CHECK ERROR (A, B, C, D, E, F, G, H)$$5321 RATE REVERSE REACTION CHECK ERROR (A, B, C, D, E)$$5322 LINEARITY CHECK ERROR (A, B, C, D, E)$$5323 REACTION PROFILE CHECK CONSECUTIVE JUDGEMENT$$ERROR (A, B)$$5401 NO SAMPLE CUP (A, B, C-D, E)$$5402 SAMPLE NOP (A, B, C-D, E)$$5403 SAMPLE ID NOT FOUND (A, B, C-D, E)$$5404 NO TESTS REQUISITIONED (A, B, C-D, E)$$5405 MAXIMUM NUMBER OF SAMPLE (A, B, C-D, E)$$5406 SAMPLE NO. CALCURATE ERROR (A, B-C)$$5407 BROKEN LABEL (A, B-C, D)$$5408 SAMPLE ID READ ERROR (A, B-C)$$5409 MEASURE COMPLETED FOR THE READ SAMPLE ID (A, B-C, D)$$5410 MEASURE COMPLETED FOR THE READ SAMPLE ID (A, B-C, D)$$5411 MEASURE COMPLETED FOR THE READ SAMPLE ID (A, B-C, D)$$5412 CAN NOT SET THE RACK IN THIS POSITION (A,B)$$5413 RB RACK SETTING ERROR (A)$$5414 ILLEGAL SAMPLE ID (A-B, C)$$5415 NORMAL REPEAT NOT AVAILABLE (A-B, C)$$5416 A part of test requisition has been deleted on Calibration or QC$$Rack Requisition menu. (A,B)$$5501 THERE IS A DANGER THAT THE WAVELENGTH IS NOT$$REGISTERED AS SET (A,B)$$5502 CHECK RELATED PARAMETERS BY MISMATCHING TEST$$CODE (A, B, C \u0026lt;\u0026gt; D)$$5503 CHECK RELATED PARAMETERS BY CHANGING TEST CODE (A, B, C -\u0026gt; D)$$5702 FILE NOT FOUND (A)$$5703 FILE WRITE ERROR (A)$$5751 PRINTER NOT SELECTED$$5753 PART OF DATA IS NOT OUTPUT YET$$5754 PRINTER BUSY$$6010 FAILED TO DELETE SAMPLE (A, B)$$6020 FAILED TO REQUISTION BECAUSE OF MAXIMUM SAMPLE NO. (A, B-C,D)$$6024 NO REAGENT BLANK DATA (A, B, C-D, E)$$6025 NO CALIBRATION DATA (A, B, C, D, E)$$6031 ONLINE ERROR (A)(B C D E)$$6032 ONLINE FORMAT ERROR$$6033 ONLINE ILLEGAL TEXT CODE (A)$$6034 ONLINE ILLEGAL TEXT BLOCK No. (A\u0026lt;-\u0026gt;B)$$6035 ONLINE ILLEGAL SAMPLE NO. (A B) C$$6036 ONLINE ILLEGAL RACK NO. (A B C :D-E) F$$6037 ONLINE ILLEGAL SEX TEXT (A B :C) D$$6038 ONLINE ILLEGAL AGE/MONTH (A B :C D) E$$6039 ONLINE ANALYSIS METHOD MISMATCH (A B :C\u0026lt;\u0026gt;D) E$$6040 ONLINE SAMPLE NO. MISMATCH (A B\u0026lt;\u0026gt;C D) E$$6041 ONLINE RACK NO. MISMATCH (A B :C-D\u0026lt;\u0026gt;E-F) G$$6042 ONLINE MISMATCH (A\u0026lt;\u0026gt;B)$$6043 ONLINE TEST ITEM ERROR (A B) C D$$6044 ONLINE REPEAT ITEM ERROR (A B C)$$6100 ONLINE CONNECTION ERROR (A)(B C D)$$6101 ONLINE ERROR (A)(B C D) E$$6102 ONLINE FORMAT ERROR (A B)(C) D$$6103 ONLINE SET UP ERROR (A B) C,D$$6104 ONLINE REQUISITION INFORMATION RECEIVE ERROR (A B) C,D$$6111 ONLINE ILLEGAL ANALYSIS METHOD (A B) C,D$$6112 ONLINE ILLEGAL SAMPLE KIND (A B) C,D$$6113 ONLINE ILLEGAL SAMPLE TYPE (A B) C,D$$6114 ONLINE ILLEGAL SAMPLE NO. (A B) C,D$$6115 ONLINE ILLEGAL RACK NO. (A B:C-D) E,F$$6116 ONLINE ILLEGAL SEX TEXT (A B:C) D,E$$6117 ONLINE ILLEGAL AGE/MONTH (A B:C D) E,F$$6118 ONLINE ILLEGAL PATIENT INFORMATION (A B:C D) E,F$$6119 ONLINE ILLEGAL SAMPLE ID (A B) C,D$$6120 ONLINE SAMPLE ID MIXED (A\u0026lt;\u0026gt;B) C$$6131 ONLINE ANALYSIS METHOD MISMATCH (A B\u0026lt;\u0026gt;C D) E,F$$6132 ONLINE SAMPLE KIND MISMATCH (A B\u0026lt;\u0026gt;C D) E,F$$6133 ONLINE SAMPLE TYPE MISMATCH (A B\u0026lt;\u0026gt;C D) E,F$$6134 ONLINE SAMPLE NO. MISMATCH (A B\u0026lt;\u0026gt;C D) E,F$$6135 ONLINE RACK NO. MISMATCH (A B:C-D\u0026lt;\u0026gt;E-F) G,H$$6136 ONLINE MISMATCH (A\u0026lt;\u0026gt;B) C$$6151 ONLINE TEST ITEM ERROR (A B:C D) E,F$$6152 ONLINE REPEAT ITEM ERROR (A B) C$$6153 ONLINE SAME SAMPLE ID ERROR (A B) C,D$$6161 ONLINE MAXIMUM SAMPLE NO. ERROR (A B) C,D$$6162 ONLINE SAMPLES REMAINING ERROR (A B) C,D$$6181 ONLINE PENDING TRANSFERS (A,B)$$6182 SAMPLE REGISTRATION WAS DONE FOR HOST DIRECTION (A B) C,D$$6183 THERE IS UNPROCESSED SAMPLE AT CURRENT INDEX$$6500 PROService COMMUNICATION DATA ERROR (A B)$$6501 PROService COMMUNICATION BUFFER FULL (A B)$$6502 PROService COMMUNICATION TIMEOUT ERROR (A B)$$6503 PROService FILE TRANSFER FOLDER FULL (A)$$6504 FAILED TO LAUNCH THE BROWSER$$6801 PrepLink COMMUNICATION ERROR (A, B)$$6802 CHEM ID NOT FOUND (A)$$6803 CALCULATED TEST ERROR (A, B)$$7001 SET CALIBRATION INFORMATION (A, B)$$7002 OVER MAXIMUM SETTING OF SAMPLE BLANK (A)$$7003 NO REAGENT PARAMETER (A, B)$$7011 SET CALIBRATION INFORMATION (A, B, C)$$7012 PERFORM CALIBRATION (A, B, C)$$7013 SET CALIBRATOR INFORMATION (A, B, C)$$7014 UNIT OF CONC IS CHANGED. (A, B, C)$$8001 DPR-ANL COMMUNICATION ERROR (A, B)$$8002 DPR-ISE COMMUNICATION ERROR (A, B)$$8003 DPR-ANL COMMUNICATION TIMEOUT (A)$$8010 DIFFERENT VERSION OF FILE (A,B)$$8011 NO DATA FILE (A,B)$$8100 PRINTER ERROR$$8200 ALARM NO. NOT FOUND (A)$$8500 SAMPLE MANAGER EDIT (A, B, C, D)$$8501 QC DATA EDIT (A, B, C, D, E)$$8502 OVERWRITTEN BY REPEAT (A, B, C, D)$$8503 RECALCULATE DATA (A,B,C)$$8504 DATA CORRECTION (A,B,C)$$8505 SAMPLE ID EDIT (A,B,C)$$8506 DATA UPDATE ERROR (A, B)$$8507 A SAME SAMPLE ID EXISTS (A,B,C)$$8508 RECALCULATE CALIBRATION DATA (A,B,C,D,E,F,G,H)$$9000 PROGRAM ERROR (･･･)$$9001 PROGRAM INF (･･･)$$9999 DEBUG INF (･･･)$$\u0026#34; s explain=\u0026#34;分析仪未接收到控制电脑传送的文本$$控制单元未接收到样本信息传送的文本$$样本未接收到控制单元传送的文本$$控制电脑与生化仪之间通讯错误$$样本信息通讯错误$$控制单元通讯错误$$文本标识信息不匹配（DPR与ANL之间)$$文本接受错误$$分布式控制第一级错误(生化仪内控制部分错误)$$分布式控制第二级错误(生化仪内控制部分错误）$$电机控制器错误$$条码阅读器通讯错误 $$电路板输入输出错误 $$内圈样品传输单元？上下运动错误$$内圈样品传输单元上下运动错误$$内圈样品传输单元旋转运动错误$$内圈样品分配器（注射器）运行错误$$内圈内冲洗分配器（注射器）运行错误$$外圈样品传输单元上下运动错误$$外圈样品传输单元上下运动错误$$外圈样品传输单元旋转运动错误$$外圈样品分配器（注射器）运行错误$$外圈内冲洗分配器（注射器）运行错误$$样本传输单元初始化错误$$比色杯冲洗单元错误$$比色杯冲洗分配器失效$$样品/R1搅拌单元上下运动错误$$样品/R1搅拌单元旋转运动错误$$样品/R1搅拌棒转动错误$$R2搅拌器上下运动错误$$R2搅拌器旋转运动错误$$R2搅拌棒转动错误$$内圈R1试剂传输单元上下运动错误$$内圈R1试剂传输单元上下运动错误$$内圈R1试剂传输单元旋转运动错误$$内圈R1试剂针分配器错误$$内圈R1试剂传输单元内冲洗分配器失效$$外圈R1试剂传输单元上下运动错误$$外圈R1试剂传输单元上下运动错误$$外圈R1试剂传输单元旋转运动错误$$外圈R1试剂传输单元分配器错误$$外圈R1试剂传输单元内冲洗分配器失效$$R1试剂传输单元运动初始化错误$$内圈R2试剂传输单元上下运动错误$$内圈R2试剂传输单元上下运动错误$$内圈R2试剂传输单元旋转运动错误$$内圈R2试剂传输单元分配器错误$$内圈R2试剂传输单元内冲洗分配器失效$$外圈R2试剂传输单元上下运动错误$$外圈R2试剂传输单元上下运动错误$$外圈R2试剂传输单元旋转运动错误$$外圈R2试剂传输单元分配器错误$$外圈R2试剂传输单元内冲洗分配器失效$$R2试剂传输单元运动初始化错误$$R1试剂仓单元错误$$R2试剂仓单元错误$$比色杯轮盘错误$$样本推板单元错误$$光度测定控制器错误1$$光度测定控制器错误2$$加热器控制错误 1$$加热器控制错误 2$$制冷单元错误$$孵育室温度超出范围$$制冷单元错误$$样品针液面探测错误$$样品针液面探测错误$$样品针堵孔探测错误$$R1试剂针液面探测错误$$R1试剂针液面探测错误$$R2试剂针液面探测错误$$R2试剂针液面探测错误$$HBA1c冲洗池浇注错误$$HBA1c冲洗池排水错误$$样本量少$$样本针堵孔$$样品针吸样量少$$样品针清洗液少$$样品针清洗液空$$样品针清洗液空$$样品针W2清洗液空$$样品预稀释液少$$样品预稀释液已使用完$$样品预稀释液已使用完$$样品预稀释液空$$样品预稀释液空$$R1试剂少$$R1试剂已使用完$$R1试剂已使用完$$R1试剂空$$R1试剂空$$R1试剂针清洗液少$$R1试剂针清洗液空$$R1试剂针清洗液空$$R1试剂针W2清洗液少$$R1试剂针冷却水供应错误$$R2试剂少$$R2试剂已使用完$$R2试剂已使用完$$R2试剂空$$R2试剂空$$R2试剂针清洗液少$$R2试剂针清洗液空$$R2试剂针清洗液空$$R2试剂针W2清洗液少$$R2试剂针水供应错误$$清洗原液空$$清洗液空$$清洗液溢出$$清洗液溢出$$真空压力弱$$真空罐满$$浓废液罐满$$淡废液罐满$$清洗液供应不足？$$光度测量单元错误$$光度测量数据错误$$光源灯关闭$$光源灯暗$$R1试剂仓盖打开$$R1试剂仓盖打开$$R2试剂仓盖打开$$R2试剂仓盖打开$$样品架固定单元进样错误$$样品架收集单元出架错误$$条码阅读器错误？$$条码阅读器错误？$$缓冲区样品架水平移动错误$$缓冲区样品架推杆错误$$缓冲区样品架上下移动错误$$样品架传输带错误$$分配轨道样本架进样错误$$样品架卸载单元出架错误$$样本架卸载单元推板错误$$重测架进样错误$$分析仪传输带错误$$分析仪传输推板错误$$分析仪分配带错误$$分析仪分配带推板错误$$分析仪分配带推板错误$$分析仪分配带推板错误$$分析仪分配带推板错误$$分析仪分配带挡板错误$$分析仪样品架进样轨道错误$$分析仪重测轨道错误$$分析仪变轨单元错误$$分析仪变轨单元挡板错误$$电解质传输轨道错误$$电解质传输轨道挡板错误$$电解质分配轨道错误$$电解质分配轨道挡板错误$$电解质重测轨道带错误$$传输轨道样本架运行错误$$分配轨道样本架运行错误$$传输轨道样本架卡住$$分配轨道样本架卡住$$重测轨道样本架卡住$$探测到传输轨道进架禁止信号$$探测到分配轨道进架禁止信号$$样本单元卡架$$样本架类型读取错误$$样品架类型不匹配$$样本架进样错误$$样本架进样同步错误$$样品架条形码阅读错误$$试剂空白未完成$$定标未完成$$质控未完成$$样品架设置错误$$样品架缓冲区盖子打开$$样品架缓冲区盖子打开$$样本架进样停止$$样本架进样停止$$无样品架$$样品架条码阅读错误$$急诊位置盖子打开$$无急诊架$$重测样品架条码阅读错误$$出现电源故障$$样本条形码阅读错误$$制造商参数设定错误$$通讯单元错误$$补充清洗液少$$开始检测失败$$探测比色杯错误$$传输轨道初始化错误$$分配轨道初始化错误$$样本架卸载单元样本架满或者无卸载盘$$无急诊架$$样本架滞留在传输轨道进样单元$$样本架滞留在分配轨道进样单元$$样本架滞留在重测轨道进样单元$$样本架卸载单元样本架满$$样本架卸载单元样本架满或者无卸载盘$$无样本架卸载盘$$样品架滞留在条码阅读器位置$$样本架滞留在样本架传输单元$$样本架滞留在卸载单元$$样本架滞留在缓冲区单元$$样本架滞留在分析仪传输轨道$$样本架滞留在分析仪分配轨道$$样本架滞留在分析仪重测轨道$$样本架滞留在电解质传输轨道$$样本架滞留在电解质分配轨道$$样本架滞留在电解质重测轨道$$急诊架进样单元样本架非法设置$$无样本架收集盘$$无样本架装载盘$$自动化系统样本架进样单元错误$$样本架卸载单元错误$$样本架卸载单元满$$无样本架收集盘$$样本架条形码阅读错误$$自动化系统样本架出架无法完成$$样本架卸载无法完成$$仪器联接自动化时样本架非法设定$$自动化系统样本架进样程序错误$$自动化系统样本架出架程序错误$$自动化系统样本架出架程序错误$$样本架在进入自动化系统时卡架$$样本架从自动化系统卸载时卡架$$电解质控制器通讯失败$$电解质样本传送单元上下运动错误$$电解质样本传送单元旋转运动错误$$电解质样本针液面探测器错误$$电解质样本分配器错误$$电解质样本针内部清洗分配器错误$$电解质样本分配器压力探测错误$$电解质缓冲液分配器错误$$电解质缓冲液分配器错误$$电解质样品混合池液面传感器错误$$电解质样品混合池液面传感器错误$$电解质样品混合池溢出$$电解质样品混合池溢出$$电解质模拟放大器电源模块错误$$电解质模拟放大器电源模块错误$$电解质样本注射器灌注未完成$$电解质定标液非法设定$$电解质废液排放未完成？$$电解质数据处理器错误$$电解质数据处理器错误$$电解质数据处理器错误$$电解质搅拌马达错误$$电解质搅拌马达错误$$电解质内标液蠕动泵错误$$电解质内标液蠕动泵错误$$电解质吸样蠕动泵错误$$电解质吸样蠕动泵错误$$电解质单元控制错误$$电解质单元控制错误 $$电解质样本量少$$电解质样品针清洗液少$$电解质样本针清洗液已用完$$电解质样本针清洗液已用完$$电解质样本针探测到凝块$$样本针吸样失败$$电解质缓冲液少$$电解质内标液少$$电解质参比液少$$电解质清洗液少$$电解质血清高值定标液少$$电解质血清低值定标液少$$电解质尿液高值定标液少$$电解质尿液低值定标液少$$电解质Na电极选择性检查液少$$电解质K电极选择性检查液少$$电解质CRS标准液（高值）少$$电解质CRS标准液（中值）少$$电解质CRS标准液（低值）少$$电解质CRS标准液（高值）少（尿液）$$电解质CRS标准液（中值）少（尿液）$$电解质CRS标准液（低值）少（尿液）$$电解质上盖未盖好$$电解质上盖未盖好$$电解质样品针撞针$$浓缩计算失败？$$浓缩计算失败？$$电解质顺序运行错误$$电解质顺序运行错误$$电解质预测量中值定标液稳定性错误$$电解质预测量中值定标液稳定性错误$$电解质内标液稳定性错误(测量中）$$电解质内标液稳定性错误(测量中）$$电解质血清标准液（高值）稳定性错误$$电解质血清标准液（高值）稳定性错误$$电解质血清标准液（低值）稳定性错误$$电解质血清标准液（低值）稳定性错误$$电解质尿液标准液（高值）稳定性错误$$电解质尿液标准液（高值）稳定性错误$$电解质尿液标准液（低值）稳定性错误$$电解质尿液标准液（低值）稳定性错误$$钠低浓度值错误$$钠低浓度值错误$$钠低浓度值错误$$试剂瓶更换$$试剂空白/定标无试剂瓶$$试剂空白/定标试剂少$$试剂仓正在使用$$试剂空白/定标预稀释液少$$样品针撞针$$R1试剂针撞针$$R2试剂针撞针$$样品针灌注未完成$$试剂瓶非法设置$$样本针定期清洗$$试剂条形码错误（诊断检查时）$$去离子水少$$去离子水空$$去离子水空$$去离子水溢出$$去离子水供应不足$$去离子水供应不足$$清洗原液空$$清洗原液空$$清洗原液供应不足$$清洗原液溢出$$试剂针位置错误$$清洗样品杯过程中出现光度测量错误$$分析仪程序错误$$分析仪程序错误1$$分析仪程序错误2$$分析仪程序错误3$$分析仪机械错误$$分析仪机械错误1$$分析仪机械错误2$$分析仪机械错误3$$分析仪修正信息$$分析仪修正信息$$分析仪修正信息$$分析仪修正信息$$分析仪程序下载完成$$初始化$$预热$$待机$$运行开始$$最后样品架$$测量转换到暂停状态$$测量转换到停止状态$$暂停$$停止$$系统停止$$W1清洗开始$$W2清洗开始$$光校准开始$$W1清洗结束$$W2清洗结束$$光校准结束$$光校准失败$$测试结束$$转向停止$$W1清洗失败$$W2清洗失败$$空白索引删除$$空白反应数据删除$$空白质控索引删除$$日期索引更新$$日期索引删除$$反应数据被删除$$质控索引删除$$电解质定标开始$$电解质电极选择性检查开始$$电解质CRS定标开始$$电解质清洗开始$$电解质增强型清洗开始$$电解质定标完成$$电解质电极选择性检查完成$$电解质CRS定标完成$$电解质清洗完成$$电解质增强型清洗完成$$开机$$登录$$注销$$登录失败$$改密失败$$无试剂瓶$$试剂条码阅读错误$$试剂条码阅读错误$$试剂条码未定义$$非法试剂类型$$R2试剂瓶被发现放置在R1试剂仓内$$R1试剂瓶被发现放置在R2试剂仓内$$非法试剂瓶类型$$非法试剂瓶位置$$试剂过期$$某试剂被发现有不同批号试剂在一起使用$$试剂类型更换$$试剂瓶类型更换$$试剂体积超过上限$$光电校正数据错误$$比色杯平均值检查错误$$光电校正光源灯检查错误$$孵育室温度高$$孵育室温度低$$试剂仓温度高$$试剂仓温度低$$危险测量值$$HbA1c预处理检查范围错误$$HbA1c计算检查失败$$无颜色数据$$无空白数据$$试剂空白数据错误$$定标因数高出范围$$定标因数低于范围$$定标吸光度高出范围$$定标吸光度低于范围$$定标错误$$多点定标吸光度斜率检查错误$$1/2点定标校正因子错误$$质控数据超出范围$$质控数据低于范围$$质控数据多规则检查错误$$质控数据偏离检查错误$$电解质CRS定标失败$$HbA1c批号不匹配$$反应曲线检查错误？$$速率法下降反应检查错误？$$线性检查错误$$$$反应曲线连续调整错误$$无样品杯（管）$$样品无申请单$$样品管无条形码$$此样品无测试项目申请$$此样品申请号超出最大样品号$$样本计算错误$$破损标签$$样品条形码阅读错误$$读条形码的样品测量完成$$读条形码的样品测量完成$$读条形码的样品测量完成$$样品架使用错误$$RB样本架设置错误$$不合格样品ID$$常规重测不可用$$$$校准/质控申请目录一部分测试申请已取消$$$$存在一个波长没有按设定进行写入的危险$$$$测试代码不匹配时检查相关参数$$改变测试代码时检查相关参数$$文件未找到$$文件写入错误$$未选择打印机$$部分数据仍未输出$$打印机繁忙$$删除样本失败$$因达最大样本号无法申请项目$$无试剂空白数据$$无校准数据$$在线传输错误$$在线传输格式错误$$在线传输非法文本代码$$在线传输非法文本块编号$$在线传输非法样品号$$在线传输非法样品架号$$在线传输非法性别文本$$在线传输非法年龄/日期$$在线传输分析方法不匹配$$在线传输样品号匹配不当$$在线传输非法样品架号匹配不当$$在线传送与接收内容不配$$在线传输测量项目错误$$在线传输复查项目错误$$在线传输联接错误$$在线传输错误$$在线传输格式错误$$在线传输设置错误$$在线传输样本申请信息接收错误$$在线传输非法分析方法$$在线传输非法样本种类$$在线传输非法样本类型$$在线传输非法样本号$$在线传输非法样本架号$$在线传输非法性别信息$$在线传输非法年龄/日期$$在线传输非法病人信息$$在线传输非法样本ID$$在线传输样本ID混合$$在线传输分析方法不匹配$$在线传输样本种类不匹配$$在线传输样本类型不匹配$$在线传输样本号不匹配$$在线传输样本架号不匹配$$在线传送与接收内容不配$$在线传输测量项目错误$$在线传输复查项目错误$$在线传输相同样本ID错误$$在线传输最大样本号错误$$在线传输样本存在错误$$在线传输等待传输$$样本登记按照主机指示完成$$当前索引有未完成的样本$$$$$$$$$$启动浏览程序失败$$perplink 传输错误$$项目ID未找到$$测试计算错误$$设置定标信息$$样本空白超过最大设定值$$无试剂参数$$设置定标信息$$执行定标$$设置定标品信息$$测量单位已改变$$控制电脑与生化仪之间通讯错误$$控制电脑与电解质模块之间通讯错误$$控制电脑与生化仪之间通讯错误$$不同版本文件$$无数据文件$$打印机错误$$报警号未发现$$数据管理编辑$$质控数据编辑$$自动重测数据覆盖原始数据$$重新计算数据$$数据修正$$样本ID编辑$$数据更新错误$$样本ID重复$$重新计算定标数据$$程序错误$$程序文件$$修正文件$$\u0026#34; 贝克曼流水线Remisol 1 2 3 s MachineName=\u0026#34;BKMLSX\u0026#34; s police=\u0026#34;Y$$U$$y$$u$$@$$＄$$D$$B$$*$$＆$$Z$$E$$Fx$$Gx$$！$$）$$a$$ba$$bh$$bn$$bz$$F$$G$$ph$$pl$$T$$J$$K$$fh$$fl$$Va$$xQ$$1Q$$2Q$$3Q$$4Q$$5Q$$6Q$$7Q$$\u0026#34; s explain=\u0026#34;试剂空白OD超出最后一次光度测量读数点设定的上限$$试剂空白OD超出最后一次光度测量读数点设定的下限$$试剂空白或第一个光读点的常规（患者）OD高$$试剂空白或第一个光读点的常规（患者）OD低$$OD高于3$$没有足够的数据来确定反映的线性$$反映的OD值高于最高OD范围$$反映的OD值高于最低OD范围$$速率法中的线性错误$$前带测试数据异常$$前带错误$$在速率法检测中检测到了过度反应$$结果（OD)高于动态范围$$结果（OD)低于动态范围$$无法计算浓度$$样品分析时使用的试剂批号与用于RB/定标的批号不同$$试剂已过期$$没有定标数据或过期$$由于最近的定标或试剂空白失败，因此采用先前成功保存的定标或试剂空白数据计算结果$$使用了主曲线$$使用了前带数据的定标曲线$$结果高于动态范围$$结果低于动态范围$$结果低于危急值上限$$结果高于危急值上限$$Checked Tests Menu(已检查的测试菜单）中编定的可选计算测试检查中发现异常$$结果高于重测判定范围$$结果低于重测判定范围$$结果高于重测反射范围$$结果低于重测反射范围$$多次测量结果的偏差超出范围$$多规则质控在其他质控样品中检测失败$$质控数据超出在Single Check Level(单次检查水平）字段中输入的范围$$质控数据超出13S质控范围$$质控数据超出23S质控范围$$质控数据超出R4S质控范围$$质控数据超出41S质控范围$$预设数目的连续质控结果均偏向均值一侧$$连续的质控结果反映了持续上升或下降的值$$\u0026#34; 斯塔高stargo(数字、符号) 1 2 3 4 5 6 s MachineName=\u0026#34;StarGoNum\u0026#34; s police=\u0026#34;1$$2$$3$$4$$6$$8\u0026#34; s explain=\u0026#34;To be validated$$Tech error$$\u0026gt;Mmax$$\u0026lt;Mmin$$QNS$$Linearity\u0026#34; s MachineName=\u0026#34;StarGoLet\u0026#34; s police=\u0026#34;@$$A$$C$$D$$E$$F$$G$$H$$I$$J$$K$$L$$M$$N$$O\u0026#34; s explain=\u0026#34;No alarm code$$Result Confirmed with T \u0026gt; Tmax$$Quality Control Out of range or not done$$Quality Control Forced confirmation$$Level detection number 3 not managed$$Level detection number 2 not managed$$Level detection number 1 not managed$$Result Value in primary units skewed$$Result Dilution change$$Result Rerun test$$Reagent drawer Temperature out of limit$$Syringe Arm #3 Maintenance date overdue Syringe Maintenance date overdue$$Syringe Arm #2 Maintenance date overdue$$Syringe Arm #1 Maintenance date overdue$$Double measurement tolerance\u0026#34; ","date":"2025-08-29T00:00:00Z","image":"https://work.717170.xyz/img/title.jpg","permalink":"https://work.717170.xyz/p/%E4%BB%AA%E5%99%A8%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-20250829163158/","title":"仪器报警信息"},{"content":" 方法存放在MI.Special目录中，后期整合公共方法都会放进Common类中，私有方法放单独类或者公共Common中\n公共方法 通过通道号获取检测项目 Code2TCDR 1 2 3 4 5 6 7 8 9 10 11 12 ClassMethod Code2TCDR(mi, code) { s mi=$g(mi),code=$g(code) s ret=\u0026#34;\u0026#34; i \u0026#39;$l(mi) q ret i \u0026#39;$l(code) q ret i $d(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexResultChannel\u0026#34;,mi,code)) d .s BTMIMachineTestCodeDR=$o(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexResultChannel\u0026#34;,mi,code,\u0026#34;\u0026#34;)) .s TestCodeDR=$lg($g(^dbo.BTMIMachineTestCodeD(BTMIMachineTestCodeDR)),3) .s ret=TestCodeDR q ret } 保存架子号 SaveRackNo 20250329 ！！！额外调用保存标本操作日志接口（SaveRecord），dbo.BTOperatorType 新增101（架子号更新）数据\n20250330 如果架子号相同时不增加标本操作日志\n20250821 如果操作类型为上机，增加上机日志，类型为 6\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 /// 保存归档,分类信息,架子号,新增保存类型和参数工作小组ID，针对仪器不在对应的工作小组也可以保存架子号。 /// D ##class(MI.Special.Common).SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) /// D ##class(MI.Special.Common).SaveRackNo(\u0026#34;9000000193\u0026#34;,\u0026#34;50-1\u0026#34;,\u0026#34;6\u0026#34;,\u0026#34;上机\u0026#34;) ClassMethod SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) { s labno=$g(labno) s positioninfo=$g(positioninfo) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),typename=$g(typename) i \u0026#39;$L(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $l(typename) s positioninfo=typename_\u0026#34;:\u0026#34;_positioninfo s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo),objrep.RackNo\u0026#39;=positioninfo try{j ..SaveRecord(labno,\u0026#34;架子号位置更新:\u0026#34;_objrep.RackNo_\u0026#34;--\u0026gt;\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;)}catch{}\t//架子号更新 .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....i typename=\u0026#34;上机\u0026#34; try{j ..SaveRecord(labno,\u0026#34;仪器上机:\u0026#34;_positioninfo,mi,\u0026#34;6\u0026#34;)}catch{} .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,\u0026#34;-1^存\u0026#34;_typename_\u0026#34;信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i $l(objrep.RackNo),objrep.RackNo\u0026#39;=positioninfo try{j ..SaveRecord(labno,\u0026#34;架子号位置更新:\u0026#34;_objrep.RackNo_\u0026#34;--\u0026gt;\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;)}catch{}\t//架子号更新 .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .i typename=\u0026#34;上机\u0026#34; try{j ..SaveRecord(labno,\u0026#34;仪器上机:\u0026#34;_positioninfo,mi,\u0026#34;6\u0026#34;)}catch{} .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q hasFindRep } /// 记录标本日志 /// D ##class(MI.Special.Common).SaveRecord(\u0026#34;9000000193\u0026#34;,\u0026#34;仪器上机:上机:50-1--\u0026gt;上机:50-1\u0026#34;,\u0026#34;6\u0026#34;,\u0026#34;100\u0026#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode, curWorkGroupMachineDR) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s OperateTypeCode=$g(OperateTypeCode) i \u0026#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,\u0026#34;,\u0026#34;,2),\u0026#34;\u0026#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,\u0026#34;\u0026#34;) } BAK 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 /// 保存架子号 /// D ##class(MI.Special.Common).SaveRackNo(mi,labno, positioninfo) ClassMethod SaveRackNo(mi, labno, positioninfo) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s CanDoTS=0 .....i $d(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,ReportDR)) d ......s TestSetDR=\u0026#34;\u0026#34; f s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,ReportDR,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; d .......i $d(^dbo.BTTestSetWorkGroupMachineI(\u0026#34;IndexWorkGroupMachine\u0026#34;,curWorkGroupMachineDR,TestSetDR)) d ........s CanDoTS=1 .....i CanDoTS=0 q .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,\u0026#34;-1^存位置信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } 保存报警信息 20250329 将处理好后的报警信息存入到评价信息\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 /// 保存评价信息(仪器报警信息等提示信息) /// 条码号或者流水号，存储信息，仪器主键，工作小组(仪器和工作小组非关联使用)，是否打印(1 主评价，0 次评价) /// D ##class(MI.Special.Common).SaveAlarmInformation(\u0026#34;1003791311\u0026#34;,\u0026#34;Lymphopenia：淋巴细胞减少；Anemia：贫血；Reticulocytosis：网织红细胞增多\u0026#34;,\u0026#34;3\u0026#34;) ClassMethod SaveAlarmInformation(labno, conclusion, predealMI, curWorkGroupMachineDR, IsPrint) { s labno=$g(labno),conclusion=$g(conclusion),predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),IsPrint=$g(IsPrint) i \u0026#39;$l(predealMI),\u0026#39;$l(curWorkGroupMachineDR) q \u0026#34;\u0026#34; i IsPrint\u0026#39;=1 s IsPrint=\u0026#34;0\u0026#34;\t//1 打印主评价，0 不打印次评价 i \u0026#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....;i Status=\u0026#34;3\u0026#34; q\t//审核后的标本存储报警信息，测试用 .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i IsPrint=1 d ......i $l(objrep.MajorConclusion) s objrep.MajorConclusion=objrep.MajorConclusion_\u0026#34;,\u0026#34;_conclusion ......e s objrep.MajorConclusion=conclusion .....e d ......i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_\u0026#34;,\u0026#34;_conclusion ......e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i IsPrint=1 d ..s objrep.MajorConclusion=conclusion .e s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) try{D ##class(MI.Special.Common).SaveResultWarned(labno,conclusion,predealMI, curWorkGroupMachineDR)}catch{}\t//保存至报告表报警信息 q \u0026#34;1\u0026#34; } BAK 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 /// Creator： yanghaoran /// CreatDate： 20240828 /// Description： 保存报警提示信息 /// Input： mi 仪器主键,epis 流水号,expertRules 报警信息,expertRulesType 报警信息仪器类型(存在值将报警信息进行转换，不存在则直接保存报警信息) /// SaveTypeData (分隔符^)保存类型(1:次评价不打印，2:主评价可打印)，为空默认为1 /// 是否保存未转换数据(1:保存，0:不保存)，为空默认为0 /// Output： /// DeBug:\tw ##Class(MI.Special.Common).SaveAlarmInformation(57,1200150259127,\u0026#34;CSCSCS\u0026#34;) /// DeBug:\tw ##Class(MI.Special.Common).SaveAlarmInformation(2,1892,\u0026#34;Basophilia：嗜碱性粒细胞增加；NRBC?：有核红细胞？；Anisocytosis：红细胞大小不均；Macrocytosis：大红细胞症；Hypochromia：低色素性；WBC_Abn_Scattergram：白细胞异常散点图；IG_Present：幼稚粒细胞存在；PLT_Abn_Distribution：血小板异常直方图；Blasts/Abn_Lympho?：原始细胞/异常淋巴细胞?\u0026#34;) ClassMethod SaveAlarmInformation(mi, epis, expertRules, expertRulesType, SaveTypeData) { s mi=$g(mi) s epis=$g(epis) s expertRules=$g(expertRules) s SaveTypeData=$g(SaveTypeData) s SaveType=$p(SaveTypeData,\u0026#34;^\u0026#34;,1) i \u0026#39;$l(SaveType) s SaveType=1\t// 保存类型(1:次评价不打印，2:主评价可打印)，为空默认为1 s expertRulesIsSave=$p(SaveTypeData,\u0026#34;^\u0026#34;,2) i \u0026#39;$l(expertRulesIsSave) s expertRulesIsSave=\u0026#34;0\u0026#34;\t// 是否保存未转换数据(1:保存，0:不保存)，为空默认为0 s expertRulesType=$g(expertRulesType) // 配置信息 s Sep=\u0026#34;；\u0026#34;\t// 文本串分隔符 // 转换报警信息 i $l(expertRulesType) d .s InputInfo=\u0026#34;\u0026#34; .s PoliceInfo=expertRules .i $l(PoliceInfo),$d(^LISPolice(expertRulesType,PoliceInfo)) d ..s InputInfo=$g(^LISPolice(expertRulesType,PoliceInfo)) ..d Trace^MI.MIF000(MachID,PoliceInfo_\u0026#34;$$\u0026#34;_InputInfo,\u0026#34;报警信息\u0026#34;) .i $l(InputInfo) d ..s expertRules=InputInfo .e d ..i expertRulesIsSave=0 d ...s expertRules=\u0026#34;\u0026#34; ...d Trace^MI.MIF000(MachID,\u0026#34;转换报警信息失败。\u0026#34;,\u0026#34;报警信息异常\u0026#34;) ..e d ...d Trace^MI.MIF000(MachID,\u0026#34;保存原始报警信息。\u0026#34;,\u0026#34;报警信息异常\u0026#34;) i \u0026#39;$l(expertRules) q \u0026#34;\u0026#34; s ReportDR=$$GetReportID(mi,epis) i \u0026#39;$l(ReportDR) q \u0026#34;\u0026#34; s obj=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) s TMPstr=obj.MinorConclusion i TMPstr\u0026#39;[expertRules d .i $l(TMPstr) d ..s Str=TMPstr_Sep_expertRules .e d ..s Str=expertRules .s Str=$$DislodgeRepetition(Str,Sep) .i SaveType=1 d ..s obj.MinorConclusion=Str\t//YHR 20230411 保存在报告次评价 不可打印 .i SaveType=2 d ..s obj.MinorConclusion=Str\t//YHR 20230411 保存在报告主评价 可打印 s ret=obj.%Save() D Trace^MI.MIF000(mi,ret_\u0026#34;$$\u0026#34;_expertRules,\u0026#34;SaveAlarmInformation\u0026#34;) q ret GetReportID(mi,AssayNo) // 根据仪器试验号获取报告ID s mi=$g(mi),AssayNo=$g(AssayNo) s ReportDR=\u0026#34;\u0026#34; i \u0026#39;$l(AssayNo) q ReportDR s WGMachineID=$lg(^dbo.BTMIMachineParameterD(mi),6) i $D(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,AssayNo)) d .s TransmitDate=$zd($p($h,\u0026#34;,\u0026#34;,1),8) .s ReportID=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,AssayNo,TransmitDate,\u0026#34;\u0026#34;),-1) i $l(ReportDR) q ReportDR i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,AssayNo)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,AssayNo,\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1)) d ..s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1,\u0026#34;\u0026#34;),-1) q ReportDR DislodgeRepetition(Str,Sep) // 去除重复信息 s Sep=$g(Sep) i \u0026#39;$l(Sep) s Sep=\u0026#34;；\u0026#34; k ^LISTMPStr s ret=\u0026#34;\u0026#34; f p=1:1:$l(Str,Sep) d .s Strp=$p(Str,Sep,p) .i \u0026#39;$l(Strp) q .s ^LISTMPStr(\u0026#34;Data\u0026#34;,Strp)=\u0026#34;\u0026#34; s GStr=\u0026#34;\u0026#34; f s GStr=$o(^LISTMPStr(\u0026#34;Data\u0026#34;,GStr)) q:GStr=\u0026#34;\u0026#34; d .s ret=ret_Sep_GStr s ret=$e(ret,2,*) k ^LISTMPStr q ret } 获取报警信息Global 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 /// 获取报警信息global /// d ##class(MI.Special.Tool).GetPoliceGlobal() ClassMethod GetPoliceGlobal() { //****MI.Special.PoliceInfo***//\t相关仪器报警信息存储记录 // 用 $$ 分割报警信息代码和解释 s MachineName=\u0026#34;\u0026#34;\t;仪器型号 s police=\u0026#34;\u0026#34;\t;报警信息代码 s explain=\u0026#34;\u0026#34;\t;报警信息解释 ;k ^LISPolice(MachineName) // 如果要覆盖则放开 for i=1:1:$l(police,\u0026#34;$$\u0026#34;) d .s po=$p(police,\u0026#34;$$\u0026#34;,i) .s ex=$p(explain,\u0026#34;$$\u0026#34;,i) .i \u0026#39;$l(po) q .s ^LISPolice(MachineName,po)=ex q } 自动核收 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /// 自动核收方法 /// w ##class(MI.Special.AutomaticReceipt).AutoAccept(\u0026#34;24\u0026#34;,\u0026#34;9000000254\u0026#34;) ClassMethod AutoAccept(mi, barcode) { D Trace^MI.MIF000(mi,\u0026#34;开始自动核收:\u0026#34;_barcode,\u0026#34;自动核收\u0026#34;) s ZDHSret=1 s HSSign=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,barcode)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR)) d ..s HSSign=0 /*------自动核收-------*/ i ($l(barcode)\u0026gt;9)\u0026amp;\u0026amp;((\u0026#39;$d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,barcode)))||(HSSign=0)) d .;s dealret=$$ReceiveLabno^MI.MIF000(mi,barcode) .s dealret=##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(mi,barcode)\t//调用自动核收方法 .d Trace^MI.MIF000(mi,barcode_\u0026#34;核收到仪器返回:\u0026#34;_dealret,\u0026#34;H\u0026lt;--M\u0026#34;) .s HSSign=1 .i dealret[\u0026#34;标本已核收\u0026#34; D Trace^MI.MIF000(mi,\u0026#34;该标本已核收\u0026#34;,\u0026#34;核收返回\u0026#34;) q .i dealret[\u0026#34;排样到\u0026#34; D Trace^MI.MIF000(mi,\u0026#34;该标本已核收\u0026#34;,\u0026#34;核收返回\u0026#34;) q .e i dealret=\u0026#34;1\u0026#34; d ..D Trace^MI.MIF000(mi,\u0026#34;核收成功\u0026#34;,\u0026#34;核收返回\u0026#34;) .e d ..s ZDHSret=0 ..D Trace^MI.MIF000(mi,\u0026#34;该标本核收失败\u0026#34;,\u0026#34;核收返回\u0026#34;) ..s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() ..s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) ..s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) ..s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) ..s perUser = \u0026#34;WG-\u0026#34;_CurWorkGroupDR ..;s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_barcode_\u0026#34;处理核收失败:\u0026#34;_dealret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) /*------自动核收-------*/ q ZDHSret } 消息弹窗 1 2 3 4 5 6 7 8 9 10 11 12 /// 弹窗 /// w ##class(MI.Special.AutomaticReceipt).TanChuang(mi,epis,dealret) ClassMethod TanChuang(mi, epis, dealret) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) s perUser = \u0026#34;WG-\u0026#34;_CurWorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_epis_\u0026#34;处理核收失败:\u0026#34;_dealret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q ret } ‍\n获取该检测项目是否异常 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 /// 获取该检测结果是否异常 /// w ##class(MI.Special.JudgeResult).IsAbFlag(\u0026#34;29\u0026#34;,\u0026#34;24092500125\u0026#34;,\u0026#34;48\u0026#34;,\u0026#34;2\u0026#34;) ClassMethod IsAbFlag(mi, epis, code, res) { s Nres=\u0026#34;\u0026#34; i \u0026#39;$d(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexResultChannel\u0026#34;,mi,code)) q Nres s MachineTCDR=$o(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexResultChannel\u0026#34;,mi,code,\u0026#34;\u0026#34;)) s TestCodeDR=$lg($g(^dbo.BTMIMachineTestCodeD(MachineTCDR)),3) i \u0026#39;$l(TestCodeDR) q Nres s ReportDR=$p($$GetLabnoByEpis(mi,epis),\u0026#34;^\u0026#34;,1) i \u0026#39;$l(ReportDR) q Nres s Range=##Class(LISSP.DHCRPVisitNumberReport).CheckResultAbFlag(ReportDR,TestCodeDR,res) s AbFlag=$lg(Range,1) i $l(AbFlag) d .s Nres=\u0026#34;阳性\u0026#34; e s Nres=\u0026#34;阴性\u0026#34; q Nres GetLabnoByEpis(mi,Epis) s (ret,ReportDR)=\u0026#34;\u0026#34;,mi=$g(mi) s date=$zd($h,8) i \u0026#39;$l(mi) q Epis s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i \u0026#39;$l(WGMachineID) q Epis i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,date,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis))) { s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,date,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis),\u0026#34;\u0026#34;),-1) S VisitNumberDR=$LG($G(^dbo.RPVisitNumberReportD(ReportDR)),2) s ret=$lg(^dbo.RPVisitNumberD(VisitNumberDR),2) } i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis,\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1)) d ..s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1,\u0026#34;\u0026#34;),-1) q ReportDR_\u0026#34;^\u0026#34;_ret } 微生物结果直接保存 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 /// Creator： yanghaoran /// CreatDate： 20240828 /// Description： 微生物质谱结果直接保存 /// Updata： /// Input： mi 仪器主键, Epis 流水号, result 细菌名称, isolateNumber 细菌通道号(为空默认为1(细菌一)) /// Output： /// DeBug:\tw ##class(MI.Special.MakeMidReportNode).MakeMidReportNode(57,\u0026#34;WX241101002\u0026#34;,\u0026#34;金黄色葡萄球菌\u0026#34;) ClassMethod MakeMidReportNode(mi, Epis, result, isolateNumber) As %String { s mi=$g(mi),Epis=$g(Epis) s isolateNumber=$g(isolateNumber) i \u0026#39;$l(isolateNumber) s isolateNumber=1 i \u0026#39;$l(mi) q Epis i \u0026#39;$l(Epis) q Epis i \u0026#39;$l(result) q Epis i $d(^dbo.BTMIMachineMicroBugsI(\u0026#34;IndexChannel\u0026#34;,mi,result)) d .s MMicroBugsDR=$o(^dbo.BTMIMachineMicroBugsI(\u0026#34;IndexChannel\u0026#34;,mi,result,\u0026#34;\u0026#34;)) .s OrganismDR=$lg($g(^dbo.BTMIMachineMicroBugsD(MMicroBugsDR)),4) .i $l(OrganismDR) s result=$lg($g(^dbo.BTOrganismD(OrganismDR)),3) s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s ret=\u0026#34;\u0026#34; s (ReportDR,Labno,VisitNumberDR)=\u0026#34;\u0026#34; i \u0026#39;$l(WGMachineID) q ret i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis))) { s date=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis),\u0026#34;\u0026#34;)) s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis),date,\u0026#34;\u0026#34;)) S VisitNumberDR=$LG($G(^dbo.RPVisitNumberReportD(ReportDR)),2) s Labno=$lg(^dbo.RPVisitNumberD(VisitNumberDR),2) }else{\t// 核收在其他工作小组(一个仪器对应多个工作小组) s QuitFlag=0 s fWGMachineID=\u0026#34;\u0026#34; f s fWGMachineID=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,fWGMachineID)) q:(fWGMachineID=\u0026#34;\u0026#34;)||(QuitFlag=1) d .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,fWGMachineID,##Class(LIS.Util.Common).IndexData(Epis))) d ..s date=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,fWGMachineID,##Class(LIS.Util.Common).IndexData(Epis),\u0026#34;\u0026#34;)) ..s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,fWGMachineID,##Class(LIS.Util.Common).IndexData(Epis),date,\u0026#34;\u0026#34;)) ..S VisitNumberDR=$LG($G(^dbo.RPVisitNumberReportD(ReportDR)),2) ..s Labno=$lg(^dbo.RPVisitNumberD(VisitNumberDR),2) ..s QuitFlag=1 } i \u0026#39;$l(ReportDR),$d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis,\u0026#34;\u0026#34;)) .s WGMachineID=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,\u0026#34;\u0026#34;)) .i \u0026#39;$l(WGMachineID) q .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1)) d ..s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1,\u0026#34;\u0026#34;)) i \u0026#39;$l(ReportDR) q \u0026#34;\u0026#34; i \u0026#39;$d(^dbo.IDPResultI(\u0026#34;IndexIDPElement\u0026#34;,ReportDR,2)) q \u0026#34;\u0026#34;\t//初鉴预报告节点 s IDPResultDR=$o(^dbo.IDPResultI(\u0026#34;IndexIDPElement\u0026#34;,ReportDR,2,\u0026#34;\u0026#34;)) i \u0026#39;$d(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,ReportDR)) q \u0026#34;\u0026#34; s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,ReportDR,\u0026#34;\u0026#34;)) i \u0026#39;$d(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexResultChannel\u0026#34;,mi,isolateNumber)) q \u0026#34;\u0026#34; s MachineTCDR=$o(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexResultChannel\u0026#34;,mi,isolateNumber,\u0026#34;\u0026#34;)) s TestCodeDR=$lg($g(^dbo.BTMIMachineTestCodeD(MachineTCDR)),3) i \u0026#39;$l($g(TestCodeDR)) q \u0026#34;\u0026#34; s ITestCodeDR=TestCodeDR_\u0026#34;^\u0026#34; try{s ret=##Class(IDP.WS.BLL.DHCMidReport).MakeMidReportNodeDo(IDPResultDR,ITestCodeDR,\u0026#34;^\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;^^^^\u0026#34;)}catch{} i $d(^dbo.RPVisitNumberRepMidI(\u0026#34;IndexMidReport\u0026#34;,ReportDR)) d .s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberRepMidI(\u0026#34;IndexMidReport\u0026#34;,ReportDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ..s RepMidDR=$o(^dbo.RPVisitNumberRepMidI(\u0026#34;IndexMidReport\u0026#34;,ReportDR,OrderNo,\u0026#34;\u0026#34;)) ..i $d(^dbo.RPVisitNumberRepMidResI(\u0026#34;IndexMidReportTCItem\u0026#34;,RepMidDR,TestCodeDR)) d ...s RepMidResDR=$o(^dbo.RPVisitNumberRepMidResI(\u0026#34;IndexMidReportTCItem\u0026#34;,RepMidDR,TestCodeDR,\u0026#34;\u0026#34;)) ...s obj=##class(dbo.RPVisitNumberRepMidRes).%OpenId(RepMidResDR) ...s obj.Result=result ...s obj.TextRes=result ...s sc=obj.%Save() ...If ($SYSTEM.Status.IsOK(sc)) {s ret=1} ...Else s ret=\u0026#34;\u0026#34; q ret } 保存报警信息标志 存放报警信息标志至报告表中\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /// 保存报告表报警信息标志 /// D ##class(MI.Special.Common).SaveResultWarned(\u0026#34;1003803130\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;41\u0026#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI, curWorkGroupMachineDR) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) i \u0026#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) i $l(conclusion)\u0026gt;20 s conclusion=$e(conclusion,1,20)_\u0026#34;...\u0026#34; s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } 保存标本操作日志 标本操作日志，保存仪器对于标本的操作等后台对于标本的操作\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /// 记录标本日志 /// D ##class(MI.Special.Common).SaveRecord(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode, curWorkGroupMachineDR) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s OperateTypeCode=$g(OperateTypeCode) i \u0026#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,\u0026#34;,\u0026#34;,2),\u0026#34;\u0026#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,\u0026#34;\u0026#34;) } 去除重复消息 根据分隔符将重复的字符过滤只保留一个\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 /// w ##class(YHR.Problem.ScaleConversion).DislodgeRepetition(\u0026#34;123；223；12；123；22；241\u0026#34;,\u0026#34;；\u0026#34;) ClassMethod DislodgeRepetition(Str, Sep) { // 去除重复信息 s Sep=$g(Sep) i \u0026#39;$l(Sep) s Sep=\u0026#34;；\u0026#34; k LISTMPStr s ret=\u0026#34;\u0026#34; f p=1:1:$l(Str,Sep) d .s Strp=$p(Str,Sep,p) .i \u0026#39;$l(Strp) q .s LISTMPStr(\u0026#34;Data\u0026#34;,Strp)=\u0026#34;\u0026#34; s GStr=\u0026#34;\u0026#34; f s GStr=$o(LISTMPStr(\u0026#34;Data\u0026#34;,GStr)) q:GStr=\u0026#34;\u0026#34; d .s ret=ret_Sep_GStr s ret=$e(ret,2,*) k LISTMPStr q ret } 私有方法 万泰仪器报警信息和判断阴阳性 报警信息 万泰的报警信息需要将报警信息串从16进制在转换为2进制，随后根据所在位置确定是第几位报警信息\n获取报警信息global 1 2 3 4 5 6 7 8 9 10 11 12 /// w ##class(MI.Special.JudgeResult).GetPolice(\u0026#34;42000100000\u0026#34;) ClassMethod GetPolice(PoliceInfo) { s str=..scaleconversion4(PoliceInfo,\u0026#34;16\u0026#34;,\u0026#34;2\u0026#34;)\t// 进制转换 k ^LISCaris200(\u0026#34;Data\u0026#34;) s strLong=$l(str) f i=1:1:strLong d .s stri=$e(str,i) .i stri=1 d ..s ^LISCaris200(\u0026#34;Data\u0026#34;,strLong+1-i)=1 q \u0026#34;\u0026#34; } 进制转换 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 /// w ##class(YHR.Problem.ScaleConversion).zeroize() /// 补零 ClassMethod zeroize(fnum, long) { s fnumlong=$l(fnum) s fnumlongdiff=long-fnumlong f i=1:1:fnumlongdiff d .s fnum=\u0026#34;0\u0026#34;_fnum q fnum } /// w ##class(YHR.Problem.ScaleConversion).scaleconversion2() /// 其他进制转十进制 ClassMethod Other2Ten(snum, scale) { s snum=$g(snum) s tnum=0 s numlong=$l(snum) f i=1:1:$L(snum) d .s numi=$e(snum,i) .s numi=$$Sixteen(numi) .s tnum=tnum+(numi*(scale**(numlong-i))) q tnum Sixteen(numi) i (numi=\u0026#34;A\u0026#34;)||(numi=\u0026#34;a\u0026#34;) s numi=10 i (numi=\u0026#34;B\u0026#34;)||(numi=\u0026#34;b\u0026#34;) s numi=11 i (numi=\u0026#34;C\u0026#34;)||(numi=\u0026#34;c\u0026#34;) s numi=12 i (numi=\u0026#34;D\u0026#34;)||(numi=\u0026#34;d\u0026#34;) s numi=13 i (numi=\u0026#34;E\u0026#34;)||(numi=\u0026#34;e\u0026#34;) s numi=14 i (numi=\u0026#34;F\u0026#34;)||(numi=\u0026#34;f\u0026#34;) s numi=15 q numi } /// w ##class(YHR.Problem.ScaleConversion).scaleconversion3() /// 十进制转其他进制 ClassMethod Ten2Other(snum, scale) { s snum=$g(snum) s tnum=\u0026#34;\u0026#34; f i=1:1:10 q:(snum=0)||\u0026#39;$l(snum) d .s pnum1=snum .s snum=$p(snum/scale,\u0026#34;.\u0026#34;,1) .s pnum2=pnum1#scale .s pnum2=$$Sixteen(pnum2) .s tnum=pnum2_tnum i scale=2 d .s tnum=..zeroize(tnum,8) q tnum Sixteen(pnum2) i pnum2=10 s pnum2=\u0026#34;A\u0026#34; i pnum2=11 s pnum2=\u0026#34;B\u0026#34; i pnum2=12 s pnum2=\u0026#34;C\u0026#34; i pnum2=13 s pnum2=\u0026#34;D\u0026#34; i pnum2=14 s pnum2=\u0026#34;E\u0026#34; i pnum2=15 s pnum2=\u0026#34;F\u0026#34; q pnum2 } /// w ##class(YHR.Problem.ScaleConversion).scaleconversion4() /// 进制转换 ClassMethod scale(snum, scale1, scale2) { s cnum=..Other2Ten(snum,scale1) s num=..Ten2Other(cnum,scale2) q num } 获取扩展结果阴阳性 调用##Class(LISSP.DHCRPVisitNumberReport).CheckResultAbFlag(ReportDR,TestCodeDR,res)方法获取结果的判断\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 /// w ##class(MI.Special.JudgeResult).IsYang(\u0026#34;29\u0026#34;,\u0026#34;24092500125\u0026#34;,\u0026#34;48\u0026#34;,\u0026#34;2\u0026#34;) ClassMethod IsYang(mi, epis, code, res) { // IndexResultChannel\tMachineParameterDR, ResultChannel\tBTMIMachineTestCode s Nres=\u0026#34;\u0026#34; i \u0026#39;$d(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexResultChannel\u0026#34;,mi,code)) q Nres s MachineTCDR=$o(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexResultChannel\u0026#34;,mi,code,\u0026#34;\u0026#34;)) s TestCodeDR=$lg($g(^dbo.BTMIMachineTestCodeD(MachineTCDR)),3) i \u0026#39;$l(TestCodeDR) q Nres s Units=$lg($g(^dbo.BTTestCodeD(TestCodeDR)),8) i Units\u0026#39;=\u0026#34;COI\u0026#34; q Nres s ReportDR=$p($$GetLabnoByEpis(mi,epis),\u0026#34;^\u0026#34;,1) i \u0026#39;$l(ReportDR) q Nres s Range=##Class(LISSP.DHCRPVisitNumberReport).CheckResultAbFlag(ReportDR,TestCodeDR,res) s AbFlag=$lg(Range,1) i $l(AbFlag) d .s Nres=\u0026#34;阳性\u0026#34; e s Nres=\u0026#34;阴性\u0026#34; q Nres GetLabnoByEpis(mi,Epis) s (ret,ReportDR)=\u0026#34;\u0026#34;,mi=$g(mi) s date=$zd($h,8) i \u0026#39;$l(mi) q Epis s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i \u0026#39;$l(WGMachineID) q Epis i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,date,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis))) { s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,date,WGMachineID,##Class(LIS.Util.Common).IndexData(Epis),\u0026#34;\u0026#34;),-1) S VisitNumberDR=$LG($G(^dbo.RPVisitNumberReportD(ReportDR)),2) s ret=$lg(^dbo.RPVisitNumberD(VisitNumberDR),2)\t} i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis,\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1)) d ..s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1,\u0026#34;\u0026#34;),-1) q ReportDR_\u0026#34;^\u0026#34;_ret } ‍\n","date":"2025-08-29T00:00:00Z","image":"https://work.717170.xyz/p/%E4%BB%AA%E5%99%A8%E5%85%AC%E5%85%B1%E6%96%B9%E6%B3%95-20250829163158/assets/image-20250813195117-i4t8mzw_hu_8e21e2917ada6e38.png","permalink":"https://work.717170.xyz/p/%E4%BB%AA%E5%99%A8%E5%85%AC%E5%85%B1%E6%96%B9%E6%B3%95-20250829163158/","title":"仪器公共方法"}]
[{"content":"罗氏流水线RS600 接口说明 仪器厂商 罗氏流水线RS600\n仪器型号 罗氏流水线RS600\n通讯方式 单向|双向|主动上传☑\n仪器类型 医院名称 程序名称 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：串口|网口|监听文件☑|数据库|其他 连接方式：HL7协议|ASTM协议|监听文件☑|数据库|其他 仪器接口说明 对于数据上传增加业务内容修改，仅作参考 串口盒子配置 波特率： 9600 数据位：8 停止位： 1 校验位： N 仪器图片 仪器配置 数据格式 项目通道号 修改记录 序号 日期 操作人 说明 1 2025-08-29 14:23:27\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;Z:\\\\ResultExport\\\\\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFLICA800\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.csv\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;Z:\\\\Imports\\\\\u0026#34;}] Class MI.MIFRS600 Extends %RegisteredObject { /// D ##class(MI.MIFInfinity).fileMTHD(\u0026#34;7\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#\u0026#34;,\u0026#34;\u0026#34;) /// seen: [VT]#enter#MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR] /// result: [VT]#enter#MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR] /// D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) /// seen: D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;[VT]#enter#MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]\u0026#34;,\u0026#34;\u0026#34;) /// result:D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;[VT]#enter#MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]\u0026#34;,\u0026#34;\u0026#34;) ClassMethod fileMTHD(mi, record, epis, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;0\u0026#34; s HospitalDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),4) i \u0026#39;$l(record) q \u0026#34;0\u0026#34; i \u0026#39;$d(^TMPLIS(\u0026#34;RS600\u0026#34;,mi,\u0026#34;ERR\u0026#34;)) s ^TMPLIS(\u0026#34;RS600\u0026#34;,mi,\u0026#34;ERR\u0026#34;)=\u0026#34;\u0026#34; d Trace^MI.MIF000(mi,record,\u0026#34;H\u0026lt;--M\u0026#34;) s miold=mi s recordbak=record //仪器临时结果映射 s TMPMachResMap=\u0026#34;\u0026#34; //解析多行合并数据 f i=1:1:$l(recordbak,\u0026#34;#enter#\u0026#34;) d .s record=$p(recordbak,\u0026#34;#enter#\u0026#34;,i) .d Trace^MI.MIF000(mi,\u0026#34;解析行数据:\u0026#34;_record,\u0026#34;H\u0026lt;--M\u0026#34;) .i \u0026#39;$l(record) q .s mi=miold .//识别前处理上机信息 .//取出第一位命令类型 .s type=$p(record,\u0026#34;|\u0026#34;,1) .//解析EQU命令 .i type=\u0026#34;EQU\u0026#34; d ..//前处理Seen命令 ..s commandchild=$p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,7) ..d Trace^MI.MIF000(mi,\u0026#34;前处理命令为:\u0026#34;_commandchild,\u0026#34;H\u0026lt;--M\u0026#34;) .//解析SAC命令 .i type=\u0026#34;SAC\u0026#34; d ..//解析上前处理信息 ..//取出流水号 ..s epis=$p(record,\u0026#34;|\u0026#34;,5) ..//取出前处理或仪器信息 ..s machCode=$p(record,\u0026#34;|\u0026#34;,11) ..//取出位置信息 ..s positioninfo=$p(record,\u0026#34;|\u0026#34;,12) ..//-----------------------------------------------------------------------------------------------\u0026gt;根据前处理命令处理 ..i commandchild=\u0026#34;SEEN\u0026#34; d //自动核收 ...//得到当前工作小组 ...s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) ...s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) ...s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) ...//得到仪器工作小组的核收类型 ...s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13) ...//如果是前处理小组，就认为上前处理 ...//************************************************************************************************ ...i AcceptFlag=\u0026#34;1\u0026#34; d ....d Trace^MI.MIF000(mi,\u0026#34;上前处理，鉴定号:\u0026#34;_epis_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ....d Trace^MI.MIF000(mi,\u0026#34;执行核收到前处理\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) ....//此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 ....s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,epis,\u0026#34;\u0026#34;) ....d Trace^MI.MIF000(mi,epis_\u0026#34;核收到前处理返回信息:\u0026#34;_dealret,\u0026#34;H\u0026lt;--M\u0026#34;) ....//记录位置信息到报告位置号 ....d ..SaveRackNo(epis,positioninfo,mi) ....i dealret[\u0026#34;标本已核收\u0026#34; q ....i dealret=\u0026#34;1\u0026#34; d .....//写标本操作日志 .....d ..SaveRecord(epis,machCode,mi,\u0026#34;5\u0026#34;) ....e d .....s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .....s perUser = \u0026#34;WG-\u0026#34;_CurWorkGroupDR .....s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_epis_\u0026#34;前处理核收失败:\u0026#34;_dealret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) .....//写标本操作日志 .....d ..SaveRecord(epis,dealret,mi,\u0026#34;100\u0026#34;) .....//************************************************************************************************ ...e d ....d Trace^MI.MIF000(mi,\u0026#34;上仪器，鉴定号:\u0026#34;_epis_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ....//核收操作，记录位置号5984@1 ....//标本操作，类型：已上机，备注：C8000A 5984@1 ....//上机提示（仪器项目上传日志，增加流水号索引） ....//此处调核收逻辑核收到仪器，标本从前处理小组进入仪器的小组 ....s dealret=##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(mi,epis,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;LSHS\u0026#34;) ....;s RetLL=$$SaveLastMachine^MI.MIF000(mi,epis,\u0026#34;1\u0026#34;) ....;d Trace^MI.MIF000(mi,RetLL,\u0026#34;最后仪器\u0026#34;) ....d Trace^MI.MIF000(mi,epis_\u0026#34;核收到仪器返回:\u0026#34;_dealret,\u0026#34;H\u0026lt;--M\u0026#34;) ....d Trace^MI.MIF000(mi,epis_\u0026#34;执行记录位置号:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ....//不管接收是否成功，记录位置信息到报告位置号 ....d ..SaveRackNo(epis,\u0026#34;已上机:\u0026#34;_positioninfo,mi) ....d Trace^MI.MIF000(mi,epis_\u0026#34;记录位置号完成\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) ....i dealret[\u0026#34;标本已核收\u0026#34; q ....i dealret=\u0026#34;1\u0026#34; d .....//写标本操作日志 .....d ..SaveRecord(epis,\u0026#34;仪器:\u0026#34;_curMachName_\u0026#34;,位置:\u0026#34;_positioninfo_\u0026#34;核收\u0026#34;,mi,\u0026#34;5\u0026#34;) .....d ..SaveRecord(epis,\u0026#34;已上流水线:\u0026#34;_positioninfo,mi,\u0026#34;5\u0026#34;) ....e d .....s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .....s perUser = \u0026#34;WG-\u0026#34;_CurWorkGroupDR .....s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_epis_\u0026#34;前处理核收失败:\u0026#34;_dealret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) .....//写标本操作日志 .....d ..SaveRecord(epis,dealret,mi,\u0026#34;100\u0026#34;) ..//-----------------------------------------------------------------------------------------------\u0026gt;根据前处理命令处理 ..i commandchild=\u0026#34;RESULT\u0026#34; d //处理分类信息 ...//通过仪器对照码取仪器 ...s curMachName=machCode ...//此处存标本全部审核报告的位置号 ...d Trace^MI.MIF000(mi,\u0026#34;分类信息，标本号:\u0026#34;_epis_\u0026#34;的样本所在仪器:\u0026#34;_curMachName_\u0026#34; \u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ...d Trace^MI.MIF000(mi,epis_\u0026#34;执行记录分类信息:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ...//保存分类信息到架子号 ...d ..SaveCARCH(epis,curMachName_\u0026#34;: \u0026#34;_positioninfo,mi,curMachName) ...d Trace^MI.MIF000(mi,epis_\u0026#34;记录分类信息完成\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) ...//写标本操作日志 ...d ..SaveRecord(epis,\u0026#34;上机位置:\u0026#34;_positioninfo,mi,\u0026#34;6\u0026#34;) ..//-----------------------------------------------------------------------------------------------\u0026gt;根据前处理命令处理 ..i commandchild=\u0026#34;ARCHIVE\u0026#34; d //处理归档信息 ...//通过仪器对照码取仪器 ...s curMachName=machCode ...//此处存标本全部审核报告的位置号 ...d Trace^MI.MIF000(mi,\u0026#34;归档信息，标本号:\u0026#34;_epis_\u0026#34;的样本所在仪器:\u0026#34;_curMachName_\u0026#34; \u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ...d Trace^MI.MIF000(mi,epis_\u0026#34;执行记录分类信息:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ...//保存归档信息到架子号 ...d ..SaveCARCH(epis,\u0026#34;归档:\u0026#34;_positioninfo,mi,\u0026#34;归档\u0026#34;) ...d Trace^MI.MIF000(mi,epis_\u0026#34;记录归档信息完成\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) ...//写标本操作日志 ...d ..SaveRecord(epis,\u0026#34;归档位置:\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;) .//-----------------------------------------------------------------------------------------------\u0026gt;处理结果数据 .//解析质控数据,P业务数据，Q质控数据 .i (type[\u0026#34;MSH\u0026#34;) d ..s ^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;MSH\u0026#34;)=$p(record,\u0026#34;|\u0026#34;,10) ..//取日期串 ..s DateStr=$p(record,\u0026#34;|\u0026#34;,7) ..//解析保存日期串 ..i $l(DateStr)=14 s ^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;DATE\u0026#34;)=$e(DateStr,1,8)_\u0026#34;,\u0026#34;_(($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60)) .i type=\u0026#34;OBR\u0026#34; s ^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;OBR\u0026#34;)=$p(record,\u0026#34;|\u0026#34;,3) .i type=\u0026#34;ORC\u0026#34; s ^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;ORC\u0026#34;)=$p(record,\u0026#34;|\u0026#34;,3) .//仪器警告 .i type=\u0026#34;NTE\u0026#34; d\t..s WaringStr=$p(record,\u0026#34;|\u0026#34;,4) ..d Trace^MI.MIF000(mi,\u0026#34;仪器报警信息:\u0026#34;_WaringStr,\u0026#34;H\u0026lt;--M\u0026#34;) ..s WaringCode=$p(WaringStr,\u0026#34; \u0026#34;,2) ..i $l(WaringCode) d ...i WaringCode=\u0026#34;5\u0026#34; s WaringStr=\u0026#34;\u0026gt;ABS(超出ABS)\u0026#34; ...e i WaringCode=\u0026#34;43\u0026#34; s WaringStr=\u0026#34;Cal.E(校准结果异常)\u0026#34; ...e i WaringCode=\u0026#34;2\u0026#34; s WaringStr=\u0026#34;\u0026gt;Cuvet(反应杯空白异常)\u0026#34; ...e i WaringCode=\u0026#34;42\u0026#34; s WaringStr=\u0026#34;Edit(实验结果已被编辑)\u0026#34; ...e i WaringCode=\u0026#34;23\u0026#34; s WaringStr=\u0026#34;\u0026gt;ISE(超出ISE范围)\u0026#34; ...e i WaringCode=\u0026#34;19\u0026#34; s WaringStr=\u0026#34;ISE.E(ISE电压级错误)\u0026#34; ...e i WaringCode=\u0026#34;56\u0026#34; s WaringStr=\u0026#34;\u0026gt;Kin(Prozone错误2/运动不稳)\u0026#34; ...e i WaringCode=\u0026#34;10\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; ...e i WaringCode=\u0026#34;11\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; ...e i WaringCode=\u0026#34;6\u0026#34; s WaringStr=\u0026#34;\u0026gt;Prozone(Prozone错误1)\u0026#34; ...e i WaringCode=\u0026#34;4\u0026#34; s WaringStr=\u0026#34;Reag.S(试剂不足)\u0026#34; ...e i WaringCode=\u0026#34;44\u0026#34; s WaringStr=\u0026#34;\u0026gt;Rept(高出原倍复查范围)\u0026#34; ...e i WaringCode=\u0026#34;45\u0026#34; s WaringStr=\u0026#34;\u0026lt;Rept(低于原倍复查范围)\u0026#34; ...e i WaringCode=\u0026#34;46\u0026#34; s WaringStr=\u0026#34;Samp.？(高出ABS最大值)\u0026#34; ...e i WaringCode=\u0026#34;68\u0026#34; s WaringStr=\u0026#34;Samp.B(样本中有气泡)\u0026#34; ...e i WaringCode=\u0026#34;72\u0026#34; s WaringStr=\u0026#34;Samp.C(样本中有凝块)\u0026#34; ...e i WaringCode=\u0026#34;26\u0026#34; s WaringStr=\u0026#34;\u0026gt;Test(高出线性范围)\u0026#34; ...e i WaringCode=\u0026#34;27\u0026#34; s WaringStr=\u0026#34;\u0026lt;Test(低于线性范围)\u0026#34; ..//保存仪器报警信息到组内报告评价 ..d ..SaveResultWarned(epis,WaringStr,mi) .d ##class(MI.Special.RecordGlobal).RecordData(epis,recordbak,\u0026#34;MI.MIFRS600\u0026#34;,1,10)\t//YHR 20230828 记录十天的数据 .i type=\u0026#34;OBX\u0026#34; d ..s (sample,result,date,time,QC)=\u0026#34;\u0026#34; ..s epis=^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;OBR\u0026#34;) ..s machCode=$p($p($p($p(record,\u0026#34;|\u0026#34;,16),\u0026#34;^\u0026#34;,1),\u0026#34;:\u0026#34;,1),\u0026#34;^\u0026#34;,1) ..d Trace^MI.MIF000(mi,\u0026#34;解析仪器对照码:\u0026#34;_machCode,\u0026#34;H\u0026lt;--M\u0026#34;) ..//通过仪器对照码取仪器 ..s code=$p($p(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1) ;AHBS^6012 ..s reswaring=$p($p(record,\u0026#34;|\u0026#34;,6),\u0026#34;^\u0026#34;,2) ..s res=$p($p(record,\u0026#34;|\u0026#34;,6),\u0026#34;^\u0026#34;,1) ;[\u0026#34;\u0026#34;一般|-1阴性+定量|1阳性+定量|0临界值] ..s CallThePolice=$p($p(record,\u0026#34;|\u0026#34;,9),\u0026#34;^\u0026#34;,2) ..i $l(CallThePolice) d ...try{d ..SaveAlarmInformation(mi,epis,CallThePolice)}catch {} //YHR 20230828 保存报警信息 ..//i res=-1 s res=\u0026#34;阴性\u0026#34;_$c(92)_$p($p(record,\u0026#34;|\u0026#34;,6),\u0026#34;^\u0026#34;,2)_$c(92)_$c(92)_reswaring ..//e i res=1 s res=\u0026#34;阳性\u0026#34;_$c(92)_$p($p(record,\u0026#34;|\u0026#34;,6),\u0026#34;^\u0026#34;,2)_$c(92)_$c(92)_reswaring ..//e i res=0 s res=\u0026#34;临界值\u0026#34;_$c(92)_$p($p(record,\u0026#34;|\u0026#34;,6),\u0026#34;^\u0026#34;,2)_$c(92)_$c(92)_reswaring ..//e s res=\u0026#34;临界值\u0026#34;_$c(92)_$c(92)_$c(92)_reswaring ..i res=\u0026#34;SORTED\u0026#34; q ..i res=\u0026#34;N/I\u0026#34; q ..//标本质量数据当做仪器报警，不让自动审核 ..i code=\u0026#34;SQ-D\u0026#34; d ...//保存仪器报警信息到报告评价 ...//d ..SaveResultWarned(epis,res,mi) ...d ..SaveQuality(epis,res,mi) ..//计算肾小球滤过率 ..i code=\u0026#34;8690\u0026#34; d ...s x1=\u0026#34;Cur\u0026#34; ...s x2=##class(MI.Special.GetSxqlgl).GeteGFRResultLast(mi,epis,res) ...i $l(x2) s result=result_x1_$c(92)_x2_$c(44) ..s result=result_code_$c(92)_res_$c(44) ..d Trace^MI.MIF000(mi,epis_\u0026#34;:\u0026#34;_result,\u0026#34;H\u0026lt;--M\u0026#34;) ..d Trace^MI.MIF000(mi,\u0026#34;按对照仪器保存数据:\u0026#34;_machCode,\u0026#34;H\u0026lt;--M\u0026#34;) ..//统一保存结果 ..i $l(epis),$l(result) d ...d Trace^MI.MIF000(mi,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;H\u0026lt;--M\u0026#34;) ...s DateStr=\u0026#34;\u0026#34; ...i $d(^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;DATE\u0026#34;)) s DateStr=^TMP(\u0026#34;RS600\u0026#34;,mi,\u0026#34;DATE\u0026#34;) ...i $l(DateStr) d ....s date=$p(DateStr,\u0026#34;,\u0026#34;,1) ....s time=$p(DateStr,\u0026#34;,\u0026#34;,2) ...d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) q \u0026#34;1\u0026#34; } // 记录标本日志 // D ##class(MI.MIFRS600).SaveRecord(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi) s OperateTypeCode=$g(OperateTypeCode) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,\u0026#34;,\u0026#34;,2),\u0026#34;\u0026#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,\u0026#34;\u0026#34;) } // 保存仪器报警信息 // D ##class(MI.MIFRS600).SaveResultWarned(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.ResultWarned) s objrep.ResultWarned=objrep.ResultWarned_\u0026#34;,\u0026#34;_conclusion .....e s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存仪器报警信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } // 保存仪器报警信息(标本质量) // D ##class(MI.MIFRS600).SaveQuality(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveQuality(labno, conclusion, predealMI) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_\u0026#34;,\u0026#34;_conclusion .....e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } // 保存架子号 // D ##class(MI.MIFRS600).SaveRackNo(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveRackNo(labno, positioninfo, mi) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s CanDoTS=0 .....i $d(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,ReportDR)) d ......s TestSetDR=\u0026#34;\u0026#34; f s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,ReportDR,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; d .......i $d(^dbo.BTTestSetWorkGroupMachineI(\u0026#34;IndexWorkGroupMachine\u0026#34;,curWorkGroupMachineDR,TestSetDR)) d ........s CanDoTS=1 .....i CanDoTS=0 q .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,\u0026#34;-1^存位置信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } // 保存归档和分类信息 // D ##class(MI.MIFRS600).SaveCARCH(\u0026#34;1000100990\u0026#34;,\u0026#34;2@2\u0026#34;,57,\u0026#34;归档\u0026#34;) ClassMethod SaveCARCH(labno, positioninfo, mi, typename) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo) d ......i $p(objrep.RackNo,\u0026#34;-\u0026gt;\u0026#34;,*)[typename d .......s positioninfo=$p(objrep.RackNo,typename,1)_positioninfo ......e d .......s positioninfo=objrep.RackNo_\u0026#34;-\u0026gt;\u0026#34;_positioninfo .....s objrep.RackNo=positioninfo .....s objrep.LastMachineLName=\u0026#34;\u0026#34; .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,\u0026#34;-1^存\u0026#34;_typename_\u0026#34;信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0 d Trace^MI.MIF000(mi,labno_\u0026#34;:没有找到\u0026#34;_typename_\u0026#34;的报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } // D ##class(MI.MIFRS600).SaveImageMTHD(\u0026#34;8\u0026#34;,\u0026#34;1000001727\u0026#34;,\u0026#34;07\u0026#34;,\u0026#34;/LIS/IT3000/20180823/SerumQ0001_orig_64_1000001727_8170_4_0__04.jpg\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) // 保存标本图片 // D ##class(MI.MIFRS600).SaveImageMTHD(\u0026#34;57\u0026#34;,\u0026#34;1000100990\u0026#34;,\u0026#34;P\u0026#34;,\u0026#34;/iLISLIS080/demo.png\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //s ^TMP(\u0026#34;zlzi\u0026#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=\u0026#34;1\u0026#34; i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=\u0026#34;\u0026#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=\u0026#34;\u0026#34; f s RowID=$o(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=\u0026#34;\u0026#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i \u0026#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=\u0026#34;SerumQ\u0026#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= \u0026#34;-1^保存报告图片失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_\u0026#34;:\u0026#34;_ImageClass_\u0026#34;:\u0026#34;_FileName,\u0026#34;H\u0026lt;--M\u0026#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=\u0026#34;\u0026#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // w ##class(MI.MIFRS600).GetFtpMTHD(\u0026#34;24\u0026#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = \u0026#34;labno,labnoInfo,patInfo\u0026#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(\u0026#34;MI.MIFRS600\u0026#34;,\u0026#34;QryLabInfo\u0026#34;,\u0026#34;57\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; s LabnoList=\u0026#34;\u0026#34; s VisitNumberDR=\u0026#34;\u0026#34; //*--------------------------------\u0026gt;*申请项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i \u0026#39;$l(EpisNo) q ..i \u0026#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..b ;VisitNumberDR ..i \u0026#39;$l(VisitNumberDR) q ..;i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=\u0026#34;0\u0026#34; ..i TestType=\u0026#34;0\u0026#34; d ...b ;1 ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@C\u0026#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ...s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ...d Trace^MI.MIF000(mi,txtInfo,\u0026#34;上传信息\u0026#34;) ...d OutputRow ...//文本双向上传结束****************************************************** ////*--------------------------------\u0026gt;*复查结果上传 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..b ;F101 ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i \u0026#39;$l(EpisNo) q ..i \u0026#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..b ;VisitNumberDR ..i \u0026#39;$l(VisitNumberDR) q ..i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=\u0026#34;0\u0026#34; ..i TestType=\u0026#34;0\u0026#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ...s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;|@U\u0026#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ...s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ...d Trace^MI.MIF000(mi,txtInfo,\u0026#34;上传信息\u0026#34;) ...d OutputRow ...//文本双向上传结束****************************************************** //*--------------------------------\u0026gt;*取消项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..b ;101 ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i \u0026#39;$l(EpisNo) q ..i \u0026#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..b ;VisitNumberDR ..i \u0026#39;$l(VisitNumberDR) q ..;i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=\u0026#34;0\u0026#34; ..i TestType=\u0026#34;0\u0026#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@R\u0026#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ...s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ...d Trace^MI.MIF000(mi,txtInfo,\u0026#34;上传信息\u0026#34;) ...d OutputRow ...//文本双向上传结束****************************************************** Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=\u0026#34;labno,labnoInfo,patInfo\u0026#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=\u0026#34;\u0026#34; { Set AtEnd=1 Set Row=\u0026#34;\u0026#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 获取申请名称和内容 /// 申请名称： /// 发送申请：order_2012051718302501_9999999901NW.HL7 /// 取消申请：order_2012051718302501_9999999901CA.HL7 /// 项目复查：order_2012051718302501_9999999901XO.HL7 /// w ##class(MI.MIFRS600).GetLisOrderMTHD(\u0026#34;8\u0026#34;,\u0026#34;POS@C@1\u0026#34;,\u0026#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08 -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34; ,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod GetLabnoInfoN(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s VT=\u0026#34;[11]\u0026#34;,FS=\u0026#34;[28]\u0026#34;,CR=\u0026#34;[13]\u0026#34; s labNo=$p(patInfo,\u0026#34;,\u0026#34;,16) s Sampleno=$p(patInfo,\u0026#34;,\u0026#34;,3) //i labNo=\u0026#34;74623177\u0026#34; s ^TMP(\u0026#34;zlzit3000d\u0026#34;)=$lb(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s location=$p(patInfo,\u0026#34;,\u0026#34;,6) s docName=$p(patInfo,\u0026#34;,\u0026#34;,7) s regNo=$p(patInfo,\u0026#34;,\u0026#34;,9) s patName=$p(patInfo,\u0026#34;,\u0026#34;,10) s sex=$p(patInfo,\u0026#34;,\u0026#34;,11) i sex=\u0026#34;1\u0026#34; s sex=\u0026#34;M\u0026#34; i sex=\u0026#34;2\u0026#34; s sex=\u0026#34;F\u0026#34; i (sex\u0026#39;=\u0026#34;M\u0026#34;)\u0026amp;\u0026amp;(sex\u0026#39;=\u0026#34;F\u0026#34;) s sex=\u0026#34;U\u0026#34; s birthDate=$p(patInfo,\u0026#34;,\u0026#34;,29) s collectTime=$p(patInfo,\u0026#34;,\u0026#34;,17) ;2017-08-14 11:57 s collectTime=$tr(collectTime,\u0026#34;- :\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;00\u0026#34; s status=$p(labnoInfo,\u0026#34;@\u0026#34;,2) s labnoInfo=$p(labnoInfo,\u0026#34;@\u0026#34;,1) s curTime=$zd($h,8)_$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;,\u0026#34;\u0026#34;) s PatType=$p(patInfo,\u0026#34;,\u0026#34;,12) s Wardno=$p(patInfo,\u0026#34;,\u0026#34;,27) s Diagnose=$p(patInfo,\u0026#34;,\u0026#34;,22) S patTypeFlag=\u0026#34;RO\u0026#34; //门诊=RO,住院=RI,体检=RC,急诊=RS I PatType=\u0026#34;住院\u0026#34; { S patTypeFlag=\u0026#34;RI\u0026#34; } I PatType=\u0026#34;门诊\u0026#34; { S patTypeFlag=\u0026#34;RO\u0026#34; } I PatType=\u0026#34;急诊\u0026#34; { S patTypeFlag=\u0026#34;RS\u0026#34; } I PatType=\u0026#34;体检\u0026#34; { S patTypeFlag=\u0026#34;RC\u0026#34; } I PatType=\u0026#34;干诊\u0026#34; { S patTypeFlag=\u0026#34;RC\u0026#34; } s MSN=\u0026#34;MSH|^\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|\u0026#34;_curTime_\u0026#34;||OML^O21|\u0026#34;_curTime_\u0026#34;_\u0026#34;_labNo_\u0026#34;|P|2.3|||ER|ER||8859/1\u0026#34; i status=\u0026#34;S\u0026#34; s MSN=\u0026#34;MSH|^\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|\u0026#34;_curTime_\u0026#34;||RESULTS|\u0026#34;_curTime_\u0026#34;_\u0026#34;_labNo_\u0026#34;|P|2.3|||ER|ER||8859/1\u0026#34; s PID=\u0026#34;PID|1||\u0026#34;_Sampleno_\u0026#34;||\u0026#34;_\u0026#34;^\u0026#34;_patName_\u0026#34;||\u0026#34;_birthDate_\u0026#34;|\u0026#34;_sex s PV1=\u0026#34;PV1|||\u0026#34;_Wardno_\u0026#34;||||||||||||||||^^^^^^^^\u0026#34;_location_\u0026#34;|\u0026#34; s DG1=\u0026#34;DG1|||\u0026#34;_Diagnose s orcF1=\u0026#34;NW\u0026#34;,orcF2=\u0026#34;\u0026#34; i status=\u0026#34;R\u0026#34; s orcF1=\u0026#34;CA\u0026#34; //i status=\u0026#34;U\u0026#34; s orcF1=\u0026#34;XO\u0026#34; s orcF2=\u0026#34;SC\u0026#34; i status=\u0026#34;U\u0026#34; s orcF1=\u0026#34;XO\u0026#34; s orcF2=\u0026#34;RP\u0026#34; s ORC=\u0026#34;ORC|\u0026#34;_orcF1_\u0026#34;|\u0026#34;_labNo_\u0026#34;|||||\u0026#34;_patTypeFlag_\u0026#34;||\u0026#34;_curTime_\u0026#34;||\u0026#34;_docName_\u0026#34;|\u0026#34;_Wardno_\u0026#34;|||||||\u0026#34; s obrF1=\u0026#34;A\u0026#34; i status=\u0026#34;U\u0026#34; s obrF1=\u0026#34;G\u0026#34; s OBR=\u0026#34;OBR||\u0026#34;_labNo_\u0026#34;||AA|||\u0026#34;_collectTime_\u0026#34;||||\u0026#34;_obrF1\ts OBRs=\u0026#34;\u0026#34; i $p(labnoInfo,\u0026#34;@\u0026#34;,1)=\u0026#34;POS\u0026#34; d .s OBRs=\u0026#34;OBR||\u0026#34;_labNo_\u0026#34;||POS|||\u0026#34;_collectTime_\u0026#34;||||\u0026#34;_obrF1 e d .d GetOBRs\t//s orderTxt=VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS s orderTxt=VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS q orderTxt GetOBRs s items=$tr($p(labnoInfo,\u0026#34;,\u0026#34;,2),\u0026#34;|\u0026#34;,\u0026#34;\u0026#34;) f i=1:1:$l(items,\u0026#34;+\u0026#34;) d .s item=$p(items,\u0026#34;+\u0026#34;,i) .s splitStr=$p(OBR,\u0026#34;|\u0026#34;,5) .s curOBR=$p(OBR,splitStr,1)_item_$p(OBR,splitStr,2) .s OBRs=OBRs_curOBR_CR q } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=\u0026#34;\u0026#34; s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) q:chl=\u0026#34;\u0026#34; d .s tcx=tcx_chl_\u0026#34;+\u0026#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno) i $l(tcx) s tcx=labno_\u0026#34;,\u0026#34;_tcx_\u0026#34;|\u0026#34; d Trace^MI.MIF000(mi,tcx,\u0026#34;H--\u0026gt;M\u0026#34;) d Trace^MI.MIF000(56,\u0026#34;共\u0026#34;_$l(tcx,\u0026#34;+\u0026#34;)_\u0026#34;个项目。\u0026#34;_tcx,\u0026#34;H--\u0026gt;M\u0026#34;) //YHR 20230816 将上传信息存入罗氏infinity仪器 q tcx } /// w ##Class(MI.MIFRS600).GetPatInfo(57,9000001912) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName\ts SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) i $l(Instrument) s Instrument=$tr(Instrument,\u0026#34;,\u0026#34;,\u0026#34;^\u0026#34;) s Sampleno=$lg(RPVisitNumberData,6) //病案号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; s WardnoDR=$lg(RPVisitNumberData,26) ;病区 i $l(WardnoDR) s Wardno=$lg($g(^dbo.BTWardD(WardnoDR)),3) s RetString=\u0026#34;\u0026#34; s RetString=$tr(Sampleda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Instrument,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sampleno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sampletype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Feetype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Srcdepno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Srcdocno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Userno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Patno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Patna,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sex,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Pattype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Bedno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Patage,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Ageunit,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reqno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reqda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Reportda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Printflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Resultflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Errflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Diagnose,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Description,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reserve,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Patnamn,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Getda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Wardno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(BarCode,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(BirthDate,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;) q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,\u0026#34;S\u0026#34;,filename) q } /// 流水号特殊处理 /// w ##class(MI.MIFRS600).GetEpis() ClassMethod GetEpis() { s sign=1 while sign=1 { s maxEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByRowIDMTHD(\u0026#34;5\u0026#34;) //YHR 20230810 罗氏流水线规则 s ret=$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,67,maxEpis)) i ret\u0026#39;=0 s sign=1 e d s sign=0 } q maxEpis } /// 保存报警提示信息 /// YHR 20230828 /// w ##Class(MI.MIFRS600).SaveAlarmInformation(57,9000001960,\u0026#34;CSCSCS\u0026#34;) ClassMethod SaveAlarmInformation(mi, epis, expertRules) { s mi=$g(mi) s epis=$g(epis) s expertRules=$g(expertRules) s ReportDR=$$GetReportID(mi,epis) s obj=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) s obj.MinorConclusion=expertRules s ret=obj.%Save() q ret GetReportID(mi,epis) i $l(epis)\u0026lt;10 d .s AssayNo=epis e d .s AssayNo=$$GetEpisByLabno(mi,epis) s WGMachineID=$lg(^dbo.BTMIMachineParameterD(mi),6) s WGMachineID1=$lg(^dbo.BTMIMachineParameterD(mi),6) s ReportID=\u0026#34;\u0026#34; i $D(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,AssayNo)) d .s TransmitDate=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,AssayNo,\u0026#34;\u0026#34;)) .s ReportID=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WGMachineID,AssayNo,TransmitDate,\u0026#34;\u0026#34;)) q ReportID GetEpisByLabno(mi,Epis) ;Index IndexVisitNumber On VisitNumber [ SqlName = Index_VisitNumber, Type = index, Unique ]; ;Index IndexReportID On (VisitNumberDR, WorkGroupMachineDR, OrderNo) [ SqlName = Index_ReportID, Type = index, Unique ]; s ret=\u0026#34;\u0026#34;,mi=$g(mi),Epis=$g(Epis) i \u0026#39;$l(mi) q Epis s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,Epis,\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1)) d ..s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitnumberDR,WGMachineID,1,\u0026#34;\u0026#34;)) ..s ret=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),8) q ret } } 附录 仪器文档提取数据格式 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 第十章LIS 10.1Order格式 [VT] MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||OML^O21|20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR] PID|1||00943729|9009|^Test||19811002|F[CR] PV1|||041||||||||||||||||^^^^^^^^产六科|[CR] DG1|||宫内孕37+5天[CR] ORC|NW|121092103669|||||RI||20210922075000|医保|10001|041|||||||[CR] OBR||121092103669||YLCSC|||||||A[CR] OBR||121092103669||ATPO|||||||A[CR] OBR||121092103669||FT4|||||||A[CR] OBR||121092103669||TSH|||||||A[CR] [FS] [CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 OML^O21：message type Order的消息类型，Order发送必须用OML^O21 20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复） 00943729：病人的门诊或住院号 9009：样本号 ^Test：病人姓名 19811002：出生年月日 F：性别（F = Female；M = Male；U = Unknown） 宫内孕37+5天：临床诊断(如果有代码就用临床诊断得代码，没有就用文字描述) NW：Action code (NW:新建；XO：修改；CA：删除) 121092103669：条码号 RI：病人类别（门诊；住院；急诊；体检……） 20180201101033：时间戳(精确到秒无需毫秒) 医保：病人收费类别 10001：申请医生代码 041：申请科室代码 121092103669：条码号 YLCSC：测试项目代号 10.2Result格式 [VT] MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||RESULTS |20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR] PID|1||00943729|9009|^Test||19811002|F[CR] PV1|||041||||||||||||||||^^^^^^^^产六科|[CR] DG1|||宫内孕37+5天[CR] ORC|NW|121092103669|9009||||RI||20210922075000|医保|10001|041|||||||[CR] OBR||121092103669||YLCSC|||||||A[CR] OBX|1|NM|YLCSC||1.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||ATPO|||||||A[CR] OBX|1|NM|ATPO||2.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||FT4|||||||A[CR] OBX|1|NM|FT4||3.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||TSH|||||||A[CR] OBX|1|NM|TSH||6.1||||||F|||20210922101033|c6000^E11[CR] [FS] [CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 RESULTS：message type Order的消息类型，结果回传必须用RESULTS 20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复） 00943729：病人的门诊或住院号 9009：样本号 ^Test：病人姓名 19811002：出生年月日 F：性别（F = Female；M = Male；U = Unknown） NW：Action code (NW:新建；XO：修改；CA：删除) 121092103669：条码号 RI：病人类别（门诊；住院；急诊；体检……） 20210922075000：时间戳(精确到秒无需毫秒) 医保：病人收费类别 10001：申请医生代码 041：申请科室代码 121092103669：条码号 NM：Value Type (NM = Numeric；ST = String data) YLCSC：测试项目代号 1.1：项目测试结果 c6000^E11：分析仪名称和模块名称 10.3Seen格式 01前处理条码扫描消息格式 [VT] MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR] SAC|||0800150242|0800150242||20220908183340|01||P|MILESTON1|0@0[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^SEEN：消息类型 0800150242：条码号 MILESTON1：前处理名称 0@0：架子号和位置号 20220908183340：消息产生的时间 02前处理分类Distribution消息格式 [VT] MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^RESULT|20220908183340|SORTED[CR] SAC|||0800150242|0800150242||20220908183340|01||R|c6000|0@0[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^RESULT：消息类型 0800150242：条码号 MILESTON1：前处理名称 c6000：分析仪名称 0@0：架子号和位置号 20220908183340：消息产生的时间 03前处理归档消息格式 [VT] MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^ARCHIVE|20220908183340|SORTED[CR] SAC|||0800150242|0800150242||20220908183340|01||R|MILESTON1|23@1[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^ARCHIVE：消息类型 0800150242：条码号 MILESTON1：前处理名称 23@1：架子号和位置号 20220908183340：消息产生的时间 特殊处理 标本拒收更改标本上传状态为R\nLISSP.DHCRPVisitNumber——RejectVisitNumber\n1 2 3 4 5 s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexVisitNumber\u0026#34;,fLabno,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .S RowID=$O(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,fLabno,\u0026#34;\u0026#34;)) //q .S obj=##class(dbo.RPMachineUpload).%OpenId(RowID) .s obj.SendStatus=\u0026#34;R\u0026#34; .s ret=obj.%Save() 更新拒收状态后回传文件之后删除该条上传信息，避免签收会无法签收\nMI.MachineUpload——SetSendFlag\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 /// Description:： 记录上传标志 /// Table： /// Input： 仪器DR,检验号,标记(C:创建 S:发送 F:失败),Comments:备注信息 /// Output： 无 /// Return： 1:成功 其他:失败 /// w ##Class(MI.MachineUpload).SetSendFlag(6,1001367,\u0026#34;S\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SetSendFlag(MachineDR, Labno, SendStatus, Comments) As %String { s MachineDR=$g(MachineDR),Labno=$g(Labno),SendStatus=$g(SendStatus) s Labno=$p(Labno,\u0026#34;^\u0026#34;,1) s RowID=$o(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(SendStatus) s SendStatus=\u0026#34;C\u0026#34; i \u0026#39;$l(RowID) q 100 s TCList=$lg($g(^dbo.RPMachineUploadD(RowID)),7) s oldSendStatus=$lg($g(^dbo.RPMachineUploadD(RowID)),4) i oldSendStatus=\u0026#34;R\u0026#34; k ^dbo.RPMachineUploadD(RowID) s obj=##class(dbo.RPMachineUpload).%OpenId(RowID) s obj.SendStatus=SendStatus s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) s ret=obj.%Save() q ret } 签收标本特殊处理，避免造成同一医嘱在不同主动上传仪器生成上传标本\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 /// Description:： 上传标本记录 /// Table： /// Input： 标本号,检验套DR,工作小组 /// Output： 无 /// Return： 1:成功 其他:失败 /// w ##Class(MI.MachineUpload).Upload(\u0026#34;1000100990\u0026#34;,39,57) ClassMethod Upload(Labno, TestSetDR, WorkGroupMachineDR) As %String { s Labno=$g(Labno),TestSetDR=$g(TestSetDR),WorkGroupMachineDR=$g(WorkGroupMachineDR) i \u0026#39;$l(Labno) q 100 i \u0026#39;$l(TestSetDR),\u0026#39;$l(WorkGroupMachineDR) q 100 //接收或核收操作标识 s RecFlag=\u0026#34;C\u0026#34; i $l(WorkGroupMachineDR) s RecFlag=\u0026#34;H\u0026#34; //无工作小组认为是核收操作，不增加入参 s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) I $L(WorkGroupMachineDR) d .D UploadTC E D //不传工作小组时遍历关联的所有主动上传仪器 .S LinkWGMDR=\u0026#34;\u0026#34; F S LinkWGMDR=$O(^dbo.BTTestSetWorkGroupMachineI(\u0026#34;IndexMaster\u0026#34;,TestSetDR,LinkWGMDR)) Q:LinkWGMDR=\u0026#34;\u0026#34; D ..S WorkGroupMachineDR=LinkWGMDR ..//标本接收医院 ..s VisHosDR=$LG($G(^dbo.RPVisitNumberD(VisitNumberDR)),78) ..//工作小组所在医院 ..s CKWGDR=$LG($G(^dbo.BTWorkGroupMachineD(LinkWGMDR)),4) ..s CkDepartDR=$LG($G(^dbo.BTWorkGroupD(CKWGDR)),4) ..S CkHosDR=$LG($G(^dbo.BTDepartmentD(CkDepartDR)),4) ..I CkHosDR\u0026#39;=VisHosDR Q //非本医院标本不生成工单 ..D UploadTCN q 1 UploadTC s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///临时处理老年医院流水线标本上传 //i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; s ^DHCUploadAll(Labno)=WorkGroupMachineDR i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; q 100 //装载列表接收不生成工单 i CommDirection=\u0026#34;LS\u0026#34;,RecFlag=\u0026#34;C\u0026#34; q 100 s ret=100 s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.BTMIMachineParameterI(\u0026#34;IndexWorkGroupMachine\u0026#34;,WorkGroupMachineDR,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .s miCommDirection=$lg(^dbo.BTMIMachineParameterD(MachineDR),11) .i miCommDirection\u0026#39;=\u0026#34;UP\u0026#34;,miCommDirection\u0026#39;=\u0026#34;LS\u0026#34; q .d ScanOne^MI.MIF000(MachineDR,Labno) .s TCList=\u0026#34;\u0026#34; .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachineDR,Labno,chl)) q:chl=\u0026#34;\u0026#34; d ..s TCList=TCList_chl_\u0026#34;\\\u0026#34; .s TCList=$e(TCList,1,$l(TCList)-1) .i \u0026#39;$l(TCList) s ret=Labno_\u0026#34;没有上传项目\u0026#34; q .s RowID=\u0026#34;\u0026#34; .i $d(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno))) S RowID=$O(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) //q .I $L(RowID) S obj=##class(dbo.RPMachineUpload).%OpenId(RowID) .e s obj=##class(dbo.RPMachineUpload).%New() .i $L(obj.SendStatus),obj.SendStatus\u0026#39;=\u0026#34;C\u0026#34; Q //已读取标本不再上传 .s obj.MachineParameterDR=MachineDR .s obj.VisitNumber=Labno .s obj.SendStatus=\u0026#34;C\u0026#34; .s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) .s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) .s obj.TCList=TCList .s ret=obj.%Save() q UploadTCN s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///临时处理老年医院流水线标本上传 //i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; s ^DHCUploadAll(Labno)=WorkGroupMachineDR i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; q 100 //装载列表接收不生成工单 i CommDirection=\u0026#34;LS\u0026#34;,RecFlag=\u0026#34;C\u0026#34; q 100 s ret=100 s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.BTMIMachineParameterI(\u0026#34;IndexWorkGroupMachine\u0026#34;,WorkGroupMachineDR,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .i MachineDR\u0026#39;=57 q //上传标本信息接收标本特殊处理 .s miCommDirection=$lg(^dbo.BTMIMachineParameterD(MachineDR),11) .i miCommDirection\u0026#39;=\u0026#34;UP\u0026#34;,miCommDirection\u0026#39;=\u0026#34;LS\u0026#34; q .d ScanOne^MI.MIF000(MachineDR,Labno) .s TCList=\u0026#34;\u0026#34; .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachineDR,Labno,chl)) q:chl=\u0026#34;\u0026#34; d ..s TCList=TCList_chl_\u0026#34;\\\u0026#34; .s TCList=$e(TCList,1,$l(TCList)-1) .i \u0026#39;$l(TCList) s ret=Labno_\u0026#34;没有上传项目\u0026#34; q .s RowID=\u0026#34;\u0026#34; .i $d(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno))) S RowID=$O(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) //q .I $L(RowID) S obj=##class(dbo.RPMachineUpload).%OpenId(RowID) .i $L(obj.SendStatus),obj.SendStatus\u0026#39;=\u0026#34;C\u0026#34; d ..s obj.SendStatus=\u0026#34;C\u0026#34; ..s ret=obj.%Save() //签收强制重新上传 .e d ..s obj=##class(dbo.RPMachineUpload).%New() ..s obj.MachineParameterDR=MachineDR ..s obj.VisitNumber=Labno ..s obj.SendStatus=\u0026#34;C\u0026#34; ..s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) ..s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) ..s obj.TCList=TCList ..s ret=obj.%Save() q } 通过规则设置流水号\n1 2 3 4 5 6 7 8 9 i \u0026#39;$l(RuleCode) { s RuleCode=$lg($g(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR)),2) } // 罗氏流水线流水号通过规则生成流水号 i RuleCode=\u0026#34;LSHS\u0026#34; d .s maxEpis=##class(MI.MIFRS600).GetEpis() //YHR 20230810 罗氏流水线规则 e d .s maxEpis=##Class(LIS.Common.DHCVisitNumber).GetRuleCodeEpisodeNo(RuleCode,.SYSRuleNoBaseDR) 增加项目，删除项目，复查项目生成工单\nLISSP.DHCRPVisitNumberReport\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 /// Creator： 杨浩然 /// CreatDate： 20230714 /// Description:： 主动上传生成项目工单 /// Table： /// Input： 标本号，工作小组ID，报告ID，项目ID主键，工单类型（R 删除，U 复查，C 增加） /// Output： 成功1 /// Return： 生成上传工单 /// Others w ##class(LIS.Common.DHCVisitNumber).GenerateUploadRecordMTHD(\u0026#34;1000100990\u0026#34;,\u0026#34;67\u0026#34;,\u0026#34;59396\u0026#34;,\u0026#34;^61^284\u0026#34;,\u0026#34;U\u0026#34;) ClassMethod GenerateUploadRecordMTHD(Labno, WorkGroupMachineDR, ReportDR, RepeatTCList, SendStatus, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s Labno=$g(Labno),WorkGroupMachineDR=$G(WorkGroupMachineDR) s ^TMP(\u0026#34;CreateUploadRecordMTHD\u0026#34;)=$LB(Labno, WorkGroupMachineDR) s Labno=$g(Labno),ReportDR=$g(ReportDR),WorkGroupMachineDR=$g(WorkGroupMachineDR),RepeatTCList=$g(RepeatTCList),SendStatus=$g(SendStatus) i \u0026#39;$l(Labno) q 100 i \u0026#39;$l(ReportDR) q 100 i \u0026#39;$l(WorkGroupMachineDR) q 100 i \u0026#39;$l(SendStatus) q 100 s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///临时处理老年医院流水线标本上传 //i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; s ^DHCUploadAll(Labno)=WorkGroupMachineDR i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; q 100 s ret=100 s TCList=\u0026#34;\u0026#34; s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.BTMIMachineParameterI(\u0026#34;IndexWorkGroupMachine\u0026#34;,WorkGroupMachineDR,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .;i $d(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,Labno)) q .s miCommDirection=$lg(^dbo.BTMIMachineParameterD(MachineDR),11) .i miCommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; q .f i=1:1:$l(RepeatTCList,\u0026#34;^\u0026#34;) d ..s TestCodeID=$p(RepeatTCList,\u0026#34;^\u0026#34;,i) ..i TestCodeID=\u0026#34;\u0026#34; q ..//如果是复查或者删除项目则判断该项目是不是该报告的 ..i (SendStatus=\u0026#34;U\u0026#34;)||(SendStatus=\u0026#34;R\u0026#34;) d ...i $d(^dbo.RPVisitNumberReportResultI(\u0026#34;IndexReportItem\u0026#34;,ReportDR,TestCodeID)) d ....i $d(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexUPChannel\u0026#34;,MachineDR,TestCodeID)) d .....s UPChannel=$o(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexUPChannel\u0026#34;,MachineDR,TestCodeID,\u0026#34;\u0026#34;)) .....i UPChannel=-100000000000000 q .....b ;102 .....s TCList=TCList_UPChannel_\u0026#34;\\\u0026#34; ..e i SendStatus=\u0026#34;C\u0026#34; d ...i $d(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexUPChannel\u0026#34;,MachineDR,TestCodeID)) d ....s UPChannel=$o(^dbo.BTMIMachineTestCodeI(\u0026#34;IndexUPChannel\u0026#34;,MachineDR,TestCodeID,\u0026#34;\u0026#34;)) ....i UPChannel=-100000000000000 q ....b ;102 ....s TCList=TCList_UPChannel_\u0026#34;\\\u0026#34; .b ;101 .s TCList=$e(TCList,1,$l(TCList)-1) .i \u0026#39;$l(TCList) s ret=Labno_\u0026#34;没有上传项目\u0026#34; q .S RowID=\u0026#34;\u0026#34; .i $d(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno))) s RowID=$O(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) .I $L(RowID) s obj=##class(dbo.RPMachineUpload).%OpenId(RowID) .e s obj=##class(dbo.RPMachineUpload).%New() .s obj.MachineParameterDR=MachineDR .s obj.VisitNumber=Labno .s obj.SendStatus=SendStatus .s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) .s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) .s obj.TCList=TCList .s ret=obj.%Save() Q ret } 增加 AddReportTCRes\n1 S ret=##class(LIS.Common.DHCVisitNumber).GenerateUploadRecordMTHD(LabNo,WGMDR,ReportDR,RepeatTCList,\u0026#34;C\u0026#34;) 删除 DeleteReportTC\n1 S ret=##class(LIS.Common.DHCVisitNumber).GenerateUploadRecordMTHD(LabNo,WGMDR,ReportDR,RepeatTCList,\u0026#34;R\u0026#34;) 复查 RepeatReportTC\n1 S ret=##class(LIS.Common.DHCVisitNumber).CreateUploadRecordMTHD(LabNo,WGMDR,ReportDR,RepeatTCList) 编号规则\n1 [[\u0026#34;\u0026#34;1\u0026#34;\u0026#34;],[\u0026#34;\u0026#34;0\u0026#34;\u0026#34;,\u0026#34;\u0026#34;1\u0026#34;\u0026#34;,\u0026#34;\u0026#34;2\u0026#34;\u0026#34;,\u0026#34;\u0026#34;3\u0026#34;\u0026#34;,\u0026#34;\u0026#34;4\u0026#34;\u0026#34;,\u0026#34;\u0026#34;5\u0026#34;\u0026#34;,\u0026#34;\u0026#34;6\u0026#34;\u0026#34;,\u0026#34;\u0026#34;7\u0026#34;\u0026#34;,\u0026#34;\u0026#34;8\u0026#34;\u0026#34;,\u0026#34;\u0026#34;9\u0026#34;\u0026#34;],[\u0026#34;\u0026#34;0\u0026#34;\u0026#34;,\u0026#34;\u0026#34;1\u0026#34;\u0026#34;,\u0026#34;\u0026#34;2\u0026#34;\u0026#34;,\u0026#34;\u0026#34;3\u0026#34;\u0026#34;,\u0026#34;\u0026#34;4\u0026#34;\u0026#34;,\u0026#34;\u0026#34;5\u0026#34;\u0026#34;,\u0026#34;\u0026#34;6\u0026#34;\u0026#34;,\u0026#34;\u0026#34;7\u0026#34;\u0026#34;,\u0026#34;\u0026#34;8\u0026#34;\u0026#34;,\u0026#34;\u0026#34;9\u0026#34;\u0026#34;],[\u0026#34;\u0026#34;0\u0026#34;\u0026#34;,\u0026#34;\u0026#34;1\u0026#34;\u0026#34;,\u0026#34;\u0026#34;2\u0026#34;\u0026#34;,\u0026#34;\u0026#34;3\u0026#34;\u0026#34;,\u0026#34;\u0026#34;4\u0026#34;\u0026#34;,\u0026#34;\u0026#34;5\u0026#34;\u0026#34;,\u0026#34;\u0026#34;6\u0026#34;\u0026#34;,\u0026#34;\u0026#34;7\u0026#34;\u0026#34;,\u0026#34;\u0026#34;8\u0026#34;\u0026#34;,\u0026#34;\u0026#34;9\u0026#34;\u0026#34;],[\u0026#34;\u0026#34;0\u0026#34;\u0026#34;,\u0026#34;\u0026#34;1\u0026#34;\u0026#34;,\u0026#34;\u0026#34;2\u0026#34;\u0026#34;,\u0026#34;\u0026#34;3\u0026#34;\u0026#34;,\u0026#34;\u0026#34;4\u0026#34;\u0026#34;,\u0026#34;\u0026#34;5\u0026#34;\u0026#34;,\u0026#34;\u0026#34;6\u0026#34;\u0026#34;,\u0026#34;\u0026#34;7\u0026#34;\u0026#34;,\u0026#34;\u0026#34;8\u0026#34;\u0026#34;,\u0026#34;\u0026#34;9\u0026#34;\u0026#34;]] ","date":"2025-08-29T00:00:00Z","image":"https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-20250829142859/assets/image-20230713171820668-20250317141249-oljkc64_hu_daf2493c3e2552.png","permalink":"https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-20250829142859/","title":"罗氏流水线RS600"},{"content":"罗氏E601 接口说明 仪器厂商 罗氏E601\n仪器型号 罗氏E601\n通讯方式 双向\n仪器类型 医院名称 程序名称 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：串口☑|网口|监听文件|数据库|其他 连接方式：HL7协议|ASTM协议☑|监听文件|数据库|其他 仪器接口说明 增加稀释倍数上传 串口盒子配置 波特率： 9600 数据位：8 停止位： 1 校验位： N 数据格式 项目通道号 修改记录 序号 日期 操作人 说明 1 2025-04-29 10:57:07\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 /// 名称: MI.MIFCOBASE601 /// 描述: Cobas 6000 仪器接口 New Mode /// 通讯方式：双向 /// 编写者:liuzf /// 编写日期: 20150827 /// MIFCOBASE601(MachID) //仪器结果 s MachID=$g(MachID) S ^TMPMACH10(MachID,104)=$H i \u0026#39;$l(MachID) q s ItemDeli=$li(^dbo.BTMIMachineParameterD(MachID),12) //项目分隔符 s ResultDeli=$li(^dbo.BTMIMachineParameterD(MachID),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(MachID),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(MachID),15) //药敏结果分隔符 s Port=\u0026#34;|TCP|\u0026#34;_$li(^dbo.BTMIMachineParameterD(MachID),10) //端口号 //控制字符 s stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4),lf=$c(10),cr=$c(13),nak=$c(21),etb=$c(23) //s stx=\u0026#34;[\u0026#34;,etx=\u0026#34;]\u0026#34; s AllRecord=\u0026#34;\u0026#34; S ^TMPMACH10(MachID,102)=$H i $$Start^MI.MIF000(MachID) q f d Main i $$Stop^MI.MIF000(MachID) q c Port q Main SET $ZTRAP=\u0026#34;ERR\u0026#34; r *R:10 e d q .d ORDER i $c(R)=-1 w nak,*-3 i $c(R)\u0026#39;=enq q d Trace^MI.MIF000(MachID,\u0026#34;ENQ\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) d ACK f r *R:10 q:$c(R)=eot q:R=-1 d .i $c(R)\u0026#39;=stx q .s record=$$Read^MI.MIF000(MachID,\u0026#34;\u0026#34;,lf) q:\u0026#39;$l(record) .d Trace^MI.MIF000(MachID,record,\u0026#34;H\u0026lt;--M\u0026#34;) .d ACK .s record=$e(record,1,$l(record)-1) .i $l(record,etb)\u0026gt;1 s AllRecord=$g(AllRecord)_$p($e(record,2,$l(record)-1),etb,1) .i $l(record,etx)\u0026gt;1 s AllRecord=$g(AllRecord)_$p($e(record,2,$l(record)-1),etx,1) .d Result d Trace^MI.MIF000(MachID,$s($c(R)=eot:\u0026#34;EOT\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) d ORDER q Last\t; file result if exist d Trace^MI.MIF000(MachID,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;Result\u0026#34;) i $l(epis),$l(result) d Save^MI.MIF000(MachID,epis,result,date,time,QC) s (epis,result,date,time,QC)=\u0026#34;\u0026#34; q Result //s num=$o(^TMP(mi,\u0026#34;\u0026#34;),-1)+1 //s ^TMP(mi,num)=AllRecord s headstr=\u0026#34;\u0026#34; f k=1:1:$l(AllRecord,cr) d .s record=$p(AllRecord,cr,k) .i $e(record,1)=\u0026#34;H\u0026#34; d q ..s (sample,epis,surname,rec,res,result,date,time,QC)=\u0026#34;\u0026#34; ..s headstr=\u0026#34;1\u0026#34;_record .i $e(record,1)=\u0026#34;Q\u0026#34; d q ..;Q|1|^^ 55163517^0^5066^1^^S1^SC||ALL||||||||A ..S sampleID=$P($P(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,3) ..S sampleInfo=$P($P(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4,9) ..S labno=$TR(sampleID,\u0026#34; *\u0026#34;) ..s rack=$tr($p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,5),\u0026#34; \u0026#34;) ..s pos=$tr($p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,6),\u0026#34; \u0026#34;) ..;s retVal=$$ReceiveLabno^MI.MIF000(MachID,labno,rack_pos) ..;i retVal\u0026#39;=1 Quit ..i $l(labno) S ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,labno)=sampleID_$C(2)_sampleInfo_$c(2)_rack_$c(2)_pos // .i $e(record,1)=\u0026#34;O\u0026#34; d q ..;-------双向取条码号--- ..s epis=$tr($p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) ..i \u0026#39;$l(epis) s epis=$tr($p($p(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1),\u0026#34; \u0026#34;) . ; result record .i $e(record,1)=\u0026#34;R\u0026#34; d q ..;R|1|^^^50/1/not|3.38|ng/ml||N||F|||||E11 ..;R|2|^^^64//not|2.00|IU/L||LL||F|||||E22 ..s code=$p($p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4),\u0026#34;/\u0026#34;,1) ..s res=$p(record,\u0026#34;|\u0026#34;,4) ..i res[\u0026#34;^\u0026#34; s res=$p(res,\u0026#34;^\u0026#34;,2) ..s res=$tr(res,\u0026#34; \u0026#34;) ..s Flag=$p(record,\u0026#34;|\u0026#34;,7) ..i Flag=\u0026#34;LL\u0026#34; s res=\u0026#34;\u0026lt;\u0026#34;_res ..i Flag=\u0026#34;HH\u0026#34; s res=\u0026#34;\u0026gt;\u0026#34;_res ..i $l(code),$l(res) s result=result_code_ResultDeli_res_ItemDeli .; last record .i $e(record,1)=\u0026#34;L\u0026#34; d Last i $l(AllRecord) s AllRecord=$p(AllRecord,cr,$l(AllRecord,cr)) q ORDER ;ORDER LIST ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,epis i \u0026#39;$d(^TMP($zn)) q i \u0026#39;$d(^TMP($zn,$j)) q s labno=\u0026#34;\u0026#34; f s labno=$o(^TMP($zn,$j,\u0026#34;ENQ\u0026#34;,labno)) q:labno=\u0026#34;\u0026#34; d .s requestData=^(labno) .s sampleID=$P(requestData,$C(2),1) .s sampleInfo=$P(requestData,$C(2),2) .s $p(headstr,\u0026#34;|\u0026#34;,11)=\u0026#34;TSDWN^REPLY\u0026#34; .s headstr=headstr_cr .//20140403 .s rackid=$p(requestData,$c(2),3) .s posid=$p(requestData,$c(2),4) .///保存位置号20110621 huhm .//d SetTSMachPos^MIF000(mi,labno,rackid,posid) .// .d ScanOne^MI.MIF000(MachID,labno) .s patstr=$$PATDET(labno)_cr .s tcx=\u0026#34;\u0026#34;,episx=labno .//s ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID,labno,49)=\u0026#34;\u0026#34; .//s ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID,labno,50)=\u0026#34;\u0026#34; .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID,labno,chl)) q:chl=\u0026#34;\u0026#34; d ..;i chl=\u0026#34;148\u0026#34; d ...;s tcx=tcx_\u0026#34;^^^\u0026#34;_chl_\u0026#34;^20\\\u0026#34; ..;e s tcx=tcx_\u0026#34;^^^\u0026#34;_chl_\u0026#34;^\\\u0026#34; ..s XSBS=$g(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachID,labno,chl)) ..d Trace^MI.MIF000(MachID,chl_\u0026#34;项目稀释\u0026#34;_XSBS_\u0026#34;倍\u0026#34;,\u0026#34;稀释倍数\u0026#34;) ..s tcx=tcx_\u0026#34;^^^\u0026#34;_chl_\u0026#34;^\u0026#34;_XSBS_\u0026#34;\\\u0026#34; .s tcx=$e(tcx,1,$l(tcx)-1) .s SpecimenDR=\u0026#34;\u0026#34; .s VisNumDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $l(VisNumDR) s SpecimenDR=$lg(^dbo.RPVisitNumberD(VisNumDR),56) .S specimenTypeID=\u0026#34;1\u0026#34;,specimenType=\u0026#34;血\u0026#34; .I $L(SpecimenDR) D ..S specimenType=$lg($g(^dbo.BTSpecimenD(SpecimenDR)),3) .//标本类型代码,1=血清/血浆,2=尿,3=脑脊液,4=supmt,5=其他 .S specimenID=$S(specimenType[\u0026#34;血\u0026#34;:1,specimenType[\u0026#34;尿\u0026#34;:2,specimenType[\u0026#34;脑脊液\u0026#34;:3,1:1) .///O|1| CEA-10|0^5012^2^^S1^SC|^^^49^|R||||||N||||1|||||||20140324140016|||F .S ordstr=\u0026#34;O|1|\u0026#34;_sampleID_\u0026#34;|\u0026#34;_sampleInfo_\u0026#34;|\u0026#34; .S ordstr=ordstr_tcx_\u0026#34;|R||\u0026#34;_$TR($ZD($P($H,\u0026#34;,\u0026#34;,1),3),\u0026#34;-\u0026#34;)_$TR($ZT($P($H,\u0026#34;,\u0026#34;,2),1),\u0026#34;:\u0026#34;)_\u0026#34;||||N||||\u0026#34;_specimenID_\u0026#34;||||||||||O|||||\u0026#34;_cr .///L .s endstr=\u0026#34;L|1|N\u0026#34;_cr .s str=headstr_patstr_ordstr_endstr .d Send(labno,str) k ^TMP($zn,$j,\u0026#34;ENQ\u0026#34;) q PATDET(epis) ; set patient details record s retstr=\u0026#34;P|1\u0026#34; q retstr Send(epis,str) ; send list of orders if exists w enq,*-3 d Trace^MI.MIF000(MachID,\u0026#34;ENQ\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q d Trace^MI.MIF000(MachID,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;H\u0026lt;--M\u0026#34;) i $c(R)=enq q i $c(R)\u0026#39;=ack w eot,*-3 d Trace^MI.MIF000(MachID,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q i $l(str)\u0026gt;241 d .s str1=$e(str,1,241) .s ret=$$SEND(str1,1) .s str2=\u0026#34;2\u0026#34;_$e(str,242,$l(str)) .s ret=$$SEND(str2,0) e d .s ret=$$SEND(str,0) //f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q //d Trace^MI.MIF000(MachID,$s($c(R)=ack:\u0026#34;ACK\u0026#34;,$c(R)=enq:\u0026#34;ENQ\u0026#34;,$c(R)=nak:\u0026#34;NAK\u0026#34;,1:R),\u0026#34;2H\u0026lt;--M\u0026#34;) w eot,*-3 d Trace^MI.MIF000(MachID,\u0026#34;EOT\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q h 0.2 q ERR h 10 s ^TMPMachErr(+MachID,$j)=$ZERROR_\u0026#34;.错误代码:\u0026#34;_$ECODE q SEND(str,flag) ; send string to instrument i flag=1 d .s str=str_etb .s chsum=$$CHSUM(str) e d .s str=str_etx .s chsum=$$CHSUM(str) w stx,str,chsum,cr,lf,*-3 d Trace^MI.MIF000(MachID,str_chsum,\u0026#34;H--\u0026gt;M\u0026#34;) f j=1:1:6 r *R:1 i ($c(R)=ack)!($c(R)=eot) q i $c(R)=ack d Trace^MI.MIF000(MachID,\u0026#34;ACK\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 i $c(R)=eot d Trace^MI.MIF000(MachID,\u0026#34;EOT\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q 0 i $c(R)=-1 w nak,*-3 d Trace^MI.MIF000(MachID,R,\u0026#34;H\u0026lt;--M\u0026#34;) q 1 ///w $$CHSUM^MI.MIFCOBASE601(\u0026#34;3O^0101001N01300043225^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^M^^^20200115^1.021^59M^\u0026#34;) CHSUM(x) ; calculate check sum n (x) s z=0 f y=1:1:$l(x) s z=z+$a(x,y) s z=$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#256\\16+1)_$e(\u0026#34;0123456789ABCDEF\u0026#34;,z#16+1) q z ///发送回应符到仪器 ACK h 0.2 s ack=$c(6) w ack,*-3 d Trace^MI.MIF000(MachID,\u0026#34;ACK\u0026#34;,\u0026#34;H--\u0026gt;M\u0026#34;) q NEXTTRAY(tray) q tray ","date":"2025-08-28T00:00:00Z","image":"https://work.717170.xyz/img/title.jpg","permalink":"https://work.717170.xyz/p/%E7%BD%97%E6%B0%8Fe601-20250828182020/","title":"罗氏E601"},{"content":"罗氏流水线IT3000 接口说明 仪器厂商 罗氏流水线\n仪器型号 IT3000\n通讯方式 主动上传\n仪器类型 生化发光流水线 医院名称 厦门翔安医院 程序名称 MI.MIFIT3000 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：监听文件 连接方式：抓取RESULT结果文件和SEEN处理文件 .hl7文件，上传ORDERS .hl7文件 仪器接口说明 罗氏流水线与lis交互分为处理文件 SEEN 和结果文件 RESULT 两种以及血清图片，处理文件过多，lis读取文件和解析文件同时进行，造成结果文件无法及时解析，造成仪器传了结果但是未及时读取造成无法及时发报告。针对这一问题，详细在问题处理中无法及时读取文件处理造成获取结果过慢记录。 接口中包含多种功能，包含血清图片，自动核收，报警信息存储等。详细在仪器个性功能中展示。 数据格式 修改记录 序号 日期 操作人 说明 1 2025-04-03 10:15:50\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848 849 850 851 852 853 854 855 856 857 858 859 860 861 862 863 864 865 866 867 868 869 870 871 872 873 874 875 876 877 878 879 880 881 882 883 884 885 886 887 888 889 890 891 892 893 894 895 896 897 898 899 900 901 902 903 904 905 906 907 908 909 910 911 912 913 914 915 916 917 918 919 920 921 922 923 924 925 926 927 928 929 930 931 932 933 934 935 936 937 938 939 940 941 942 943 944 945 946 947 948 949 950 951 952 953 954 955 956 957 958 959 960 961 962 963 964 965 966 967 968 969 970 971 972 973 974 975 976 977 978 979 980 981 982 983 984 985 986 987 988 989 990 991 992 993 994 995 996 997 998 999 1000 1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 1011 1012 1013 1014 1015 1016 1017 1018 1019 1020 1021 1022 1023 1024 1025 1026 1027 1028 1029 1030 1031 1032 1033 1034 1035 1036 1037 1038 1039 1040 1041 1042 1043 1044 1045 1046 1047 1048 1049 1050 1051 1052 1053 1054 1055 1056 1057 1058 1059 1060 1061 1062 1063 1064 1065 1066 1067 1068 1069 1070 1071 1072 1073 1074 1075 1076 1077 1078 1079 1080 1081 1082 1083 1084 1085 1086 1087 1088 1089 1090 1091 1092 1093 1094 1095 1096 1097 1098 1099 1100 1101 1102 1103 1104 1105 1106 1107 1108 1109 1110 1111 1112 1113 1114 1115 1116 1117 1118 1119 1120 1121 1122 1123 1124 1125 /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;Z:\\\\ResultExport\\\\\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFLICA800\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.csv\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;Z:\\\\Imports\\\\\u0026#34;}] Class MI.MIFIT3000N1 Extends %RegisteredObject { /// D ##class(MI.MIFInfinity).fileMTHD(\u0026#34;7\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#\u0026#34;,\u0026#34;\u0026#34;) /// seen: [VT]#enter#MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR] /// result: [VT]#enter#MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR] /// D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) /// seen: D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;[VT]#enter#MSH|^~\\\u0026amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]\u0026#34;,\u0026#34;\u0026#34;) /// result:D ##class(MI.MIFRS600).fileMTHD(\u0026#34;56\u0026#34;,\u0026#34;[VT]#enter#MSH|^~\\\u0026amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]\u0026#34;,\u0026#34;\u0026#34;) /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\Results,E:\\\\Temp\\\\Temp\\\\Interface\\\\Seens\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFXAIT3000\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.hl7\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoMAll,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealImage,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\ORDERS\\\\\u0026#34;}] /// [{\u0026#34;MachID\u0026#34;:\u0026#34;#RowID\u0026#34;,\u0026#34;Type\u0026#34;:\u0026#34;Drect\u0026#34;,\u0026#34;UpTime\u0026#34;:\u0026#34;3000\u0026#34;,\u0026#34;Address\u0026#34;:\u0026#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\Results,E:\\\\Temp\\\\Temp\\\\Interface\\\\Seens\u0026#34;,\u0026#34;UpCDF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;UpREF\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DealProcess\u0026#34;:\u0026#34;MI.MIFXAIT3000\u0026#34;,\u0026#34;Para\u0026#34;:\u0026#34;.hl7\u0026#34;,\u0026#34;PreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoMAll,PreDeal\u0026#34;,\u0026#34;UPPreDealClass\u0026#34;:\u0026#34;PreDeal.DealDemoM,PreDeal\u0026#34;,\u0026#34;UpPara\u0026#34;:\u0026#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\ORDERS\\\\\u0026#34;}] /// D ##class(MI.MIFIT300N).fileMTHD(\u0026#34;34\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|LIS||HOST||20250317162926||ORU^R01^ORU_R01|20250317162926573175|P|2.5|||AL|ER[13][10]PID|1||0000486028||^郑龙怡||20000126|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^感染性疾病科[13][10]ORC|SC|1003777033|||CM||||20250317160618[13][10]OBR|1|1003777033|||||||||||||||||||||||F[13][10]OBX|1|NM|TRAB^TRAB||\u0026lt;0.800|||LIMTL|||F|||20250317170643|E1^MU1-e801-1-2@5503[13][10]NTE|1||LIMTL[13][10]NTE|1||LIMTL[13][10]\u0026#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(\u0026#34;34\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|LIS||HOST||20250320102229||ORU^R01^ORU_R01|20250320102229442999|P|2.5|||AL|ER[13][10]PID|1||0000481255||^杨建利||19880623|M[13][10]PV1|1|U||||||||109|||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003782597|||CM||||20250320084145||||||||109[13][10]OBR|1|1003782597|||||||||||||||||||||||F[13][10]OBX|1|NM|GLU^GLU||8.830||||||F|||20250320100301|C2^MU1-c702-2-2@5607[13][10]OBX|2|NM|UREA^UREA||4.330||||||F|||20250320100306|C2^MU1-c702-2-1@5607[13][10]OBX|3|NM|UA^UA||434.900||||||F|||20250320100254|C2^MU1-c702-2-2@5607[13][10]OBX|4|NM|TP^TP||79.900||||||F|||20250320095858|C1^MU1-c702-1-1@5607[13][10]OBX|5|NM|ALB^ALB||46.000||||||F|||20250320095348|C1^MU1-c702-1-2@5607[13][10]OBX|6|NM|TBIL^TBIL||6.000||||||F|||20250320095923|C1^MU1-c702-1-1@5607[13][10]OBX|7|NM|DBIL^DBIL||1.800||||||F|||20250320095901|C1^MU1-c702-1-1@5607[13][10]OBX|8|NM|ALT^ALT||107.000||||||F|||20250320095900|C1^MU1-c702-1-2@5607[13][10]OBX|9|NM|AST^AST||62.300||||||F|||20250320095909|C1^MU1-c702-1-1@5607[13][10]OBX|10|NM|RGT^RGT||68.800||||||F|||20250320100259|C2^MU1-c702-2-1@5607[13][10]OBX|11|NM|ALP^ALP||83.700||||||F|||20250320095907|C1^MU1-c702-1-2@5607[13][10]OBX|12|NM|TRIGL^TRIGL||8.810||||||F|||20250320100304|C2^MU1-c702-2-2@5607[13][10]OBX|13|NM|TC^TC||4.910||||||F|||20250320100257|C2^MU1-c702-2-2@5607[13][10]OBX|14|NM|SCRE^SCRE||66.400||||||F|||20250320100313|C2^MU1-c702-2-1@5607[13][10]OBX|15|NM|9CYSC^CYSC_NEW||0.89||||||F|||20250320095916|C1^MU1-c702-1-1@5607[13][10]OBX|16|NM|9HDL^HDL_NEW||0.69||||||F|||20250320095914|C1^MU1-c702-1-2@5607[13][10]OBX|17|NM|9LDL^LDL_NEW||2.06||||||F|||20250320095921|C1^MU1-c702-1-2@5607[13][10]OBX|18|ST|XYZL^DM_SERQ||Z:脂血||||||F|||20250320083356[13][10]\u0026#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(\u0026#34;34\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|LIS||HOST||20250320151725||ORU^R01^ORU_R01|20250320151725880554|P|2.5|||AL|ER[13][10]PID|1||0000095425||^姚程成||19980712|M[13][10]PV1|1|U|||||||||||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003784045|||CM||||20250320104114[13][10]OBR|1|1003784045|||||||||||||||||||||||F[13][10]OBX|1|NM|TP^TP||73.600||||||F|||20250320115059|C1^MU1-c702-1-1@5095[13][10]OBX|2|NM|ALB^ALB||49.600||||||F|||20250320114553|C1^MU1-c702-1-2@5095[13][10]OBX|3|NM|TBIL^TBIL||16.400||||||F|||20250320115110|C1^MU1-c702-1-1@5095[13][10]OBX|4|NM|DBIL^DBIL||4.400||||||F|||20250320115056|C1^MU1-c702-1-1@5095[13][10]OBX|5|NM|ALT^ALT||18.100||||||F|||20250320115057|C1^MU1-c702-1-2@5095[13][10]OBX|6|NM|AST^AST||22.900||||||F|||20250320115103|C1^MU1-c702-1-1@5095[13][10]OBX|7|NM|RGT^RGT||8.900||||||F|||20250320115522|C2^MU1-c702-2-1@5095[13][10]OBX|8|NM|ALP^ALP||78.100||||||F|||20250320115105|C1^MU1-c702-1-2@5095[13][10]\u0026#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(\u0026#34;34\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|LIS||HOST||20250321083434||ACK^^ACK|20250321083434378641|P|2.5|||NE|NE[13][10]EQU||^^^c702^^SAMPLEEVENT^SEEN|20250321083434[13][10]SAC|||1003775669|1003775669||20250321083433|01||P|c702|5719@4[13][10]\u0026#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(\u0026#34;34\u0026#34;,\u0026#34;MSH|^~\\\u0026amp;|LIS||HOST||20250328191032||ORU^R01^ORU_R01|20250328191032737830|P|2.5|||AL|ER[13][10]PID|1||0000531818||^郑苹||19811117|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^心血管内科[13][10]ORC|SC|1003802907|||CM||||20250328191358[13][10]OBR|1|1003802907|||||||||||||||||||||||F[13][10]OBX|1|NM|U-CR^U-CR||5924.00||||||F|||20250328200846|C2^MU1-c702-2-1@4003|||||||||5924.00[13][10]OBX|2|NM|UR-MALB^UR-MALB||15.30|||OBS.RR|||F|||20250328200852|C2^MU1-c702-2-2@4003|||||||||15.30[13][10]NTE|1||OBS.RR[13][10]\u0026#34;) /// 非流水线分区代码 Parameter FQCode = \u0026#34;WANTAI,XINCHANYE,LINJIAN,XIEGUANG\u0026#34;; ClassMethod fileMTHD(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),record=$g(record),epis=$g(epis),filename=$g(filename),P4=$g(P4),P5=$g(P5),P6=$g(P6),P7=$g(P7),P8=$g(P8),P9=$g(P9),P10=$g(P10),P11=$g(P11),P12=$g(P12),P13=$g(P13),Sessions=$g(Sessions) i filename[\u0026#34;Results\u0026#34; j ..ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) q \u0026#34;\u0026#34; e d ..ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) q \u0026#34;\u0026#34; } ClassMethod ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;0\u0026#34; s HospitalDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),4) i \u0026#39;$l(record) q \u0026#34;0\u0026#34; i filename[\u0026#34;Seens\u0026#34; d Trace^MI.MIF000(mi,record,\u0026#34;SeensRecord\u0026#34;) e i filename[\u0026#34;Results\u0026#34; d Trace^MI.MIF000(mi,record,\u0026#34;ResultsRecord\u0026#34;) e d Trace^MI.MIF000(mi,record,\u0026#34;AllRecord\u0026#34;) s recordbak=record\t//仪器数据备份 s commandName=\u0026#34;\u0026#34;\t//前处理名称初始化 s commandchild=\u0026#34;\u0026#34; //前处理命令初始化 s DealDateStr=\u0026#34;\u0026#34; //MSH 时间初始化 s (sample,result,date,time,QC)=\u0026#34;\u0026#34; //解析多行合并数据 f i=1:1:$l(recordbak,\u0026#34;[13][10]\u0026#34;){ s record=$p(recordbak,\u0026#34;[13][10]\u0026#34;,i) ;d Trace^MI.MIF000(mi,record,\u0026#34;解析行数据\u0026#34;) i \u0026#39;$l(record) q s type=$p(record,\u0026#34;|\u0026#34;,1)\t//取出消息头命令类型 //解析MSH命令 i type=\u0026#34;MSH\u0026#34;{ s DateStr=$p(record,\u0026#34;|\u0026#34;,7)\t//取日期串 i $l(DateStr)=14 s DealDateStr=$e(DateStr,1,8)_\u0026#34;,\u0026#34;_(($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60))\t//解析保存日期串 } //解析EQU命令\t包含前处理后处理指令，根据指令记录对应事件 i type=\u0026#34;EQU\u0026#34;{ //前处理名称\tRSA1 流水线处理信息，e801、P501_701\t仪器处理信息 s commandName=$p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,4) //获取前处理命令，SEEN 上机事件，RESULT 前处理分区事件，RSA1 未知事件，ARCHIVE 归档事件 s commandchild=$p($p(record,\u0026#34;|\u0026#34;,3),\u0026#34;^\u0026#34;,7) ;d Trace^MI.MIF000(mi,commandchild,\u0026#34;前处理命令\u0026#34;) } //解析SAC命令\t根据EQU命令重获取到的前处理事件，进行LIS相关处理 //本接口包括 SEEN 自动核收，ARCHIVE 记录归档位置 i type=\u0026#34;SAC\u0026#34;{ s epis=$p(record,\u0026#34;|\u0026#34;,5)\t//取出流水号 s machCode=$p(record,\u0026#34;|\u0026#34;,11)\t//取出前处理分区信息或仪器信息 s positioninfo=$p(record,\u0026#34;|\u0026#34;,12)\t//取出位置信息 //前处理SEEN 自动核收 i commandchild=\u0026#34;SEEN\u0026#34;{ ;d Trace^MI.MIF000(mi,\u0026#34;分区信息，标本号:\u0026#34;_epis_\u0026#34;的样本所在分区:\u0026#34;_machCode_\u0026#34; \u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) i commandName=\u0026#34;RSA1\u0026#34; j ..SaveRecord(epis,\u0026#34;分区位置:\u0026#34;_machCode_\u0026#34;-\u0026#34;_positioninfo,mi,\u0026#34;100\u0026#34;)\t//前处理分区 e j ..SaveRecord(epis,\u0026#34;上机位置:\u0026#34;_commandName_\u0026#34;-\u0026#34;_positioninfo,mi,\u0026#34;6\u0026#34;)\t//上机 try{d ..ZDHS(mi,epis,machCode,positioninfo)}catch ex{d Trace^MI.MIF000(mi,ex.Data,\u0026#34;自动核收提示\u0026#34;)}\t//自动核收 i commandName=\u0026#34;RSA1\u0026#34; d .i (\u0026#34;,\u0026#34;_..#FQCode_\u0026#34;,\u0026#34;)\u0026#39;[(\u0026#34;,\u0026#34;_machCode_\u0026#34;,\u0026#34;) d\t//$TS$ 只有流水线仪器记录分区架子号 ..j ..SaveRackNo(epis,machCode_\u0026#34;-\u0026#34;_positioninfo,mi,\u0026#34;分区\u0026#34;) e j ..SaveRackNo(epis,commandName_\u0026#34;-\u0026#34;_positioninfo,mi,\u0026#34;上机\u0026#34;) } //前处理RESULT 处理分区信息 i commandchild=\u0026#34;RESULT\u0026#34;{ s curMachName=machCode\t//通过仪器对照码取仪器 //此处存标本全部分区预处理的位置号\t针对非流水线标本分拣 i commandName=\u0026#34;RSA1\u0026#34; j ..SaveRecord(epis,\u0026#34;分区位置:\u0026#34;_positioninfo,mi,\u0026#34;100\u0026#34;)\t//前处理分区 i commandName=\u0026#34;RSA1\u0026#34; j ..SaveRackNo(epis,positioninfo,mi,\u0026#34;分区\u0026#34;) } //前处理ARCHIVE 处理归档信息 i commandchild=\u0026#34;ARCHIVE\u0026#34;{ s curMachName=machCode\t//通过仪器对照码取仪器 //此处存标本全部审核报告的位置号 ;d Trace^MI.MIF000(mi,\u0026#34;归档信息，标本号:\u0026#34;_epis_\u0026#34;的样本所在仪器:\u0026#34;_curMachName_\u0026#34; \u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) ;d Trace^MI.MIF000(mi,epis_\u0026#34;执行记录分类信息:\u0026#34;_positioninfo,\u0026#34;H\u0026lt;--M\u0026#34;) i commandName=\u0026#34;RSA1\u0026#34; d .j ..SaveRackNo(epis,positioninfo,mi,\u0026#34;归档\u0026#34;)\t//保存归档信息到架子号 .j ..SaveRecord(epis,\u0026#34;冰箱归档位置:\u0026#34;_positioninfo,mi,\u0026#34;62\u0026#34;)\t//冰箱归档 e d .j ..SaveRackNo(epis,positioninfo,mi,\u0026#34;归档中\u0026#34;)\t//保存归档信息到架子号 .j ..SaveRecord(epis,\u0026#34;归档中位置:\u0026#34;_positioninfo,mi,\u0026#34;62\u0026#34;)\t//归档 ;d Trace^MI.MIF000(mi,epis_\u0026#34;记录归档信息完成\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) } } //解析质控数据,P业务数据，Q质控数据 i type=\u0026#34;ORC\u0026#34;{ s epis=$p(record,\u0026#34;|\u0026#34;,3) } i type=\u0026#34;OBR\u0026#34;{ s epis=$p(record,\u0026#34;|\u0026#34;,3) } //仪器报警信息 i type=\u0026#34;NTE\u0026#34;{ s WaringStr=$p(record,\u0026#34;|\u0026#34;,4) s WaringCode=$p(WaringStr,\u0026#34; \u0026#34;,2) ;d Trace^MI.MIF000(mi,\u0026#34;仪器报警信息:\u0026#34;_WaringStr,\u0026#34;H\u0026lt;--M\u0026#34;) //保存仪器报警信息到组内报告评价 ;d ..SaveResultWarned(epis,WaringStr,mi) } try{j ##class(MI.Special.Record).RecordData(epis,recordbak,\u0026#34;LSLSXGET\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 i type=\u0026#34;OBX\u0026#34;{ s machCode=$p(record,\u0026#34;|\u0026#34;,16)\t//仪器信息和架子号信息 s code=$p($p(record,\u0026#34;|\u0026#34;,4),\u0026#34;^\u0026#34;,1) s res=$p(record,\u0026#34;|\u0026#34;,6) s CallThePolice=$p(record,\u0026#34;|\u0026#34;,9)\t//项目报警信息 s res=..ConvertResult(code,res)\t//结果特殊转换 i $l(CallThePolice) d .s result=result_code_$c(92)_res_$c(92)_$c(92)_CallThePolice_$c(44)\t//YHR 20250328 将报警信息存入到其他结果字段 .try{j ..SaveResultWarned(epis,\u0026#34;存在仪器报警信息\u0026#34;,mi,\u0026#34;41\u0026#34;)}catch{}\t//YHR 20250329 存储报警信息标志，此处41为常规生化工作小组$TS$ e s result=result_code_$c(92)_res_$c(44) } } i $l(result) d Trace^MI.MIF000(mi,epis_\u0026#34;$$\u0026#34;_result,\u0026#34;H\u0026lt;--M\u0026#34;) //统一保存结果 i $l(epis),$l(result){ i $l(DealDateStr){\t//如果记录到时间，则根据仪器时间存储结果。 s date=$p(DealDateStr,\u0026#34;,\u0026#34;,1) s time=$p(DealDateStr,\u0026#34;,\u0026#34;,2) i $l(date)\u0026#39;=8 s date=\u0026#34;\u0026#34;,time=\u0026#34;\u0026#34; } d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) } q \u0026#34;\u0026#34; } /// 结果特殊转换 /// $TS$ /// W ##CLASS(MI.MIFIT3000N1).ConvertResult(\u0026#34;9PA\u0026#34;,\u0026#34;\u0026lt;0.070\u0026#34;) ClassMethod ConvertResult(code, res) { i code=\u0026#34;9PA\u0026#34; d .i $e(res)=\u0026#34;\u0026lt;\u0026#34;,+$e(res,2,*)=\u0026#34;.07\u0026#34; d ..s res=\u0026#34;\u0026lt;70\u0026#34; q res } /// 报警信息转换 ClassMethod ConvertPoliceInfo(WaringCode) { s WaringStr=\u0026#34;\u0026#34; i WaringCode=\u0026#34;5\u0026#34; s WaringStr=\u0026#34;\u0026gt;ABS(超出ABS)\u0026#34; i WaringCode=\u0026#34;43\u0026#34; s WaringStr=\u0026#34;Cal.E(校准结果异常)\u0026#34; i WaringCode=\u0026#34;2\u0026#34; s WaringStr=\u0026#34;\u0026gt;Cuvet(反应杯空白异常)\u0026#34; i WaringCode=\u0026#34;42\u0026#34; s WaringStr=\u0026#34;Edit(实验结果已被编辑)\u0026#34; i WaringCode=\u0026#34;23\u0026#34; s WaringStr=\u0026#34;\u0026gt;ISE(超出ISE范围)\u0026#34; i WaringCode=\u0026#34;19\u0026#34; s WaringStr=\u0026#34;ISE.E(ISE电压级错误)\u0026#34; i WaringCode=\u0026#34;56\u0026#34; s WaringStr=\u0026#34;\u0026gt;Kin(Prozone错误2/运动不稳)\u0026#34; i WaringCode=\u0026#34;10\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; i WaringCode=\u0026#34;11\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; i WaringCode=\u0026#34;6\u0026#34; s WaringStr=\u0026#34;\u0026gt;Prozone(Prozone错误1)\u0026#34; i WaringCode=\u0026#34;4\u0026#34; s WaringStr=\u0026#34;Reag.S(试剂不足)\u0026#34; i WaringCode=\u0026#34;44\u0026#34; s WaringStr=\u0026#34;\u0026gt;Rept(高出原倍复查范围)\u0026#34; i WaringCode=\u0026#34;45\u0026#34; s WaringStr=\u0026#34;\u0026lt;Rept(低于原倍复查范围)\u0026#34; i WaringCode=\u0026#34;46\u0026#34; s WaringStr=\u0026#34;Samp.？(高出ABS最大值)\u0026#34; i WaringCode=\u0026#34;68\u0026#34; s WaringStr=\u0026#34;Samp.B(样本中有气泡)\u0026#34; i WaringCode=\u0026#34;72\u0026#34; s WaringStr=\u0026#34;Samp.C(样本中有凝块)\u0026#34; i WaringCode=\u0026#34;26\u0026#34; s WaringStr=\u0026#34;\u0026gt;Test(高出线性范围)\u0026#34; i WaringCode=\u0026#34;27\u0026#34; s WaringStr=\u0026#34;\u0026lt;Test(低于线性范围)\u0026#34; q WaringStr } /// 记录标本日志 /// D ##class(MI.MIFRS600).SaveRecord(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode, curWorkGroupMachineDR) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s OperateTypeCode=$g(OperateTypeCode) i \u0026#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,\u0026#34;,\u0026#34;,2),\u0026#34;\u0026#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,\u0026#34;\u0026#34;) } /// 保存报告表报警信息标志 /// D ##class(MI.MIFIT3000N1).SaveResultWarned(\u0026#34;1003803130\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;41\u0026#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI, curWorkGroupMachineDR) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) i \u0026#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) i $l(conclusion)\u0026gt;20 s conclusion=$e(conclusion,1,20)_\u0026#34;...\u0026#34; s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } /// 保存评价信息(标本质量) /// D ##class(MI.MIFRS600).SaveConclusion(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveConclusion(labno, conclusion, predealMI, curWorkGroupMachineDR, IsPrint) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s IsPrint=$g(IsPrint) i IsPrint\u0026#39;=1 s IsPrint=\u0026#34;0\u0026#34;\t//1 打印主评价，0 不打印次评价 i \u0026#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i IsPrint=1 d ......i $l(objrep.MajorConclusion) s objrep.MajorConclusion=objrep.MajorConclusion_\u0026#34;,\u0026#34;_conclusion ......e s objrep.MajorConclusion=conclusion ......e d ......i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_\u0026#34;,\u0026#34;_conclusion ......e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i IsPrint=1 d ..s objrep.MajorConclusion=conclusion .e s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } /// 保存归档,分类信息,架子号,新增保存类型和参数工作小组ID，针对仪器不在对应的工作小组也可以保存架子号。 /// D ##class(MI.Special.Common).SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) /// D ##class(MI.Special.Common).SaveRackNo(\u0026#34;1003775669\u0026#34;,\u0026#34;c702-5719@4\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;上机\u0026#34;) ClassMethod SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) { s labno=$g(labno) s positioninfo=$g(positioninfo) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),typename=$g(typename) i \u0026#39;$L(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $l(typename) s positioninfo=typename_\u0026#34;:\u0026#34;_positioninfo s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo) j ..SaveRecord(labno,\u0026#34;架子号位置更新:\u0026#34;_objrep.RackNo_\u0026#34;--\u0026gt;\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;)\t//架子号更新 .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,\u0026#34;-1^存\u0026#34;_typename_\u0026#34;信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i $l(objrep.RackNo) j ..SaveRecord(labno,\u0026#34;架子号位置更新:\u0026#34;_objrep.RackNo_\u0026#34;--\u0026gt;\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;)\t//架子号更新 .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q hasFindRep } /// 保存标本图片 /// D ##class(MI.MIFRS600).SaveImageMTHD(\u0026#34;57\u0026#34;,\u0026#34;1000100990\u0026#34;,\u0026#34;P\u0026#34;,\u0026#34;/iLISLIS080/demo.png\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) /// D ##class(MI.MIFIT3000N1).SaveImageMTHD(\u0026#34;34\u0026#34;,\u0026#34;1003783657_01\u0026#34;,\u0026#34;1003783657_01\u0026#34;,\u0026#34;/iLISLIS032/20250321/1003783657_01.jpg\u0026#34;,\u0026#34;C:\\LISDATA\\DATA\\1003783657_01.jpg\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s ^YHR(\u0026#34;MI.MIFIT3000\u0026#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=\u0026#34;1\u0026#34; s epis=$p(epis,\u0026#34;_\u0026#34;,1) s ImageClass=\u0026#34;P\u0026#34;_+$p(ImageClass,\u0026#34;_\u0026#34;,2) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=\u0026#34;\u0026#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=\u0026#34;\u0026#34; f s RowID=$o(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=\u0026#34;\u0026#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i \u0026#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=\u0026#34;SerumQ\u0026#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= \u0026#34;-1^保存报告图片失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_\u0026#34;:\u0026#34;_ImageClass_\u0026#34;:\u0026#34;_FileName,\u0026#34;H\u0026lt;--M\u0026#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=\u0026#34;\u0026#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // w ##class(MI.MIFRS600).GetFtpMTHD(\u0026#34;24\u0026#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = \u0026#34;labno,labnoInfo,patInfo\u0026#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(\u0026#34;MI.MIFIT3000N1\u0026#34;,\u0026#34;QryLabInfo\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; s LabnoList=\u0026#34;\u0026#34; s VisitNumberDR=\u0026#34;\u0026#34; s OutPutNum=0 //*--------------------------------\u0026gt;*申请项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate)) q:(AddDate=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;6) d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime)) q:(AddTime=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;6) d ..s OutPutNum=OutPutNum+1 ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i \u0026#39;$l(EpisNo) q ..i \u0026#39;$l(labno) q ..i \u0026#39;$d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno)) q ..s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..s ReceiveTime=$lg($g(^dbo.RPVisitNumberD(VisitNumberDR)),67) ..i ((+$p($h,\u0026#34;,\u0026#34;,2))-ReceiveTime\u0026gt;=-2)\u0026amp;\u0026amp;((+$p($h,\u0026#34;,\u0026#34;,2))-ReceiveTime\u0026lt;5) d Trace^MI.MIF000(mi,labno_\u0026#34;标本接收时间低于5秒不上传\u0026#34;,\u0026#34;等待上传\u0026#34;) q ..//得到通道号 ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@C\u0026#34;\t//重新获取通道号 避免因为接收造成漏项目 ..;s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..;s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;|@U\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;申请上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;C@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** //*--------------------------------\u0026gt;*复查结果上传 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;|@U\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;复查上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;U@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** //*--------------------------------\u0026gt;*取消项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@R\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;取消上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;R@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=labno_\u0026#34;,\u0026#34;_\u0026#34;DM_OVER\u0026#34;_\u0026#34;@C\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;审核上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;T@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=\u0026#34;labno,labnoInfo,patInfo\u0026#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=\u0026#34;\u0026#34; { Set AtEnd=1 Set Row=\u0026#34;\u0026#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 获取申请名称和内容 /// 申请名称： /// 发送申请：order_2012051718302501_9999999901NW.HL7 /// 取消申请：order_2012051718302501_9999999901CA.HL7 /// 项目复查：order_2012051718302501_9999999901XO.HL7 /// w ##class(MI.MIFRS600).GetLisOrderMTHD(\u0026#34;8\u0026#34;,\u0026#34;POS@C@1\u0026#34;,\u0026#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08 -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34; ,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) /// w ##class(MI.MIFIT300N).GetLabnoInfoN(\u0026#34;34\u0026#34;,\u0026#34;1003779663,DM_OVER@C\u0026#34;,\u0026#34;2025-03-18□19:07:07,IT3000,,,,急诊内科,测试医生(勿选）,检验管理员,0000243381,陈耀明,1,急诊,,34,,1003779663,2025-03-18□18:24,,,,,眩晕,,,,2025-03-18□18:24,,,19900920\u0026#34;) ClassMethod GetLabnoInfoN(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s VT=\u0026#34;[11]\u0026#34;,FS=\u0026#34;[28]\u0026#34;,CR=\u0026#34;[13]\u0026#34; s labNo=$p(patInfo,\u0026#34;,\u0026#34;,16) s Sampleno=$p(patInfo,\u0026#34;,\u0026#34;,3) //i labNo=\u0026#34;74623177\u0026#34; s ^TMP(\u0026#34;zlzit3000d\u0026#34;)=$lb(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s location=$p(patInfo,\u0026#34;,\u0026#34;,6) s docName=$p(patInfo,\u0026#34;,\u0026#34;,7) s regNo=$p(patInfo,\u0026#34;,\u0026#34;,9) s patName=$p(patInfo,\u0026#34;,\u0026#34;,10) s sex=$p(patInfo,\u0026#34;,\u0026#34;,11) i sex=\u0026#34;1\u0026#34; s sex=\u0026#34;M\u0026#34; i sex=\u0026#34;2\u0026#34; s sex=\u0026#34;F\u0026#34; i (sex\u0026#39;=\u0026#34;M\u0026#34;)\u0026amp;\u0026amp;(sex\u0026#39;=\u0026#34;F\u0026#34;) s sex=\u0026#34;U\u0026#34; s birthDate=$p(patInfo,\u0026#34;,\u0026#34;,29) s collectTime=$p(patInfo,\u0026#34;,\u0026#34;,17) ;2017-08-14 11:57 s collectTime=$tr(collectTime,\u0026#34;- :\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;00\u0026#34; s status=$p(labnoInfo,\u0026#34;@\u0026#34;,2) s labnoInfo=$p(labnoInfo,\u0026#34;@\u0026#34;,1) s curTime=$zd($h,8)_$tr($zt($p($h,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;,\u0026#34;\u0026#34;) s PatType=$p(patInfo,\u0026#34;,\u0026#34;,12) s Wardno=$p(patInfo,\u0026#34;,\u0026#34;,27) s Diagnose=$p(patInfo,\u0026#34;,\u0026#34;,22) S patTypeFlag=\u0026#34;RO\u0026#34; //门诊=RO,住院=RI,体检=RC,急诊=RS I PatType=\u0026#34;住院\u0026#34; { S patTypeFlag=\u0026#34;RI\u0026#34; } I PatType=\u0026#34;门诊\u0026#34; { S patTypeFlag=\u0026#34;RO\u0026#34; } I PatType=\u0026#34;急诊\u0026#34; { S patTypeFlag=\u0026#34;RS\u0026#34; } I PatType=\u0026#34;体检\u0026#34; { S patTypeFlag=\u0026#34;RC\u0026#34; } I PatType=\u0026#34;干诊\u0026#34; { S patTypeFlag=\u0026#34;RC\u0026#34; } s AssayNo=..GetReportAssayNoMTHD(mi,labNo) s MSN=\u0026#34;MSH|^~\\\u0026amp;|DHC-LIS|IT3000|||||OML^O21|\u0026#34;_$tr($zdt($h,3),\u0026#34; \u0026#34;\u0026#34;:\u0026#34;\u0026#34;-\u0026#34;)_\u0026#34;SND\u0026#34;_labNo_\u0026#34;|P|2.3|||NE|NE||\u0026#34; s PID=\u0026#34;PID|1||\u0026#34;_regNo_\u0026#34;|\u0026#34;_docName_\u0026#34;|^\u0026#34;_patName_\u0026#34;||\u0026#34;_birthDate_\u0026#34;|\u0026#34;_sex //_location s PV1=\u0026#34;PV1|||?|||||||||||||||||\u0026#34; s DG1=\u0026#34;DG1|||00000^default|||F\u0026#34; ;s IN1=\u0026#34;IN1|||China-Bank\u0026#34; ;s ORC=\u0026#34;ORC|NW|\u0026#34;_labNo_\u0026#34;|\u0026#34;_regNo_\u0026#34;||||R||\u0026#34;_$zd($h,8)_$tr($zt($h),\u0026#34;:\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;|\u0026#34;_docName s orcF1=\u0026#34;NW\u0026#34;,orcF2=\u0026#34;\u0026#34; i status=\u0026#34;R\u0026#34; s orcF1=\u0026#34;CA\u0026#34; i status=\u0026#34;U\u0026#34; s orcF1=\u0026#34;XO\u0026#34; s orcF2=\u0026#34;SC\u0026#34; s ORC=\u0026#34;ORC|\u0026#34;_orcF1_\u0026#34;|\u0026#34;_labNo_\u0026#34;|\u0026#34;_AssayNo_\u0026#34;||\u0026#34;_orcF2_\u0026#34;||\u0026#34;_patTypeFlag_\u0026#34;|\u0026#34;_location_\u0026#34;|\u0026#34;_..GetReceiveDateTime(labNo) //change by sch20210421 //s:orcF1\u0026#39;=\u0026#34;XO\u0026#34; ORC=\u0026#34;ORC|\u0026#34;_orcF1_\u0026#34;|\u0026#34;_labNo_\u0026#34;|\u0026#34;_AssayNo_\u0026#34;||\u0026#34;_orcF2_\u0026#34;||\u0026#34;_patFLAG_\u0026#34;||\u0026#34;_$tr($zdt($h,3),\u0026#34; \u0026#34;\u0026#34;:\u0026#34;\u0026#34;-\u0026#34;) //_\u0026#34;|\u0026#34;_docName //\u0026#34;_regNo_\u0026#34; ;s NTE=\u0026#34; NTE||I|Code: C1 Comment: Sample comment 1|\u0026#34; s obrF1=\u0026#34;A\u0026#34; i status=\u0026#34;U\u0026#34; s obrF1=\u0026#34;G\u0026#34; //OBR||2012081501||ROCHE_AFP|||20120814160023|||9999|A s OBR=\u0026#34;OBR||\u0026#34;_labNo_\u0026#34;||GLU|||||||\u0026#34;_obrF1 //\u0026#34;_collectTime_\u0026#34; ;s OBX=\u0026#34;OBX|2|ST|AHBS^6012^||45.290^Instrument flag!|mol/L| - ^^||5221^1||F|||20170816152751|356^COBAS8000B:E602C2|DATOS_PRJ^16-8月 -17^^|\u0026#34; s OBRs=\u0026#34;\u0026#34; i $p(labnoInfo,\u0026#34;@\u0026#34;,1)=\u0026#34;POS\u0026#34; d .s OBRs=\u0026#34;OBR||\u0026#34;_labNo_\u0026#34;||POS|||\u0026#34;_collectTime_\u0026#34;||||\u0026#34;_obrF1 e d .d GetOBRs //s orderTxt=VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS s orderTxt=VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS q orderTxt GetOBRs s items=$tr($p(labnoInfo,\u0026#34;,\u0026#34;,2),\u0026#34;|\u0026#34;,\u0026#34;\u0026#34;) f i=1:1:$l(items,\u0026#34;+\u0026#34;) d .s item=$p(items,\u0026#34;+\u0026#34;,i) .s splitStr=$p(OBR,\u0026#34;|\u0026#34;,5) .s curOBR=$p(OBR,splitStr,1)_item_$p(OBR,splitStr,2) .s OBRs=OBRs_curOBR_CR q } // w ##Class(MI.MIFIT3000).GetReportAssayNoMTHD(8,\u0026#34;1905074122\u0026#34;) ClassMethod GetReportAssayNoMTHD(mi, labno, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { S mi= $G(mi) S labno= $G(labno) i \u0026#39;$l(labno) q \u0026#34;\u0026#34; i \u0026#39;$l(mi) q \u0026#34;\u0026#34; s (orderno,VisitNumberDR)=\u0026#34;\u0026#34; s labno=\u0026#34;\u0026#34;_labno s WGMDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i \u0026#39;$l(WGMDR) q \u0026#34;\u0026#34; S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) s orderno=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WGMDR,\u0026#34;\u0026#34;)) i \u0026#39;$l(orderno) q \u0026#34;\u0026#34; s reportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WGMDR,orderno,\u0026#34;\u0026#34;)) s AssayNo =$lg($g(^dbo.RPVisitNumberReportD(reportDR)),8) Q AssayNo } /// W ##class(MI.MIFIT300N).GetReceiveDateTime(\u0026#34;1003775372\u0026#34;) ClassMethod GetReceiveDateTime(Labnum) { q:\u0026#39;$l(Labnum) \u0026#34;\u0026#34; s VisitnumberDR=\u0026#34;\u0026#34;,ReceiveDate=\u0026#34;\u0026#34;,ReceiveTime=\u0026#34;\u0026#34;,ReceiveDateTime=\u0026#34;\u0026#34; s VisitnumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,\u0026#34;\u0026#34;_Labnum,\u0026#34;\u0026#34;)) s:$l(VisitnumberDR) ReceiveDate=$lg(^dbo.RPVisitNumberD(VisitnumberDR),66) s:$l(VisitnumberDR) ReceiveTime=$lg(^dbo.RPVisitNumberD(VisitnumberDR),67) s:$l(ReceiveDate)\u0026amp;$l(ReceiveTime) ReceiveDateTime=ReceiveDate_$tr($zt(ReceiveTime),\u0026#34;:\u0026#34;) q ReceiveDateTime } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) /// w ##Class(MI.MIFIT3000N1).GetLabnoInfo(34,\u0026#34;8000001003\u0026#34;) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=\u0026#34;\u0026#34; s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno,chl)) q:chl=\u0026#34;\u0026#34; d .s tcx=tcx_chl_\u0026#34;+\u0026#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,mi,labno) i $l(tcx) s tcx=labno_\u0026#34;,\u0026#34;_tcx_\u0026#34;|\u0026#34; d Trace^MI.MIF000(mi,tcx,\u0026#34;H--\u0026gt;M\u0026#34;) d Trace^MI.MIF000(56,\u0026#34;共\u0026#34;_$l(tcx,\u0026#34;+\u0026#34;)_\u0026#34;个项目。\u0026#34;_tcx,\u0026#34;H--\u0026gt;M\u0026#34;) //YHR 20230816 将上传信息存入罗氏infinity仪器 q tcx } /// w ##Class(MI.MIFRS600).GetPatInfo(57,9000001912) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q \u0026#34;\u0026#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) i \u0026#39;$l(VisitNumberDR) q \u0026#34;\u0026#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=\u0026#34;\u0026#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=\u0026#34;\u0026#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=\u0026#34;\u0026#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=\u0026#34;\u0026#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=\u0026#34;\u0026#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=\u0026#34;\u0026#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,\u0026#34;,\u0026#34;,1),3)_\u0026#34; \u0026#34;_$zt($p($h,\u0026#34;,\u0026#34;,2)) s Instrument = \u0026#34;XN\u0026#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) i $l(Instrument) s Instrument=$tr(Instrument,\u0026#34;,\u0026#34;,\u0026#34;^\u0026#34;) s Sampleno=$lg(RPVisitNumberData,6) //病案号 s Sampletype=\u0026#34;\u0026#34; s Feetype=\u0026#34;\u0026#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 \u0026#34;\u0026#34; s BarCode=\u0026#34;\u0026#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=\u0026#34;男\u0026#34; s Sex=\u0026#34;1\u0026#34; ;1:男 ，2 女 i Species =\u0026#34;女\u0026#34; s Sex=\u0026#34;2\u0026#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=\u0026#34;\u0026#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=\u0026#34;\u0026#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_\u0026#34;-\u0026#34;_$e(ReceiveDate,5,6)_\u0026#34;-\u0026#34;_$e(ReceiveDate,7,8)_\u0026#34; \u0026#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=\u0026#34;\u0026#34; ;报告日期 = 初审(保存结果)时间 s Printflag=\u0026#34;\u0026#34; ;打印标志 s Resultflag=\u0026#34;\u0026#34; ;结果标志 s Errflag=\u0026#34;\u0026#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=\u0026#34;\u0026#34; ;备注 s Reserve=\u0026#34;\u0026#34; ;保留字段 s Patnamn=\u0026#34;\u0026#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_\u0026#34;-\u0026#34;_$e(CollectDate,5,6)_\u0026#34;-\u0026#34;_$e(CollectDate,7,8)_\u0026#34; \u0026#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=\u0026#34;\u0026#34; s WardnoDR=$lg(RPVisitNumberData,26) ;病区 i $l(WardnoDR) s Wardno=$lg($g(^dbo.BTWardD(WardnoDR)),3) s RetString=\u0026#34;\u0026#34; s RetString=$tr(Sampleda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Instrument,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sampleno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sampletype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Feetype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Srcdepno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Srcdocno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Userno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Patno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Patna,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Sex,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Pattype,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Bedno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Patage,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Ageunit,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reqno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reqda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Reportda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Printflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Resultflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Errflag,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Diagnose,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Description,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Reserve,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34; s RetString=RetString_$tr(Patnamn,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Getda,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(Wardno,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(BarCode,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;)_\u0026#34;,\u0026#34;_$tr(BirthDate,\u0026#34;,\u0026#34;,\u0026#34;\u0026#34;) q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,\u0026#34;S\u0026#34;,filename) q } /********************************************自动核收开始****************************************************/ /// 仪器主键，条码号，前处理标本分区标识，仪器信息(位置) /// w ##class(MI.MIFIT3000N1).ZDHS(\u0026#34;34\u0026#34;,\u0026#34;8000000352\u0026#34;,\u0026#34;WANTAI\u0026#34;) /// w ##class(MI.MIFIT300N).ZDHS(\u0026#34;34\u0026#34;,\u0026#34;1003779663\u0026#34;,\u0026#34;RSA1\u0026#34;) ClassMethod ZDHS(mi, Labno, MachineCode, positioninfo) { s mi=$g(mi),Labno=$g(Labno),machCode=$g(MachineCode),positioninfo=$g(positioninfo) i \u0026#39;$l(Labno) q \u0026#34;\u0026#34; /*----------\u0026gt;判断该标本是否已接收未核收 开始\u0026lt;----------*/ s QuitFlag=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##class(LIS.Util.Common).IndexData(Labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) s QuitFlag=1 i QuitFlag=1 q \u0026#34;\u0026#34; /*----------\u0026gt;判断该标本是否已接收未核收 结束\u0026lt;----------*/ s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)\t//得到当前仪器关联工作小组信息 s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13)\t//得到仪器工作小组的核收类型 //AcceptFlag为1认为是前处理工作小组，如果是前处理小组，就认为上前处理\t本接口未设置前处理工作小组，未对此流程进行测试 i AcceptFlag=\u0026#34;1\u0026#34; d QCLZDHS e d ZDHS q \u0026#34;\u0026#34; ZDHS d Trace^MI.MIF000(mi,\u0026#34;上仪器,标本号:\u0026#34;_Labno_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,分区位置:\u0026#34;_MachineCode_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;自动核收\u0026#34;) //根据前处理标本分区进行分区自动核收，并且根据分区代码是否核收进行区分 //本接口认为 默认认为罗氏流水线核收，如果分区代码中包含 【BHS】则认为标本不核收，此块代码将仪器传过来的分区代码进行归类 //本接口关联标本分区， WANTAI 万泰--\u0026gt;W，XINCHANYE 新产业--\u0026gt;X，LINJIAN 临检凝血--\u0026gt;L，XIEGUANG 携光--\u0026gt;R，罗氏--\u0026gt;Y，不核收--\u0026gt;N s HsFlag=\u0026#34;Y\u0026#34;,WorkGroupMachineDR=\u0026#34;\u0026#34; i (MachineCode[\u0026#34;WANTAI\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;WANTAI\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;W\u0026#34; .s WorkGroupMachineDR=48\t//未核收且分区是WANTAI i (MachineCode[\u0026#34;XINCHANYE\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;XINCHANYE\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;X\u0026#34; .s WorkGroupMachineDR=50\t//未核收且分区是XINCHANYE i (MachineCode[\u0026#34;LINJIAN\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;LINJIAN\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;L\u0026#34; .s WorkGroupMachineDR=9\t//未核收且分区是LINJIAN i (MachineCode[\u0026#34;XIEGUANG\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;XIEGUANG\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;R\u0026#34; .s WorkGroupMachineDR=67\t//未核收且分区是XIEGUANG i (MachineCode[\u0026#34;BHS_\u0026#34;) d\t;BHS_WANTAI .S MachineCode=$REPLACE(MachineCode,\u0026#34;BHS_\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;N\u0026#34; i MachineCode=\u0026#34;C_C8K886\u0026#34; s MachineCode=\u0026#34;C801\u0026#34; i MachineCode=\u0026#34;C_C8K77\u0026#34; s MachineCode=\u0026#34;C701\u0026#34; i MachineCode=\u0026#34;C8K886\u0026#34; s MachineCode=\u0026#34;C801\u0026#34; i MachineCode=\u0026#34;C8K77\u0026#34; s MachineCode=\u0026#34;C701\u0026#34; i HsFlag=\u0026#34;Y\u0026#34; d .s WorkGroupMachineDR=41\t//未核收且分区不包含BHS_\t默认核收到罗氏流水线 i \u0026#39;$l(WorkGroupMachineDR) q s ret=..ReceiveLabNoByWGM(WorkGroupMachineDR,Labno,$zd(+$h,8)) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) i ret\u0026#39;=\u0026#34;1\u0026#34; d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR\t//自动核收出错显示再对应的工作组 .s SendRet=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收失败\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_Labno_\u0026#34;前处理核收失败:\u0026#34;_ret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) j ..SaveRecord(Labno,\u0026#34;自动核收:\u0026#34;_ret,\u0026#34;\u0026#34;,\u0026#34;14\u0026#34;,WorkGroupMachineDR) q ret QCLZDHS d Trace^MI.MIF000(mi,\u0026#34;上前处理，鉴定号:\u0026#34;_Labno_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;DealInfo\u0026#34;) d Trace^MI.MIF000(mi,\u0026#34;执行核收到前处理\u0026#34;,\u0026#34;DealInfo\u0026#34;) //此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,Labno,\u0026#34;\u0026#34;) d Trace^MI.MIF000(mi,Labno_\u0026#34;核收到前处理返回信息:\u0026#34;_dealret,\u0026#34;DealInfo\u0026#34;) //记录位置信息到报告位置号 d ..SaveRackNo(Labno,positioninfo,mi) i dealret[\u0026#34;标本已核收\u0026#34; q i dealret=\u0026#34;1\u0026#34; d .//写标本操作日志 .d ..SaveRecord(Labno,machCode,mi,\u0026#34;5\u0026#34;) e d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_CurWorkGroupDR .s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收失败\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_Labno_\u0026#34;前处理核收失败:\u0026#34;_dealret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) .//写标本操作日志 .d ..SaveRecord(Labno,dealret,mi,\u0026#34;100\u0026#34;) q } /// Others w ##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(\u0026#34;3\u0026#34;,\u0026#34;1000004476\u0026#34;,\u0026#34;20191105\u0026#34;) /// 按工作小组核收医嘱 /// INPUT: MachID:仪器主键，LabNo：条码号，TransmitDate：上机日期（不传默认当天） /// OutPut: RetValue:1成功 ClassMethod ReceiveLabNoByWGM(WorkGroupMachineDR As %String, LabNo As %String, TransmitDate, RackNo, RuleCode) As %String { s WorkGroupMachineDR=$g(WorkGroupMachineDR) s LabNo=$g(LabNo) s TransmitDate=$g(TransmitDate) s RuleCode=$g(RuleCode) s RackNo=$g(RackNo) s NowDate=$zd($h,8) s RetValue=1 i \u0026#39;$l(TransmitDate) s TransmitDate=NowDate i \u0026#39;$l(WorkGroupMachineDR) q 100 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s WorkGroupMachineName=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) s DepartmentDR=$lg(^dbo.BTWorkGroupD(WorkGroupDR),4) s HospitalDR=$lg(^dbo.BTDepartmentD(DepartmentDR),4) s WorkGroupMachineDesc=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s IndexOperateType=##class(LIS.Util.Common).IndexData(\u0026#34;H\u0026#34;) s AutoDR=$O(^dbo.RPWGMachineAutoI(\u0026#34;IndexOperateType\u0026#34;,IndexOperateType,WorkGroupMachineDR,\u0026#34;\u0026#34;)) i \u0026#39;$l(AutoDR) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未设置自动核收\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未设置自动核收！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未设置自动核收！\u0026#34; } s MachineAutoData=$g(^dbo.RPWGMachineAutoD(AutoDR)) s IsOpen=$LG(MachineAutoData,4) i IsOpen\u0026#39;=1 { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未开启自动核收\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未开启自动核收！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未开启自动核收！\u0026#34; } s CurrentDate = $p($h,\u0026#34;,\u0026#34;,1) s Currenttime = $p($h,\u0026#34;,\u0026#34;,2) //开始时间 s StartDate=$lg(MachineAutoData,5) i $l(StartDate) s StartDate= $zdh(StartDate,8) s StartTime=$lg(MachineAutoData,6) //结束时间 s EndDate=$lg(MachineAutoData,7) i $l(EndDate) s EndDate= $zdh(EndDate,8) s EndTime=$lg(MachineAutoData,8) //时间类型 s TimeType=$lg(MachineAutoData,9) i TimeType=\u0026#34;CT\u0026#34; //连续 { i (CurrentDate\u0026lt;StartDate)||(($l(StartTime))\u0026amp;\u0026amp;(CurrentDate=StartDate)\u0026amp;\u0026amp;(Currenttime\u0026lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期未生效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期未生效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期未生效！\u0026#34; } i (CurrentDate\u0026gt;EndDate)||(($l(EndTime))\u0026amp;\u0026amp;(CurrentDate=EndDate)\u0026amp;\u0026amp;(Currenttime\u0026gt;EndTime) ) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期已失效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期已失效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期已失效！\u0026#34; } } i TimeType=\u0026#34;TS\u0026#34; //时间段 { i (CurrentDate\u0026lt;StartDate)||(($l(StartTime))\u0026amp;\u0026amp;(Currenttime\u0026lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期未生效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期未生效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期未生效！\u0026#34; } i (CurrentDate\u0026gt;EndDate)||(($l(EndTime))\u0026amp;\u0026amp;(Currenttime\u0026gt;EndTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期已失效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期已失效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期已失效！\u0026#34; } } s AcceptUserDR=\u0026#34;\u0026#34; i $l(AutoDR) s AcceptUserDR=$LG($g(^dbo.RPWGMachineAutoD(AutoDR)),10) i \u0026#39;$l(AcceptUserDR) d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR .s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未设置负责人\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未设置核收负责人！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) i \u0026#39;$l(AcceptUserDR) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未设置核收负责人！\u0026#34; s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///判断医嘱是否核收 S AcceptFlag=0 s IsSpecialFlag=0 s CheckItemList=\u0026#34;\u0026#34; s PreReportDR=\u0026#34;\u0026#34; k TestSetList s LabNoType=##Class(LISSP.DHCRPVisitNumber).GetLabNoType(LabNo) s WebNamespace=##Class(OTH.SYSParameter).GetWebNamespace() i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo))){ s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo),\u0026#34;\u0026#34;)) S TestSetDR=\u0026#34;\u0026#34; f { s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR,\u0026#34;\u0026#34;)) i $l(RowID){ s TestSetGroup=\u0026#34;Default\u0026#34; //工作小组下分组类型 s WGMDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),5) i \u0026#39;$l(WGMDR) s CheckItemList=TestSetDR_CheckItemList S AccpetReportDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11) I $L(AccpetReportDR) s AccpetWGMDR=$LG($G(^dbo.RPVisitNumberReportD(AccpetReportDR)),4) I $LG($g(^dbo.BTWorkGroupMachineD(AccpetWGMDR)),13)\u0026#39;=1 continue s AcceptFlag=0 I $L(WGMDR) S AcceptFlag=$LG($g(^dbo.BTWorkGroupMachineD(WGMDR)),13) //是否是前处理小组 I AcceptFlag=1 S PreReportDR= $LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11),IsSpecialFlag=1 I AcceptFlag=1,$D(^dbo.BTTestSetWorkGroupMachineI(\u0026#34;IndexMaster\u0026#34;,TestSetDR,WorkGroupMachineDR)) { //处理报告分组信息 i $d(^dbo.BTWorkGroupMachineRuleTSI(\u0026#34;IndexTestSet\u0026#34;,TestSetDR)) { s WorkGroupMachineRuleDR=\u0026#34;\u0026#34; f{ s WorkGroupMachineRuleDR=$o(^dbo.BTWorkGroupMachineRuleTSI(\u0026#34;IndexTestSet\u0026#34;,TestSetDR,WorkGroupMachineRuleDR)) q:WorkGroupMachineRuleDR=\u0026#34;\u0026#34; s GroupWGMDR=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),4) s IsShow=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),5) i WorkGroupMachineDR\u0026#39;=GroupWGMDR continue i IsShow=\u0026#34;1\u0026#34; continue s TestSetGroup=WorkGroupMachineRuleDR } } s TestSetList(TestSetGroup,TestSetDR)=\u0026#34;\u0026#34; } } } } s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo),\u0026#34;\u0026#34;)) //前处理标本核收 i IsSpecialFlag=1 { I \u0026#39;$D(TestSetList) s RetValue=\u0026#34;-1^无可核收医嘱\u0026#34; q RetValue s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) Set $ZTrap = \u0026#34;ErrorHandle\u0026#34; TSTART s MajorConclusion=\u0026#34;\u0026#34;,OldEpi=\u0026#34;\u0026#34;,MiniConclusion=\u0026#34;\u0026#34; i $l(PreReportDR) s MajorConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),40),MiniConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),41),OldEpi=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),8) s maxEpis=OldEpi s TestSetGroup=\u0026#34;\u0026#34; f{ s TestSetGroup=$o(TestSetList(TestSetGroup)) q:TestSetGroup=\u0026#34;\u0026#34; s objVisitNumberReport=##class(dbo.RPVisitNumberReport).%New() s objVisitNumberReport.VisitNumberDR=VisitNumberDR s objVisitNumberReport.TransmitDate=TransmitDate s objVisitNumberReport.WorkGroupMachineDR=WorkGroupMachineDR S objVisitNumberReport.MajorConclusion=MajorConclusion s objVisitNumberReport.MinorConclusion=MiniConclusion S OrderNo=1 if $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,\u0026#34;1\u0026#34;)) { s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,\u0026#34;\u0026#34;),-1) s OrderNo=(OrderNo +1) } s AssayNo=\u0026#34;\u0026#34; s objVisitNumberReport.OrderNo=OrderNo i ((CommDirection=\u0026#34;UP\u0026#34;)||(CommDirection=\u0026#34;BI\u0026#34;)) s AssayNo=LabNo i \u0026#39;$l(AssayNo) s AssayNo=maxEpis s objVisitNumberReport.AccessionNo=\u0026#34;\u0026#34; ///细菌分离号 s objVisitNumberReport.AssayNo=AssayNo s objVisitNumberReport.EpisodeNo=maxEpis i $l(maxEpis) s ^DHCLABWGMEPSIDERECORD(\u0026#34;WGM\u0026#34;,WorkGroupMachineDR,TransmitDate,maxEpis)=\u0026#34;\u0026#34; s objVisitNumberReport.AcceptDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s objVisitNumberReport.AcceptTime=$p($h,\u0026#34;,\u0026#34;,2) s objVisitNumberReport.AcceptUserDR=AcceptUserDR i $l(RackNo) s objVisitNumberReport.RackNo=RackNo s objVisitNumberReport.Status=1 //报告状态(1登记，2初审，3审核，4复查，5取消审核，6作废，O其他) s ret=objVisitNumberReport.%Save() If ($SYSTEM.Status.IsOK(ret)) {s RetValue=1 } Else {s err=\u0026#34;报告生成失败:\u0026#34;_$SYSTEM.Status.GetErrorText(ret) s RetValue=\u0026#34;-1^\u0026#34;_err q } I \u0026#39;$D(TestSetList(TestSetGroup)) s RetValue=\u0026#34;-1^无可核收医嘱\u0026#34; q s TestSetDR=\u0026#34;\u0026#34; F { s TestSetDR=$o(TestSetList(TestSetGroup,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR,\u0026#34;\u0026#34;)) i $l(RowID){ //修改标本医嘱核收工作小组 s objTestSets=##class(dbo.RPVisitNumberTestSet).%OpenId(RowID) s objTestSets.VisitNumberReportDR=objVisitNumberReport.RowID s objTestSets.WorkGroupMachineDR=WorkGroupMachineDR s sc=objTestSets.%Save() If (\u0026#39;$SYSTEM.Status.IsOK(sc)) { s RetValue=$SYSTEM.Status.GetErrorText(sc) Quit } //按医嘱生成报告项目结果 s RetValue=##Class(LISSP.DHCRPVisitNumberReport).SaveReportTestCode(objVisitNumberReport.RowID,TestSetDR) i RetValue\u0026#39;=1 q } } } i RetValue\u0026#39;=1 TROLLBACK Quit RetValue //删除前处理报告 i $l(PreReportDR),\u0026#39;$d(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,PreReportDR)){ s sc=##class(dbo.RPVisitNumberReport).%DeleteId(PreReportDR) If (\u0026#39;$SYSTEM.Status.IsOK(sc)){s RetValue=\u0026#34;删除报告信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc) } } i RetValue\u0026#39;=1 TROLLBACK Quit RetValue TCOMMIT i $l(WorkGroupMachineDR),$l(maxEpis) s ret=##Class(HIS.DHCCommon).SaveWorkGroupMachineEpis(WorkGroupMachineDR,TransmitDate,maxEpis,\u0026#34;\u0026#34;) } else { //普通标本核收 s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) s Flag=1\t//YHR 20250319 仪器自动核收标志，为1的话，不影响工作小组手动核收序号 s Param=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P0\u0026gt;H\u0026lt;/P0\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P1\u0026gt;\u0026#34;_LabNo_\u0026#34;\u0026lt;/P1\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P3\u0026gt;\u0026#34;_maxEpis_\u0026#34;\u0026lt;/P3\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P4\u0026gt;\u0026#34;_AcceptUserDR_\u0026#34;\u0026lt;/P4\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P8\u0026gt;\u0026#34;_WorkGroupMachineDR_\u0026#34;\u0026lt;/P8\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P12\u0026gt;\u0026#34;_RackNo_\u0026#34;\u0026lt;/P12\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P14\u0026gt;@@1@@\u0026#34;_Flag_\u0026#34;\u0026lt;/P14\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s Sessions=AcceptUserDR_\u0026#34;^\u0026#34;_WorkGroupDR_\u0026#34;^^^\u0026#34;_HospitalDR b ;a KSZDHS s ret=##Class(LISSP.DHCRPVisitNumber).ReceiveVisitNumber(LabNo,Param,Sessions) i $p(ret,\u0026#34;^\u0026#34;,1)\u0026#39;=\u0026#34;1\u0026#34; s RetValue=ret } q RetValue ErrorHandle TROLLBACK s RetValue=\u0026#34;-1^错误\u0026#34;_$tr($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE Quit RetValue } /// Creator： YHR /// CreatDate： 20250320 /// Description： 通过编号规则获取工作小组最大流水号 /// Table： dbo.RPVisitNumberReport /// Input： 工作小组，日期(只能获取当天的，编号规则隔天后会刷新) /// Output： 无 /// Return： 失败:\u0026#34;\u0026#34; 成功:流水号 /// Others\t【原】w ##Class(LIS.Common.DHCVisitNumber).GetMaxMiEpisodeNo(\u0026#34;41\u0026#34;,\u0026#34;20250319\u0026#34;) /// k ^TMP(\u0026#34;MI.MIFIT3000N1.1\u0026#34;,\u0026#34;WGMEpis\u0026#34;,\u0026#34;41\u0026#34;) /// w ##Class(MI.MIFIT3000N1).GetMaxMiEpisodeNo(\u0026#34;41\u0026#34;,\u0026#34;20250319\u0026#34;) ClassMethod GetMaxMiEpisodeNo(WorkGroupMachineDR As %String, TransmitDate As %String) As %String { S TransmitDate=$g(TransmitDate) S WorkGroupMachineDR=$G(WorkGroupMachineDR) S RetValue=\u0026#34;\u0026#34; i \u0026#39;$l(WorkGroupMachineDR) q RetValue i \u0026#39;$l(TransmitDate) s TransmitDate=$zd($h,8) s TransmitDate=$tr(TransmitDate,\u0026#34;-\u0026#34;) //记录该工作小组当天最大的流水号，如果有记录，则优先判断是否核收成功，如果未核收成功仍旧使用该号码 i $d(^TMP($zn,\u0026#34;WGMEpis\u0026#34;,WorkGroupMachineDR,TransmitDate)) d .s JLEpis=$g(^TMP($zn,\u0026#34;WGMEpis\u0026#34;,WorkGroupMachineDR,TransmitDate)) .i \u0026#39;$l(JLEpis) q .i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,JLEpis,TransmitDate)) d ..s RetValue=JLEpis i $l(RetValue) q RetValue //通过编号规则获取当天流水号，编号规则代码设置为工作小组同样代码，通过代码获取工作小组对应的编号规则 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) //YHR 20230810 罗氏流水线规则 i $l(ZDHSEpis) d .i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ..s RetValue=ZDHSEpis .e d ..f Num=1:1:1000 d\t//避免死循环，每次进行一千次增号判断 ...s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) ...i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ....s RetValue=ZDHSEpis ....s Num=1001 i $l(RetValue) s ^TMP($zn,\u0026#34;WGMEpis\u0026#34;,WorkGroupMachineDR,TransmitDate)=RetValue q RetValue //未查询到编号规则，则获取当前工作小组最大流水号 s Parameter=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P0\u0026gt;\u0026#34;_TransmitDate_\u0026#34;\u0026lt;/P0\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s WGMEpisNo=##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(WorkGroupMachineDR,Parameter) //YHR 20250317 获取最大流水号报错问题处理 i $l(WGMEpisNo) s RetValue=WGMEpisNo q RetValue } /********************************************自动核收结束****************************************************/ } 个性化功能记录 本节点无特殊功能，可直接在其他接口使用类似功能。\n自动核收功能 将自动核收单独出来。标准版方法为（##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM），标板使用的功能，是通过仪器对应的工作小组进行核收，流水线仪器为了方便维护以及后续的拓展。此处将仪器主键入参改为了工作小组主键入参。\n修改获取流水号逻辑。标本从仪器开始流水号那里获取，如果多个仪器就会造成维护多个不用的仪器。基于标准版有编号规则维护功能，在此基础上，将获取流水号的逻辑放在了这里。具体方法参考 通过编号规则获取自动核收对应的流水号。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 /// Others w ##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(\u0026#34;3\u0026#34;,\u0026#34;1000004476\u0026#34;,\u0026#34;20191105\u0026#34;) /// 按工作小组核收医嘱 /// INPUT: MachID:仪器主键，LabNo：条码号，TransmitDate：上机日期（不传默认当天） /// OutPut: RetValue:1成功 ClassMethod ReceiveLabNoByWGM(WorkGroupMachineDR As %String, LabNo As %String, TransmitDate, RackNo, RuleCode) As %String { s WorkGroupMachineDR=$g(WorkGroupMachineDR) s LabNo=$g(LabNo) s TransmitDate=$g(TransmitDate) s RuleCode=$g(RuleCode) s RackNo=$g(RackNo) s NowDate=$zd($h,8) s RetValue=1 i \u0026#39;$l(TransmitDate) s TransmitDate=NowDate i \u0026#39;$l(WorkGroupMachineDR) q 100 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s WorkGroupMachineName=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) s DepartmentDR=$lg(^dbo.BTWorkGroupD(WorkGroupDR),4) s HospitalDR=$lg(^dbo.BTDepartmentD(DepartmentDR),4) s WorkGroupMachineDesc=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s IndexOperateType=##class(LIS.Util.Common).IndexData(\u0026#34;H\u0026#34;) s AutoDR=$O(^dbo.RPWGMachineAutoI(\u0026#34;IndexOperateType\u0026#34;,IndexOperateType,WorkGroupMachineDR,\u0026#34;\u0026#34;)) i \u0026#39;$l(AutoDR) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未设置自动核收\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未设置自动核收！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未设置自动核收！\u0026#34; } s MachineAutoData=$g(^dbo.RPWGMachineAutoD(AutoDR)) s IsOpen=$LG(MachineAutoData,4) i IsOpen\u0026#39;=1 { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未开启自动核收\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未开启自动核收！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未开启自动核收！\u0026#34; } s CurrentDate = $p($h,\u0026#34;,\u0026#34;,1) s Currenttime = $p($h,\u0026#34;,\u0026#34;,2) //开始时间 s StartDate=$lg(MachineAutoData,5) i $l(StartDate) s StartDate= $zdh(StartDate,8) s StartTime=$lg(MachineAutoData,6) //结束时间 s EndDate=$lg(MachineAutoData,7) i $l(EndDate) s EndDate= $zdh(EndDate,8) s EndTime=$lg(MachineAutoData,8) //时间类型 s TimeType=$lg(MachineAutoData,9) i TimeType=\u0026#34;CT\u0026#34; //连续 { i (CurrentDate\u0026lt;StartDate)||(($l(StartTime))\u0026amp;\u0026amp;(CurrentDate=StartDate)\u0026amp;\u0026amp;(Currenttime\u0026lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期未生效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期未生效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期未生效！\u0026#34; } i (CurrentDate\u0026gt;EndDate)||(($l(EndTime))\u0026amp;\u0026amp;(CurrentDate=EndDate)\u0026amp;\u0026amp;(Currenttime\u0026gt;EndTime) ) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期已失效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期已失效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期已失效！\u0026#34; } } i TimeType=\u0026#34;TS\u0026#34; //时间段 { i (CurrentDate\u0026lt;StartDate)||(($l(StartTime))\u0026amp;\u0026amp;(Currenttime\u0026lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期未生效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期未生效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期未生效！\u0026#34; } i (CurrentDate\u0026gt;EndDate)||(($l(EndTime))\u0026amp;\u0026amp;(Currenttime\u0026gt;EndTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收日期已失效\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】自动核收日期已失效！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】自动核收日期已失效！\u0026#34; } } s AcceptUserDR=\u0026#34;\u0026#34; i $l(AutoDR) s AcceptUserDR=$LG($g(^dbo.RPWGMachineAutoD(AutoDR)),10) i \u0026#39;$l(AcceptUserDR) d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR .s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;未设置负责人\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_\u0026#34;工作小组【\u0026#34;_WorkGroupMachineName_\u0026#34;】未设置核收负责人！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) i \u0026#39;$l(AcceptUserDR) q \u0026#34;-1^该工作小组【\u0026#34;_WorkGroupMachineDesc_\u0026#34;】未设置核收负责人！\u0026#34; s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///判断医嘱是否核收 S AcceptFlag=0 s IsSpecialFlag=0 s CheckItemList=\u0026#34;\u0026#34; s PreReportDR=\u0026#34;\u0026#34; k TestSetList s LabNoType=##Class(LISSP.DHCRPVisitNumber).GetLabNoType(LabNo) s WebNamespace=##Class(OTH.SYSParameter).GetWebNamespace() i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo))){ s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo),\u0026#34;\u0026#34;)) S TestSetDR=\u0026#34;\u0026#34; f { s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR,\u0026#34;\u0026#34;)) i $l(RowID){ s TestSetGroup=\u0026#34;Default\u0026#34; //工作小组下分组类型 s WGMDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),5) i \u0026#39;$l(WGMDR) s CheckItemList=TestSetDR_CheckItemList S AccpetReportDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11) I $L(AccpetReportDR) s AccpetWGMDR=$LG($G(^dbo.RPVisitNumberReportD(AccpetReportDR)),4) I $LG($g(^dbo.BTWorkGroupMachineD(AccpetWGMDR)),13)\u0026#39;=1 continue s AcceptFlag=0 I $L(WGMDR) S AcceptFlag=$LG($g(^dbo.BTWorkGroupMachineD(WGMDR)),13) //是否是前处理小组 I AcceptFlag=1 S PreReportDR= $LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11),IsSpecialFlag=1 I AcceptFlag=1,$D(^dbo.BTTestSetWorkGroupMachineI(\u0026#34;IndexMaster\u0026#34;,TestSetDR,WorkGroupMachineDR)) { //处理报告分组信息 i $d(^dbo.BTWorkGroupMachineRuleTSI(\u0026#34;IndexTestSet\u0026#34;,TestSetDR)) { s WorkGroupMachineRuleDR=\u0026#34;\u0026#34; f{ s WorkGroupMachineRuleDR=$o(^dbo.BTWorkGroupMachineRuleTSI(\u0026#34;IndexTestSet\u0026#34;,TestSetDR,WorkGroupMachineRuleDR)) q:WorkGroupMachineRuleDR=\u0026#34;\u0026#34; s GroupWGMDR=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),4) s IsShow=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),5) i WorkGroupMachineDR\u0026#39;=GroupWGMDR continue i IsShow=\u0026#34;1\u0026#34; continue s TestSetGroup=WorkGroupMachineRuleDR } } s TestSetList(TestSetGroup,TestSetDR)=\u0026#34;\u0026#34; } } } } s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(LabNo),\u0026#34;\u0026#34;)) //前处理标本核收 i IsSpecialFlag=1 { I \u0026#39;$D(TestSetList) s RetValue=\u0026#34;-1^无可核收医嘱\u0026#34; q RetValue s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) Set $ZTrap = \u0026#34;ErrorHandle\u0026#34; TSTART s MajorConclusion=\u0026#34;\u0026#34;,OldEpi=\u0026#34;\u0026#34;,MiniConclusion=\u0026#34;\u0026#34; i $l(PreReportDR) s MajorConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),40),MiniConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),41),OldEpi=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),8) s maxEpis=OldEpi s TestSetGroup=\u0026#34;\u0026#34; f{ s TestSetGroup=$o(TestSetList(TestSetGroup)) q:TestSetGroup=\u0026#34;\u0026#34; s objVisitNumberReport=##class(dbo.RPVisitNumberReport).%New() s objVisitNumberReport.VisitNumberDR=VisitNumberDR s objVisitNumberReport.TransmitDate=TransmitDate s objVisitNumberReport.WorkGroupMachineDR=WorkGroupMachineDR S objVisitNumberReport.MajorConclusion=MajorConclusion s objVisitNumberReport.MinorConclusion=MiniConclusion S OrderNo=1 if $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,\u0026#34;1\u0026#34;)) { s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,\u0026#34;\u0026#34;),-1) s OrderNo=(OrderNo +1) } s AssayNo=\u0026#34;\u0026#34; s objVisitNumberReport.OrderNo=OrderNo i ((CommDirection=\u0026#34;UP\u0026#34;)||(CommDirection=\u0026#34;BI\u0026#34;)) s AssayNo=LabNo i \u0026#39;$l(AssayNo) s AssayNo=maxEpis s objVisitNumberReport.AccessionNo=\u0026#34;\u0026#34; ///细菌分离号 s objVisitNumberReport.AssayNo=AssayNo s objVisitNumberReport.EpisodeNo=maxEpis i $l(maxEpis) s ^DHCLABWGMEPSIDERECORD(\u0026#34;WGM\u0026#34;,WorkGroupMachineDR,TransmitDate,maxEpis)=\u0026#34;\u0026#34; s objVisitNumberReport.AcceptDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) s objVisitNumberReport.AcceptTime=$p($h,\u0026#34;,\u0026#34;,2) s objVisitNumberReport.AcceptUserDR=AcceptUserDR i $l(RackNo) s objVisitNumberReport.RackNo=RackNo s objVisitNumberReport.Status=1 //报告状态(1登记，2初审，3审核，4复查，5取消审核，6作废，O其他) s ret=objVisitNumberReport.%Save() If ($SYSTEM.Status.IsOK(ret)) {s RetValue=1 } Else {s err=\u0026#34;报告生成失败:\u0026#34;_$SYSTEM.Status.GetErrorText(ret) s RetValue=\u0026#34;-1^\u0026#34;_err q } I \u0026#39;$D(TestSetList(TestSetGroup)) s RetValue=\u0026#34;-1^无可核收医嘱\u0026#34; q s TestSetDR=\u0026#34;\u0026#34; F { s TestSetDR=$o(TestSetList(TestSetGroup,TestSetDR)) q:TestSetDR=\u0026#34;\u0026#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,TestSetDR,\u0026#34;\u0026#34;)) i $l(RowID){ //修改标本医嘱核收工作小组 s objTestSets=##class(dbo.RPVisitNumberTestSet).%OpenId(RowID) s objTestSets.VisitNumberReportDR=objVisitNumberReport.RowID s objTestSets.WorkGroupMachineDR=WorkGroupMachineDR s sc=objTestSets.%Save() If (\u0026#39;$SYSTEM.Status.IsOK(sc)) { s RetValue=$SYSTEM.Status.GetErrorText(sc) Quit } //按医嘱生成报告项目结果 s RetValue=##Class(LISSP.DHCRPVisitNumberReport).SaveReportTestCode(objVisitNumberReport.RowID,TestSetDR) i RetValue\u0026#39;=1 q } } } i RetValue\u0026#39;=1 TROLLBACK Quit RetValue //删除前处理报告 i $l(PreReportDR),\u0026#39;$d(^dbo.RPVisitNumberTestSetI(\u0026#34;IndexReportID\u0026#34;,PreReportDR)){ s sc=##class(dbo.RPVisitNumberReport).%DeleteId(PreReportDR) If (\u0026#39;$SYSTEM.Status.IsOK(sc)){s RetValue=\u0026#34;删除报告信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc) } } i RetValue\u0026#39;=1 TROLLBACK Quit RetValue TCOMMIT i $l(WorkGroupMachineDR),$l(maxEpis) s ret=##Class(HIS.DHCCommon).SaveWorkGroupMachineEpis(WorkGroupMachineDR,TransmitDate,maxEpis,\u0026#34;\u0026#34;) } else { //普通标本核收 s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) s Flag=1\t//YHR 20250319 仪器自动核收标志，为1的话，不影响工作小组手动核收序号 s Param=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P0\u0026gt;H\u0026lt;/P0\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P1\u0026gt;\u0026#34;_LabNo_\u0026#34;\u0026lt;/P1\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P3\u0026gt;\u0026#34;_maxEpis_\u0026#34;\u0026lt;/P3\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P4\u0026gt;\u0026#34;_AcceptUserDR_\u0026#34;\u0026lt;/P4\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026#34; s Param=Param_\u0026#34;\u0026lt;P8\u0026gt;\u0026#34;_WorkGroupMachineDR_\u0026#34;\u0026lt;/P8\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P12\u0026gt;\u0026#34;_RackNo_\u0026#34;\u0026lt;/P12\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P14\u0026gt;@@1@@\u0026#34;_Flag_\u0026#34;\u0026lt;/P14\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s Sessions=AcceptUserDR_\u0026#34;^\u0026#34;_WorkGroupDR_\u0026#34;^^^\u0026#34;_HospitalDR s ret=##Class(LISSP.DHCRPVisitNumber).ReceiveVisitNumber(LabNo,Param,Sessions) i $p(ret,\u0026#34;^\u0026#34;,1)\u0026#39;=\u0026#34;1\u0026#34; s RetValue=ret } q RetValue ErrorHandle TROLLBACK s RetValue=\u0026#34;-1^错误\u0026#34;_$tr($ZERROR,\u0026#34;^\u0026#34;,\u0026#34;--\u0026#34;)_\u0026#34;.错误代码:\u0026#34;_$ECODE Quit RetValue } 通过编号规则获取自动核收对应的流水号 本方法通过维护编号规则，编号规则代码与工作小组代码相同时，从编号规则获取对应工作小组流水号。\n避免核收失败流水号浪费造成跳号情况，本方法做出以下处理。\n1.先进行判断编号规则当前号是否在对应工作小组有报告，如果没有的话则还使用当前的流水号再次进行核收，如果有的话，则进入到下一个获取流水号的逻辑。\n2.通过编号规则获取下一个流水号，并进行最大1000次的判断循环取号，避免号重复核收失败。\n3.如果未通过编号规则获取到流水号，获取失败或者没有维护对应的编号规则，则获取当前工作小组最大流水号\n1 [[\u0026#34;0\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;2\u0026#34;,\u0026#34;3\u0026#34;,\u0026#34;4\u0026#34;,\u0026#34;5\u0026#34;,\u0026#34;6\u0026#34;,\u0026#34;7\u0026#34;,\u0026#34;8\u0026#34;,\u0026#34;9\u0026#34;],[\u0026#34;0\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;2\u0026#34;,\u0026#34;3\u0026#34;,\u0026#34;4\u0026#34;,\u0026#34;5\u0026#34;,\u0026#34;6\u0026#34;,\u0026#34;7\u0026#34;,\u0026#34;8\u0026#34;,\u0026#34;9\u0026#34;],[\u0026#34;0\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;2\u0026#34;,\u0026#34;3\u0026#34;,\u0026#34;4\u0026#34;,\u0026#34;5\u0026#34;,\u0026#34;6\u0026#34;,\u0026#34;7\u0026#34;,\u0026#34;8\u0026#34;,\u0026#34;9\u0026#34;],[\u0026#34;0\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;2\u0026#34;,\u0026#34;3\u0026#34;,\u0026#34;4\u0026#34;,\u0026#34;5\u0026#34;,\u0026#34;6\u0026#34;,\u0026#34;7\u0026#34;,\u0026#34;8\u0026#34;,\u0026#34;9\u0026#34;] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 /// Creator： YHR /// CreatDate： 20250320 /// Description： 通过编号规则获取工作小组最大流水号 /// Table： dbo.RPVisitNumberReport /// Input： 工作小组，日期(只能获取当天的，编号规则隔天后会刷新) /// Output： 无 /// Return： 失败:\u0026#34;\u0026#34; 成功:流水号 /// Others\t【原】w ##Class(LIS.Common.DHCVisitNumber).GetMaxMiEpisodeNo(\u0026#34;41\u0026#34;,\u0026#34;20250319\u0026#34;) /// k ^TMP(\u0026#34;MI.MIFIT3000N1.1\u0026#34;,\u0026#34;WGMEpis\u0026#34;,\u0026#34;41\u0026#34;) /// w ##Class(MI.MIFIT3000N1).GetMaxMiEpisodeNo(\u0026#34;41\u0026#34;,\u0026#34;20250403\u0026#34;) ClassMethod GetMaxMiEpisodeNo(WorkGroupMachineDR As %String, TransmitDate As %String) As %String { S TransmitDate=$g(TransmitDate) S WorkGroupMachineDR=$G(WorkGroupMachineDR) S RetValue=\u0026#34;\u0026#34; i \u0026#39;$l(WorkGroupMachineDR) q RetValue i \u0026#39;$l(TransmitDate) s TransmitDate=$zd($h,8) s TransmitDate=$tr(TransmitDate,\u0026#34;-\u0026#34;) s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) //记录该工作小组当天最大的流水号，如果有记录，则优先判断是否核收成功，如果未核收成功仍旧使用该号码 i $d(^dbo.SYSRuleNoBaseI(\u0026#34;IndexCode\u0026#34;,WorkGroupMachineCode)) d .s RuleNoBasDR=$o(^dbo.SYSRuleNoBaseI(\u0026#34;IndexCode\u0026#34;,WorkGroupMachineCode,\u0026#34;\u0026#34;)) .s JLEpis=$lg($g(^dbo.SYSRuleNoBaseD(RuleNoBasDR)),5) .i \u0026#39;$l(JLEpis) q .i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,JLEpis,TransmitDate)) d ..s RetValue=JLEpis i $l(RetValue) q RetValue //通过编号规则获取当天流水号，编号规则代码设置为工作小组同样代码，通过代码获取工作小组对应的编号规则 s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) //YHR 20230810 罗氏流水线规则 i $l(ZDHSEpis) d .i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ..s RetValue=ZDHSEpis .e d ..f Num=1:1:1000 d\t//避免死循环，每次进行一千次增号判断 ...s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) ...i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexMicNo\u0026#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ....s RetValue=ZDHSEpis ....s Num=1001 i $l(RetValue) q RetValue //未查询到编号规则，则获取当前工作小组最大流水号 s Parameter=\u0026#34;\u0026lt;Data\u0026gt;\u0026lt;P3\u0026gt;\u0026lt;/P3\u0026gt;\u0026lt;P12\u0026gt;\u0026lt;/P12\u0026gt;\u0026lt;P4\u0026gt;\u0026lt;/P4\u0026gt;\u0026lt;P0\u0026gt;\u0026#34;_TransmitDate_\u0026#34;\u0026lt;/P0\u0026gt;\u0026lt;P8\u0026gt;\u0026lt;/P8\u0026gt;\u0026lt;P10\u0026gt;\u0026lt;/P10\u0026gt;\u0026lt;P5\u0026gt;\u0026lt;/P5\u0026gt;\u0026lt;P1\u0026gt;\u0026lt;/P1\u0026gt;\u0026lt;P13\u0026gt;\u0026lt;/P13\u0026gt;\u0026lt;P9\u0026gt;\u0026lt;/P9\u0026gt;\u0026lt;P14\u0026gt;\u0026lt;/P14\u0026gt;\u0026lt;P6\u0026gt;\u0026lt;/P6\u0026gt;\u0026lt;P2\u0026gt;\u0026lt;/P2\u0026gt;\u0026lt;P11\u0026gt;\u0026lt;/P11\u0026gt;\u0026lt;P7\u0026gt;\u0026lt;/P7\u0026gt;\u0026lt;/Data\u0026gt;\u0026#34; s WGMEpisNo=##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(WorkGroupMachineDR,Parameter) //YHR 20250317 获取最大流水号报错问题处理 i $l(WGMEpisNo) s RetValue=WGMEpisNo q RetValue } 记录标本操作日志 记录仪器对于标本的操作日志，比如自动核收，上机，归档等信息\n示例：j ..SaveRecord(epis,\u0026ldquo;归档中位置:\u0026quot;_positioninfo,mi,\u0026ldquo;62\u0026rdquo;)\t//归档\n此处62为操作表的Code，操作表为 dbo.BTOperatorType​\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /// 记录标本日志 /// D ##class(MI.MIFRS600).SaveRecord(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode, curWorkGroupMachineDR) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s OperateTypeCode=$g(OperateTypeCode) i \u0026#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,\u0026#34;,\u0026#34;,2),\u0026#34;\u0026#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,\u0026#34;\u0026#34;) } 存储报警信息标志 将报警信息存放到报告表中结果报警信息（ResultWarned）中，该字段为自动审核存储报警信息使用，未验证是否冲突。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /// 保存报告表报警信息标志 /// D ##class(MI.MIFIT3000N1).SaveResultWarned(\u0026#34;1003803130\u0026#34;,\u0026#34;1\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;41\u0026#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI, curWorkGroupMachineDR) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) i \u0026#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) i $l(conclusion)\u0026gt;20 s conclusion=$e(conclusion,1,20)_\u0026#34;...\u0026#34; s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=\u0026#34;3\u0026#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q \u0026#34;1\u0026#34; } 基于此功能增加报告列表报警信息展示功能\n报警信息存储记录展示 仪器保存到报告表中结果报警信息后，在报告列表进行展示。只有非审核状态标本有此标志，其他状态显示报警信息标志。\nd ##Class(%ResultSet).RunQuery(\u0026ldquo;LIS.WS.BLL.DHCRPReportManage\u0026rdquo;,\u0026ldquo;QryWorkList\u0026rdquo;,\u0026ldquo;NoAuth\u0026rdquo;,\u0026ldquo;2022-11-16\u0026rdquo;,\u0026rdquo;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026ldquo;15\u0026rdquo;,\u0026ldquo;N^^0\u0026rdquo;,\u0026quot;\u0026quot;,\u0026quot;\u0026quot;,\u0026ldquo;8280402^1\u0026rdquo;)\n后台增加输出结果报警信息字段\n1 s ResultWarned=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),49)\t//YHR 20250329 报警信息 1 if (row.ResultWarned != null \u0026amp;\u0026amp; row.ResultWarned.length \u0026gt; 0 \u0026amp;\u0026amp; !row.Status.includes(\u0026#34;3\u0026#34;) ) retInfo = retInfo + \u0026#39;\u0026lt;img src=\u0026#34;../../resource/easyui/themes/icons/abnresult.gif\u0026#34; title=\u0026#34;\u0026#39; + escapeHtml(row.ResultWarned) + \u0026#39;\u0026#34; /\u0026gt;\u0026#39;;\t//YHR 20250329 报告列表显示报警信息 对于报警信息进行转义\n1 2 3 4 5 6 7 8 function escapeHtml(unsafe) { return unsafe .replace(/\u0026amp;/g, \u0026#34;\u0026amp;amp;\u0026#34;) .replace(/\u0026lt;/g, \u0026#34;\u0026amp;lt;\u0026#34;) .replace(/\u0026gt;/g, \u0026#34;\u0026amp;gt;\u0026#34;) .replace(/\u0026#34;/g, \u0026#34;\u0026amp;quot;\u0026#34;) .replace(/\u0026#39;/g, \u0026#34;\u0026amp;#039;\u0026#34;); } 报告处理增加筛选功能 可以快速对于含有报警信息的报告进行快速筛选\n1 \u0026lt;div listranslate=\u0026#34;title~Display expedited report^html~U\u0026amp;报告处理\u0026#34; class=\u0026#34;HISUITheme2\u0026#34; onclick=\u0026#34;SearchReportList(\u0026#39;8\u0026#39;)\u0026#34; style=\u0026#34;background-color: #FFF3E1; color: #AC5919; border: 1px solid #CF8A3B; display: inline-block; border-radius: 4px; width: 16px; height: 16px; text-align: center; line-height: 17px; font-size: 13px; vertical-align: top; cursor: pointer;\u0026#34; onmouseover=\u0026#34;this.style.cursor=\u0026#39;pointer\u0026#39;\u0026#34; title=\u0026#34;展示含有报警信息报告\u0026#34;\u0026gt;警\u0026lt;/div\u0026gt; 1 \u0026lt;div listranslate=\u0026#34;title~Display expedited report^html~U\u0026amp;报告处理\u0026#34; class=\u0026#34;HISUITheme\u0026#34; onclick=\u0026#34;SearchReportList(\u0026#39;8\u0026#39;)\u0026#34; style=\u0026#34;background-color: #dd3838; color: #FFF; border: 1px solid #e91b1b; display: inline-block; border-radius: 4px; width: 16px; height: 16px; text-align: center; line-height: 17px; font-size: 13px; vertical-align: top; cursor: pointer;\u0026#34; onmouseover=\u0026#34;this.style.cursor=\u0026#39;pointer\u0026#39;\u0026#34; title=\u0026#34;展示含有报警信息报告\u0026#34;\u0026gt;警\u0026lt;/div\u0026gt; 1 2 3 4 5 6 else if (Flag == \u0026#34;8\u0026#34;) {\t//YHR 20250331 增加报警信息筛选 //查询已处理危急值 if (obj.ResultWarned.length != 0) { rows.push(obj); } } 存放报警信息或者评价信息 根据科室实际要求来，本接口只是将报警信息存放到其他结果字段，此方法只是扩展补充，将报警信息存放到主评价或者次评价\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 /// 保存评价信息(仪器报警信息等提示信息) /// 条码号或者流水号，存储信息，仪器主键，工作小组(仪器和工作小组非关联使用)，是否打印(1 主评价，0 次评价) /// D ##class(MI.Special.Common).SaveAlarmInformation(\u0026#34;1003791311\u0026#34;,\u0026#34;Lymphopenia：淋巴细胞减少；Anemia：贫血；Reticulocytosis：网织红细胞增多\u0026#34;,\u0026#34;3\u0026#34;) /// D ##class(MI.Special.Common).SaveAlarmInformation(\u0026#34;8000001163\u0026#34;,\u0026#34;Monocytosis：单核细胞增加，Microcytosis：小红细胞症，Anemia：贫血，HGB Defect?：HGB异常？，IG present：幼稚粒细胞存在\u0026#34;,\u0026#34;77\u0026#34;) ClassMethod SaveAlarmInformation(labno, conclusion, predealMI, curWorkGroupMachineDR, IsPrint) { s labno=$g(labno),conclusion=$g(conclusion),predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),IsPrint=$g(IsPrint) i \u0026#39;$l(predealMI),\u0026#39;$l(curWorkGroupMachineDR) q \u0026#34;\u0026#34; i IsPrint\u0026#39;=1 s IsPrint=\u0026#34;0\u0026#34;\t//1 打印主评价，0 不打印次评价 i \u0026#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....;i Status=\u0026#34;3\u0026#34; q\t//审核后的标本存储报警信息，测试用 .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i IsPrint=1 d ......i $l(objrep.MajorConclusion) s objrep.MajorConclusion=objrep.MajorConclusion_\u0026#34;,\u0026#34;_conclusion ......e s objrep.MajorConclusion=conclusion .....e d ......i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_\u0026#34;,\u0026#34;_conclusion ......e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,\u0026#34;-1^存标本质量信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i IsPrint=1 d ..s objrep.MajorConclusion=conclusion .e s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) try{D ##class(MI.Special.Common).SaveResultWarned(labno,conclusion,predealMI, curWorkGroupMachineDR)}catch{}\t//保存至报告表报警信息 q \u0026#34;1\u0026#34; } 存储架子号信息以及标本操作日志记录 标本在流水线上有分区，上机，标本位置变化和标本归档等操作。之前查询标本位置需要在仪器软件上进行搜索查看，基于流水线本身会传输标本在流水线上的相关信息，因此对于这些信息解析。并将这些信息，存放至标本操作日志，将标本当前位置存放至架子号。\n本初增加额外的标本操作类型，101，架子号更新，避免仪器传错信息，仍旧可以有地方记录查看。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 /// 保存归档,分类信息,架子号,新增保存类型和参数工作小组ID，针对仪器不在对应的工作小组也可以保存架子号。 /// D ##class(MI.Special.Common).SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) /// D ##class(MI.Special.Common).SaveRackNo(\u0026#34;1003775669\u0026#34;,\u0026#34;c702-5719@4\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;上机\u0026#34;) /// D ##class(MI.Special.Common).SaveRackNo(\u0026#34;1003807721\u0026#34;,\u0026#34;新产业-NA024-2\u0026#34;,\u0026#34;45\u0026#34;,\u0026#34;上机\u0026#34;) ClassMethod SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) { s labno=$g(labno) s positioninfo=$g(positioninfo) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),typename=$g(typename) i \u0026#39;$L(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $l(typename) s positioninfo=typename_\u0026#34;:\u0026#34;_positioninfo s hasFindRep=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=\u0026#34;\u0026#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=\u0026#34;\u0026#34; d ...s OrderNo=\u0026#34;\u0026#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=\u0026#34;\u0026#34; d ....s ReportDR=\u0026#34;\u0026#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=\u0026#34;\u0026#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i typename[\u0026#34;上机\u0026#34; try{j ..SaveRecord(labno,positioninfo,mi,\u0026#34;6\u0026#34;)}catch{} .....i $l(objrep.RackNo),objrep.RackNo\u0026#39;=positioninfo try{j ..SaveRecord(labno,\u0026#34;架子号位置更新:\u0026#34;_objrep.RackNo_\u0026#34;--\u0026gt;\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;)}catch{}\t//架子号更新 .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,\u0026#34;-1^存\u0026#34;_typename_\u0026#34;信息失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc),\u0026#34;H\u0026lt;--M\u0026#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(\u0026#34;IndexEpisodeNo\u0026#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),\u0026#34;\u0026#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i typename[\u0026#34;上机\u0026#34; try{j ..SaveRecord(labno,positioninfo,mi,\u0026#34;6\u0026#34;)}catch{} .i $l(objrep.RackNo),objrep.RackNo\u0026#39;=positioninfo try{j ..SaveRecord(labno,\u0026#34;架子号位置更新:\u0026#34;_objrep.RackNo_\u0026#34;--\u0026gt;\u0026#34;_positioninfo,mi,\u0026#34;101\u0026#34;)}catch{}\t//架子号更新 .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_\u0026#34;:没有找到报告\u0026#34;,\u0026#34;H\u0026lt;--M\u0026#34;) q hasFindRep } 存储标本图片 罗氏流水线有血清标本图片，图片命名格式为条码号_第几个，比如1003783657_01，标本重复上线时会出现多个标本图片的情况，此处抓图将多个图片都抓取，按照P1，P2保存至标本图片表，如果找不到哦啊对应标本，则存入仪器图片表。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /// 保存标本图片 /// D ##class(MI.MIFRS600).SaveImageMTHD(\u0026#34;57\u0026#34;,\u0026#34;1000100990\u0026#34;,\u0026#34;P\u0026#34;,\u0026#34;/iLISLIS080/demo.png\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) /// D ##class(MI.MIFIT3000N1).SaveImageMTHD(\u0026#34;34\u0026#34;,\u0026#34;1003783657_01\u0026#34;,\u0026#34;1003783657_01\u0026#34;,\u0026#34;/iLISLIS032/20250321/1003783657_01.jpg\u0026#34;,\u0026#34;C:\\LISDATA\\DATA\\1003783657_01.jpg\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s ^YHR(\u0026#34;MI.MIFIT3000\u0026#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=\u0026#34;1\u0026#34; s epis=$p(epis,\u0026#34;_\u0026#34;,1) s ImageClass=\u0026#34;P\u0026#34;_+$p(ImageClass,\u0026#34;_\u0026#34;,2) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=\u0026#34;\u0026#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(epis),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=\u0026#34;\u0026#34; f s RowID=$o(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=\u0026#34;\u0026#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i \u0026#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=\u0026#34;SerumQ\u0026#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (\u0026#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= \u0026#34;-1^保存报告图片失败:\u0026#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_\u0026#34;:\u0026#34;_ImageClass_\u0026#34;:\u0026#34;_FileName,\u0026#34;H\u0026lt;--M\u0026#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=\u0026#34;\u0026#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } 基于此功能附加功能\n血清标本显示 抓取血清图片后，会有多张图片的情况，将最新的图片显示在最上边\n修改方法 \u0026ldquo;LIS.WS.BLL.DHCRPVisitNumberReport\u0026rdquo;,\u0026ldquo;QryReportImage\u0026rdquo;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 k ^LISVisitNumberImage(\u0026#34;Data\u0026#34;) //获取条码标本质量图形信息 i $d(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;))) D .s SERUMID=\u0026#34;\u0026#34; .f S SERUMID=$O(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),SERUMID)) q:SERUMID=\u0026#34;\u0026#34; d ..S SERUMQRowID=$O(^dbo.RPVisitNumberImageI(\u0026#34;IndexMaster\u0026#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(\u0026#34;SerumQ\u0026#34;),SERUMID,\u0026#34;\u0026#34;)) ..S (FileName,MachineParameterDR,Caption,DisplayRatio,Height,Width,Sequence,ImageClassDesc) = \u0026#34;\u0026#34; ..S StrData=$g(^dbo.RPVisitNumberImageD(SERUMQRowID)) ..s RowID=SERUMQRowID ..s ImageClassDesc = $lg(StrData,4) ..s FileName = ftp_$lg(StrData,5) ..s ThumbnailWidth=\u0026#34;\u0026#34;,ThumbnailHeight=\u0026#34;\u0026#34;,ThumbnailDeg=\u0026#34;\u0026#34; ..s Caption = \u0026#34;SerumQ\u0026#34; ..s IsImageRes=\u0026#34;\u0026#34; ..s IsExistImgRes=\u0026#34;\u0026#34; ..s Time=$p($h,\u0026#34;,\u0026#34;,2) ..s FileName=FileName //_\u0026#34;?Version=\u0026#34;_Time //解决图片缓存问题 ..Set Data=$lb(ImageClassDesc,ImageOrder,FileName,MachineParameterDR,Caption,DisplayRatio,Height,Width,Sequence,RowID,IsImageRes,ThumbnailWidth,ThumbnailHeight,ThumbnailDeg) ..s ^LISVisitNumberImage(\u0026#34;Data\u0026#34;,ImageClassDesc)=Data ..;d OutputRow /*----------\u0026gt;设置血清标本只显示最新的开始\u0026lt;----------*/ i $d(^LISVisitNumberImage(\u0026#34;Data\u0026#34;)) d .s ImageClassDesc=$o(^LISVisitNumberImage(\u0026#34;Data\u0026#34;,\u0026#34;\u0026#34;),-1) .s Data=$g(^LISVisitNumberImage(\u0026#34;Data\u0026#34;,ImageClassDesc)) .s Caption=$lg(Data,5) .s ImageClassDescNext=$o(^LISVisitNumberImage(\u0026#34;Data\u0026#34;,ImageClassDesc),-1) .i $l(ImageClassDescNext) s $li(Data,5)=Caption_\u0026#34;-\u0026#34;_ImageClassDesc .i \u0026#39;$l(Sequence) s Sequence=999 .i \u0026#39;$l(RowID) q .s ^TMP($zn,repid,$j,Sequence,RowID)=Data k ^LISVisitNumberImage(\u0026#34;Data\u0026#34;) /*----------\u0026gt;设置血清标本只显示最新的结束\u0026lt;----------*/ 特殊处理记录 本节点为该仪器接口特殊处理的部分，可以参考实际修改使用\n监听配置，有多条监听配置 主监听配置会获取仪器主键，其他的无法获取只能写死，主键有根据项目实际情况修改\n自动核收调用核收方法，按照工作小组主键入参。 自动核收前处理 由于自动核收功能包括罗氏本流水线自动核收，同时还带有分拣功能，对于免疫标本和临检标本分区和自动核收。本部分为特殊处理部分。\n本部分分为两块，一块为接收时上传维护，此部分与科室进行核对维护，另一部分为接收分区标识，根据仪器分区进行核收。（注：未通过检验自己维护的项目分区进行核收，一部分是减少调用增加处理速度，另一部分是根据仪器分区，方便科室对应分区找到对应工作小组的标本。）\n1.生化的标本都会立马拔盖上机去做，对于其他的标本，比如免疫和临检的标本，涉及到是否拔盖和分区的逻辑。仪器分别该标本类型，则需要通过检验上传对应条码的相关信息，因此，在流水线工作组中，对应医嘱维护不同的检测项目，在接收的时候就会获取流水线的医嘱对应的项目，在上传通道号维护对应的标识。\n2.标本上机仪器回传分区标识进行自动核收\n优先判断是否已接收未核收，如果已经核收则直接退出。\n根据前处理标本分区标识进行自动核收（此标识跟仪器进行核对不同的分区标识），通过不同的标识获取对应的工作小组，或者BHS_标识只记录分区不进行核收。核收失败进行弹窗提示。\n记录自动核收操作日志。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 /// 仪器主键，条码号，前处理标本分区标识，仪器信息(位置) /// w ##class(MI.MIFIT3000N1).ZDHS(\u0026#34;34\u0026#34;,\u0026#34;8000000352\u0026#34;,\u0026#34;WANTAI\u0026#34;) /// w ##class(MI.MIFIT300N).ZDHS(\u0026#34;34\u0026#34;,\u0026#34;1003779663\u0026#34;,\u0026#34;RSA1\u0026#34;) ClassMethod ZDHS(mi, Labno, MachineCode, positioninfo) { s mi=$g(mi),Labno=$g(Labno),machCode=$g(MachineCode),positioninfo=$g(positioninfo) i \u0026#39;$l(Labno) q \u0026#34;\u0026#34; /*----------\u0026gt;判断该标本是否已接收未核收 开始\u0026lt;----------*/ s QuitFlag=0 i $d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##class(LIS.Util.Common).IndexData(Labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) .i $d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) s QuitFlag=1 i QuitFlag=1 q \u0026#34;\u0026#34; /*----------\u0026gt;判断该标本是否已接收未核收 结束\u0026lt;----------*/ s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)\t//得到当前仪器关联工作小组信息 s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13)\t//得到仪器工作小组的核收类型 //AcceptFlag为1认为是前处理工作小组，如果是前处理小组，就认为上前处理\t本接口未设置前处理工作小组，未对此流程进行测试 i AcceptFlag=\u0026#34;1\u0026#34; d QCLZDHS e d ZDHS q \u0026#34;\u0026#34; ZDHS d Trace^MI.MIF000(mi,\u0026#34;上仪器,标本号:\u0026#34;_Labno_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,分区位置:\u0026#34;_MachineCode_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;自动核收\u0026#34;) //根据前处理标本分区进行分区自动核收，并且根据分区代码是否核收进行区分 //本接口认为 默认认为罗氏流水线核收，如果分区代码中包含 【BHS】则认为标本不核收，此块代码将仪器传过来的分区代码进行归类 //本接口关联标本分区， WANTAI 万泰--\u0026gt;W，XINCHANYE 新产业--\u0026gt;X，LINJIAN 临检凝血--\u0026gt;L，XIEGUANG 携光--\u0026gt;R，罗氏--\u0026gt;Y，不核收--\u0026gt;N s HsFlag=\u0026#34;Y\u0026#34;,WorkGroupMachineDR=\u0026#34;\u0026#34; i (MachineCode[\u0026#34;WANTAI\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;WANTAI\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;W\u0026#34; .s WorkGroupMachineDR=48\t//未核收且分区是WANTAI i (MachineCode[\u0026#34;XINCHANYE\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;XINCHANYE\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;X\u0026#34; .s WorkGroupMachineDR=50\t//未核收且分区是XINCHANYE i (MachineCode[\u0026#34;LINJIAN\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;LINJIAN\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;L\u0026#34; .s WorkGroupMachineDR=9\t//未核收且分区是LINJIAN i (MachineCode[\u0026#34;XIEGUANG\u0026#34;)\u0026amp;\u0026amp;(MachineCode\u0026#39;[\u0026#34;BHS\u0026#34;) d .S MachineCode=$REPLACE(MachineCode,\u0026#34;XIEGUANG\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;R\u0026#34; .s WorkGroupMachineDR=67\t//未核收且分区是XIEGUANG i (MachineCode[\u0026#34;BHS_\u0026#34;) d\t;BHS_WANTAI .S MachineCode=$REPLACE(MachineCode,\u0026#34;BHS_\u0026#34;,\u0026#34;\u0026#34;) .s HsFlag=\u0026#34;N\u0026#34; i MachineCode=\u0026#34;C_C8K886\u0026#34; s MachineCode=\u0026#34;C801\u0026#34; i MachineCode=\u0026#34;C_C8K77\u0026#34; s MachineCode=\u0026#34;C701\u0026#34; i MachineCode=\u0026#34;C8K886\u0026#34; s MachineCode=\u0026#34;C801\u0026#34; i MachineCode=\u0026#34;C8K77\u0026#34; s MachineCode=\u0026#34;C701\u0026#34; i HsFlag=\u0026#34;Y\u0026#34; d .s WorkGroupMachineDR=41\t//未核收且分区不包含BHS_\t默认核收到罗氏流水线 i \u0026#39;$l(WorkGroupMachineDR) q s ret=..ReceiveLabNoByWGM(WorkGroupMachineDR,Labno,$zd(+$h,8)) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) i ret\u0026#39;=\u0026#34;1\u0026#34; d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_WorkGroupDR\t//自动核收出错显示再对应的工作组 .s SendRet=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收失败\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_Labno_\u0026#34;前处理核收失败:\u0026#34;_ret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) j ..SaveRecord(Labno,\u0026#34;自动核收:\u0026#34;_ret,\u0026#34;\u0026#34;,\u0026#34;14\u0026#34;,WorkGroupMachineDR) q ret QCLZDHS d Trace^MI.MIF000(mi,\u0026#34;上前处理，鉴定号:\u0026#34;_Labno_\u0026#34;的标本在:\u0026#34;_curMachName_\u0026#34;,样本所在:\u0026#34;_positioninfo,\u0026#34;DealInfo\u0026#34;) d Trace^MI.MIF000(mi,\u0026#34;执行核收到前处理\u0026#34;,\u0026#34;DealInfo\u0026#34;) //此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,Labno,\u0026#34;\u0026#34;) d Trace^MI.MIF000(mi,Labno_\u0026#34;核收到前处理返回信息:\u0026#34;_dealret,\u0026#34;DealInfo\u0026#34;) //记录位置信息到报告位置号 d ..SaveRackNo(Labno,positioninfo,mi) i dealret[\u0026#34;标本已核收\u0026#34; q i dealret=\u0026#34;1\u0026#34; d .//写标本操作日志 .d ..SaveRecord(Labno,machCode,mi,\u0026#34;5\u0026#34;) e d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = \u0026#34;WG-\u0026#34;_CurWorkGroupDR .s ret=retObj.SendMsg(\u0026#34;dhcc\u0026#34;,\u0026#34;{ \u0026#34;\u0026#34;type\u0026#34;\u0026#34;: \u0026#34;\u0026#34;自动核收失败\u0026#34;\u0026#34;, \u0026#34;\u0026#34;info\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;_Labno_\u0026#34;前处理核收失败:\u0026#34;_dealret_\u0026#34;,仪器【\u0026#34;_curMachName_\u0026#34;】！\u0026#34;_\u0026#34;\u0026#34;\u0026#34;, \u0026#34;\u0026#34;dealurl\u0026#34;\u0026#34;: \u0026#34;\u0026#34;\u0026#34;\u0026#34; }\u0026#34;, \u0026#34;Crisis\u0026#34;, perUser) .//写标本操作日志 .d ..SaveRecord(Labno,dealret,mi,\u0026#34;100\u0026#34;) q } 特殊结果的转换 仪器某些结果需要进行转换，固定的大部分都可以通过仪器维护对应项目的系数进行转换，但是对于包含\u0026gt;\u0026lt;的无法进行转换，因此需要在接口里进行特殊处理。\n！！！注：系数为除法\n1 2 3 4 5 6 7 8 9 10 /// 结果特殊转换 /// $TS$ /// W ##CLASS(MI.MIFIT3000N1).ConvertResult(\u0026#34;9PA\u0026#34;,\u0026#34;\u0026lt;0.070\u0026#34;) ClassMethod ConvertResult(code, res) { i code=\u0026#34;9PA\u0026#34; d .i $e(res)=\u0026#34;\u0026lt;\u0026#34;,+$e(res,2,*)=\u0026#34;.07\u0026#34; d ..s res=\u0026#34;\u0026lt;70\u0026#34; q res } 报警信息转换 本接口未使用报警信息转换，仪器传过来的报警信息就是转换后的报警信息，此处只是作为记录。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 /// 报警信息转换 ClassMethod ConvertPoliceInfo(WaringCode) { s WaringStr=\u0026#34;\u0026#34; i WaringCode=\u0026#34;5\u0026#34; s WaringStr=\u0026#34;\u0026gt;ABS(超出ABS)\u0026#34; i WaringCode=\u0026#34;43\u0026#34; s WaringStr=\u0026#34;Cal.E(校准结果异常)\u0026#34; i WaringCode=\u0026#34;2\u0026#34; s WaringStr=\u0026#34;\u0026gt;Cuvet(反应杯空白异常)\u0026#34; i WaringCode=\u0026#34;42\u0026#34; s WaringStr=\u0026#34;Edit(实验结果已被编辑)\u0026#34; i WaringCode=\u0026#34;23\u0026#34; s WaringStr=\u0026#34;\u0026gt;ISE(超出ISE范围)\u0026#34; i WaringCode=\u0026#34;19\u0026#34; s WaringStr=\u0026#34;ISE.E(ISE电压级错误)\u0026#34; i WaringCode=\u0026#34;56\u0026#34; s WaringStr=\u0026#34;\u0026gt;Kin(Prozone错误2/运动不稳)\u0026#34; i WaringCode=\u0026#34;10\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; i WaringCode=\u0026#34;11\u0026#34; s WaringStr=\u0026#34;\u0026gt;Lin(线性异常)\u0026#34; i WaringCode=\u0026#34;6\u0026#34; s WaringStr=\u0026#34;\u0026gt;Prozone(Prozone错误1)\u0026#34; i WaringCode=\u0026#34;4\u0026#34; s WaringStr=\u0026#34;Reag.S(试剂不足)\u0026#34; i WaringCode=\u0026#34;44\u0026#34; s WaringStr=\u0026#34;\u0026gt;Rept(高出原倍复查范围)\u0026#34; i WaringCode=\u0026#34;45\u0026#34; s WaringStr=\u0026#34;\u0026lt;Rept(低于原倍复查范围)\u0026#34; i WaringCode=\u0026#34;46\u0026#34; s WaringStr=\u0026#34;Samp.？(高出ABS最大值)\u0026#34; i WaringCode=\u0026#34;68\u0026#34; s WaringStr=\u0026#34;Samp.B(样本中有气泡)\u0026#34; i WaringCode=\u0026#34;72\u0026#34; s WaringStr=\u0026#34;Samp.C(样本中有凝块)\u0026#34; i WaringCode=\u0026#34;26\u0026#34; s WaringStr=\u0026#34;\u0026gt;Test(高出线性范围)\u0026#34; i WaringCode=\u0026#34;27\u0026#34; s WaringStr=\u0026#34;\u0026lt;Test(低于线性范围)\u0026#34; q WaringStr } 新增标本操作日志记录类型 新增两个操作类型\n100\t前处理分区\n101\t架子号更新\n主动上传特殊处理 包含申请项目上传，复查项目上传，回退项目上传和审核项目上传\n申请状态为C，复查状态为U，回退状态为R，审核状态为T\n申请状态和审核状态进行分批上传，分别同时超过10个就先输出这10个，再次查询时再进行新的查询\n申请为重新获取项目，避免漏项目，如果要提升速度，则修改为获取上传表通道号，复查为获取上传表通道号(跟踪后发现也为发送全部为空的数据，并不是只复查需要复查的项目)，回退项目为获取标本对应医嘱所关联的工作小组布局和组合套布局（要求输入全部的项目才能完全删除仪器不做的项目，只传部分的话只删除上传的项目），审核上传为固定的通道项目\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = \u0026#34;labno,labnoInfo,patInfo\u0026#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(\u0026#34;MI.MIFIT3000N1\u0026#34;,\u0026#34;QryLabInfo\u0026#34;,\u0026#34;34\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i \u0026#39;$d(^dbo.BTMIMachineParameterD(mi)) q \u0026#34;\u0026#34; s LabnoList=\u0026#34;\u0026#34; s VisitNumberDR=\u0026#34;\u0026#34; s OutPutNum=0 //*--------------------------------\u0026gt;*申请项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate)) q:(AddDate=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;6) d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime)) q:(AddTime=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;6) d ..s OutPutNum=OutPutNum+1 ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;C\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i \u0026#39;$l(EpisNo) q ..i \u0026#39;$l(labno) q ..i \u0026#39;$d(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno)) q ..s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..s ReceiveTime=$lg($g(^dbo.RPVisitNumberD(VisitNumberDR)),67) ..i ((+$p($h,\u0026#34;,\u0026#34;,2))-ReceiveTime\u0026gt;=-2)\u0026amp;\u0026amp;((+$p($h,\u0026#34;,\u0026#34;,2))-ReceiveTime\u0026lt;5) d Trace^MI.MIF000(mi,labno_\u0026#34;标本接收时间低于5秒不上传\u0026#34;,\u0026#34;等待上传\u0026#34;) q ..//得到通道号 ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@C\u0026#34;\t//重新获取通道号 避免因为接收造成漏项目 ..;GetLabnoInfoDelete ..;s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..;s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;|@U\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;申请上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;C@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 //*--------------------------------\u0026gt;*复查结果上传 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;U\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..i \u0026#39;$d(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//控制输出文本的内容 ..s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;|@U\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;复查上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;U@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 //*--------------------------------\u0026gt;*取消项目 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate)) q:AddDate=\u0026#34;\u0026#34; d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime)) q:AddTime=\u0026#34;\u0026#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;R\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//控制输出文本的内容 ..;s labnoInfo=..GetLabnoInfo(mi,labno)_\u0026#34;@R\u0026#34; ..s TCList=..GetLabnoInfoDelete(mi,labno) ..s labnoInfo=labno_\u0026#34;,\u0026#34;_$replace(TCList,\u0026#34;\\\u0026#34;,\u0026#34;+\u0026#34;)_\u0026#34;@R\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;取消上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;R@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 //*--------------------------------\u0026gt;*审核项目 s OutPutNum=0 s AddDate=$zd($p($h,\u0026#34;,\u0026#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate)) q:(AddDate=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;10) d .s AddTime=\u0026#34;\u0026#34; f s AddTime=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate,AddTime)) q:(AddTime=\u0026#34;\u0026#34;)||(OutPutNum\u0026gt;10) d ..s OutPutNum=OutPutNum+1 ..s MiUploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,mi,##Class(LIS.Util.Common).IndexData(\u0026#34;T\u0026#34;),AddDate,AddTime,\u0026#34;\u0026#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i \u0026#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,labno,\u0026#34;\u0026#34;)) ..i \u0026#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,\u0026#34;,\u0026#34;,10) ..//控制输出文本的内容 ..s labnoInfo=labno_\u0026#34;,\u0026#34;_\u0026#34;DM_OVER\u0026#34;_\u0026#34;@C\u0026#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,\u0026#34;,\u0026#34;,1),8)_$tr($zt($p(now,\u0026#34;,\u0026#34;,2)),\u0026#34;:\u0026#34;)_$p(now,\u0026#34;.\u0026#34;,2) ..s filename=filenametime_\u0026#34;_\u0026#34;_labno_\u0026#34;.hl7\u0026#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,\u0026#34;\u0026#34;) ..d Trace^MI.MIF000(mi,txtInfo,\u0026#34;审核上传信息\u0026#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,\u0026#34;T@\u0026#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,\u0026#34;LSLSXPUT\u0026#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=\u0026#34;labno,labnoInfo,patInfo\u0026#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=\u0026#34;\u0026#34; { Set AtEnd=1 Set Row=\u0026#34;\u0026#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } 基于此的特殊处理操作\n回退和审核更新状态 基于复查更新状态进行功能扩展 原方法为d ##class(LIS.WS.BLL.DHCMachineUploadManage).UploadByWGM(\u0026quot;8000000413\u0026quot;,\u0026quot;\u0026quot;,\u0026quot;41\u0026quot;,\u0026quot;U\u0026quot;)​\n回退时设置状态为R，上传通道号为END（接收时如果上传表中有数据，则不进行重新上传，避免接收和核收重复上传，基于此过滤判断通道号为END，通道号为END时则重新进行上传。）\n审核时设置通道号为DM_OVER\n拒收调用方法位置 LISSP.DHCRPVisitNumber\u0026ndash;RejectVisitNumber\n审核和复审时调用方法位置 LISSP.DHCRPVisitNumberReport\u0026ndash;SaveResult\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 /// 按小组重置上传列表 /// d ##class(MI.MIFIT3000N1).UploadByWGM(\u0026#34;8000000413\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;41\u0026#34;,\u0026#34;R\u0026#34;) /// d ##class(MI.MIFIT3000N1).UploadByWGM(\u0026#34;8000000413\u0026#34;,\u0026#34;\u0026#34;,41,\u0026#34;T\u0026#34;) /// d ##class(MI.MIFIT3000N1).UploadByWGM(\u0026#34;8000000413\u0026#34;,\u0026#34;\u0026#34;,41,\u0026#34;U\u0026#34;) ClassMethod UploadByWGM(Labno, TestSetDR, WorkGroupMachineDR, SendStatus) As %String { s Labno=$g(Labno),TestSetDR=$g(TestSetDR),WorkGroupMachineDR=$g(WorkGroupMachineDR) i \u0026#39;$l(Labno) q 100 i \u0026#39;$l(TestSetDR),\u0026#39;$l(WorkGroupMachineDR),SendStatus\u0026#39;=\u0026#34;R\u0026#34; q 100 i SendStatus=\u0026#34;R\u0026#34;,\u0026#39;$d(^dbo.RPMachineUploadI(\u0026#34;IndexVisitNumber\u0026#34;,Labno)) q i SendStatus=\u0026#34;R\u0026#34; { s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexVisitNumber\u0026#34;,Labno,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .s UploadDR=\u0026#34;\u0026#34; f s UploadDR=$o(^dbo.RPMachineUploadI(\u0026#34;IndexVisitNumber\u0026#34;,Labno,MachineDR,UploadDR)) q:UploadDR=\u0026#34;\u0026#34; d ..S obj=##class(dbo.RPMachineUpload).%OpenId(UploadDR) ..s obj.MachineParameterDR=MachineDR ..s obj.VisitNumber=Labno ..s obj.SendStatus=SendStatus ..s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) ..s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) ..s obj.TCList=\u0026#34;END\u0026#34; ..s ret=obj.%Save() }else{ s ReplaceWGMDRData=\u0026#34;3,41\u0026#34; s QuitFlag=0 for i=1:1:$l(ReplaceWGMDRData,\u0026#34;,\u0026#34;) q:QuitFlag=\u0026#34;1\u0026#34; d .i WorkGroupMachineDR=$p(ReplaceWGMDRData,\u0026#34;,\u0026#34;,i) d ..s WorkGroupMachineDR=\u0026#34;96\u0026#34; ..s QuitFlag=1 i SendStatus=\u0026#34;T\u0026#34; { s ReplaceWGMDRData=\u0026#34;1,3,41\u0026#34;\t//屏蔽所有，这里维护所有可以上传的工作小组 s WorkGroupMachineDRBAK=WorkGroupMachineDR s WorkGroupMachineDR=\u0026#34;\u0026#34; s QuitFlag=0 for i=1:1:$l(ReplaceWGMDRData,\u0026#34;,\u0026#34;) q:QuitFlag=\u0026#34;1\u0026#34; d .i WorkGroupMachineDRBAK=$p(ReplaceWGMDRData,\u0026#34;,\u0026#34;,i) d ..s WorkGroupMachineDR=\u0026#34;96\u0026#34; ..s QuitFlag=1 s WorkGroupMachineDR=\u0026#34;96\u0026#34;\t//所有的审核都发送归档标志 } s SendStatus=$g(SendStatus) s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) I $L(WorkGroupMachineDR) d .D UploadTC } q \u0026#34;1\u0026#34; UploadTC s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) i CommDirection\u0026#39;=\u0026#34;UP\u0026#34;,CommDirection\u0026#39;=\u0026#34;LS\u0026#34; q 100 s ret=100 s MachineDR=\u0026#34;\u0026#34; f s MachineDR=$o(^dbo.BTMIMachineParameterI(\u0026#34;IndexWorkGroupMachine\u0026#34;,WorkGroupMachineDR,MachineDR)) q:MachineDR=\u0026#34;\u0026#34; d .s miCommDirection=$lg(^dbo.BTMIMachineParameterD(MachineDR),11) .i miCommDirection\u0026#39;=\u0026#34;UP\u0026#34;,miCommDirection\u0026#39;=\u0026#34;LS\u0026#34; q .d ScanOne^MI.MIF000(MachineDR,Labno) .s TCList=\u0026#34;\u0026#34; .s chl=\u0026#34;\u0026#34; f s chl=$o(^TMP(\u0026#34;MIFTESTCODE\u0026#34;,$j,MachineDR,Labno,chl)) q:chl=\u0026#34;\u0026#34; d ..s TCList=TCList_chl_\u0026#34;\\\u0026#34; .s TCList=$e(TCList,1,$l(TCList)-1) .i \u0026#39;$l(TCList),SendStatus\u0026#39;=\u0026#34;T\u0026#34; s ret=Labno_\u0026#34;没有上传项目\u0026#34; q .s RowID=\u0026#34;\u0026#34; .i $d(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno))) S RowID=$O(^dbo.RPMachineUploadI(\u0026#34;IndexMaster\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),\u0026#34;\u0026#34;)) //q .I $L(RowID) S obj=##class(dbo.RPMachineUpload).%OpenId(RowID) .E s obj=##class(dbo.RPMachineUpload).%New() .//i $L(obj.SendStatus),obj.SendStatus\u0026#39;=\u0026#34;C\u0026#34; Q //已读取标本不再上传 .s obj.MachineParameterDR=MachineDR .s obj.VisitNumber=Labno .s obj.SendStatus=\u0026#34;C\u0026#34; .i $l(SendStatus) s obj.SendStatus=SendStatus .s obj.AddDate=$tr($zd(+$h,3),\u0026#34;-\u0026#34;) .s obj.AddTime=$p($h,\u0026#34;,\u0026#34;,2) .i SendStatus=\u0026#34;T\u0026#34; s TCList=\u0026#34;DM_OVER\u0026#34; .s obj.TCList=TCList .s ret=obj.%Save() q 0 } 标本上传处理修改显示 由于仪器和实际工作的工作小组不在一个位置，造成如果为上传成功时，重新上传查询不到标本，修改页面查询query逻辑 \u0026ldquo;LIS.WS.BLL.DHCMachineUploadManage\u0026rdquo;,\u0026ldquo;QrySampleStatus\u0026rdquo;,\n1 2 3 i MachineDR=\u0026#34;34\u0026#34; d .s WorkGroupMachineDRs=\u0026#34;41,3,48,50,67,7,9\u0026#34; e s WorkGroupMachineDRs=WorkGroupMachineDR 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 QryLSData s WorkGroupMachineDRs=\u0026#34;41,3,48,50,67,7,9\u0026#34; //按仪器或者小组查询 f date=SttDate:1:EndDate d .s Curdate=$TR($ZD(date,3),\u0026#34;-\u0026#34;) .f i=1:1:$L(SendStatus,\u0026#34;,\u0026#34;) d ..s CurSendStatus=$P(SendStatus,\u0026#34;,\u0026#34;,i) ..i \u0026#39;$l(iWorkGroupMachineDR) d ...s Time=\u0026#34;\u0026#34; f s Time=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(CurSendStatus),Curdate,Time)) q:Time=\u0026#34;\u0026#34; d ....s RowID=\u0026#34;\u0026#34; f s RowID=$o(^dbo.RPMachineUploadI(\u0026#34;IndexSendStatus\u0026#34;,MachineDR,##Class(LIS.Util.Common).IndexData(CurSendStatus),Curdate,Time,RowID)) q:RowID=\u0026#34;\u0026#34; d .....s loadData=$g(^dbo.RPMachineUploadD(RowID)) .....s VisitNumber=$lg(loadData,3) .....s VisitNumberDR=$o(^dbo.RPVisitNumberI(\u0026#34;IndexVisitNumber\u0026#34;,##Class(LIS.Util.Common).IndexData(VisitNumber),\u0026#34;\u0026#34;)) .....s VisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) .....i $l(iVisitNumber),VisitNumber\u0026#39;[iVisitNumber q .....f j=1:1:$l(WorkGroupMachineDRs,\u0026#34;,\u0026#34;) d ......s WorkGroupMachineDRsj=$p(WorkGroupMachineDRs,\u0026#34;,\u0026#34;,j) ......i \u0026#39;$l(WorkGroupMachineDRsj) q ......s order=\u0026#34;\u0026#34; ......f s order=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDRsj,order)) q:order=\u0026#34;\u0026#34; d .......s ReportDR=$O(^dbo.RPVisitNumberReportI(\u0026#34;IndexReportID\u0026#34;,VisitNumberDR,WorkGroupMachineDRsj,order,\u0026#34;\u0026#34;)) .......d InsertData q 问题处理记录 本节点为接口使用过程中踩过的雷和遇到过的问题以及处理方案\n无法及时读取文件处理造成获取结果过慢 1.修改监听配置，允许同一台电脑上存在多个监听。（新版本监听支持，本接口对应使用软件在附件中）\n监听中存在两个配置，AllowMultiOpen（是否允许多开，1允许，0不允许，默认不允许） 和OpenMessageService（多开版本维护为0，如果是1的话会造成系统崩溃！！！如果是正常在用电脑，其中一个维护为1就可以，其他的一定要设置为0） 在监听配置中，配置多个监听读取。本接口配置多个监听，主监听读取结果，额外配置两个，一个读取流水线处理文件，一个读取图片和上传信息（！！！这两个功能一定要在一起，上传参数 \u0026quot;UPPreDealClass\u0026quot;:\u0026quot;PreDeal.DealDemoM,PreDeal\u0026quot; 配置后，就一定会主动上传文件，所以一定一定一定再一起！！！）\n2.使用job线程处理。监听固定调用对应接口的fileMTHD方法，读取结果与系统其他方法没有交互，因此将具体的处理方法另外写了方法 ResultDo ，通过文件名包含路径进行判断，如果是结果RESULT文件，用job调用存储结果，如果是处理SEEN文件，用do调用处理结果。加快解析读取结果速度。\n仪器未获取到项目问题 1.读取结果不能及时时，进行了监听配置配置多个监听，最开始是为了分工明确，设置了四个监听，一个用来读取结果RESULT，一个用来读取处理文件SEEN，一个用来上传信息，一个用来读取图片。读取图片的配置和上传信息的配置处理类是同一个，读取图片多了一个额外的读取图片路径。\n最开始认为，读取图片的配置，不配置上传信息的路径，就不会进行上传。后面科室经常说会有漏标本漏项目的情况，经过多次排查核对日志后，发现被读取图片配置的监听上传了文件，因为没有配置上传路径，将上传的文件存在了监听对应的根路径。后面修改为上传信息和读取图片合为一个监听，最终为三个监听，一个读取结果，一个读取处理文件，一个上传信息+读取图片。\n2.修改后仍旧有漏项目的情况，确定仪器电脑只有三个监听，三个监听的日志都有认真排查。后面使用获取调用webservice的ip方法 w ##Class(LIS.Util.Common).GetClientIP()，查询到有其他电脑配置了监听，造成被其他电脑抢走了。\n3.上传过快造成未接收完标本已经上传，造成漏项目问题，判断接收5s内不上传。遇到偶发问题，上传时间与接收时间为0甚至上传时间比接收时间早1s，判断是事务未完成已经发送。设置上传时间大于-2秒不上传。\n报警信息过长保存到其他结果字段时造成无法保存仪器结果 报警信息存放在结果说明字段，会将结果说明字段发送给临床医生，很多医院要求报警信息不发送给临床医生，因此将报警信息存放至其他结果字段。然而其他结果字段，在dbo.RPMachineResult仪器结果表和dbo.RPMachineResultLog仪器结果日志表中字段OtherRes设置长度较短，就会造成存储时报错但是前台没有任何提示。扩长后可以正常的对应到结果。\n如果仪器维护报警结果不传输，如果没有结果，其他结果也不会赋值，因此要根据实际进行判断，如果有报警信息但是没有结果，设置结果为ERR，报警信息就可以正常的保存显示。\n同时存在大量标本，查询速度过慢，造成堆积无法正常上传项目 批量手工登记，造成同时存在超多标本等待上传，由于主动上传查询query中，包含申请项目上传，复查项目上传，回退项目上传和审核项目上传，造成查询速度过慢\n监听查询等待时间为60s，如果超过时间认为查询超时，就不再等待进行上传，会提示查询错误超过50次。因此对于接口进行处理，申请项目上传分批上传，超过10个就停止查询直接输出。\n‍\n","date":"2025-08-28T00:00:00Z","image":"https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-20250828182020/assets/image-20250403125731-kgqb3bk_hu_b500dc94302cab34.png","permalink":"https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-20250828182020/","title":"罗氏流水线IT3000"}]
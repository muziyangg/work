/// d ##class(MI.TEST.TEST).SaveChannel()
ClassMethod SaveChannel()
{
	s machine="86"			// 仪器DR
	s SaveType="2"			// 1.细菌，2.抗生素
	s IsSave="0"			// 0.查看，1.保存
	s matchingType="1^1^0"	// 匹配方式(0,1)名称,英文名称,通道号(whonet码)
	
	i SaveType=1 s logName="/dthealth/app/dthis/imedicallis/imedicallis/tmp/File/细菌导入模板.csv"
	i SaveType=2 s logName="/dthealth/app/dthis/imedicallis/imedicallis/tmp/File/抗生素导入模板.csv"
	
	i '$d(^dbo.BTMIMachineParameterD(machine)) q
	s machineName=$lg($g(^dbo.BTMIMachineParameterD(machine)),3)
	if SaveType=1 s SaveTypeName="细菌"
	if SaveType=2 s SaveTypeName="抗生素"
	
	w "保存仪器为:"_machineName,!
	w "保存方式为:"_SaveTypeName,!
	w "读取路径为:"_logName,!
	r "是否继续(Y/N)",GoTo
	i ##Class(OTH.SYSParameter).MIUPPER(GoTo)'="Y" q
	
	s file=##class(%File).%New(logName)
	s status=file.Open("RU")
	i status'=1 d file.Close() w status q ""
	set AllStr = file.Read(, .sc)
	
	i '$l(matchingType) s matchingType="1^^"
	s num=0				// 匹配数
	s linenum=0			// 获取数
	s savenum=0			// 保存数
	for i=1:1:$l(AllStr,$c(13,10)) d
	.s Str=$p(AllStr,$c(13,10),i)
	.i '$l($tr(Str,",")) q
	.if SaveType=1 d SaveOrganism
	.if SaveType=2 d SaveAntiBug
	.s linenum=linenum+1
	
	w "共获取"_SaveTypeName_"数:"_linenum,!
	w "共匹配"_SaveTypeName_"数:"_num,!
	w "共保存"_SaveTypeName_"数:"_savenum,!
	
	d file.Close()
	q ""
	
SaveOrganism
	s Organism=$p(Str,",",1)		//通道号
	s bugname=$p(Str,",",2)		//名称
	s Engbugname=$p(Str,",",3)	//拉丁文

	s QuitFlag=0
	s ret="0" 
	// dbo.BTAntibiotics            Index IndexCode On Code
	// dbo.BTMIMachineMicroAntiBio  Index IndexMaster On (MachineParameterDR, AntibioticsDR, MachineAntiBiotic)
	// dbo.BTOrganism               Index IndexCode On Code 
	// dbo.BTMIMachineMicroBugs     Index IndexMaster On (MachineParameterDR, OrganismDR, MachineBug)  
	S Code="" F  S Code=$O(^dbo.BTOrganismI("IndexCode",Code)) Q:((Code="")||(QuitFlag=1))  D
	.S OrganismDR="" F  S OrganismDR=$O(^dbo.BTOrganismI("IndexCode",Code,OrganismDR)) Q:((OrganismDR="")||(QuitFlag=1))  D 
	..s sysbugname=$LG($G(^dbo.BTOrganismD(OrganismDR)),3)
	..s sysEngbugname=$LG($G(^dbo.BTOrganismD(OrganismDR)),4)
	..s sysOrganism=$LG($G(^dbo.BTOrganismD(OrganismDR)),6)
	..s Active=$LG($G(^dbo.BTOrganismD(OrganismDR)),14)
	..i Active'=1 q
	..s SaveFlag=0
	..I $p(matchingType,"^",1),sysbugname=bugname s SaveFlag=1
	..i $p(matchingType,"^",2),$l(Engbugname),(##Class(OTH.SYSParameter).MIUPPER(sysEngbugname)=##Class(OTH.SYSParameter).MIUPPER(Engbugname)) s SaveFlag=1
	..i $p(matchingType,"^",3),(##Class(OTH.SYSParameter).MIUPPER(sysOrganism)=##Class(OTH.SYSParameter).MIUPPER(Organism)) s SaveFlag=1
	..i SaveFlag'=1 q
	..;s AntiBug=##Class(OTH.SYSParameter).MIUPPER(AntiBug)
	..i $d(^dbo.BTMIMachineMicroBugsI("IndexMaster",machine,OrganismDR)) q
	..i $d(^dbo.BTMIMachineMicroBugsI("IndexChannel",machine,Organism)) q
	..s obj=##Class(dbo.BTMIMachineMicroBugs).%New()
	..s obj.OrganismDR=OrganismDR
	..s obj.MachineBug=Organism
	..S obj.MachineParameterDR=machine  		///35为仪器的主键
	..i IsSave=1 s ret=obj.%Save()
	..;zw $lb(sysOrganism,Organism,sysbugname,bugname,sysEngbugname,Engbugname,ret)
	..s QuitFlag=1
	..s num=num+1
	..i ret=1 s savenum=savenum+1
	
	zw $lb(Organism,bugname,Engbugname,ret)
	q ""
	
SaveAntiBug
	s AntiBug=$p(Str,",",1)		//通道号
	s bugname=$p(Str,",",2)		//名称
	s Engbugname=$p(Str,",",3)	//拉丁文

	s QuitFlag=0
	s ret="0" 
	// dbo.BTAntibiotics            Index IndexCode On Code
	// dbo.BTMIMachineMicroAntiBio  Index IndexMaster On (MachineParameterDR, AntibioticsDR, MachineAntiBiotic)
	// dbo.BTOrganism               Index IndexCode On Code 
	// dbo.BTMIMachineMicroBugs     Index IndexMaster On (MachineParameterDR, OrganismDR, MachineBug)  
	S Code="" F  S Code=$O(^dbo.BTAntibioticsI("IndexCode",Code)) Q:((Code="")||(QuitFlag=1))  D
	.S AntibioticsDR="" F  S AntibioticsDR=$O(^dbo.BTAntibioticsI("IndexCode",Code,AntibioticsDR)) Q:((AntibioticsDR="")||(QuitFlag=1))  D 
	..s sysbugname=$LG($G(^dbo.BTAntibioticsD(AntibioticsDR)),3)
	..s sysEngbugname=$LG($G(^dbo.BTAntibioticsD(AntibioticsDR)),4)
	..s sysAntiBug=$LG($G(^dbo.BTAntibioticsD(AntibioticsDR)),7)
	..s SaveFlag=0
	..I $p(matchingType,"^",1),sysbugname=bugname s SaveFlag=1
	..i $p(matchingType,"^",2),$l(Engbugname),(##Class(OTH.SYSParameter).MIUPPER(sysEngbugname)=##Class(OTH.SYSParameter).MIUPPER(Engbugname)) s SaveFlag=1
	..i $p(matchingType,"^",3),(##Class(OTH.SYSParameter).MIUPPER(sysAntiBug)=##Class(OTH.SYSParameter).MIUPPER(AntiBug)) s SaveFlag=1
	..i SaveFlag'=1 q
	..;s AntiBug=##Class(OTH.SYSParameter).MIUPPER(AntiBug)
	..i $d(^dbo.BTMIMachineMicroAntiBioI("IndexMaster",machine,AntibioticsDR)) q
	..i $d(^dbo.BTMIMachineMicroAntiBioI("IndexChannel",machine,AntiBug)) q
	..s obj=##Class(dbo.BTMIMachineMicroAntiBio).%New()
	..s obj.AntibioticsDR=AntibioticsDR
	..s obj.MachineAntiBiotic=AntiBug
	..S obj.MachineParameterDR=machine  
	..i IsSave=1 s ret=obj.%Save()
	..s QuitFlag=1
	..zw $lb(sysAntiBug,AntiBug,sysbugname,bugname,sysEngbugname,Engbugname,ret)
	..s num=num+1
	..i ret=1 s savenum=savenum+1
	
	;zw $lb(AntiBug,bugname,Engbugname,ret)
	
	q ""
}
<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="上机请求双向 HL7 协议接口双向 回传多行 DSP 回传信息时要求有 DSP 字段，且 DSP 字段前 28 行为患者信息，第 29 行之后为检测项目信息。\n示例接口(亚辉龙 3000) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 /// 名称: MI.MIFI3000 /// 描述: 深圳亚辉龙iFlash3000 双向仪器接口 MIFI3000(mi) S mi=$G(mi) Q:&#39;$L(mi) s par11=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s par10=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s par4=&#34;|TCP|&#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 S mi1=mi S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23) S sb=$C(11),eb=$C(28),cr=$C(13) S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=&#34;&#34;,kk=1 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType)=&#34;&#34; Q:$$StartUTF8^MI.MIF000(mi) F { D Main Q:$$Stop^MI.MIF000(mi) } C par4 Q Main S $ZT=&#34;ErrHandler&#34;,$EC=&#34;&#34; R *R:10 Q:&#39;$TEST //如果超时则退出 Q:$c(R)&#39;=sb //以sb开头 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType,msgType,barcode,mshStr)=&#34;&#34; S startTime=$P($H,&#34;,&#34;,2) K PLIST S index=1 F { S curTime=$P($H,&#34;,&#34;,2) Q:curTime&gt;(startTime+300) //5分钟内没有处理完则退出循环 Q:$$Stop^MI.MIF000(mi) R *R:10 Q:&#39;$TEST //如果超时则退出 I $L($G(PLIST(index)))&gt;=32700 { //32767 S index=+$O(PLIST(&#34;&#34;),-1)+1 S PLIST(index)=&#34;&#34; } I $C(R)&#39;=eb,$C(R)&#39;=cr { S PLIST(index)=$G(PLIST(index))_$C(R) } I $C(R)=cr { //解析一条记录 D Record K PLIST S index=1 } Q:$C(R)=eb //循环读取,当为eb的时候则退出 } D Save Q Record K ^TMPMACHINEEPIS(mi) S index=&#34;&#34; S segmentType=&#34;&#34;,dataTye=&#34;&#34;,graphType=&#34;&#34; S isImage=0,isBinary=0 F { S index=$O(PLIST(index)) Q:&#39;$L(index) S record=$TR($G(PLIST(index)),cr) Continue:&#39;$L(record) D Trace^MI.MIF000(mi,record,&#34;H&lt;--M&#34;) I index=1 { S segmentType=$P(record,&#34;|&#34;,1) ;消息段(数据类型) MSH\tMSA PID OBR OBX ORD QRF ERR QAK DSP DSC I segmentType=&#34;MSH&#34; { //信息头信息 S mshStr=record //消息类型 S msgType=$P($P(record,&#34;|&#34;,9),&#34;^&#34;,1) //ORU,ACK,QRY,QCK,DSR I msgType=&#34;ORU&#34; { D SendACK(mi,record,&#34;AA&#34;,0,&#34;Message accepted&#34;) } I msgType=&#34;ORM&#34; { } I msgType=&#34;QRY&#34; { D SendQryACK(mi,record,&#34;AA&#34;,0,&#34;Message accepted&#34;) } S resultType=$P(record,&#34;|&#34;,11) } I segmentType=&#34;PID&#34; { //患者信息 } I segmentType=&#34;PVI&#34; { //就诊信息 } I segmentType=&#34;OBR&#34; { //医嘱信息 S epis=$P(record,&#34;|&#34;,3) S:&#39;$l(epis) epis=$P(record,&#34;|&#34;,4) S dateStr=$P(record,&#34;|&#34;,8) I dateStr?14N { S date=$ZDH($E(dateStr,1,4)_&#34;-&#34;_$E(dateStr,5,6)_&#34;-&#34;_$E(dateStr,7,8),3) S time=$ZTH($E(dateStr,9,10)_&#34;:&#34;_$E(dateStr,11,12)_&#34;:&#34;_$E(dateStr,13,14),1) } S code=$P($P(record,&#34;|&#34;,5),&#34;^&#34;,1) } I segmentType=&#34;OBX&#34; { S dataTye=$P(record,&#34;|&#34;,3) //NM (numeric) 表示数字值，用于定量项目, //ST (string) 表示字符串值，用于定性项目 S channel=$P(record,&#34;|&#34;,4) S channel=$P(channel,&#34;^&#34;,1) S value=$P(record,&#34;|&#34;,6) I $L(channel),dataTye&#39;=&#34;ED&#34;,dataTye&#39;=&#34;IS&#34; { S result=result_channel_par10_value_par11 } } //根据条码号获取LIS标本 I segmentType=&#34;QRD&#34; { S barcode=$P(record,&#34;|&#34;,9) //QRD|20161208150935|R|D|1|||RD|16120703726|OTH|||T| I $L(barcode) { S ^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;MSH&#34;)=mshStr S ^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;QRD&#34;)=record } } //根据查询条件获取LIS标本 I segmentType=&#34;QRF&#34; { S tRecord=record S record=$TR(record,&#34; &#34;) S qryStartDate=$P(record,&#34;|&#34;,3) S qryEndDate=$P(record,&#34;|&#34;,4) S sampleIdStart=$P(record,&#34;|&#34;,5) S sampleIdEnd=$P(record,&#34;|&#34;,6) S:&#39;$L(qryStartDate) qryStartDate=qryEndDate S:&#39;$L(qryEndDate) qryEndDate=qryStartDate S:&#39;$L(sampleIdStart) sampleIdStart=sampleIdEnd S:&#39;$L(sampleIdEnd) sampleIdEnd=sampleIdStart //通过样本号段查询 QRF|iFlash3000|||1|9|RCT|COR|ALL|| I sampleIdStart?1.N,sampleIdEnd?1.N { F sampleId=sampleIdStart:1:sampleIdEnd { S ^TMPMACHINEEPIS(mi,&#34;S&#34;,sampleId,&#34;MSH&#34;)=mshStr S ^TMPMACHINEEPIS(mi,&#34;S&#34;,sampleId,&#34;QRF&#34;)=tRecord } } //通过时间段查询\tQRF|iFlash3000|20160122080000|20160122120000|||RCT|COR|ALL|| I qryStartDate?1.N,qryEndDate?1.N { F qryDate=qryStartDate:1:qryEndDate { S ^TMPMACHINEEPIS(mi,&#34;D&#34;,qryDate,&#34;MSH&#34;)=mshStr S ^TMPMACHINEEPIS(mi,&#34;D&#34;,qryDate,&#34;QRF&#34;)=tRecord } } } } } //根本样本号获取条码号 S sampleId=&#34;&#34; F { S sampleId=$O(^TMPMACHINEEPIS(mi,&#34;B&#34;,sampleId)) Q:&#39;$L(sampleId) //暂不处理 } //根本日期获取条码号 S qryDate=&#34;&#34; F { S qryDate=$O(^TMPMACHINEEPIS(mi,&#34;D&#34;,qryDate)) Q:&#39;$L(qryDate) //暂不处理 } //上传标本 S barcode=&#34;&#34;,barcodeIndex=0 F { S barcode=$O(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode)) Q:&#39;$L(barcode) S mshStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode)) S barcodeIndex=barcodeIndex+1 I $O(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode))=&#34;&#34; { S barcodeIndex=&#34;&#34; //最后一个为空 } S mshStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;MSH&#34;)) S qrdStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;QRD&#34;)) S qrfStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;QRF&#34;)) I &#39;$L(qrdStr) { S qrdStr=&#34;QRD|&#34;_$TR($ZDT($H,8),&#34; :&#34;)_&#34;|R|D|1|||RD||OTH|||T|&#34; } I &#39;$L(qrfStr) { S qrfStr=&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34; } S $P(qrdStr,&#34;|&#34;,9)=&#34;&#34; S ret=$$SendOrder(mi,mshStr,qrdStr,qrfStr,barcode,barcodeIndex) } K ^TMPMACHINEEPIS(mi) Q Save D Trace^MI.MIF000(mi,epis_&#34;^&#34;_result,&#34;Test&#34;) I $l(epis),$l(result) { S QC=&#34;&#34; ;S result=$$TransResult(mi,result) D Save^MI.MIF000(mi,epis,result,date,time,QC) } S (sample,epis,surname,rec,res,result,date,time,QC,resultType)=&#34;&#34; Q SendACK(mi,mshStr,ackType=&#34;AA&#34;,errCode=0,errDesc=&#34;Message accepted&#34;) //send &#39;ack&#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(&#39;$l(mi))||(&#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,&#34;&#34;) //Q:$l(mshStr,&#34;|&#34;)&lt;21 ret S ret=0 S msgRoutine=$P($P(mshStr,&#34;|&#34;,9),&#34;^&#34;,2) S seq=$P(mshStr,&#34;|&#34;,10) S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S $P(mshStr,&#34;|&#34;,9)=&#34;ACK^&#34;_msgRoutine W sb,mshStr,cr,&#34;MSA|&#34;_ackType_&#34;|&#34;_seq_&#34;|&#34;_errDesc_&#34;|||&#34;_errCode_&#34;|&#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=&#34;AA&#34;:&#34;ACK&#34;,ackType=&#34;AE&#34;:&#34;Error&#34;,ackType=&#34;AR&#34;:&#34;NAK&#34;,1:&#34;NULL&#34;),&#34;H--&gt;M&#34;) Q ret SendQryACK(mi,mshStr,ackType=&#34;AA&#34;,errCode=0,errDesc=&#34;Message accepted&#34;) //send &#39;ack&#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(&#39;$l(mi))||(&#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,&#34;&#34;) S ret=0 S msgRoutine=$P($P(mshStr,&#34;|&#34;,9),&#34;^&#34;,2) S seq=$P(mshStr,&#34;|&#34;,10) S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S $P(mshStr,&#34;|&#34;,9)=&#34;QCK^&#34;_msgRoutine W sb,mshStr,cr,&#34;MSA|&#34;_ackType_&#34;|&#34;_seq_&#34;|&#34;_errDesc_&#34;|||&#34;_errCode_&#34;|&#34;,cr,&#34;ERR|0|&#34;,cr,&#34;QAK|SR|OK|&#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=&#34;AA&#34;:&#34;QACK&#34;,ackType=&#34;AE&#34;:&#34;Error&#34;,ackType=&#34;AR&#34;:&#34;QNAK&#34;,1:&#34;NULL&#34;),&#34;H--&gt;M&#34;) Q ret ErrHandler h 10 D Trace^MI.MIF000(mi,$TR($ZERROR,&#34;^&#34;,&#34;--&#34;)_&#34;.错误代码:&#34;_$ECODE,&#34;Runtime Error&#34;) Q //双向上传医嘱信息,wwh,2015-11-05 SendOrder(mi,mshStr,qrdStr,qrfStr,barcode,DSC) N (mi,mshStr,qrdStr,qrfStr,barcode,DSC) S mi=$G(mi),mshStr=$G(mshStr),barcode=$G(barcode),DSC=$G(DSC),qrdStr=$G(qrdStr),qrfStr=$G(qrfStr) S sb=$C(11),eb=$C(28),cr=$C(13) I &#39;$L(barcode) { D Trace^MI.MIF000(mi,&#34;条码号为空&#34;,&#34;Upload Error&#34;) Q 1 } I $ZCVT(barcode,&#34;U&#34;)=$ZCVT(&#34;Invalid&#34;,&#34;U&#34;) { //条码扫描错误 D Trace^MI.MIF000(mi,&#34;条码扫描错误,机器未识别&#34;,&#34;Upload Error&#34;) Q 1 } S labno=barcode S workGroupMachineDR=$LG($G(^dbo.BTMIMachineParameterD(mi)),6) S visiNumberDR=$O(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) I &#39;$L(visiNumberDR) { D Trace^MI.MIF000(mi,&#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,&#34;Upload Error&#34;) Q 1 } S visNumberObj=##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR) I &#39;$L(visNumberObj) { D Trace^MI.MIF000(mi,&#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,&#34;Upload Error&#34;) Q 1 } D Trace^MI.MIF000(mi,labno,&#34;Upload Start&#34;) K ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) D ScanOne^MI.MIF000(mi,labno) S result=&#34;&#34; S chlStr=&#34;&#34; S chl=&#34;&#34;,chlCnt=29 F { S chl=$O(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) Q:&#39;$L(chl) S chlStr=chlStr_&#34;DSP|&#34;_chlCnt_&#34;||&#34;_chl_&#34;^^^|||&#34;_cr S chlCnt=chlCnt+1 ;S result=result_chl_$C(92)_&#34;?&#34;_$C(44) } I &#39;$L(chlStr) { D Trace^MI.MIF000(mi,&#34;在检验系统未找到条码:&#34;_labno_&#34;对应的化验项目信息,确定医嘱或项目维护正确?&#34;,&#34;Upload Error&#34;) Q 1 } D Save^MI.MIF000(mi,labno,result,&#34;&#34;,&#34;&#34;,&#34;&#34;) S specimenDR=$LG($G(^dbo.RPVisitNumberD(visiNumberDR)),56) S specimenName=&#34;&#34; S:$L(specimenDR) specimenName=$LG($G(^dbo.BTSpecimenD(specimenDR)),3) S sampleType=&#34;其他&#34; I $L(specimenName),&#34;,血清,血浆,尿液,脑脊液,&#34;[(&#34;,&#34;_specimenName_&#34;,&#34;) { S sampleType=specimenName } S birdthday=visNumberObj.BirthDate S:$L(birdthday)=8 birdthday=birdthday_&#34;000000&#34; S:&#39;$L(mshStr) mshStr=&#34;MSH|^~\\&amp;|YHLO|iFlash3000|||20161208150935||QRY^Q02|18|P|2.3.1||||||ASCII|||&#34; S mshSeq=$P(mshStr,&#34;|&#34;,10) S $P(mshStr,&#34;|&#34;,9)=&#34;DSR^Q03&#34; S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S episode=&#34;&#34; S workGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) //##Class(MI.Instrument).GetWorkGroupMachineRowId(mi) I $L(workGroupMachineDR) { S OrderNo=$O(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,visiNumberDR,workGroupMachineDR,&#34;&#34;)) I $L(OrderNo) { S reportDR=$O(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,visiNumberDR,workGroupMachineDR,OrderNo,&#34;&#34;)) S episode=&#34;&#34; //##Class(LIS.Core.Report).GetEpisodeNumber(reportDR) i $l(reportDR) s Assayno=$lg($g(^dbo.RPVisitNumberReportD(reportDR)),6) } } S order=mshStr_cr //&#34;MSH|^~\\&amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||&#34;_cr S order=order_&#34;MSA|AA|&#34;_mshSeq_&#34;|Message accepted|||0|&#34;_cr S order=order_&#34;ERR|0|&#34;_cr S order=order_&#34;QAK|SR|OK|&#34;_cr S order=order_qrdStr_cr //&#34;QRD|20160122110540|R|D|1|||RD||OTH|||T|&#34;_cr S order=order_qrfStr_cr //&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34;_cr S order=order_&#34;DSP|1||&#34;_visNumberObj.RegNo_&#34;|||&#34;_cr\t//住院号 S order=order_&#34;DSP|2||&#34;_visNumberObj.BedNo_&#34;|||&#34;_cr\t//床号 S order=order_&#34;DSP|3||&#34;_visNumberObj.SurName_&#34;|||&#34;_cr\t//病人姓名 /* S order=order_&#34;DSP|1||&#34;_visNumberObj.RegNo_&#34;|||&#34;_cr\t//住院号 S order=order_&#34;DSP|2||&#34;_episode_&#34;|||&#34;_cr\t//床号 //S order=order_&#34;DSP|3||&#34;_visNumberObj.SurName_&#34;|||&#34;_cr\t//病人姓名 S order=order_&#34;DSP|3||&#34;_episode_&#34;|||&#34;_cr\t//病人姓名 */ S order=order_&#34;DSP|4||&#34;_birdthday_&#34;|||&#34;_cr\t//出生日期 S order=order_&#34;DSP|5||&#34;_$S(visNumberObj.SpeciesDR=1:&#34;M&#34;,visNumberObj.SpeciesDR=2:&#34;F&#34;,1:&#34;O&#34;)_&#34;|||&#34;_cr\t//性别 S order=order_&#34;DSP|6|||||&#34;_cr\t//血型 S order=order_&#34;DSP|7|||||&#34;_cr\t//种族 S order=order_&#34;DSP|8|||||&#34;_cr\t//地址 S order=order_&#34;DSP|9|||||&#34;_cr\t//邮编 S order=order_&#34;DSP|10|||||&#34;_cr\t//家庭电话 S order=order_&#34;DSP|11|||||&#34;_cr\t//样本位 S order=order_&#34;DSP|12|||||&#34;_cr\t//样本采集时间 S order=order_&#34;DSP|13|||||&#34;_cr\t//未用 S order=order_&#34;DSP|14|||||&#34;_cr\t//未用 S order=order_&#34;DSP|15|||||&#34;_cr\t//病人类别 S order=order_&#34;DSP|16|||||&#34;_cr\t//医保帐号 S order=order_&#34;DSP|17|||||&#34;_cr\t//收费类型 S order=order_&#34;DSP|18|||||&#34;_cr\t//民族 S order=order_&#34;DSP|19|||||&#34;_cr\t//籍贯 S order=order_&#34;DSP|20|||||&#34;_cr\t//国家 S order=order_&#34;DSP|21||&#34;_barcode_&#34;|||&#34;_cr\t//*样本条码 S order=order_&#34;DSP|22||&#34;_barcode_&#34;|||&#34;_cr\t//*样本编号 S order=order_&#34;DSP|23|||||&#34;_cr\t//送检时间 S order=order_&#34;DSP|24||&#34;_$S(visNumberObj.Urgent=1:&#34;Y&#34;,1:&#34;N&#34;)_&#34;|||&#34;_cr\t//*是否急诊 S order=order_&#34;DSP|25|||||&#34;_cr\t//未用 S order=order_&#34;DSP|26||&#34;_sampleType_&#34;|||&#34;_cr\t//*样本类型(血清,血浆,尿液,脑脊液,其他) S order=order_&#34;DSP|27|||||&#34;_cr\t//送检医生 S order=order_&#34;DSP|28|||||&#34;_cr\t//送检科室 S order=order_chlStr S order=order_&#34;DSC|&#34;_DSC_&#34;|&#34;_cr W sb,order,eb,cr,*-3 D Trace^MI.MIF000(mi,sb_order_eb_cr,&#34;H--&gt;M&#34;) //$TR($ZDT($H,8),&#34; :&#34;) Q 0 //d Test^MI.MIFIFLASH3000N(&#34;22&#34;,9000000266) Test(mi,barcode) N (mi,barcode) S mi=$G(mi),barcode=$G(barcode) S mshStr=&#34;MSH|^~\\&amp;|YHLO|iFlash3000|||20160122110540||QRY^Q02|14|P|2.3.1||||||ASCII|||&#34; S DSC=&#34;&#34; S qrdStr=&#34;QRD|20160122110540|R|D|1|||RD|BarCode1|OTH|||T|&#34; S qrfStr=&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34; S sb=&#34;&lt;SB&gt;&#34;,eb=&#34;&lt;EB&gt;&#34;,cr=&#34;&lt;CR&gt;&#34; I &#39;$L(barcode) { W &#34;条码号为空&#34;,! Q 1 } I $ZCVT(barcode,&#34;U&#34;)=$ZCVT(&#34;Invalid&#34;,&#34;U&#34;) { //条码扫描错误 W &#34;条码扫描错误,机器未识别&#34;,! Q 1 } S labno=barcode S workGroupMachineDR=$LG($G(^dbo.BTMIMachineParameterD(mi)),6) S visiNumberDR=$O(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) I &#39;$L(visiNumberDR) { W &#34;条码未接收&#34;,! Q 1 } I &#39;$L(visiNumberDR) { W &#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,! Q 1 } S visNumberObj=##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR) I &#39;$L(visNumberObj) { W &#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,! Q 1 } K ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) D ScanOne^MI.MIF000(mi,labno) S chlStr=&#34;&#34; b ;a102 S chl=&#34;&#34;,chlCnt=29 F { S chl=$O(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) Q:&#39;$L(chl) S chlStr=chlStr_&#34;DSP|&#34;_chlCnt_&#34;||&#34;_chl_&#34;^^^|||&#34;_cr S chlCnt=chlCnt+1 } I &#39;$L(chlStr) { W &#34;在检验系统未找到条码:&#34;_labno_&#34;对应的化验项目信息,确定医嘱或项目维护正确?&#34;,! Q 1 } S specimenDR=$LG($G(^dbo.RPVisitNumberD(visiNumberDR)),56) S specimenName=&#34;&#34; S:$L(specimenDR) specimenName=$LG($G(^dbo.BTSpecimenD(specimenDR)),3) S sampleType=&#34;其他&#34; I $L(specimenName),&#34;,血清,血浆,尿液,脑脊液,&#34;[(&#34;,&#34;_specimenName_&#34;,&#34;) { S sampleType=specimenName } S birdthday=visNumberObj.BirthDate S:$L(birdthday)=8 birdthday=birdthday_&#34;000000&#34; S mshSeq=$P(mshStr,&#34;|&#34;,10) S $P(mshStr,&#34;|&#34;,9)=&#34;DSR^Q03&#34; S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S order=mshStr_cr //&#34;MSH|^~\\&amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||&#34;_cr S order=order_&#34;MSA|AA|&#34;_mshSeq_&#34;|Message accepted|||0|&#34;_cr S order=order_&#34;ERR|0|&#34;_cr S order=order_&#34;QAK|SR|OK|&#34;_cr S order=order_qrdStr_cr //&#34;QRD|20160122110540|R|D|1|||RD||OTH|||T|&#34;_cr S order=order_qrfStr_cr //&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34;_cr S order=order_&#34;DSP|1||&#34;_visNumberObj.RegNo_&#34;|||&#34;_cr\t//住院号 S order=order_&#34;DSP|2||&#34;_visNumberObj.BedNo_&#34;|||&#34;_cr\t//床号 S order=order_&#34;DSP|3||&#34;_visNumberObj.SurName_&#34;|||&#34;_cr\t//病人姓名 b ;a101 S order=order_&#34;DSP|4||&#34;_birdthday_&#34;|||&#34;_cr\t//出生日期 S order=order_&#34;DSP|5||&#34;_$S(visNumberObj.SpeciesDR=1:&#34;M&#34;,visNumberObj.SpeciesDR=2:&#34;F&#34;,1:&#34;O&#34;)_&#34;|||&#34;_cr\t//性别 S order=order_&#34;DSP|6|||||&#34;_cr\t//血型 S order=order_&#34;DSP|7|||||&#34;_cr\t//种族 S order=order_&#34;DSP|8|||||&#34;_cr\t//地址 S order=order_&#34;DSP|9|||||&#34;_cr\t//邮编 S order=order_&#34;DSP|10|||||&#34;_cr\t//家庭电话 S order=order_&#34;DSP|11|||||&#34;_cr\t//样本位 S order=order_&#34;DSP|12|||||&#34;_cr\t//样本采集时间 S order=order_&#34;DSP|13|||||&#34;_cr\t//未用 S order=order_&#34;DSP|14|||||&#34;_cr\t//未用 S order=order_&#34;DSP|15|||||&#34;_cr\t//病人类别 S order=order_&#34;DSP|16|||||&#34;_cr\t//医保帐号 S order=order_&#34;DSP|17|||||&#34;_cr\t//收费类型 S order=order_&#34;DSP|18|||||&#34;_cr\t//民族 S order=order_&#34;DSP|19|||||&#34;_cr\t//籍贯 S order=order_&#34;DSP|20|||||&#34;_cr\t//国家 S order=order_&#34;DSP|21||&#34;_barcode_&#34;|||&#34;_cr\t//*样本条码 S order=order_&#34;DSP|22||&#34;_barcode_&#34;|||&#34;_cr\t//*样本编号 S order=order_&#34;DSP|23|||||&#34;_cr\t//送检时间 S order=order_&#34;DSP|24||&#34;_$S(visNumberObj.Urgent=1:&#34;Y&#34;,1:&#34;N&#34;)_&#34;|||&#34;_cr\t//*是否急诊 S order=order_&#34;DSP|25|||||&#34;_cr\t//未用 S order=order_&#34;DSP|26||&#34;_sampleType_&#34;|||&#34;_cr\t//*样本类型(血清,血浆,尿液,脑脊液,其他) S order=order_&#34;DSP|27|||||&#34;_cr\t//送检医生 S order=order_&#34;DSP|28|||||&#34;_cr\t//送检科室 S order=order_chlStr S order=order_&#34;DSC|&#34;_DSC_&#34;|&#34;_cr W sb,order,eb,cr,! Q 0 TransResult(miRowId,result) N (miRowId,result) S miRowId=$G(miRowId),result=$G(result),newRes=&#34;&#34; F i=1:1:$L(result,&#34;,&#34;) { S chlStr=$P(result,&#34;,&#34;,i) Continue:&#39;$L(chlStr) S chl=$P(chlStr,&#34;\\&#34;,1) S val=$P(chlStr,&#34;\\&#34;,2) Continue:&#39;$L(chl) S res=val I chl&gt;97,chl&lt;102,val&#39;[&#34;?&#34; { S res=$$GetQuaResult(miRowId,chl,val) } S newRes=newRes_chl_$C(92)_res_$C(44) } Q:$L(newRes) newRes Q result GetQuaResult(miRowId,chl,res) N (miRowId,chl,res) S miRowId=$G(miRowId),chl=$G(chl),res=$G(res) S:res?1&#34;.&#34;1.N res=&#34;0&#34;_res S orgRes=res S resPrefix=$E(res,1) S:&#34;&lt;&gt;&#34;&#39;[resPrefix resPrefix=&#34;&#34; I $L(resPrefix) { S res=$P(res,resPrefix,2) } Q:&#39;$L(chl) orgRes Q:(res&#39;?0.N1.&#34;.&#34;1.N)&amp;&amp;(res&#39;?1.N) orgRes S tcRefRowId=$O(^dbo.BTMIMachineTestCodeI(&#34;IndexResultChannel&#34;,miRowId,##Class(LIS.Util.Common).IndexData(chl),&#34;&#34;)) Q:&#39;$L(tcRefRowId) orgRes S tcRowId=$LG($G(^dbo.BTMIMachineTestCodeD(tcRefRowId)),3) Q:&#39;$L(tcRowId) orgRes S orderNo=$O(^dbo.BTTestCodeRangesI(&#34;IndexMaster&#34;,tcRowId,&#34;&#34;)) Q:&#39;$L(orderNo) orgRes S rangeDR=$O(^dbo.BTTestCodeRangesI(&#34;IndexMaster&#34;,tcRowId,orderNo,&#34;&#34;)) Q:&#39;$L(rangeDR) orgRes S rangeObj=##Class(dbo.BTTestCodeRanges).%OpenId(rangeDR) Q:&#39;$L(rangeObj) orgRes I res&gt;=rangeObj.ValueHigh { I resPrefix=&#34;&lt;&#34; { Q orgRes } Q &#34;阳性(&#34;_orgRes_&#34;)&#34; } ELSE { I resPrefix=&#34;&gt;&#34; { Q orgRes } } Q &#34;阴性(&#34;_orgRes_&#34;)&#34; ">
<title>双向接口程序整合</title>

<link rel='canonical' href='https://work.717170.xyz/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/'>

<link rel="stylesheet" href="/scss/style.min.03a781d9157f24b812ddd138de5660e9264f58b2adb326fa7d814bcd56b0e29c.css"><meta property='og:title' content="双向接口程序整合">
<meta property='og:description' content="上机请求双向 HL7 协议接口双向 回传多行 DSP 回传信息时要求有 DSP 字段，且 DSP 字段前 28 行为患者信息，第 29 行之后为检测项目信息。\n示例接口(亚辉龙 3000) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 /// 名称: MI.MIFI3000 /// 描述: 深圳亚辉龙iFlash3000 双向仪器接口 MIFI3000(mi) S mi=$G(mi) Q:&#39;$L(mi) s par11=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s par10=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s par4=&#34;|TCP|&#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 S mi1=mi S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23) S sb=$C(11),eb=$C(28),cr=$C(13) S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=&#34;&#34;,kk=1 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType)=&#34;&#34; Q:$$StartUTF8^MI.MIF000(mi) F { D Main Q:$$Stop^MI.MIF000(mi) } C par4 Q Main S $ZT=&#34;ErrHandler&#34;,$EC=&#34;&#34; R *R:10 Q:&#39;$TEST //如果超时则退出 Q:$c(R)&#39;=sb //以sb开头 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType,msgType,barcode,mshStr)=&#34;&#34; S startTime=$P($H,&#34;,&#34;,2) K PLIST S index=1 F { S curTime=$P($H,&#34;,&#34;,2) Q:curTime&gt;(startTime+300) //5分钟内没有处理完则退出循环 Q:$$Stop^MI.MIF000(mi) R *R:10 Q:&#39;$TEST //如果超时则退出 I $L($G(PLIST(index)))&gt;=32700 { //32767 S index=+$O(PLIST(&#34;&#34;),-1)+1 S PLIST(index)=&#34;&#34; } I $C(R)&#39;=eb,$C(R)&#39;=cr { S PLIST(index)=$G(PLIST(index))_$C(R) } I $C(R)=cr { //解析一条记录 D Record K PLIST S index=1 } Q:$C(R)=eb //循环读取,当为eb的时候则退出 } D Save Q Record K ^TMPMACHINEEPIS(mi) S index=&#34;&#34; S segmentType=&#34;&#34;,dataTye=&#34;&#34;,graphType=&#34;&#34; S isImage=0,isBinary=0 F { S index=$O(PLIST(index)) Q:&#39;$L(index) S record=$TR($G(PLIST(index)),cr) Continue:&#39;$L(record) D Trace^MI.MIF000(mi,record,&#34;H&lt;--M&#34;) I index=1 { S segmentType=$P(record,&#34;|&#34;,1) ;消息段(数据类型) MSH\tMSA PID OBR OBX ORD QRF ERR QAK DSP DSC I segmentType=&#34;MSH&#34; { //信息头信息 S mshStr=record //消息类型 S msgType=$P($P(record,&#34;|&#34;,9),&#34;^&#34;,1) //ORU,ACK,QRY,QCK,DSR I msgType=&#34;ORU&#34; { D SendACK(mi,record,&#34;AA&#34;,0,&#34;Message accepted&#34;) } I msgType=&#34;ORM&#34; { } I msgType=&#34;QRY&#34; { D SendQryACK(mi,record,&#34;AA&#34;,0,&#34;Message accepted&#34;) } S resultType=$P(record,&#34;|&#34;,11) } I segmentType=&#34;PID&#34; { //患者信息 } I segmentType=&#34;PVI&#34; { //就诊信息 } I segmentType=&#34;OBR&#34; { //医嘱信息 S epis=$P(record,&#34;|&#34;,3) S:&#39;$l(epis) epis=$P(record,&#34;|&#34;,4) S dateStr=$P(record,&#34;|&#34;,8) I dateStr?14N { S date=$ZDH($E(dateStr,1,4)_&#34;-&#34;_$E(dateStr,5,6)_&#34;-&#34;_$E(dateStr,7,8),3) S time=$ZTH($E(dateStr,9,10)_&#34;:&#34;_$E(dateStr,11,12)_&#34;:&#34;_$E(dateStr,13,14),1) } S code=$P($P(record,&#34;|&#34;,5),&#34;^&#34;,1) } I segmentType=&#34;OBX&#34; { S dataTye=$P(record,&#34;|&#34;,3) //NM (numeric) 表示数字值，用于定量项目, //ST (string) 表示字符串值，用于定性项目 S channel=$P(record,&#34;|&#34;,4) S channel=$P(channel,&#34;^&#34;,1) S value=$P(record,&#34;|&#34;,6) I $L(channel),dataTye&#39;=&#34;ED&#34;,dataTye&#39;=&#34;IS&#34; { S result=result_channel_par10_value_par11 } } //根据条码号获取LIS标本 I segmentType=&#34;QRD&#34; { S barcode=$P(record,&#34;|&#34;,9) //QRD|20161208150935|R|D|1|||RD|16120703726|OTH|||T| I $L(barcode) { S ^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;MSH&#34;)=mshStr S ^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;QRD&#34;)=record } } //根据查询条件获取LIS标本 I segmentType=&#34;QRF&#34; { S tRecord=record S record=$TR(record,&#34; &#34;) S qryStartDate=$P(record,&#34;|&#34;,3) S qryEndDate=$P(record,&#34;|&#34;,4) S sampleIdStart=$P(record,&#34;|&#34;,5) S sampleIdEnd=$P(record,&#34;|&#34;,6) S:&#39;$L(qryStartDate) qryStartDate=qryEndDate S:&#39;$L(qryEndDate) qryEndDate=qryStartDate S:&#39;$L(sampleIdStart) sampleIdStart=sampleIdEnd S:&#39;$L(sampleIdEnd) sampleIdEnd=sampleIdStart //通过样本号段查询 QRF|iFlash3000|||1|9|RCT|COR|ALL|| I sampleIdStart?1.N,sampleIdEnd?1.N { F sampleId=sampleIdStart:1:sampleIdEnd { S ^TMPMACHINEEPIS(mi,&#34;S&#34;,sampleId,&#34;MSH&#34;)=mshStr S ^TMPMACHINEEPIS(mi,&#34;S&#34;,sampleId,&#34;QRF&#34;)=tRecord } } //通过时间段查询\tQRF|iFlash3000|20160122080000|20160122120000|||RCT|COR|ALL|| I qryStartDate?1.N,qryEndDate?1.N { F qryDate=qryStartDate:1:qryEndDate { S ^TMPMACHINEEPIS(mi,&#34;D&#34;,qryDate,&#34;MSH&#34;)=mshStr S ^TMPMACHINEEPIS(mi,&#34;D&#34;,qryDate,&#34;QRF&#34;)=tRecord } } } } } //根本样本号获取条码号 S sampleId=&#34;&#34; F { S sampleId=$O(^TMPMACHINEEPIS(mi,&#34;B&#34;,sampleId)) Q:&#39;$L(sampleId) //暂不处理 } //根本日期获取条码号 S qryDate=&#34;&#34; F { S qryDate=$O(^TMPMACHINEEPIS(mi,&#34;D&#34;,qryDate)) Q:&#39;$L(qryDate) //暂不处理 } //上传标本 S barcode=&#34;&#34;,barcodeIndex=0 F { S barcode=$O(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode)) Q:&#39;$L(barcode) S mshStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode)) S barcodeIndex=barcodeIndex+1 I $O(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode))=&#34;&#34; { S barcodeIndex=&#34;&#34; //最后一个为空 } S mshStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;MSH&#34;)) S qrdStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;QRD&#34;)) S qrfStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;QRF&#34;)) I &#39;$L(qrdStr) { S qrdStr=&#34;QRD|&#34;_$TR($ZDT($H,8),&#34; :&#34;)_&#34;|R|D|1|||RD||OTH|||T|&#34; } I &#39;$L(qrfStr) { S qrfStr=&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34; } S $P(qrdStr,&#34;|&#34;,9)=&#34;&#34; S ret=$$SendOrder(mi,mshStr,qrdStr,qrfStr,barcode,barcodeIndex) } K ^TMPMACHINEEPIS(mi) Q Save D Trace^MI.MIF000(mi,epis_&#34;^&#34;_result,&#34;Test&#34;) I $l(epis),$l(result) { S QC=&#34;&#34; ;S result=$$TransResult(mi,result) D Save^MI.MIF000(mi,epis,result,date,time,QC) } S (sample,epis,surname,rec,res,result,date,time,QC,resultType)=&#34;&#34; Q SendACK(mi,mshStr,ackType=&#34;AA&#34;,errCode=0,errDesc=&#34;Message accepted&#34;) //send &#39;ack&#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(&#39;$l(mi))||(&#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,&#34;&#34;) //Q:$l(mshStr,&#34;|&#34;)&lt;21 ret S ret=0 S msgRoutine=$P($P(mshStr,&#34;|&#34;,9),&#34;^&#34;,2) S seq=$P(mshStr,&#34;|&#34;,10) S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S $P(mshStr,&#34;|&#34;,9)=&#34;ACK^&#34;_msgRoutine W sb,mshStr,cr,&#34;MSA|&#34;_ackType_&#34;|&#34;_seq_&#34;|&#34;_errDesc_&#34;|||&#34;_errCode_&#34;|&#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=&#34;AA&#34;:&#34;ACK&#34;,ackType=&#34;AE&#34;:&#34;Error&#34;,ackType=&#34;AR&#34;:&#34;NAK&#34;,1:&#34;NULL&#34;),&#34;H--&gt;M&#34;) Q ret SendQryACK(mi,mshStr,ackType=&#34;AA&#34;,errCode=0,errDesc=&#34;Message accepted&#34;) //send &#39;ack&#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(&#39;$l(mi))||(&#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,&#34;&#34;) S ret=0 S msgRoutine=$P($P(mshStr,&#34;|&#34;,9),&#34;^&#34;,2) S seq=$P(mshStr,&#34;|&#34;,10) S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S $P(mshStr,&#34;|&#34;,9)=&#34;QCK^&#34;_msgRoutine W sb,mshStr,cr,&#34;MSA|&#34;_ackType_&#34;|&#34;_seq_&#34;|&#34;_errDesc_&#34;|||&#34;_errCode_&#34;|&#34;,cr,&#34;ERR|0|&#34;,cr,&#34;QAK|SR|OK|&#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=&#34;AA&#34;:&#34;QACK&#34;,ackType=&#34;AE&#34;:&#34;Error&#34;,ackType=&#34;AR&#34;:&#34;QNAK&#34;,1:&#34;NULL&#34;),&#34;H--&gt;M&#34;) Q ret ErrHandler h 10 D Trace^MI.MIF000(mi,$TR($ZERROR,&#34;^&#34;,&#34;--&#34;)_&#34;.错误代码:&#34;_$ECODE,&#34;Runtime Error&#34;) Q //双向上传医嘱信息,wwh,2015-11-05 SendOrder(mi,mshStr,qrdStr,qrfStr,barcode,DSC) N (mi,mshStr,qrdStr,qrfStr,barcode,DSC) S mi=$G(mi),mshStr=$G(mshStr),barcode=$G(barcode),DSC=$G(DSC),qrdStr=$G(qrdStr),qrfStr=$G(qrfStr) S sb=$C(11),eb=$C(28),cr=$C(13) I &#39;$L(barcode) { D Trace^MI.MIF000(mi,&#34;条码号为空&#34;,&#34;Upload Error&#34;) Q 1 } I $ZCVT(barcode,&#34;U&#34;)=$ZCVT(&#34;Invalid&#34;,&#34;U&#34;) { //条码扫描错误 D Trace^MI.MIF000(mi,&#34;条码扫描错误,机器未识别&#34;,&#34;Upload Error&#34;) Q 1 } S labno=barcode S workGroupMachineDR=$LG($G(^dbo.BTMIMachineParameterD(mi)),6) S visiNumberDR=$O(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) I &#39;$L(visiNumberDR) { D Trace^MI.MIF000(mi,&#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,&#34;Upload Error&#34;) Q 1 } S visNumberObj=##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR) I &#39;$L(visNumberObj) { D Trace^MI.MIF000(mi,&#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,&#34;Upload Error&#34;) Q 1 } D Trace^MI.MIF000(mi,labno,&#34;Upload Start&#34;) K ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) D ScanOne^MI.MIF000(mi,labno) S result=&#34;&#34; S chlStr=&#34;&#34; S chl=&#34;&#34;,chlCnt=29 F { S chl=$O(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) Q:&#39;$L(chl) S chlStr=chlStr_&#34;DSP|&#34;_chlCnt_&#34;||&#34;_chl_&#34;^^^|||&#34;_cr S chlCnt=chlCnt+1 ;S result=result_chl_$C(92)_&#34;?&#34;_$C(44) } I &#39;$L(chlStr) { D Trace^MI.MIF000(mi,&#34;在检验系统未找到条码:&#34;_labno_&#34;对应的化验项目信息,确定医嘱或项目维护正确?&#34;,&#34;Upload Error&#34;) Q 1 } D Save^MI.MIF000(mi,labno,result,&#34;&#34;,&#34;&#34;,&#34;&#34;) S specimenDR=$LG($G(^dbo.RPVisitNumberD(visiNumberDR)),56) S specimenName=&#34;&#34; S:$L(specimenDR) specimenName=$LG($G(^dbo.BTSpecimenD(specimenDR)),3) S sampleType=&#34;其他&#34; I $L(specimenName),&#34;,血清,血浆,尿液,脑脊液,&#34;[(&#34;,&#34;_specimenName_&#34;,&#34;) { S sampleType=specimenName } S birdthday=visNumberObj.BirthDate S:$L(birdthday)=8 birdthday=birdthday_&#34;000000&#34; S:&#39;$L(mshStr) mshStr=&#34;MSH|^~\\&amp;|YHLO|iFlash3000|||20161208150935||QRY^Q02|18|P|2.3.1||||||ASCII|||&#34; S mshSeq=$P(mshStr,&#34;|&#34;,10) S $P(mshStr,&#34;|&#34;,9)=&#34;DSR^Q03&#34; S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S episode=&#34;&#34; S workGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) //##Class(MI.Instrument).GetWorkGroupMachineRowId(mi) I $L(workGroupMachineDR) { S OrderNo=$O(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,visiNumberDR,workGroupMachineDR,&#34;&#34;)) I $L(OrderNo) { S reportDR=$O(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,visiNumberDR,workGroupMachineDR,OrderNo,&#34;&#34;)) S episode=&#34;&#34; //##Class(LIS.Core.Report).GetEpisodeNumber(reportDR) i $l(reportDR) s Assayno=$lg($g(^dbo.RPVisitNumberReportD(reportDR)),6) } } S order=mshStr_cr //&#34;MSH|^~\\&amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||&#34;_cr S order=order_&#34;MSA|AA|&#34;_mshSeq_&#34;|Message accepted|||0|&#34;_cr S order=order_&#34;ERR|0|&#34;_cr S order=order_&#34;QAK|SR|OK|&#34;_cr S order=order_qrdStr_cr //&#34;QRD|20160122110540|R|D|1|||RD||OTH|||T|&#34;_cr S order=order_qrfStr_cr //&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34;_cr S order=order_&#34;DSP|1||&#34;_visNumberObj.RegNo_&#34;|||&#34;_cr\t//住院号 S order=order_&#34;DSP|2||&#34;_visNumberObj.BedNo_&#34;|||&#34;_cr\t//床号 S order=order_&#34;DSP|3||&#34;_visNumberObj.SurName_&#34;|||&#34;_cr\t//病人姓名 /* S order=order_&#34;DSP|1||&#34;_visNumberObj.RegNo_&#34;|||&#34;_cr\t//住院号 S order=order_&#34;DSP|2||&#34;_episode_&#34;|||&#34;_cr\t//床号 //S order=order_&#34;DSP|3||&#34;_visNumberObj.SurName_&#34;|||&#34;_cr\t//病人姓名 S order=order_&#34;DSP|3||&#34;_episode_&#34;|||&#34;_cr\t//病人姓名 */ S order=order_&#34;DSP|4||&#34;_birdthday_&#34;|||&#34;_cr\t//出生日期 S order=order_&#34;DSP|5||&#34;_$S(visNumberObj.SpeciesDR=1:&#34;M&#34;,visNumberObj.SpeciesDR=2:&#34;F&#34;,1:&#34;O&#34;)_&#34;|||&#34;_cr\t//性别 S order=order_&#34;DSP|6|||||&#34;_cr\t//血型 S order=order_&#34;DSP|7|||||&#34;_cr\t//种族 S order=order_&#34;DSP|8|||||&#34;_cr\t//地址 S order=order_&#34;DSP|9|||||&#34;_cr\t//邮编 S order=order_&#34;DSP|10|||||&#34;_cr\t//家庭电话 S order=order_&#34;DSP|11|||||&#34;_cr\t//样本位 S order=order_&#34;DSP|12|||||&#34;_cr\t//样本采集时间 S order=order_&#34;DSP|13|||||&#34;_cr\t//未用 S order=order_&#34;DSP|14|||||&#34;_cr\t//未用 S order=order_&#34;DSP|15|||||&#34;_cr\t//病人类别 S order=order_&#34;DSP|16|||||&#34;_cr\t//医保帐号 S order=order_&#34;DSP|17|||||&#34;_cr\t//收费类型 S order=order_&#34;DSP|18|||||&#34;_cr\t//民族 S order=order_&#34;DSP|19|||||&#34;_cr\t//籍贯 S order=order_&#34;DSP|20|||||&#34;_cr\t//国家 S order=order_&#34;DSP|21||&#34;_barcode_&#34;|||&#34;_cr\t//*样本条码 S order=order_&#34;DSP|22||&#34;_barcode_&#34;|||&#34;_cr\t//*样本编号 S order=order_&#34;DSP|23|||||&#34;_cr\t//送检时间 S order=order_&#34;DSP|24||&#34;_$S(visNumberObj.Urgent=1:&#34;Y&#34;,1:&#34;N&#34;)_&#34;|||&#34;_cr\t//*是否急诊 S order=order_&#34;DSP|25|||||&#34;_cr\t//未用 S order=order_&#34;DSP|26||&#34;_sampleType_&#34;|||&#34;_cr\t//*样本类型(血清,血浆,尿液,脑脊液,其他) S order=order_&#34;DSP|27|||||&#34;_cr\t//送检医生 S order=order_&#34;DSP|28|||||&#34;_cr\t//送检科室 S order=order_chlStr S order=order_&#34;DSC|&#34;_DSC_&#34;|&#34;_cr W sb,order,eb,cr,*-3 D Trace^MI.MIF000(mi,sb_order_eb_cr,&#34;H--&gt;M&#34;) //$TR($ZDT($H,8),&#34; :&#34;) Q 0 //d Test^MI.MIFIFLASH3000N(&#34;22&#34;,9000000266) Test(mi,barcode) N (mi,barcode) S mi=$G(mi),barcode=$G(barcode) S mshStr=&#34;MSH|^~\\&amp;|YHLO|iFlash3000|||20160122110540||QRY^Q02|14|P|2.3.1||||||ASCII|||&#34; S DSC=&#34;&#34; S qrdStr=&#34;QRD|20160122110540|R|D|1|||RD|BarCode1|OTH|||T|&#34; S qrfStr=&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34; S sb=&#34;&lt;SB&gt;&#34;,eb=&#34;&lt;EB&gt;&#34;,cr=&#34;&lt;CR&gt;&#34; I &#39;$L(barcode) { W &#34;条码号为空&#34;,! Q 1 } I $ZCVT(barcode,&#34;U&#34;)=$ZCVT(&#34;Invalid&#34;,&#34;U&#34;) { //条码扫描错误 W &#34;条码扫描错误,机器未识别&#34;,! Q 1 } S labno=barcode S workGroupMachineDR=$LG($G(^dbo.BTMIMachineParameterD(mi)),6) S visiNumberDR=$O(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) I &#39;$L(visiNumberDR) { W &#34;条码未接收&#34;,! Q 1 } I &#39;$L(visiNumberDR) { W &#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,! Q 1 } S visNumberObj=##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR) I &#39;$L(visNumberObj) { W &#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,! Q 1 } K ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) D ScanOne^MI.MIF000(mi,labno) S chlStr=&#34;&#34; b ;a102 S chl=&#34;&#34;,chlCnt=29 F { S chl=$O(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) Q:&#39;$L(chl) S chlStr=chlStr_&#34;DSP|&#34;_chlCnt_&#34;||&#34;_chl_&#34;^^^|||&#34;_cr S chlCnt=chlCnt+1 } I &#39;$L(chlStr) { W &#34;在检验系统未找到条码:&#34;_labno_&#34;对应的化验项目信息,确定医嘱或项目维护正确?&#34;,! Q 1 } S specimenDR=$LG($G(^dbo.RPVisitNumberD(visiNumberDR)),56) S specimenName=&#34;&#34; S:$L(specimenDR) specimenName=$LG($G(^dbo.BTSpecimenD(specimenDR)),3) S sampleType=&#34;其他&#34; I $L(specimenName),&#34;,血清,血浆,尿液,脑脊液,&#34;[(&#34;,&#34;_specimenName_&#34;,&#34;) { S sampleType=specimenName } S birdthday=visNumberObj.BirthDate S:$L(birdthday)=8 birdthday=birdthday_&#34;000000&#34; S mshSeq=$P(mshStr,&#34;|&#34;,10) S $P(mshStr,&#34;|&#34;,9)=&#34;DSR^Q03&#34; S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S order=mshStr_cr //&#34;MSH|^~\\&amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||&#34;_cr S order=order_&#34;MSA|AA|&#34;_mshSeq_&#34;|Message accepted|||0|&#34;_cr S order=order_&#34;ERR|0|&#34;_cr S order=order_&#34;QAK|SR|OK|&#34;_cr S order=order_qrdStr_cr //&#34;QRD|20160122110540|R|D|1|||RD||OTH|||T|&#34;_cr S order=order_qrfStr_cr //&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34;_cr S order=order_&#34;DSP|1||&#34;_visNumberObj.RegNo_&#34;|||&#34;_cr\t//住院号 S order=order_&#34;DSP|2||&#34;_visNumberObj.BedNo_&#34;|||&#34;_cr\t//床号 S order=order_&#34;DSP|3||&#34;_visNumberObj.SurName_&#34;|||&#34;_cr\t//病人姓名 b ;a101 S order=order_&#34;DSP|4||&#34;_birdthday_&#34;|||&#34;_cr\t//出生日期 S order=order_&#34;DSP|5||&#34;_$S(visNumberObj.SpeciesDR=1:&#34;M&#34;,visNumberObj.SpeciesDR=2:&#34;F&#34;,1:&#34;O&#34;)_&#34;|||&#34;_cr\t//性别 S order=order_&#34;DSP|6|||||&#34;_cr\t//血型 S order=order_&#34;DSP|7|||||&#34;_cr\t//种族 S order=order_&#34;DSP|8|||||&#34;_cr\t//地址 S order=order_&#34;DSP|9|||||&#34;_cr\t//邮编 S order=order_&#34;DSP|10|||||&#34;_cr\t//家庭电话 S order=order_&#34;DSP|11|||||&#34;_cr\t//样本位 S order=order_&#34;DSP|12|||||&#34;_cr\t//样本采集时间 S order=order_&#34;DSP|13|||||&#34;_cr\t//未用 S order=order_&#34;DSP|14|||||&#34;_cr\t//未用 S order=order_&#34;DSP|15|||||&#34;_cr\t//病人类别 S order=order_&#34;DSP|16|||||&#34;_cr\t//医保帐号 S order=order_&#34;DSP|17|||||&#34;_cr\t//收费类型 S order=order_&#34;DSP|18|||||&#34;_cr\t//民族 S order=order_&#34;DSP|19|||||&#34;_cr\t//籍贯 S order=order_&#34;DSP|20|||||&#34;_cr\t//国家 S order=order_&#34;DSP|21||&#34;_barcode_&#34;|||&#34;_cr\t//*样本条码 S order=order_&#34;DSP|22||&#34;_barcode_&#34;|||&#34;_cr\t//*样本编号 S order=order_&#34;DSP|23|||||&#34;_cr\t//送检时间 S order=order_&#34;DSP|24||&#34;_$S(visNumberObj.Urgent=1:&#34;Y&#34;,1:&#34;N&#34;)_&#34;|||&#34;_cr\t//*是否急诊 S order=order_&#34;DSP|25|||||&#34;_cr\t//未用 S order=order_&#34;DSP|26||&#34;_sampleType_&#34;|||&#34;_cr\t//*样本类型(血清,血浆,尿液,脑脊液,其他) S order=order_&#34;DSP|27|||||&#34;_cr\t//送检医生 S order=order_&#34;DSP|28|||||&#34;_cr\t//送检科室 S order=order_chlStr S order=order_&#34;DSC|&#34;_DSC_&#34;|&#34;_cr W sb,order,eb,cr,! Q 0 TransResult(miRowId,result) N (miRowId,result) S miRowId=$G(miRowId),result=$G(result),newRes=&#34;&#34; F i=1:1:$L(result,&#34;,&#34;) { S chlStr=$P(result,&#34;,&#34;,i) Continue:&#39;$L(chlStr) S chl=$P(chlStr,&#34;\\&#34;,1) S val=$P(chlStr,&#34;\\&#34;,2) Continue:&#39;$L(chl) S res=val I chl&gt;97,chl&lt;102,val&#39;[&#34;?&#34; { S res=$$GetQuaResult(miRowId,chl,val) } S newRes=newRes_chl_$C(92)_res_$C(44) } Q:$L(newRes) newRes Q result GetQuaResult(miRowId,chl,res) N (miRowId,chl,res) S miRowId=$G(miRowId),chl=$G(chl),res=$G(res) S:res?1&#34;.&#34;1.N res=&#34;0&#34;_res S orgRes=res S resPrefix=$E(res,1) S:&#34;&lt;&gt;&#34;&#39;[resPrefix resPrefix=&#34;&#34; I $L(resPrefix) { S res=$P(res,resPrefix,2) } Q:&#39;$L(chl) orgRes Q:(res&#39;?0.N1.&#34;.&#34;1.N)&amp;&amp;(res&#39;?1.N) orgRes S tcRefRowId=$O(^dbo.BTMIMachineTestCodeI(&#34;IndexResultChannel&#34;,miRowId,##Class(LIS.Util.Common).IndexData(chl),&#34;&#34;)) Q:&#39;$L(tcRefRowId) orgRes S tcRowId=$LG($G(^dbo.BTMIMachineTestCodeD(tcRefRowId)),3) Q:&#39;$L(tcRowId) orgRes S orderNo=$O(^dbo.BTTestCodeRangesI(&#34;IndexMaster&#34;,tcRowId,&#34;&#34;)) Q:&#39;$L(orderNo) orgRes S rangeDR=$O(^dbo.BTTestCodeRangesI(&#34;IndexMaster&#34;,tcRowId,orderNo,&#34;&#34;)) Q:&#39;$L(rangeDR) orgRes S rangeObj=##Class(dbo.BTTestCodeRanges).%OpenId(rangeDR) Q:&#39;$L(rangeObj) orgRes I res&gt;=rangeObj.ValueHigh { I resPrefix=&#34;&lt;&#34; { Q orgRes } Q &#34;阳性(&#34;_orgRes_&#34;)&#34; } ELSE { I resPrefix=&#34;&gt;&#34; { Q orgRes } } Q &#34;阴性(&#34;_orgRes_&#34;)&#34; ">
<meta property='og:url' content='https://work.717170.xyz/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/'>
<meta property='og:site_name' content='木子洋'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-09-03T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-09-03T23:20:57&#43;00:00'/><meta property='og:image' content='https://work.717170.xyz/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110220839-bac5x44.png' />
<meta name="twitter:title" content="双向接口程序整合">
<meta name="twitter:description" content="上机请求双向 HL7 协议接口双向 回传多行 DSP 回传信息时要求有 DSP 字段，且 DSP 字段前 28 行为患者信息，第 29 行之后为检测项目信息。\n示例接口(亚辉龙 3000) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 /// 名称: MI.MIFI3000 /// 描述: 深圳亚辉龙iFlash3000 双向仪器接口 MIFI3000(mi) S mi=$G(mi) Q:&#39;$L(mi) s par11=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符 s par10=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符 s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符 s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符 s par4=&#34;|TCP|&#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号 S mi1=mi S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23) S sb=$C(11),eb=$C(28),cr=$C(13) S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=&#34;&#34;,kk=1 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType)=&#34;&#34; Q:$$StartUTF8^MI.MIF000(mi) F { D Main Q:$$Stop^MI.MIF000(mi) } C par4 Q Main S $ZT=&#34;ErrHandler&#34;,$EC=&#34;&#34; R *R:10 Q:&#39;$TEST //如果超时则退出 Q:$c(R)&#39;=sb //以sb开头 S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType,msgType,barcode,mshStr)=&#34;&#34; S startTime=$P($H,&#34;,&#34;,2) K PLIST S index=1 F { S curTime=$P($H,&#34;,&#34;,2) Q:curTime&gt;(startTime+300) //5分钟内没有处理完则退出循环 Q:$$Stop^MI.MIF000(mi) R *R:10 Q:&#39;$TEST //如果超时则退出 I $L($G(PLIST(index)))&gt;=32700 { //32767 S index=+$O(PLIST(&#34;&#34;),-1)+1 S PLIST(index)=&#34;&#34; } I $C(R)&#39;=eb,$C(R)&#39;=cr { S PLIST(index)=$G(PLIST(index))_$C(R) } I $C(R)=cr { //解析一条记录 D Record K PLIST S index=1 } Q:$C(R)=eb //循环读取,当为eb的时候则退出 } D Save Q Record K ^TMPMACHINEEPIS(mi) S index=&#34;&#34; S segmentType=&#34;&#34;,dataTye=&#34;&#34;,graphType=&#34;&#34; S isImage=0,isBinary=0 F { S index=$O(PLIST(index)) Q:&#39;$L(index) S record=$TR($G(PLIST(index)),cr) Continue:&#39;$L(record) D Trace^MI.MIF000(mi,record,&#34;H&lt;--M&#34;) I index=1 { S segmentType=$P(record,&#34;|&#34;,1) ;消息段(数据类型) MSH\tMSA PID OBR OBX ORD QRF ERR QAK DSP DSC I segmentType=&#34;MSH&#34; { //信息头信息 S mshStr=record //消息类型 S msgType=$P($P(record,&#34;|&#34;,9),&#34;^&#34;,1) //ORU,ACK,QRY,QCK,DSR I msgType=&#34;ORU&#34; { D SendACK(mi,record,&#34;AA&#34;,0,&#34;Message accepted&#34;) } I msgType=&#34;ORM&#34; { } I msgType=&#34;QRY&#34; { D SendQryACK(mi,record,&#34;AA&#34;,0,&#34;Message accepted&#34;) } S resultType=$P(record,&#34;|&#34;,11) } I segmentType=&#34;PID&#34; { //患者信息 } I segmentType=&#34;PVI&#34; { //就诊信息 } I segmentType=&#34;OBR&#34; { //医嘱信息 S epis=$P(record,&#34;|&#34;,3) S:&#39;$l(epis) epis=$P(record,&#34;|&#34;,4) S dateStr=$P(record,&#34;|&#34;,8) I dateStr?14N { S date=$ZDH($E(dateStr,1,4)_&#34;-&#34;_$E(dateStr,5,6)_&#34;-&#34;_$E(dateStr,7,8),3) S time=$ZTH($E(dateStr,9,10)_&#34;:&#34;_$E(dateStr,11,12)_&#34;:&#34;_$E(dateStr,13,14),1) } S code=$P($P(record,&#34;|&#34;,5),&#34;^&#34;,1) } I segmentType=&#34;OBX&#34; { S dataTye=$P(record,&#34;|&#34;,3) //NM (numeric) 表示数字值，用于定量项目, //ST (string) 表示字符串值，用于定性项目 S channel=$P(record,&#34;|&#34;,4) S channel=$P(channel,&#34;^&#34;,1) S value=$P(record,&#34;|&#34;,6) I $L(channel),dataTye&#39;=&#34;ED&#34;,dataTye&#39;=&#34;IS&#34; { S result=result_channel_par10_value_par11 } } //根据条码号获取LIS标本 I segmentType=&#34;QRD&#34; { S barcode=$P(record,&#34;|&#34;,9) //QRD|20161208150935|R|D|1|||RD|16120703726|OTH|||T| I $L(barcode) { S ^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;MSH&#34;)=mshStr S ^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;QRD&#34;)=record } } //根据查询条件获取LIS标本 I segmentType=&#34;QRF&#34; { S tRecord=record S record=$TR(record,&#34; &#34;) S qryStartDate=$P(record,&#34;|&#34;,3) S qryEndDate=$P(record,&#34;|&#34;,4) S sampleIdStart=$P(record,&#34;|&#34;,5) S sampleIdEnd=$P(record,&#34;|&#34;,6) S:&#39;$L(qryStartDate) qryStartDate=qryEndDate S:&#39;$L(qryEndDate) qryEndDate=qryStartDate S:&#39;$L(sampleIdStart) sampleIdStart=sampleIdEnd S:&#39;$L(sampleIdEnd) sampleIdEnd=sampleIdStart //通过样本号段查询 QRF|iFlash3000|||1|9|RCT|COR|ALL|| I sampleIdStart?1.N,sampleIdEnd?1.N { F sampleId=sampleIdStart:1:sampleIdEnd { S ^TMPMACHINEEPIS(mi,&#34;S&#34;,sampleId,&#34;MSH&#34;)=mshStr S ^TMPMACHINEEPIS(mi,&#34;S&#34;,sampleId,&#34;QRF&#34;)=tRecord } } //通过时间段查询\tQRF|iFlash3000|20160122080000|20160122120000|||RCT|COR|ALL|| I qryStartDate?1.N,qryEndDate?1.N { F qryDate=qryStartDate:1:qryEndDate { S ^TMPMACHINEEPIS(mi,&#34;D&#34;,qryDate,&#34;MSH&#34;)=mshStr S ^TMPMACHINEEPIS(mi,&#34;D&#34;,qryDate,&#34;QRF&#34;)=tRecord } } } } } //根本样本号获取条码号 S sampleId=&#34;&#34; F { S sampleId=$O(^TMPMACHINEEPIS(mi,&#34;B&#34;,sampleId)) Q:&#39;$L(sampleId) //暂不处理 } //根本日期获取条码号 S qryDate=&#34;&#34; F { S qryDate=$O(^TMPMACHINEEPIS(mi,&#34;D&#34;,qryDate)) Q:&#39;$L(qryDate) //暂不处理 } //上传标本 S barcode=&#34;&#34;,barcodeIndex=0 F { S barcode=$O(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode)) Q:&#39;$L(barcode) S mshStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode)) S barcodeIndex=barcodeIndex+1 I $O(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode))=&#34;&#34; { S barcodeIndex=&#34;&#34; //最后一个为空 } S mshStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;MSH&#34;)) S qrdStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;QRD&#34;)) S qrfStr=$G(^TMPMACHINEEPIS(mi,&#34;B&#34;,barcode,&#34;QRF&#34;)) I &#39;$L(qrdStr) { S qrdStr=&#34;QRD|&#34;_$TR($ZDT($H,8),&#34; :&#34;)_&#34;|R|D|1|||RD||OTH|||T|&#34; } I &#39;$L(qrfStr) { S qrfStr=&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34; } S $P(qrdStr,&#34;|&#34;,9)=&#34;&#34; S ret=$$SendOrder(mi,mshStr,qrdStr,qrfStr,barcode,barcodeIndex) } K ^TMPMACHINEEPIS(mi) Q Save D Trace^MI.MIF000(mi,epis_&#34;^&#34;_result,&#34;Test&#34;) I $l(epis),$l(result) { S QC=&#34;&#34; ;S result=$$TransResult(mi,result) D Save^MI.MIF000(mi,epis,result,date,time,QC) } S (sample,epis,surname,rec,res,result,date,time,QC,resultType)=&#34;&#34; Q SendACK(mi,mshStr,ackType=&#34;AA&#34;,errCode=0,errDesc=&#34;Message accepted&#34;) //send &#39;ack&#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(&#39;$l(mi))||(&#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,&#34;&#34;) //Q:$l(mshStr,&#34;|&#34;)&lt;21 ret S ret=0 S msgRoutine=$P($P(mshStr,&#34;|&#34;,9),&#34;^&#34;,2) S seq=$P(mshStr,&#34;|&#34;,10) S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S $P(mshStr,&#34;|&#34;,9)=&#34;ACK^&#34;_msgRoutine W sb,mshStr,cr,&#34;MSA|&#34;_ackType_&#34;|&#34;_seq_&#34;|&#34;_errDesc_&#34;|||&#34;_errCode_&#34;|&#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=&#34;AA&#34;:&#34;ACK&#34;,ackType=&#34;AE&#34;:&#34;Error&#34;,ackType=&#34;AR&#34;:&#34;NAK&#34;,1:&#34;NULL&#34;),&#34;H--&gt;M&#34;) Q ret SendQryACK(mi,mshStr,ackType=&#34;AA&#34;,errCode=0,errDesc=&#34;Message accepted&#34;) //send &#39;ack&#39; to instrument N (mi,mshStr,ackType,errCode,errDesc) S mi=$g(mi),mshStr=$g(mshStr),ackType=$g(ackType),errCode=$g(errCode),errDesc=$g(errDesc) S ret=1,sb=$C(11),eb=$C(28),cr=$C(13) Q:(&#39;$l(mi))||(&#39;$l(mshStr)) ret S mshStr=$TR(mshStr,cr,&#34;&#34;) S ret=0 S msgRoutine=$P($P(mshStr,&#34;|&#34;,9),&#34;^&#34;,2) S seq=$P(mshStr,&#34;|&#34;,10) S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S $P(mshStr,&#34;|&#34;,9)=&#34;QCK^&#34;_msgRoutine W sb,mshStr,cr,&#34;MSA|&#34;_ackType_&#34;|&#34;_seq_&#34;|&#34;_errDesc_&#34;|||&#34;_errCode_&#34;|&#34;,cr,&#34;ERR|0|&#34;,cr,&#34;QAK|SR|OK|&#34;,cr,eb,cr,*-3 D Trace^MI.MIF000(mi,$S(ackType=&#34;AA&#34;:&#34;QACK&#34;,ackType=&#34;AE&#34;:&#34;Error&#34;,ackType=&#34;AR&#34;:&#34;QNAK&#34;,1:&#34;NULL&#34;),&#34;H--&gt;M&#34;) Q ret ErrHandler h 10 D Trace^MI.MIF000(mi,$TR($ZERROR,&#34;^&#34;,&#34;--&#34;)_&#34;.错误代码:&#34;_$ECODE,&#34;Runtime Error&#34;) Q //双向上传医嘱信息,wwh,2015-11-05 SendOrder(mi,mshStr,qrdStr,qrfStr,barcode,DSC) N (mi,mshStr,qrdStr,qrfStr,barcode,DSC) S mi=$G(mi),mshStr=$G(mshStr),barcode=$G(barcode),DSC=$G(DSC),qrdStr=$G(qrdStr),qrfStr=$G(qrfStr) S sb=$C(11),eb=$C(28),cr=$C(13) I &#39;$L(barcode) { D Trace^MI.MIF000(mi,&#34;条码号为空&#34;,&#34;Upload Error&#34;) Q 1 } I $ZCVT(barcode,&#34;U&#34;)=$ZCVT(&#34;Invalid&#34;,&#34;U&#34;) { //条码扫描错误 D Trace^MI.MIF000(mi,&#34;条码扫描错误,机器未识别&#34;,&#34;Upload Error&#34;) Q 1 } S labno=barcode S workGroupMachineDR=$LG($G(^dbo.BTMIMachineParameterD(mi)),6) S visiNumberDR=$O(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) I &#39;$L(visiNumberDR) { D Trace^MI.MIF000(mi,&#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,&#34;Upload Error&#34;) Q 1 } S visNumberObj=##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR) I &#39;$L(visNumberObj) { D Trace^MI.MIF000(mi,&#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,&#34;Upload Error&#34;) Q 1 } D Trace^MI.MIF000(mi,labno,&#34;Upload Start&#34;) K ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) D ScanOne^MI.MIF000(mi,labno) S result=&#34;&#34; S chlStr=&#34;&#34; S chl=&#34;&#34;,chlCnt=29 F { S chl=$O(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) Q:&#39;$L(chl) S chlStr=chlStr_&#34;DSP|&#34;_chlCnt_&#34;||&#34;_chl_&#34;^^^|||&#34;_cr S chlCnt=chlCnt+1 ;S result=result_chl_$C(92)_&#34;?&#34;_$C(44) } I &#39;$L(chlStr) { D Trace^MI.MIF000(mi,&#34;在检验系统未找到条码:&#34;_labno_&#34;对应的化验项目信息,确定医嘱或项目维护正确?&#34;,&#34;Upload Error&#34;) Q 1 } D Save^MI.MIF000(mi,labno,result,&#34;&#34;,&#34;&#34;,&#34;&#34;) S specimenDR=$LG($G(^dbo.RPVisitNumberD(visiNumberDR)),56) S specimenName=&#34;&#34; S:$L(specimenDR) specimenName=$LG($G(^dbo.BTSpecimenD(specimenDR)),3) S sampleType=&#34;其他&#34; I $L(specimenName),&#34;,血清,血浆,尿液,脑脊液,&#34;[(&#34;,&#34;_specimenName_&#34;,&#34;) { S sampleType=specimenName } S birdthday=visNumberObj.BirthDate S:$L(birdthday)=8 birdthday=birdthday_&#34;000000&#34; S:&#39;$L(mshStr) mshStr=&#34;MSH|^~\\&amp;|YHLO|iFlash3000|||20161208150935||QRY^Q02|18|P|2.3.1||||||ASCII|||&#34; S mshSeq=$P(mshStr,&#34;|&#34;,10) S $P(mshStr,&#34;|&#34;,9)=&#34;DSR^Q03&#34; S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S episode=&#34;&#34; S workGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) //##Class(MI.Instrument).GetWorkGroupMachineRowId(mi) I $L(workGroupMachineDR) { S OrderNo=$O(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,visiNumberDR,workGroupMachineDR,&#34;&#34;)) I $L(OrderNo) { S reportDR=$O(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,visiNumberDR,workGroupMachineDR,OrderNo,&#34;&#34;)) S episode=&#34;&#34; //##Class(LIS.Core.Report).GetEpisodeNumber(reportDR) i $l(reportDR) s Assayno=$lg($g(^dbo.RPVisitNumberReportD(reportDR)),6) } } S order=mshStr_cr //&#34;MSH|^~\\&amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||&#34;_cr S order=order_&#34;MSA|AA|&#34;_mshSeq_&#34;|Message accepted|||0|&#34;_cr S order=order_&#34;ERR|0|&#34;_cr S order=order_&#34;QAK|SR|OK|&#34;_cr S order=order_qrdStr_cr //&#34;QRD|20160122110540|R|D|1|||RD||OTH|||T|&#34;_cr S order=order_qrfStr_cr //&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34;_cr S order=order_&#34;DSP|1||&#34;_visNumberObj.RegNo_&#34;|||&#34;_cr\t//住院号 S order=order_&#34;DSP|2||&#34;_visNumberObj.BedNo_&#34;|||&#34;_cr\t//床号 S order=order_&#34;DSP|3||&#34;_visNumberObj.SurName_&#34;|||&#34;_cr\t//病人姓名 /* S order=order_&#34;DSP|1||&#34;_visNumberObj.RegNo_&#34;|||&#34;_cr\t//住院号 S order=order_&#34;DSP|2||&#34;_episode_&#34;|||&#34;_cr\t//床号 //S order=order_&#34;DSP|3||&#34;_visNumberObj.SurName_&#34;|||&#34;_cr\t//病人姓名 S order=order_&#34;DSP|3||&#34;_episode_&#34;|||&#34;_cr\t//病人姓名 */ S order=order_&#34;DSP|4||&#34;_birdthday_&#34;|||&#34;_cr\t//出生日期 S order=order_&#34;DSP|5||&#34;_$S(visNumberObj.SpeciesDR=1:&#34;M&#34;,visNumberObj.SpeciesDR=2:&#34;F&#34;,1:&#34;O&#34;)_&#34;|||&#34;_cr\t//性别 S order=order_&#34;DSP|6|||||&#34;_cr\t//血型 S order=order_&#34;DSP|7|||||&#34;_cr\t//种族 S order=order_&#34;DSP|8|||||&#34;_cr\t//地址 S order=order_&#34;DSP|9|||||&#34;_cr\t//邮编 S order=order_&#34;DSP|10|||||&#34;_cr\t//家庭电话 S order=order_&#34;DSP|11|||||&#34;_cr\t//样本位 S order=order_&#34;DSP|12|||||&#34;_cr\t//样本采集时间 S order=order_&#34;DSP|13|||||&#34;_cr\t//未用 S order=order_&#34;DSP|14|||||&#34;_cr\t//未用 S order=order_&#34;DSP|15|||||&#34;_cr\t//病人类别 S order=order_&#34;DSP|16|||||&#34;_cr\t//医保帐号 S order=order_&#34;DSP|17|||||&#34;_cr\t//收费类型 S order=order_&#34;DSP|18|||||&#34;_cr\t//民族 S order=order_&#34;DSP|19|||||&#34;_cr\t//籍贯 S order=order_&#34;DSP|20|||||&#34;_cr\t//国家 S order=order_&#34;DSP|21||&#34;_barcode_&#34;|||&#34;_cr\t//*样本条码 S order=order_&#34;DSP|22||&#34;_barcode_&#34;|||&#34;_cr\t//*样本编号 S order=order_&#34;DSP|23|||||&#34;_cr\t//送检时间 S order=order_&#34;DSP|24||&#34;_$S(visNumberObj.Urgent=1:&#34;Y&#34;,1:&#34;N&#34;)_&#34;|||&#34;_cr\t//*是否急诊 S order=order_&#34;DSP|25|||||&#34;_cr\t//未用 S order=order_&#34;DSP|26||&#34;_sampleType_&#34;|||&#34;_cr\t//*样本类型(血清,血浆,尿液,脑脊液,其他) S order=order_&#34;DSP|27|||||&#34;_cr\t//送检医生 S order=order_&#34;DSP|28|||||&#34;_cr\t//送检科室 S order=order_chlStr S order=order_&#34;DSC|&#34;_DSC_&#34;|&#34;_cr W sb,order,eb,cr,*-3 D Trace^MI.MIF000(mi,sb_order_eb_cr,&#34;H--&gt;M&#34;) //$TR($ZDT($H,8),&#34; :&#34;) Q 0 //d Test^MI.MIFIFLASH3000N(&#34;22&#34;,9000000266) Test(mi,barcode) N (mi,barcode) S mi=$G(mi),barcode=$G(barcode) S mshStr=&#34;MSH|^~\\&amp;|YHLO|iFlash3000|||20160122110540||QRY^Q02|14|P|2.3.1||||||ASCII|||&#34; S DSC=&#34;&#34; S qrdStr=&#34;QRD|20160122110540|R|D|1|||RD|BarCode1|OTH|||T|&#34; S qrfStr=&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34; S sb=&#34;&lt;SB&gt;&#34;,eb=&#34;&lt;EB&gt;&#34;,cr=&#34;&lt;CR&gt;&#34; I &#39;$L(barcode) { W &#34;条码号为空&#34;,! Q 1 } I $ZCVT(barcode,&#34;U&#34;)=$ZCVT(&#34;Invalid&#34;,&#34;U&#34;) { //条码扫描错误 W &#34;条码扫描错误,机器未识别&#34;,! Q 1 } S labno=barcode S workGroupMachineDR=$LG($G(^dbo.BTMIMachineParameterD(mi)),6) S visiNumberDR=$O(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) I &#39;$L(visiNumberDR) { W &#34;条码未接收&#34;,! Q 1 } I &#39;$L(visiNumberDR) { W &#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,! Q 1 } S visNumberObj=##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR) I &#39;$L(visNumberObj) { W &#34;在检验系统未找到条码:&#34;_labno_&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;,! Q 1 } K ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) D ScanOne^MI.MIF000(mi,labno) S chlStr=&#34;&#34; b ;a102 S chl=&#34;&#34;,chlCnt=29 F { S chl=$O(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) Q:&#39;$L(chl) S chlStr=chlStr_&#34;DSP|&#34;_chlCnt_&#34;||&#34;_chl_&#34;^^^|||&#34;_cr S chlCnt=chlCnt+1 } I &#39;$L(chlStr) { W &#34;在检验系统未找到条码:&#34;_labno_&#34;对应的化验项目信息,确定医嘱或项目维护正确?&#34;,! Q 1 } S specimenDR=$LG($G(^dbo.RPVisitNumberD(visiNumberDR)),56) S specimenName=&#34;&#34; S:$L(specimenDR) specimenName=$LG($G(^dbo.BTSpecimenD(specimenDR)),3) S sampleType=&#34;其他&#34; I $L(specimenName),&#34;,血清,血浆,尿液,脑脊液,&#34;[(&#34;,&#34;_specimenName_&#34;,&#34;) { S sampleType=specimenName } S birdthday=visNumberObj.BirthDate S:$L(birdthday)=8 birdthday=birdthday_&#34;000000&#34; S mshSeq=$P(mshStr,&#34;|&#34;,10) S $P(mshStr,&#34;|&#34;,9)=&#34;DSR^Q03&#34; S mshStr=$P(mshStr,&#34;|&#34;,1,2)_&#34;|LIS|||&#34;_$P(mshStr,&#34;|&#34;,6,$l(mshStr)) S order=mshStr_cr //&#34;MSH|^~\\&amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||&#34;_cr S order=order_&#34;MSA|AA|&#34;_mshSeq_&#34;|Message accepted|||0|&#34;_cr S order=order_&#34;ERR|0|&#34;_cr S order=order_&#34;QAK|SR|OK|&#34;_cr S order=order_qrdStr_cr //&#34;QRD|20160122110540|R|D|1|||RD||OTH|||T|&#34;_cr S order=order_qrfStr_cr //&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34;_cr S order=order_&#34;DSP|1||&#34;_visNumberObj.RegNo_&#34;|||&#34;_cr\t//住院号 S order=order_&#34;DSP|2||&#34;_visNumberObj.BedNo_&#34;|||&#34;_cr\t//床号 S order=order_&#34;DSP|3||&#34;_visNumberObj.SurName_&#34;|||&#34;_cr\t//病人姓名 b ;a101 S order=order_&#34;DSP|4||&#34;_birdthday_&#34;|||&#34;_cr\t//出生日期 S order=order_&#34;DSP|5||&#34;_$S(visNumberObj.SpeciesDR=1:&#34;M&#34;,visNumberObj.SpeciesDR=2:&#34;F&#34;,1:&#34;O&#34;)_&#34;|||&#34;_cr\t//性别 S order=order_&#34;DSP|6|||||&#34;_cr\t//血型 S order=order_&#34;DSP|7|||||&#34;_cr\t//种族 S order=order_&#34;DSP|8|||||&#34;_cr\t//地址 S order=order_&#34;DSP|9|||||&#34;_cr\t//邮编 S order=order_&#34;DSP|10|||||&#34;_cr\t//家庭电话 S order=order_&#34;DSP|11|||||&#34;_cr\t//样本位 S order=order_&#34;DSP|12|||||&#34;_cr\t//样本采集时间 S order=order_&#34;DSP|13|||||&#34;_cr\t//未用 S order=order_&#34;DSP|14|||||&#34;_cr\t//未用 S order=order_&#34;DSP|15|||||&#34;_cr\t//病人类别 S order=order_&#34;DSP|16|||||&#34;_cr\t//医保帐号 S order=order_&#34;DSP|17|||||&#34;_cr\t//收费类型 S order=order_&#34;DSP|18|||||&#34;_cr\t//民族 S order=order_&#34;DSP|19|||||&#34;_cr\t//籍贯 S order=order_&#34;DSP|20|||||&#34;_cr\t//国家 S order=order_&#34;DSP|21||&#34;_barcode_&#34;|||&#34;_cr\t//*样本条码 S order=order_&#34;DSP|22||&#34;_barcode_&#34;|||&#34;_cr\t//*样本编号 S order=order_&#34;DSP|23|||||&#34;_cr\t//送检时间 S order=order_&#34;DSP|24||&#34;_$S(visNumberObj.Urgent=1:&#34;Y&#34;,1:&#34;N&#34;)_&#34;|||&#34;_cr\t//*是否急诊 S order=order_&#34;DSP|25|||||&#34;_cr\t//未用 S order=order_&#34;DSP|26||&#34;_sampleType_&#34;|||&#34;_cr\t//*样本类型(血清,血浆,尿液,脑脊液,其他) S order=order_&#34;DSP|27|||||&#34;_cr\t//送检医生 S order=order_&#34;DSP|28|||||&#34;_cr\t//送检科室 S order=order_chlStr S order=order_&#34;DSC|&#34;_DSC_&#34;|&#34;_cr W sb,order,eb,cr,! Q 0 TransResult(miRowId,result) N (miRowId,result) S miRowId=$G(miRowId),result=$G(result),newRes=&#34;&#34; F i=1:1:$L(result,&#34;,&#34;) { S chlStr=$P(result,&#34;,&#34;,i) Continue:&#39;$L(chlStr) S chl=$P(chlStr,&#34;\\&#34;,1) S val=$P(chlStr,&#34;\\&#34;,2) Continue:&#39;$L(chl) S res=val I chl&gt;97,chl&lt;102,val&#39;[&#34;?&#34; { S res=$$GetQuaResult(miRowId,chl,val) } S newRes=newRes_chl_$C(92)_res_$C(44) } Q:$L(newRes) newRes Q result GetQuaResult(miRowId,chl,res) N (miRowId,chl,res) S miRowId=$G(miRowId),chl=$G(chl),res=$G(res) S:res?1&#34;.&#34;1.N res=&#34;0&#34;_res S orgRes=res S resPrefix=$E(res,1) S:&#34;&lt;&gt;&#34;&#39;[resPrefix resPrefix=&#34;&#34; I $L(resPrefix) { S res=$P(res,resPrefix,2) } Q:&#39;$L(chl) orgRes Q:(res&#39;?0.N1.&#34;.&#34;1.N)&amp;&amp;(res&#39;?1.N) orgRes S tcRefRowId=$O(^dbo.BTMIMachineTestCodeI(&#34;IndexResultChannel&#34;,miRowId,##Class(LIS.Util.Common).IndexData(chl),&#34;&#34;)) Q:&#39;$L(tcRefRowId) orgRes S tcRowId=$LG($G(^dbo.BTMIMachineTestCodeD(tcRefRowId)),3) Q:&#39;$L(tcRowId) orgRes S orderNo=$O(^dbo.BTTestCodeRangesI(&#34;IndexMaster&#34;,tcRowId,&#34;&#34;)) Q:&#39;$L(orderNo) orgRes S rangeDR=$O(^dbo.BTTestCodeRangesI(&#34;IndexMaster&#34;,tcRowId,orderNo,&#34;&#34;)) Q:&#39;$L(rangeDR) orgRes S rangeObj=##Class(dbo.BTTestCodeRanges).%OpenId(rangeDR) Q:&#39;$L(rangeObj) orgRes I res&gt;=rangeObj.ValueHigh { I resPrefix=&#34;&lt;&#34; { Q orgRes } Q &#34;阳性(&#34;_orgRes_&#34;)&#34; } ELSE { I resPrefix=&#34;&gt;&#34; { Q orgRes } } Q &#34;阴性(&#34;_orgRes_&#34;)&#34; "><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://work.717170.xyz/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110220839-bac5x44.png' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/touxiang_hu_3261c9b36eb249a9.jpg" width="300"
                            height="285" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">木子洋</a></h1>
            <h2 class="site-description">To be or not to be.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/muziyangg'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://gitee.com/muziyangg'
                        target="_blank"
                        title="Gitee"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1756364241553" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1459" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M739.76 462H484.2a22.22 22.22 0 0 0-22.2 22.21v55.56A22.24 22.24 0 0 0 484.19 562h155.57A22.22 22.22 0 0 1 662 584.22v11.11A66.67 66.67 0 0 1 595.31 662H384.19A22.22 22.22 0 0 1 362 639.79V428.68A66.67 66.67 0 0 1 428.64 362h311.07a22.21 22.21 0 0 0 22.22-22.2v-55.56A22.22 22.22 0 0 0 739.79 262h-311.1A166.67 166.67 0 0 0 262 428.68v311.1A22.22 22.22 0 0 0 284.22 762H612a150 150 0 0 0 150-150V484.23A22.23 22.23 0 0 0 739.77 462z m0 0" fill="#231815" p-id="1460"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>首页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/link/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                <div class="widget search-widget">
    <div class="search-box">
        <form class="search-form widget">
            <p>
                <input type="text" class="search-input" placeholder="搜索本页内容..." />
                <button type="button" title="搜索" class="search-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.33" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </p>
        </form>
        <div class="search-results" style="display: none !important;"></div>
        <div class="search-stats"></div>
    </div>
    
    <div class="search-navigation">
        <button class="nav-button" id="prev-match" aria-label="上一个匹配项">
            <img src="/icons/up.svg" alt="上一个匹配项" width="16" height="16">
        </button>
        <span id="match-counter"></span>
        <button class="nav-button" id="next-match" aria-label="下一个匹配项">
            <img src="/icons/down.svg" alt="下一个匹配项" width="16" height="16">
        </button>
    </div>
</div>

<style>
 
.search-widget {
    margin-bottom: 20px;
}

.search-box {
    position: relative;
}

.search-form {
    position: relative;
    --button-size: 80px;
    margin-bottom: 1rem;
}

.search-form.widget {
    --button-size: 60px;
}

.search-form.widget input {
    padding: 15px 20px;
    height: auto;
}

.search-form p {
    position: relative;
    margin: 0;
    display: flex;
    flex-direction: column;
}

.search-input {
    padding: 15px 20px;
    border-radius: 12px;
    background-color: var(--card-background);
    box-shadow: var(--shadow-l1);
    color: var(--card-text-color-main);
    width: 100%;
    border: 1px solid var(--card-border-color);
    -webkit-appearance: none;
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
    font-size: 1.5rem !important;
    min-height: 48px;
}

.search-input::placeholder {
    font-size: 1.5rem;
    color: var(--card-text-color-tertiary);
    opacity: 1;
}

.search-input:focus {
    outline: 0;
    box-shadow: var(--shadow-l2);
    border-color: var(--primary-color);
}

.search-button {
    position: absolute;
    right: 0;
    top: 24px;
    height: 48px;
    width: var(--button-size);
    cursor: pointer;
    background-color: transparent;
    border: 0;
    padding: 0 10px;
}

.search-button:focus svg {
    stroke-width: 2;
    color: var(--accent-color);
}

.search-button svg {
    color: var(--card-text-color-secondary);
    stroke-width: 1.33;
    transition: all 0.3s ease;
    width: 20px;
    height: 20px;
}

.search-stats {
    margin-top: 8px;
    font-size: 14px;
    color: var(--card-text-color-tertiary);
}

.search-navigation {
    display: none;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding: 8px;
    background: var(--card-background-secondary);
    border-radius: var(--card-border-radius);
}

.nav-button {
    padding: 5px 10px;
    background: #2c559c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
}

.nav-button:hover {
    background: #1e3d76;
}

.nav-button:disabled {
    background: var(--card-text-color-tertiary);
    cursor: not-allowed;
}

.nav-button img {
    filter: invert(70%);
    transition: all 0.2s ease;
}

.nav-button:hover img {
    opacity: 0.9;
}

.nav-button:disabled img {
    filter: invert(40%);
}

#match-counter {
    font-size: 14px;
    color: var(--card-text-color-tertiary);
}

.search-highlight {
    background-color: #ffeb3b;
    padding: 0 2px;
    border-radius: 3px;
    transition: background-color 0.2s ease;
}

.search-highlight.current {
    background-color: #ff9800;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('.search-widget .search-input');
    const searchResults = document.querySelector('.search-widget .search-results');
    const searchStats = document.querySelector('.search-widget .search-stats');
    const searchNav = document.querySelector('.search-widget .search-navigation');
    const prevButton = document.querySelector('.search-widget #prev-match');
    const nextButton = document.querySelector('.search-widget #next-match');
    const matchCounter = document.querySelector('.search-widget #match-counter');
    const searchForm = document.querySelector('.search-form');
    const searchButton = document.querySelector('.search-button');
    
    let currentMatches = [];
    let currentMatchIndex = -1;
    let searchDebounceTimer = null;
    const DEBOUNCE_DELAY = 1000;
    
    
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
    });
    
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            handleSearchInput(searchTerm);
        }, DEBOUNCE_DELAY);
    });
    
    
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); 
            const searchTerm = this.value.trim();
            
            
            clearTimeout(searchDebounceTimer);
            
            
            if (currentMatches.length > 0) {
                currentMatchIndex = (currentMatchIndex + 1) % currentMatches.length;
                navigateToMatch();
            } 
            
            else if (searchTerm.length >= 1) {
                handleSearchInput(searchTerm);
            }
        }
    });
    
    
    searchButton.addEventListener('click', function() {
        clearTimeout(searchDebounceTimer);
        const searchTerm = searchInput.value.trim();
        handleSearchInput(searchTerm);
    });
    
    
    function handleSearchInput(term) {
        if (term.length < 1) {
            resetSearch();
            return;
        }
        performSearch(term);
    }
    
    
    function resetSearch() {
        searchResults.style.display = 'none';
        searchNav.style.display = 'none';
        clearHighlights();
        currentMatches = [];
        currentMatchIndex = -1;
        searchStats.textContent = '';
    }
    
    
    function performSearch(term) {
        clearHighlights();
        currentMatches = [];
        currentMatchIndex = -1;
        
        const articleContent = document.querySelector('.article-content');
        if (!articleContent) return;
        
        const textNodes = getTextNodes(articleContent);
        
        textNodes.forEach(node => {
            const text = node.textContent;
            const regex = new RegExp(term, 'gi');
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                if (match.index >= 0 && match.index + match[0].length <= text.length) {
                    currentMatches.push({
                        node: node,
                        offset: match.index,
                        length: match[0].length,
                        text: match[0]
                    });
                }
                if (match.index === regex.lastIndex) {
                    regex.lastIndex++;
                }
            }
        });
        
        displaySearchResults(term);
        highlightMatches();
        updateNavigation();
        
        
        if (currentMatches.length > 0) {
            currentMatchIndex = 0;
            navigateToMatch();
        }
    }
    
    
    function getTextNodes(element) {
        const textNodes = [];
        const walker = document.createTreeWalker(
            element, 
            NodeFilter.SHOW_TEXT, 
            {
                acceptNode: function(node) {
                    if (node.parentNode.classList.contains('search-highlight') ||
                        node.parentNode.tagName === 'CODE' || 
                        node.parentNode.tagName === 'PRE') {
                        return NodeFilter.FILTER_REJECT;
                    }
                    if (node.textContent.trim().length === 0) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    return NodeFilter.FILTER_ACCEPT;
                }
            }
        );
        
        let node;
        while ((node = walker.nextNode())) {
            textNodes.push(node);
        }
        
        return textNodes;
    }
    
    
    function displaySearchResults(term) {
        if (currentMatches.length === 0) {
            searchStats.textContent = `未找到"${term}"的匹配结果`;
            searchNav.style.display = 'none';
            return;
        }
        
        searchStats.textContent = `找到${currentMatches.length}个"${term}"的匹配结果`;
        searchNav.style.display = 'flex';
    }
    
    
    function highlightMatches() {
        currentMatches.forEach(match => {
            try {
                const node = match.node;
                const textLength = node.textContent.length;
                
                if (match.offset < 0 || match.offset >= textLength) {
                    console.warn('无效的匹配偏移量', match);
                    return;
                }
                
                const endOffset = Math.min(match.offset + match.length, textLength);
                
                const range = document.createRange();
                range.setStart(node, match.offset);
                range.setEnd(node, endOffset);
                
                const highlight = document.createElement('span');
                highlight.className = 'search-highlight';
                range.surroundContents(highlight);
            } catch (e) {
                console.error('高亮匹配项失败:', e, match);
            }
        });
    }
    
    
    function clearHighlights() {
        const highlights = document.querySelectorAll('.search-highlight');
        highlights.forEach(highlight => {
            const parent = highlight.parentNode;
            const textNode = document.createTextNode(highlight.textContent);
            parent.replaceChild(textNode, highlight);
            parent.normalize();
        });
    }
    
    
    function updateNavigation() {
        matchCounter.textContent = currentMatches.length > 0 ? 
            `${currentMatchIndex + 1} / ${currentMatches.length}` : 
            '无匹配结果';
        
        prevButton.disabled = currentMatches.length === 0;
        nextButton.disabled = currentMatches.length === 0;
    }
    
    
    nextButton.addEventListener('click', function() {
        if (currentMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex + 1) % currentMatches.length;
        navigateToMatch();
    });
    
    
    prevButton.addEventListener('click', function() {
        if (currentMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex - 1 + currentMatches.length) % currentMatches.length;
        navigateToMatch();
    });
    
    
    function navigateToMatch() {
        if (currentMatchIndex < 0 || currentMatchIndex >= currentMatches.length) return;
        
        const highlights = document.querySelectorAll('.search-highlight');
        if (highlights.length > 0 && currentMatchIndex < highlights.length) {
            highlights.forEach(h => h.classList.remove('current'));
            highlights[currentMatchIndex].classList.add('current');
            highlights[currentMatchIndex].scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }
        
        updateNavigation();
    }
    
    
    searchNav.style.display = 'none';
});
</script>
    
            
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#上机请求双向">上机请求双向</a>
      <ol>
        <li><a href="#hl7-协议接口双向">HL7 协议接口双向</a>
          <ol>
            <li><a href="#回传多行-dsp">回传多行 DSP</a></li>
            <li><a href="#回传三行-dsp">回传三行 DSP</a></li>
            <li><a href="#回传多行-obx">回传多行 OBX</a></li>
          </ol>
        </li>
        <li><a href="#astm-协议接口双向">ASTM 协议接口双向</a>
          <ol>
            <li><a href="#一次性发送按照字符数多次发送">一次性发送按照字符数多次发送</a></li>
            <li><a href="#通过收到-ack-发送多条数据">通过收到 ACK 发送多条数据</a></li>
          </ol>
        </li>
        <li><a href="#通过文件请求双向">通过文件请求双向</a>
          <ol>
            <li><a href="#上机生成请求文件请求">上机生成请求文件请求</a></li>
          </ol>
        </li>
        <li><a href="#私有协议接口双向">私有协议接口双向</a>
          <ol>
            <li><a href="#类-astm-双向回复-ack">类 ASTM 双向回复 ACK</a></li>
            <li><a href="#安图协议">安图协议</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#主动上传双向">主动上传双向</a>
      <ol>
        <li><a href="#通过监听文件双向">通过监听文件双向</a>
          <ol>
            <li><a href="#不同路径回传患者信息和检测项目信息">不同路径回传患者信息和检测项目信息</a></li>
            <li><a href="#同一路径回传文件上传一个或多个文件">同一路径回传文件上传一个或多个文件</a></li>
          </ol>
        </li>
        <li><a href="#通过串口网口主动上传">通过串口网口主动上传</a>
          <ol>
            <li><a href="#上传和下载为不同的串口或端口">上传和下载为不同的串口或端口</a></li>
          </ol>
        </li>
        <li><a href="#通过数据库主动上传">通过数据库主动上传</a>
          <ol>
            <li><a href="#odbc连接数据库回插数据">ODBC连接数据库回插数据</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/">
                <img src="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110220839-bac5x44_hu_8a259e39f20f217c.png"
                        srcset="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110220839-bac5x44_hu_8a259e39f20f217c.png 800w, /p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110220839-bac5x44_hu_110a1b2abcb06dd6.png 1600w"
                        width="800" 
                        height="2284" 
                        loading="lazy"
                        alt="Featured image of post 双向接口程序整合" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/2.%E4%BB%AA%E5%99%A8%E6%8E%A5%E5%8F%A3%E8%AE%B0%E5%BD%95/" >
                2.仪器接口记录
            </a>
        
            <a href="/categories/%E4%B8%AA%E4%BA%BA%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F/" >
                个人接口程序
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/">双向接口程序整合</a>
        </h2>
    
        
    </div>

        
        <footer class="article-time">
            
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                    <time class="article-time--published">2025-09-03</time>
                </div>
            

            
            
                        最后更新于
                        <time class="article-time--updated" datetime="2025-09-03 23:20:57 &#43;0000 UTC" title="2025-09-03 23:20:57 &#43;0000 UTC">
                            2025-09-03 23:20:57
                        </time>
			
			
			
				<div>
					<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



					<time class="article-words">
						43293字
					</time>
				</div>
			
			

            
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                    <time class="article-time--reading">
                        阅读时长: 87 分钟
                    </time>
                </div>
            
        </footer>
    


    
</div>
</header>



    <section class="article-content">
    
    
    <h2 id="上机请求双向">上机请求双向
</h2><h3 id="hl7-协议接口双向">HL7 协议接口双向
</h3><h4 id="回传多行-dsp">回传多行 DSP
</h4><blockquote>
<p>回传信息时要求有 DSP 字段，且 DSP 字段前 28 行为患者信息，第 29 行之后为检测项目信息。</p></blockquote>
<h5 id="示例接口亚辉龙-3000">示例接口(亚辉龙 3000)
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span> <span class="err">名称</span><span class="p">:</span> <span class="n">MI</span><span class="o">.</span><span class="n">MIFI3000</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">描述</span><span class="p">:</span> <span class="err">深圳亚辉龙</span><span class="n">iFlash3000</span> <span class="err">双向仪器接口</span>
</span></span><span class="line"><span class="cl"><span class="n">MIFI3000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(mi)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">par11</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">12</span><span class="p">)</span>      <span class="o">//</span><span class="err">项目分隔符</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">par10</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">13</span><span class="p">)</span>  <span class="o">//</span><span class="err">结果分隔符</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AntDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">14</span><span class="p">)</span>        <span class="o">//</span><span class="err">抗生素分隔符</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SenDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span>        <span class="o">//</span><span class="err">药敏结果分隔符</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">par4</span><span class="o">=</span><span class="s2">&#34;|TCP|&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>   <span class="o">//</span><span class="err">端口号</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi1</span><span class="o">=</span><span class="n">mi</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">stx</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">etx</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ack</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">enq</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">eot</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">etb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">lf</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">nak</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">21</span><span class="p">),(</span><span class="n">AllRecord</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">kk</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">errFlag</span><span class="p">,</span><span class="n">resultType</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="o">$$</span><span class="n">StartUTF8</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Main</span>
</span></span><span class="line"><span class="cl">        <span class="n">Q</span><span class="p">:</span><span class="o">$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">C</span> <span class="n">par4</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Main</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">$</span><span class="n">ZT</span><span class="o">=</span><span class="s2">&#34;ErrHandler&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">EC</span><span class="o">=</span><span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$TEST    //如果超时则退出</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=sb   //以sb开头</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">errFlag</span><span class="p">,</span><span class="n">resultType</span><span class="p">,</span><span class="n">msgType</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="n">mshStr</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">startTime</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="n">PLIST</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">S</span> <span class="n">curTime</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Q</span><span class="p">:</span><span class="n">curTime</span><span class="o">&gt;</span><span class="p">(</span><span class="n">startTime</span><span class="o">+</span><span class="mi">300</span><span class="p">)</span>  <span class="o">//</span><span class="mi">5</span><span class="err">分钟内没有处理完则退出循环</span>
</span></span><span class="line"><span class="cl">        <span class="n">Q</span><span class="p">:</span><span class="o">$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$TEST    //如果超时则退出</span>
</span></span><span class="line"><span class="cl">        <span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)))</span><span class="o">&gt;=</span><span class="mi">32700</span> <span class="p">{</span>  <span class="o">//</span><span class="mi">32767</span>
</span></span><span class="line"><span class="cl">            <span class="n">S</span> <span class="n">index</span><span class="o">=+$</span><span class="n">O</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">S</span> <span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">I</span> <span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=eb,$C(R)&#39;</span><span class="o">=</span><span class="n">cr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">S</span> <span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">))</span><span class="n">_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">I</span> <span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">cr</span> <span class="p">{</span>    <span class="o">//</span><span class="err">解析一条记录</span>
</span></span><span class="line"><span class="cl">            <span class="n">D</span> <span class="n">Record</span>
</span></span><span class="line"><span class="cl">            <span class="n">K</span> <span class="n">PLIST</span>
</span></span><span class="line"><span class="cl">            <span class="n">S</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span>   
</span></span><span class="line"><span class="cl">        <span class="p">}</span>   
</span></span><span class="line"><span class="cl">        <span class="n">Q</span><span class="p">:</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eb</span>      <span class="o">//</span><span class="err">循环读取</span><span class="p">,</span><span class="err">当为</span><span class="n">eb的时候则退出</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Save</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Record</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">index</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">isImage</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">isBinary</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">S</span> <span class="n">index</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(index)</span>
</span></span><span class="line"><span class="cl">        <span class="n">S</span> <span class="n">record</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span><span class="n">cr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Continue</span><span class="p">:</span><span class="s1">&#39;$L(record)</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">I</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">S</span> <span class="n">segmentType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">;</span><span class="err">消息段</span><span class="p">(</span><span class="err">数据类型</span><span class="p">)</span> 	<span class="n">MSH</span>	  <span class="n">MSA</span> 	<span class="n">PID</span>   <span class="n">OBR</span>  	<span class="n">OBX</span>  <span class="n">ORD</span>  <span class="n">QRF</span> 	<span class="n">ERR</span>   <span class="n">QAK</span>    <span class="n">DSP</span>     <span class="n">DSC</span>   
</span></span><span class="line"><span class="cl">            <span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;MSH&#34;</span> <span class="p">{</span>   <span class="o">//</span><span class="err">信息头信息</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">mshStr</span><span class="o">=</span><span class="n">record</span>
</span></span><span class="line"><span class="cl">                <span class="o">//</span><span class="err">消息类型</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">msgType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="o">//</span><span class="n">ORU</span><span class="p">,</span><span class="n">ACK</span><span class="p">,</span><span class="n">QRY</span><span class="p">,</span><span class="n">QCK</span><span class="p">,</span><span class="n">DSR</span> 
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="n">msgType</span><span class="o">=</span><span class="s2">&#34;ORU&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">D</span> <span class="n">SendACK</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="n">msgType</span><span class="o">=</span><span class="s2">&#34;ORM&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="n">msgType</span><span class="o">=</span><span class="s2">&#34;QRY&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	                <span class="n">D</span> <span class="n">SendQryACK</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">resultType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;PID&#34;</span> <span class="p">{</span>   <span class="o">//</span><span class="err">患者信息</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;PVI&#34;</span> <span class="p">{</span>   <span class="o">//</span><span class="err">就诊信息</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;OBR&#34;</span> <span class="p">{</span>   <span class="o">//</span><span class="err">医嘱信息</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">epis</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">:</span><span class="s1">&#39;$l(epis) epis=$P(record,&#34;|&#34;,4)</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">dateStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="n">dateStr</span><span class="err">?</span><span class="mi">14</span><span class="n">N</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">S</span> <span class="n">date</span><span class="o">=$</span><span class="n">ZDH</span><span class="p">(</span><span class="o">$</span><span class="n">E</span><span class="p">(</span><span class="n">dateStr</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">E</span><span class="p">(</span><span class="n">dateStr</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">E</span><span class="p">(</span><span class="n">dateStr</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">S</span> <span class="n">time</span><span class="o">=$</span><span class="n">ZTH</span><span class="p">(</span><span class="o">$</span><span class="n">E</span><span class="p">(</span><span class="n">dateStr</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">E</span><span class="p">(</span><span class="n">dateStr</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">E</span><span class="p">(</span><span class="n">dateStr</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">code</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;OBX&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">dataTye</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>  <span class="o">//</span><span class="n">NM</span> <span class="p">(</span><span class="n">numeric</span><span class="p">)</span> <span class="err">表示数字值，用于定量项目</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">//</span><span class="n">ST</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="err">表示字符串值，用于定性项目</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">channel</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">channel</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">value</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span><span class="n">dataTye</span><span class="s1">&#39;=&#34;ED&#34;,dataTye&#39;</span><span class="o">=</span><span class="s2">&#34;IS&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">S</span> <span class="n">result</span><span class="o">=</span><span class="n">result_channel_par10_value_par11</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"> 			<span class="o">//</span><span class="err">根据条码号获取</span><span class="n">LIS标本</span>
</span></span><span class="line"><span class="cl">            <span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;QRD&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">barcode</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>  <span class="o">//</span><span class="n">QRD</span><span class="o">|</span><span class="mi">20161208150935</span><span class="o">|</span><span class="n">R</span><span class="o">|</span><span class="n">D</span><span class="o">|</span><span class="mi">1</span><span class="o">|||</span><span class="n">RD</span><span class="o">|</span><span class="mi">16120703726</span><span class="o">|</span><span class="n">OTH</span><span class="o">|||</span><span class="n">T</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	                <span class="n">S</span> <span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;B&#34;</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;MSH&#34;</span><span class="p">)</span><span class="o">=</span><span class="n">mshStr</span>
</span></span><span class="line"><span class="cl">	                <span class="n">S</span> <span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;B&#34;</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;QRD&#34;</span><span class="p">)</span><span class="o">=</span><span class="n">record</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">//</span><span class="err">根据查询条件获取</span><span class="n">LIS标本</span>
</span></span><span class="line"><span class="cl">            <span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;QRF&#34;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">            	<span class="n">S</span> <span class="n">tRecord</span><span class="o">=</span><span class="n">record</span>
</span></span><span class="line"><span class="cl">            	<span class="n">S</span> <span class="n">record</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            	<span class="n">S</span> <span class="n">qryStartDate</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">qryEndDate</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">sampleIdStart</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span> <span class="n">sampleIdEnd</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">:</span><span class="s1">&#39;$L(qryStartDate) qryStartDate=qryEndDate</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">:</span><span class="s1">&#39;$L(qryEndDate) qryEndDate=qryStartDate</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">:</span><span class="s1">&#39;$L(sampleIdStart) sampleIdStart=sampleIdEnd</span>
</span></span><span class="line"><span class="cl">                <span class="n">S</span><span class="p">:</span><span class="s1">&#39;$L(sampleIdEnd) sampleIdEnd=sampleIdStart</span>
</span></span><span class="line"><span class="cl">                <span class="o">//</span><span class="err">通过样本号段查询</span>  <span class="n">QRF</span><span class="o">|</span><span class="n">iFlash3000</span><span class="o">|||</span><span class="mi">1</span><span class="o">|</span><span class="mi">9</span><span class="o">|</span><span class="n">RCT</span><span class="o">|</span><span class="n">COR</span><span class="o">|</span><span class="n">ALL</span><span class="o">||</span> 
</span></span><span class="line"><span class="cl">                <span class="n">I</span> <span class="n">sampleIdStart</span><span class="err">?</span><span class="mf">1.</span><span class="n">N</span><span class="p">,</span><span class="n">sampleIdEnd</span><span class="err">?</span><span class="mf">1.</span><span class="n">N</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	                <span class="n">F</span> <span class="n">sampleId</span><span class="o">=</span><span class="n">sampleIdStart</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">sampleIdEnd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		                <span class="n">S</span> <span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;S&#34;</span><span class="p">,</span><span class="n">sampleId</span><span class="p">,</span><span class="s2">&#34;MSH&#34;</span><span class="p">)</span><span class="o">=</span><span class="n">mshStr</span>
</span></span><span class="line"><span class="cl">		                <span class="n">S</span> <span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;S&#34;</span><span class="p">,</span><span class="n">sampleId</span><span class="p">,</span><span class="s2">&#34;QRF&#34;</span><span class="p">)</span><span class="o">=</span><span class="n">tRecord</span>
</span></span><span class="line"><span class="cl">		            <span class="p">}</span>
</span></span><span class="line"><span class="cl">	            <span class="p">}</span>
</span></span><span class="line"><span class="cl">	            <span class="o">//</span><span class="err">通过时间段查询</span>	<span class="n">QRF</span><span class="o">|</span><span class="n">iFlash3000</span><span class="o">|</span><span class="mi">20160122080000</span><span class="o">|</span><span class="mi">20160122120000</span><span class="o">|||</span><span class="n">RCT</span><span class="o">|</span><span class="n">COR</span><span class="o">|</span><span class="n">ALL</span><span class="o">||</span>
</span></span><span class="line"><span class="cl">	            <span class="n">I</span> <span class="n">qryStartDate</span><span class="err">?</span><span class="mf">1.</span><span class="n">N</span><span class="p">,</span><span class="n">qryEndDate</span><span class="err">?</span><span class="mf">1.</span><span class="n">N</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	                <span class="n">F</span> <span class="n">qryDate</span><span class="o">=</span><span class="n">qryStartDate</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">qryEndDate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		                <span class="n">S</span> <span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;D&#34;</span><span class="p">,</span><span class="n">qryDate</span><span class="p">,</span><span class="s2">&#34;MSH&#34;</span><span class="p">)</span><span class="o">=</span><span class="n">mshStr</span>
</span></span><span class="line"><span class="cl">		                <span class="n">S</span> <span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;D&#34;</span><span class="p">,</span><span class="n">qryDate</span><span class="p">,</span><span class="s2">&#34;QRF&#34;</span><span class="p">)</span><span class="o">=</span><span class="n">tRecord</span>
</span></span><span class="line"><span class="cl">		            <span class="p">}</span>
</span></span><span class="line"><span class="cl">	            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">根本样本号获取条码号</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">sampleId</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">sampleId</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;B&#34;</span><span class="p">,</span><span class="n">sampleId</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(sampleId) </span>
</span></span><span class="line"><span class="cl">	    <span class="o">//</span><span class="err">暂不处理</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">根本日期获取条码号</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">qryDate</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">qryDate</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;D&#34;</span><span class="p">,</span><span class="n">qryDate</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(qryDate) </span>
</span></span><span class="line"><span class="cl">	    <span class="o">//</span><span class="err">暂不处理</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">上传标本</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">barcode</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">barcodeIndex</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">barcode</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;B&#34;</span><span class="p">,</span><span class="n">barcode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(barcode)</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;B&#34;</span><span class="p">,</span><span class="n">barcode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">barcodeIndex</span><span class="o">=</span><span class="n">barcodeIndex</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	    <span class="n">I</span> <span class="o">$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;B&#34;</span><span class="p">,</span><span class="n">barcode</span><span class="p">))</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		    <span class="n">S</span> <span class="n">barcodeIndex</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="o">//</span><span class="err">最后一个为空</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;B&#34;</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;MSH&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">qrdStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;B&#34;</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;QRD&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">qrfStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;B&#34;</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;QRF&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="s1">&#39;$L(qrdStr) {</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">qrdStr</span><span class="o">=</span><span class="s2">&#34;QRD|&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZDT</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="s2">&#34; :&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|R|D|1|||RD||OTH|||T|&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="s1">&#39;$L(qrfStr) {</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">qrfStr</span><span class="o">=</span><span class="s2">&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">qrdStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SendOrder</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">qrdStr</span><span class="p">,</span><span class="n">qrfStr</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="n">barcodeIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="o">^</span><span class="n">TMPMACHINEEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">Save</span>  
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;^&#34;</span><span class="n">_result</span><span class="p">,</span><span class="s2">&#34;Test&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">S</span> <span class="n">QC</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">;</span><span class="n">S</span> <span class="n">result</span><span class="o">=$$</span><span class="n">TransResult</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Save</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">resultType</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">SendACK</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="n">errCode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">errDesc</span><span class="o">=</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">)</span> <span class="o">//</span><span class="n">send</span> <span class="s1">&#39;ack&#39;</span> <span class="n">to</span> <span class="n">instrument</span> 
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">ackType</span><span class="p">,</span><span class="n">errCode</span><span class="p">,</span><span class="n">errDesc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">mshStr</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mshStr</span><span class="p">),</span><span class="n">ackType</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ackType</span><span class="p">),</span><span class="n">errCode</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">errCode</span><span class="p">),</span><span class="n">errDesc</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">errDesc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:(</span><span class="s1">&#39;$l(mi))||(&#39;</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">Q</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">21</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">msgRoutine</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">seq</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|LIS|||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;ACK^&#34;</span><span class="n">_msgRoutine</span>
</span></span><span class="line"><span class="cl">    <span class="n">W</span> <span class="n">sb</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;MSA|&#34;</span><span class="n">_ackType_</span><span class="s2">&#34;|&#34;</span><span class="n">_seq_</span><span class="s2">&#34;|&#34;</span><span class="n">_errDesc_</span><span class="s2">&#34;|||&#34;</span><span class="n">_errCode_</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">S</span><span class="p">(</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AE&#34;</span><span class="p">:</span><span class="s2">&#34;Error&#34;</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AR&#34;</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;NULL&#34;</span><span class="p">),</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">SendQryACK</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="n">errCode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">errDesc</span><span class="o">=</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">)</span> <span class="o">//</span><span class="n">send</span> <span class="s1">&#39;ack&#39;</span> <span class="n">to</span> <span class="n">instrument</span> 
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">ackType</span><span class="p">,</span><span class="n">errCode</span><span class="p">,</span><span class="n">errDesc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">mshStr</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mshStr</span><span class="p">),</span><span class="n">ackType</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ackType</span><span class="p">),</span><span class="n">errCode</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">errCode</span><span class="p">),</span><span class="n">errDesc</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">errDesc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:(</span><span class="s1">&#39;$l(mi))||(&#39;</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">msgRoutine</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">seq</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|LIS|||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;QCK^&#34;</span><span class="n">_msgRoutine</span>
</span></span><span class="line"><span class="cl">    <span class="n">W</span> <span class="n">sb</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;MSA|&#34;</span><span class="n">_ackType_</span><span class="s2">&#34;|&#34;</span><span class="n">_seq_</span><span class="s2">&#34;|&#34;</span><span class="n">_errDesc_</span><span class="s2">&#34;|||&#34;</span><span class="n">_errCode_</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;ERR|0|&#34;</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;QAK|SR|OK|&#34;</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">S</span><span class="p">(</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span><span class="p">:</span><span class="s2">&#34;QACK&#34;</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AE&#34;</span><span class="p">:</span><span class="s2">&#34;Error&#34;</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AR&#34;</span><span class="p">:</span><span class="s2">&#34;QNAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;NULL&#34;</span><span class="p">),</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">ErrHandler</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZERROR</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="s2">&#34;--&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;.错误代码:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ECODE</span><span class="p">,</span><span class="s2">&#34;Runtime Error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">双向上传医嘱信息</span><span class="p">,</span><span class="n">wwh</span><span class="p">,</span><span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">05</span>
</span></span><span class="line"><span class="cl"><span class="n">SendOrder</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">qrdStr</span><span class="p">,</span><span class="n">qrfStr</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="n">DSC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">qrdStr</span><span class="p">,</span><span class="n">qrfStr</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="n">DSC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">mshStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mshStr</span><span class="p">),</span><span class="n">barcode</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">barcode</span><span class="p">),</span><span class="n">DSC</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">DSC</span><span class="p">),</span><span class="n">qrdStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">qrdStr</span><span class="p">),</span><span class="n">qrfStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">qrfStr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="s1">&#39;$L(barcode) {</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码号为空&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>             <span class="o">//</span><span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码扫描错误,机器未识别&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">labno</span><span class="o">=</span><span class="n">barcode</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">workGroupMachineDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">visiNumberDR</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="s1">&#39;$L(visiNumberDR) {</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_labno_</span><span class="s2">&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">visNumberObj</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR)</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="s1">&#39;$L(visNumberObj) {</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_labno_</span><span class="s2">&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;Upload Start&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">result</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">chlStr</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">chlCnt</span><span class="o">=</span><span class="mi">29</span>
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chl</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(chl)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chlStr</span><span class="o">=</span><span class="n">chlStr_</span><span class="s2">&#34;DSP|&#34;</span><span class="n">_chlCnt_</span><span class="s2">&#34;||&#34;</span><span class="n">_chl_</span><span class="s2">&#34;^^^|||&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chlCnt</span><span class="o">=</span><span class="n">chlCnt</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span><span class="n">S</span> <span class="n">result</span><span class="o">=</span><span class="n">result_chl_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;?&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">I</span> <span class="s1">&#39;$L(chlStr) {</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_labno_</span><span class="s2">&#34;对应的化验项目信息,确定医嘱或项目维护正确?&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">Save</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">specimenDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">visiNumberDR</span><span class="p">)),</span><span class="mi">56</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">specimenName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">specimenDR</span><span class="p">)</span> <span class="n">specimenName</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpecimenD</span><span class="p">(</span><span class="n">specimenDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">sampleType</span><span class="o">=</span><span class="s2">&#34;其他&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">specimenName</span><span class="p">),</span><span class="s2">&#34;,血清,血浆,尿液,脑脊液,&#34;</span><span class="p">[(</span><span class="s2">&#34;,&#34;</span><span class="n">_specimenName_</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">sampleType</span><span class="o">=</span><span class="n">specimenName</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">birdthday</span><span class="o">=</span><span class="n">visNumberObj</span><span class="o">.</span><span class="n">BirthDate</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">birdthday</span><span class="p">)</span><span class="o">=</span><span class="mi">8</span> <span class="n">birdthday</span><span class="o">=</span><span class="n">birdthday_</span><span class="s2">&#34;000000&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="s1">&#39;$L(mshStr) mshStr=&#34;MSH|^~\&amp;|YHLO|iFlash3000|||20161208150935||QRY^Q02|18|P|2.3.1||||||ASCII|||&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshSeq</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;DSR^Q03&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|LIS|||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">episode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">workGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span> <span class="o">//</span><span class="c1">##Class(MI.Instrument).GetWorkGroupMachineRowId(mi)</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">workGroupMachineDR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    	<span class="n">S</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">visiNumberDR</span><span class="p">,</span><span class="n">workGroupMachineDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">OrderNo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    	<span class="n">S</span> <span class="n">reportDR</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">visiNumberDR</span><span class="p">,</span><span class="n">workGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	    	<span class="n">S</span> <span class="n">episode</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="o">//</span><span class="c1">##Class(LIS.Core.Report).GetEpisodeNumber(reportDR)</span>
</span></span><span class="line"><span class="cl">	    	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">reportDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Assayno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">reportDR</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">mshStr_cr</span> <span class="o">//</span><span class="s2">&#34;MSH|^~\&amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;MSA|AA|&#34;</span><span class="n">_mshSeq_</span><span class="s2">&#34;|Message accepted|||0|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;ERR|0|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;QAK|SR|OK|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_qrdStr_cr</span>  <span class="o">//</span><span class="s2">&#34;QRD|20160122110540|R|D|1|||RD||OTH|||T|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_qrfStr_cr</span>  <span class="o">//</span><span class="s2">&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|1||&#34;</span><span class="n">_visNumberObj</span><span class="o">.</span><span class="n">RegNo_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>		<span class="o">//</span><span class="err">住院号</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|2||&#34;</span><span class="n">_visNumberObj</span><span class="o">.</span><span class="n">BedNo_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>		<span class="o">//</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|3||&#34;</span><span class="n">_visNumberObj</span><span class="o">.</span><span class="n">SurName_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">	<span class="o">/*</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|1||&#34;</span><span class="n">_visNumberObj</span><span class="o">.</span><span class="n">RegNo_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>		<span class="o">//</span><span class="err">住院号</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|2||&#34;</span><span class="n">_episode_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>		<span class="o">//</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|3||&#34;</span><span class="n">_visNumberObj</span><span class="o">.</span><span class="n">SurName_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|3||&#34;</span><span class="n">_episode_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">	<span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|4||&#34;</span><span class="n">_birdthday_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">出生日期</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|5||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">S</span><span class="p">(</span><span class="n">visNumberObj</span><span class="o">.</span><span class="n">SpeciesDR</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;M&#34;</span><span class="p">,</span><span class="n">visNumberObj</span><span class="o">.</span><span class="n">SpeciesDR</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span><span class="s2">&#34;F&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;O&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|6|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">血型</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|7|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">种族</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|8|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">地址</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|9|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">邮编</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|10|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">家庭电话</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|11|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">样本位</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|12|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">样本采集时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|13|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">未用</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|14|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">未用</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|15|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">病人类别</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|16|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">医保帐号</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|17|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">收费类型</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|18|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">民族</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|19|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">籍贯</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|20|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">国家</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|21||&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//*</span><span class="err">样本条码</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|22||&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//*</span><span class="err">样本编号</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|23|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">送检时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|24||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">S</span><span class="p">(</span><span class="n">visNumberObj</span><span class="o">.</span><span class="n">Urgent</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;Y&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;N&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>				<span class="o">//*</span><span class="err">是否急诊</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|25|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">未用</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|26||&#34;</span><span class="n">_sampleType_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//*</span><span class="err">样本类型</span><span class="p">(</span><span class="err">血清</span><span class="p">,</span><span class="err">血浆</span><span class="p">,</span><span class="err">尿液</span><span class="p">,</span><span class="err">脑脊液</span><span class="p">,</span><span class="err">其他</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|27|||||&#34;</span><span class="n">_cr</span>	<span class="o">//</span><span class="err">送检医生</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|28|||||&#34;</span><span class="n">_cr</span>		<span class="o">//</span><span class="err">送检科室</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_chlStr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSC|&#34;</span><span class="n">_DSC_</span><span class="s2">&#34;|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">    <span class="n">W</span> <span class="n">sb</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">sb_order_eb_cr</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">//$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZDT</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="s2">&#34; :&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">d</span> <span class="n">Test</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIFIFLASH3000N</span><span class="p">(</span><span class="s2">&#34;22&#34;</span><span class="p">,</span><span class="mi">9000000266</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Test</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">barcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">barcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">barcode</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=</span><span class="s2">&#34;MSH|^~\&amp;|YHLO|iFlash3000|||20160122110540||QRY^Q02|14|P|2.3.1||||||ASCII|||&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">DSC</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">qrdStr</span><span class="o">=</span><span class="s2">&#34;QRD|20160122110540|R|D|1|||RD|BarCode1|OTH|||T|&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">qrfStr</span><span class="o">=</span><span class="s2">&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">sb</span><span class="o">=</span><span class="s2">&#34;&lt;SB&gt;&#34;</span><span class="p">,</span><span class="n">eb</span><span class="o">=</span><span class="s2">&#34;&lt;EB&gt;&#34;</span><span class="p">,</span><span class="n">cr</span><span class="o">=</span><span class="s2">&#34;&lt;CR&gt;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="s1">&#39;$L(barcode) {</span>
</span></span><span class="line"><span class="cl">        <span class="n">W</span> <span class="s2">&#34;条码号为空&#34;</span><span class="p">,</span><span class="o">!</span>
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>             <span class="o">//</span><span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">        <span class="n">W</span> <span class="s2">&#34;条码扫描错误,机器未识别&#34;</span><span class="p">,</span><span class="o">!</span>   
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">labno</span><span class="o">=</span><span class="n">barcode</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">workGroupMachineDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">visiNumberDR</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="s1">&#39;$L(visiNumberDR) {</span>
</span></span><span class="line"><span class="cl">    	<span class="n">W</span> <span class="s2">&#34;条码未接收&#34;</span><span class="p">,</span><span class="o">!</span>   
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="s1">&#39;$L(visiNumberDR) {</span>
</span></span><span class="line"><span class="cl">        <span class="n">W</span> <span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_labno_</span><span class="s2">&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;</span><span class="p">,</span><span class="o">!</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">visNumberObj</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR)</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="s1">&#39;$L(visNumberObj) {</span>
</span></span><span class="line"><span class="cl">        <span class="n">W</span> <span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_labno_</span><span class="s2">&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;</span><span class="p">,</span><span class="o">!</span>   
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">chlStr</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">b</span> <span class="p">;</span><span class="n">a102</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">chlCnt</span><span class="o">=</span><span class="mi">29</span>
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chl</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(chl)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chlStr</span><span class="o">=</span><span class="n">chlStr_</span><span class="s2">&#34;DSP|&#34;</span><span class="n">_chlCnt_</span><span class="s2">&#34;||&#34;</span><span class="n">_chl_</span><span class="s2">&#34;^^^|||&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chlCnt</span><span class="o">=</span><span class="n">chlCnt</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">I</span> <span class="s1">&#39;$L(chlStr) {</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">W</span> <span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_labno_</span><span class="s2">&#34;对应的化验项目信息,确定医嘱或项目维护正确?&#34;</span><span class="p">,</span><span class="o">!</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">specimenDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">visiNumberDR</span><span class="p">)),</span><span class="mi">56</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">specimenName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">specimenDR</span><span class="p">)</span> <span class="n">specimenName</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpecimenD</span><span class="p">(</span><span class="n">specimenDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">sampleType</span><span class="o">=</span><span class="s2">&#34;其他&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">specimenName</span><span class="p">),</span><span class="s2">&#34;,血清,血浆,尿液,脑脊液,&#34;</span><span class="p">[(</span><span class="s2">&#34;,&#34;</span><span class="n">_specimenName_</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">sampleType</span><span class="o">=</span><span class="n">specimenName</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">birdthday</span><span class="o">=</span><span class="n">visNumberObj</span><span class="o">.</span><span class="n">BirthDate</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">birdthday</span><span class="p">)</span><span class="o">=</span><span class="mi">8</span> <span class="n">birdthday</span><span class="o">=</span><span class="n">birdthday_</span><span class="s2">&#34;000000&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshSeq</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;DSR^Q03&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|LIS|||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">mshStr_cr</span> <span class="o">//</span><span class="s2">&#34;MSH|^~\&amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;MSA|AA|&#34;</span><span class="n">_mshSeq_</span><span class="s2">&#34;|Message accepted|||0|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;ERR|0|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;QAK|SR|OK|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_qrdStr_cr</span>  <span class="o">//</span><span class="s2">&#34;QRD|20160122110540|R|D|1|||RD||OTH|||T|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_qrfStr_cr</span>  <span class="o">//</span><span class="s2">&#34;QRF|iFlash3000|||||RCT|COR|ALL||&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|1||&#34;</span><span class="n">_visNumberObj</span><span class="o">.</span><span class="n">RegNo_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>		<span class="o">//</span><span class="err">住院号</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|2||&#34;</span><span class="n">_visNumberObj</span><span class="o">.</span><span class="n">BedNo_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>		<span class="o">//</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|3||&#34;</span><span class="n">_visNumberObj</span><span class="o">.</span><span class="n">SurName_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">	<span class="n">b</span> <span class="p">;</span><span class="n">a101</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|4||&#34;</span><span class="n">_birdthday_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">出生日期</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|5||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">S</span><span class="p">(</span><span class="n">visNumberObj</span><span class="o">.</span><span class="n">SpeciesDR</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;M&#34;</span><span class="p">,</span><span class="n">visNumberObj</span><span class="o">.</span><span class="n">SpeciesDR</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span><span class="s2">&#34;F&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;O&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|6|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">血型</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|7|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">种族</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|8|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">地址</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|9|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">邮编</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|10|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">家庭电话</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|11|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">样本位</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|12|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">样本采集时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|13|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">未用</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|14|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">未用</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|15|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">病人类别</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|16|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">医保帐号</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|17|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">收费类型</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|18|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">民族</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|19|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">籍贯</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|20|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">国家</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|21||&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//*</span><span class="err">样本条码</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|22||&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//*</span><span class="err">样本编号</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|23|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">送检时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|24||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">S</span><span class="p">(</span><span class="n">visNumberObj</span><span class="o">.</span><span class="n">Urgent</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;Y&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;N&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>				<span class="o">//*</span><span class="err">是否急诊</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|25|||||&#34;</span><span class="n">_cr</span>				<span class="o">//</span><span class="err">未用</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|26||&#34;</span><span class="n">_sampleType_</span><span class="s2">&#34;|||&#34;</span><span class="n">_cr</span>	<span class="o">//*</span><span class="err">样本类型</span><span class="p">(</span><span class="err">血清</span><span class="p">,</span><span class="err">血浆</span><span class="p">,</span><span class="err">尿液</span><span class="p">,</span><span class="err">脑脊液</span><span class="p">,</span><span class="err">其他</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|27|||||&#34;</span><span class="n">_cr</span>	<span class="o">//</span><span class="err">送检医生</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|28|||||&#34;</span><span class="n">_cr</span>		<span class="o">//</span><span class="err">送检科室</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_chlStr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSC|&#34;</span><span class="n">_DSC_</span><span class="s2">&#34;|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">    <span class="n">W</span> <span class="n">sb</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">!</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">TransResult</span><span class="p">(</span><span class="n">miRowId</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">N</span> <span class="p">(</span><span class="n">miRowId</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">miRowId</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">miRowId</span><span class="p">),</span><span class="n">result</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">result</span><span class="p">),</span><span class="n">newRes</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chlStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Continue</span><span class="p">:</span><span class="s1">&#39;$L(chlStr)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chl</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">chlStr</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,1)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">val</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">chlStr</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,2)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Continue</span><span class="p">:</span><span class="s1">&#39;$L(chl)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">res</span><span class="o">=</span><span class="n">val</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="n">chl</span><span class="o">&gt;</span><span class="mi">97</span><span class="p">,</span><span class="n">chl</span><span class="o">&lt;</span><span class="mi">102</span><span class="p">,</span><span class="n">val</span><span class="s1">&#39;[&#34;?&#34; {</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">res</span><span class="o">=$$</span><span class="n">GetQuaResult</span><span class="p">(</span><span class="n">miRowId</span><span class="p">,</span><span class="n">chl</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">newRes</span><span class="o">=</span><span class="n">newRes_chl_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_res_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">newRes</span><span class="p">)</span> <span class="n">newRes</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GetQuaResult</span><span class="p">(</span><span class="n">miRowId</span><span class="p">,</span><span class="n">chl</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">N</span> <span class="p">(</span><span class="n">miRowId</span><span class="p">,</span><span class="n">chl</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">miRowId</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">miRowId</span><span class="p">),</span><span class="n">chl</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">chl</span><span class="p">),</span><span class="n">res</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="n">res</span><span class="err">?</span><span class="mi">1</span><span class="s2">&#34;.&#34;</span><span class="mf">1.</span><span class="n">N</span> <span class="n">res</span><span class="o">=</span><span class="s2">&#34;0&#34;</span><span class="n">_res</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">orgRes</span><span class="o">=</span><span class="n">res</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">resPrefix</span><span class="o">=$</span><span class="n">E</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="s2">&#34;&lt;&gt;&#34;</span><span class="s1">&#39;[resPrefix resPrefix=&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">resPrefix</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">res</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">resPrefix</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(chl) orgRes</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:(</span><span class="n">res</span><span class="s1">&#39;?0.N1.&#34;.&#34;1.N)&amp;&amp;(res&#39;</span><span class="err">?</span><span class="mf">1.</span><span class="n">N</span><span class="p">)</span> <span class="n">orgRes</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tcRefRowId</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineTestCodeI</span><span class="p">(</span><span class="s2">&#34;IndexResultChannel&#34;</span><span class="p">,</span><span class="n">miRowId</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(chl),&#34;&#34;)) </span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(tcRefRowId) orgRes</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tcRowId</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineTestCodeD</span><span class="p">(</span><span class="n">tcRefRowId</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(tcRowId) orgRes</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">orderNo</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTTestCodeRangesI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">tcRowId</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(orderNo) orgRes</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">rangeDR</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTTestCodeRangesI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">tcRowId</span><span class="p">,</span><span class="n">orderNo</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(rangeDR) orgRes</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">rangeObj</span><span class="o">=</span><span class="c1">##Class(dbo.BTTestCodeRanges).%OpenId(rangeDR)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(rangeObj) orgRes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="n">res</span><span class="o">&gt;=</span><span class="n">rangeObj</span><span class="o">.</span><span class="n">ValueHigh</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="n">resPrefix</span><span class="o">=</span><span class="s2">&#34;&lt;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Q</span> <span class="n">orgRes</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span> <span class="s2">&#34;阳性(&#34;</span><span class="n">_orgRes_</span><span class="s2">&#34;)&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="n">ELSE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="n">resPrefix</span><span class="o">=</span><span class="s2">&#34;&gt;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Q</span> <span class="n">orgRes</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="s2">&#34;阴性(&#34;</span><span class="n">_orgRes_</span><span class="s2">&#34;)&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110220839-bac5x44.png"
	width="739"
	height="2110"
	srcset="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110220839-bac5x44_hu_6dc426e318beae44.png 480w, /p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110220839-bac5x44_hu_12e82eccffdfd945.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="35"
		data-flex-basis="84px"
	
></p>
<h4 id="回传三行-dsp">回传三行 DSP
</h4><blockquote>
<p>双向要求回传三行 DSP 信息，DSP1 为患者信息，DSP2 为标本信息，DSP3 为检测项目信息。</p></blockquote>
<h5 id="示例接口美康生化">示例接口(美康生化)
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">MIFCL600OI</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">仪器名称</span><span class="p">:</span>	<span class="err">血细胞分析流水线</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">仪器型号</span><span class="p">:</span>	<span class="err">迈瑞</span><span class="n">HL7</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">仪器厂商</span><span class="p">:</span>	<span class="err">迈瑞</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">通信协议</span><span class="p">:</span>	<span class="n">HL7</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">交互方式</span><span class="p">:</span>	<span class="err">双</span> <span class="err">向</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">接</span>    <span class="err">口</span><span class="p">:</span>	<span class="n">TCP</span><span class="o">/</span><span class="ne">IP</span><span class="p">,</span><span class="n">RS232</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">备</span>    <span class="err">注</span><span class="p">:</span>	<span class="err">仪器配置</span><span class="p">:</span><span class="err">选择</span><span class="n">HL7协议</span><span class="p">,</span><span class="err">散点图选择</span><span class="p">:</span><span class="err">位图</span>   
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(mi)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">par11</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">12</span><span class="p">)</span> 		<span class="o">//</span><span class="err">项目分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">par10</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">13</span><span class="p">)</span> 	<span class="o">//</span><span class="err">结果分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AntDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">14</span><span class="p">)</span> 		<span class="o">//</span><span class="err">抗生素分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SenDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span> 		<span class="o">//</span><span class="err">药敏结果分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">par4</span><span class="o">=</span><span class="s2">&#34;|TCP|&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>  	<span class="o">//</span><span class="err">端口号</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">stx</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">etx</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ack</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">enq</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">eot</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">etb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">lf</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">nak</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">21</span><span class="p">),(</span><span class="n">AllRecord</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">kk</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">errFlag</span><span class="p">,</span><span class="n">resultType</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">$</span><span class="n">ZT</span><span class="o">=</span><span class="s2">&#34;ErrHandler&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">EC</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="o">$$</span><span class="n">Start</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="ne">IP</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Port</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LinkTime</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Device</span><span class="o">=</span><span class="s2">&#34;|TCP|&#34;</span><span class="n">_Port</span>
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">try</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">ZA</span><span class="p">,</span><span class="s2">&#34;ZA&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="err">未启动客户端</span><span class="o">/</span><span class="err">服务端</span><span class="mi">0</span><span class="err">，客户端断开连接标志</span><span class="mi">20484</span><span class="err">，无客户端连接</span><span class="mi">20480</span><span class="err">，有客户端连接</span><span class="mi">28674</span><span class="err">，连接并建立数据传输</span><span class="mi">28672</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="n">lis断开</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span> <span class="o">$</span><span class="n">ZA</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">h</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">				<span class="n">open</span> <span class="n">Device</span><span class="p">:(</span><span class="ne">IP</span><span class="p">:</span><span class="n">Port</span><span class="p">:</span><span class="o">/</span><span class="n">IOTABLE</span><span class="o">=</span><span class="s2">&#34;GB18030&#34;</span><span class="p">):</span><span class="mi">20</span>
</span></span><span class="line"><span class="cl">				<span class="n">use</span> <span class="n">Device</span>
</span></span><span class="line"><span class="cl">				<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;lis断开连接&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;lisReConnect&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">throw</span> <span class="c1">##class(%Exception.General).%New(&#34;ConnectError&#34;,&#34;D&#34;,,&#34;重新连接失败&#34;)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="err">仪器断开，或者无数据</span><span class="mi">1</span><span class="nb">min</span><span class="err">，重启</span><span class="n">tcp</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span> <span class="p">((</span><span class="o">$</span><span class="n">ZA</span><span class="o">=</span><span class="s2">&#34;20484&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">close</span> <span class="n">par4</span>
</span></span><span class="line"><span class="cl">				<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;仪器断开连接&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;blockConnect&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">h</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">				<span class="n">open</span> <span class="n">Device</span><span class="p">:(</span><span class="ne">IP</span><span class="p">:</span><span class="n">Port</span><span class="p">:</span><span class="o">/</span><span class="n">IOTABLE</span><span class="o">=</span><span class="s2">&#34;GB18030&#34;</span><span class="p">):</span><span class="mi">20</span>
</span></span><span class="line"><span class="cl">				<span class="n">use</span> <span class="n">Device</span>
</span></span><span class="line"><span class="cl">				<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;重新连接&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;reConnect&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">s</span> <span class="n">LinkTime</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="err">连接无数据传输，</span><span class="n">main每执行6次</span><span class="err">，即</span><span class="mi">1</span><span class="nb">min</span><span class="err">，重启</span><span class="n">tcp</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span> <span class="o">$</span><span class="n">ZA</span><span class="o">=</span><span class="s2">&#34;28674&#34;</span> <span class="n">s</span> <span class="n">LinkTime</span><span class="o">=$</span><span class="n">i</span><span class="p">(</span><span class="n">LinkTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="err">正常传输了，就清空计数</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span> <span class="o">$</span><span class="n">ZA</span><span class="o">=</span><span class="s2">&#34;28672&#34;</span> <span class="n">s</span> <span class="n">LinkTime</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">			<span class="n">d</span> <span class="n">Main</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span><span class="n">catch</span> <span class="n">ex</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 <span class="n">s</span> <span class="n">exception</span><span class="o">=</span><span class="s2">&#34;错误:&#34;</span><span class="n">_ex</span><span class="o">.</span><span class="n">Location_</span><span class="s2">&#34;^&#34;</span><span class="n">_ex</span><span class="o">.</span><span class="n">Data_ex</span><span class="o">.</span><span class="n">Name</span>
</span></span><span class="line"><span class="cl">		 <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">exception</span><span class="p">,</span><span class="s2">&#34;读取或写入异常，重启服务端&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="o">$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">C</span> <span class="n">par4</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Main</span>
</span></span><span class="line"><span class="cl">	<span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$TEST	//如果超时则退出</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=sb   //以sb开头</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">errFlag</span><span class="p">,</span><span class="n">resultType</span><span class="p">,</span><span class="n">msgType</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="n">mshStr</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">startTime</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="n">PLIST</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">curTime</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="n">curTime</span><span class="o">&gt;</span><span class="p">(</span><span class="n">startTime</span><span class="o">+</span><span class="mi">300</span><span class="p">)</span>  <span class="o">//</span><span class="mi">5</span><span class="err">分钟内没有处理完则退出循环</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="o">$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$TEST	//如果超时则退出</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)))</span><span class="o">&gt;=</span><span class="mi">32700</span> <span class="p">{</span>  <span class="o">//</span><span class="mi">32767</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">index</span><span class="o">=+$</span><span class="n">O</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=eb,$C(R)&#39;</span><span class="o">=</span><span class="n">cr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">))</span><span class="n">_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">cr</span> <span class="p">{</span>  	<span class="o">//</span><span class="err">解析一条记录</span>
</span></span><span class="line"><span class="cl">			<span class="n">D</span> <span class="n">Record</span>
</span></span><span class="line"><span class="cl">			<span class="n">K</span> <span class="n">PLIST</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eb</span>   	<span class="o">//</span><span class="err">循环读取</span><span class="p">,</span><span class="err">当为</span><span class="n">eb的时候则退出</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="s2">&#34;result&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">Save</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Record</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">index</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">base64Stream</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">isImage</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">isBinary</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">OldgraphDataDIFF</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">OldgraphDataBaso</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">index</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(index)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">record</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span><span class="n">cr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Continue</span><span class="p">:</span><span class="s1">&#39;$L(record)</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">segmentType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;MSH&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">信息头信息</span>
</span></span><span class="line"><span class="cl">				<span class="n">S</span> <span class="n">mshStr</span><span class="o">=</span><span class="n">record</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="err">消息类型</span>
</span></span><span class="line"><span class="cl">    			<span class="n">S</span> <span class="n">msgType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="o">//</span><span class="n">ORU</span><span class="p">,</span><span class="n">ACK</span><span class="p">,</span><span class="n">QRY</span><span class="p">,</span><span class="n">QCK</span><span class="p">,</span><span class="n">DSR</span>
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">msgType</span><span class="o">=</span><span class="s2">&#34;ORU&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">D</span> <span class="n">SendACK</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    		<span class="n">I</span> <span class="n">msgType</span><span class="o">=</span><span class="s2">&#34;ORM&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    		<span class="n">S</span> <span class="n">resultType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;PID&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">患者信息</span>
</span></span><span class="line"><span class="cl">				
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;PVI&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">就诊信息</span>
</span></span><span class="line"><span class="cl">				
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;OBR&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">医嘱信息</span>
</span></span><span class="line"><span class="cl">				<span class="n">S</span> <span class="n">epis</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    			<span class="n">S</span><span class="p">:</span><span class="s1">&#39;$l(epis) epis=$P(record,&#34;|&#34;,3)</span>
</span></span><span class="line"><span class="cl">	     		<span class="n">S</span> <span class="n">code</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	     		<span class="n">I</span> <span class="n">code</span><span class="o">=</span><span class="s2">&#34;00003&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="n">LJ</span> <span class="n">QCR</span>
</span></span><span class="line"><span class="cl">		     	
</span></span><span class="line"><span class="cl">		     	<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;OBX&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">S</span> <span class="n">dataTye</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>  <span class="o">//</span><span class="n">NM</span> <span class="p">(</span><span class="n">numeric</span><span class="p">)</span> <span class="err">表示数字值，用于定量项目</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     										<span class="o">//</span><span class="n">ST</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="err">表示字符串值，用于定性项目</span>
</span></span><span class="line"><span class="cl">    			<span class="n">S</span> <span class="n">channel</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    			<span class="n">S</span> <span class="n">channel</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    			<span class="o">//</span><span class="n">s</span><span class="p">:</span><span class="s1">&#39;$l(channel) channel=$P(record,&#34;|&#34;,5)</span>
</span></span><span class="line"><span class="cl">    			<span class="n">S</span> <span class="n">value</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    			<span class="n">i</span> <span class="n">value</span><span class="p">[</span><span class="s2">&#34;&lt;&#34;</span> <span class="n">s</span> <span class="n">value</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;&lt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    			<span class="n">i</span> <span class="n">value</span><span class="p">[</span><span class="s2">&#34;&gt;&#34;</span> <span class="n">s</span> <span class="n">value</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;&gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;SI&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="n">value</span><span class="o">=</span><span class="err">浊度</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">^</span><span class="err">溶血</span><span class="p">(</span><span class="n">H</span><span class="p">)</span><span class="o">^</span><span class="err">黄疸</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="n">result</span><span class="o">=</span><span class="n">result_channel_</span><span class="s2">&#34;H&#34;</span><span class="n">_par10_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_par11</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="n">result</span><span class="o">=</span><span class="n">result_channel_</span><span class="s2">&#34;I&#34;</span><span class="n">_par10_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="n">_par11</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span> <span class="n">value</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;ST&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    				<span class="n">S</span> <span class="n">value</span><span class="o">=$</span><span class="n">S</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&#34;ò?D?&#34;</span><span class="p">:</span><span class="s2">&#34;阴性&#34;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s2">&#34;??D?&#34;</span><span class="p">:</span><span class="s2">&#34;阳性&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span><span class="n">dataTye</span><span class="s1">&#39;=&#34;ED&#34;,dataTye&#39;</span><span class="o">=</span><span class="s2">&#34;IS&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span> <span class="n">result</span><span class="o">=</span><span class="n">result_channel_par10_value_par11</span>
</span></span><span class="line"><span class="cl">    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;IS&#34;</span> <span class="p">{</span>	  
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;05001&#34;</span><span class="p">,</span><span class="n">resultType</span><span class="o">=</span><span class="s2">&#34;Q&#34;</span> <span class="p">{</span>		<span class="o">//</span><span class="err">质控浓度</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">S</span> <span class="n">epis</span><span class="o">=</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">		    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    			<span class="n">S</span> <span class="n">graphTypeDesc</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34;U&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;ED&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">图形数据</span>
</span></span><span class="line"><span class="cl">    				<span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Image&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">isImage</span><span class="o">=</span><span class="mi">1</span>  	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Octer-stream&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">S</span> <span class="n">isBinary</span><span class="o">=</span><span class="mi">1</span>	<span class="o">//</span><span class="err">二进制数据</span><span class="p">(</span><span class="err">需要绘图</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="n">channel</span>
</span></span><span class="line"><span class="cl">    				<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15050&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;RBC&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15056&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;RBC&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15100&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;PLT&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15116&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;PLT&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15200&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;WBC-DIFFBMP&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15201&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="p">(</span><span class="n">isImage</span><span class="p">,</span><span class="n">isBinary</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>	<span class="o">//</span><span class="err">暂时不处理二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;WBC-DIFF&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15202&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="p">(</span><span class="n">isImage</span><span class="p">,</span><span class="n">isBinary</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>	<span class="o">//</span><span class="err">暂时不处理二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;WBC-DIFF&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15250&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;BASOBMP&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15251&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="p">(</span><span class="n">isImage</span><span class="p">,</span><span class="n">isBinary</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>	<span class="o">//</span><span class="err">暂时不处理二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;BASO&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15300&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;RET&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15306&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="p">(</span><span class="n">isImage</span><span class="p">,</span><span class="n">isBinary</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>	<span class="o">//</span><span class="err">暂时不处理二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;RET&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15301&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;PLT-0&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15302&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;RET-EXT&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15350&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;NRBC&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15354&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="p">(</span><span class="n">isImage</span><span class="p">,</span><span class="n">isBinary</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>	<span class="o">//</span><span class="err">暂时不处理二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;NRBC&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span> <span class="n">graphData</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    		
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span> <span class="n">graphDataType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">graphDataType</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Base64&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">graphType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;RBC&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;RBC&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;Histogram#RBC#RBC######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RBC#RBC######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">mi</span><span class="p">),</span><span class="s2">&#34;绘图：RBC&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;PLT&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;PLT&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;Histogram#PLT#PLT######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#PLT#RBC######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">mi</span><span class="p">),</span><span class="s2">&#34;绘图：PLT&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;WBC&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="n">OldgraphDataDIFF</span><span class="o">=</span><span class="n">graphData</span>
</span></span><span class="line"><span class="cl">						<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;WBC-DIFF&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#DIFF#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#DIFF#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">mi</span><span class="p">),</span><span class="s2">&#34;绘图：wbc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;WNB&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">OldgraphDataBaso</span><span class="o">=</span><span class="n">graphData</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;BASO&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#WNB#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#Baso#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;ORC&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">就诊信息</span>
</span></span><span class="line"><span class="cl">				<span class="n">S</span> <span class="n">barcode</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="n">barcode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="o">//</span><span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span> <span class="p">{</span>  <span class="o">//</span><span class="err">双向</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="p">}</span> <span class="n">Invalid</span> <span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">				<span class="n">d</span> <span class="n">SendORR</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">barcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;QRD&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">就诊信息</span>
</span></span><span class="line"><span class="cl">				<span class="n">S</span> <span class="n">barcode</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">s</span> <span class="n">qrdStr</span><span class="o">=</span><span class="n">record</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="n">barcode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="o">//</span><span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span> <span class="p">{</span>  <span class="o">//</span><span class="err">双向</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="p">}</span> <span class="n">Invalid</span> <span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">qrdStr</span><span class="p">,</span><span class="n">qrfStr</span><span class="p">,</span><span class="n">barcode</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;QRF&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">就诊信息</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span><span class="n">S</span> <span class="n">barcode</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">s</span> <span class="n">qrfStr</span><span class="o">=</span><span class="n">record</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="n">barcode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="o">//</span><span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span> <span class="p">{</span>  <span class="o">//</span><span class="err">双向</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="p">}</span> <span class="n">Invalid</span> <span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">qrdStr</span><span class="p">,</span><span class="n">qrfStr</span><span class="p">,</span><span class="n">barcode</span>
</span></span><span class="line"><span class="cl">				<span class="n">d</span> <span class="n">SendDSP</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">qrdStr</span><span class="p">,</span><span class="n">qrfStr</span><span class="p">,</span><span class="n">barcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="o">//</span><span class="n">I</span> <span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;ED&#34;</span><span class="p">,</span><span class="n">index</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">base64Stream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="n">D</span> <span class="n">base64Stream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="n">i</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;WBC-DIFFBMP&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    <span class="o">//.</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;WBC-DIFF&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">OldgraphDataDIFF</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFBC6800BI&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#DIFF#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="o">//</span><span class="n">i</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;BASOBMP&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    <span class="o">//.</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;BASO&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">OldgraphDataBaso</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFBC6800BI&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#Baso#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="n">s</span> <span class="n">miCode</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="o">//</span><span class="n">i</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;WBC-DIFF&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">			<span class="o">//.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">miCode_</span><span class="s2">&#34;:&#34;</span><span class="n">_epis_</span><span class="s2">&#34;:&#34;</span><span class="n">_graphType</span><span class="p">,</span><span class="s2">&#34;SaveImage&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="o">//.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.Common.MIFBase).SaveBase64ToMachine(mi,epis,graphType,base64Stream,epis_&#34;-&#34;_graphType,miCode)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="o">//</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="n">SendDSP</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIFMEIKANG</span><span class="p">(</span><span class="mi">63</span><span class="p">,</span><span class="s2">&#34;MSH|^~\&amp;|HOST|Unkown□Device|FMIS||20240410153949||QRY^Q02|2|P|2.3.1||||0||ANSI||&#34;</span><span class="p">,</span><span class="s2">&#34;QRD|20240410153949|BC|D|0|||RD|1000860681||Rack^Pos|N|T&#34;</span><span class="p">,</span><span class="s2">&#34;QRF|Unkown□Device|20240410000000|20240410235959|||RCT|COR|ALL|&#34;</span><span class="p">,</span><span class="s2">&#34;1000860681&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">SendDSP</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">qrdStr</span><span class="p">,</span><span class="n">qrfStr</span><span class="p">,</span><span class="n">barcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">qrdStr</span><span class="p">,</span><span class="n">qrfStr</span><span class="p">,</span><span class="n">barcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">mshStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mshStr</span><span class="p">),</span><span class="n">barcode</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">barcode</span><span class="p">),</span><span class="n">qrdStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">qrdStr</span><span class="p">),</span><span class="n">qrfStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">qrfStr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;开始上传&#34;</span><span class="p">,</span><span class="s2">&#34;Upload&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;Upload&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">qrdStr</span><span class="p">,</span><span class="s2">&#34;Upload&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">qrfStr</span><span class="p">,</span><span class="s2">&#34;Upload&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="p">;</span><span class="n">a102</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="s1">&#39;$L(barcode) {</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码号为空&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>   
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>             <span class="o">//</span><span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码扫描错误,机器未识别&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">labno</span><span class="o">=</span><span class="n">barcode</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">workGroupMachineDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">visiNumberDR</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="s1">&#39;$L(visiNumberDR) {</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_labno_</span><span class="s2">&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">visNumberObj</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumber).%OpenId(visiNumberDR)</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="s1">&#39;$L(visNumberObj) {</span>
</span></span><span class="line"><span class="cl">        <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_labno_</span><span class="s2">&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;Upload Start&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">result</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">chlStr</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">chlCnt</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chl</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(chl)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chlStr</span><span class="o">=</span><span class="n">chlStr_chl_</span><span class="s2">&#34;^&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chlCnt</span><span class="o">=</span><span class="n">chlCnt</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span><span class="n">S</span> <span class="n">result</span><span class="o">=</span><span class="n">result_chl_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;?&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">I</span> <span class="s1">&#39;$L(chlStr) {</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_labno_</span><span class="s2">&#34;对应的化验项目信息,确定医嘱或项目维护正确?&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">chlStr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">chlStr</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">chlStr</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">*-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">/*</span>
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chl</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(chl)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chlStr</span><span class="o">=</span><span class="n">chlStr_</span><span class="s2">&#34;DSP|&#34;</span><span class="n">_chlCnt_</span><span class="s2">&#34;||&#34;</span><span class="n">_chl_</span><span class="s2">&#34;^^^|||&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chlCnt</span><span class="o">=</span><span class="n">chlCnt</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span><span class="n">S</span> <span class="n">result</span><span class="o">=</span><span class="n">result_chl_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;?&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">I</span> <span class="s1">&#39;$L(chlStr) {</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_labno_</span><span class="s2">&#34;对应的化验项目信息,确定医嘱或项目维护正确?&#34;</span><span class="p">,</span><span class="s2">&#34;Upload Error&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">Save</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">specimenDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">visiNumberDR</span><span class="p">)),</span><span class="mi">56</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">specimenName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">specimenDR</span><span class="p">)</span> <span class="n">specimenName</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpecimenD</span><span class="p">(</span><span class="n">specimenDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">sampleType</span><span class="o">=</span><span class="s2">&#34;其他&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">specimenName</span><span class="p">),</span><span class="s2">&#34;,血清,血浆,尿液,脑脊液,&#34;</span><span class="p">[(</span><span class="s2">&#34;,&#34;</span><span class="n">_specimenName_</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">sampleType</span><span class="o">=</span><span class="n">specimenName</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">birdthday</span><span class="o">=</span><span class="n">visNumberObj</span><span class="o">.</span><span class="n">BirthDate</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">birdthday</span><span class="p">)</span><span class="o">=</span><span class="mi">8</span> <span class="n">birdthday</span><span class="o">=</span><span class="n">birdthday_</span><span class="s2">&#34;000000&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="s1">&#39;$L(mshStr) mshStr=&#34;MSH|^~\&amp;|YHLO|iFlash3000|||20161208150935||QRY^Q02|18|P|2.3.1||||||ASCII|||&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshSeq</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;DSR^Q03&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|LIS|||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">episode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">workGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span> <span class="o">//</span><span class="c1">##Class(MI.Instrument).GetWorkGroupMachineRowId(mi)</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">workGroupMachineDR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    	<span class="n">S</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">visiNumberDR</span><span class="p">,</span><span class="n">workGroupMachineDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">OrderNo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    	<span class="n">S</span> <span class="n">reportDR</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">visiNumberDR</span><span class="p">,</span><span class="n">workGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	    	<span class="n">S</span> <span class="n">episode</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="o">//</span><span class="c1">##Class(LIS.Core.Report).GetEpisodeNumber(reportDR)</span>
</span></span><span class="line"><span class="cl">	    	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">reportDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Assayno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">reportDR</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Date</span><span class="o">=$</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">datetime</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>	<span class="o">//</span><span class="err">时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">JZHWZ</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">qrdStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>		<span class="o">//</span><span class="err">架子号位置</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">mshStr_cr</span> <span class="o">//</span><span class="s2">&#34;MSH|^~\&amp;|||||20160122110540||DSR^Q03|14|P|2.3.1||||||ASCII|||&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;MSA|OK|&#34;</span><span class="n">_mshSeq_</span><span class="s2">&#34;||||0&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|1||&#34;</span><span class="n">_visNumberObj</span><span class="o">.</span><span class="n">RegNo_</span><span class="s2">&#34;|&#34;</span><span class="n">_episode_</span><span class="s2">&#34;|&#34;</span><span class="n">_visNumberObj</span><span class="o">.</span><span class="n">SurName_</span><span class="s2">&#34;|||||||||||||||||||||||||&#34;</span><span class="n">_cr</span>	
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|2|&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;|&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;||N||&#34;</span><span class="n">_datetime_</span><span class="s2">&#34;||1|&#34;</span><span class="n">_JZHWZ_</span><span class="s2">&#34;||N||&#34;</span><span class="n">_datetime_</span><span class="s2">&#34;||||||||&#34;</span><span class="n">_datetime_</span><span class="s2">&#34;||||||||||||||||||||||||&#34;</span><span class="n">_cr</span>	
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">order</span><span class="o">=</span><span class="n">order_</span><span class="s2">&#34;DSP|3|&#34;</span><span class="n">_chlCnt_</span><span class="s2">&#34;|&#34;</span><span class="n">_chlStr_cr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">W</span> <span class="n">sb</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="p">;</span><span class="n">a101</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">sb_order_eb_cr</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">//$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZDT</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="s2">&#34; :&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">Save</span>  
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;^&#34;</span><span class="n">_result</span><span class="p">,</span><span class="s2">&#34;Test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  	<span class="n">I</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  	<span class="n">S</span> <span class="n">QC</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  		<span class="n">D</span> <span class="n">Save</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  	<span class="n">S</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">resultType</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">Q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">SendACK</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="n">errCode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">errDesc</span><span class="o">=</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">)</span> <span class="o">//</span><span class="n">send</span> <span class="s1">&#39;ack&#39;</span> <span class="n">to</span> <span class="n">instrument</span> 
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">ackType</span><span class="p">,</span><span class="n">errCode</span><span class="p">,</span><span class="n">errDesc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">mshStr</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mshStr</span><span class="p">),</span><span class="n">ackType</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ackType</span><span class="p">),</span><span class="n">errCode</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">errCode</span><span class="p">),</span><span class="n">errDesc</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">errDesc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:(</span><span class="s1">&#39;$l(mi))||(&#39;</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">Q</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">21</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">msgRoutine</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">seq</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|LIS|||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;ACK^&#34;</span><span class="n">_msgRoutine</span>
</span></span><span class="line"><span class="cl">    <span class="n">W</span> <span class="n">sb</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;MSA|&#34;</span><span class="n">_ackType_</span><span class="s2">&#34;|&#34;</span><span class="n">_seq_</span><span class="s2">&#34;|&#34;</span><span class="n">_errDesc_</span><span class="s2">&#34;|||&#34;</span><span class="n">_errCode_</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">S</span><span class="p">(</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AE&#34;</span><span class="p">:</span><span class="s2">&#34;Error&#34;</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AR&#34;</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;NULL&#34;</span><span class="p">),</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">ErrHandler</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZERROR</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="s2">&#34;--&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;.错误代码:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ECODE</span><span class="p">,</span><span class="s2">&#34;Runtime Error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">h</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">保存直方图</span>
</span></span><span class="line"><span class="cl"><span class="n">SaveHistogram</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">graphType</span><span class="p">,</span><span class="n">graphOrder</span><span class="p">,</span><span class="n">base64Stream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">graphType</span><span class="p">,</span><span class="n">graphOrder</span><span class="p">,</span><span class="n">base64Stream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">epis</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="n">graphType</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">graphType</span><span class="p">),</span><span class="n">graphOrder</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">graphOrder</span><span class="p">),</span><span class="n">base64Stream</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">base64Stream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(mi) 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(epis) 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(base64Stream) 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(graphType) 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span><span class="p">:</span><span class="s1">&#39;$L(graphOrder) graphOrder=0</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">glBinaryStream</span><span class="o">=</span><span class="c1">##Class(%GlobalBinaryStream).%New()</span>
</span></span><span class="line"><span class="cl">    <span class="n">While</span> <span class="s1">&#39;base64Stream.AtEnd {</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">base64</span><span class="o">=</span><span class="n">base64Stream</span><span class="o">.</span><span class="n">Read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">binary</span><span class="o">=$</span><span class="n">system</span><span class="o">.</span><span class="n">Encryption</span><span class="o">.</span><span class="n">Base64Decode</span><span class="p">(</span><span class="n">base64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="n">D</span> <span class="n">glBinaryStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">charStream</span><span class="o">=</span><span class="c1">##Class(%GlobalCharacterStream).%New()</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">maxDot</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">While</span> <span class="s1">&#39;glBinaryStream.AtEnd {</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">char</span><span class="o">=</span><span class="n">glBinaryStream</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">ascValue</span><span class="o">=$</span><span class="n">ASCII</span><span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">maxDot</span><span class="o">=</span><span class="n">maxDot</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	    <span class="n">D</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">ascValue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="n">glBinaryStream</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">title</span><span class="o">=</span><span class="n">graphType</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">foreColor</span><span class="o">=</span><span class="mi">12</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;PLT&#34;</span> <span class="n">foreColor</span><span class="o">=</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">top</span><span class="o">=</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">left</span><span class="o">=</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">width</span><span class="o">=</span><span class="mi">300</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">height</span><span class="o">=</span><span class="mi">150</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">maxValue</span><span class="p">,</span><span class="n">memo</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">error</span><span class="o">=</span><span class="c1">##Class(MI.Instrument).SaveHistogram(charStream,mi,epis,graphType,graphOrder,label,title,maxDot,maxValue,memo,foreColor,top,left,width,height)</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">TR</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="s2">&#34;--&#34;</span><span class="p">),</span><span class="s2">&#34;Graph Error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="n">charStream</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">SendORR</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span> <span class="n">AckType</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="n">ErrCode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ErrDesc</span><span class="o">=</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="n">AckType</span><span class="p">,</span><span class="n">ErrCode</span><span class="p">,</span><span class="n">ErrDesc</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">record</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">record</span><span class="p">),</span><span class="n">AckType</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">AckType</span><span class="p">),</span><span class="n">ErrCode</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ErrCode</span><span class="p">),</span><span class="n">ErrDesc</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ErrDesc</span><span class="p">),</span><span class="n">mshStr</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mshStr</span><span class="p">),</span><span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">Q</span><span class="p">:(</span><span class="s1">&#39;$l(mi))||(&#39;</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">	 <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	 <span class="n">S</span> <span class="n">seq</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|LIS||||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   	 <span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;ORR^O02&#34;</span>
</span></span><span class="line"><span class="cl">   	 <span class="n">s</span> <span class="n">isRecieve</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">   	 <span class="n">s</span> <span class="n">wgDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">   	 <span class="n">s</span> <span class="n">wgDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="o">//&amp;</span><span class="n">sql</span><span class="p">(</span><span class="n">SELECT</span> <span class="n">EpisodeNo</span> <span class="n">into</span> <span class="p">:</span><span class="n">isRecieve</span> <span class="n">FROM</span> <span class="n">dbo</span><span class="o">.</span><span class="n">RP_VisitNumberReport</span> <span class="n">where</span> <span class="n">AssayNo</span><span class="o">=</span><span class="p">:</span><span class="n">epis</span> <span class="ow">and</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="p">:</span><span class="n">wgDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">isRecieve</span><span class="o">=</span><span class="n">epis</span> <span class="o">//</span><span class="c1">##class(HIS.DHCReportPrint).GetReportAssayNoMTHD(mi,epis)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">MSACode</span><span class="o">=</span><span class="n">seq</span>
</span></span><span class="line"><span class="cl">	 <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">isRecieve</span><span class="p">,</span><span class="s2">&#34;isRecieve is &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">i</span> <span class="p">(</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">isRecieve</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">{</span>
</span></span><span class="line"><span class="cl">		 <span class="n">s</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&#34;AR&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="p">}</span>
</span></span><span class="line"><span class="cl">	 <span class="n">i</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		 <span class="n">s</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&#34;AR&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="p">}</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">MSA</span><span class="o">=</span><span class="s2">&#34;MSA|&#34;</span><span class="n">_flag_</span><span class="s2">&#34;|&#34;</span><span class="n">_MSACode</span>
</span></span><span class="line"><span class="cl">	 <span class="n">i</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&#34;AR&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 <span class="n">S</span> <span class="n">TMPCORDE</span><span class="o">=</span><span class="n">sb_mshStr_cr_MSA_cr_eb_cr</span>
</span></span><span class="line"><span class="cl">		 <span class="n">W</span> <span class="n">sb</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">MSA</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">		 <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">TMPCORDE</span><span class="p">,</span><span class="s2">&#34;H-&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PatInfomation</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PatInfomation</span><span class="o">=$$</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;PatInfomation is&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="p">(</span><span class="n">RegNo</span><span class="p">,</span><span class="n">Name</span><span class="p">,</span><span class="n">Birth</span><span class="p">,</span><span class="n">Species</span><span class="p">,</span><span class="n">PatType</span><span class="p">,</span><span class="n">LOC</span><span class="p">,</span><span class="n">BedNo</span><span class="p">,</span><span class="n">Fee</span><span class="p">,</span><span class="n">Srcdocno</span><span class="p">,</span><span class="n">PatAge</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="k">if</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">RegNo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">Name</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">Birth</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">29</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;Male&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;2&#34;</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;Fmale&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PatType</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">LOC</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">Fee</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">Srcdocno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PatAge</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">}</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PID</span><span class="o">=</span><span class="s2">&#34;PID|1||&#34;</span><span class="n">_RegNo_</span><span class="s2">&#34;^^^^MR||&#34;</span><span class="n">_Name_</span><span class="s2">&#34;||&#34;</span><span class="n">_Birth_</span><span class="s2">&#34;|&#34;</span><span class="n">_Species</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PV1</span><span class="o">=</span><span class="s2">&#34;PV1|1|&#34;</span><span class="n">_PatType_</span><span class="s2">&#34;|&#34;</span><span class="n">_LOC_</span><span class="s2">&#34;^^&#34;</span><span class="n">_BedNo_</span><span class="s2">&#34;|||||||||||||||||&#34;</span><span class="n">_Fee</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">ORC</span><span class="o">=</span><span class="s2">&#34;ORC|AF||&#34;</span><span class="n">_epis</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">curTime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">randomNumber</span><span class="o">=</span><span class="mi">1000</span><span class="o">+$</span><span class="n">r</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">OBR</span><span class="o">=</span><span class="s2">&#34;OBR|1|&#34;</span><span class="n">_epis_</span><span class="s2">&#34;||00001^Automated Count^99MRC||&#34;</span><span class="n">_curTime_randomNumber_</span><span class="s2">&#34;||||&#34;</span><span class="n">_Srcdocno_</span><span class="s2">&#34;||||||||||||||HM||||||||Bill&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">TestCodeDate</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">TestCodeDate</span><span class="o">=$$</span><span class="n">SearchTestItem</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">OBX</span><span class="o">=</span><span class="s2">&#34;OBX|1|IS|08003^Test Mode^99MRC||&#34;</span><span class="n">_TestCodeDate_</span><span class="s2">&#34;||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|2|IS|01002^Ref Group^99MRC||Child||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|3|NM|30525-0^Age^LN||&#34;</span><span class="n">_PatAge_</span><span class="s2">&#34;|yr|||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|4|ST|01001^Remark^99MRC||&#34;</span><span class="n">_PatType_</span><span class="s2">&#34;||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|5|ST|08005^SerialNumber^99MRC||&#34;</span><span class="n">_isRecieve_</span><span class="s2">&#34;||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|6|IS|01007^Sample Type^99MRC||Venous blood||||||&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|7|IS|01008^Patient Area^99MRC||A - 501||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|8|ST|01009^Custom patient info 1^99MRC||Nothing||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|9|ST|01010^Custom patient info 2^99MRC||Nothing||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|10|ST|01011^Custom patient info 3^99MRC||Nothing||||||F&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">TMPORDER</span><span class="o">=</span><span class="n">sb_mshStr_cr_MSA_cr_PID_cr_PV1_cr_ORC_cr_OBR_cr_OBX_cr_eb_cr</span>
</span></span><span class="line"><span class="cl">		<span class="n">w</span> <span class="n">sb</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">MSA</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">PID</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">PV1</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">ORC</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">OBR</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">OBX</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">TMPORDER</span><span class="p">,</span><span class="s2">&#34;H-&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="n">SearchTestItem</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">tc</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">	   <span class="n">f</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">s</span> <span class="n">tc</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">tc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	 	 <span class="n">q</span><span class="p">:</span><span class="n">tc</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	 	 <span class="n">i</span> <span class="s1">&#39;$l(tcx){</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tc</span> 
</span></span><span class="line"><span class="cl">	 	 <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    	<span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_</span><span class="s2">&#34;+&#34;</span><span class="n">_tc</span>
</span></span><span class="line"><span class="cl">	 	 <span class="p">}</span>
</span></span><span class="line"><span class="cl">  	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="n">tcx</span>
</span></span><span class="line"><span class="cl"><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">labno</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">VisitNumberDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="s2">&#34; &#34;</span><span class="n">_labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">标本信息</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RPVisitNumberData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LocationDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">),</span><span class="n">Location</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Location</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">DoctorDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">Doctor</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Doctor</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDoctorD</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveUserDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">68</span><span class="p">),</span><span class="n">ReceiveUser</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">ReceiveUser</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">SYSUserD</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RegNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SurName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">GivenName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">SurName</span><span class="o">=</span><span class="n">GivenName</span> <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName_GivenName</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SpeciesDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span><span class="n">Species</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AdmTypeDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">AdmType</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AdmType</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAdmissionTypeD</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BirthDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AgeUnitDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span><span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAgeUnitD</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CollectDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">51</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CollectTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Sampleda</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Instrument</span> <span class="o">=</span> <span class="s2">&#34;XN&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">s</span> <span class="n">Instrument</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sampleno</span><span class="o">=</span><span class="n">labno</span>   <span class="o">//</span><span class="err">检测号</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sampletype</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">Feetype</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">;</span><span class="err">费别</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Srcdepno</span><span class="o">=</span><span class="n">Location</span>  <span class="p">;</span><span class="err">送检科室</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Srcdocno</span><span class="o">=</span><span class="n">Doctor</span>   <span class="p">;</span><span class="err">送检医生</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Userno</span><span class="o">=</span><span class="n">ReceiveUser</span> <span class="p">;</span><span class="err">检验医生</span><span class="p">(</span><span class="err">录入者</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Patno</span><span class="o">=</span><span class="n">RegNo</span> <span class="p">;</span><span class="err">登记号</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BarCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Patna</span><span class="o">=</span><span class="n">PatName</span>   <span class="p">;</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="mi">1</span>  <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;男&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>     <span class="p">;</span><span class="mi">1</span><span class="p">:</span><span class="err">男</span> <span class="err">，</span><span class="mi">2</span> <span class="err">女</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">Species</span> <span class="o">=</span><span class="s2">&#34;女&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Pattype</span><span class="o">=</span><span class="n">AdmType</span>   <span class="p">;</span><span class="err">病人类型</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Bedno</span> <span class="o">=</span> <span class="n">BedNo</span>    <span class="p">;</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Patage</span><span class="o">=</span><span class="n">Age</span>  <span class="p">;</span><span class="err">年龄</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Ageunit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">年龄单位</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Reqno</span><span class="o">=</span><span class="n">labno</span>  <span class="p">;</span><span class="err">申请号</span> <span class="o">=</span> <span class="err">检验号</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reqda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Reqda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">ReceiveTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span><span class="err">送检日期</span> <span class="o">=</span> <span class="err">接收时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reportda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">报告日期</span>  <span class="o">=</span> <span class="err">初审</span><span class="p">(</span><span class="err">保存结果</span><span class="p">)</span><span class="err">时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Printflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">打印标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Resultflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">结果标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Errflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">错误标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span> <span class="o">=</span> <span class="n">Diagnose</span>   <span class="p">;</span><span class="err">诊断</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Description</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">备注</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reserve</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">保留字段</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Patnamn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">姓名拼音码</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Getda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">CollectTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">s</span> <span class="n">Getda</span><span class="o">=</span><span class="n">Reqda</span> <span class="p">;</span><span class="err">接收时间</span><span class="o">/</span><span class="err">采样日期</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Wardno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">病区</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">EpisodeNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">Sampleda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Instrument_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampleno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampletype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Feetype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdepno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdocno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Userno_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patna_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sex_</span><span class="s2">&#34;,&#34;</span><span class="n">_Pattype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Bedno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patage_</span><span class="s2">&#34;,&#34;</span><span class="n">_Ageunit_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqda_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Reportda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Printflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Resultflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Errflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Diagnose_</span><span class="s2">&#34;,&#34;</span><span class="n">_Description_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reserve_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patnamn_</span><span class="s2">&#34;,&#34;</span><span class="n">_Getda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Wardno_</span><span class="s2">&#34;,&#34;</span><span class="n">_BarCode_</span><span class="s2">&#34;,&#34;</span><span class="n">_BirthDate_</span><span class="s2">&#34;,&#34;</span><span class="n">_EpisodeNo</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">RetString</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">双向上传医嘱信息</span><span class="p">,</span><span class="n">wwh</span><span class="p">,</span><span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">05</span><span class="p">,</span><span class="err">未测试</span>
</span></span><span class="line"><span class="cl"><span class="n">SendOrder</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">mshStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mshStr</span><span class="p">),</span><span class="n">record</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(mi) 1</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$D(^TMIF(mi)) 1</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">barcode</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="s1">&#39;$L(barcode) {</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码号为空&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>				<span class="o">//</span><span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码扫描错误,机器未识别&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> 
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="s1">&#39;$D(^TEPI(barcode)) {</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="n">uploadList</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tsCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">uploadList</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">tsCode</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">tsCode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(tsCode)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$D(^TMIF(mi,0,tsCode))</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">tsDesc</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">TTAB</span><span class="p">(</span><span class="s2">&#34;TS&#34;</span><span class="p">,</span><span class="n">tsCode</span><span class="p">)),</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,1)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">tsCnt</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">tsCode</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(tsCnt)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">status</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">tsCode</span><span class="p">,</span><span class="n">tsCnt</span><span class="p">)),</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,31)</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;A&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码扫:&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;,医嘱:&#34;</span><span class="n">_tsCode_</span><span class="s2">&#34;||&#34;</span><span class="n">_tsDesc_</span><span class="s2">&#34;,不是登记状态,不再上传&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">			<span class="n">Continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">channel</span><span class="o">=$$</span><span class="n">GetTestSetChannel</span><span class="p">(</span><span class="n">tsCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="s1">&#39;$L(channel) {</span>
</span></span><span class="line"><span class="cl">			<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码扫:&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;,医嘱:&#34;</span><span class="n">_tsCode_</span><span class="s2">&#34;||&#34;</span><span class="n">_tsDesc_</span><span class="s2">&#34;,未找到通道号&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">			<span class="n">Continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">Continue</span><span class="p">:</span><span class="o">$</span><span class="n">D</span><span class="p">(</span><span class="n">uploadList</span><span class="p">(</span><span class="n">tsCode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">uploadList</span><span class="p">(</span><span class="n">tsCode</span><span class="p">)</span><span class="o">=</span><span class="n">channel</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">uploadList</span><span class="o">=$</span><span class="n">I</span><span class="p">(</span><span class="n">uploadList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">+$</span><span class="n">G</span><span class="p">(</span><span class="n">uploadList</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码扫:&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;未找可上传的医嘱&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="mi">1</span><span class="p">,</span><span class="err">仪器发送过来的请求信息</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">MSH</span><span class="o">|^~</span>\<span class="o">&amp;||</span><span class="n">Mindray</span><span class="o">|||</span><span class="mi">20081120174836</span><span class="o">||</span><span class="n">ORM</span><span class="o">^</span><span class="n">O01</span><span class="o">|</span><span class="mi">4</span><span class="o">|</span><span class="n">P</span><span class="o">|</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">1</span><span class="o">||||||</span><span class="n">UNICODE</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">ORC</span><span class="o">|</span><span class="n">RF</span><span class="o">||</span><span class="n">SampleID1</span><span class="o">||</span><span class="ne">IP</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">msh</span><span class="o">=</span><span class="s2">&#34;MSH|^~\&amp;|LIS||||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZDT</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="s2">&#34; :&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;||ORR^O02|1|P|2.3.1||||||UNICODE&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">huifu</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">MSH</span><span class="o">|^~</span>\<span class="o">&amp;|</span><span class="n">LIS</span><span class="o">||||</span><span class="mi">20081120174836</span><span class="o">||</span><span class="n">ORR</span><span class="o">^</span><span class="n">O02</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">P</span><span class="o">|</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">1</span><span class="o">||||||</span><span class="n">UNICODE</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">MSA</span><span class="o">|</span><span class="n">AA</span><span class="o">|</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">PID</span><span class="o">|</span><span class="mi">1</span><span class="o">||</span><span class="n">ChartNo</span><span class="o">^^^^</span><span class="n">MR</span><span class="o">||^</span><span class="n">FName</span><span class="o">||</span><span class="mi">19810506</span><span class="o">|</span><span class="n">NT</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">PV1</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">E</span><span class="o">|</span><span class="err">内科</span><span class="o">^^</span><span class="n">Bn4</span><span class="o">|||||||||||||||||</span><span class="n">NewCharge</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">ORC</span><span class="o">|</span><span class="n">AF</span><span class="o">|</span><span class="n">SampleID1</span><span class="o">|||</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBR</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">SampleID1</span><span class="o">||||</span><span class="mi">20060506</span><span class="o">||||</span><span class="n">tester</span><span class="o">|||</span><span class="n">Diagnose</span> <span class="n">content</span><span class="o">...|</span><span class="mi">20060504</span><span class="o">||||||||</span><span class="mi">20080821</span><span class="o">||</span><span class="n">HM</span><span class="o">||||</span><span class="err">审核者</span><span class="o">||||</span><span class="err">检验者</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">IS</span><span class="o">|</span><span class="mi">08001</span><span class="o">^</span><span class="n">Take</span> <span class="n">Mode</span><span class="o">^</span><span class="mi">99</span><span class="n">MRC</span><span class="o">||</span><span class="n">A</span><span class="o">||||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">2</span><span class="o">|</span><span class="n">IS</span><span class="o">|</span><span class="mi">08002</span><span class="o">^</span><span class="n">Blood</span> <span class="n">Mode</span><span class="o">^</span><span class="mi">99</span><span class="n">MRC</span><span class="o">||</span><span class="n">W</span><span class="o">||||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">3</span><span class="o">|</span><span class="n">IS</span><span class="o">|</span><span class="mi">08003</span><span class="o">^</span><span class="n">Test</span> <span class="n">Mode</span><span class="o">^</span><span class="mi">99</span><span class="n">MRC</span><span class="o">||</span><span class="n">CBC</span><span class="o">||||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">4</span><span class="o">|</span><span class="n">IS</span><span class="o">|</span><span class="mi">01002</span><span class="o">^</span><span class="n">Ref</span> <span class="n">Group</span><span class="o">^</span><span class="mi">99</span><span class="n">MRC</span><span class="o">||</span><span class="n">XXXX</span><span class="o">||||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">5</span><span class="o">|</span><span class="n">NM</span><span class="o">|</span><span class="mi">30525</span><span class="o">-</span><span class="mi">0</span><span class="o">^</span><span class="n">Age</span><span class="o">^</span><span class="n">LN</span><span class="o">||</span><span class="mi">1</span><span class="o">|</span><span class="n">hr</span><span class="o">|||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">6</span><span class="o">|</span><span class="n">ST</span><span class="o">|</span><span class="mi">01001</span><span class="o">^</span><span class="n">Remark</span><span class="o">^</span><span class="mi">99</span><span class="n">MRC</span><span class="o">||</span><span class="n">remark</span> <span class="n">content</span><span class="o">...||||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">未找到检测时</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">MSH</span><span class="o">|^~</span>\<span class="o">&amp;|</span><span class="n">LIS</span><span class="o">||||</span><span class="mi">20081120174836</span><span class="o">||</span><span class="n">ORR</span><span class="o">^</span><span class="n">O02</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">P</span><span class="o">|</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">1</span><span class="o">||||||</span><span class="n">UNICODE</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">MSA</span><span class="o">|</span><span class="n">AR</span><span class="o">|</span><span class="mi">9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GetTestSetChannel</span><span class="p">(</span><span class="n">tsCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">N</span> <span class="p">(</span><span class="n">tsCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tsCode</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">tsCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110221403-iayciez.png"
	width="740"
	height="1840"
	srcset="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110221403-iayciez_hu_f060053a5bfcd25f.png 480w, /p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110221403-iayciez_hu_42661246be2313bc.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="40"
		data-flex-basis="96px"
	
></p>
<h4 id="回传多行-obx">回传多行 OBX
</h4><h5 id="示例接口迈瑞-bc7500">示例接口(迈瑞 BC7500)
</h5><blockquote>
<p>将患者信息和项目信息存入 OBX 回传仪器</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">MIFCL600OI</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">仪器名称</span><span class="p">:</span>	<span class="err">血细胞分析流水线</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">仪器型号</span><span class="p">:</span>	<span class="err">迈瑞</span><span class="n">HL7</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">仪器厂商</span><span class="p">:</span>	<span class="err">迈瑞</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">通信协议</span><span class="p">:</span>	<span class="n">HL7</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">交互方式</span><span class="p">:</span>	<span class="err">双</span> <span class="err">向</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">接</span>    <span class="err">口</span><span class="p">:</span>	<span class="n">TCP</span><span class="o">/</span><span class="ne">IP</span><span class="p">,</span><span class="n">RS232</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">备</span>    <span class="err">注</span><span class="p">:</span>	<span class="err">仪器配置</span><span class="p">:</span><span class="err">选择</span><span class="n">HL7协议</span><span class="p">,</span><span class="err">散点图选择</span><span class="p">:</span><span class="err">位图</span>   
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(mi)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">par11</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">12</span><span class="p">)</span> 		<span class="o">//</span><span class="err">项目分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">par10</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">13</span><span class="p">)</span> 	<span class="o">//</span><span class="err">结果分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AntDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">14</span><span class="p">)</span> 		<span class="o">//</span><span class="err">抗生素分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SenDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span> 		<span class="o">//</span><span class="err">药敏结果分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">par4</span><span class="o">=</span><span class="s2">&#34;|TCP|&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>  	<span class="o">//</span><span class="err">端口号</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">stx</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">etx</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ack</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">enq</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">eot</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">etb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">lf</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">nak</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">21</span><span class="p">),(</span><span class="n">AllRecord</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">kk</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">errFlag</span><span class="p">,</span><span class="n">resultType</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">$</span><span class="n">ZT</span><span class="o">=</span><span class="s2">&#34;ErrHandler&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">EC</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="o">$$</span><span class="n">StartUTF8</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="ne">IP</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Port</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LinkTime</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Device</span><span class="o">=</span><span class="s2">&#34;|TCP|&#34;</span><span class="n">_Port</span>
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">try</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">ZA</span><span class="p">,</span><span class="s2">&#34;ZA&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="err">未启动客户端</span><span class="o">/</span><span class="err">服务端</span><span class="mi">0</span><span class="err">，客户端断开连接标志</span><span class="mi">20484</span><span class="err">，无客户端连接</span><span class="mi">20480</span><span class="err">，有客户端连接</span><span class="mi">28674</span><span class="err">，连接并建立数据传输</span><span class="mi">28672</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="n">lis断开</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span> <span class="o">$</span><span class="n">ZA</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">h</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">				<span class="n">open</span> <span class="n">Device</span><span class="p">:(</span><span class="ne">IP</span><span class="p">:</span><span class="n">Port</span><span class="p">:</span><span class="o">/</span><span class="n">IOTABLE</span><span class="o">=</span><span class="s2">&#34;GB18030&#34;</span><span class="p">):</span><span class="mi">20</span>
</span></span><span class="line"><span class="cl">				<span class="n">use</span> <span class="n">Device</span>
</span></span><span class="line"><span class="cl">				<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;lis断开连接&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;lisReConnect&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">throw</span> <span class="c1">##class(%Exception.General).%New(&#34;ConnectError&#34;,&#34;D&#34;,,&#34;重新连接失败&#34;)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="err">仪器断开，或者无数据</span><span class="mi">1</span><span class="nb">min</span><span class="err">，重启</span><span class="n">tcp</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span> <span class="p">((</span><span class="o">$</span><span class="n">ZA</span><span class="o">=</span><span class="s2">&#34;20484&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">close</span> <span class="n">par4</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;仪器断开连接&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;blockConnect&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">h</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">				<span class="n">open</span> <span class="n">Device</span><span class="p">:(</span><span class="ne">IP</span><span class="p">:</span><span class="n">Port</span><span class="p">:</span><span class="o">/</span><span class="n">IOTABLE</span><span class="o">=</span><span class="s2">&#34;GB18030&#34;</span><span class="p">):</span><span class="mi">20</span>
</span></span><span class="line"><span class="cl">				<span class="n">use</span> <span class="n">Device</span>
</span></span><span class="line"><span class="cl">				<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;重新连接&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;reConnect&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">s</span> <span class="n">LinkTime</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="err">连接无数据传输，</span><span class="n">main每执行6次</span><span class="err">，即</span><span class="mi">1</span><span class="nb">min</span><span class="err">，重启</span><span class="n">tcp</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span> <span class="o">$</span><span class="n">ZA</span><span class="o">=</span><span class="s2">&#34;28674&#34;</span> <span class="n">s</span> <span class="n">LinkTime</span><span class="o">=$</span><span class="n">i</span><span class="p">(</span><span class="n">LinkTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="err">正常传输了，就清空计数</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span> <span class="o">$</span><span class="n">ZA</span><span class="o">=</span><span class="s2">&#34;28672&#34;</span> <span class="n">s</span> <span class="n">LinkTime</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">			<span class="n">d</span> <span class="n">Main</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span><span class="n">catch</span> <span class="n">ex</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 <span class="n">s</span> <span class="n">exception</span><span class="o">=</span><span class="s2">&#34;错误:&#34;</span><span class="n">_ex</span><span class="o">.</span><span class="n">Location_</span><span class="s2">&#34;^&#34;</span><span class="n">_ex</span><span class="o">.</span><span class="n">Data_ex</span><span class="o">.</span><span class="n">Name</span>
</span></span><span class="line"><span class="cl">		 <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">exception</span><span class="p">,</span><span class="s2">&#34;读取或写入异常，重启服务端&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="o">$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">C</span> <span class="n">par4</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Main</span>
</span></span><span class="line"><span class="cl">	<span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$TEST	//如果超时则退出</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=sb   //以sb开头</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">errFlag</span><span class="p">,</span><span class="n">resultType</span><span class="p">,</span><span class="n">msgType</span><span class="p">,</span><span class="n">barcode</span><span class="p">,</span><span class="n">mshStr</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">startTime</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="n">PLIST</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">curTime</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="n">curTime</span><span class="o">&gt;</span><span class="p">(</span><span class="n">startTime</span><span class="o">+</span><span class="mi">300</span><span class="p">)</span>  <span class="o">//</span><span class="mi">5</span><span class="err">分钟内没有处理完则退出循环</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="o">$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$TEST	//如果超时则退出</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)))</span><span class="o">&gt;=</span><span class="mi">32700</span> <span class="p">{</span>  <span class="o">//</span><span class="mi">32767</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">index</span><span class="o">=+$</span><span class="n">O</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=eb,$C(R)&#39;</span><span class="o">=</span><span class="n">cr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">))</span><span class="n">_</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">cr</span> <span class="p">{</span>  	<span class="o">//</span><span class="err">解析一条记录</span>
</span></span><span class="line"><span class="cl">			<span class="n">D</span> <span class="n">Record</span>
</span></span><span class="line"><span class="cl">			<span class="n">K</span> <span class="n">PLIST</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eb</span>   	<span class="o">//</span><span class="err">循环读取</span><span class="p">,</span><span class="err">当为</span><span class="n">eb的时候则退出</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="s2">&#34;result&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">Save</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Record</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">index</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">base64Stream</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">isImage</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">isBinary</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">OldgraphDataDIFF</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">OldgraphDataBaso</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">Bracket</span><span class="p">,</span><span class="n">TestTube</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">index</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(index)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">record</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span><span class="n">cr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Continue</span><span class="p">:</span><span class="s1">&#39;$L(record)</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">segmentType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;MSH&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">信息头信息</span>
</span></span><span class="line"><span class="cl">				<span class="n">S</span> <span class="n">mshStr</span><span class="o">=</span><span class="n">record</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="err">消息类型</span>
</span></span><span class="line"><span class="cl">    			<span class="n">S</span> <span class="n">msgType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="o">//</span><span class="n">ORU</span><span class="p">,</span><span class="n">ACK</span><span class="p">,</span><span class="n">QRY</span><span class="p">,</span><span class="n">QCK</span><span class="p">,</span><span class="n">DSR</span>
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">msgType</span><span class="o">=</span><span class="s2">&#34;ORU&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">D</span> <span class="n">SendACK</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    		<span class="n">I</span> <span class="n">msgType</span><span class="o">=</span><span class="s2">&#34;ORM&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    		<span class="n">S</span> <span class="n">resultType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;PID&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">患者信息</span>
</span></span><span class="line"><span class="cl">				
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;PVI&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">就诊信息</span>
</span></span><span class="line"><span class="cl">				
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;OBR&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">医嘱信息</span>
</span></span><span class="line"><span class="cl">				<span class="n">S</span> <span class="n">epis</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    			<span class="n">S</span><span class="p">:</span><span class="s1">&#39;$l(epis) epis=$P(record,&#34;|&#34;,4)</span>
</span></span><span class="line"><span class="cl">    			<span class="n">i</span> <span class="n">epis</span><span class="p">[</span><span class="s2">&#34;Inv&#34;</span> <span class="n">d</span>		<span class="o">//</span><span class="n">Inv</span><span class="o">.</span><span class="mi">082526</span><span class="n">_6</span><span class="o">-</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl">    			<span class="o">.</span><span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;Inv.&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">),</span><span class="s2">&#34;_&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>		<span class="o">//</span><span class="n">YHR</span> <span class="mi">20230819</span> <span class="err">仪器未识别到条码改为架子号获取信息</span>
</span></span><span class="line"><span class="cl">    			<span class="o">/*------</span><span class="err">自动核收</span><span class="o">-------*/</span>		<span class="o">//</span><span class="n">YHR</span> <span class="mi">20230910</span> <span class="err">迈瑞</span><span class="n">BC7500自动核收</span>
</span></span><span class="line"><span class="cl">    			<span class="p">;</span><span class="n">try</span><span class="p">{</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##class(MI.Special.AutomaticReceipt).ZDHS(mi,epis)}catch{}</span>
</span></span><span class="line"><span class="cl">	     	
</span></span><span class="line"><span class="cl">	     		<span class="n">S</span> <span class="n">code</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	     		<span class="n">I</span> <span class="n">code</span><span class="o">=</span><span class="s2">&#34;00003&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="n">LJ</span> <span class="n">QCR</span>
</span></span><span class="line"><span class="cl">		     	
</span></span><span class="line"><span class="cl">		     	<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;OBX&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">S</span> <span class="n">dataTye</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>  <span class="o">//</span><span class="n">NM</span> <span class="p">(</span><span class="n">numeric</span><span class="p">)</span> <span class="err">表示数字值，用于定量项目</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     										<span class="o">//</span><span class="n">ST</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="err">表示字符串值，用于定性项目</span>
</span></span><span class="line"><span class="cl">    			<span class="n">S</span> <span class="n">channel</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    			<span class="n">s</span> <span class="n">InformationID</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    			<span class="n">S</span> <span class="n">channel</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    			<span class="o">//</span><span class="n">s</span><span class="p">:</span><span class="s1">&#39;$l(channel) channel=$P(record,&#34;|&#34;,5)</span>
</span></span><span class="line"><span class="cl">    			<span class="n">S</span> <span class="n">value</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    			<span class="p">;</span><span class="n">i</span> <span class="n">value</span><span class="p">[</span><span class="s2">&#34;&lt;&#34;</span> <span class="n">s</span> <span class="n">value</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;&lt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    			<span class="p">;</span><span class="n">i</span> <span class="n">value</span><span class="p">[</span><span class="s2">&#34;&gt;&#34;</span> <span class="n">s</span> <span class="n">value</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;&gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    			<span class="n">s</span> <span class="n">value</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;FR-CRP&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    				<span class="n">i</span> <span class="n">value</span><span class="o">&gt;</span><span class="mi">10</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">channel1</span><span class="o">=</span><span class="s2">&#34;FCRP&#34;</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">channel2</span><span class="o">=</span><span class="s2">&#34;Fhs-CRP&#34;</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">value1</span><span class="o">=</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">value2</span><span class="o">=</span><span class="s2">&#34;&gt;10&#34;</span>
</span></span><span class="line"><span class="cl">    				<span class="n">i</span> <span class="n">value</span><span class="o">&lt;</span><span class="mi">10</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">channel1</span><span class="o">=</span><span class="s2">&#34;FCRP&#34;</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">channel2</span><span class="o">=</span><span class="s2">&#34;Fhs-CRP&#34;</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">value1</span><span class="o">=</span><span class="s2">&#34;&lt;10&#34;</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">value2</span><span class="o">=</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">    				<span class="n">i</span> <span class="n">value</span><span class="o">=</span><span class="mi">10</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">channel1</span><span class="o">=</span><span class="s2">&#34;FCRP&#34;</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">channel2</span><span class="o">=</span><span class="s2">&#34;Fhs-CRP&#34;</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">value1</span><span class="o">=</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">value2</span><span class="o">=</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">    			
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span> <span class="n">result</span><span class="o">=</span><span class="n">result_channel1_par10_value1_par11</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span> <span class="n">result</span><span class="o">=</span><span class="n">result_channel2_par10_value2_par11</span>
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;SI&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="n">value</span><span class="o">=</span><span class="err">浊度</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">^</span><span class="err">溶血</span><span class="p">(</span><span class="n">H</span><span class="p">)</span><span class="o">^</span><span class="err">黄疸</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="n">result</span><span class="o">=</span><span class="n">result_channel_</span><span class="s2">&#34;H&#34;</span><span class="n">_par10_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_par11</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="n">result</span><span class="o">=</span><span class="n">result_channel_</span><span class="s2">&#34;I&#34;</span><span class="n">_par10_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="n">_par11</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span> <span class="n">value</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;ST&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    				<span class="n">S</span> <span class="n">value</span><span class="o">=$</span><span class="n">S</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&#34;ò?D?&#34;</span><span class="p">:</span><span class="s2">&#34;阴性&#34;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s2">&#34;??D?&#34;</span><span class="p">:</span><span class="s2">&#34;阳性&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    				<span class="n">i</span> <span class="n">InformationID</span><span class="o">=</span><span class="s2">&#34;01012&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">Bracket</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="o">^</span><span class="n">TMPBC7500</span><span class="p">(</span><span class="s2">&#34;Bracket&#34;</span><span class="p">)</span><span class="o">=</span><span class="n">Bracket</span>
</span></span><span class="line"><span class="cl">    				<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">TMPBC7500</span><span class="p">(</span><span class="s2">&#34;Bracket&#34;</span><span class="p">))),</span><span class="n">InformationID</span><span class="o">=</span><span class="s2">&#34;01013&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">TestTube</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">s</span> <span class="n">RackNo</span><span class="o">=</span><span class="s2">&#34;上机:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">TMPBC7500</span><span class="p">(</span><span class="s2">&#34;Bracket&#34;</span><span class="p">))</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_TestTube</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">k</span> <span class="o">^</span><span class="n">TMPBC7500</span><span class="p">(</span><span class="s2">&#34;Bracket&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    				<span class="o">.</span><span class="n">try</span><span class="p">{</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##class(MI.Special.SaveInformation).SaveRackNo(mi,epis, RackNo)}catch{}		//YHR 20230914 保存架子号</span>
</span></span><span class="line"><span class="cl">    			
</span></span><span class="line"><span class="cl">    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span><span class="n">dataTye</span><span class="s1">&#39;=&#34;ED&#34;,dataTye&#39;</span><span class="o">=</span><span class="s2">&#34;IS&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span> <span class="n">result</span><span class="o">=</span><span class="n">result_channel_par10_value_par11</span>
</span></span><span class="line"><span class="cl">    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;IS&#34;</span> <span class="p">{</span>	  
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;05001&#34;</span><span class="p">,</span><span class="n">resultType</span><span class="o">=</span><span class="s2">&#34;Q&#34;</span> <span class="p">{</span>		<span class="o">//</span><span class="err">质控浓度</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">S</span> <span class="n">epis</span><span class="o">=</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">		    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		    	
</span></span><span class="line"><span class="cl">		    		<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">LISPolice</span><span class="p">(</span><span class="s2">&#34;BC7500&#34;</span><span class="p">,</span><span class="n">InformationID</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    		<span class="o">.</span><span class="n">s</span> <span class="n">WarningMessage</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">LISPolice</span><span class="p">(</span><span class="s2">&#34;BC7500&#34;</span><span class="p">,</span><span class="n">InformationID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		    		<span class="o">.</span><span class="n">try</span><span class="p">{</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.Special.SaveInformation).SaveAlarmInformation(mi,epis,WarningMessage)}catch{}		//YHR 20230914 保存报警信息</span>
</span></span><span class="line"><span class="cl">		    	
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    			<span class="n">S</span> <span class="n">graphTypeDesc</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34;U&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">    			<span class="n">I</span> <span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;ED&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">图形数据</span>
</span></span><span class="line"><span class="cl">    				<span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Image&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">isImage</span><span class="o">=</span><span class="mi">1</span>  	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Octer-stream&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">S</span> <span class="n">isBinary</span><span class="o">=</span><span class="mi">1</span>	<span class="o">//</span><span class="err">二进制数据</span><span class="p">(</span><span class="err">需要绘图</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="n">channel</span>
</span></span><span class="line"><span class="cl">    				<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15050&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;RBC&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15056&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;RBC&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15100&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;PLT&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15116&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;PLT&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15200&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;WBC-DIFFBMP&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15201&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="p">(</span><span class="n">isImage</span><span class="p">,</span><span class="n">isBinary</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>	<span class="o">//</span><span class="err">暂时不处理二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;WBC-DIFF&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15202&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="p">(</span><span class="n">isImage</span><span class="p">,</span><span class="n">isBinary</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>	<span class="o">//</span><span class="err">暂时不处理二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;WBC-DIFF&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15250&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;BASOBMP&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15251&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="p">(</span><span class="n">isImage</span><span class="p">,</span><span class="n">isBinary</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>	<span class="o">//</span><span class="err">暂时不处理二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;BASO&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15300&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;RET&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15306&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="p">(</span><span class="n">isImage</span><span class="p">,</span><span class="n">isBinary</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>	<span class="o">//</span><span class="err">暂时不处理二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;RET&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15301&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;PLT-0&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15302&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;RET-EXT&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15350&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">位图数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;NRBC&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&#34;15354&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="p">(</span><span class="n">isImage</span><span class="p">,</span><span class="n">isBinary</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>	<span class="o">//</span><span class="err">暂时不处理二进制数据</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">S</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;NRBC&#34;</span>
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span> <span class="n">graphData</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    		
</span></span><span class="line"><span class="cl">	    			<span class="n">S</span> <span class="n">graphDataType</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    			<span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">graphDataType</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Base64&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">graphType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">/*</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;RBC Histogram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">charStream</span><span class="o">=</span><span class="c1">##class(%GlobalCharacterStream).%New()</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">graphData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.TEST.TEST).SaveBase64ToMachine(mi,epis,&#34;RBC&#34;,charStream,epis_&#34;RBC.bmp&#34;,&#34;BC7500&#34;)</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">ret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：RBC Histogram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;PLT Histogram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">charStream</span><span class="o">=</span><span class="c1">##class(%GlobalCharacterStream).%New()</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">graphData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.TEST.TEST).SaveBase64ToMachine(mi,epis,&#34;PLT&#34;,charStream,epis_&#34;PLT.bmp&#34;,&#34;BC7500&#34;)</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">ret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：PLT Histogram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;WBC DIFF Scattergram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">charStream</span><span class="o">=</span><span class="c1">##class(%GlobalCharacterStream).%New()</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">graphData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.TEST.TEST).SaveBase64ToMachine(mi,epis,&#34;DIFF&#34;,charStream,epis_&#34;DIFF.bmp&#34;,&#34;BC7500&#34;)</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">ret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：WBC DIFF Scattergram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;WNB Scattergram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">charStream</span><span class="o">=</span><span class="c1">##class(%GlobalCharacterStream).%New()</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">graphData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.TEST.TEST).SaveBase64ToMachine(mi,epis,&#34;Baso&#34;,charStream,epis_&#34;Baso.bmp&#34;,&#34;BC7500&#34;)</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">ret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：WNB Scattergram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="o">*/</span>
</span></span><span class="line"><span class="cl">		    		
</span></span><span class="line"><span class="cl">		    			<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;RBC Histogram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;RBC&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;Histogram#RBC#RBC######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RBC#RBC######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：RBC Histogram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;PLT Histogram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;PLT&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;Histogram#PLT#PLT######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#PLT#RBC######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：PLT Histogram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;WBC DIFF&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="n">OldgraphDataDIFF</span><span class="o">=</span><span class="n">graphData</span>
</span></span><span class="line"><span class="cl">						<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;WBC-DIFF&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#DIFF#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#DIFF#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：WBC DIFF&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    			<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;WNB Scattergram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">OldgraphDataBaso</span><span class="o">=</span><span class="n">graphData</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;BASO&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#WNB#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#Baso#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：WNB Scattergram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;RET Scattergram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">OldgraphDataBaso</span><span class="o">=</span><span class="n">graphData</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;BASO&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RET#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RET#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：RET Scattergram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;PLT-O Scattergram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">OldgraphDataBaso</span><span class="o">=</span><span class="n">graphData</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;BASO&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RET#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#PLTO#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：PLT-O Scattergram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;RET-EXT Scattergram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">OldgraphDataBaso</span><span class="o">=</span><span class="n">graphData</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;BASO&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RET#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RETEXT#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：RET-EXT Scattergram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;RBCVHF Scattergram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">OldgraphDataBaso</span><span class="o">=</span><span class="n">graphData</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;BASO&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RET#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RBCVHF#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：RBCVHF Scattergram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="n">i</span> <span class="n">graphType</span><span class="p">[</span><span class="s2">&#34;RBCSCT Scattergram&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.</span><span class="n">s</span> <span class="n">OldgraphDataBaso</span><span class="o">=</span><span class="n">graphData</span>
</span></span><span class="line"><span class="cl">		    			<span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;BASO&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RET#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    				<span class="o">.</span><span class="n">s</span> <span class="n">tretObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    					<span class="o">.</span><span class="n">s</span> <span class="n">tret</span><span class="o">=</span><span class="n">tretObj</span><span class="o">.</span><span class="n">DrawImage</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">graphData</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFLISMonitorTest&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#RBCSCT#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">						<span class="o">.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tret_</span><span class="s2">&#34;!!&#34;</span><span class="n">_epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_mi</span><span class="p">,</span><span class="s2">&#34;绘图：RBCSCT Scattergram&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    			
</span></span><span class="line"><span class="cl">	    		
</span></span><span class="line"><span class="cl">	    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="n">I</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&#34;ORC&#34;</span> <span class="p">{</span>	<span class="o">//</span><span class="err">就诊信息</span>
</span></span><span class="line"><span class="cl">				<span class="n">S</span> <span class="n">barcode</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">				<span class="o">/*------</span><span class="err">自动核收</span><span class="o">-------*/</span>		<span class="o">//</span><span class="n">YHR</span> <span class="mi">20230910</span> <span class="err">迈瑞</span><span class="n">BC7500自动核收</span>
</span></span><span class="line"><span class="cl">    			<span class="p">;</span><span class="n">try</span><span class="p">{</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##class(MI.Special.AutomaticReceipt).ZDHS(mi,barcode)}catch{}</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="n">barcode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="o">//</span><span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span> <span class="p">{</span>  <span class="o">//</span><span class="err">双向</span>
</span></span><span class="line"><span class="cl">				<span class="o">//</span><span class="p">}</span> <span class="n">Invalid</span> <span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">				<span class="n">d</span> <span class="n">SendORR</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">barcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="o">//</span><span class="n">I</span> <span class="n">dataTye</span><span class="o">=</span><span class="s2">&#34;ED&#34;</span><span class="p">,</span><span class="n">index</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">base64Stream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="n">D</span> <span class="n">base64Stream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="n">i</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;WBC-DIFFBMP&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    <span class="o">//.</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;WBC-DIFF&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">OldgraphDataDIFF</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFBC6800BI&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#DIFF#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="o">//</span><span class="n">i</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;BASOBMP&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		    <span class="o">//.</span><span class="n">s</span> <span class="o">^</span><span class="n">LISDrawImageTask</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;BASO&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">OldgraphDataBaso</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MI.MIFBC6800BI&#34;</span><span class="p">,</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span><span class="s2">&#34;DiffPlot#Baso#######10#10#320#138&#34;</span><span class="p">,</span><span class="s2">&#34;LIS.Mach.ImageDeal.Imagebc6800,LIS.Mach.ImageDeal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			<span class="o">//</span><span class="n">s</span> <span class="n">miCode</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="o">//</span><span class="n">i</span> <span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;WBC-DIFF&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">			<span class="o">//.</span><span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">miCode_</span><span class="s2">&#34;:&#34;</span><span class="n">_epis_</span><span class="s2">&#34;:&#34;</span><span class="n">_graphType</span><span class="p">,</span><span class="s2">&#34;SaveImage&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="o">//.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.Common.MIFBase).SaveBase64ToMachine(mi,epis,graphType,base64Stream,epis_&#34;-&#34;_graphType,miCode)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="o">//</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">Save</span>  
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;^&#34;</span><span class="n">_result</span><span class="p">,</span><span class="s2">&#34;Test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  	<span class="n">I</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  	<span class="n">S</span> <span class="n">QC</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  		<span class="n">D</span> <span class="n">Save</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  	<span class="n">S</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">resultType</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">Q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">SendACK</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="n">errCode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">errDesc</span><span class="o">=</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">)</span> <span class="o">//</span><span class="n">send</span> <span class="s1">&#39;ack&#39;</span> <span class="n">to</span> <span class="n">instrument</span> 
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">ackType</span><span class="p">,</span><span class="n">errCode</span><span class="p">,</span><span class="n">errDesc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">mshStr</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mshStr</span><span class="p">),</span><span class="n">ackType</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ackType</span><span class="p">),</span><span class="n">errCode</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">errCode</span><span class="p">),</span><span class="n">errDesc</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">errDesc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:(</span><span class="s1">&#39;$l(mi))||(&#39;</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">Q</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">21</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">msgRoutine</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">seq</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|LIS|||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;ACK^&#34;</span><span class="n">_msgRoutine</span>
</span></span><span class="line"><span class="cl">    <span class="n">W</span> <span class="n">sb</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;MSA|&#34;</span><span class="n">_ackType_</span><span class="s2">&#34;|&#34;</span><span class="n">_seq_</span><span class="s2">&#34;|&#34;</span><span class="n">_errDesc_</span><span class="s2">&#34;|||&#34;</span><span class="n">_errCode_</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">S</span><span class="p">(</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AE&#34;</span><span class="p">:</span><span class="s2">&#34;Error&#34;</span><span class="p">,</span><span class="n">ackType</span><span class="o">=</span><span class="s2">&#34;AR&#34;</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;NULL&#34;</span><span class="p">),</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">ErrHandler</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZERROR</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="s2">&#34;--&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;.错误代码:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ECODE</span><span class="p">,</span><span class="s2">&#34;Runtime Error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">h</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">保存直方图</span>
</span></span><span class="line"><span class="cl"><span class="n">SaveHistogram</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">graphType</span><span class="p">,</span><span class="n">graphOrder</span><span class="p">,</span><span class="n">base64Stream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">graphType</span><span class="p">,</span><span class="n">graphOrder</span><span class="p">,</span><span class="n">base64Stream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">epis</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="n">graphType</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">graphType</span><span class="p">),</span><span class="n">graphOrder</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">graphOrder</span><span class="p">),</span><span class="n">base64Stream</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">base64Stream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(mi) 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(epis) 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(base64Stream) 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(graphType) 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span><span class="p">:</span><span class="s1">&#39;$L(graphOrder) graphOrder=0</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">glBinaryStream</span><span class="o">=</span><span class="c1">##Class(%GlobalBinaryStream).%New()</span>
</span></span><span class="line"><span class="cl">    <span class="n">While</span> <span class="s1">&#39;base64Stream.AtEnd {</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">base64</span><span class="o">=</span><span class="n">base64Stream</span><span class="o">.</span><span class="n">Read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">binary</span><span class="o">=$</span><span class="n">system</span><span class="o">.</span><span class="n">Encryption</span><span class="o">.</span><span class="n">Base64Decode</span><span class="p">(</span><span class="n">base64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="n">D</span> <span class="n">glBinaryStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">charStream</span><span class="o">=</span><span class="c1">##Class(%GlobalCharacterStream).%New()</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">maxDot</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">While</span> <span class="s1">&#39;glBinaryStream.AtEnd {</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">char</span><span class="o">=</span><span class="n">glBinaryStream</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">ascValue</span><span class="o">=$</span><span class="n">ASCII</span><span class="p">(</span><span class="n">char</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	    <span class="n">S</span> <span class="n">maxDot</span><span class="o">=</span><span class="n">maxDot</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	    <span class="n">D</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">ascValue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="n">glBinaryStream</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">title</span><span class="o">=</span><span class="n">graphType</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">foreColor</span><span class="o">=</span><span class="mi">12</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="n">graphType</span><span class="o">=</span><span class="s2">&#34;PLT&#34;</span> <span class="n">foreColor</span><span class="o">=</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">top</span><span class="o">=</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">left</span><span class="o">=</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">width</span><span class="o">=</span><span class="mi">300</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">height</span><span class="o">=</span><span class="mi">150</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">maxValue</span><span class="p">,</span><span class="n">memo</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">error</span><span class="o">=</span><span class="c1">##Class(MI.Instrument).SaveHistogram(charStream,mi,epis,graphType,graphOrder,label,title,maxDot,maxValue,memo,foreColor,top,left,width,height)</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">TR</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="s2">&#34;--&#34;</span><span class="p">),</span><span class="s2">&#34;Graph Error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="n">charStream</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">SendORR</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span> <span class="n">AckType</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span><span class="p">,</span><span class="n">ErrCode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ErrDesc</span><span class="o">=</span><span class="s2">&#34;Message accepted&#34;</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="n">AckType</span><span class="p">,</span><span class="n">ErrCode</span><span class="p">,</span><span class="n">ErrDesc</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">record</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">record</span><span class="p">),</span><span class="n">AckType</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">AckType</span><span class="p">),</span><span class="n">ErrCode</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ErrCode</span><span class="p">),</span><span class="n">ErrDesc</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ErrDesc</span><span class="p">),</span><span class="n">mshStr</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mshStr</span><span class="p">),</span><span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">eb</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">Q</span><span class="p">:(</span><span class="s1">&#39;$l(mi))||(&#39;</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">	 <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	 <span class="n">S</span> <span class="n">seq</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">S</span> <span class="n">mshStr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|LIS||||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mshStr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   	 <span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">mshStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;ORR^O02&#34;</span>
</span></span><span class="line"><span class="cl">   	 <span class="n">s</span> <span class="n">isRecieve</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">   	 <span class="n">s</span> <span class="n">wgDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">   	 <span class="n">s</span> <span class="n">wgDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="o">//&amp;</span><span class="n">sql</span><span class="p">(</span><span class="n">SELECT</span> <span class="n">EpisodeNo</span> <span class="n">into</span> <span class="p">:</span><span class="n">isRecieve</span> <span class="n">FROM</span> <span class="n">dbo</span><span class="o">.</span><span class="n">RP_VisitNumberReport</span> <span class="n">where</span> <span class="n">AssayNo</span><span class="o">=</span><span class="p">:</span><span class="n">epis</span> <span class="ow">and</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="p">:</span><span class="n">wgDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">isRecieve</span><span class="o">=</span><span class="n">epis</span> <span class="o">//</span><span class="c1">##class(HIS.DHCReportPrint).GetReportAssayNoMTHD(mi,epis)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&#34;AA&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">MSACode</span><span class="o">=</span><span class="n">seq</span>
</span></span><span class="line"><span class="cl">	 <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">isRecieve</span><span class="p">,</span><span class="s2">&#34;isRecieve is &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">i</span> <span class="p">(</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">isRecieve</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">{</span>
</span></span><span class="line"><span class="cl">		 <span class="n">s</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&#34;AR&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="p">}</span>
</span></span><span class="line"><span class="cl">	 <span class="n">i</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		 <span class="n">s</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&#34;AR&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="p">}</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">MSA</span><span class="o">=</span><span class="s2">&#34;MSA|&#34;</span><span class="n">_flag_</span><span class="s2">&#34;|&#34;</span><span class="n">_MSACode</span>
</span></span><span class="line"><span class="cl">	 <span class="n">i</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&#34;AR&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 <span class="n">S</span> <span class="n">TMPCORDE</span><span class="o">=</span><span class="n">sb_mshStr_cr_MSA_cr_eb_cr</span>
</span></span><span class="line"><span class="cl">		 <span class="n">W</span> <span class="n">sb</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">MSA</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">		 <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">TMPCORDE</span><span class="p">,</span><span class="s2">&#34;H-&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PatInfomation</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PatInfomation</span><span class="o">=$$</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;PatInfomation is&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="p">(</span><span class="n">RegNo</span><span class="p">,</span><span class="n">Name</span><span class="p">,</span><span class="n">Birth</span><span class="p">,</span><span class="n">Species</span><span class="p">,</span><span class="n">PatType</span><span class="p">,</span><span class="n">LOC</span><span class="p">,</span><span class="n">BedNo</span><span class="p">,</span><span class="n">Fee</span><span class="p">,</span><span class="n">Srcdocno</span><span class="p">,</span><span class="n">PatAge</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="k">if</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">RegNo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">Name</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">Birth</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">29</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;男&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;2&#34;</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;女&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PatType</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">LOC</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">Fee</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">Srcdocno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PatAge</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfomation</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">}</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PID</span><span class="o">=</span><span class="s2">&#34;PID|1||&#34;</span><span class="n">_RegNo_</span><span class="s2">&#34;^^^^MR||&#34;</span><span class="n">_Name_</span><span class="s2">&#34;^&#34;</span><span class="n">_Name_</span><span class="s2">&#34;||&#34;</span><span class="n">_Birth_</span><span class="s2">&#34;|&#34;</span><span class="n">_Species</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">PV1</span><span class="o">=</span><span class="s2">&#34;PV1|1|&#34;</span><span class="n">_PatType_</span><span class="s2">&#34;|&#34;</span><span class="n">_LOC_</span><span class="s2">&#34;^^&#34;</span><span class="n">_BedNo_</span><span class="s2">&#34;|||||||||||||||||&#34;</span><span class="n">_Fee</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">ORC</span><span class="o">=</span><span class="s2">&#34;ORC|AF||&#34;</span><span class="n">_epis</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">curTime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">randomNumber</span><span class="o">=</span><span class="mi">1000</span><span class="o">+$</span><span class="n">r</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">OBR</span><span class="o">=</span><span class="s2">&#34;OBR|1|&#34;</span><span class="n">_epis_</span><span class="s2">&#34;||00001^Automated Count^99MRC||&#34;</span><span class="n">_curTime_randomNumber_</span><span class="s2">&#34;||||&#34;</span><span class="n">_Srcdocno_</span><span class="s2">&#34;||||||||||||||HM||||||||Bill&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">TestCodeDate</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">TestCodeDate</span><span class="o">=$$</span><span class="n">SearchTestItem</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="n">s</span> <span class="n">OBX</span><span class="o">=</span><span class="s2">&#34;OBX|1|IS|08003^Test Mode^99MRC||&#34;</span><span class="n">_TestCodeDate_</span><span class="s2">&#34;||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|2|IS|01002^Ref Group^99MRC||Child||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|3|NM|30525-0^Age^LN||&#34;</span><span class="n">_PatAge_</span><span class="s2">&#34;|yr|||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|4|ST|01001^Remark^99MRC||&#34;</span><span class="n">_PatType_</span><span class="s2">&#34;||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|5|ST|08005^SerialNumber^99MRC||&#34;</span><span class="n">_isRecieve_</span><span class="s2">&#34;||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|6|IS|01007^Sample Type^99MRC||Venous blood||||||&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|7|IS|01008^Patient Area^99MRC||A - 501||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|8|ST|01009^Custom patient info 1^99MRC||Nothing||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|9|ST|01010^Custom patient info 2^99MRC||Nothing||||||F&#34;</span><span class="n">_cr_</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;OBX|10|ST|01011^Custom patient info 3^99MRC||Nothing||||||F&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">TMPORDER</span><span class="o">=</span><span class="n">sb_mshStr_cr_MSA_cr_PID_cr_PV1_cr_ORC_cr_OBR_cr_OBX_cr_eb_cr</span>
</span></span><span class="line"><span class="cl">		<span class="n">w</span> <span class="n">sb</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">MSA</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">PID</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">PV1</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">ORC</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">OBR</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">OBX</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">eb</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">TMPORDER</span><span class="p">,</span><span class="s2">&#34;H-&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="n">SearchTestItem</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">tc</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">	   <span class="n">f</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">s</span> <span class="n">tc</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">tc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	 	 <span class="n">q</span><span class="p">:</span><span class="n">tc</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	 	 <span class="n">i</span> <span class="s1">&#39;$l(tcx){</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tc</span> 
</span></span><span class="line"><span class="cl">	 	 <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    	<span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_</span><span class="s2">&#34;+&#34;</span><span class="n">_tc</span>
</span></span><span class="line"><span class="cl">	 	 <span class="p">}</span>
</span></span><span class="line"><span class="cl">  	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="n">tcx</span>
</span></span><span class="line"><span class="cl"><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">labno</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">VisitNumberDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="n">_labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">标本信息</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RPVisitNumberData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LocationDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">),</span><span class="n">Location</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Location</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">DoctorDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">Doctor</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Doctor</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDoctorD</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveUserDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">68</span><span class="p">),</span><span class="n">ReceiveUser</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">ReceiveUser</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">SYSUserD</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RegNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SurName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">GivenName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">SurName</span><span class="o">=</span><span class="n">GivenName</span> <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName_GivenName</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SpeciesDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span><span class="n">Species</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AdmTypeDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">AdmType</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AdmType</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAdmissionTypeD</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BirthDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AgeUnitDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span><span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAgeUnitD</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CollectDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">51</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CollectTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Sampleda</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Instrument</span> <span class="o">=</span> <span class="s2">&#34;XN&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">s</span> <span class="n">Instrument</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sampleno</span><span class="o">=</span><span class="n">labno</span>   <span class="o">//</span><span class="err">检测号</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sampletype</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">Feetype</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">;</span><span class="err">费别</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Srcdepno</span><span class="o">=</span><span class="n">Location</span>  <span class="p">;</span><span class="err">送检科室</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Srcdocno</span><span class="o">=</span><span class="n">Doctor</span>   <span class="p">;</span><span class="err">送检医生</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Userno</span><span class="o">=</span><span class="n">ReceiveUser</span> <span class="p">;</span><span class="err">检验医生</span><span class="p">(</span><span class="err">录入者</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Patno</span><span class="o">=</span><span class="n">RegNo</span> <span class="p">;</span><span class="err">登记号</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BarCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Patna</span><span class="o">=</span><span class="n">PatName</span>   <span class="p">;</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="mi">1</span>  <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;男&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>     <span class="p">;</span><span class="mi">1</span><span class="p">:</span><span class="err">男</span> <span class="err">，</span><span class="mi">2</span> <span class="err">女</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">Species</span> <span class="o">=</span><span class="s2">&#34;女&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Pattype</span><span class="o">=</span><span class="n">AdmType</span>   <span class="p">;</span><span class="err">病人类型</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Bedno</span> <span class="o">=</span> <span class="n">BedNo</span>    <span class="p">;</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Patage</span><span class="o">=</span><span class="n">Age</span>  <span class="p">;</span><span class="err">年龄</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Ageunit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">年龄单位</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Reqno</span><span class="o">=</span><span class="n">labno</span>  <span class="p">;</span><span class="err">申请号</span> <span class="o">=</span> <span class="err">检验号</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reqda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Reqda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">ReceiveTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span><span class="err">送检日期</span> <span class="o">=</span> <span class="err">接收时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reportda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">报告日期</span>  <span class="o">=</span> <span class="err">初审</span><span class="p">(</span><span class="err">保存结果</span><span class="p">)</span><span class="err">时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Printflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">打印标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Resultflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">结果标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Errflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">错误标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span> <span class="o">=</span> <span class="n">Diagnose</span>   <span class="p">;</span><span class="err">诊断</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Description</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">备注</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reserve</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">保留字段</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Patnamn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">姓名拼音码</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Getda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">CollectTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">s</span> <span class="n">Getda</span><span class="o">=</span><span class="n">Reqda</span> <span class="p">;</span><span class="err">接收时间</span><span class="o">/</span><span class="err">采样日期</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Wardno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">病区</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">EpisodeNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">Sampleda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Instrument_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampleno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampletype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Feetype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdepno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdocno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Userno_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patna_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sex_</span><span class="s2">&#34;,&#34;</span><span class="n">_Pattype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Bedno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patage_</span><span class="s2">&#34;,&#34;</span><span class="n">_Ageunit_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqda_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Reportda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Printflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Resultflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Errflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Diagnose_</span><span class="s2">&#34;,&#34;</span><span class="n">_Description_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reserve_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patnamn_</span><span class="s2">&#34;,&#34;</span><span class="n">_Getda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Wardno_</span><span class="s2">&#34;,&#34;</span><span class="n">_BarCode_</span><span class="s2">&#34;,&#34;</span><span class="n">_BirthDate_</span><span class="s2">&#34;,&#34;</span><span class="n">_EpisodeNo</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">RetString</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">双向上传医嘱信息</span><span class="p">,</span><span class="n">wwh</span><span class="p">,</span><span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">05</span><span class="p">,</span><span class="err">未测试</span>
</span></span><span class="line"><span class="cl"><span class="n">SendOrder</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mshStr</span><span class="p">,</span><span class="n">record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">mshStr</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mshStr</span><span class="p">),</span><span class="n">record</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(mi) 1</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$D(^TMIF(mi)) 1</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">barcode</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="s1">&#39;$L(barcode) {</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码号为空&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">ZCVT</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">ZCVT</span><span class="p">(</span><span class="s2">&#34;Invalid&#34;</span><span class="p">,</span><span class="s2">&#34;U&#34;</span><span class="p">)</span> <span class="p">{</span>				<span class="o">//</span><span class="err">条码扫描错误</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码扫描错误,机器未识别&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> 
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="s1">&#39;$D(^TEPI(barcode)) {</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;在检验系统未找到条码:&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;对应的标本信息,确定条码正确或标本已经接收?&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="n">uploadList</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tsCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">uploadList</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">tsCode</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">tsCode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(tsCode)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$D(^TMIF(mi,0,tsCode))</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">tsDesc</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">TTAB</span><span class="p">(</span><span class="s2">&#34;TS&#34;</span><span class="p">,</span><span class="n">tsCode</span><span class="p">)),</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,1)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">tsCnt</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">tsCode</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(tsCnt)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">status</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">tsCode</span><span class="p">,</span><span class="n">tsCnt</span><span class="p">)),</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,31)</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;A&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码扫:&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;,医嘱:&#34;</span><span class="n">_tsCode_</span><span class="s2">&#34;||&#34;</span><span class="n">_tsDesc_</span><span class="s2">&#34;,不是登记状态,不再上传&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">			<span class="n">Continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">channel</span><span class="o">=$$</span><span class="n">GetTestSetChannel</span><span class="p">(</span><span class="n">tsCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="s1">&#39;$L(channel) {</span>
</span></span><span class="line"><span class="cl">			<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码扫:&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;,医嘱:&#34;</span><span class="n">_tsCode_</span><span class="s2">&#34;||&#34;</span><span class="n">_tsDesc_</span><span class="s2">&#34;,未找到通道号&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">			<span class="n">Continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">Continue</span><span class="p">:</span><span class="o">$</span><span class="n">D</span><span class="p">(</span><span class="n">uploadList</span><span class="p">(</span><span class="n">tsCode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">uploadList</span><span class="p">(</span><span class="n">tsCode</span><span class="p">)</span><span class="o">=</span><span class="n">channel</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">uploadList</span><span class="o">=$</span><span class="n">I</span><span class="p">(</span><span class="n">uploadList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">+$</span><span class="n">G</span><span class="p">(</span><span class="n">uploadList</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">D</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;条码扫:&#34;</span><span class="n">_barcode_</span><span class="s2">&#34;未找可上传的医嘱&#34;</span><span class="p">,</span><span class="s2">&#34;Order&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="mi">1</span><span class="p">,</span><span class="err">仪器发送过来的请求信息</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">MSH</span><span class="o">|^~</span>\<span class="o">&amp;||</span><span class="n">Mindray</span><span class="o">|||</span><span class="mi">20081120174836</span><span class="o">||</span><span class="n">ORM</span><span class="o">^</span><span class="n">O01</span><span class="o">|</span><span class="mi">4</span><span class="o">|</span><span class="n">P</span><span class="o">|</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">1</span><span class="o">||||||</span><span class="n">UNICODE</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">ORC</span><span class="o">|</span><span class="n">RF</span><span class="o">||</span><span class="n">SampleID1</span><span class="o">||</span><span class="ne">IP</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">msh</span><span class="o">=</span><span class="s2">&#34;MSH|^~\&amp;|LIS||||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZDT</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="s2">&#34; :&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;||ORR^O02|1|P|2.3.1||||||UNICODE&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">huifu</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">MSH</span><span class="o">|^~</span>\<span class="o">&amp;|</span><span class="n">LIS</span><span class="o">||||</span><span class="mi">20081120174836</span><span class="o">||</span><span class="n">ORR</span><span class="o">^</span><span class="n">O02</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">P</span><span class="o">|</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">1</span><span class="o">||||||</span><span class="n">UNICODE</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">MSA</span><span class="o">|</span><span class="n">AA</span><span class="o">|</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">PID</span><span class="o">|</span><span class="mi">1</span><span class="o">||</span><span class="n">ChartNo</span><span class="o">^^^^</span><span class="n">MR</span><span class="o">||^</span><span class="n">FName</span><span class="o">||</span><span class="mi">19810506</span><span class="o">|</span><span class="n">NT</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">PV1</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">E</span><span class="o">|</span><span class="err">内科</span><span class="o">^^</span><span class="n">Bn4</span><span class="o">|||||||||||||||||</span><span class="n">NewCharge</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">ORC</span><span class="o">|</span><span class="n">AF</span><span class="o">|</span><span class="n">SampleID1</span><span class="o">|||</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBR</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">SampleID1</span><span class="o">||||</span><span class="mi">20060506</span><span class="o">||||</span><span class="n">tester</span><span class="o">|||</span><span class="n">Diagnose</span> <span class="n">content</span><span class="o">...|</span><span class="mi">20060504</span><span class="o">||||||||</span><span class="mi">20080821</span><span class="o">||</span><span class="n">HM</span><span class="o">||||</span><span class="err">审核者</span><span class="o">||||</span><span class="err">检验者</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">IS</span><span class="o">|</span><span class="mi">08001</span><span class="o">^</span><span class="n">Take</span> <span class="n">Mode</span><span class="o">^</span><span class="mi">99</span><span class="n">MRC</span><span class="o">||</span><span class="n">A</span><span class="o">||||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">2</span><span class="o">|</span><span class="n">IS</span><span class="o">|</span><span class="mi">08002</span><span class="o">^</span><span class="n">Blood</span> <span class="n">Mode</span><span class="o">^</span><span class="mi">99</span><span class="n">MRC</span><span class="o">||</span><span class="n">W</span><span class="o">||||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">3</span><span class="o">|</span><span class="n">IS</span><span class="o">|</span><span class="mi">08003</span><span class="o">^</span><span class="n">Test</span> <span class="n">Mode</span><span class="o">^</span><span class="mi">99</span><span class="n">MRC</span><span class="o">||</span><span class="n">CBC</span><span class="o">||||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">4</span><span class="o">|</span><span class="n">IS</span><span class="o">|</span><span class="mi">01002</span><span class="o">^</span><span class="n">Ref</span> <span class="n">Group</span><span class="o">^</span><span class="mi">99</span><span class="n">MRC</span><span class="o">||</span><span class="n">XXXX</span><span class="o">||||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">5</span><span class="o">|</span><span class="n">NM</span><span class="o">|</span><span class="mi">30525</span><span class="o">-</span><span class="mi">0</span><span class="o">^</span><span class="n">Age</span><span class="o">^</span><span class="n">LN</span><span class="o">||</span><span class="mi">1</span><span class="o">|</span><span class="n">hr</span><span class="o">|||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBX</span><span class="o">|</span><span class="mi">6</span><span class="o">|</span><span class="n">ST</span><span class="o">|</span><span class="mi">01001</span><span class="o">^</span><span class="n">Remark</span><span class="o">^</span><span class="mi">99</span><span class="n">MRC</span><span class="o">||</span><span class="n">remark</span> <span class="n">content</span><span class="o">...||||||</span><span class="n">F</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">未找到检测时</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">MSH</span><span class="o">|^~</span>\<span class="o">&amp;|</span><span class="n">LIS</span><span class="o">||||</span><span class="mi">20081120174836</span><span class="o">||</span><span class="n">ORR</span><span class="o">^</span><span class="n">O02</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">P</span><span class="o">|</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">1</span><span class="o">||||||</span><span class="n">UNICODE</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">MSA</span><span class="o">|</span><span class="n">AR</span><span class="o">|</span><span class="mi">9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GetTestSetChannel</span><span class="p">(</span><span class="n">tsCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">N</span> <span class="p">(</span><span class="n">tsCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tsCode</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">tsCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="assets/8-%e8%a1%80%e7%bb%86%e8%83%9e%ef%bc%88%e8%bf%88%e7%91%9e7500%ef%bc%89%ef%bc%89H-046-011151-00-7.0%20labXpert%20%e9%80%9a%e4%bf%a1%e5%8d%8f%e8%ae%ae%ef%bc%88%e4%b8%ad%e6%96%87%ef%bc%89-20250111212208-ghft7fx.pdf" >8-血细胞（迈瑞7500））H-046-011151-00-7.0 labXpert 通信协议（中文）</a> <a href="assets/8-血细胞（迈瑞7500））H-046-011151-00-7.0%20labXpert%20通信协议（中文）-20250111212208-ghft7fx.pdf" 
download="8-血细胞（迈瑞7500））H-046-011151-00-7.0 labXpert 通信协议（中文）-20250111212208-ghft7fx.pdf"
class="pdf-download" style="margin-left: 10px;">
<img src="/icons/pdf.svg" alt="PDF文件" style="width:16px; height:16px; margin-right:5px;">
点击下载pdf
</a></p>
<p><img src="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250111002720-fzqnjdw.png"
	width="722"
	height="1627"
	srcset="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250111002720-fzqnjdw_hu_692a2af968a321e9.png 480w, /p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250111002720-fzqnjdw_hu_37ba8e8aa61e109f.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="44"
		data-flex-basis="106px"
	
></p>
<h3 id="astm-协议接口双向">ASTM 协议接口双向
</h3><h4 id="一次性发送按照字符数多次发送">一次性发送按照字符数多次发送
</h4><blockquote>
<p>限制每次发送字数不能超过 241 个字数，在回传时要根据回传的字符数进行分割</p></blockquote>
<h5 id="示例接口日立-008">示例接口(日立 008)
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">////</span> <span class="n">MI</span><span class="o">.</span><span class="n">MIFABH7600BI</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">名称</span><span class="p">:</span> <span class="n">MI</span><span class="o">.</span><span class="n">MIFDXC800BI</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">描述</span><span class="p">:</span> <span class="n">DXC800</span> <span class="err">仪器接口</span>  
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">通讯方式：双向</span><span class="p">,</span><span class="err">半双工</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">编写者</span><span class="p">:</span><span class="n">liuzf</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">编写日期</span><span class="p">:</span> <span class="mi">20150827</span>
</span></span><span class="line"><span class="cl"><span class="n">MIFABH7600BI</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="p">;</span> <span class="mi">3</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">04</span> <span class="p">;</span> <span class="n">ASTM</span> <span class="n">protocol</span> <span class="o">-</span> <span class="n">H7600</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">^</span><span class="n">TMPMACH10</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="mi">104</span><span class="p">)</span><span class="o">=$</span><span class="n">H</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(mi) q</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ItemDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">12</span><span class="p">)</span> <span class="o">//</span><span class="err">项目分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ResultDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">13</span><span class="p">)</span> <span class="o">//</span><span class="err">结果分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AntDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">14</span><span class="p">)</span> <span class="o">//</span><span class="err">抗生素分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SenDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span> <span class="o">//</span><span class="err">药敏结果分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Port</span><span class="o">=</span><span class="s2">&#34;|TCP|&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>  <span class="o">//</span><span class="err">端口号</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">控制字符</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">stx</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">etx</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ack</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">enq</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">eot</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">lf</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="n">nak</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">21</span><span class="p">),(</span><span class="n">result</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">etb</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">^</span><span class="n">TMPMACH10</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="mi">102</span><span class="p">)</span><span class="o">=$</span><span class="n">H</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$$</span><span class="n">Start</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span>  <span class="n">d</span> <span class="n">Main</span> <span class="n">i</span> <span class="o">$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  	<span class="n">c</span> <span class="n">Port</span>
</span></span><span class="line"><span class="cl">  	<span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="n">ErrHandler</span>
</span></span><span class="line"><span class="cl">	<span class="n">h</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZERROR</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="s2">&#34;--&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;.错误代码:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ECODE</span><span class="p">,</span><span class="s2">&#34;Runtime Error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">iERR</span><span class="o">=+$</span><span class="n">g</span><span class="p">(</span><span class="n">iERR</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">iERR</span><span class="o">&gt;</span><span class="mi">30</span> <span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">SET</span> <span class="o">$</span><span class="n">ZTRAP</span><span class="o">=</span><span class="s2">&#34;ErrHandler&#34;</span> <span class="n">S</span> <span class="n">iERR</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span> <span class="n">e</span>  <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">BUILD</span>
</span></span><span class="line"><span class="cl">  <span class="o">.//</span><span class="err">自动上传</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">BUILD2</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">ACK</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">f</span>  <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span> <span class="n">q</span><span class="p">:</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=stx q</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">record</span><span class="o">=$$</span><span class="n">Read</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">lf</span><span class="p">)</span> <span class="n">q</span><span class="p">:</span><span class="s1">&#39;$l(record)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">record</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="n">AllRecord_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="n">etb</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">d</span> <span class="n">ACK</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span><span class="p">:</span><span class="s2">&#34;EOT&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AllRecord</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AllRecord</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="p">(</span><span class="n">mid</span><span class="p">,</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">Pflag</span><span class="p">,</span><span class="n">code</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AllRecord</span><span class="p">,</span><span class="n">cr</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">rec</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">AllRecord</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;rec&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">type</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;H&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="p">(</span><span class="n">mid</span><span class="p">,</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">racksid</span><span class="p">,</span><span class="n">rackno</span><span class="p">,</span><span class="n">code</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;Q&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">Q</span><span class="o">|</span><span class="mi">1</span><span class="o">|^^</span><span class="mi">0</span><span class="o">/*************/</span><span class="mi">1</span><span class="o">/</span><span class="mi">5527</span><span class="o">/</span><span class="mi">5</span><span class="o">/</span><span class="n">R1</span><span class="o">/</span><span class="n">R</span><span class="o">||||||||||</span><span class="n">A</span><span class="s2">&#34;_$c(13)_&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">temstr</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">temlabno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">s</span> <span class="n">temlabno</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34;*&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">i</span> <span class="s1">&#39;$l(temlabno) q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">s</span> <span class="n">racksid</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">s</span> <span class="n">rackno</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">S</span> <span class="n">temlabno</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">temlabno</span><span class="p">,</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">s</span> <span class="n">temlabno</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34;*&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">i</span> <span class="s1">&#39;$l(temlabno) q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">racksid</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">rackno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="s2">&#34;temlabnoInfo&#34;</span><span class="p">,</span><span class="n">temlabno</span><span class="p">)</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">temlabno</span><span class="p">,</span><span class="s2">&#34;temlabno&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">s</span> <span class="n">temlabno</span><span class="o">=</span><span class="mi">9000001621</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">i</span> <span class="s1">&#39;$l(temlabno) q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="n">temlabno</span><span class="p">)</span><span class="o">=</span><span class="n">racksid_</span><span class="s2">&#34;^&#34;</span><span class="n">_rackno</span>
</span></span><span class="line"><span class="cl">  <span class="o">...//------------------------------------</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;O&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="k">if</span> <span class="n">epis</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">s</span> <span class="n">epis</span><span class="o">=+$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">qcid</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">qcid</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">qcid</span><span class="p">,</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">QCStat</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">SpecStat</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">i</span> <span class="n">SpecStat</span><span class="o">=</span><span class="s2">&#34;S&#34;</span> <span class="n">s</span> <span class="n">epis</span><span class="o">=</span><span class="n">epis</span> <span class="o">//</span><span class="n">s</span> <span class="n">epis</span><span class="o">=</span><span class="s2">&#34;E&#34;</span><span class="n">_epis</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">i</span> <span class="n">QCStat</span><span class="o">=</span><span class="s2">&#34;Q&#34;</span> <span class="n">s</span> <span class="n">QC</span><span class="o">=</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">_qcid,epis=qcid</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">s</span> <span class="n">QC</span><span class="o">=$$</span><span class="n">findQC</span><span class="o">^</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">datex</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">23</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....//</span><span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;/&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;/&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;,</span><span class="n">date</span><span class="o">=$$</span><span class="n">intdate</span><span class="o">^</span><span class="n">SSUTIL4</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....//</span><span class="n">s</span> <span class="n">time</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span> <span class="p">;,</span><span class="n">time</span><span class="o">=$$</span><span class="n">inttime</span><span class="o">^</span><span class="n">SSUTIL4</span><span class="p">(</span><span class="n">time1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...//--------------------</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;R&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">code</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">mid1</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....//</span><span class="n">DaiYi</span> <span class="mi">20111226</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">mid1</span><span class="o">=</span><span class="s2">&#34;ISE1&#34;</span> <span class="n">Set</span> <span class="n">mid1</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">If</span> <span class="n">mid1</span><span class="o">=</span><span class="s2">&#34;D1&#34;</span> <span class="n">Set</span> <span class="n">mid1</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">If</span> <span class="n">mid1</span><span class="s1">&#39;=&#34;&#34;,QC&#39;</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">Set</span> <span class="n">QC</span><span class="o">=$$</span><span class="n">findQC</span><span class="o">^</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_mid1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">If</span> <span class="n">mid1</span><span class="s1">&#39;=&#34;&#34;,QC&#39;</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">Set</span> <span class="n">epis</span><span class="o">=</span><span class="n">epis_mid1</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">mid1</span><span class="s1">&#39;=&#34;&#34; s mid=mid1</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">res</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;C&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....//-----</span><span class="n">FLAG</span><span class="o">---</span><span class="n">DaiYi</span> <span class="mi">2010</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">12</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">resFlag</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">0</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">26</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;$&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">5</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;Z&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">43</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;!&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">1</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;A&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">2</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;Q&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">3</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;V&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">4</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;T&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">6</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;P&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">7</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;I&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">8</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;J&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">9</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;K&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">10</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;W&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">11</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;F&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">12</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;H&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">13</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;U&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">14</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;S&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">15</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;Y&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">16</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;G&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">17</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;B&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">18</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;N&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">19</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;L&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">20</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;E&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">21</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;R&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">22</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;D&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">23</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;&amp;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">24</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;Z&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">25</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;M&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">27</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;$&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">28</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;@&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">29</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;#&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">30</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;#&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">31</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;#&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">32</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;#&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">33</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;#&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">34</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;#&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">35</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;+&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">36</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;+&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">37</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;%&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">38</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;O&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">39</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;X&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">42</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;&#39;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">43</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;!&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">44</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;=&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">45</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;=&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">46</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;&gt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">51</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;:&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">52</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">53</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;/&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">55</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;r&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">62</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;g&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">63</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;a&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">64</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;b&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">65</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;p&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">66</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;q&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">67</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;h&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">68</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;k&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">69</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;m&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">70</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;f&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">71</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;d&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">72</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;e&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">74</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;y&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">75</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;t&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">76</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;s&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">77</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;c&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">86</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;u&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">87</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;n&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">93</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;z&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">94</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;]&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">95</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;[&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">96</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;[&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">97</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;}&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">98</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;v&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">99</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;w&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">100</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;&lt;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">If</span> <span class="n">resFlag</span><span class="o">=</span><span class="mi">101</span> <span class="n">Set</span> <span class="n">resFlag</span><span class="o">=</span><span class="s2">&#34;￥&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="p">;</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_code_ResultDeli_res_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">,</span><span class="mi">92</span><span class="p">,</span><span class="mi">92</span><span class="p">)</span><span class="n">_resFlag_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_code_ResultDeli_res_ItemDeli</span>
</span></span><span class="line"><span class="cl">  <span class="o">....//------------------------------------------------</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;L&#34;</span> <span class="n">d</span> <span class="n">Last</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Last</span>	<span class="p">;</span> <span class="n">file</span> <span class="n">result</span> <span class="k">if</span> <span class="n">exist</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">BUILD</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;1H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="s2">&#34;1H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">s</span> <span class="n">epis</span><span class="o">=</span><span class="mi">9775</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">d</span> <span class="n">Save</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">BUILD</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="s1">&#39;$d(^TMP($zn)) q</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="s1">&#39;$d(^TMP($zn,$j)) q </span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">labno</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">labno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="err">根据预置条码号取得检验条码号</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="n">s</span> <span class="o">^</span><span class="n">aai200</span><span class="p">(</span><span class="mi">763</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.//</span><span class="n">s</span> <span class="n">labno1</span><span class="o">=$$</span><span class="n">GetLabNo</span><span class="o">^</span><span class="n">CHDhcLabDoEpis</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.//</span><span class="n">s</span> <span class="o">^</span><span class="n">aai200</span><span class="p">(</span><span class="mi">764</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="n">labno1_</span><span class="s2">&#34;,&#34;</span><span class="n">_labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_mi</span>
</span></span><span class="line"><span class="cl">  <span class="o">.//----</span><span class="err">判断日志条码和系统条码是否一样</span><span class="o">----</span>
</span></span><span class="line"><span class="cl">  <span class="o">.//</span><span class="n">If</span> <span class="n">labno</span><span class="o">=</span><span class="n">labno1</span> <span class="n">Quit</span>
</span></span><span class="line"><span class="cl">  <span class="o">.//--------------------------------------</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_</span><span class="s2">&#34;^^^&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">chl</span><span class="p">,</span><span class="s2">&#34;_&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;^</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">tcx</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="n">s</span> <span class="n">xx</span><span class="o">=$$</span><span class="n">extdate2</span><span class="o">^</span><span class="n">SSUTIL4</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">),</span><span class="n">date</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="n">s</span> <span class="n">xx</span><span class="o">=$$</span><span class="n">exttime</span><span class="o">^</span><span class="n">SSUTIL4</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="n">time</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;00&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">temepis</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&#34;1H|\^&amp;|||host^1|||||LST008AS|TSDWN^REPLY|P|1&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.//</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;P|1|||||||M||||||48^Y&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;P|1|||||||||||||&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">samtype</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">racksid</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="n">s</span> <span class="n">rackno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">temlabnoInfo</span><span class="o">=^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="s2">&#34;temlabnoInfo&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">i</span> <span class="n">labno</span><span class="o">=</span><span class="s2">&#34;N&#34;</span> <span class="n">s</span> <span class="n">labno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="n">d</span> <span class="n">SetTSMachine</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">racksid</span><span class="p">,</span><span class="n">rackno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;O|1|&#34;</span><span class="n">_labno_</span><span class="s2">&#34;|&#34;</span><span class="n">_temlabnoInfo_</span><span class="s2">&#34;|&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_tcx_</span><span class="s2">&#34;|R||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zdt</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;||||A||||1||||||||||O&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;O|1|40045259602|0^00001^1^^S1^SC|^^^601^\^^^1011^dec</span><span class="se">\101</span><span class="s2">2^400|R||20000630131236||||A||||1||||||||||O&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;C|1|I|comment1^comment2^comment3^comment4^comment5|G&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;L|1|N&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">Send</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">k</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">k</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="s2">&#34;temlabnoInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="o">//</span><span class="err">读取自动上传的标本</span>
</span></span><span class="line"><span class="cl"><span class="n">BUILD2</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LabnoList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MI&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">AddDate</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">Labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.//</span><span class="n">H</span> <span class="mi">1</span>  <span class="o">//</span><span class="err">每隔</span><span class="mi">2</span><span class="n">S处理一个标本上传</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">S</span> <span class="n">SIMAck</span><span class="o">=$$</span><span class="n">BUILD3</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">I</span> <span class="n">SIMAck</span><span class="o">=</span><span class="mi">0</span> <span class="n">D</span>  
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">err</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,Labno,&#34;S&#34;,&#34;&#34;)  //成功</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">E</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">err</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,Labno,&#34;F&#34;,&#34;&#34;)  //失败</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span>  
</span></span><span class="line"><span class="cl"><span class="n">BUILD3</span><span class="p">()</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">S</span> <span class="n">episx</span><span class="o">=</span><span class="n">Labno</span><span class="p">,</span><span class="n">Labno</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">RetAck</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">WorkGPMiDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">WorkGPMiDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RptOrder</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span> <span class="n">WorkGPMiDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">RptOrder</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span> <span class="n">WorkGPMiDR</span><span class="p">,</span><span class="n">RptOrder</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">EpisodeNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">EpisodeNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">epis</span><span class="o">=</span><span class="n">EpisodeNo</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">Labno</span><span class="p">)</span> <span class="p">;</span><span class="err">创建上传化验项目列表</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="s1">&#39;$D(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,Labno)) q 1</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">Labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_</span><span class="s2">&#34;^^^&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">chl</span><span class="p">,</span><span class="s2">&#34;_&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;/</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">tcx</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">time</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&#34;1H|\^&amp;|||H7600^1|||||host|TSDWN^REPLY|P|1&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;P|1&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;O|1|&#34;</span><span class="n">_epis_</span><span class="s2">&#34;^^1^^|R1|&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_tcx_</span><span class="s2">&#34;|R||&#34;</span><span class="n">_date_time_</span><span class="s2">&#34;||||N||||||||^^^^||||||O&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;L|1|N&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">d</span> <span class="n">Send</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">//</span><span class="err">给检验号赋仪器和位置号</span>
</span></span><span class="line"><span class="cl"><span class="n">SetTSMachine</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">rack</span><span class="p">,</span><span class="n">pos</span><span class="p">)</span> <span class="n">n</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">rack</span><span class="p">,</span><span class="n">pos</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"> <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">rack</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">rack</span><span class="p">),</span><span class="n">pos</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">If</span> <span class="o">$</span><span class="n">Data</span><span class="p">(</span><span class="o">^</span><span class="n">DHCSndLabNo</span><span class="p">(</span><span class="n">labno</span><span class="p">))</span> <span class="n">Set</span> <span class="o">^</span><span class="n">DHCSndLabNo</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">_rack_&#34;</span><span class="o">-</span><span class="s2">&#34;_pos_&#34;</span>\<span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="n">q</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">ORDER</span>  <span class="p">;</span> <span class="n">create</span> <span class="n">list</span> <span class="n">of</span> <span class="n">orders</span> <span class="k">if</span> <span class="n">exists</span> <span class="p">;</span> <span class="o">^</span><span class="n">DHCMIFLoadList</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;PEND&#34;</span><span class="p">,</span><span class="n">flowno</span><span class="p">)</span> <span class="err">暂时存储上传医嘱列表</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">ord</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">f</span>  <span class="n">s</span> <span class="n">ord</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">DHCMIFLoadList</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;PEND&#34;</span><span class="p">,</span><span class="n">ord</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">ord</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">rectemp</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">DHCMIFLoadList</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;PEND&#34;</span><span class="p">,</span><span class="n">ord</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">epis</span><span class="o">=</span><span class="n">ord</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">tcs</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="err">化验项目列表</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">rectemp</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="n">d</span> 
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">tc</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rectemp</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">q</span><span class="p">:</span><span class="n">tc</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">tcs</span><span class="o">=</span><span class="n">tcs_</span><span class="s2">&#34;^^^&#34;</span><span class="n">_tc_</span><span class="s2">&#34;/</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">tcs</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">tcs</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="err">日期时间</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">xx</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">time</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;00&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="n">s</span> <span class="n">xx</span><span class="o">=$$</span><span class="n">extdate2</span><span class="o">^</span><span class="n">SSUTIL4</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">),</span><span class="n">date</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="n">s</span> <span class="n">xx</span><span class="o">=$$</span><span class="n">exttime</span><span class="o">^</span><span class="n">SSUTIL4</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="n">time</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;00&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&#34;1H|\^&amp;|||HOST^1|||||1-99999|TSDWN^REPLY|P|1&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;P|1&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;O|1|&#34;</span><span class="n">_epis_</span><span class="s2">&#34;^ ^1^^|R1|&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_tcs_</span><span class="s2">&#34;|R||&#34;</span><span class="n">_date_time_</span><span class="s2">&#34;||||N||||||||^^^^||||||O&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;L|1|N&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">Send</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="o">^</span><span class="n">DHCMIFLoadList</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;TRAN&#34;</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">DHCMIFLoadList</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;PEND&#34;</span><span class="p">,</span><span class="n">epis</span><span class="p">))</span> <span class="p">;</span><span class="err">保存已传输数据</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">k</span> <span class="o">^</span><span class="n">DHCMIFLoadList</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;PEND&#34;</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span> <span class="p">;</span><span class="err">删除待传输数据</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Send</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>  <span class="p">;</span> <span class="n">send</span> <span class="n">list</span> <span class="n">of</span> <span class="n">orders</span> <span class="k">if</span> <span class="n">exists</span>
</span></span><span class="line"><span class="cl">  <span class="n">h</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">  <span class="p">;</span><span class="n">w</span> <span class="n">enq</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">trace</span><span class="o">^</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">w</span> <span class="n">enq</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">f</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span> <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">1</span> <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="o">!</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">:</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">nak</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;1H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=ack w eot,*-3 d Trace^MI.MIF000(mi,&#34;EOT&#34;,&#34;H--&gt;M&#34;) q</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">240</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">str1</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">240</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">strS</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="mi">241</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">strS</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">240</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">str2</span><span class="o">=</span><span class="s2">&#34;2&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">strS</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">240</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">strS1</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">strS</span><span class="p">,</span><span class="mi">241</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">strS</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">strS1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">240</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">str3</span><span class="o">=</span><span class="s2">&#34;3&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">strS1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">240</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">str4</span><span class="o">=</span><span class="s2">&#34;4&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">strS1</span><span class="p">,</span><span class="mi">241</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">strS1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">str3</span><span class="o">=</span><span class="s2">&#34;3&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">strS1</span><span class="p">,</span><span class="mi">241</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">strS1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">str2</span><span class="o">=</span><span class="s2">&#34;2&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="mi">241</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">;</span><span class="n">f</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span> <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">1</span> <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="o">!</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="p">;</span><span class="n">d</span> <span class="n">trace</span><span class="o">^</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">:</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">nak</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;2H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">w</span> <span class="n">eot</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;EOT&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Sendold</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">;</span> <span class="n">send</span> <span class="n">list</span> <span class="n">of</span> <span class="n">orders</span> <span class="k">if</span> <span class="n">exists</span>
</span></span><span class="line"><span class="cl">  <span class="n">w</span> <span class="n">enq</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">f</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span> <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">1</span> <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="o">!</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">:</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">nak</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;1H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=ack w eot,*-3 d Trace^MI.MIF000(mi,&#34;EOT&#34;,&#34;H--&gt;M&#34;) q</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">241</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">str1</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">241</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">str2</span><span class="o">=</span><span class="s2">&#34;2&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="mi">242</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">w</span> <span class="n">eot</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;EOT&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">SEND</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span> <span class="p">;</span> <span class="n">send</span> <span class="n">string</span> <span class="n">to</span> <span class="n">instrument</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="n">flag</span><span class="o">=</span><span class="mi">1</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_etb</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">chsum</span><span class="o">=$$</span><span class="n">CHSUM</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_etx</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">chsum</span><span class="o">=$$</span><span class="n">CHSUM</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">w</span> <span class="n">stx</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="n">chsum</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">lf</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">str_chsum</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">f</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span> <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">1</span> <span class="n">i</span> <span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">)</span><span class="o">!</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span> <span class="n">q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;EOT&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span> <span class="n">q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=-</span><span class="mi">1</span> <span class="n">w</span> <span class="n">nak</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">CHSUM</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">;</span> <span class="n">calculate</span> <span class="n">check</span> <span class="n">sum</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">s</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span> <span class="n">f</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">s</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+$</span><span class="n">a</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">z</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="s2">&#34;0123456789ABCDEF&#34;</span><span class="p">,</span><span class="n">z</span><span class="c1">#256\16+1)_$e(&#34;0123456789ABCDEF&#34;,z#16+1)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl"><span class="n">ACK</span>  <span class="p">;</span> <span class="n">send</span> <span class="s1">&#39;ack&#39;</span> <span class="n">to</span> <span class="n">instrument</span>
</span></span><span class="line"><span class="cl">  <span class="n">w</span> <span class="n">ack</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="n">NEXTTRAY</span><span class="p">(</span><span class="n">tray</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">  <span class="n">q</span> <span class="n">tray</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110224136-youpa8q.png"
	width="784"
	height="192"
	srcset="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110224136-youpa8q_hu_2f34ce67a3700519.png 480w, /p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110224136-youpa8q_hu_3f4a00ee8f464669.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="408"
		data-flex-basis="980px"
	
></p>
<h4 id="通过收到-ack-发送多条数据">通过收到 ACK 发送多条数据
</h4><h5 id="示例接口贝克曼-dxh900">示例接口(贝克曼 DXH900)
</h5><blockquote>
<p>标准的 ASTM 发送等收到 ACK 后继续回传下一条信息</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">MIFDXH800I(MachID) 
</span></span><span class="line"><span class="cl">	s MachID=$g(MachID) 
</span></span><span class="line"><span class="cl">	S ^TMPMACH10(MachID,104)=$H
</span></span><span class="line"><span class="cl">	i &#39;$l(MachID) q
</span></span><span class="line"><span class="cl">	s ItemDeli=$li(^dbo.BTMIMachineParameterD(MachID),12) //项目分隔符
</span></span><span class="line"><span class="cl">	s ResultDeli=$li(^dbo.BTMIMachineParameterD(MachID),13) //结果分隔符
</span></span><span class="line"><span class="cl">	s AntDeli=$li(^dbo.BTMIMachineParameterD(MachID),14) //抗生素分隔符
</span></span><span class="line"><span class="cl">	s SenDeli=$li(^dbo.BTMIMachineParameterD(MachID),15) //药敏结果分隔符
</span></span><span class="line"><span class="cl">	s Port=&#34;|TCP|&#34;_$li(^dbo.BTMIMachineParameterD(MachID),17) //端口号
</span></span><span class="line"><span class="cl">	//控制字符
</span></span><span class="line"><span class="cl">	s stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4),lf=$c(10),cr=$c(13),nak=$c(21)
</span></span><span class="line"><span class="cl">	//s stx=&#34;[&#34;,etx=&#34;]&#34;
</span></span><span class="line"><span class="cl">	S ^TMPMACH10(MachID,102)=$H
</span></span><span class="line"><span class="cl">	i $$Start^MI.MIF000(MachID) q
</span></span><span class="line"><span class="cl">	f  d Main i $$Stop^MI.MIF000(MachID) q
</span></span><span class="line"><span class="cl">  	c Port
</span></span><span class="line"><span class="cl">  	q
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	///结果采集和数据分解
</span></span><span class="line"><span class="cl">Main
</span></span><span class="line"><span class="cl">	r *R:10 e  d  q
</span></span><span class="line"><span class="cl">	.d ORDER
</span></span><span class="line"><span class="cl">  	i $c(R)&#39;=enq q
</span></span><span class="line"><span class="cl">  	d Trace^MI.MIF000(MachID,&#34;ENQ&#34;,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl">  	d ACK
</span></span><span class="line"><span class="cl">  	s (Epis,Result,Date,Time,QC)=&#34;&#34;
</span></span><span class="line"><span class="cl">  	f  r *R:10 q:$c(R)=eot  q:R=-1  d
</span></span><span class="line"><span class="cl">  	.i $c(R)&#39;=stx q
</span></span><span class="line"><span class="cl">  	.s Record=$$Read^MI.MIF000(MachID,&#34;&#34;,lf) q:&#39;$l(Record)
</span></span><span class="line"><span class="cl">  	.d Trace^MI.MIF000(MachID,Record,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl">  	.d ACK
</span></span><span class="line"><span class="cl">  	.i $e(Record,2)=&#34;C&#34; d  q
</span></span><span class="line"><span class="cl">  	..//报警信息
</span></span><span class="line"><span class="cl">  	..s PoliceInfo=$p(Record,&#34;|&#34;,4)
</span></span><span class="line"><span class="cl">  	..i $l(PoliceInfo),$d(^LISPolice(&#34;DXH900&#34;,PoliceInfo)) d
</span></span><span class="line"><span class="cl">  	...s InputInfo=$g(^LISPolice(&#34;DXH900&#34;,PoliceInfo))
</span></span><span class="line"><span class="cl">  	...d Trace^MI.MIF000(MachID,PoliceInfo_&#34;$$&#34;_InputInfo,&#34;报警信息&#34;)
</span></span><span class="line"><span class="cl">  	...try{s ret=##Class(MI.Special.Common).SaveAlarmInformation(MachID,Epis,InputInfo)}catch{}
</span></span><span class="line"><span class="cl">  	.i $e(Record,2)=&#34;Q&#34; d  q
</span></span><span class="line"><span class="cl">  	..//询问信息
</span></span><span class="line"><span class="cl">  	..s QEpis=$tr($p(Record,&#34;|&#34;,3),&#34;!&#34;)
</span></span><span class="line"><span class="cl">  	..;d Trace^MI.MIF000(MachID,QEpis,&#34;QEpis&#34;)
</span></span><span class="line"><span class="cl">    ..S ^TMPQUERY(MachID,1)=QEpis
</span></span><span class="line"><span class="cl">  	..i $l(QEpis) s ^TMP($zn,$j,&#34;ENQ&#34;,QEpis)=&#34;&#34;
</span></span><span class="line"><span class="cl">  	.i $e(Record,2)=&#34;H&#34; d  q
</span></span><span class="line"><span class="cl">  	..//结果头信息
</span></span><span class="line"><span class="cl">  	..d Last s (Epis,Result,Date,Time,QC)=&#34;&#34;
</span></span><span class="line"><span class="cl">  	.i $e(Record,2)=&#34;P&#34; d  q
</span></span><span class="line"><span class="cl">  	..//病人信息
</span></span><span class="line"><span class="cl">  	.i $e(Record,2)=&#34;O&#34; d  q
</span></span><span class="line"><span class="cl">  	..s Epis=$tr($p($p(Record,&#34;|&#34;,3),&#34;^&#34;,1),&#34; &#34;)
</span></span><span class="line"><span class="cl">  	..s QC=$tr($p(Record,&#34;|&#34;,12),&#34; &#34;) 
</span></span><span class="line"><span class="cl">  	..s:&#39;$l(Epis) Epis=$tr($p($p(Record,&#34;|&#34;,4),&#34;^&#34;,1),&#34; &#34;)
</span></span><span class="line"><span class="cl">  	..//判断是否是质控编号
</span></span><span class="line"><span class="cl">  	..//s QC=$$findQC^MIF000(mi,epis)
</span></span><span class="line"><span class="cl">  	.i $e(Record,2)=&#34;R&#34; d  q
</span></span><span class="line"><span class="cl">  	..//结果信息
</span></span><span class="line"><span class="cl">  	..s Chl=$tr($tr($p($p(Record,&#34;|&#34;,3),&#34;!&#34;,4),&#34; &#34;),&#34;@&#34;)
</span></span><span class="line"><span class="cl">  	..//s ResStus=$tr($p($p(Record,&#34;|&#34;,3),&#34;^&#34;,11),&#34; &#34;)
</span></span><span class="line"><span class="cl">	..s Res=$p($tr($p(Record,&#34;|&#34;,4),&#34; &#34;),&#34;!&#34;,1)
</span></span><span class="line"><span class="cl">	..//i ResStus&#39;=&#34;F&#34; q //判断结果状态
</span></span><span class="line"><span class="cl">	..i $l(Chl),$l(Res) s Result=Result_Chl_ResultDeli_Res_ItemDeli
</span></span><span class="line"><span class="cl">	.//绘图
</span></span><span class="line"><span class="cl">    .i $e(Record,2)=&#34;M&#34; d  q
</span></span><span class="line"><span class="cl">    ..//结果信息
</span></span><span class="line"><span class="cl">    ..s Chl=$tr($p($p(Record,&#34;|&#34;,3),&#34;!&#34;,4),&#34; &#34;)
</span></span><span class="line"><span class="cl">    ..s Res=$P($tr($p(Record,&#34;|&#34;,4),&#34; |&#34;),&#34;!&#34;,1)
</span></span><span class="line"><span class="cl">    ..s Chl=$p(Chl,&#34;.&#34;,1)
</span></span><span class="line"><span class="cl">    ..i Chl=&#34;WBC&#34; d
</span></span><span class="line"><span class="cl">    ...s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    ...s tret=tretObj.DrawImage(Epis,Res,MachID,&#34;MI.MIFDXH800&#34;,&#34;-1&#34;,&#34;Histogram#WBCF.bmp#######10#10#320#138&#34;,&#34;LIS.Mach.ImageDeal.ImageDealDXH800,LIS.Mach.ImageDeal&#34;) 
</span></span><span class="line"><span class="cl">    ...d Trace^MI.MIF000(MachID,tret,&#34;绘图返回&#34;)
</span></span><span class="line"><span class="cl">    ..i Chl=&#34;Plt&#34; d
</span></span><span class="line"><span class="cl">    ...s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    ...s tret=tretObj.DrawImage(Epis,Res,MachID,&#34;MI.MIFDXH800&#34;,&#34;-1&#34;,&#34;Histogram#PLT.bmp#######10#10#320#138&#34;,&#34;LIS.Mach.ImageDeal.ImageDealDXH800,LIS.Mach.ImageDeal&#34;) 
</span></span><span class="line"><span class="cl">    ...d Trace^MI.MIF000(MachID,tret,&#34;绘图返回&#34;)
</span></span><span class="line"><span class="cl">    ..i Chl=&#34;RBC&#34; d
</span></span><span class="line"><span class="cl">    ...s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    ...s tret=tretObj.DrawImage(Epis,Res,MachID,&#34;MI.MIFDXH800&#34;,&#34;-1&#34;,&#34;Histogram#RBCH.bmp#######10#10#320#138&#34;,&#34;LIS.Mach.ImageDeal.ImageDealDXH800,LIS.Mach.ImageDeal&#34;) 
</span></span><span class="line"><span class="cl">    ...d Trace^MI.MIF000(MachID,tret,&#34;绘图返回&#34;)
</span></span><span class="line"><span class="cl">    ..i Chl=&#34;5PD1&#34; d
</span></span><span class="line"><span class="cl">    ...s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    ...s tret=tretObj.DrawImage(Epis,Res,MachID,&#34;MI.MIFDXH800&#34;,&#34;-1&#34;,&#34;DiffPlot#5PD1.bmp#######10#10#320#138&#34;,&#34;LIS.Mach.ImageDeal.ImageDealDXH800,LIS.Mach.ImageDeal&#34;) 
</span></span><span class="line"><span class="cl">    ...d Trace^MI.MIF000(MachID,tret,&#34;绘图返回&#34;)
</span></span><span class="line"><span class="cl">    ..i Chl=&#34;NRBC1&#34; d
</span></span><span class="line"><span class="cl">    ...s tretObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisDrawImageAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    ...s tret=tretObj.DrawImage(Epis,Res,MachID,&#34;MI.MIFDXH800&#34;,&#34;-1&#34;,&#34;DiffPlot#NRBC1.bmp#######10#10#320#138&#34;,&#34;LIS.Mach.ImageDeal.ImageDealDXH800,LIS.Mach.ImageDeal&#34;) 
</span></span><span class="line"><span class="cl">    ...d Trace^MI.MIF000(MachID,tret,&#34;绘图返回&#34;)
</span></span><span class="line"><span class="cl">	.i $e(Record,2)=&#34;L&#34; d Last q
</span></span><span class="line"><span class="cl">	d Trace^MI.MIF000(MachID,$s($c(R)=eot:&#34;EOT&#34;,1:R),&#34;H&lt;--M&#34;) 
</span></span><span class="line"><span class="cl">	d ORDER
</span></span><span class="line"><span class="cl">	q
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">	///保存结果
</span></span><span class="line"><span class="cl">Last  ; file result if exist
</span></span><span class="line"><span class="cl">   i $l(Epis),$l(Result) d Save^MI.MIF000(MachID,Epis,Result,Date,Time,QC)
</span></span><span class="line"><span class="cl">   q
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	///上传项目
</span></span><span class="line"><span class="cl">ORDER
</span></span><span class="line"><span class="cl">	s date=$tr($zdt($p($h,&#34;,&#34;,1),3),&#34;-&#34;)_$tr($zt($p($h,&#34;,&#34;,2)),&#34;:&#34;)
</span></span><span class="line"><span class="cl">	s ^TMPQUERY(MachID,2)=$d(^TMP($zn,$j))
</span></span><span class="line"><span class="cl">	i &#39;$d(^TMP($zn,$j)) q 
</span></span><span class="line"><span class="cl">	;d Trace^MI.MIF000(MachID,&#34;准备上传,清除缓存&#34;,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl">	k ^TMP(&#34;MIFTESTCODE&#34;,$j,MachID)
</span></span><span class="line"><span class="cl">	k ^TMPQUERY(MachID,4)
</span></span><span class="line"><span class="cl">  	s Epis=&#34;&#34; f  s Epis=$o(^TMP($zn,$j,&#34;ENQ&#34;,Epis)) q:Epis=&#34;&#34;  d
</span></span><span class="line"><span class="cl">   	.d ScanOne^MI.MIF000(MachID,Epis)
</span></span><span class="line"><span class="cl">   	.;d PATDET(Epis)
</span></span><span class="line"><span class="cl">   	.s LSH=&#34;&#34;
</span></span><span class="line"><span class="cl">   	.s LSH=$$CHANGEEPIS(MachID,Epis)
</span></span><span class="line"><span class="cl">   	.d Trace^MI.MIF000(MachID,Epis,&#34;Epis&#34;)
</span></span><span class="line"><span class="cl">   	.s TCx=&#34;&#34;,Episx=Epis
</span></span><span class="line"><span class="cl">   	.s chl=&#34;&#34; f  s chl=$o(^TMP(&#34;MIFTESTCODE&#34;,$j,MachID,Epis,chl)) q:chl=&#34;&#34;  d
</span></span><span class="line"><span class="cl">   	..s TCx=TCx_&#34;!!!&#34;_chl
</span></span><span class="line"><span class="cl">   	.;s TCx=TCx_&#34;\&#34;
</span></span><span class="line"><span class="cl">   	.i TCx[&#34;CDR&#34; s TCx=&#34;!!!CDR&#34;
</span></span><span class="line"><span class="cl">   	.s sam=&#34;Sam&#34;
</span></span><span class="line"><span class="cl">   	.s pat=&#34;219!King!Eric!T&#34;
</span></span><span class="line"><span class="cl">   	.s F=&#34;F&#34;
</span></span><span class="line"><span class="cl">   	.s FA=&#34;Fairview!952-121-1123&#34;
</span></span><span class="line"><span class="cl">   	.s ^TMPQUERY(MachID,3)=TCx
</span></span><span class="line"><span class="cl">   	.i $l(TCx) d
</span></span><span class="line"><span class="cl">   	..s line=$o(^TMPTMIF(MachID,22,&#34;&#34;),-1)+1,^TMPTMIF(MachID,22,line)=&#34;H|\!~|||LISHOST|||||||P|LIS2-A|&#34;_date
</span></span><span class="line"><span class="cl">   	..s line=$o(^TMPTMIF(MachID,22,&#34;&#34;),-1)+1,^TMPTMIF(MachID,22,line)=&#34;P|1||&#34;_LSH  
</span></span><span class="line"><span class="cl">   	..;s line=$o(^TMPTMIF(MachID,22,&#34;&#34;),-1)+1,^TMPTMIF(MachID,22,line)=&#34;O|1|&#34;_Episx_&#34;|&#34;_Pos_&#34;|&#34;_tcx_&#34;|R||||||A||||Whole blood|||||||||||&#34;
</span></span><span class="line"><span class="cl">   	..;s line=$o(^TMPTMIF(MachID,22,&#34;&#34;),-1)+1,^TMPTMIF(MachID,22,line)=&#34;O|1|&#34;_Episx_&#34;||&#34;_TCx_&#34;|R|&#34;_date_&#34;|&#34;_date_&#34;|||&#34;_sam_&#34;|A||||Whole blood|&#34;_pat_&#34;|||||||||&#34;_F_&#34;||&#34;_FA
</span></span><span class="line"><span class="cl">   	..s line=$o(^TMPTMIF(MachID,22,&#34;&#34;),-1)+1,^TMPTMIF(MachID,22,line)=&#34;O|1|&#34;_Episx_&#34;||&#34;_TCx_&#34;|R|&#34;_date_&#34;|&#34;_date_&#34;|||&#34;_sam_&#34;|A||||Whole blood&#34;
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   	..s line=$o(^TMPTMIF(MachID,22,&#34;&#34;),-1)+1,^TMPTMIF(MachID,22,line)=&#34;L|1|N&#34;
</span></span><span class="line"><span class="cl">   	.e  d
</span></span><span class="line"><span class="cl">   	..s line=$o(^TMPTMIF(MachID,22,&#34;&#34;),-1)+1,^TMPTMIF(MachID,22,line)=&#34;Q|1|^&#34;_Epis_&#34;||^^^ALL||||||||X&#34;
</span></span><span class="line"><span class="cl">   	k ^TMP($zn,$j,&#34;ENQ&#34;)
</span></span><span class="line"><span class="cl">   	k ^TMP(&#34;MIFTESTCODE&#34;,$j,MachID)
</span></span><span class="line"><span class="cl">   	q:&#39;$d(^TMPTMIF(MachID,22))
</span></span><span class="line"><span class="cl">   	m ^TMPQUERY(MachID,4)=^TMPTMIF(MachID,22)
</span></span><span class="line"><span class="cl">   	d Send k ^TMPTMIF(MachID,22)
</span></span><span class="line"><span class="cl">   	q
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">	///病人基本信息
</span></span><span class="line"><span class="cl">PATDET(Epis)  ; set patient details record
</span></span><span class="line"><span class="cl"> 	s line=$o(^TMPTMIF(MachID,22,&#34;&#34;),-1)+1,^TMPTMIF(MachID,22,line)=&#34;P|1|&#34;_+$h_&#34;||||||U||||||||||||||||||||||||||&#34;
</span></span><span class="line"><span class="cl"> 	q 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">	///发送检测项目
</span></span><span class="line"><span class="cl">Send  
</span></span><span class="line"><span class="cl">	w enq,*-3 d Trace^MI.MIF000(MachID,&#34;ENQ&#34;,&#34;H--&gt;M&#34;)
</span></span><span class="line"><span class="cl"> 	f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q
</span></span><span class="line"><span class="cl"> 	d Trace^MI.MIF000(MachID,$s($c(R)=ack:&#34;ACK&#34;,$c(R)=enq:&#34;ENQ&#34;,$c(R)=nak:&#34;NAK&#34;,1:R),&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl"> 	i $c(R)=enq q
</span></span><span class="line"><span class="cl"> 	i $c(R)&#39;=ack w eot,*-3 d Trace^MI.MIF000(MachID,&#34;EOT&#34;,&#34;H--&gt;M&#34;) q
</span></span><span class="line"><span class="cl"> 	//q:$$SEND(&#34;1H|\^&amp;&#34;)
</span></span><span class="line"><span class="cl"> 	;q:$$SEND(&#34;1H|\^&amp;|||LIS||||||||LIS2-A|&#34;_date)
</span></span><span class="line"><span class="cl"> 	s x=&#34;&#34; f FRAME=1:1 s x=$O(^TMPQUERY(MachID,4,x)) q:x=&#34;&#34;  q:$$SEND(FRAME#8_^TMPQUERY(MachID,4,x))
</span></span><span class="line"><span class="cl">  	w eot,*-3 d Trace^MI.MIF000(MachID,&#34;EOT&#34;,&#34;H--&gt;M&#34;)
</span></span><span class="line"><span class="cl"> 	k ^TMPTMIF(MachID,22)
</span></span><span class="line"><span class="cl"> 	q
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"> 	///发送字符串
</span></span><span class="line"><span class="cl">SEND(str)
</span></span><span class="line"><span class="cl">	s str=str_cr_etx,chsum=$$CHSUM(str)
</span></span><span class="line"><span class="cl"> 	w stx,str,chsum,cr,lf,*-3 d Trace^MI.MIF000(MachID,str_chsum,&#34;H--&gt;M&#34;)
</span></span><span class="line"><span class="cl"> 	f j=1:1:6 r *R:1 i ($c(R)=ack)!($c(R)=eot) q
</span></span><span class="line"><span class="cl"> 	i $c(R)=ack d Trace^MI.MIF000(MachID,&#34;ACK&#34;,&#34;H&lt;--M&#34;) q 0
</span></span><span class="line"><span class="cl"> 	i $c(R)=eot d Trace^MI.MIF000(MachID,&#34;EOT&#34;,&#34;H&lt;--M&#34;) q 0
</span></span><span class="line"><span class="cl"> 	d Trace^MI.MIF000(MachID,R,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl"> 	q 1 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"> 	///生成校验码
</span></span><span class="line"><span class="cl">CHSUM(x)
</span></span><span class="line"><span class="cl">	n (x) s z=0 f y=1:1:$l(x) s z=z+$a(x,y)
</span></span><span class="line"><span class="cl"> 	s z=$e(&#34;0123456789ABCDEF&#34;,z#256\16+1)_$e(&#34;0123456789ABCDEF&#34;,z#16+1)
</span></span><span class="line"><span class="cl"> 	q z  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  	///发送回应符到仪器
</span></span><span class="line"><span class="cl">ACK
</span></span><span class="line"><span class="cl">	w ack,*-3 d Trace^MI.MIF000(MachID,&#34;ACK&#34;,&#34;H--&gt;M&#34;)
</span></span><span class="line"><span class="cl">	q
</span></span><span class="line"><span class="cl">	     
</span></span><span class="line"><span class="cl">	  
</span></span><span class="line"><span class="cl">CHANGEEPIS(mi,epis)  
</span></span><span class="line"><span class="cl"> 	//根据流水号找检测号
</span></span><span class="line"><span class="cl">    S DATA=$zd($h,8)
</span></span><span class="line"><span class="cl">	s mi=$g(mi),epis=$g(epis)
</span></span><span class="line"><span class="cl">	s VisitNumberReportDR=&#34;&#34;
</span></span><span class="line"><span class="cl">	b ;//^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,TransmitDate, WorkGroupMachineDR, EpisodeNo)
</span></span><span class="line"><span class="cl">    i &#39;$l(mi) q epis
</span></span><span class="line"><span class="cl">    i &#39;$l(epis) q epis  
</span></span><span class="line"><span class="cl">	s WorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)
</span></span><span class="line"><span class="cl">	i &#39;$l(WorkGroupMachineDR) q epis
</span></span><span class="line"><span class="cl">	s VisitNumberReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexAcceptDate&#34;,WorkGroupMachineDR,DATA,&#34; &#34;_epis,&#34;&#34;))
</span></span><span class="line"><span class="cl">	i &#39;$l(VisitNumberReportDR) q epis
</span></span><span class="line"><span class="cl">	s LSH=$lg($g(^dbo.RPVisitNumberReportD(VisitNumberReportDR)),8)
</span></span><span class="line"><span class="cl">	i &#39;$l(LSH) q epis 
</span></span><span class="line"><span class="cl">	B ;LSH
</span></span><span class="line"><span class="cl">	Q LSH
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">//// w $$GetName^MI.MIFBECKImage(70,3003497773)
</span></span><span class="line"><span class="cl">//// 取病人姓名按拼音输出,&#34;^&#34;分隔
</span></span><span class="line"><span class="cl">GetName(MachID,epis)
</span></span><span class="line"><span class="cl">    s epis = $g(epis),MachID=$g(MachID)
</span></span><span class="line"><span class="cl">    s SurName=&#34;&#34;
</span></span><span class="line"><span class="cl">    i $l(epis)=0 q &#34;&#34;
</span></span><span class="line"><span class="cl">    s VisitNumberDR = $o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis),&#34;&#34;))
</span></span><span class="line"><span class="cl">    i &#39;$l(VisitNumberDR) q &#34;&#34;
</span></span><span class="line"><span class="cl">    //标本信息
</span></span><span class="line"><span class="cl">    s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR))
</span></span><span class="line"><span class="cl">    s SurName=$lg(RPVisitNumberData,13)
</span></span><span class="line"><span class="cl">    i SurName&#39;=&#34;&#34; s SurName=$$GetCNCODE(SurName,3,&#34;^&#34;)
</span></span><span class="line"><span class="cl">    q SurName
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/// Description:返回汉字的编码信息
</span></span><span class="line"><span class="cl">/// Input：	HANZI:汉字
</span></span><span class="line"><span class="cl">/// 			FLAG:返回何种编码(1:ASC码,2:汉字,3:拼音,4:首拼,5:四角码6:五笔码7:区位码8:笔划数9:郑码)
</span></span><span class="line"><span class="cl">/// 			SPLIT:分割符(可以为空)
</span></span><span class="line"><span class="cl">/// Output：
</span></span><span class="line"><span class="cl">/// 	非0:返回编码信息:ASC码^汉字^拼音^首拼^四角码^五笔码^区位码^笔划数^郑码
</span></span><span class="line"><span class="cl">/// 	0：未找到编码信息
</span></span><span class="line"><span class="cl">/// CreatDate:2011-06-08
</span></span><span class="line"><span class="cl">/// w ##class(web.DHCINSUPort).GetCNCODE(&#34;东华&#34;,4,&#34;^&#34;)
</span></span><span class="line"><span class="cl">/// w ##class(web.DHCINSUPort).GetCNCODE(&#34;东华&#34;,4,&#34;&#34;)
</span></span><span class="line"><span class="cl">GetCNCODE(HANZIS,FLAG, SPLIT)
</span></span><span class="line"><span class="cl">	s Rtnstr=&#34;0&#34;
</span></span><span class="line"><span class="cl">	q:$g(HANZIS)=&#34;&#34; Rtnstr
</span></span><span class="line"><span class="cl">	s Rtnstr=&#34;&#34;
</span></span><span class="line"><span class="cl">	f i=1:1:$l(HANZIS) d
</span></span><span class="line"><span class="cl">	.s HANZI=$EXTRACT(HANZIS,i)
</span></span><span class="line"><span class="cl">	.s ASCIICODE=$ASCII(HANZI)
</span></span><span class="line"><span class="cl">	.i $D(^DHCCharacterEncoding(&#34;0&#34;,&#34;ASCII&#34;,ASCIICODE))&#39;=0 d
</span></span><span class="line"><span class="cl">	..s rowid=$o(^DHCCharacterEncoding(&#34;0&#34;,&#34;ASCII&#34;,ASCIICODE,&#34;&#34;))
</span></span><span class="line"><span class="cl">	..s tmpstr=&#34;&#34;
</span></span><span class="line"><span class="cl">	..s:FLAG=&#34;&#34; tmpstr=$g(^DHCCharacterEncoding(rowid))
</span></span><span class="line"><span class="cl">	..s:FLAG&#39;=&#34;&#34; tmpstr=$p(^DHCCharacterEncoding(rowid),&#34;^&#34;,FLAG)
</span></span><span class="line"><span class="cl">	..i Rtnstr=&#34;&#34;  d
</span></span><span class="line"><span class="cl">	...s Rtnstr=tmpstr
</span></span><span class="line"><span class="cl">	..e  d
</span></span><span class="line"><span class="cl">	...s Rtnstr=Rtnstr_SPLIT_tmpstr
</span></span><span class="line"><span class="cl">	.e  d
</span></span><span class="line"><span class="cl">	..s:Rtnstr=&#34;&#34; Rtnstr=&#34;?&#34;
</span></span><span class="line"><span class="cl">	..s Rtnstr=Rtnstr_SPLIT_&#34;?&#34;
</span></span><span class="line"><span class="cl">	q Rtnstr
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250111003210-lknq7r1.png"
	width="1206"
	height="1326"
	srcset="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250111003210-lknq7r1_hu_a64a5d5b88786628.png 480w, /p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250111003210-lknq7r1_hu_5283fae88e212d3.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="90"
		data-flex-basis="218px"
	
></p>
<h3 id="通过文件请求双向">通过文件请求双向
</h3><h4 id="上机生成请求文件请求">上机生成请求文件请求
</h4><h5 id="示例代码爱康-aigel400">示例代码(爱康 Aigel400)
</h5><blockquote>
<p>仪器上机扫条码后生成请求文件，通过监听读取文件，解析数据后回传文件，此处需特殊解析设置。将仪器配置为主动上传模式，解析数据时，将主动上传信息从 C 变为 X，QryLabInfo 循环读取为 X 的标本，从而实现文件双向。</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl">	<span class="err">双向比较特殊，需要配置两台仪器，一台用于接收，一台用于双向上传</span>
</span></span><span class="line"><span class="cl"><span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;Drect&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;3000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;D:</span><span class="se">\\</span><span class="s2">OUTPUT</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFAigel400&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;.txt&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoMAll,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;UpPara&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">},{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;41&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;Drect&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;3000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;D:</span><span class="se">\\</span><span class="s2">Aigel400</span><span class="se">\\</span><span class="s2">Data</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFAigel400&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;regexImport.dat&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoMAll,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UpPara&#34;</span><span class="p">:</span><span class="s2">&#34;D:</span><span class="se">\\</span><span class="s2">Aigel400</span><span class="se">\\</span><span class="s2">Data</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Class</span> <span class="n">MI</span><span class="o">.</span><span class="n">MIFAigel400</span> <span class="n">Extends</span> <span class="o">%</span><span class="n">RegisteredObject</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">H</span><span class="o">|</span>\<span class="o">^&amp;|||</span><span class="n">Across</span><span class="err">□</span><span class="n">Auto</span><span class="err">□</span><span class="n">System</span><span class="err">□</span><span class="n">OCTO</span><span class="o">-</span><span class="n">M</span><span class="o">^^</span><span class="mf">1.00</span><span class="o">.</span><span class="mi">25</span><span class="err">□</span><span class="p">(</span><span class="n">build17062603</span><span class="p">)</span><span class="o">|||||||</span><span class="n">P</span><span class="o">|</span><span class="mi">4</span><span class="o">|</span><span class="mi">20230503095046</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="n">P</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="mi">12</span><span class="o">|</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="n">O</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="mi">12</span><span class="o">^^^^^^|</span><span class="mi">69449292212011757621</span><span class="o">|^^^</span><span class="n">ABO</span><span class="o">/</span><span class="n">RhD血型定型试剂卡</span><span class="o">|</span><span class="n">R</span><span class="o">|</span><span class="mi">20230503094655</span><span class="o">||||||||||||||||||</span><span class="n">Across</span><span class="err">□</span><span class="n">Auto</span><span class="err">□</span><span class="n">System</span><span class="err">□</span><span class="n">OCTO</span><span class="o">-</span><span class="n">M</span><span class="o">^^</span><span class="mf">1.00</span><span class="o">.</span><span class="mi">25</span><span class="err">□</span><span class="p">(</span><span class="n">build17062603</span><span class="p">)</span><span class="o">|</span><span class="n">C</span><span class="o">|</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="n">R</span><span class="o">|</span><span class="mi">1</span><span class="o">|^^^</span><span class="n">ABO</span><span class="o">/</span><span class="n">RhD血型定型试剂卡</span><span class="o">|-</span><span class="n">A</span><span class="o">=-^-</span><span class="n">B</span><span class="o">=</span><span class="mi">4</span><span class="o">+^-</span><span class="n">D</span><span class="o">=</span><span class="mi">3</span><span class="o">+^</span><span class="n">control</span><span class="o">=-^</span><span class="n">Ac</span><span class="o">=</span><span class="mi">3</span><span class="o">+^</span><span class="n">Bc</span><span class="o">=-^</span><span class="n">B</span><span class="o">/</span><span class="n">Rh</span><span class="o">+|||</span><span class="n">N</span><span class="o">||</span><span class="n">F</span><span class="o">||</span><span class="n">A1</span><span class="o">|</span><span class="mi">20230503091546</span><span class="o">|</span><span class="mi">20230503094655</span><span class="o">|</span><span class="n">Across</span><span class="err">□</span><span class="n">Auto</span><span class="err">□</span><span class="n">System</span><span class="err">□</span><span class="n">OCTO</span><span class="o">-</span><span class="n">M</span><span class="o">^^</span><span class="mf">1.00</span><span class="o">.</span><span class="mi">25</span><span class="err">□</span><span class="p">(</span><span class="n">build17062603</span><span class="p">)</span><span class="o">|</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="n">L</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">N</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">H</span><span class="o">|</span>\<span class="o">^&amp;|||</span><span class="n">Across</span><span class="err">□</span><span class="n">Auto</span><span class="err">□</span><span class="n">System</span><span class="err">□</span><span class="n">OCTO</span><span class="o">-</span><span class="n">M</span><span class="o">^^</span><span class="mf">1.00</span><span class="o">.</span><span class="mi">25</span><span class="err">□</span><span class="p">(</span><span class="n">build17062603</span><span class="p">)</span><span class="o">|||||||</span><span class="n">P</span><span class="o">|</span><span class="mi">4</span><span class="o">|</span><span class="mi">20230602161519</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="n">P</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="mi">102</span><span class="o">|</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="n">O</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="mi">102</span><span class="o">^^^^^^|</span><span class="mi">69449292211011587452</span><span class="o">|^^^</span><span class="err">抗人球蛋白检测卡</span><span class="p">(</span><span class="err">抗筛</span><span class="p">)</span><span class="o">|</span><span class="n">R</span><span class="o">|</span><span class="mi">20230602094910</span><span class="o">||||||||||||||||||</span><span class="n">Across</span><span class="err">□</span><span class="n">Auto</span><span class="err">□</span><span class="n">System</span><span class="err">□</span><span class="n">OCTO</span><span class="o">-</span><span class="n">M</span><span class="o">^^</span><span class="mf">1.00</span><span class="o">.</span><span class="mi">25</span><span class="err">□</span><span class="p">(</span><span class="n">build17062603</span><span class="p">)</span><span class="o">|</span><span class="n">F</span><span class="o">|</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="n">R</span><span class="o">|</span><span class="mi">1</span><span class="o">|^^^</span><span class="err">抗人球蛋白检测卡</span><span class="p">(</span><span class="err">抗筛</span><span class="p">)</span><span class="o">|</span><span class="n">IgG</span><span class="o">=-^</span><span class="n">C3d</span><span class="o">=-^</span><span class="n">Ctl</span><span class="o">=-^-|||</span><span class="n">N</span><span class="o">||</span><span class="n">F</span><span class="o">||</span><span class="n">A1</span><span class="o">|</span><span class="mi">20230602091802</span><span class="o">|</span><span class="mi">20230602094910</span><span class="o">|</span><span class="n">Across</span><span class="err">□</span><span class="n">Auto</span><span class="err">□</span><span class="n">System</span><span class="err">□</span><span class="n">OCTO</span><span class="o">-</span><span class="n">M</span><span class="o">^^</span><span class="mf">1.00</span><span class="o">.</span><span class="mi">25</span><span class="err">□</span><span class="p">(</span><span class="n">build17062603</span><span class="p">)</span><span class="o">|</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="n">L</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="n">N</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(MI.MIFAigel300).fileMTHD(28,&#34;H|\^&amp;|||Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|||||||P|4|20230503095046[13][10]P|1|12|[13][10]O|1|12^^^^^^|69449292212011757621|^^^ABO/RhD血型定型试剂卡|R|20230503094655||||||||||||||||||Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|C|[13][10]R|1|^^^ABO/RhD血型定型试剂卡|-A=-^-B=4+^-D=3+^control=-^Ac=3+^Bc=-^B/Rh+|||N||F||A1|20230503091546|20230503094655|Across□Auto□System□OCTO-M^^1.00.25□(build17062603)|[13][10]L|1|N[13][10]&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">fileMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(record) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">P3</span><span class="s1">&#39;[&#34;Import&#34; d Result</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">d</span> <span class="n">Upload</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Upload</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AllEpis</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;[13][10]&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">rec</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;[13][10]&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">rtype</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="n">rtype</span><span class="o">=</span><span class="s2">&#34;H&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">ASTMH</span><span class="o">=</span><span class="n">rec</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">ASTMH</span><span class="p">,</span><span class="s2">&#34;ASTMH&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="o">^</span><span class="n">LISAigel400</span><span class="p">(</span><span class="s2">&#34;DATA&#34;</span><span class="p">)</span><span class="o">=</span><span class="n">ASTMH</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">rtype</span><span class="o">=</span><span class="s2">&#34;Q&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(AllEpis) s AllEpis=epis</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">e</span>  <span class="n">s</span> <span class="n">AllEpis</span><span class="o">=</span><span class="n">AllEpis_</span><span class="s2">&#34;^&#34;</span><span class="n">_epis</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AllEpis</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="o">^</span><span class="n">LISAigel400</span><span class="p">(</span><span class="s2">&#34;Epis&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">AllEpis</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">AllEpis</span><span class="p">,</span><span class="s2">&#34;AllEpis&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="o">^</span><span class="n">LISAigel400</span><span class="p">(</span><span class="s2">&#34;OutFlag&#34;</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">d</span> <span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,&#34;9000000256&#34;,&#34;X&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Result</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;[13][10]&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">rec</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;[13][10]&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">rtype</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="n">rtype</span><span class="o">=</span><span class="s2">&#34;O&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="n">rtype</span><span class="o">=</span><span class="s2">&#34;R&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">TestSet</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">TestSet</span><span class="p">[</span><span class="s2">&#34;ABO&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">allres</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">code1</span><span class="o">=</span><span class="s2">&#34;ABO&#34;</span> <span class="n">s</span> <span class="n">res1</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">allres</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;型&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">code2</span><span class="o">=</span><span class="s2">&#34;Rh&#34;</span> <span class="n">s</span> <span class="n">res2</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">allres</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="n">res2</span><span class="p">[</span><span class="s2">&#34;+&#34;</span> <span class="n">s</span> <span class="n">res2</span><span class="o">=</span><span class="s2">&#34;阳性&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="n">res2</span><span class="p">[</span><span class="s2">&#34;-&#34;</span> <span class="n">s</span> <span class="n">res2</span><span class="o">=</span><span class="s2">&#34;阴性&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">code1_</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">_res1_&#34;</span><span class="p">,</span><span class="s2">&#34;_code2_&#34;</span>\<span class="s2">&#34;_res2_&#34;</span><span class="p">,</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">TestSet</span><span class="p">[</span><span class="s2">&#34;交叉配血&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">code1</span><span class="o">=</span><span class="s2">&#34;JCPX&#34;</span> <span class="n">s</span> <span class="n">res1</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="n">res1</span><span class="o">=</span><span class="s2">&#34;+&#34;</span> <span class="n">s</span> <span class="n">res1</span><span class="o">=</span><span class="s2">&#34;阳性&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="n">res1</span><span class="o">=</span><span class="s2">&#34;-&#34;</span> <span class="n">s</span> <span class="n">res1</span><span class="o">=</span><span class="s2">&#34;阴性&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">code1_</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">_res1_&#34;</span><span class="p">,</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">TestSet</span><span class="p">[</span><span class="s2">&#34;不规则抗体筛查&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">code1</span><span class="o">=</span><span class="s2">&#34;KRQDB&#34;</span> <span class="n">s</span> <span class="n">res1</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="n">res1</span><span class="p">[</span><span class="s2">&#34;=&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">....</span><span class="n">s</span> <span class="n">res1</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span><span class="s2">&#34;=&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="n">res1</span><span class="o">=</span><span class="s2">&#34;+&#34;</span> <span class="n">s</span> <span class="n">res1</span><span class="o">=</span><span class="s2">&#34;阳性&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="n">res1</span><span class="o">=</span><span class="s2">&#34;-&#34;</span> <span class="n">s</span> <span class="n">res1</span><span class="o">=</span><span class="s2">&#34;阴性&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">code1_</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">_res1_&#34;</span><span class="p">,</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_result</span><span class="p">,</span><span class="s2">&#34;AllResult&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">d</span> <span class="c1">##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveImageMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">ImageClass</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FullName</span><span class="p">,</span> <span class="n">SaveImageRetName</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">通过</span><span class="n">OtherPara配置取图的在这里通过epis和ImageClass的图片名字提取出流水号和图片类别</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ImageClass</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ImageClass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FileName</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FullName</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">FullName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SaveImageRetName</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">SaveImageRetName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="c1">##Class(MI.Common.MIFBase).Trace(mi,epis_&#34;:&#34;_ImageClass_&#34;:&#34;_FileName,&#34;H&lt;--M&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span> <span class="n">ImageOrder</span><span class="p">,</span> <span class="n">Caption</span><span class="p">,</span> <span class="n">DisplayRatio</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">加上当前时间，防止浏览器缓存</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FileName</span><span class="o">=</span><span class="n">FileName_</span><span class="s2">&#34;?&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">OtherPara用</span><span class="o">^</span><span class="err">分隔第四位指定</span><span class="n">SaveImageRetName的话在这里改FileName为新名称</span><span class="err">。同时让方法返回新图片名字</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">NewFileName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">SaveImageRetName</span><span class="o">=</span><span class="s2">&#34;SaveImageRetName&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.//</span><span class="err">图片新名字</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">NewFileName</span><span class="o">=</span><span class="n">epis_</span><span class="s2">&#34;-&#34;</span><span class="n">_ImageClass_</span><span class="s2">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.//</span><span class="err">路径新名字</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">NewPathName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">SPLen</span><span class="o">=$</span><span class="n">l</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">f</span> <span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">SPLen</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">ii</span><span class="o">&lt;</span><span class="n">SPLen</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">NewPathName</span><span class="o">=</span><span class="n">NewPathName_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="n">ii</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;/&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">ii</span><span class="o">=</span><span class="n">SPLen</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">NewFileName</span><span class="o">=</span><span class="n">NewFileName_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="n">ii</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">NewPathName</span><span class="o">=</span><span class="n">NewPathName_NewFileName</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">FileName</span><span class="o">=</span><span class="n">NewPathName</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">最后返回</span><span class="n">NewFileName</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">返回值控制图片名称模式</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">SaveImageRetName</span><span class="o">=</span><span class="s2">&#34;SaveImageRetName&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">NewFileName</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">w</span> <span class="c1">##class(MI.XN9000).GetFtpMTHD(&#34;7&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetFtpMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">文件服务模式必须改的地方，老的</span><span class="n">FTP模式这么改了也没问题</span><span class="err">，所以建议都这样</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="c1">##Class(MI.Common.MIFBase).GetMiFtpPath(mi)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Creator</span><span class="err">：</span>      <span class="err">查询患者信息，监听配置上传前处理类后会定时调用这个</span><span class="n">query查询数据进行上传操作</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">CreatDate</span><span class="err">：</span>    <span class="mi">20140919</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="p">:</span><span class="err">：</span> 
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>    
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="n">mi</span><span class="err">：仪器主键</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Others</span><span class="err">：</span>   
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">QryLabInfo</span><span class="p">(</span><span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Query</span><span class="p">(</span><span class="n">ROWSPEC</span> <span class="o">=</span> <span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Query的执行方法</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(%ResultSet).RunQuery(&#34;MI.MIFAigel400&#34;,&#34;QryLabInfo&#34;,&#34;41&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoExecute</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">i</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">flag</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">LabnoList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">DeleteFlag</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">LISAigel400</span><span class="p">(</span><span class="s2">&#34;Epis&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">DeleteFlag</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">b</span> <span class="p">;</span><span class="n">MiUploadDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">LISAigel400</span><span class="p">(</span><span class="s2">&#34;Epis&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="p">;</span><span class="n">s</span> <span class="n">EpisNo</span><span class="o">=$$</span><span class="n">getEpis</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="p">;</span><span class="n">i</span> <span class="s1">&#39;$l(EpisNo) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">.//</span><span class="err">测试类型</span><span class="mi">0</span><span class="err">：文本，</span><span class="mi">1</span><span class="err">：数据库</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">文本双向上传开始</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&#34;L&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.txt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&#34;Servers.dat&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno1</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno1,0,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">文本双向上传结束</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">DeleteFlag</span><span class="o">=</span><span class="mi">1</span> <span class="n">k</span> <span class="o">^</span><span class="n">LISAigel400</span><span class="p">(</span><span class="s2">&#34;Epis&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ColFields</span><span class="o">=</span><span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span><span class="o">=</span><span class="c1">##Class(LIS.Util.Common).TransListNull(Data,ColFields)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">quit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoClose</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Kill</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoFetch</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">Row</span> <span class="n">As</span> <span class="o">%</span><span class="n">List</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">AtEnd</span> <span class="n">As</span> <span class="o">%</span><span class="n">Integer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">If</span> <span class="n">ind</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Else</span>      <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">AtEnd</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFAigel400).GetLabnoInfo(41,&#34;9000000256^9000000258&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;labno&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ASTMH</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">LISAigel400</span><span class="p">(</span><span class="s2">&#34;DATA&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">ASTMP</span><span class="p">,</span><span class="n">ASTMO</span><span class="p">,</span><span class="n">ASTMPO</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">labnoi</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTMP</span><span class="o">=</span><span class="s2">&#34;P|1|&#34;</span><span class="n">_labnoi_</span><span class="s2">&#34;|&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTMO</span><span class="o">=$$</span><span class="n">GetASTMO</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTMPO</span><span class="o">=</span><span class="n">ASTMPO_ASTMP_</span><span class="s2">&#34;[13]&#34;</span><span class="n">_ASTMO_</span><span class="s2">&#34;[13]&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ASTML</span><span class="o">=</span><span class="s2">&#34;L|1|N&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ASTMP</span><span class="p">,</span><span class="n">ASTMO</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">ASTMH_</span><span class="s2">&#34;[13]&#34;</span><span class="n">_ASTMPO_ASTML</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">tcx</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">GetASTMO</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">VisitNumber</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">VisitNumber</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">获取项目通道号</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">VisitNumber</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ASTMO</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Num</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">VisitNumber</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">Num</span><span class="o">=</span><span class="n">Num</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&#34;O|&#34;</span><span class="n">_Num_</span><span class="s2">&#34;|&#34;</span><span class="n">_VisitNumber_</span><span class="s2">&#34;^&#34;</span><span class="n">_PatName_</span><span class="s2">&#34;^^^^|||^^^^&#34;</span><span class="n">_chl</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(ASTMO) s ASTMO=str</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">e</span>  <span class="n">s</span> <span class="n">ASTMO</span><span class="o">=</span><span class="n">ASTMO_</span><span class="s2">&#34;[13]&#34;</span><span class="n">_str</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">ASTMO</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFKRD).GetLabnoInfo(22,&#34;9000000253&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetLabnoInfoBak</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">OutFlag</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">LISAigel400</span><span class="p">(</span><span class="s2">&#34;OutFlag&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">OutFlag</span><span class="o">=</span><span class="mi">1</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTMH</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">LISAigel400</span><span class="p">(</span><span class="s2">&#34;DATA&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTMP</span><span class="o">=</span><span class="s2">&#34;P|1|001&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTMO1</span><span class="o">=</span><span class="s2">&#34;O|1|001^测试^^^^|||^^^^ABO/RhD血型抗原检测卡&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTMO2</span><span class="o">=</span><span class="s2">&#34;O|2|001^测试^^^^|||^^^^ABO正反定型及Rh(D/C/E)血型检测卡&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTMO3</span><span class="o">=</span><span class="s2">&#34;O|3|001^测试^^^^|||^^^^抗人球蛋白检测卡(IgG+C3d)不规则抗体筛查&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTMO4</span><span class="o">=</span><span class="s2">&#34;O|1|001^测试^^^^|||^^^^O|4|001^测试^^^^|||^^^^抗人球蛋白检测卡(抗IgG+C3d)交叉配血&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTMO5</span><span class="o">=</span><span class="s2">&#34;O|1|001^测试^^^^|||^^^^Rh血型抗原检测卡&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ASTML</span><span class="o">=</span><span class="s2">&#34;L|1|N&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">ASTMH_</span><span class="s2">&#34;[13]&#34;</span><span class="n">_ASTMP_</span><span class="s2">&#34;[13]&#34;</span><span class="n">_ASTMO1_</span><span class="s2">&#34;[13]&#34;</span><span class="n">_ASTMO2_</span><span class="s2">&#34;[13]&#34;</span><span class="n">_ASTMO3_</span><span class="s2">&#34;[13]&#34;</span><span class="n">_ASTMO4_</span><span class="s2">&#34;[13]&#34;</span><span class="n">_ASTMO5_</span><span class="s2">&#34;[13]&#34;</span><span class="n">_ASTML</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">tcx</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">获取项目通道号</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_chl_</span><span class="s2">&#34;[9]&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;[9]&#34;</span><span class="n">_str</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">tcx</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFLISMonitorTest).GetPatInfo(6,1001367)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">labno</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">标本信息</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RPVisitNumberData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">LocationDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">),</span><span class="n">Location</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Location</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">DoctorDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">Doctor</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Doctor</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDoctorD</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveUserDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">68</span><span class="p">),</span><span class="n">ReceiveUser</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">ReceiveUser</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">SYSUserD</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RegNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SurName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">GivenName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">SurName</span><span class="o">=</span><span class="n">GivenName</span> <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName_GivenName</span>  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SpeciesDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span><span class="n">Species</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AdmTypeDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">AdmType</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AdmType</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAdmissionTypeD</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AgeUnitDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span><span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAgeUnitD</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">CollectDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">51</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">CollectTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Diagnose</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampleda</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Instrument</span> <span class="o">=</span> <span class="s2">&#34;XN&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">s</span> <span class="n">Instrument</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampleno</span><span class="o">=</span><span class="n">labno</span>   <span class="o">//</span><span class="err">检测号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampletype</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Feetype</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">;</span><span class="err">费别</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Srcdepno</span><span class="o">=</span><span class="n">Location</span>  <span class="p">;</span><span class="err">送检科室</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Srcdocno</span><span class="o">=</span><span class="n">Doctor</span>   <span class="p">;</span><span class="err">送检医生</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Userno</span><span class="o">=</span><span class="n">ReceiveUser</span> <span class="p">;</span><span class="err">检验医生</span><span class="p">(</span><span class="err">录入者</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patno</span><span class="o">=</span><span class="n">RegNo</span> <span class="p">;</span><span class="err">登记号</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">BarCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patna</span><span class="o">=</span><span class="n">PatName</span>   <span class="p">;</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="mi">1</span>  <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;男&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>     <span class="p">;</span><span class="mi">1</span><span class="p">:</span><span class="err">男</span> <span class="err">，</span><span class="mi">2</span> <span class="err">女</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">Species</span> <span class="o">=</span><span class="s2">&#34;女&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Pattype</span><span class="o">=</span><span class="n">AdmType</span>   <span class="p">;</span><span class="err">病人类型</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Bedno</span> <span class="o">=</span> <span class="n">BedNo</span>    <span class="p">;</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patage</span><span class="o">=</span><span class="n">Age</span>  <span class="p">;</span><span class="err">年龄</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Ageunit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">年龄单位</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reqno</span><span class="o">=</span><span class="n">labno</span>  <span class="p">;</span><span class="err">申请号</span> <span class="o">=</span> <span class="err">检验号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reqda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Reqda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">ReceiveTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span><span class="err">送检日期</span> <span class="o">=</span> <span class="err">接收时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reportda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">报告日期</span>  <span class="o">=</span> <span class="err">初审</span><span class="p">(</span><span class="err">保存结果</span><span class="p">)</span><span class="err">时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Printflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">打印标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Resultflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">结果标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Errflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">错误标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Diagnose</span> <span class="o">=</span> <span class="n">Diagnose</span>   <span class="p">;</span><span class="err">诊断</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Description</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">备注</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reserve</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">保留字段</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patnamn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">姓名拼音码</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Getda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">CollectTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">s</span> <span class="n">Getda</span><span class="o">=</span><span class="n">Reqda</span> <span class="p">;</span><span class="err">接收时间</span><span class="o">/</span><span class="err">采样日期</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Wardno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">病区</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">Sampleda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Instrument_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampleno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampletype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Feetype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdepno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdocno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Userno_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patna_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sex_</span><span class="s2">&#34;,&#34;</span><span class="n">_Pattype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Bedno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patage_</span><span class="s2">&#34;,&#34;</span><span class="n">_Ageunit_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqda_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Reportda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Printflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Resultflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Errflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Diagnose_</span><span class="s2">&#34;,&#34;</span><span class="n">_Description_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reserve_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patnamn_</span><span class="s2">&#34;,&#34;</span><span class="n">_Getda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Wardno_</span><span class="s2">&#34;,&#34;</span><span class="n">_BarCode</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">RetString</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">监听做上传操作后调用改方法设置标本上传表状态</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveSDFMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">epis</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="n">filename</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="私有协议接口双向">私有协议接口双向
</h3><h4 id="类-astm-双向回复-ack">类 ASTM 双向回复 ACK
</h4><h5 id="示例接口万泰-wan200">示例接口(万泰 Wan200)
</h5><blockquote>
<p>W1N1111222222222222222200334S555555556666abcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghij 2 1141123</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">MIFCARIS200BI(mi)
</span></span><span class="line"><span class="cl"> 	s mi=$g(mi) 
</span></span><span class="line"><span class="cl">	S ^TMPMACH10(mi,104)=$H
</span></span><span class="line"><span class="cl">	i &#39;$l(mi) q
</span></span><span class="line"><span class="cl">	s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符
</span></span><span class="line"><span class="cl">	s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符
</span></span><span class="line"><span class="cl">	s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符
</span></span><span class="line"><span class="cl">	s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符
</span></span><span class="line"><span class="cl">	s Port=&#34;|TCP|&#34;_$li(^dbo.BTMIMachineParameterD(mi),17)  //端口号
</span></span><span class="line"><span class="cl">	//控制字符
</span></span><span class="line"><span class="cl">	SET $ZTRAP=&#34;ErrHandler&#34;
</span></span><span class="line"><span class="cl">	S iERR=0
</span></span><span class="line"><span class="cl">	s stx=$c(2),etx=$c(3),ack=$c(6),enq=$c(5),eot=$c(4)
</span></span><span class="line"><span class="cl">	s lf=$c(10),cr=$c(13),nak=$c(21),(result,epis)=&#34;&#34;,etb=$c(23)
</span></span><span class="line"><span class="cl">	S ^TMPMACH10(mi,102)=$H
</span></span><span class="line"><span class="cl">	i $$Start^MI.MIF000(mi) q
</span></span><span class="line"><span class="cl">	f  d Main i $$Stop^MI.MIF000(mi) q
</span></span><span class="line"><span class="cl">  	c Port
</span></span><span class="line"><span class="cl">  	q
</span></span><span class="line"><span class="cl">ErrHandler
</span></span><span class="line"><span class="cl">	h 10
</span></span><span class="line"><span class="cl">	d Trace^MI.MIF000(mi,$TR($ZERROR,&#34;^&#34;,&#34;--&#34;)_&#34;.错误代码:&#34;_$ECODE,&#34;Runtime Error&#34;)
</span></span><span class="line"><span class="cl">	s iERR=+$g(iERR)+1
</span></span><span class="line"><span class="cl">	i iERR&gt;30 s ret=$$Stop^MI.MIF000(mi)
</span></span><span class="line"><span class="cl">    Q
</span></span><span class="line"><span class="cl">Main 
</span></span><span class="line"><span class="cl"> r *R:10 e  d  q
</span></span><span class="line"><span class="cl"> .d BUILD
</span></span><span class="line"><span class="cl"> i $c(R)=enq d
</span></span><span class="line"><span class="cl"> .s record1=&#34;&#34;
</span></span><span class="line"><span class="cl"> .d Trace^MI.MIF000(mi,&#34;ENQ&#34;,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl"> .d ACK
</span></span><span class="line"><span class="cl"> .f  r *R:10 q:$c(R)=eot  d
</span></span><span class="line"><span class="cl"> ..i $c(R)&#39;=stx q
</span></span><span class="line"><span class="cl"> ..s record=$$Read^MI.MIF000(mi,&#34;&#34;,etx) q:&#39;$l(record)
</span></span><span class="line"><span class="cl"> ..d Trace^MI.MIF000(mi,record,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl"> ..d ACK
</span></span><span class="line"><span class="cl"> ..s (sample,epis,surname,result,date,time,QC)=&#34;&#34;
</span></span><span class="line"><span class="cl"> ..//&#34;D1N15    15             xx500015S        1                                                                                     1 3975631111.05                              12016121020170223165831&#34;_$C(3)
</span></span><span class="line"><span class="cl"> ..s Type=$e(record,1)
</span></span><span class="line"><span class="cl"> ..//请求
</span></span><span class="line"><span class="cl"> ..i Type=&#34;R&#34; d  q
</span></span><span class="line"><span class="cl"> ...s epis=$tr($e(record,4,19),&#34; &#34;)
</span></span><span class="line"><span class="cl"> ...i $l(epis) s ^TMP($zn,$j,&#34;ENQ&#34;,epis)=record
</span></span><span class="line"><span class="cl"> ..//结果   D1N7008□□11□□□□□□□□□□□□□□□800383S□□□□□□□□1□□□T□□□□□
</span></span><span class="line"><span class="cl"> ..//       D1N7001□□□1□□□□□□900023407700382S□□□□□□□□1□□□N□□□□□□□□□□□□□
</span></span><span class="line"><span class="cl"> ..i Type=&#34;D&#34; d  q
</span></span><span class="line"><span class="cl"> ...s ResultType=$e(record,3)
</span></span><span class="line"><span class="cl"> ...i ResultType=&#34;C&#34; d
</span></span><span class="line"><span class="cl"> ....s epis=$tr($e(record,8,16),&#34; &#34;)
</span></span><span class="line"><span class="cl"> ...e  d
</span></span><span class="line"><span class="cl"> ....s epis=$tr($e(record,17,27),&#34; &#34;)
</span></span><span class="line"><span class="cl"> ...s code=$tr($e(record,126,128),&#34; &#34;)
</span></span><span class="line"><span class="cl"> ...i code=28 s code=$tr($e(record,45,46),&#34; &#34;)_code
</span></span><span class="line"><span class="cl"> ...s res=$tr($e(record,137,142),&#34; &#34;)
</span></span><span class="line"><span class="cl"> ...;try{s res1=##class(MI.Special.JudgeResult).IsYang(mi,epis,code,res)}catch{s res1=&#34;&#34;}
</span></span><span class="line"><span class="cl"> ...s PoliceInfo=$e(record,157,172)
</span></span><span class="line"><span class="cl"> ...try{s ret=$$GetPolice(PoliceInfo)}catch{}
</span></span><span class="line"><span class="cl"> ...s resFuHao=&#34;&#34;
</span></span><span class="line"><span class="cl"> ...i $d(^LISCaris200(&#34;Data&#34;,43)) s resFuHao=&#34;&lt;&#34;
</span></span><span class="line"><span class="cl"> ...i $d(^LISCaris200(&#34;Data&#34;,42)) s resFuHao=&#34;&gt;&#34;
</span></span><span class="line"><span class="cl"> ...k ^LISCaris200(&#34;Data&#34;)
</span></span><span class="line"><span class="cl"> ...i $l(resFuHao) s res=resFuHao_res
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> ...i $l(code),$l(res) s result=result_code_$c(92)_res_$c(92)_res1_$c(44)
</span></span><span class="line"><span class="cl"> ...d Trace^MI.MIF000(mi,epis_&#34;$$&#34;_result,&#34;Result&#34;)
</span></span><span class="line"><span class="cl"> ...i $l(epis),$l(result) d Save^MI.MIF000(mi,epis,result,date,time,QC)
</span></span><span class="line"><span class="cl"> .d Trace^MI.MIF000(mi,$s($c(R)=eot:&#34;EOT&#34;,1:R),&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl"> .d BUILD
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> q
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">GetPolice(PoliceInfo)
</span></span><span class="line"><span class="cl">	s str=$$scale(PoliceInfo,&#34;16&#34;,&#34;2&#34;)
</span></span><span class="line"><span class="cl">	k ^LISCaris200(&#34;Data&#34;)
</span></span><span class="line"><span class="cl">	s strLong=$l(str)
</span></span><span class="line"><span class="cl">	f i=1:1:strLong d
</span></span><span class="line"><span class="cl">	.s stri=$e(str,i)
</span></span><span class="line"><span class="cl">	.i stri=1 d
</span></span><span class="line"><span class="cl">	..s ^LISCaris200(&#34;Data&#34;,strLong+1-i)=1
</span></span><span class="line"><span class="cl">	q &#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/// 进制转换，将snum从scale1进制转换为scale2进制
</span></span><span class="line"><span class="cl">scale(snum, scale1, scale2)
</span></span><span class="line"><span class="cl">	// 转十进制
</span></span><span class="line"><span class="cl">	s snum=$g(snum)
</span></span><span class="line"><span class="cl">	s tnum=0
</span></span><span class="line"><span class="cl">	s numlong=$l(snum)
</span></span><span class="line"><span class="cl">	f i=1:1:$L(snum) d
</span></span><span class="line"><span class="cl">	.s numi=$e(snum,i)
</span></span><span class="line"><span class="cl">	.s numi=$$Sixteen2Ten(numi)
</span></span><span class="line"><span class="cl">	.s tnum=tnum+(numi*(scale1**(numlong-i)))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	// 转scale2进制
</span></span><span class="line"><span class="cl">	s tnum=$g(tnum)
</span></span><span class="line"><span class="cl">	s num=&#34;&#34;
</span></span><span class="line"><span class="cl">	s GoTo=1
</span></span><span class="line"><span class="cl">	while (GoTo=1){ 
</span></span><span class="line"><span class="cl">		s pnum1=tnum
</span></span><span class="line"><span class="cl">		s tnum=$p(tnum/scale2,&#34;.&#34;,1)
</span></span><span class="line"><span class="cl">		s pnum2=pnum1#scale2
</span></span><span class="line"><span class="cl">		s pnum2=$$Ten2Sixteen(pnum2)
</span></span><span class="line"><span class="cl">		i tnum&lt;scale2 d
</span></span><span class="line"><span class="cl">		.s num=tnum_pnum2_num
</span></span><span class="line"><span class="cl">		.s GoTo=0
</span></span><span class="line"><span class="cl">		e  s num=pnum2_num
</span></span><span class="line"><span class="cl">		if (tnum=0)||&#39;$l(tnum) s GoTo=0
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	q num
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Ten2Sixteen(pnum2)
</span></span><span class="line"><span class="cl">	i pnum2=10 s pnum2=&#34;A&#34;
</span></span><span class="line"><span class="cl">	i pnum2=11 s pnum2=&#34;B&#34;
</span></span><span class="line"><span class="cl">	i pnum2=12 s pnum2=&#34;C&#34;
</span></span><span class="line"><span class="cl">	i pnum2=13 s pnum2=&#34;D&#34;
</span></span><span class="line"><span class="cl">	i pnum2=14 s pnum2=&#34;E&#34;
</span></span><span class="line"><span class="cl">	i pnum2=15 s pnum2=&#34;F&#34;
</span></span><span class="line"><span class="cl">	q pnum2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Sixteen2Ten(numi)
</span></span><span class="line"><span class="cl">	i (numi=&#34;A&#34;)||(numi=&#34;a&#34;) s numi=10
</span></span><span class="line"><span class="cl">	i (numi=&#34;B&#34;)||(numi=&#34;b&#34;) s numi=11
</span></span><span class="line"><span class="cl">	i (numi=&#34;C&#34;)||(numi=&#34;c&#34;) s numi=12
</span></span><span class="line"><span class="cl">	i (numi=&#34;D&#34;)||(numi=&#34;d&#34;) s numi=13
</span></span><span class="line"><span class="cl">	i (numi=&#34;E&#34;)||(numi=&#34;e&#34;) s numi=14
</span></span><span class="line"><span class="cl">	i (numi=&#34;F&#34;)||(numi=&#34;f&#34;) s numi=15
</span></span><span class="line"><span class="cl">	q numi
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  //W1N11112222222222222222aa&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">BUILD  
</span></span><span class="line"><span class="cl">    i &#39;$d(^TMP($zn)) q
</span></span><span class="line"><span class="cl">    i &#39;$d(^TMP($zn,$j)) q 
</span></span><span class="line"><span class="cl">    s labno=&#34;&#34; f  s labno=$o(^TMP($zn,$j,&#34;ENQ&#34;,labno)) q:labno=&#34;&#34;  d
</span></span><span class="line"><span class="cl">    .d ScanOne^MI.MIF000(mi,labno)  
</span></span><span class="line"><span class="cl">    .s tcx=&#34;&#34;,tcNum=0
</span></span><span class="line"><span class="cl">    .s chl=&#34;&#34; f  s chl=$o(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) q:chl=&#34;&#34;  d
</span></span><span class="line"><span class="cl">    ..s AutoDil=1 ///自动稀释倍数
</span></span><span class="line"><span class="cl">    ..i $l(chl)=1 s tcx=tcx_&#34;  &#34;_chl_AutoDil
</span></span><span class="line"><span class="cl">    ..i $l(chl)=2 s tcx=tcx_&#34; &#34;_chl_AutoDil
</span></span><span class="line"><span class="cl">    ..i $l(chl)=3 s tcx=tcx_chl_AutoDil
</span></span><span class="line"><span class="cl">    ..s tcNum=tcNum+1
</span></span><span class="line"><span class="cl">	.//组串
</span></span><span class="line"><span class="cl">    .s tStr=$g(^TMP($zn,$j,&#34;ENQ&#34;,labno))
</span></span><span class="line"><span class="cl">    .s TNUM=$e($p($h,&#34;,&#34;,2),2,5)
</span></span><span class="line"><span class="cl">    .
</span></span><span class="line"><span class="cl">    .//&#34;W1N1111222222222222222200334S555555556666abcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghijabcdefghij 2 1141123&#34;
</span></span><span class="line"><span class="cl">    .s str=&#34;W1N&#34;_TNUM_$e(tStr,4,19)_&#34;     S        1   &#34;
</span></span><span class="line"><span class="cl">    .s Commend=&#34;                                                                                &#34;      
</span></span><span class="line"><span class="cl">    .//i $l(tcNum)=1 s str=str_Commend_&#34; &#34;_tcNum
</span></span><span class="line"><span class="cl">    .//i $l(tcNum)=2 s str=str_Commend_tcNum
</span></span><span class="line"><span class="cl">    .s str=str_Commend_&#34; &#34;_tcNum_tcx
</span></span><span class="line"><span class="cl">    .d Send(str)
</span></span><span class="line"><span class="cl">	k ^TMP($zn,$j,&#34;ENQ&#34;)
</span></span><span class="line"><span class="cl">    q
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Send(str) ; send list of orders if exists
</span></span><span class="line"><span class="cl"> w enq,*-3 d Trace^MI.MIF000(mi,&#34;ENQ&#34;,&#34;H--&gt;M&#34;)
</span></span><span class="line"><span class="cl"> f j=1:1:10 r *R:1 i $c(R)=ack!($c(R)=enq) q
</span></span><span class="line"><span class="cl"> d Trace^MI.MIF000(mi,$s($c(R)=ack:&#34;ACK&#34;,$c(R)=enq:&#34;ENQ&#34;,$c(R)=nak:&#34;NAK&#34;,1:R),&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl"> i $c(R)=enq q
</span></span><span class="line"><span class="cl"> i $c(R)&#39;=ack w eot,*-3 d Trace^MI.MIF000(mi,&#34;EOT&#34;,&#34;H--&gt;M&#34;) q
</span></span><span class="line"><span class="cl"> q:$$SEND(str)
</span></span><span class="line"><span class="cl"> w eot,*-3 d Trace^MI.MIF000(mi,&#34;EOT&#34;,&#34;H--&gt;M&#34;)
</span></span><span class="line"><span class="cl"> q
</span></span><span class="line"><span class="cl">SEND(str) ; send string to instrument
</span></span><span class="line"><span class="cl"> s str=str,chsum=$$CHSUM(str_etx)
</span></span><span class="line"><span class="cl"> w stx,str,etx,chsum,*-3 d Trace^MI.MIF000(mi,str_chsum,&#34;H--&gt;M&#34;)
</span></span><span class="line"><span class="cl"> f j=1:1:6 r *R:1 i ($c(R)=ack)!($c(R)=eot) q
</span></span><span class="line"><span class="cl"> i $c(R)=ack d Trace^MI.MIF000(mi,&#34;ACK&#34;,&#34;H&lt;--M&#34;) q 0
</span></span><span class="line"><span class="cl"> i $c(R)=eot d Trace^MI.MIF000(mi,&#34;EOT&#34;,&#34;H&lt;--M&#34;) q 0
</span></span><span class="line"><span class="cl"> d Trace^MI.MIF000(mi,R,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl"> q 1
</span></span><span class="line"><span class="cl">CHSUM(x) ; calculate check sum
</span></span><span class="line"><span class="cl"> n (x) s z=0 f y=1:1:$l(x) s z=z+$a(x,y)
</span></span><span class="line"><span class="cl"> s z=$zh(z)  //转16进制
</span></span><span class="line"><span class="cl"> i $l(z)=3 s z=&#34;0&#34;_z
</span></span><span class="line"><span class="cl"> q z
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">aa(val)
</span></span><span class="line"><span class="cl">	s ret = &#34;&#34;
</span></span><span class="line"><span class="cl">	f j=1:1:$l(val) d
</span></span><span class="line"><span class="cl">	.s ascii = $a($e(val,j)) 
</span></span><span class="line"><span class="cl">	.if ascii&lt;16 set ret = ret_&#34;0&#34;_$zh(ascii)
</span></span><span class="line"><span class="cl">	.else  set ret = ret_$zh(ascii)
</span></span><span class="line"><span class="cl">	q ret 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ACK ; send &#39;ack&#39; to instrument
</span></span><span class="line"><span class="cl"> w ack,*-3
</span></span><span class="line"><span class="cl"> d Trace^MI.MIF000(mi,&#34;ACK&#34;,&#34;H--&gt;M&#34;)
</span></span><span class="line"><span class="cl"> q
</span></span><span class="line"><span class="cl">NEXTTRAY(tray) 
</span></span><span class="line"><span class="cl"> q tray
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110231540-2sl4pxn.png"
	width="964"
	height="754"
	srcset="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110231540-2sl4pxn_hu_5c1240445ba0fe61.png 480w, /p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110231540-2sl4pxn_hu_fddcd052b501ece7.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="127"
		data-flex-basis="306px"
	
></p>
<p><img src="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110231815-rg5llua.png"
	width="814"
	height="833"
	srcset="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110231815-rg5llua_hu_c41ba47104b4caf9.png 480w, /p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110231815-rg5llua_hu_7f25a3da1f1b02d.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="97"
		data-flex-basis="234px"
	
></p>
<p><img src="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110233605-g55e7du.png"
	width="1034"
	height="1058"
	srcset="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110233605-g55e7du_hu_85544e8f2fde4238.png 480w, /p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110233605-g55e7du_hu_ee40ecb35d5c95bb.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="97"
		data-flex-basis="234px"
	
></p>
<h4 id="安图协议">安图协议
</h4><h5 id="示例接口安图-2000">示例接口(安图 2000)
</h5><blockquote>
<p>{10,0,[S]41,1,0,[S]0,[S]BL07,3,[S]100,1,[S]112,1,[S]113,1}</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">MIFAUTOLUMOA2000(mi)
</span></span><span class="line"><span class="cl">	///仪器名称:	全自动化学发光测定仪
</span></span><span class="line"><span class="cl">	///仪器型号:	A2000 
</span></span><span class="line"><span class="cl">	///仪器厂商:	AutoLumo
</span></span><span class="line"><span class="cl">	///通信协议:	自定义V0.07
</span></span><span class="line"><span class="cl">	///交互方式:	双向
</span></span><span class="line"><span class="cl">	///接    口:	RS232
</span></span><span class="line"><span class="cl">	///编 写 者:	wwh
</span></span><span class="line"><span class="cl">	///编写日期:	2015-11-05
</span></span><span class="line"><span class="cl">	///备    注:	仪器配置:系统设置--&gt;LIS通信设置
</span></span><span class="line"><span class="cl">	///				仪器也可读取文件,文件路径log/LisData/,文件内容与通信协议中一致
</span></span><span class="line"><span class="cl">	///接口版本:	V0.0.1
</span></span><span class="line"><span class="cl">	///更新日志:
</span></span><span class="line"><span class="cl">	///-1.更新日期:
</span></span><span class="line"><span class="cl">	///---更 新 者:
</span></span><span class="line"><span class="cl">	///---更新备注:  
</span></span><span class="line"><span class="cl">	s mi=$g(mi) 
</span></span><span class="line"><span class="cl">	i &#39;$l(mi) q
</span></span><span class="line"><span class="cl">	s ItemDeli=$li(^dbo.BTMIMachineParameterD(mi),12) //项目分隔符
</span></span><span class="line"><span class="cl">	s ResultDeli=$li(^dbo.BTMIMachineParameterD(mi),13) //结果分隔符
</span></span><span class="line"><span class="cl">	s AntDeli=$li(^dbo.BTMIMachineParameterD(mi),14) //抗生素分隔符
</span></span><span class="line"><span class="cl">	s SenDeli=$li(^dbo.BTMIMachineParameterD(mi),15) //药敏结果分隔符
</span></span><span class="line"><span class="cl">	s Port=&#34;|TCP|&#34;_$li(^dbo.BTMIMachineParameterD(mi),10) //端口号
</span></span><span class="line"><span class="cl">	//控制字符
</span></span><span class="line"><span class="cl">    S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23)
</span></span><span class="line"><span class="cl">    S sb=$C(11),eb=$C(28),cr=$C(13)  
</span></span><span class="line"><span class="cl">    S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=&#34;&#34;,kk=1 
</span></span><span class="line"><span class="cl">	s ^TMPMACHDATA1(mi,10)=mi
</span></span><span class="line"><span class="cl">    S leftBrace=&#34;{&#34;,rightBrace=&#34;}&#34;
</span></span><span class="line"><span class="cl">	i $$Start^MI.MIF000(mi) q
</span></span><span class="line"><span class="cl">	f  d Main i $$Stop^MI.MIF000(mi) q
</span></span><span class="line"><span class="cl">	s ^TMPMACH10(mi,50)=$h
</span></span><span class="line"><span class="cl">  	c Port
</span></span><span class="line"><span class="cl">  	q
</span></span><span class="line"><span class="cl">    /*
</span></span><span class="line"><span class="cl">    S mi=$G(mi) 
</span></span><span class="line"><span class="cl">    Q:&#39;$L(mi)
</span></span><span class="line"><span class="cl">    Q:$$select^LVBMIMP(mi)
</span></span><span class="line"><span class="cl">    F j=1:1:PLIST {
</span></span><span class="line"><span class="cl">	    S @(&#34;par&#34;_j)=PLIST(j)
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	S mi1=$P($G(par36),&#34;,&#34;,1)
</span></span><span class="line"><span class="cl">    S stx=$C(2),etx=$C(3),ack=$C(6),enq=$C(5),eot=$C(4),etb=$C(23)
</span></span><span class="line"><span class="cl">    S sb=$C(11),eb=$C(28),cr=$C(13)  
</span></span><span class="line"><span class="cl">    S lf=$C(10),nak=$C(21),(AllRecord,result,epis)=&#34;&#34;,kk=1
</span></span><span class="line"><span class="cl">    S $ZT=&#34;ErrHandler&#34;,$EC=&#34;&#34;
</span></span><span class="line"><span class="cl">    S leftBrace=&#34;{&#34;,rightBrace=&#34;}&#34;
</span></span><span class="line"><span class="cl">    S (sample,epis,surname,rec,res,result,date,time,QC,errFlag,resultType)=&#34;&#34;
</span></span><span class="line"><span class="cl">    Q:$$start^MIF000()
</span></span><span class="line"><span class="cl">	F {
</span></span><span class="line"><span class="cl">		D Main
</span></span><span class="line"><span class="cl">		Q:$$stop^MIF000()
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">    C par4
</span></span><span class="line"><span class="cl">    Q
</span></span><span class="line"><span class="cl">    */
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">Main  
</span></span><span class="line"><span class="cl">    S $ZT=&#34;ErrHandler&#34;,$EC=&#34;&#34;
</span></span><span class="line"><span class="cl">    S record=$$Read^MI.MIF000(mi,leftBrace,rightBrace) 
</span></span><span class="line"><span class="cl">    Q:&#39;$l(record)
</span></span><span class="line"><span class="cl">  	d Trace^MI.MIF000(mi,record,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl">  	S (epis,result,date,time,QC,data)=&#34;&#34;
</span></span><span class="line"><span class="cl">  	S cmd=$P(record,&#34;,&#34;,1)
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  	I cmd=&#34;1&#34; {		//获取指定样本编号和指定病历号的样本详细测试请求数据
</span></span><span class="line"><span class="cl">  		S instrumentId=$P(record,&#34;,&#34;,2)		//系统标识
</span></span><span class="line"><span class="cl">		S:instrumentId[&#34;[S]&#34; instrumentId=$P(instrumentId,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		S sampleId=$P(record,&#34;,&#34;,3)		//测试请求ID
</span></span><span class="line"><span class="cl">		S epis=sampleId
</span></span><span class="line"><span class="cl">		S:epis[&#34;[S]&#34; epis=$P(epis,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		K PLIST
</span></span><span class="line"><span class="cl">	 	S error=$$BuildItems(mi,epis)
</span></span><span class="line"><span class="cl">	 	I $L(error) {
</span></span><span class="line"><span class="cl">			S ack=&#34;{2,1,&#34;_sampleId_&#34;}&#34;
</span></span><span class="line"><span class="cl">			D ACK(mi,ack)
</span></span><span class="line"><span class="cl">			;D trace^MIF000(mi,error,&#34;Error&#34;)
</span></span><span class="line"><span class="cl">			Q
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		S tc=&#34;&#34;,items=&#34;&#34;
</span></span><span class="line"><span class="cl">		F {
</span></span><span class="line"><span class="cl">			S tc=$O(PLIST(tc))
</span></span><span class="line"><span class="cl">			Q:&#39;$L(tc)
</span></span><span class="line"><span class="cl">			S itemDiluFactor=$G(PLIST(tc))
</span></span><span class="line"><span class="cl">			S:&#39;$L(itemDiluFactor) itemDiluFactor=1		//稀释倍数,机器内部稀释,必须在该测试项目的支持范围内
</span></span><span class="line"><span class="cl">			S items=items_&#34;[S]&#34;_tc_&#34;,&#34;_itemDiluFactor_&#34;,&#34;
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		S itemCount=+$G(PLIST)
</span></span><span class="line"><span class="cl">		S items=$E(items,1,$L(items)-1)
</span></span><span class="line"><span class="cl">		S dilutionFactor=1	//稀释倍数
</span></span><span class="line"><span class="cl">		S isEmergency=0		//是否急诊:0=普通,1=急诊
</span></span><span class="line"><span class="cl">		S medicareId=&#34;[S]&#34;	//病案号
</span></span><span class="line"><span class="cl">		S secondName=&#34;[S]&#34;	//姓
</span></span><span class="line"><span class="cl">		S firstName=&#34;[S]&#34;	//名
</span></span><span class="line"><span class="cl">		S sex=&#34;&#34;			//性别 0:女 1:男
</span></span><span class="line"><span class="cl">		S age=&#34;&#34;			//年龄:整数
</span></span><span class="line"><span class="cl">		S location=&#34;[S]&#34;	//科室
</span></span><span class="line"><span class="cl">		S ward=&#34;[S]&#34;		//病区
</span></span><span class="line"><span class="cl">		S bed=&#34;[S]&#34;			//床号
</span></span><span class="line"><span class="cl">		S reqDoctor=&#34;[S]&#34;	//送检医生
</span></span><span class="line"><span class="cl">		S reqDate=&#34;&#34;		//送检日期(格式:YYYY/MM/DD)
</span></span><span class="line"><span class="cl">		S receiveUser=&#34;[S]&#34;	//检验人员
</span></span><span class="line"><span class="cl">		S remark=&#34;[S]&#34;			//备注
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		S ack=&#34;{2,0,&#34;_sampleId_&#34;,&#34;_dilutionFactor_&#34;,&#34;_isEmergency_&#34;,&#34;_medicareId_&#34;,&#34;
</span></span><span class="line"><span class="cl">		S ack=ack_secondName_&#34;,&#34;_firstName_&#34;,&#34;_sex_&#34;,&#34;_age_&#34;,&#34;_location_&#34;,&#34;_ward_&#34;,&#34;
</span></span><span class="line"><span class="cl">		S ack=ack_bed_&#34;,&#34;_reqDoctor_&#34;,&#34;_reqDate_&#34;,&#34;_receiveUser_&#34;,&#34;_remark_&#34;,&#34;
</span></span><span class="line"><span class="cl">		S ack=ack_itemCount_&#34;,&#34;_items_&#34;}&#34;
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		D ACK(mi,ack)
</span></span><span class="line"><span class="cl">		Q 
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	I cmd=&#34;3&#34; {		//获取分配给指定仪器所有患者测试样本的个数
</span></span><span class="line"><span class="cl">		S instrumentId=$P(record,&#34;,&#34;,2)		//系统标识
</span></span><span class="line"><span class="cl">		S:instrumentId[&#34;[S]&#34; instrumentId=$P(instrumentId,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">	 	S sampleTotal=&#34;0&#34;
</span></span><span class="line"><span class="cl">		S ack=&#34;{4,1}&#34;		//暂时不处理
</span></span><span class="line"><span class="cl">		D ACK(mi,ack)
</span></span><span class="line"><span class="cl">		Q 
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	I cmd=&#34;5&#34; {	//按测试模式发送结果到LIS
</span></span><span class="line"><span class="cl">		//{5,[S]A2000,[S]41,[S]132,47925,970200L,183.145F}
</span></span><span class="line"><span class="cl">		S instrumentId=$P(record,&#34;,&#34;,2)		//系统标识
</span></span><span class="line"><span class="cl">		S:instrumentId[&#34;[S]&#34; instrumentId=$P(instrumentId,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		S sampleId=$P(record,&#34;,&#34;,5)		//测试请求ID
</span></span><span class="line"><span class="cl">		S sampleNo=$P(record,&#34;,&#34;,3)		//测试样本编号
</span></span><span class="line"><span class="cl">		S itemId=$P(record,&#34;,&#34;,4)		//测试项目编号
</span></span><span class="line"><span class="cl">		S medicareId=&#34;[S]&#34;				//病案号
</span></span><span class="line"><span class="cl">		//{6,0,47925,[S]41,[S],[S]132}
</span></span><span class="line"><span class="cl">		S ack=&#34;{6,0,&#34;_sampleId_&#34;,&#34;_sampleNo_&#34;,&#34;_medicareId_&#34;,&#34;_itemId_&#34;}&#34;
</span></span><span class="line"><span class="cl">		D ACK(mi,ack)
</span></span><span class="line"><span class="cl">		S epis=sampleNo  //sampleId
</span></span><span class="line"><span class="cl">		S:epis[&#34;[S]&#34; epis=$P(epis,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		// 2017-09-13 WxC 质控标示特殊处理
</span></span><span class="line"><span class="cl">		;I &#34;H1,L1,P1,C1&#34;[epis S epis=&#34;liver1&#34;
</span></span><span class="line"><span class="cl">		;I &#34;H2,L2,P2,C2&#34;[epis S epis=&#34;liver2&#34;
</span></span><span class="line"><span class="cl">		;I &#34;M1,G1&#34;[epis S epis=&#34;HEV1&#34;
</span></span><span class="line"><span class="cl">		;I &#34;M2,G2&#34;[epis S epis=&#34;HEV2&#34;
</span></span><span class="line"><span class="cl">		//
</span></span><span class="line"><span class="cl">		S channel=itemId
</span></span><span class="line"><span class="cl">		S:channel[&#34;[S]&#34; channel=$P(channel,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		S valueL=$P(record,&#34;,&#34;,6)		//RLU((检测结果相对发光值)
</span></span><span class="line"><span class="cl">		S valueL=$P(valueL,&#34;L&#34;,1)
</span></span><span class="line"><span class="cl">		S valueF=$P(record,&#34;,&#34;,7)		//浓度值或S/CO值
</span></span><span class="line"><span class="cl">		S valueF=$P(valueF,&#34;F&#34;,1)
</span></span><span class="line"><span class="cl">		S:valueF[&#34;[S]&#34; valueF=$tr(valueF,&#34;[S]&#34;,&#34;&#34;)
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		Q:&#39;$L(channel)
</span></span><span class="line"><span class="cl">		S result=&#34;&#34;
</span></span><span class="line"><span class="cl">		//S result=result_channel_&#34;-L&#34;_$C(par10)_valueL_$C(par11)
</span></span><span class="line"><span class="cl">		//S result=result_channel_&#34;-F&#34;_$C(par10)_valueF_$C(par11)
</span></span><span class="line"><span class="cl">		S result=result_channel_ResultDeli_valueF_ItemDeli
</span></span><span class="line"><span class="cl">		D Save
</span></span><span class="line"><span class="cl">		Q 
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	I cmd=&#34;7&#34; {	//按样本模式发送结果到LIS
</span></span><span class="line"><span class="cl">		//{7,[S]A2000,101,[S]41,3,[S]132,970200L,183.145F,[S]112,673200L,13.15F,[S]113,1378200L,13.5F
</span></span><span class="line"><span class="cl">		S instrumentId=$P(record,&#34;,&#34;,2)		//系统标识
</span></span><span class="line"><span class="cl">		S:instrumentId[&#34;[S]&#34; instrumentId=$P(instrumentId,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		S sampleId=$P(record,&#34;,&#34;,3)			//样本ID
</span></span><span class="line"><span class="cl">		S sampleNo=$P(record,&#34;,&#34;,4)			//测试样本编号
</span></span><span class="line"><span class="cl">		S itemCount=+$P(record,&#34;,&#34;,5)		//测试样本包含的测试个数
</span></span><span class="line"><span class="cl">		S items=$P(record,&#34;,&#34;,6,$L(record,&#34;,&#34;))
</span></span><span class="line"><span class="cl">		S medicareId=&#34;[S]&#34;					//病案号 
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		//{8,0,101,[S]41,[S]
</span></span><span class="line"><span class="cl">		S ack=&#34;{8,0,&#34;_sampleId_&#34;,&#34;_sampleNo_&#34;,&#34;_medicareId_&#34;}&#34;
</span></span><span class="line"><span class="cl">		D ACK(mi,ack)
</span></span><span class="line"><span class="cl">		S epis=sampleId
</span></span><span class="line"><span class="cl">		S:epis[&#34;[S]&#34; epis=$P(epis,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		// 2017-09-13 WxC 质控标示特殊处理
</span></span><span class="line"><span class="cl">		I &#34;H1,L1,P1,C1&#34;[epis S epis=&#34;liver1&#34;
</span></span><span class="line"><span class="cl">		I &#34;H2,L2,P2,C2&#34;[epis S epis=&#34;liver2&#34;
</span></span><span class="line"><span class="cl">		I &#34;M1,G1&#34;[epis S epis=&#34;HEV1&#34;
</span></span><span class="line"><span class="cl">		I &#34;M2,G2&#34;[epis S epis=&#34;HEV2&#34;
</span></span><span class="line"><span class="cl">		//
</span></span><span class="line"><span class="cl">		S result=&#34;&#34;
</span></span><span class="line"><span class="cl">		F itemIndex=1:3:$L(items,&#34;,&#34;) {
</span></span><span class="line"><span class="cl">			S itemId=$P(items,&#34;,&#34;,itemIndex)	//测试项目编号
</span></span><span class="line"><span class="cl">			S channel=itemId
</span></span><span class="line"><span class="cl">			S:channel[&#34;[S]&#34; channel=$P(channel,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">			Continue:&#39;$L(channel)
</span></span><span class="line"><span class="cl">			S valueL=$P(items,&#34;,&#34;,itemIndex+1)	//RLU((检测结果相对发光值)
</span></span><span class="line"><span class="cl">			S valueL=$P(valueL,&#34;L&#34;,1)
</span></span><span class="line"><span class="cl">			S valueF=$P(items,&#34;,&#34;,itemIndex+2)	//浓度值或S/CO值
</span></span><span class="line"><span class="cl">			S valueF=$P(valueF,&#34;F&#34;,1)
</span></span><span class="line"><span class="cl">			S:valueF[&#34;[S]&#34; valueF=$tr(valueF,&#34;[S]&#34;,&#34;&#34;) 
</span></span><span class="line"><span class="cl">			//S result=result_channel_&#34;-L&#34;_$C(par10)_valueL_$C(par11)
</span></span><span class="line"><span class="cl">			//S result=result_channel_&#34;-F&#34;_$C(par10)_valueF_$C(par11)
</span></span><span class="line"><span class="cl">			S result=result_channel_ResultDeli_valueF_ItemDeli
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		D Save
</span></span><span class="line"><span class="cl">		Q  
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	I cmd=&#34;9&#34; {	//双向  
</span></span><span class="line"><span class="cl">		//{9,[S]A2000,[S]41}
</span></span><span class="line"><span class="cl">		S instrumentId=$P(record,&#34;,&#34;,2)		//系统标识
</span></span><span class="line"><span class="cl">		S:instrumentId[&#34;[S]&#34; instrumentId=$P(instrumentId,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		S sampleId=$P(record,&#34;,&#34;,3)			//样本ID
</span></span><span class="line"><span class="cl">		S epis=sampleId
</span></span><span class="line"><span class="cl">		S:epis[&#34;[S]&#34; epis=$P(epis,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		///2016-04-13 WXC 扫条码转换仪器
</span></span><span class="line"><span class="cl">		///D SetTSMachine^MIF000(mi,epis)
</span></span><span class="line"><span class="cl">  		;s Err=##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(mi,epis,&#34;&#34;) 
</span></span><span class="line"><span class="cl">  		;d Trace^MI.MIF000(mi,Err,&#34;核收到仪器返回&#34;)
</span></span><span class="line"><span class="cl">  		s Err=&#34;&#34;
</span></span><span class="line"><span class="cl">  		s RetLL=$$SaveLastMachine^MI.MIF000(mi,epis)
</span></span><span class="line"><span class="cl">    	d Trace^MI.MIF000(mi,RetLL,&#34;保存最后仪器&#34;)
</span></span><span class="line"><span class="cl">		K PLIST
</span></span><span class="line"><span class="cl">		S error=$$BuildItems(mi,epis)
</span></span><span class="line"><span class="cl">		I $L(error) {
</span></span><span class="line"><span class="cl">			S ack=&#34;{10,1,&#34;_sampleId_&#34;}&#34;
</span></span><span class="line"><span class="cl">			D ACK(mi,ack)
</span></span><span class="line"><span class="cl">			d Trace^MI.MIF000(mi,error,&#34;Error&#34;)
</span></span><span class="line"><span class="cl">			Q
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		S tc=&#34;&#34;,items=&#34;&#34;
</span></span><span class="line"><span class="cl">		F {
</span></span><span class="line"><span class="cl">			S tc=$O(PLIST(tc))
</span></span><span class="line"><span class="cl">			Q:&#39;$L(tc)
</span></span><span class="line"><span class="cl">			S itemDiluFactor=$G(PLIST(tc))
</span></span><span class="line"><span class="cl">			S:&#39;$L(itemDiluFactor) itemDiluFactor=1		//稀释倍数,机器内部稀释,必须在该测试项目的支持范围内
</span></span><span class="line"><span class="cl">			S items=items_&#34;[S]&#34;_tc_&#34;,&#34;_itemDiluFactor_&#34;,&#34;
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		S items=$E(items,1,$L(items)-1)
</span></span><span class="line"><span class="cl">		S dilutionFactor=1						//稀释因子
</span></span><span class="line"><span class="cl">		S isEmergency=0							//是否急诊:0=普通,1=急诊
</span></span><span class="line"><span class="cl">		S specimen=&#34;[S]&#34;_$$GetSpecimen(epis)	//样本类型:字符串,如果仪器不能识别则默认为血清
</span></span><span class="line"><span class="cl">		 
</span></span><span class="line"><span class="cl">		S itemCount=+$G(PLIST)
</span></span><span class="line"><span class="cl">		//{10,0,[S]41,1,0,[S],3,[S]132,1,[S]112,1,[S]113,1}
</span></span><span class="line"><span class="cl">		S ack=&#34;{10,0,[S]&#34;_sampleId_&#34;,&#34;_dilutionFactor_&#34;,&#34;_isEmergency_&#34;,&#34;_specimen_&#34;,&#34;_itemCount_&#34;,&#34;_items_&#34;}&#34;
</span></span><span class="line"><span class="cl">		D Trace^MI.MIF000(mi,ack,&#34;ack&lt;--M&#34;)
</span></span><span class="line"><span class="cl">		D ACK(mi,ack)
</span></span><span class="line"><span class="cl">		Q  
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	I cmd=&#34;11&#34; {	//连接LIS系统开始通信 
</span></span><span class="line"><span class="cl">		S instrumentId=$P(record,&#34;,&#34;,2)		//系统标识
</span></span><span class="line"><span class="cl">		S:instrumentId[&#34;[S]&#34; instrumentId=$P(instrumentId,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		S lisCommVersion=$P(record,&#34;,&#34;,3)		//LIS通信模块版本号
</span></span><span class="line"><span class="cl">		S lisVersion=&#34;[S]V0.0.1&#34;				//LIS系统版本号
</span></span><span class="line"><span class="cl">		S ack=&#34;{12,0,&#34;_lisVersion_&#34;}&#34;
</span></span><span class="line"><span class="cl">		D ACK(mi,ack)
</span></span><span class="line"><span class="cl">		Q  
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	I cmd=&#34;15&#34; {	//快速获取指定样本架编号测试请求数据 
</span></span><span class="line"><span class="cl">		S instrumentId=$P(record,&#34;,&#34;,2)		//系统标识
</span></span><span class="line"><span class="cl">		S:instrumentId[&#34;[S]&#34; instrumentId=$P(instrumentId,&#34;[S]&#34;,2)
</span></span><span class="line"><span class="cl">		S rackId=$P(record,&#34;,&#34;,3)		//样本架编号
</span></span><span class="line"><span class="cl">		S position=$P(record,&#34;,&#34;,4)		//样本位置号
</span></span><span class="line"><span class="cl">		S ack=&#34;{16,1,&#34;_rackId_&#34;,&#34;_position_&#34;0,[S]}&#34;	//不处理此模式
</span></span><span class="line"><span class="cl">		D ACK(mi,ack)
</span></span><span class="line"><span class="cl">		Q  
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">    Q 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ErrHandler
</span></span><span class="line"><span class="cl">    h 10
</span></span><span class="line"><span class="cl">	d Trace^MI.MIF000(mi,$TR($ZERROR,&#34;^&#34;,&#34;--&#34;)_&#34;.错误代码:&#34;_$ECODE,&#34;Runtime Error&#34;)
</span></span><span class="line"><span class="cl">    Q 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GetSpecimen(Labno) n (Labno)
</span></span><span class="line"><span class="cl">  s Labno=$G(Labno)
</span></span><span class="line"><span class="cl">  i &#39;$l(Labno) q &#34;&#34;
</span></span><span class="line"><span class="cl">  s SpecName=&#34;&#34;
</span></span><span class="line"><span class="cl">  s SpecDR=&#34;&#34;
</span></span><span class="line"><span class="cl">  &amp;sql(SELECT SpecimenDR into :SpecDR FROM dbo.RP_VisitNumber WHERE VisitNumber=:Labno)
</span></span><span class="line"><span class="cl">  i SQLCODE q &#34;&#34;
</span></span><span class="line"><span class="cl">  q:SpecDR=&#34;&#34; &#34;&#34;
</span></span><span class="line"><span class="cl">  &amp;sql(select IName into :SpecName from dbo.BT_Specimen where RowID=:SpecDR)
</span></span><span class="line"><span class="cl">  q SpecName
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">	//构建测试项目,返回错误代码
</span></span><span class="line"><span class="cl">BuildItems(mi,epis)
</span></span><span class="line"><span class="cl">	N (mi,epis,PLIST)
</span></span><span class="line"><span class="cl">	K PLIST
</span></span><span class="line"><span class="cl">	S mi=$G(mi),epis=$G(epis)
</span></span><span class="line"><span class="cl">	Q:&#39;$L(mi) &#34;仪器代码为空&#34;
</span></span><span class="line"><span class="cl">	Q:&#39;$L(epis) &#34;标本号为空&#34;
</span></span><span class="line"><span class="cl">	//Q:&#39;$D(^TMIF(mi)) &#34;仪器代码错误&#34;
</span></span><span class="line"><span class="cl">	//Q:&#39;$D(^TEPI(epis)) &#34;在LIS系统未找到样本号:&#34;_epis_&#34;,确定样本号正确或已经在LIS系统接收&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	S error=&#34;&#34;,PLIST=0
</span></span><span class="line"><span class="cl">	K ^TMP(&#34;MIFTESTCODE&#34;,$J,mi,epis)
</span></span><span class="line"><span class="cl">	d ScanOneNew^MI.MIF000(mi,epis)
</span></span><span class="line"><span class="cl">	K PLIST
</span></span><span class="line"><span class="cl">	S tc=&#34;&#34;
</span></span><span class="line"><span class="cl">	F {
</span></span><span class="line"><span class="cl">		S tc=$O(^TMP(&#34;MIFTESTCODE&#34;,$J,mi,epis,tc))
</span></span><span class="line"><span class="cl">		Q:&#39;$L(tc)
</span></span><span class="line"><span class="cl">		S tc=$P(tc,&#34;-&#34;,1)
</span></span><span class="line"><span class="cl">		Continue:&#39;$L(tc)
</span></span><span class="line"><span class="cl">		Continue:$D(PLIST(tc))
</span></span><span class="line"><span class="cl">		S PLIST(tc)=&#34;&#34;
</span></span><span class="line"><span class="cl">		S PLIST=$I(PLIST)
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	Q:+$G(PLIST)&lt;1 &#34;未找到样本号:&#34;_epis_&#34;需要上传的项目,确定样本为登记状态且所开医嘱已经正确维护到仪器&#34;
</span></span><span class="line"><span class="cl">	Q &#34;&#34;
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">ACK(mi,data)
</span></span><span class="line"><span class="cl">	N (mi,data)
</span></span><span class="line"><span class="cl">	S mi=$G(mi),data=$G(data)
</span></span><span class="line"><span class="cl">	Q:&#39;$L(mi) &#34;&#34;
</span></span><span class="line"><span class="cl">	Q:&#39;$L(data) &#34;&#34;
</span></span><span class="line"><span class="cl">	//Q:&#39;$D(^TMIF(mi)) &#34;&#34;
</span></span><span class="line"><span class="cl">	W data,*-3
</span></span><span class="line"><span class="cl">    d Trace^MI.MIF000(mi,data,&#34;H--&gt;M&#34;)
</span></span><span class="line"><span class="cl">	Q &#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Save   
</span></span><span class="line"><span class="cl">	d Trace^MI.MIF000(mi,epis_&#34;$$&#34;_result,&#34;Result&#34;)
</span></span><span class="line"><span class="cl">  	I $l(epis),$l(result) {
</span></span><span class="line"><span class="cl">	  	//S QC=$$findQC^MIF000(mi,epis)
</span></span><span class="line"><span class="cl">  		d Save^MI.MIF000(mi,epis,result,date,time,QC) //file^MIF000(mi,sample,epis,surname,result,date,time,QC,mi1)
</span></span><span class="line"><span class="cl">  	}
</span></span><span class="line"><span class="cl">  	S (epis,rec,res,result,date,time,QC,resultType)=&#34;&#34;
</span></span><span class="line"><span class="cl">  	Q
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110233658-ylcmi5y.png"
	width="710"
	height="665"
	srcset="/p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110233658-ylcmi5y_hu_12c536a0f47a4c56.png 480w, /p/%E5%8F%8C%E5%90%91%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F%E6%95%B4%E5%90%88-676313ec8e/assets/image-20250110233658-ylcmi5y_hu_45edc6bc02b7a0c0.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="106"
		data-flex-basis="256px"
	
></p>
<h2 id="主动上传双向">主动上传双向
</h2><h3 id="通过监听文件双向">通过监听文件双向
</h3><h4 id="不同路径回传患者信息和检测项目信息">不同路径回传患者信息和检测项目信息
</h4><h5 id="示例接口希森美康-xn1000">示例接口(希森美康 XN1000)
</h5><blockquote>
<p>通过配置监听 UPPreDealClass 字段“PreDeal.DealStandSysmexImage,PreDeal“，通过 M 进行编写上传信息，会同时上传两个文件，一个文件传患者信息，一个文件传标本项目。</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span><span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;Drect&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;1000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;D:</span><span class="se">\\</span><span class="s2">Laboman6.0</span><span class="se">\\</span><span class="s2">2&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;D:</span><span class="se">\\</span><span class="s2">Laboman6.0</span><span class="se">\\</span><span class="s2">1&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;D:</span><span class="se">\\</span><span class="s2">Laboman6.0&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFXN1000&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;.CDF&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealStandSysmexImage,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UpPara&#34;</span><span class="p">:</span><span class="s2">&#34;D:</span><span class="se">\\</span><span class="s2">Laboman6.0</span><span class="se">\\</span><span class="s2">1,D:</span><span class="se">\\</span><span class="s2">Laboman6.0&#34;</span><span class="p">,</span><span class="s2">&#34;IsCombineLines&#34;</span><span class="p">:</span><span class="s2">&#34;1&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;Drect&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;1000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;C:</span><span class="se">\\</span><span class="s2">Laboman</span><span class="se">\\</span><span class="s2">2&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;C:</span><span class="se">\\</span><span class="s2">Laboman</span><span class="se">\\</span><span class="s2">1&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;C:</span><span class="se">\\</span><span class="s2">Laboman&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFXN1000&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;.CDF&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealStandSysmexImage,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UpPara&#34;</span><span class="p">:</span><span class="s2">&#34;C:</span><span class="se">\\</span><span class="s2">Laboman</span><span class="se">\\</span><span class="s2">1,C:</span><span class="se">\\</span><span class="s2">Laboman&#34;</span><span class="p">,</span><span class="s2">&#34;IsCombineLines&#34;</span><span class="p">:</span><span class="s2">&#34;1&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">Class</span> <span class="n">MI</span><span class="o">.</span><span class="n">MIFXN1000</span> <span class="n">Extends</span> <span class="o">%</span><span class="n">RegisteredObject</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFLISMonitorTest).fileMTHD(&#34;38&#34;,&#34;1,BASO#,1,0.02,,,,,&#34;,&#34;1&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">mi</span><span class="p">:</span><span class="err">仪器主键</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">record</span><span class="p">:</span><span class="err">一个数据行合并提交用</span><span class="c1">#enter#分割多行数据</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">epis</span><span class="p">:</span><span class="err">流水号，前处理提取出了的画</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">fileNameOrColName</span><span class="p">:</span><span class="err">读文件的是文件全名，数据库的是数据库查询的列名用</span><span class="o">~</span><span class="err">分割</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;Drect&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;3000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;D:</span><span class="se">\\</span><span class="s2">Result</span><span class="se">\\</span><span class="s2">2&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;D:</span><span class="se">\\</span><span class="s2">Result</span><span class="se">\\</span><span class="s2">1&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;D:</span><span class="se">\\</span><span class="s2">Result</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFXEMSYS&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;.cdf&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoMAll,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealImage,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UpPara&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">fileMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">record</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">(</span><span class="n">MAXLEN</span><span class="o">=</span><span class="mi">99999999</span><span class="p">),</span> <span class="n">epis</span><span class="p">,</span> <span class="n">fileNameOrColName</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(record) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">多行数据</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">recordbak</span><span class="o">=</span><span class="n">record</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">返回值</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">retcode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">解析多行合并数据，按</span><span class="c1">#enter#分隔，监听config开启与否合并提交都支持</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">retimage</span><span class="p">,</span><span class="n">imageR</span><span class="p">,</span><span class="n">retimageR</span><span class="p">,</span><span class="n">imageres</span><span class="p">,</span><span class="n">Ipcode</span><span class="p">,</span><span class="n">IpName</span><span class="p">,</span><span class="n">conclusion</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;#enter#&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">S</span> <span class="n">resVal</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;#enter#&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="mi">0</span><span class="p">,</span><span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="n">XS500</span><span class="p">,</span><span class="mi">17944</span><span class="p">,</span><span class="mi">35</span><span class="p">,[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="mi">1</span><span class="p">,</span><span class="n">RDW</span><span class="o">-</span><span class="n">SD</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">41.60</span><span class="p">,,,,,[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="mi">1</span><span class="p">,</span><span class="n">WBC</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">4.15</span><span class="p">,,,,,[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="mi">3</span><span class="p">,,</span><span class="n">HPLT</span><span class="p">,</span><span class="n">C</span><span class="p">:</span>\<span class="n">Laboman4</span><span class="o">.</span><span class="mi">0</span>\<span class="n">XS500</span>\<span class="n">gram</span>\<span class="mi">20201210</span>\<span class="mi">0000000040</span><span class="n">_201210153004_HPLT</span><span class="o">.</span><span class="n">gif</span><span class="p">,</span><span class="mi">1</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">type</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">resVal</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="mi">0</span> <span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">resVal</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="mi">1</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">code</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">resVal</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">res</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">resVal</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_code_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_res_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="mi">3</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">image</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">resVal</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">retimage</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">resVal</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">imageR</span><span class="o">=</span><span class="n">imageR_image_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">retimageR</span><span class="o">=</span><span class="n">retimageR_retimage_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="mi">4</span> <span class="n">d</span>   <span class="o">//</span><span class="err">记录仪器报警信息</span><span class="p">,</span><span class="n">Ipcode</span> <span class="err">信息代码</span><span class="p">,</span><span class="n">IpName</span> <span class="err">信息内容</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">Ipcode</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">resVal</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">IpName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">resVal</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="n">s</span> <span class="n">conclusion</span><span class="o">=</span><span class="n">conclusion_Ipcode_</span><span class="s2">&#34;^&#34;</span><span class="n">_IpName</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">conclusion</span><span class="p">)</span> <span class="n">s</span> <span class="n">conclusion</span><span class="o">=</span><span class="n">conclusion_</span><span class="s2">&#34;，&#34;</span><span class="n">_Ipcode_</span><span class="s2">&#34;：&#34;</span><span class="n">_IpName</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">e</span>  <span class="n">s</span> <span class="n">conclusion</span><span class="o">=</span><span class="n">Ipcode_</span><span class="s2">&#34;：&#34;</span><span class="n">_IpName</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="mi">9</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">imageR</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">imageR</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">imageR</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">retimageR</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">retimageR</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">retimageR</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">conversion</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">imageres</span><span class="o">=</span><span class="s2">&#34;getimage#&#34;</span><span class="n">_epis_</span><span class="s2">&#34;#&#34;</span><span class="n">_imageR_</span><span class="s2">&#34;#&#34;</span><span class="n">_retimageR</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">imageres</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;:&#34;</span><span class="n">_result</span><span class="p">,</span><span class="s2">&#34;提示&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">conclusion</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">epis1</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">6</span> <span class="n">s</span> <span class="n">epis1</span><span class="o">=$$</span><span class="n">ChangeEpisnew</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">6</span> <span class="n">s</span> <span class="n">epis1</span><span class="o">=</span><span class="n">epis</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis1_</span><span class="s2">&#34;:&#34;</span><span class="n">_conclusion</span><span class="p">,</span><span class="s2">&#34;报警信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis1</span><span class="p">)</span> <span class="n">d</span> <span class="c1">##Class(MI.Common.MIFBase).SaveMajorConclusion(epis1, conclusion, mi)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">conclusion</span><span class="p">)</span> <span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_</span><span class="s2">&#34;BJ&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_conclusion_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">d</span> <span class="c1">##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">imageres</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">conversion</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">imageR</span><span class="o">=</span><span class="s2">&#34;HPLT&#34;</span> <span class="n">s</span> <span class="n">imageR</span><span class="o">=</span><span class="s2">&#34;PLT&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">imageR</span><span class="o">=</span><span class="s2">&#34;HRBC&#34;</span> <span class="n">s</span> <span class="n">imageR</span><span class="o">=</span><span class="s2">&#34;RBC&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">imageR</span><span class="o">=</span><span class="s2">&#34;HWBC&#34;</span> <span class="n">s</span> <span class="n">imageR</span><span class="o">=</span><span class="s2">&#34;DIFF&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">imageR</span><span class="o">=</span><span class="s2">&#34;SBASO&#34;</span> <span class="n">s</span> <span class="n">imageR</span><span class="o">=</span><span class="s2">&#34;Baso&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFLISMonitorTest)SaveImageMTHD(&#34;7&#34;,&#34;9999&#34;, &#34;&#34;,&#34;175&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">mi</span><span class="p">:</span><span class="err">仪器</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">epis</span><span class="err">：流水号，如果是监听图片模式该位置放图片名称，自己在保存前提取流水</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">ImageClass</span><span class="p">:</span><span class="err">图片类别，如果是监听图片模式该位置放图片名称，自己在保存前提取图片类型</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">FileName</span><span class="p">:</span><span class="err">保存在文件服务的相对路径，默认不动</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">FullName</span><span class="p">:</span><span class="err">文件全路径，如果是监听图片模式该位置放图片全路径名称，满足有的图片名称无法得到流水和图片类别的情况</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveImageMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">ImageClass</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FullName</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">通过</span><span class="n">OtherPara配置取图的在这里通过epis和ImageClass的图片名字提取出流水号和图片类别</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ImageClass</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ImageClass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FileName</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FullName</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">FullName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;:&#34;</span><span class="n">_ImageClass_</span><span class="s2">&#34;:&#34;</span><span class="n">_FileName</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span> <span class="n">ImageOrder</span><span class="p">,</span> <span class="n">Caption</span><span class="p">,</span> <span class="n">DisplayRatio</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">返回给监听当前上传文件路径名称，默认不要动</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">w</span> <span class="c1">##class(MI.MIFLISMonitorTest).GetFtpMTHD(&#34;7&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">mi</span><span class="p">:</span><span class="err">仪器</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetFtpMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">文件服务模式必须改的地方，老的</span><span class="n">FTP模式这么改了也没问题</span><span class="err">，所以建议都这样</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="c1">##Class(MI.Common.MIFBase).GetMiFtpPath(mi)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Creator</span><span class="err">：</span>      <span class="err">查询患者信息，监听配置上传前处理类后会定时调用这个</span><span class="n">query查询数据进行上传操作</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">CreatDate</span><span class="err">：</span>    <span class="mi">20140919</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="p">:</span><span class="err">：</span> 
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>    
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="n">mi</span><span class="err">：仪器主键</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Others</span><span class="err">：</span>   
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">QryLabInfo</span><span class="p">(</span><span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Query</span><span class="p">(</span><span class="n">ROWSPEC</span> <span class="o">=</span> <span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Query的执行方法</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(%ResultSet).RunQuery(&#34;MI.MIFXN1000&#34;,&#34;QryLabInfo&#34;,&#34;11&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoExecute</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">i</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">flag</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">LabnoList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;C&#34;</span><span class="p">,</span><span class="n">AddDate</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">AddDate</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;C&#34;</span><span class="p">,</span><span class="n">AddDate</span><span class="p">,</span><span class="n">AddTime</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;C&#34;</span><span class="p">,</span><span class="n">AddDate</span><span class="p">,</span><span class="n">AddTime</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="n">ref</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=..</span><span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="n">cdf</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">Data</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ColFields</span><span class="o">=</span><span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span><span class="o">=</span><span class="c1">##Class(LIS.Util.Common).TransListNull(Data,ColFields)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">quit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoClose</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Kill</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoFetch</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">Row</span> <span class="n">As</span> <span class="o">%</span><span class="n">List</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">AtEnd</span> <span class="n">As</span> <span class="o">%</span><span class="n">Integer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">If</span> <span class="n">ind</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Else</span>      <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">AtEnd</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.XN9000).GetLabnoInfo(2,1709040020)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">s</span> <span class="o">^</span><span class="n">TMPLIS</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">获取项目通道号</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;*&#34;</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_chl_</span><span class="s2">&#34;+&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">tcx</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span> <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_tcx_</span><span class="s2">&#34;|&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tcx</span><span class="p">,</span><span class="s2">&#34;工单&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">tcx</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFLISMonitorTest).GetPatInfo(6,1001367)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">labno</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">标本信息</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RPVisitNumberData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">LocationDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">),</span><span class="n">Location</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Location</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">DoctorDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">Doctor</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Doctor</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDoctorD</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveUserDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">68</span><span class="p">),</span><span class="n">ReceiveUser</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">ReceiveUser</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">SYSUserD</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RegNo</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SurName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">GivenName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">SurName</span><span class="o">=</span><span class="n">GivenName</span> <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName_GivenName</span>  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SpeciesDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span><span class="n">Species</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AdmTypeDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">AdmType</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AdmType</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAdmissionTypeD</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AgeUnitDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span><span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAgeUnitD</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">CollectDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">51</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">CollectTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Diagnose</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampleda</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Instrument</span> <span class="o">=</span> <span class="s2">&#34;XN&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">s</span> <span class="n">Instrument</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampleno</span><span class="o">=</span><span class="n">labno</span>   <span class="o">//</span><span class="err">检测号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampletype</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Feetype</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">;</span><span class="err">费别</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Srcdepno</span><span class="o">=</span><span class="n">Location</span>  <span class="p">;</span><span class="err">送检科室</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Srcdocno</span><span class="o">=</span><span class="n">Doctor</span>   <span class="p">;</span><span class="err">送检医生</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Userno</span><span class="o">=</span><span class="n">ReceiveUser</span> <span class="p">;</span><span class="err">检验医生</span><span class="p">(</span><span class="err">录入者</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patno</span><span class="o">=</span><span class="n">RegNo</span> <span class="p">;</span><span class="err">登记号</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">BarCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">EpisodeNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">BarCode</span><span class="o">=</span><span class="n">EpisodeNo</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patna</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">PatName</span><span class="p">,</span><span class="s2">&#34; &#34;</span><span class="p">)</span>   <span class="p">;</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">b</span> <span class="p">;</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="mi">1</span> <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;男&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>     <span class="p">;</span><span class="mi">1</span><span class="p">:</span><span class="err">男</span> <span class="err">，</span><span class="mi">2</span> <span class="err">女</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">Species</span> <span class="o">=</span><span class="s2">&#34;女&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Pattype</span><span class="o">=</span><span class="n">AdmType</span>   <span class="p">;</span><span class="err">病人类型</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Bedno</span> <span class="o">=</span> <span class="n">BedNo</span>    <span class="p">;</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patage</span><span class="o">=</span><span class="n">Age</span>  <span class="p">;</span><span class="err">年龄</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Ageunit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">年龄单位</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reqno</span><span class="o">=</span><span class="n">labno</span>  <span class="p">;</span><span class="err">申请号</span> <span class="o">=</span> <span class="err">检验号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reqda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Reqda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">ReceiveTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span><span class="err">送检日期</span> <span class="o">=</span> <span class="err">接收时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reportda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">报告日期</span> <span class="o">=</span> <span class="err">初审</span><span class="p">(</span><span class="err">保存结果</span><span class="p">)</span><span class="err">时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Printflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">打印标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Resultflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">结果标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Errflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">错误标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Diagnose</span> <span class="o">=</span> <span class="n">Diagnose</span>   <span class="p">;</span><span class="err">诊断</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Description</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">备注</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reserve</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">保留字段</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patnamn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">姓名拼音码</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Getda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">CollectTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">s</span> <span class="n">Getda</span><span class="o">=</span><span class="n">Reqda</span> <span class="p">;</span><span class="err">接收时间</span><span class="o">/</span><span class="err">采样日期</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Wardno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">病区</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">Sampleda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Instrument_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampleno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampletype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Feetype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdepno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdocno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Userno_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patna_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sex_</span><span class="s2">&#34;,&#34;</span><span class="n">_Pattype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Bedno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patage_</span><span class="s2">&#34;,&#34;</span><span class="n">_Ageunit_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqda_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Reportda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Printflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Resultflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Errflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Diagnose_</span><span class="s2">&#34;,&#34;</span><span class="n">_Description_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reserve_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patnamn_</span><span class="s2">&#34;,&#34;</span><span class="n">_Getda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Wardno_</span><span class="s2">&#34;,&#34;</span><span class="n">_BarCode</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">RetString</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">监听做上传操作后调用改方法设置标本上传表状态</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveSDFMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">epis</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="n">filename</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFX1800IA).QueryCDF(-6,&#34;2015-09-10&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QueryCDF</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">date</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">date</span><span class="p">,</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">retList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">cnt</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">time</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">time</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34; S&#34;</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">time</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34; S&#34;</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">datetime</span><span class="o">=</span><span class="n">date_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">cnt</span><span class="o">=</span><span class="n">cnt</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="n">cnt</span><span class="o">&gt;</span><span class="mi">300</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">retList</span><span class="o">=</span><span class="n">retList_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="n">_cnt_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="n">_datetime_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="n">_labno_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="n">_labno_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="n">_filename_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">retList</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">retList</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">retList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">retList</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="同一路径回传文件上传一个或多个文件">同一路径回传文件上传一个或多个文件
</h4><h5 id="示例接口贝克曼流水线">示例接口(贝克曼流水线)
</h5><blockquote>
<p>通过配置监听 UPPreDealClass 字段“PreDeal.DealDemoM,PreDeal”，通过 M 进行编写上传信息，只输出一次 OutPut 就可以生成一个文件，通过输出两次 OutPut 修改第二次 OutPut 内容可以在同一路径回传两个不同的文件。</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span> <span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;Drect&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;2000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;C:</span><span class="se">\\</span><span class="s2">Inetpub</span><span class="se">\\</span><span class="s2">UL</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFRemisolN&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;.hpr,.ok&#34;</span><span class="p">,</span><span class="s2">&#34;UpPara&#34;</span><span class="p">:</span><span class="s2">&#34;C:</span><span class="se">\\</span><span class="s2">Inetpub</span><span class="se">\\</span><span class="s2">DL</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoMALL,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">Class</span> <span class="n">MI</span><span class="o">.</span><span class="n">MIFRemisolN</span> <span class="n">Extends</span> <span class="o">%</span><span class="n">RegisteredObject</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFBeckmanRemisol).fileMTHD(&#34;38&#34;,&#34;1,BASO#,1,0.02,,,,,&#34;,&#34;1&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">mi</span><span class="p">:</span><span class="err">仪器主键</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">record</span><span class="p">:</span><span class="err">一个数据行合并提交用</span><span class="c1">#enter#分割多行数据</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">epis</span><span class="p">:</span><span class="err">流水号，前处理提取出了的画</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">fileNameOrColName</span><span class="p">:</span><span class="err">读文件的是文件全名，数据库的是数据库查询的列名用</span><span class="o">~</span><span class="err">分割</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRemisolN).fileMTHD(&#34;1&#34;,&#34;H|\^&amp;|||REMISOL||||||UPLOAD_SIGN=0\INTERPRETATION_FLAG=1\INSTRUMENT_FLAG=1|P|1|20231207134318[13][10]Q|1|^ssss||||||||||O[13][10]L|1[13][10]&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRemisolN).fileMTHD(&#34;24&#34;,&#34;H|\^&amp;|||Lb1k□V1.5.5||||||UPLOAD_SIGN=1\INTERPRETATION_FLAG=0\INSTRUMENT_FLAG=1|P|1|20241011155213[13][10]P|1||0000000072||彭均秀^||19480902|F|||||||||||||||||普外科门诊[13][10]O|1|24101100017^0020^01|||RO|20241011155213|20241011155213||||||||S|||UV[13][10]R|1|^^^GLU^^2286\2286^1598\1609^^0|7.05^M|||N||R||||20241011102518|AU5800[13][10]R|2|^^^LIPEM^^^^^0|0|||N||R||||20241011102518|AU5800[13][10]R|3|^^^ICTER^^^^^0|0|||N||R||||20241011102518|AU5800[13][10]R|4|^^^HEMOL^^^^^0|0|||N||R||||20241011102518|AU5800[13][10]L|1[13][10]&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">fileMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">record</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">(</span><span class="n">MAXLEN</span><span class="o">=</span><span class="mi">99999999</span><span class="p">),</span> <span class="n">epis</span><span class="p">,</span> <span class="n">fileNameOrColName</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(record) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">Code</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;record&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;[13][10]&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">rec</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;[13][10]&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(rec) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;rec&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">type</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;O&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;R&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">code</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">S</span> <span class="n">res</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">ResNoes</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">ResNoes</span><span class="o">=</span><span class="c1">##class(MI.MIFRemisolN).ConvertResNoes(ResNoes) </span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">res</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">resKZJG</span><span class="o">=</span><span class="c1">##class(MI.MIFRemisolN).ConvertresKZJG(mi,epis,code,res)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_code_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_res_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_resKZJG_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_ResNoes_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;L&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">   	<span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_result</span><span class="p">,</span><span class="s2">&#34;Result&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">d</span> <span class="n">Save</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">获取扩展结果</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">ConvertresKZJG</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">code</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">code</span><span class="p">),</span><span class="n">res</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Labno</span><span class="o">=$$</span><span class="n">GetLabnoByEpis</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">Labno</span><span class="p">),</span><span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">Labno</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">Labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">)),</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">Age</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(code),&#39;</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="n">q</span> <span class="n">OutPut</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">code</span><span class="o">=</span><span class="s2">&#34;BNP&#34;</span><span class="p">,</span><span class="mi">0</span> <span class="n">d</span>		<span class="o">//</span> <span class="n">BNP</span> <span class="n">N端脑钠肽前体</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(Age) q</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">Age</span><span class="o">&lt;=</span><span class="mi">50</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="n">res</span><span class="o">&lt;=</span><span class="mi">450</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;正常&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="n">res</span><span class="o">&gt;</span><span class="mi">450</span><span class="p">,</span><span class="n">res</span><span class="o">&lt;=</span><span class="mi">600</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;急性心衰&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="n">res</span><span class="o">&gt;</span><span class="mi">600</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;慢性心衰&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="p">((</span><span class="n">Age</span><span class="o">&gt;</span><span class="mi">50</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">Age</span><span class="o">&lt;=</span><span class="mi">75</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="n">res</span><span class="o">&lt;=</span><span class="mi">900</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;正常&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="n">res</span><span class="o">&gt;</span><span class="mi">900</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;急性心衰&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">Age</span><span class="o">&gt;</span><span class="mi">75</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="n">res</span><span class="o">&lt;=</span><span class="mi">1800</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;正常&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="n">res</span><span class="o">&gt;</span><span class="mi">1800</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;急性心衰&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">code</span><span class="o">=</span><span class="s2">&#34;25OHD&#34;</span> <span class="n">d</span>		<span class="o">//</span> <span class="mi">25</span><span class="err">羟维生素</span><span class="n">D</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">res</span><span class="o">&lt;=</span><span class="mi">20</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;缺乏&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">res</span><span class="o">&gt;</span><span class="mi">20</span><span class="p">,</span><span class="n">res</span><span class="o">&lt;=</span><span class="mi">30</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;不足&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">res</span><span class="o">&gt;</span><span class="mi">30</span><span class="p">,</span><span class="n">res</span><span class="o">&lt;=</span><span class="mi">100</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;充足&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">res</span><span class="o">&gt;</span><span class="mi">100</span> <span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;超上限&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">OutPut</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GetLabnoByEpis</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">Epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">Epis</span><span class="p">,</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(mi) q Epis</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WGMachineID</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(WGMachineID) q Epis</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Epis))) {</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Epis),&#34;&#34;),-1)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">ret</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">转换报警信息</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">ConvertResNoes</span><span class="p">(</span><span class="n">ResNoes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ResNoes</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ResNoes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">OutPut</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(ResNoes) q OutPut</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">LISPolice</span><span class="p">(</span><span class="s2">&#34;BKMLSX&#34;</span><span class="p">,</span><span class="n">ResNoes</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">OutPut</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">LISPolice</span><span class="p">(</span><span class="s2">&#34;BKMLSX&#34;</span><span class="p">,</span><span class="n">ResNoes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ResNoes</span><span class="p">),</span><span class="s1">&#39;$l(OutPut) s OutPut=&#34;旗标:&#34;_ResNoes</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">OutPut</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFBeckmanRemisol)SaveImageMTHD(&#34;7&#34;,&#34;9999&#34;, &#34;&#34;,&#34;175&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">mi</span><span class="p">:</span><span class="err">仪器</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">epis</span><span class="err">：流水号，如果是监听图片模式该位置放图片名称，自己在保存前提取流水</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">ImageClass</span><span class="p">:</span><span class="err">图片类别，如果是监听图片模式该位置放图片名称，自己在保存前提取图片类型</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">FileName</span><span class="p">:</span><span class="err">保存在文件服务的相对路径，默认不动</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">FullName</span><span class="p">:</span><span class="err">文件全路径，如果是监听图片模式该位置放图片全路径名称，满足有的图片名称无法得到流水和图片类别的情况</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveImageMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">ImageClass</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FullName</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">通过</span><span class="n">OtherPara配置取图的在这里通过epis和ImageClass的图片名字提取出流水号和图片类别</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ImageClass</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ImageClass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">解析流水号和图片类别</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Name</span><span class="o">=</span><span class="n">epis</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="s2">&#34;_&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ImageClass</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="s2">&#34;_&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ImageClass</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">ImageClass</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FileName</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FullName</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">FullName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="c1">##Class(MI.Common.MIFBase).Trace(mi,epis_&#34;:&#34;_ImageClass_&#34;:&#34;_FileName,&#34;H&lt;--M&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span> <span class="n">ImageOrder</span><span class="p">,</span> <span class="n">Caption</span><span class="p">,</span> <span class="n">DisplayRatio</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">加上当前时间，防止浏览器缓存</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FileName</span><span class="o">=</span><span class="n">FileName_</span><span class="s2">&#34;?&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">返回给监听当前上传文件路径名称，默认不要动</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFBeckmanRemisol).GetFtpMTHD(&#34;7&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">mi</span><span class="p">:</span><span class="err">仪器</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetFtpMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">文件服务模式必须改的地方，老的</span><span class="n">FTP模式这么改了也没问题</span><span class="err">，所以建议都这样</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="c1">##Class(MI.Common.MIFBase).GetMiFtpPath(mi)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Creator</span><span class="err">：</span>      <span class="err">查询患者信息，监听配置上传前处理类后会定时调用这个</span><span class="n">query查询数据进行上传操作</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">CreatDate</span><span class="err">：</span>    <span class="mi">20140919</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="p">:</span><span class="err">：</span> 
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>    
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="n">mi</span><span class="err">：仪器主键</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Others</span><span class="err">：</span>   
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">QryLabInfo</span><span class="p">(</span><span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Query</span><span class="p">(</span><span class="n">ROWSPEC</span> <span class="o">=</span> <span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Query的执行方法</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(%ResultSet).RunQuery(&#34;MI.MIFRemisolN&#34;,&#34;QryLabInfo&#34;,&#34;24&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoExecute</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">i</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">flag</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//*--------------------------------&gt;*</span><span class="err">申请项目</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="mi">20</span><span class="err">秒以内的先不上传，防止没接收完</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="p">(</span><span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)),((</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">AddTime</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=..</span><span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">FileName</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="o">+$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_MiUploadDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">输出</span><span class="n">hpr文件</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(FileName_&#34;.hpr&#34;,labnoInfo,labno,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">FileName_</span><span class="s2">&#34;.hpr&#34;</span><span class="n">_</span><span class="s2">&#34;$$&#34;</span><span class="n">_labno_</span><span class="s2">&#34;$$&#34;</span><span class="n">_labnoInfo</span><span class="p">,</span><span class="s2">&#34;上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">输出</span><span class="n">OK文件</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(FileName_&#34;.OK&#34;,patInfo,labno,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">FileName_</span><span class="s2">&#34;.OK&#34;</span><span class="n">_</span><span class="s2">&#34;$$&#34;</span><span class="n">_labno_</span><span class="s2">&#34;$$&#34;</span><span class="n">_patInfo</span><span class="p">,</span><span class="s2">&#34;上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">/*</span>
</span></span><span class="line"><span class="cl">    <span class="o">//*--------------------------------&gt;*</span><span class="err">复查项目</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="mi">20</span><span class="err">秒以内的先不上传，防止没接收完</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="p">(</span><span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)),((</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">AddTime</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=..</span><span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">FileName</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="o">+$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_MiUploadDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">输出</span><span class="n">hpr文件</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(FileName_&#34;.hpr&#34;,labnoInfo,labno,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">FileName_</span><span class="s2">&#34;.hpr&#34;</span><span class="n">_</span><span class="s2">&#34;$$&#34;</span><span class="n">_labno_</span><span class="s2">&#34;$$&#34;</span><span class="n">_labnoInfo</span><span class="p">,</span><span class="s2">&#34;上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">输出</span><span class="n">OK文件</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(FileName_&#34;.OK&#34;,patInfo,labno,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">FileName_</span><span class="s2">&#34;.OK&#34;</span><span class="n">_</span><span class="s2">&#34;$$&#34;</span><span class="n">_labno_</span><span class="s2">&#34;$$&#34;</span><span class="n">_patInfo</span><span class="p">,</span><span class="s2">&#34;上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">*/</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ColFields</span><span class="o">=</span><span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span><span class="o">=</span><span class="c1">##Class(LIS.Util.Common).TransListNull(Data,ColFields)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">quit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoClose</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Kill</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoFetch</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">Row</span> <span class="n">As</span> <span class="o">%</span><span class="n">List</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">AtEnd</span> <span class="n">As</span> <span class="o">%</span><span class="n">Integer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">If</span> <span class="n">ind</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Else</span>      <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">AtEnd</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">得到标本信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFRemisolN).GetLabnoInfo(24,&#34;24092600054&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">miRowId</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">miRowId</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">miRowId</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="n">PLIST</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(miRowId)||&#39;</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	 
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">J</span><span class="p">,</span><span class="n">miRowId</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">visitNumberDR</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(visitNumberDR) 1</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">visitNumberData</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">visitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(visitNumberData) 2</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">miRowId</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="n">S</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">chlList</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">hcg5d</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">chlCnt</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">   	<span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chl</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">J</span><span class="p">,</span><span class="n">miRowId</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">chl</span><span class="p">)</span><span class="s1">&#39;=0   </span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">		    <span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">E</span><span class="p">(</span><span class="n">chl</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;A&#34;</span> <span class="n">chlCnt</span><span class="o">=</span><span class="n">chlCnt</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		    <span class="n">S</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;A179&#34;</span> <span class="n">hcg5d</span><span class="o">=</span><span class="n">chl</span>
</span></span><span class="line"><span class="cl">		    <span class="n">Continue</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;A179&#34;</span>
</span></span><span class="line"><span class="cl">		    <span class="n">S</span> <span class="n">chlList</span><span class="o">=</span><span class="n">chlList_</span><span class="s2">&#34;^^^&#34;</span><span class="n">_chl_</span><span class="s2">&#34;</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(chl)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		 
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	 
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">hcg5d</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="p">(</span><span class="n">chlCnt</span><span class="s1">&#39;=2)&amp;&amp;(chlCnt&#39;</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">chlCnt</span><span class="s1">&#39;=4) {</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">hcg5d</span><span class="o">=</span><span class="s2">&#34;A178&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">chlList</span><span class="o">=</span><span class="n">chlList_</span><span class="s2">&#34;^^^&#34;</span><span class="n">_hcg5d_</span><span class="s2">&#34;</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">chlList</span><span class="o">=$</span><span class="n">E</span><span class="p">(</span><span class="n">chlList</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">chlList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(chlList) 3</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">locationDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">),</span><span class="n">location</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">locationDR</span><span class="p">)</span> <span class="n">location</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">locationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">doctorDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">doctor</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">doctorCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">doctorDR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">doctor</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDoctorD</span><span class="p">(</span><span class="n">doctorDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">doctorCode</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDoctorD</span><span class="p">(</span><span class="n">doctorDR</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">receiveDate</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">receiveTime</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">receiveUserDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">68</span><span class="p">),</span><span class="n">receiveUser</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">receiveUserDR</span><span class="p">)</span> <span class="n">receiveUser</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">SYSUserD</span><span class="p">(</span><span class="n">receiveUserDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">patientId</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">surName</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">S</span> <span class="n">givenName</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">S</span> <span class="n">patName</span><span class="o">=</span><span class="n">surName_givenName</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="n">surName</span><span class="o">=</span><span class="n">givenName</span> <span class="n">patName</span><span class="o">=</span><span class="n">surName</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">speciesDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span><span class="n">species</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">speciesCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">speciesDR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">species</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">speciesDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">speciesCode</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">speciesDR</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">admTypeDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">admType</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">admTypeDR</span><span class="p">)</span> <span class="n">admType</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAdmissionTypeD</span><span class="p">(</span><span class="n">admTypeDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">bed</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">age</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">ageUnitDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span><span class="n">ageUnit</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">ageUnitCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">ageUnitDR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">ageUnit</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAgeUnitD</span><span class="p">(</span><span class="n">ageUnitDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">ageUnitCode</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAgeUnitD</span><span class="p">(</span><span class="n">ageUnitDR</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">collectDate</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">51</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">collectTime</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">collectDateTime</span><span class="o">=</span><span class="n">collectDate_</span><span class="c1">##Class(LIS.Core.Util).CvtClientTime(collectTime,&#34;HHMMSS&#34;)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">diagnosis</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">birthday</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">visitNumberData</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="s2">&#34;MF&#34;</span><span class="s1">&#39;[speciesCode speciesCode=&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span><span class="p">:</span><span class="s2">&#34;YMD&#34;</span><span class="s1">&#39;[ageUnitCode ageUnitCode=&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">S</span> <span class="n">PLIST</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">S</span> <span class="n">PLIST</span><span class="p">(</span><span class="o">$</span><span class="n">I</span><span class="p">(</span><span class="n">PLIST</span><span class="p">))</span><span class="o">=</span><span class="s2">&#34;H|\^&amp;|||LIS^1|||||REMISOL||P|1|&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ZD</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZT</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">patRecord</span><span class="o">=</span><span class="s2">&#34;P|1||||||||||||||||||||||||||||||||||&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">patRecord</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">patientId</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">givenName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">patRecord</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">surName_</span><span class="s2">&#34;^&#34;</span><span class="n">_givenName_</span><span class="s2">&#34;^^^&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">patRecord</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="o">=</span><span class="n">birthday_</span><span class="s2">&#34;^&#34;</span><span class="n">_age_</span><span class="s2">&#34;^&#34;</span><span class="n">_ageUnitCode</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">patRecord</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="o">=</span> <span class="n">speciesCode</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">patRecord</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span><span class="o">=</span> <span class="n">doctorCode</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">patRecord</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">22</span><span class="p">)</span><span class="o">=</span> <span class="n">diagnosis</span>  	<span class="o">//</span><span class="err">诊断</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">patRecord</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">26</span><span class="p">)</span><span class="o">=</span><span class="n">location</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">PLIST</span><span class="p">(</span><span class="o">$</span><span class="n">I</span><span class="p">(</span><span class="n">PLIST</span><span class="p">))</span><span class="o">=</span><span class="n">patRecord</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">order</span><span class="o">=</span><span class="s2">&#34;O|1|&#34;</span><span class="n">_labno_</span><span class="s2">&#34;||&#34;</span><span class="n">_chlList_</span><span class="s2">&#34;|||||||||||||||||||||&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">specType</span><span class="o">=..</span><span class="n">GetSpecimen</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">S</span> <span class="n">specTypeId</span><span class="o">=</span><span class="s2">&#34;S&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span> <span class="err">样品类型，如血清、血浆、尿液等。</span><span class="mi">0</span><span class="o">-</span><span class="err">血清，</span><span class="mi">1</span><span class="o">-</span><span class="err">血浆，</span><span class="mi">2</span><span class="o">-</span><span class="err">尿液，</span><span class="mi">3</span><span class="o">-</span><span class="err">脑脊液，</span><span class="mi">4</span><span class="o">-</span><span class="err">胃液，</span><span class="mi">5</span><span class="o">-</span><span class="err">胸水，</span><span class="mi">6</span><span class="o">-</span><span class="err">腹水，</span><span class="mi">7</span><span class="o">-</span><span class="err">其他</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="n">specType</span><span class="p">[</span><span class="s2">&#34;血清&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">specTypeId</span><span class="o">=</span><span class="s2">&#34;0&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">ELSEIF</span> <span class="n">specType</span><span class="p">[</span><span class="s2">&#34;血浆&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">specTypeId</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> 
</span></span><span class="line"><span class="cl">	<span class="n">ELSEIF</span> <span class="n">specType</span><span class="p">[</span><span class="s2">&#34;尿&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">specTypeId</span><span class="o">=</span><span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> 
</span></span><span class="line"><span class="cl">	<span class="n">ELSEIF</span> <span class="n">specType</span><span class="p">[</span><span class="s2">&#34;脑脊液&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">specTypeId</span><span class="o">=</span><span class="s2">&#34;3&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> 
</span></span><span class="line"><span class="cl">	<span class="n">ELSEIF</span> <span class="n">specType</span><span class="p">[</span><span class="s2">&#34;胃液&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">specTypeId</span><span class="o">=</span><span class="s2">&#34;4&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> 
</span></span><span class="line"><span class="cl">	<span class="n">ELSEIF</span> <span class="n">specType</span><span class="p">[</span><span class="s2">&#34;胸水&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">specTypeId</span><span class="o">=</span><span class="s2">&#34;5&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> 
</span></span><span class="line"><span class="cl">	<span class="n">ELSEIF</span> <span class="n">specType</span><span class="p">[</span><span class="s2">&#34;腹水&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">specTypeId</span><span class="o">=</span><span class="s2">&#34;6&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> 
</span></span><span class="line"><span class="cl">	<span class="n">ELSE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">specTypeId</span><span class="o">=</span><span class="s2">&#34;7&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;R&#34;</span>  <span class="o">//</span><span class="n">priority</span><span class="p">:</span><span class="n">R</span><span class="o">=</span><span class="n">Routine</span><span class="p">,</span><span class="n">S</span><span class="o">=</span><span class="n">Stat</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="o">=</span><span class="n">collectDateTime</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;A&#34;</span> <span class="o">//</span><span class="n">Action</span> <span class="n">Code</span><span class="p">:</span> <span class="n">A</span><span class="o">=</span><span class="n">Add</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="n">Clear</span><span class="p">,</span><span class="n">Q</span><span class="o">=</span><span class="ne">Control</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span><span class="o">=</span><span class="n">specTypeId</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">PLIST</span><span class="p">(</span><span class="o">$</span><span class="n">I</span><span class="p">(</span><span class="n">PLIST</span><span class="p">))</span><span class="o">=</span><span class="n">order</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">PLIST</span><span class="p">(</span><span class="o">$</span><span class="n">I</span><span class="p">(</span><span class="n">PLIST</span><span class="p">))</span><span class="o">=</span><span class="s2">&#34;L|1|&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">del</span><span class="o">=</span><span class="s2">&#34;[13][10]&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">seq</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">f</span>  <span class="n">s</span> <span class="n">seq</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">seq</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">ret_PLIST</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span><span class="n">_del</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">得到标本类型</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetSpecimen</span><span class="p">(</span><span class="n">labno</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=</span><span class="s2">&#34; &#34;</span><span class="n">_labno</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno)) q ret</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RowId</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPVisitNumber).%OpenId(RowId)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">spDr</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">SpecimenDR</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">spDesc</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">spDr</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objSp</span><span class="o">=</span><span class="c1">##class(dbo.BTSpecimen).%OpenId(spDr)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">spDesc</span><span class="o">=</span><span class="n">objSp</span><span class="o">.</span><span class="n">IName</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">spDesc</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFBeckmanRemisol).GetPatInfo(6,1001367)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">labno</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">标本信息</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RPVisitNumberData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">LocationDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">),</span><span class="n">Location</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Location</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">DoctorDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">Doctor</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Doctor</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDoctorD</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveUserDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">68</span><span class="p">),</span><span class="n">ReceiveUser</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">ReceiveUser</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">SYSUserD</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RegNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SurName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">GivenName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">SurName</span><span class="o">=</span><span class="n">GivenName</span> <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName_GivenName</span>  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SpeciesDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span><span class="n">Species</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AdmTypeDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">AdmType</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AdmType</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAdmissionTypeD</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AgeUnitDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span><span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAgeUnitD</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">CollectDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">51</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">CollectTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Diagnose</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampleda</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Instrument</span> <span class="o">=</span> <span class="s2">&#34;XN&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">s</span> <span class="n">Instrument</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampleno</span><span class="o">=</span><span class="n">labno</span>   <span class="o">//</span><span class="err">检测号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampletype</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Feetype</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">;</span><span class="err">费别</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Srcdepno</span><span class="o">=</span><span class="n">Location</span>  <span class="p">;</span><span class="err">送检科室</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Srcdocno</span><span class="o">=</span><span class="n">Doctor</span>   <span class="p">;</span><span class="err">送检医生</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Userno</span><span class="o">=</span><span class="n">ReceiveUser</span> <span class="p">;</span><span class="err">检验医生</span><span class="p">(</span><span class="err">录入者</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patno</span><span class="o">=</span><span class="n">RegNo</span> <span class="p">;</span><span class="err">登记号</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">BarCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patna</span><span class="o">=</span><span class="n">PatName</span>   <span class="p">;</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="mi">1</span>  <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;男&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>     <span class="p">;</span><span class="mi">1</span><span class="p">:</span><span class="err">男</span> <span class="err">，</span><span class="mi">2</span> <span class="err">女</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">Species</span> <span class="o">=</span><span class="s2">&#34;女&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Pattype</span><span class="o">=</span><span class="n">AdmType</span>   <span class="p">;</span><span class="err">病人类型</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Bedno</span> <span class="o">=</span> <span class="n">BedNo</span>    <span class="p">;</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patage</span><span class="o">=</span><span class="n">Age</span>  <span class="p">;</span><span class="err">年龄</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Ageunit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">年龄单位</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reqno</span><span class="o">=</span><span class="n">labno</span>  <span class="p">;</span><span class="err">申请号</span> <span class="o">=</span> <span class="err">检验号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reqda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Reqda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">ReceiveTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span><span class="err">送检日期</span> <span class="o">=</span> <span class="err">接收时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reportda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">报告日期</span>  <span class="o">=</span> <span class="err">初审</span><span class="p">(</span><span class="err">保存结果</span><span class="p">)</span><span class="err">时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Printflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">打印标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Resultflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">结果标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Errflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">错误标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Diagnose</span> <span class="o">=</span> <span class="n">Diagnose</span>   <span class="p">;</span><span class="err">诊断</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Description</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">备注</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reserve</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">保留字段</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patnamn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">姓名拼音码</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Getda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">CollectTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">s</span> <span class="n">Getda</span><span class="o">=</span><span class="n">Reqda</span> <span class="p">;</span><span class="err">接收时间</span><span class="o">/</span><span class="err">采样日期</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Wardno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">病区</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">Sampleda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Instrument_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampleno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampletype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Feetype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdepno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdocno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Userno_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patna_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sex_</span><span class="s2">&#34;,&#34;</span><span class="n">_Pattype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Bedno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patage_</span><span class="s2">&#34;,&#34;</span><span class="n">_Ageunit_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqda_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Reportda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Printflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Resultflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Errflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Diagnose_</span><span class="s2">&#34;,&#34;</span><span class="n">_Description_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reserve_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patnamn_</span><span class="s2">&#34;,&#34;</span><span class="n">_Getda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Wardno_</span><span class="s2">&#34;,&#34;</span><span class="n">_BarCode</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">RetString</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">监听做上传操作后调用改方法设置标本上传表状态</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveSDFMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">epis</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="n">filename</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">保存图片</span><span class="n">Base64串到仪器</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">mi</span><span class="p">:</span><span class="err">仪器主键</span><span class="p">(</span><span class="o">*</span><span class="err">必填</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">epis</span><span class="p">:</span><span class="err">流水号</span><span class="p">(</span><span class="o">*</span><span class="err">必填</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">ImageClass</span><span class="p">:</span><span class="err">图片类别</span><span class="p">(</span><span class="o">*</span><span class="err">必填</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">base64Stream</span><span class="p">:</span><span class="err">图片的</span><span class="n">Base64流</span><span class="p">(</span><span class="o">*</span><span class="err">必填</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">fileName</span><span class="p">:</span><span class="err">文件名</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">ftpFfolderName</span><span class="p">:</span><span class="err">文件服务的文件夹名称</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFBeckmanRemisol).SaveBase64ToMachineTest()</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveBase64ToMachineTest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">charStream</span><span class="o">=</span><span class="c1">##class(%GlobalCharacterStream).%New()</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;Qk02fQAAAAAAADYEAAAoAAAAsAAAALAAAAABAAgAAAAAAAB5AAB0EgAAdBIAAAAAAAAAAAAAAAAAAAAAgAAAgAAAAICAAIAAAACAAIAAgIAAAICAgADA3MAA8MqmAKo/KgD/PyoAAF8qAFVfKgCqXyoA/18qAAB/KgBVfyoAqn8qAP9/KgAAnyoAVZ8qAKqfKgD/nyoAAL8qAFW/KgCqvyoA/78qAADfKgBV3yoAqt8qAP/fKgAA/yoAVf8qAKr/KgD//yoAAABVAFUAVQCqAFUA/wBVAAAfVQBVH1UAqh9VAP8fVQAAP1UAVT9VAKo/VQD/P1UAAF9VAFVfVQCqX1UA/19VAAB/VQBVf1UAqn9VAP9/VQAAn1UAVZ9VAKqfVQD/n1UAAL9VAFW/VQCqv1UA/79VAADfVQBV31UAqt9VAP/fVQAA/1UAVf9VAKr/VQD//1UAAAB/AFUAfwCqAH8A/wB/AAAffwBVH38Aqh9/AP8ffwAAP38AVT9/AKo/fwD/P38AAF9/AFVffwCqX38A/19/AAB/fwBVf38Aqn9/AP9/fwAAn38AVZ9/AKqffwD/n38AAL9/AFW/fwCqv38A/79/AADffwBV338Aqt9/AP/ffwAA/38AVf9/AKr/fwD//38AAACqAFUAqgCqAKoA/wCqAAAfqgBVH6oAqh+qAP8fqgAAP6oAVT+qAKo/qgD/P6oAAF+qAFVfqgCqX6oA/1+qAAB/qgBVf6oAqn+qAP9/qgAAn6oAVZ+qAKqfqgD/n6oAAL+qAFW/qgCqv6oA/7+qAADfqgBV36oAqt+qAP/fqgAA/6oAVf+qAKr/qgD//6oAAADUAFUA1ACqANQA/wDUAAAf1ABVH9QAqh/UAP8f1AAAP9QAVT/UAKo/1AD/P9QAAF/UAFVf1ACqX9QA/1/UAAB/1ABVf9QAqn/UAP9/1AAAn9QAVZ/UAKqf1AD/n9QAAL/UAFW/1ACqv9QA/7/UAADf1ABV39QAqt/UAP/f1AAA/9QAVf/UAKr/1AD//9QAVQD/AKoA/wAAH/8AVR//AKof/wD/H/8AAD//AFU//wCqP/8A/z//AABf/wBVX/8Aql//AP9f/wAAf/8AVX//AKp//wD/f/8AAJ//AFWf/wCqn/8A/5//AAC//wBVv/8Aqr//AP+//wAA3/8AVd//AKrf/wD/3/8AVf//AKr//wD/zMwA/8z/AP//MwD//2YA//+ZAP//zAAAfwAAVX8AAKp/AAD/fwAAAJ8AAFWfAACqnwAA/58AAAC/AABVvwAAqr8AAP+/AAAA3wAAVd8AAKrfAAD/3wAAVf8AAKr/AAAAACoAVQAqAKoAKgD/ACoAAB8qAFUfKgCqHyoA/x8qAAA/KgBVPyoA8Pv/AKSgoACAgIAAAAD/AAD/AAAA//8A/wAAAP8A/wD//wAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADx8fHx8fEAAADxAAAA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPHxAPHx8fEAAPEA8QAA8QDxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QDxAADx8fHx8fHx8fHxAPHx8QAA8fEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8fHxAPHx8fHx8fHx8fEA8QDxAAAAAADxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPEA8fHx8QDx8fHx8fHx8fEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPEA8QAAAADx8fHx8fHx8QDx8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QAA8fHx8fEA8fHx8fHxAPEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QDxAAAAAPHx8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPEAAPHx8fHxAPEA8fEA8fEAAPE&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAAAAAPEAAPEA8QAA8QDxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QDx8QDx8QAA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8fHx8QAAAPEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAADx8fEA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAADxAAAAAPEAAAAAAPEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QAA8fEA8fHxAAAAAADxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8QAAAAAAAADxAADxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADx8QAA8QAAAAAA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPEA8fEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPEAAPEA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAPEA8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADxAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAgICAAACAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAgAAAgAAAgIAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAgICAAAAAgAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAC+gACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAgIAAgAAAPoCAAIAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgD6APr6AvoAAgACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAICAgICAAACAPr6AAIAAgACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIA+voAAgAAAgD6AAAA+gIAAgAAAgIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAAD6AAACAAIAAAIAAgAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgD6AAAAAPr6AgL6AAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAPoC+gAC+gAAAgAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAvoAAAD6AgAC+gD6+gD6AgIAAgIAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD6+gIAAPr6+gD6+gL6AAD6AAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAAACAPoA+gD6+vr6AgL6AAICAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPoAAAACAvoCAgD6AvoCAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAL6APoCAgAC+vr6+gICAAAAAgACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+gACAgAAAgIAAAACAgACAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD6+gAC+gIC+voC+gIAAAD6AAIAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgIAAvr6+gAAAgICAgD6AAACAPoCAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPoAAgD6+voCAvr6AvoAAgIAAgACAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAICAAACAAACAgD6+gIA+voC+gACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+gIAAAICAAIAAAL6AvoAAgIAAgAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAgIA+gAAAgL6+vr6+gACAAICAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAQABAQAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAAIA+gAA+voCAPoAAgIA+gACAAICAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAEAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAvoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAQAAAAABAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD6+gICAgIAAPr6+gAAAAAAAAIAAgAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICAAACAAAAAAL6AgICAAACAgAAAAIAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAABAAABAAAAAAABAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAL6AgACAgD6AAIA+gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICAAAAAAAAAgACAgIAAAIAAAACAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAABAAAAAAD5AQAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAICAAIAAPoAAgL6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAAAAAAAAAQAAAAABAAEAAAABAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAD6AAAAAAAAAAAAAAAAAgACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAABAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAgAAAAIAAgAAAgAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAQEAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAgAAAAIAAAAAAAAAAgIAAAAA+gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAA+QAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgACAPoAAAIAAAAAAAAAAAIAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAEAAQABAQAAAAEBAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAACAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAEAAQABAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+QAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAABAAD5AAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP0AAAAAAAAAAAAAAgAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAEBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAICAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAQAAAAAAAAABAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFBQAFAAAAAAD9AAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgAAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD9AAAFBQAFAAX9AAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAABgAAAAAGAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAFBf0ABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAYGAAAABgYGAAAAAAAGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUFAAUAAAUAAAAFAAAFBQUAAAAAAAAAAAAAAAAAAAYAAAAABgAAAAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUFAAUAAAUABQAAAAUFAAAAAAAFAAAAAAAAAAAAAAAAAAAAAP4GBgYGBv4AAAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQUFBQD9AAAFBQAAAP0AAAUAAP0AAAUFAAAAAAAAAAAAAAAAAP4GAAAABgb+BgYABgAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAF/QX9BQAFBf0AAAAABQAAAAAAAAAAAAAAAAAABgD+BgAABgYGAP4GBgYAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/QAFBQD9/f0ABQAFBf0AAAAFAAAAAAAAAAAAAAAAAAAABgb+AAD+BgYGBv4GAP4G/gYGAAAGBgYAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFBQD9AAX9/QAABQAFBQAAAP0ABQAAAAAAAAYABgAGAAb+Bgb+AP4ABgb+/v4GBgAGAAAGAAYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAP0F/QD9Bf39AP39AAAAAAAFAAAAAAAAAAAABgYABgYGAP7+/v4GBgb+Bv4ABgAABgAGBgYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAFAAX9/f39AAX9AAUF/QUAAAAAAAAAAAAABgAAAAAABgYGBv4G/v7+/v7+/v7+/v7+AAYGBgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUF/QX9AP39BQAFAP39/QUA/QAAAAAAAAAGAAAAAAAGAP4GBv7+/v7+/v7+/v7+/gYGBgb+BgD+AAAAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUFBQX9AAUABQUABf0AAP0AAAX9AAAFAAAAAAAGBgYABv7+/v7+AAb+/v7+/v7+/v7+/v4GBv4GAAb+AAAGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAA/QUFAAX9/QX9AP0FBQAA/QAAAAAAAAAAAAYGAAD+AAD+/v7+/v7+/v7+/v7+/v7+Bv4GBgYAAAAGBgAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAX9Bf39AAD9BQAA/QD9/QAABQAFAAYAAAAABgAG/gYG/v7+/v7+/v7+/v7+/v7+/v4GBv7+AAYGBgAAAAYGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAF/QAF/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;QUF/QAFBf0AAAAFAAAAAAAAAAAAAAAAAAAAAP7+/gb+/v7+/v7+/v7+/v7+/v7+/v4GAAYGAAAGBgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/f0A/QD9AAAFBQAABQAAAAAAAAAAAAAAAAAABgAGAP4G/v7+/v7+/v7+/v7+/v7+/v7+/v4G/gAGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAA/QUAAAAFAAD9BQAABQAAAAAAAAAAAAAAAAYABgYGBgb+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/gAABgYGAAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP0FAAUABQAA/QX9BQAFBQAAAAAAAAAAAAAAAAAAAAAG/v7+/gb+/v7+/v7+/v7+/v7+/v7+/v7+/gYGBgYGBgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQUAAAD9/QX9BQAAAAAABQAAAAAAAAAAAAYGAAAAAAYA/gD+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v4ABgYAAAYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUFAAAAAAAAAAAABgYAAAYA/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/v4GAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUFAAAABQAAAAAAAAAAAAUAAAAAAAAABgAAAAYAAAb+/gYGBv7+/v7+/v7+/v7+/v7+/v7+Bv7+/v4GBgAAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAFAAAAAAAAAAAABgYGAAAGBgYGBv7+/v7+/v7+/v7+/v7+/v4G/v7+BgAABgYGAAYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAAABgYGBv7+/v7+/v7+/v7+/v7+/v7+/v7+/v7+/gYA/gAG/gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYG/v7+/v7+/v7+/v7+/v7+/v7+Bgb+AAYGAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgYABgAG/v4G/gb+/v7+/v7+/v7+/v7+BgAGBgAGAAYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYABv4G/v4A/v7+/v4G/v7+/v7+/gb+BgAABgYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYABgAA/v7+/v7+BgYA/v4GBv4GBv4GAAYGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYABgYAAP7+/v4G/v4GBgYGBgYGBgYAAAAAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYABgYABgYABgYAAAb+/gAGBgYABgYGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgAGBgYAAAYGBgAGAAYABgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAAABgAAAAAABgAGBgAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAAAAAAAYAAAAGBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">charStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">epis</span><span class="o">=</span><span class="mi">999</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.Common.MIFBase).SaveBase64ToMachine(mi,epis,&#34;DIFF&#34;,charStream,epis_&#34;-DIFF.bmp&#34;,&#34;ZLZ&#34;)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">ret</span><span class="s1">&#39;=1 d Trace^MI.MIF000(mi,&#34;错误&#34;_ret,&#34;H&lt;--M&#34;)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">转移标本</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFRemisolN).TransMachineGroup(1,9000000071,&#34;DXI800&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFRemisolN).TransMachineGroup(1,9000000071,&#34;AU5800&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">TransMachineGroup</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">machineName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">7</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">epis</span><span class="o">=$$</span><span class="n">GetLabnoByEpis</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WGMachineID</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">VisitnumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)),</span><span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitnumberDR</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitnumberDR</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//----------------------</span><span class="err">转移标本</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">machineName</span><span class="o">=</span><span class="s2">&#34;AU5800&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">TransMachineGroupDR</span><span class="o">=</span><span class="mi">61</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ParamList</span><span class="o">=</span><span class="n">TransMachineGroupDR_</span><span class="s2">&#34;^@&#34;</span><span class="n">_ReportDR</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(LISSP.DHCRPVisitNumberReport).TransMachineGroup(ParamList,&#34;&lt;Data&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P7&gt;&lt;/P7&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P0&gt;&lt;/P0&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P5&gt;&lt;/P5&gt;&lt;/Data&gt;&#34;,&#34;8280^18^0^2^1&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="p">;</span><span class="n">i</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&#34;流水号已存在&#34;</span> <span class="n">d</span>		<span class="o">//</span><span class="n">YHR</span> <span class="mi">20230101</span> <span class="err">如果流水号冲突是否获取最大流水号保证转移成功</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">objReport</span><span class="o">=</span><span class="c1">##class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">NewEpis</span><span class="o">=</span><span class="c1">##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(TransMachineGroupDR,&#34;&lt;Data&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P0&gt;&#34;_$zd($h,3)_&#34;&lt;/P0&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P7&gt;&lt;/P7&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P5&gt;&lt;/P5&gt;&lt;/Data&gt;&#34;,$c(0))</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">objReport</span><span class="o">.</span><span class="n">EpisodeNo</span><span class="o">=</span><span class="n">NewEpis</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objReport</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(LISSP.DHCRPVisitNumberReport).TransMachineGroup(ParamList,&#34;&lt;Data&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P7&gt;&lt;/P7&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P0&gt;&lt;/P0&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P5&gt;&lt;/P5&gt;&lt;/Data&gt;&#34;,&#34;8280^18^0^2^1&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">machineName</span><span class="o">=</span><span class="s2">&#34;DXI800&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">TransMachineGroupDR</span><span class="o">=</span><span class="mi">71</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ParamList</span><span class="o">=</span><span class="n">TransMachineGroupDR_</span><span class="s2">&#34;^@&#34;</span><span class="n">_ReportDR</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(LISSP.DHCRPVisitNumberReport).TransMachineGroup(ParamList,&#34;&lt;Data&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P7&gt;&lt;/P7&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P0&gt;&lt;/P0&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P5&gt;&lt;/P5&gt;&lt;/Data&gt;&#34;,&#34;8280^18^0^2^1&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="p">;</span><span class="n">i</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&#34;流水号已存在&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">objReport</span><span class="o">=</span><span class="c1">##class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">NewEpis</span><span class="o">=</span><span class="c1">##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(TransMachineGroupDR,&#34;&lt;Data&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P0&gt;&#34;_$zd($h,3)_&#34;&lt;/P0&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P7&gt;&lt;/P7&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P5&gt;&lt;/P5&gt;&lt;/Data&gt;&#34;,$c(0))</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">objReport</span><span class="o">.</span><span class="n">EpisodeNo</span><span class="o">=</span><span class="n">NewEpis</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objReport</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(LISSP.DHCRPVisitNumberReport).TransMachineGroup(ParamList,&#34;&lt;Data&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P7&gt;&lt;/P7&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P0&gt;&lt;/P0&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P5&gt;&lt;/P5&gt;&lt;/Data&gt;&#34;,&#34;8280^18^0^2^1&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GetLabnoByEpis</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">Epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(mi) q Epis</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WGMachineID</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(WGMachineID) q Epis</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Epis))) {</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Epis),&#34;&#34;),-1)</span>
</span></span><span class="line"><span class="cl">		<span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">ret</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="通过串口网口主动上传">通过串口网口主动上传
</h3><h4 id="上传和下载为不同的串口或端口">上传和下载为不同的串口或端口
</h4><h5 id="示例代码西门子流水线">示例代码(西门子流水线)
</h5><blockquote>
<p>仪器为两个接口，一个接口上传，一个接口接收数据解析数据。上传数据为在 main 调用 Build2 方法循环调用读取 dbo.RPMachineUpload 表中的数据。</p></blockquote>
<h6 id="接收数据">接收数据
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">MIFNYSIMRec</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>  <span class="p">;</span> <span class="mi">7</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">14</span> <span class="p">;</span> <span class="n">ASTM</span> <span class="n">protocol</span>  <span class="o">-</span> <span class="err">西门子流水线</span><span class="p">(</span><span class="n">MCR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(mi) q</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="o">^</span><span class="n">TMPMACHDATA1</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span><span class="o">=</span><span class="n">mi</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ItemDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">12</span><span class="p">)</span> <span class="o">//</span><span class="err">项目分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ResultDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">13</span><span class="p">)</span> <span class="o">//</span><span class="err">结果分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AntDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">14</span><span class="p">)</span> <span class="o">//</span><span class="err">抗生素分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SenDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span> <span class="o">//</span><span class="err">药敏结果分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Port</span><span class="o">=</span><span class="s2">&#34;|TCP|&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">17</span><span class="p">)</span>  <span class="o">//</span><span class="err">端口号</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">$</span><span class="n">ECODE</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="o">//</span><span class="err">捕获运行时错误</span><span class="p">,</span><span class="err">并显示</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">控制字符</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">stx</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">etx</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ack</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">enq</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">eot</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">lf</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="n">nak</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">21</span><span class="p">),(</span><span class="n">result</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">etb</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">isDebug</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">iError</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="o">^</span><span class="n">TMPMACHDATA1</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">=</span><span class="n">mi</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$$</span><span class="n">StartUTF8</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span>  <span class="n">d</span> <span class="n">Main</span> <span class="n">i</span> <span class="o">$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="o">^</span><span class="n">TMPMACH10</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span><span class="o">=$</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">  	<span class="n">c</span> <span class="n">Port</span>
</span></span><span class="line"><span class="cl">  	<span class="n">q</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">Main</span> 
</span></span><span class="line"><span class="cl">  <span class="p">;</span><span class="n">s</span> <span class="o">^</span><span class="n">MIFSIMENSTRecive</span><span class="o">=$</span><span class="n">zdt</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">S</span> <span class="o">$</span><span class="n">ZT</span><span class="o">=</span><span class="s2">&#34;RuntimeError&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span> <span class="n">e</span>  <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="p">;</span><span class="n">d</span> <span class="n">BUILD2</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=enq Q</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">ACK</span>
</span></span><span class="line"><span class="cl">  <span class="n">f</span>  <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span> <span class="n">q</span><span class="p">:</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=stx q</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">record</span><span class="o">=$$</span><span class="n">Read</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">lf</span><span class="p">)</span> <span class="n">q</span><span class="p">:</span><span class="s1">&#39;$l(record)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">record</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="n">etb</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="n">AllRecord_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">etb</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="n">etx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="n">AllRecord_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">etx</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">ACK</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">type</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;M&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">Intype</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">Inlabno</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">Inlabno</span><span class="p">,</span><span class="s2">&#34;Inlabno&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">try</span><span class="p">{</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##class(MI.Special.AutomaticReceipt).ZDHS(mi,Inlabno)}catch{}		//YHR 20230910 生化流水线自动核收</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span><span class="p">:</span><span class="s2">&#34;EOT&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">AllRecord</span><span class="p">,</span><span class="s2">&#34;AllRecord&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AllRecord</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="p">(</span><span class="n">mid</span><span class="p">,</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">flag</span><span class="p">,</span><span class="n">machiecode</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AllRecord</span><span class="p">,</span><span class="n">cr</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">rec</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">AllRecord</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">type</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;H&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;M&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">Intype</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">Inlabno</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">Inlabno</span><span class="p">,</span><span class="s2">&#34;Inlabno&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="p">;</span><span class="n">try</span><span class="p">{</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##class(MI.Special.AutomaticReceipt).ZDHS(mi,Inlabno)}catch{}		//YHR 20230910 生化流水线自动核收</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;O&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;R&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">code</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">flag</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">machiecode</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">14</span><span class="p">),</span><span class="s2">&#34;_&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">machiecode</span><span class="o">=</span><span class="s2">&#34;CentaurXP&#34;</span><span class="p">,</span><span class="n">flag</span><span class="s1">&#39;=&#34;DOSE&#34; Q</span>
</span></span><span class="line"><span class="cl">  <span class="o">...//</span><span class="n">R</span><span class="o">|</span><span class="mi">1</span><span class="o">|^^^</span><span class="n">Glu</span><span class="o">^</span><span class="n">Neat</span><span class="o">^</span><span class="mf">1.0</span><span class="o">^^^</span><span class="n">N</span><span class="o">|</span><span class="mf">7.70</span><span class="o">|||||||^</span><span class="n">batch</span><span class="o">|</span><span class="mi">20191116093550</span><span class="o">||</span><span class="n">Advia2400_1</span><span class="err">【</span><span class="mi">13</span><span class="err">】【</span><span class="mi">3</span><span class="err">】</span><span class="n">C2</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">MachID</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">14</span><span class="p">),</span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">res</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">I</span> <span class="n">res</span><span class="o">=</span><span class="s2">&#34;No Result&#34;</span> <span class="n">s</span> <span class="n">res</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="s1">&#39;$l(code) q</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="s1">&#39;$l(res) q</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_code_ResultDeli_res_ItemDeli</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">DateStr</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span><span class="p">:</span><span class="s1">&#39;$L(DateStr) DateStr=$p(rec,&#34;|&#34;,12)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DateStr</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">zdh</span><span class="p">(</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span><span class="o">+$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;L&#34;</span> <span class="n">d</span> <span class="n">Last</span> <span class="n">q</span> 
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Last</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">s</span> <span class="n">resultmi</span><span class="o">=</span><span class="mi">40</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;仪器rowid&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">date_</span><span class="s2">&#34;^&#34;</span><span class="n">_time_</span><span class="s2">&#34;^&#34;</span><span class="n">_epis_</span><span class="s2">&#34;^:&#34;</span><span class="n">_result</span><span class="p">,</span><span class="s2">&#34;Save in SIMENS&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">d</span> <span class="n">Save</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">///</span><span class="err">标本核收</span>
</span></span><span class="line"><span class="cl">   <span class="p">;</span> <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="s1">&#39;$d(^DHCUploadAllBAK(&#34;B&#34;,epis)) s retVal=$$ReceiveLabno^MI.MIF000(28,epis,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RuntimeError</span>
</span></span><span class="line"><span class="cl">	<span class="n">h</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">iError</span><span class="o">=</span><span class="n">iError</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;Error Code:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ECODE_</span><span class="s2">&#34;,Error:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ZERROR</span><span class="p">,</span><span class="s2">&#34;Runtime Error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">iError</span><span class="o">&gt;</span><span class="mi">100</span>  <span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">     <span class="o">///</span><span class="n">CreateDate</span><span class="err">：</span>  <span class="mi">20140717</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="n">Description</span><span class="err">：</span> <span class="err">构建医嘱列表</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="n">Table</span> <span class="n">DHC_LoadSpecimen</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="ne">Input</span><span class="err">：</span>		
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="n">Output</span><span class="err">：</span>	
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="n">Return</span><span class="err">：</span>		
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="n">Others</span><span class="err">：</span><span class="n">DHCLoadSpecimen</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;DateTime&#34;</span><span class="p">,</span><span class="s2">&#34;TDMTS&#34;</span><span class="p">,</span><span class="s2">&#34;C&#34;</span><span class="p">,</span><span class="mi">62301</span><span class="p">,</span><span class="mi">42467</span><span class="p">,</span><span class="s2">&#34;T623010010&#34;</span><span class="p">,</span><span class="s2">&#34;T101&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span> <span class="o">^</span><span class="n">DHCLoadSpecimen</span><span class="p">({</span><span class="n">DHC_LoadSpecimen</span><span class="o">.</span><span class="n">DLSP_LabNo</span><span class="p">},{</span><span class="n">DHC_LoadSpecimen</span><span class="o">.</span><span class="n">DLSP_TS</span><span class="p">},{</span><span class="n">DHC_LoadSpecimen</span><span class="o">.</span><span class="n">DLSP_TSCNT</span><span class="p">},</span><span class="s2">&#34;TC&#34;</span><span class="p">,{</span><span class="n">DLST_TestCode</span><span class="p">})</span> 
</span></span><span class="line"><span class="cl">    <span class="o">///</span> <span class="o">^</span><span class="n">DHCLoadSpecimen</span><span class="p">({</span><span class="n">DLSP_LabNo</span><span class="p">},{</span><span class="n">DLSP_TS</span><span class="p">},{</span><span class="n">DLSP_TSCNT</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="o">///</span>   <span class="n">W</span> <span class="o">$$</span><span class="n">BUILD2</span><span class="o">^</span><span class="n">DEBUG</span>
</span></span><span class="line"><span class="cl"><span class="n">BUILD2</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">DHCENQ</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">d</span> <span class="n">SendENQ</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">k</span> <span class="o">^</span><span class="n">DHCENQ</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span>  <span class="o">//</span><span class="n">wwh</span><span class="p">,</span><span class="mi">20140812</span><span class="p">,</span><span class="err">不上传标本</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="s1">&#39;$D(^DHCLoadSpecimen(0,&#34;DateTime&#34;,mi,&#34;C&#34;,+$h)) H 10 Q</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">SIMTT</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">F</span>  <span class="n">S</span> <span class="n">SIMTT</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">DHCLoadSpecimen</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;DateTime&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;C&#34;</span><span class="p">,</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="n">SIMTT</span><span class="p">))</span> <span class="n">Q</span><span class="p">:</span><span class="n">SIMTT</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">SIMEpis</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">F</span>  <span class="n">S</span> <span class="n">SIMEpis</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">DHCLoadSpecimen</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;DateTime&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;C&#34;</span><span class="p">,</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="n">SIMTT</span><span class="p">,</span><span class="n">SIMEpis</span><span class="p">))</span> <span class="n">Q</span><span class="p">:</span><span class="n">SIMEpis</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">S</span> <span class="n">SIMTS</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">F</span>  <span class="n">S</span> <span class="n">SIMTS</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">DHCLoadSpecimen</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;DateTime&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;C&#34;</span><span class="p">,</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="n">SIMTT</span><span class="p">,</span><span class="n">SIMEpis</span><span class="p">,</span><span class="n">SIMTS</span><span class="p">))</span> <span class="n">Q</span><span class="p">:</span><span class="n">SIMTS</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">S</span> <span class="n">epis</span><span class="o">=</span><span class="n">SIMEpis</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">S</span> <span class="n">SIMAck</span><span class="o">=$$</span><span class="n">BUILD</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="p">;;;</span><span class="n">I</span> <span class="p">(</span><span class="n">SIMAck</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">!</span><span class="p">(</span><span class="n">SIMAck</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="n">D</span>  
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">I</span> <span class="n">SIMAck</span><span class="o">=</span><span class="mi">0</span> <span class="n">D</span>  
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="p">;;</span><span class="n">S</span> <span class="n">err</span><span class="o">=$$</span><span class="n">UpdSendStatus</span><span class="o">^</span><span class="n">DHCLABLoadSpecimen</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">SIMTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">S</span> <span class="n">err</span><span class="o">=$$</span><span class="n">UpdSendStatus</span><span class="o">^</span><span class="n">DHCLABLoadSpecimen</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">E</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">S</span> <span class="n">err</span><span class="o">=$$</span><span class="n">UpdSendStatus</span><span class="o">^</span><span class="n">DHCLABLoadSpecimen</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">BUILD</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">episx</span><span class="o">=</span><span class="n">epis</span><span class="p">,</span><span class="n">epis</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">RetAck</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">^</span><span class="n">TMPsim</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">epis</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="s1">&#39;$D(^TEPI(epis,1)) S suffix=$E(epis,$L(epis)),epis=$E(epis,1,$L(epis)-1) I $L(epis),&#39;</span><span class="o">$</span><span class="n">D</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="n">Q</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">^</span><span class="n">TMPsim</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">epis_</span><span class="s2">&#34;,&#34;</span><span class="n">_mi_</span><span class="s2">&#34;,&#34;</span><span class="n">_suffix</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">;;;</span><span class="n">S</span> <span class="n">err</span><span class="o">=$$</span><span class="n">CreateTCList</span><span class="o">^</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">SIMTS</span><span class="p">)</span>  <span class="p">;</span><span class="err">创建上传医嘱列表</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">err</span><span class="o">=$$</span><span class="n">CreateTCList</span><span class="o">^</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>  <span class="p">;</span><span class="err">创建上传医嘱列表</span>
</span></span><span class="line"><span class="cl">	<span class="n">M</span> <span class="o">^</span><span class="n">TMPCHL</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">=^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIF-SINGLE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$D(^TMP(&#34;MIF-SINGLE&#34;,$j,mi,epis_suffix))</span>
</span></span><span class="line"><span class="cl">	<span class="n">M</span> <span class="o">^</span><span class="n">TMPCHL</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIF-SINGLE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="p">(</span><span class="n">surn</span><span class="p">,</span><span class="n">givn</span><span class="p">,</span><span class="n">sex</span><span class="p">,</span><span class="n">dob</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">urno</span><span class="p">,</span><span class="n">age</span><span class="p">,</span><span class="n">loc</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">	<span class="p">;</span> <span class="n">check</span> <span class="k">for</span> <span class="n">entered</span><span class="o">/</span><span class="n">pre</span><span class="o">-</span><span class="n">entered</span> <span class="n">patient</span> <span class="n">details</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="n">PLIST</span> <span class="n">I</span> <span class="s1">&#39;$$select^LVBEPVIS(epis,&#34;Y&#34;) D</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">F</span> <span class="n">j</span><span class="o">=</span><span class="s2">&#34;surn;3&#34;</span><span class="p">,</span><span class="s2">&#34;givn;4&#34;</span><span class="p">,</span><span class="s2">&#34;sex;5&#34;</span><span class="p">,</span><span class="s2">&#34;dob;6&#34;</span><span class="p">,</span><span class="s2">&#34;date;12&#34;</span><span class="p">,</span><span class="s2">&#34;urno;20&#34;</span><span class="p">,</span><span class="s2">&#34;age;26&#34;</span><span class="p">,</span><span class="s2">&#34;loc;66&#34;</span> <span class="n">S</span> <span class="err">@</span><span class="p">(</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="s2">&#34;;&#34;</span><span class="p">))</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">PLIST</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="s2">&#34;;&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="n">PLIST</span> <span class="n">S</span> <span class="n">sex</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">sex</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span> <span class="n">s</span><span class="p">:</span><span class="n">sex</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;M&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">urno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">urno</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="n">givn</span><span class="o">=</span><span class="n">surn</span> <span class="n">s</span> <span class="n">givn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">diag</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="mi">8</span><span class="p">)),</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,15) ;;; 诊断</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">SpecType</span><span class="o">=$$</span><span class="n">GetSpecType</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>  <span class="p">;;;</span> <span class="err">标本</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">D</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">epis</span><span class="p">))</span> <span class="n">D</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">D</span> <span class="n">scanone</span><span class="o">^</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>  <span class="p">;</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIF-SINGLE&#34;</span><span class="p">,</span><span class="mi">208912</span><span class="p">,</span><span class="s2">&#34;AH7471&#34;</span><span class="p">,</span><span class="s2">&#34;A611071030&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">F</span>  <span class="n">S</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIF-SINGLE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">Q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">tcs</span><span class="o">=</span><span class="n">tcs_</span><span class="s2">&#34;^^^&#34;</span><span class="n">_chl_</span><span class="s2">&#34;/</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">S</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_</span><span class="s2">&#34;^^^&#34;</span><span class="n">_chl_</span><span class="s2">&#34;^0</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">tcx</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">I</span> <span class="s1">&#39;$L(tcx) S tcx=&#34;^^^^^^0&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">xx</span><span class="o">=$$</span><span class="n">extdate2</span><span class="o">^</span><span class="n">SSUTIL4</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">),</span><span class="n">date</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">xx</span><span class="o">=$$</span><span class="n">exttime</span><span class="o">^</span><span class="n">SSUTIL4</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="n">time</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;00&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">temepis</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="p">;</span><span class="mi">1</span><span class="n">H</span><span class="o">|</span>\<span class="o">^&amp;|||</span><span class="n">BSLIS</span><span class="o">^</span><span class="n">V3</span><span class="o">.</span><span class="mi">00</span><span class="o">|||||||</span><span class="n">P</span><span class="o">|</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&#34;1H|\^&amp;|||BSLIS^V3.00|||||host|TSDWN^REPLY|P|1&#34;</span><span class="n">_cr</span>   <span class="p">;</span><span class="err">头信息</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="p">;</span><span class="mi">2</span><span class="n">P</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="mi">0010332409</span><span class="o">|</span><span class="mi">0010332409</span><span class="o">||</span><span class="n">Doe</span><span class="o">^</span><span class="n">JohnlSmith</span><span class="o">||</span><span class="mi">19150826</span><span class="o">|</span><span class="n">F</span><span class="o">|||||||||||||||||</span><span class="mi">5500</span><span class="o">|||||||||&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;2P|1&#34;</span><span class="n">_cr</span>  <span class="p">;</span><span class="err">病人信息</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;2P|1&#34;</span><span class="n">_cr</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">I</span> <span class="n">epis</span><span class="o">=</span><span class="s2">&#34;N&#34;</span> <span class="n">s</span> <span class="n">epis</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="p">;</span><span class="mi">3</span><span class="n">O</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="mi">112448100</span><span class="o">||^^^</span><span class="n">TP</span><span class="o">^^^</span><span class="mi">0</span>\<span class="o">^^^</span><span class="n">ALB</span><span class="o">^^^</span><span class="mi">0</span><span class="o">|</span><span class="n">R</span><span class="o">||</span><span class="mi">20110826112206</span><span class="o">||||</span><span class="n">A</span><span class="o">|</span><span class="n">hep</span><span class="o">|</span><span class="n">lipemic</span><span class="o">||</span><span class="n">Serum</span><span class="o">||||||||||</span><span class="n">Q</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;3O|1|&#34;</span><span class="n">_epis_</span><span class="s2">&#34;||&#34;</span><span class="n">_tcx_</span><span class="s2">&#34;|R||&#34;</span><span class="n">_date_time_</span><span class="s2">&#34;||||A|hep|lipemic||&#34;</span><span class="n">_SpecType_</span><span class="s2">&#34;||||||||||&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;Q&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="p">;</span><span class="mi">4</span><span class="n">L</span><span class="o">|</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;4L|1|&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">RetAck</span><span class="o">=$$</span><span class="n">Send</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">K</span> <span class="o">^</span><span class="n">TMIF</span><span class="p">(</span><span class="s2">&#34;MIF_SINGLE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">^</span><span class="n">TMPsim</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;||&#34;</span><span class="n">_RetAck</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="n">RetAck</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Send</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>  <span class="p">;</span> <span class="n">send</span> <span class="n">list</span> <span class="n">of</span> <span class="n">orders</span> <span class="k">if</span> <span class="n">exists</span>
</span></span><span class="line"><span class="cl">  <span class="n">W</span> <span class="n">enq</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="n">F</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span> <span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">1</span> <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="o">!</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">)</span>  <span class="n">Q</span> 
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">:</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">nak</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;1H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span> <span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=ack W eot,*-3 d Trace^MI.MIF000(mi,&#34;EOT&#34;,&#34;H--&gt;M&#34;) Q ret</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">241</span> <span class="n">D</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="n">str1</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">241</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="n">str2</span><span class="o">=</span><span class="s2">&#34;2&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">E</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="mi">242</span><span class="p">,</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">E</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">;</span><span class="n">f</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span> <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">1</span> <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="o">!</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">:</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">nak</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;2H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">W</span> <span class="n">eot</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;EOT&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">SEND</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span>  <span class="p">;</span> <span class="n">send</span> <span class="n">string</span> <span class="n">to</span> <span class="n">instrument</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="n">flag</span><span class="o">=</span><span class="mi">1</span> <span class="n">D</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_etb</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="n">chsum</span><span class="o">=$$</span><span class="n">CHSUM</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">E</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_etx</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="n">chsum</span><span class="o">=$$</span><span class="n">CHSUM</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">W</span> <span class="n">stx</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="n">chsum</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">lf</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">str_chsum</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">F</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span> <span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">1</span> <span class="n">I</span> <span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">)</span><span class="o">!</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span><span class="p">)</span> <span class="n">Q</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span> <span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;EOT&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span> <span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=-</span><span class="mi">1</span> <span class="n">W</span> <span class="n">nak</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">CHSUM</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="p">;</span> <span class="n">calculate</span> <span class="n">check</span> <span class="n">sum</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">s</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span> <span class="n">f</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">s</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+$</span><span class="n">a</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">z</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="s2">&#34;0123456789ABCDEF&#34;</span><span class="p">,</span><span class="n">z</span><span class="c1">#256\16+1)_$e(&#34;0123456789ABCDEF&#34;,z#16+1)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">ACK</span>  <span class="p">;</span> <span class="n">send</span> <span class="s1">&#39;ack&#39;</span> <span class="n">to</span> <span class="n">instrument</span>
</span></span><span class="line"><span class="cl">  <span class="n">w</span> <span class="n">ack</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="n">NEXTTRAY</span><span class="p">(</span><span class="n">tray</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  <span class="n">q</span> <span class="n">tray</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">///</span>  
</span></span><span class="line"><span class="cl"><span class="n">GetSpecType</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="n">n</span> <span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">spdr</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">RetVal</span><span class="o">=</span><span class="s2">&#34;SE&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">spec</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">spdr</span><span class="p">),</span><span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">TTAB</span><span class="p">(</span><span class="s2">&#34;SPEC&#34;</span><span class="p">,</span><span class="n">spdr</span><span class="p">))</span> <span class="n">s</span> <span class="n">spec</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">^</span><span class="n">TTAB</span><span class="p">(</span><span class="s2">&#34;SPEC&#34;</span><span class="p">,</span><span class="n">spdr</span><span class="p">),</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,1)</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&#34;血&#34;</span> <span class="n">s</span> <span class="n">RetVal</span><span class="o">=</span><span class="s2">&#34;SE&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&#34;尿&#34;</span> <span class="n">s</span> <span class="n">RetVal</span><span class="o">=</span><span class="s2">&#34;UR&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span> <span class="n">RetVal</span>  
</span></span><span class="line"><span class="cl"><span class="n">SendENQ</span>  <span class="p">;</span> <span class="n">send</span> <span class="n">list</span> <span class="n">of</span> <span class="n">orders</span> <span class="k">if</span> <span class="n">exists</span>
</span></span><span class="line"><span class="cl">  <span class="n">W</span> <span class="n">enq</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span><span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span> <span class="n">e</span>  <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">//.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">:</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">nak</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;1H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">F</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span> <span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">1</span> <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="o">!</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">:</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">nak</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;1H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span> <span class="n">Q</span> 
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=ack W eot,*-3 d Trace^MI.MIF000(mi,&#34;EOT&#34;,&#34;H--&gt;M&#34;)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>  
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="发送数据">发送数据
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">MIFNYSIMSend</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>  <span class="p">;</span> <span class="mi">7</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">14</span> <span class="p">;</span> <span class="n">ASTM</span> <span class="n">protocol</span>  <span class="o">-</span> <span class="err">西门子流水线</span><span class="p">(</span><span class="n">MCR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(mi) q</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="o">^</span><span class="n">TMPMACHDATA1</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span><span class="o">=</span><span class="n">mi</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ItemDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">12</span><span class="p">)</span> <span class="o">//</span><span class="err">项目分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ResultDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">13</span><span class="p">)</span> <span class="o">//</span><span class="err">结果分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AntDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">14</span><span class="p">)</span> <span class="o">//</span><span class="err">抗生素分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SenDeli</span><span class="o">=$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span> <span class="o">//</span><span class="err">药敏结果分隔符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Port</span><span class="o">=</span><span class="s2">&#34;|TCP|&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">li</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>  <span class="o">//</span><span class="err">端口号</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">控制字符</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">isDebug</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">iError</span><span class="o">=</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">stx</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">etx</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ack</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">enq</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">eot</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">lf</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">cr</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="n">nak</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">21</span><span class="p">),(</span><span class="n">result</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">etb</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="o">^</span><span class="n">TMPMACHDATA1</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">=</span><span class="n">mi</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$$</span><span class="n">Start</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span>  <span class="n">d</span> <span class="n">Main</span> <span class="n">i</span> <span class="o">$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="o">^</span><span class="n">TMPMACH10</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span><span class="o">=$</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">  	<span class="n">c</span> <span class="n">Port</span>
</span></span><span class="line"><span class="cl">  	<span class="n">q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Main</span>
</span></span><span class="line"><span class="cl">  <span class="n">S</span> <span class="o">$</span><span class="n">ZT</span><span class="o">=</span><span class="s2">&#34;RuntimeError&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">ECODE</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="o">//</span><span class="err">捕获运行时错误</span><span class="p">,</span><span class="err">并显示</span>
</span></span><span class="line"><span class="cl">  <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span> <span class="n">e</span>  <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">D</span> <span class="n">BUILD2</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">ACK</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">f</span>  <span class="n">r</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">10</span> <span class="n">q</span><span class="p">:</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=stx q</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">record</span><span class="o">=$$</span><span class="n">Read</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">lf</span><span class="p">)</span> <span class="n">q</span><span class="p">:</span><span class="s1">&#39;$l(record)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">record</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="n">etb</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="n">AllRecord_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">etb</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="n">etx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="n">AllRecord_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">etx</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="n">AllRecord_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="n">etb</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="n">AllRecord_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="n">etx</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">d</span> <span class="n">ACK</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span><span class="p">:</span><span class="s2">&#34;EOT&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AllRecord</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="p">(</span><span class="n">mid</span><span class="p">,</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AllRecord</span><span class="p">,</span><span class="n">cr</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">rec</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">AllRecord</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">s</span> <span class="n">type</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;H&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;M&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">Intype</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">Inlabno</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">Inlabno</span><span class="p">,</span><span class="s2">&#34;Inlabno&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">try</span><span class="p">{</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##class(MI.Special.AutomaticReceipt).ZDHS(mi,Inlabno)}catch{}		//YHR 20230910 生化流水线自动核收</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">i</span> <span class="n">Intype</span><span class="o">=</span><span class="s2">&#34;I&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.....</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">Inlabno</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">.....</span><span class="n">q</span><span class="p">:</span><span class="s1">&#39;$d(^TEPI(Inlabno))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.....</span><span class="n">s</span> <span class="n">temts</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">temts</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">Inlabno</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">temts</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">temts</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">......</span><span class="p">;</span><span class="n">q</span><span class="p">:</span><span class="s1">&#39;$d(^TMIF(mi,0,temts))</span>
</span></span><span class="line"><span class="cl">  <span class="o">......</span><span class="n">s</span> <span class="n">temtscnt</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">temtscnt</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">Inlabno</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">temts</span><span class="p">,</span><span class="n">temtscnt</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">temtscnt</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.......</span><span class="n">s</span><span class="p">:</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">Inlabno</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">temts</span><span class="p">,</span><span class="n">temtscnt</span><span class="p">),</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,27)=&#34;&#34; $P(^TEPI(Inlabno,1,temts,temtscnt),&#34;</span>\<span class="s2">&#34;,27)=mi</span>
</span></span><span class="line"><span class="cl">  <span class="o">.......</span><span class="n">s</span><span class="p">:</span><span class="o">$</span><span class="n">P</span><span class="p">(</span><span class="o">^</span><span class="n">TEPI</span><span class="p">(</span><span class="n">Inlabno</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">temts</span><span class="p">,</span><span class="n">temtscnt</span><span class="p">),</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,36)=&#34;&#34; $P(^TEPI(Inlabno,1,temts,temtscnt),&#34;</span>\<span class="s2">&#34;,36)=$P(^TEPI(Inlabno,1,temts,temtscnt),&#34;</span>\<span class="s2">&#34;,60) </span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;O&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">qcid</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">qcid</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">qcid</span><span class="p">,</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">QCStat</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">SpecStat</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">i</span> <span class="n">SpecStat</span><span class="o">=</span><span class="s2">&#34;S&#34;</span> <span class="n">s</span> <span class="n">epis</span><span class="o">=</span><span class="s2">&#34;E&#34;</span><span class="n">_epis</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">i</span> <span class="n">QCStat</span><span class="o">=</span><span class="s2">&#34;Q&#34;</span> <span class="n">s</span> <span class="n">QC</span><span class="o">=</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">_qcid,epis=qcid</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">datex</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">23</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;/&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;/&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">date</span><span class="o">=$$</span><span class="n">intdate</span><span class="o">^</span><span class="n">SSUTIL4</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">time1</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">datex</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">),</span><span class="n">time1</span><span class="o">=$$</span><span class="n">inttime</span><span class="o">^</span><span class="n">SSUTIL4</span><span class="p">(</span><span class="n">time1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;R&#34;</span> <span class="n">d</span>  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">code</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">flag</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">mid1</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">i</span> <span class="n">mid1</span><span class="s1">&#39;=&#34;&#34; s mid=mid1</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="n">res</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">s</span> <span class="o">^</span><span class="n">Test</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">res_</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">_flag</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">i</span> <span class="n">mid1</span><span class="p">[</span><span class="s2">&#34;CentaurXP&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">code</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="n">D</span>
</span></span><span class="line"><span class="cl">  <span class="o">.....</span><span class="n">i</span> <span class="n">flag</span><span class="o">=</span><span class="s2">&#34;DOSE&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">......</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_code_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">par10</span><span class="p">)</span><span class="n">_res_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">par11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">//....</span><span class="n">E</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">  <span class="o">....</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">code</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="n">D</span>
</span></span><span class="line"><span class="cl">  <span class="o">.....</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_code_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">par10</span><span class="p">)</span><span class="n">_res_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">par11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>  <span class="o">//</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;L&#34;</span> <span class="n">d</span> <span class="n">Last</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">  <span class="n">D</span> <span class="n">BUILD2</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Last</span>	<span class="p">;</span> <span class="n">file</span> <span class="n">result</span> <span class="k">if</span> <span class="n">exist</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AllRecord</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">time1</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">s</span> <span class="n">time1</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">time</span><span class="o">=</span><span class="n">time1</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">date</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">time</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">d</span> <span class="n">Save</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RuntimeError</span>
</span></span><span class="line"><span class="cl">	<span class="n">h</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">iError</span><span class="o">=</span><span class="n">iError</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;Error Code:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ECODE_</span><span class="s2">&#34;,Error:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ZERROR</span><span class="p">,</span><span class="s2">&#34;Runtime Error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">D</span><span class="p">:</span><span class="n">isDebug</span> <span class="n">Log</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;Error Code:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ECODE_</span><span class="s2">&#34;,Error:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ZERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">iError</span><span class="o">&gt;</span><span class="mi">100</span>  <span class="n">s</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">Stop</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">     <span class="o">///</span><span class="n">CreateDate</span><span class="err">：</span>  <span class="mi">20140717</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="n">Description</span><span class="err">：</span> <span class="err">构建医嘱列表</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="n">Table</span> <span class="n">DHC_LoadSpecimen</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="ne">Input</span><span class="err">：</span>	
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="n">Output</span><span class="err">：</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="n">Return</span><span class="err">：</span>	
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="n">Others</span><span class="err">：</span><span class="n">DHCLoadSpecimen</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;DateTime&#34;</span><span class="p">,</span><span class="s2">&#34;TDMTS&#34;</span><span class="p">,</span><span class="s2">&#34;C&#34;</span><span class="p">,</span><span class="mi">62301</span><span class="p">,</span><span class="mi">42467</span><span class="p">,</span><span class="s2">&#34;T623010010&#34;</span><span class="p">,</span><span class="s2">&#34;T101&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span> <span class="o">^</span><span class="n">DHCLoadSpecimen</span><span class="p">({</span><span class="n">DHC_LoadSpecimen</span><span class="o">.</span><span class="n">DLSP_LabNo</span><span class="p">},{</span><span class="n">DHC_LoadSpecimen</span><span class="o">.</span><span class="n">DLSP_TS</span><span class="p">},{</span><span class="n">DHC_LoadSpecimen</span><span class="o">.</span><span class="n">DLSP_TSCNT</span><span class="p">},</span><span class="s2">&#34;TC&#34;</span><span class="p">,{</span><span class="n">DLST_TestCode</span><span class="p">})</span> 
</span></span><span class="line"><span class="cl">    <span class="o">///</span> <span class="o">^</span><span class="n">DHCLoadSpecimen</span><span class="p">({</span><span class="n">DLSP_LabNo</span><span class="p">},{</span><span class="n">DLSP_TS</span><span class="p">},{</span><span class="n">DLSP_TSCNT</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="o">///</span>   <span class="n">W</span> <span class="o">$$</span><span class="n">BUILD2</span><span class="o">^</span><span class="n">DEBUG</span>
</span></span><span class="line"><span class="cl"><span class="n">BUILD2</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LabnoList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">Labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="p">;</span><span class="n">H</span> <span class="mi">1</span>  <span class="o">//</span><span class="err">每隔</span><span class="mi">2</span><span class="n">S处理一个标本</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">D</span><span class="p">:</span><span class="n">isDebug</span> <span class="n">Log</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;BUILD2|labno=&#34;</span><span class="n">_Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">S</span> <span class="n">SIMAck</span><span class="o">=$$</span><span class="n">BUILD</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">I</span> <span class="n">SIMAck</span><span class="o">=</span><span class="mi">0</span> <span class="n">D</span>  
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">err</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,Labno,&#34;S&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">E</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">D</span><span class="p">:</span><span class="n">isDebug</span> <span class="n">Log</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;BUILD2|Fail:labno=&#34;</span><span class="n">_Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="n">Q</span><span class="p">:</span><span class="n">tryTimes</span><span class="o">&lt;</span><span class="mi">4</span>  <span class="o">//</span><span class="err">失败</span><span class="mi">3</span><span class="err">次才更新失败状态</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">err</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,Labno,&#34;F&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">Labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="p">;</span><span class="n">H</span> <span class="mi">1</span>  <span class="o">//</span><span class="err">每隔</span><span class="mi">2</span><span class="n">S处理一个标本</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">D</span><span class="p">:</span><span class="n">isDebug</span> <span class="n">Log</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;BUILD2|labno=&#34;</span><span class="n">_Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">S</span> <span class="n">SIMAck</span><span class="o">=$$</span><span class="n">BUILD</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">I</span> <span class="n">SIMAck</span><span class="o">=</span><span class="mi">0</span> <span class="n">D</span>  
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">err</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,Labno,&#34;S&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">E</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">D</span><span class="p">:</span><span class="n">isDebug</span> <span class="n">Log</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;BUILD2|Fail:labno=&#34;</span><span class="n">_Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="n">Q</span><span class="p">:</span><span class="n">tryTimes</span><span class="o">&lt;</span><span class="mi">4</span>  <span class="o">//</span><span class="err">失败</span><span class="mi">3</span><span class="err">次才更新失败状态</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">err</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,Labno,&#34;F&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">老年医院流水线上传所有集中接收标本</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">s</span> <span class="n">Labno</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">Labno</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">DHCUploadAll</span><span class="p">(</span><span class="n">Labno</span><span class="p">))</span> <span class="n">Q</span><span class="p">:</span><span class="n">Labno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">//.</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">DHCUploadAll</span><span class="p">(</span><span class="n">Labno</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">//.</span><span class="n">S</span> <span class="n">SIMAck</span><span class="o">=$$</span><span class="n">SendSorting</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//.</span><span class="n">I</span> <span class="n">SIMAck</span><span class="s1">&#39;=0 s ^DHCUploadAllBAK(&#34;F&#34;,Labno)=^DHCUploadAll(Labno)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//.</span><span class="n">e</span>  <span class="n">s</span> <span class="o">^</span><span class="n">DHCUploadAllBAK</span><span class="p">(</span><span class="s2">&#34;S&#34;</span><span class="p">,</span><span class="n">Labno</span><span class="p">)</span><span class="o">=^</span><span class="n">DHCUploadAll</span><span class="p">(</span><span class="n">Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//.</span><span class="n">s</span> <span class="o">^</span><span class="n">DHCUploadAllBAK</span><span class="p">(</span><span class="s2">&#34;B&#34;</span><span class="p">,</span><span class="n">Labno</span><span class="p">)</span><span class="o">=^</span><span class="n">DHCUploadAll</span><span class="p">(</span><span class="n">Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//.</span><span class="n">k</span> <span class="o">^</span><span class="n">DHCUploadAll</span><span class="p">(</span><span class="n">Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">JudgeUrgent</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">urgent</span><span class="p">,</span><span class="s2">&#34;urgentJu&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">urgent</span><span class="o">=</span><span class="mi">1</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">urgent</span><span class="o">=</span><span class="s2">&#34;S&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">urgent</span><span class="p">,</span><span class="s2">&#34;urgentJUS&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">urgent</span><span class="o">=</span><span class="s2">&#34;R&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BUILD</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">episx</span><span class="o">=</span><span class="n">Labno</span><span class="p">,</span><span class="n">Labno</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">RetAck</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="p">(</span><span class="n">surn</span><span class="p">,</span><span class="n">givn</span><span class="p">,</span><span class="n">sex</span><span class="p">,</span><span class="n">dob</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">urno</span><span class="p">,</span><span class="n">age</span><span class="p">,</span><span class="n">loc</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">VisitNumberData</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">urno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">urno</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="n">givn</span><span class="o">=</span><span class="n">surn</span> <span class="n">s</span> <span class="n">givn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">GName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">diag</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span> <span class="p">;;;</span> <span class="err">诊断</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">SpecType</span><span class="o">=$$</span><span class="n">GetSpecType</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">)</span>  <span class="p">;;;</span> <span class="err">标本</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">debtor</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span><span class="err">登记号</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">admtype</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span><span class="err">就诊类型</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">urgent</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span> <span class="p">;</span><span class="err">是否加急</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">urgent</span><span class="p">,</span><span class="s2">&#34;urgent&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">JudgeAdmType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">JudgeUrgent</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">SpeciesDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="n">s</span> <span class="n">Species</span> <span class="o">=</span> <span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">):</span><span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">),</span><span class="mi">3</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">S</span> <span class="n">Species</span><span class="o">=</span><span class="n">SpeciesDR</span> <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">DOB</span><span class="o">=</span> <span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span> <span class="p">;</span><span class="err">出生日期</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">s</span> <span class="n">DOB</span><span class="o">=</span><span class="s2">&#34;20000202&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LocationDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Location</span> <span class="o">=</span> <span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">):</span><span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Loc</span><span class="o">=</span><span class="n">Location</span> <span class="p">;</span><span class="err">科室</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">TSName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="err">多条医嘱信息合并</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">TSName</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">TestSetDR</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">TestSetDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberTestSetI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">q</span><span class="p">:</span><span class="n">TestSetDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">TSName</span><span class="p">)</span> <span class="n">s</span> <span class="n">TSName</span><span class="o">=</span><span class="n">TSName_</span><span class="s2">&#34;+&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTTestSetD</span><span class="p">(</span><span class="n">TestSetDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">e</span>  <span class="n">s</span> <span class="n">TSName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTTestSetD</span><span class="p">(</span><span class="n">TestSetDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">Labno</span><span class="p">)</span> <span class="p">;</span><span class="err">创建上传化验项目列表</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$D(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,Labno)) q 1</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">F</span>  <span class="n">S</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">Labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">Q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_</span><span class="s2">&#34;^^^&#34;</span><span class="n">_chl_</span><span class="s2">&#34;^^^0</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tcx</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="s1">&#39;$L(tcx) S tcx=&#34;^^^^^^0&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">date</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">time</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">temepis</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">H</span><span class="o">|</span>\<span class="o">^&amp;|||</span><span class="n">BSLIS</span><span class="o">^</span><span class="n">V3</span><span class="o">.</span><span class="mi">00</span><span class="o">|||||||</span><span class="n">P</span><span class="o">|</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&#34;H|\^&amp;|||BSLIS^V3.00|||||host|TSDWN^REPLY|P|1&#34;</span><span class="n">_cr</span>   <span class="p">;</span><span class="err">头信息</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">P</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="mi">0010332409</span><span class="o">|</span><span class="mi">0010332409</span><span class="o">||</span><span class="n">Doe</span><span class="o">^</span><span class="n">JohnlSmith</span><span class="o">||</span><span class="mi">19150826</span><span class="o">|</span><span class="n">F</span><span class="o">|||||||||||||||||</span><span class="mi">5500</span><span class="o">|||||||||&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;P|1|&#34;</span><span class="n">_debtor_</span><span class="s2">&#34;|&#34;</span><span class="n">_cr</span>  <span class="p">;</span><span class="err">病人信息</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SName</span><span class="o">=</span><span class="c1">##class(OTH.DHCINSUPort).GetPinYingCode(SName)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;P|1|&#34;</span><span class="n">_debtor_</span><span class="s2">&#34;|||&#34;</span><span class="n">_SName_</span><span class="s2">&#34;^^^||&#34;</span><span class="n">_DOB_</span><span class="s2">&#34;|&#34;</span><span class="n">_Species_</span><span class="s2">&#34;|||||||||||||||||&#34;</span><span class="n">_Loc_</span><span class="s2">&#34;|||||||||&#34;</span><span class="n">_cr</span>  <span class="p">;</span><span class="err">病人信息</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="n">Labno</span><span class="o">=</span><span class="s2">&#34;N&#34;</span> <span class="n">s</span> <span class="n">Labno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">O</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="mi">112448100</span><span class="o">||^^^</span><span class="n">TP</span><span class="o">^^^</span><span class="mi">0</span>\<span class="o">^^^</span><span class="n">ALB</span><span class="o">^^^</span><span class="mi">0</span><span class="o">|</span><span class="n">R</span><span class="o">||</span><span class="mi">20110826112206</span><span class="o">||||</span><span class="n">N</span><span class="o">|</span><span class="n">hep</span><span class="o">|</span><span class="n">lipemic</span><span class="o">||</span><span class="n">Serum</span><span class="o">||||||||||</span><span class="n">Q</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">s</span> <span class="n">SpecType</span><span class="o">=</span><span class="s2">&#34;Serum&#34;</span>	<span class="o">//</span><span class="n">YHR</span> <span class="err">设置空白的为血类型</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;O|1|&#34;</span><span class="n">_Labno_</span><span class="s2">&#34;||&#34;</span><span class="n">_tcx_</span><span class="s2">&#34;|&#34;</span><span class="n">_urgent_</span><span class="s2">&#34;||&#34;</span><span class="n">_date_time_</span><span class="s2">&#34;||||A|hep|lipemic||&#34;</span><span class="n">_SpecType_</span><span class="s2">&#34;|||&#34;</span><span class="n">_TSName_</span><span class="s2">&#34;|&#34;</span><span class="n">_admtype_</span><span class="s2">&#34;||||||&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;Q&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">    <span class="p">;</span><span class="mi">4</span><span class="n">L</span><span class="o">|</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;L|1|&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">RetAck</span><span class="o">=$$</span><span class="n">Send</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">K</span> <span class="o">^</span><span class="n">TMIF</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="n">RetAck</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">JudgeAdmType</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">admtype</span><span class="o">=</span><span class="mi">1</span> <span class="n">s</span> <span class="n">admtype</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">admtype</span><span class="o">=</span><span class="mi">2</span> <span class="n">s</span> <span class="n">admtype</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">admtype</span><span class="o">=</span><span class="mi">8</span> <span class="n">s</span> <span class="n">admtype</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SendSorting</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">episx</span><span class="o">=</span><span class="n">Labno</span><span class="p">,</span><span class="n">Labno</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">RetAck</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="p">(</span><span class="n">surn</span><span class="p">,</span><span class="n">givn</span><span class="p">,</span><span class="n">sex</span><span class="p">,</span><span class="n">dob</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">urno</span><span class="p">,</span><span class="n">age</span><span class="p">,</span><span class="n">loc</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">VisitNumberData</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">urno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">urno</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="n">givn</span><span class="o">=</span><span class="n">surn</span> <span class="n">s</span> <span class="n">givn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">admtype</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span><span class="err">就诊类型</span>
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">JudgeAdmType</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">urgent</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span> <span class="p">;</span><span class="err">是否加急</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">D</span> <span class="n">JudgeUrgent</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">GName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">diag</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span> <span class="p">;;;</span> <span class="err">诊断</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">SpecType</span><span class="o">=$$</span><span class="n">GetSpecType</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">)</span>  <span class="p">;;;</span> <span class="err">标本</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">debtor</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span><span class="err">登记号</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">SpeciesDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="n">s</span> <span class="n">Species</span> <span class="o">=</span> <span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">):</span><span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">),</span><span class="mi">3</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">TSName</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">S</span> <span class="n">Species</span><span class="o">=</span><span class="n">SpeciesDR</span> <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">DOB</span><span class="o">=</span> <span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span> <span class="p">;</span><span class="err">出生日期</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LocationDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="n">VisitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Location</span> <span class="o">=</span> <span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">):</span><span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Loc</span><span class="o">=</span><span class="n">Location</span> <span class="p">;</span><span class="err">科室</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">TSName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="err">多条医嘱信息合并</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">TestSetDR</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">TestSetDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberTestSetI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">q</span><span class="p">:</span><span class="n">TestSetDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">TSName</span><span class="p">)</span> <span class="n">s</span> <span class="n">TSName</span><span class="o">=</span><span class="n">TSName_</span><span class="s2">&#34;+&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTTestSetD</span><span class="p">(</span><span class="n">TestSetDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">e</span>  <span class="n">s</span> <span class="n">TSName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTTestSetD</span><span class="p">(</span><span class="n">TestSetDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;Sorting&#34;</span><span class="n">_WorkGroupMachineDR</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_</span><span class="s2">&#34;^^^&#34;</span><span class="n">_chl_</span><span class="s2">&#34;^^^0</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">date</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">time</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">temepis</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">H</span><span class="o">|</span>\<span class="o">^&amp;|||</span><span class="n">BSLIS</span><span class="o">^</span><span class="n">V3</span><span class="o">.</span><span class="mi">00</span><span class="o">|||||||</span><span class="n">P</span><span class="o">|</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&#34;H|\^&amp;|||BSLIS^V3.00|||||host|TSDWN^REPLY|P|1&#34;</span><span class="n">_cr</span>   <span class="p">;</span><span class="err">头信息</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">P</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="mi">0010332409</span><span class="o">|</span><span class="mi">0010332409</span><span class="o">||</span><span class="n">Doe</span><span class="o">^</span><span class="n">JohnlSmith</span><span class="o">||</span><span class="mi">19150826</span><span class="o">|</span><span class="n">F</span><span class="o">|||||||||||||||||</span><span class="mi">5500</span><span class="o">|||||||||&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;P|1|&#34;</span><span class="n">_debtor_</span><span class="s2">&#34;|&#34;</span><span class="n">_cr</span>  <span class="p">;</span><span class="err">病人信息</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;P|1|&#34;</span><span class="n">_debtor_</span><span class="s2">&#34;|||&#34;</span><span class="n">_SName_</span><span class="s2">&#34;^&#34;</span><span class="n">_GName_</span><span class="s2">&#34;^^||&#34;</span><span class="n">_DOB_</span><span class="s2">&#34;|&#34;</span><span class="n">_Species_</span><span class="s2">&#34;|||||||||||||||||&#34;</span><span class="n">_Loc_</span><span class="s2">&#34;|||||||||&#34;</span><span class="n">_cr</span>  <span class="p">;</span><span class="err">病人信息</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="n">Labno</span><span class="o">=</span><span class="s2">&#34;N&#34;</span> <span class="n">s</span> <span class="n">Labno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">O</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span><span class="mi">112448100</span><span class="o">||^^^</span><span class="n">TP</span><span class="o">^^^</span><span class="mi">0</span>\<span class="o">^^^</span><span class="n">ALB</span><span class="o">^^^</span><span class="mi">0</span><span class="o">|</span><span class="n">R</span><span class="o">||</span><span class="mi">20110826112206</span><span class="o">||||</span><span class="n">N</span><span class="o">|</span><span class="n">hep</span><span class="o">|</span><span class="n">lipemic</span><span class="o">||</span><span class="n">Serum</span><span class="o">||||||||||</span><span class="n">Q</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">s</span> <span class="n">SpecType</span><span class="o">=</span><span class="s2">&#34;Serum&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;O|1|&#34;</span><span class="n">_Labno_</span><span class="s2">&#34;||&#34;</span><span class="n">_tcx_</span><span class="s2">&#34;|&#34;</span><span class="n">_urgent_</span><span class="s2">&#34;||&#34;</span><span class="n">_date_time_</span><span class="s2">&#34;||||A|hep|lipemic||&#34;</span><span class="n">_SpecType_</span><span class="s2">&#34;|||&#34;</span><span class="n">_TSName_</span><span class="s2">&#34;|&#34;</span><span class="n">_admtype_</span><span class="s2">&#34;||||||&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;Q&#34;</span><span class="n">_cr</span>
</span></span><span class="line"><span class="cl">    <span class="p">;</span><span class="mi">4</span><span class="n">L</span><span class="o">|</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_</span><span class="s2">&#34;L|1|&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">RetAck</span><span class="o">=$$</span><span class="n">Send</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="n">RetAck</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Send</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>  <span class="p">;</span> <span class="n">send</span> <span class="n">list</span> <span class="n">of</span> <span class="n">orders</span> <span class="k">if</span> <span class="n">exists</span>
</span></span><span class="line"><span class="cl">  <span class="n">W</span> <span class="n">enq</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="n">F</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span> <span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">1</span> <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="o">!</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">)</span>  <span class="n">Q</span> 
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">:</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span><span class="p">:</span><span class="s2">&#34;ENQ&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">nak</span><span class="p">:</span><span class="s2">&#34;NAK&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">R</span><span class="p">),</span><span class="s2">&#34;1H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">enq</span> <span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="s1">&#39;=ack W eot,*-3 d Trace^MI.MIF000(mi,&#34;EOT&#34;,&#34;H--&gt;M&#34;) Q ret</span>
</span></span><span class="line"><span class="cl">  <span class="n">F</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">cr</span><span class="p">)</span> <span class="n">D</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="n">temstr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">S</span> <span class="n">temstr</span><span class="o">=</span><span class="n">i_temstr</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">I</span> <span class="n">i</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">temstr</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">247</span> <span class="n">D</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">S</span> <span class="n">str1</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">241</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">S</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">str2</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="mi">242</span><span class="p">,</span><span class="mi">482</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">S</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">str2</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="mi">483</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">temstr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">S</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">str2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">S</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">s</span> <span class="n">temstr</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">S</span> <span class="n">temstr</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="n">_temstr</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">S</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">E</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">  <span class="o">..</span><span class="n">S</span> <span class="n">ret</span><span class="o">=$$</span><span class="n">SEND</span><span class="p">(</span><span class="n">temstr</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">W</span> <span class="n">eot</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;EOT&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">SEND</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span>  <span class="p">;</span> <span class="n">send</span> <span class="n">string</span> <span class="n">to</span> <span class="n">instrument</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="n">flag</span><span class="o">=</span><span class="mi">1</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_etb</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">chsum</span><span class="o">=$$</span><span class="n">CHSUM</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="nb">str</span><span class="o">=</span><span class="n">str_cr_etx</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">s</span> <span class="n">chsum</span><span class="o">=$$</span><span class="n">CHSUM</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">W</span> <span class="n">stx</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="n">chsum</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">lf</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">stx_str_chsum_cr_lf</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">F</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span> <span class="n">R</span> <span class="o">*</span><span class="n">R</span><span class="p">:</span><span class="mi">1</span> <span class="n">I</span> <span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span><span class="p">)</span><span class="o">!</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span><span class="p">)</span> <span class="n">Q</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">ack</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span> <span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=</span><span class="n">eot</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;EOT&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span> <span class="n">Q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">I</span> <span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">=-</span><span class="mi">1</span> <span class="n">W</span> <span class="n">nak</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">Q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">CHSUM</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="p">;</span> <span class="n">calculate</span> <span class="n">check</span> <span class="n">sum</span>
</span></span><span class="line"><span class="cl">  <span class="n">n</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">s</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span> <span class="n">f</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">s</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+$</span><span class="n">a</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">z</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="s2">&#34;0123456789ABCDEF&#34;</span><span class="p">,</span><span class="n">z</span><span class="c1">#256\16+1)_$e(&#34;0123456789ABCDEF&#34;,z#16+1)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">ACK</span>  <span class="p">;</span> <span class="n">send</span> <span class="s1">&#39;ack&#39;</span> <span class="n">to</span> <span class="n">instrument</span>
</span></span><span class="line"><span class="cl">  <span class="n">w</span> <span class="n">ack</span><span class="p">,</span><span class="o">*-</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ACK&#34;</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="n">NEXTTRAY</span><span class="p">(</span><span class="n">tray</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  <span class="n">q</span> <span class="n">tray</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="o">///</span>  
</span></span><span class="line"><span class="cl"><span class="n">GetSpecType</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">;</span><span class="n">s</span> <span class="n">RetVal</span><span class="o">=</span><span class="s2">&#34;SE&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">RetVal</span><span class="o">=</span><span class="s2">&#34;Serum&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">SpecimenDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">),</span><span class="mi">56</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="n">SpecimenName</span> <span class="o">=</span> <span class="o">$</span><span class="n">s</span><span class="p">(</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpecimenDR</span><span class="p">):</span><span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpecimenD</span><span class="p">(</span><span class="n">SpecimenDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="n">SpecimenName</span><span class="p">[</span><span class="s2">&#34;血&#34;</span> <span class="n">s</span> <span class="n">RetVal</span><span class="o">=</span><span class="s2">&#34;Serum&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="n">SpecimenName</span><span class="p">[</span><span class="s2">&#34;尿&#34;</span> <span class="n">s</span> <span class="n">RetVal</span><span class="o">=</span><span class="s2">&#34;Urine&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="n">SpecimenName</span><span class="p">[</span><span class="s2">&#34;血浆&#34;</span> <span class="n">s</span> <span class="n">RetVal</span><span class="o">=</span><span class="s2">&#34;Plasma&#34;</span>	<span class="o">//</span><span class="n">YHR</span> <span class="mi">20230929</span> <span class="err">增加血浆代码</span>
</span></span><span class="line"><span class="cl">  <span class="n">q</span> <span class="n">RetVal</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">Log</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">N</span> <span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">mi</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">info</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$L(mi) 1</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span><span class="p">:</span><span class="s1">&#39;$D(^TMIF(mi)) 1</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">info</span><span class="p">,</span><span class="s2">&#34;DEBUG&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">curDate</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">curTime</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="o">$</span><span class="n">H</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="o">^</span><span class="n">TMPSIMENS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">curDate</span><span class="p">,</span><span class="n">curTime</span><span class="p">)</span><span class="o">=</span><span class="n">info</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="mi">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="通过数据库主动上传">通过数据库主动上传
</h3><h4 id="odbc连接数据库回插数据">ODBC连接数据库回插数据
</h4><h5 id="示例代码dl96a">示例代码(DL96A)
</h5><blockquote>
<p>通过数据库连接，在QryLabInfo中拼串sql语句.Insert into liscontroller.lis_application (SPEC_NUM,BTBarcode,ASTBarcode,PATIENT_ID,MSPosition,PatientNo,FULL_NAME,FIRST_NAME,LAST_NAME,Birth,AGE,SEX,Purpose,WARD,Specimen,BedNo,Diagnosis,SpRequest,Medication,SuspectedBact,Doctor,AdviceNo,ApplyDate,SendDate,Collector,SPEC_DATE,CollectPosition,IdResult,Updated,UpdateDate,CARSS_ReadDate,StainType,StructVersion) values<br>
&hellip;//(&lsquo;9999&rsquo;,&lsquo;NULL&rsquo;,&lsquo;NULL&rsquo;,&lsquo;199732&rsquo;,&lsquo;NULL&rsquo;,&rsquo; &lsquo;,&lsquo;测试&rsquo;,&lsquo;NULL&rsquo;,&lsquo;NULL&rsquo;,&rsquo;&rsquo;,&lsquo;85y&rsquo;,&lsquo;f&rsquo;,&lsquo;普通细菌培养+药敏&rsquo;,&lsquo;三病室&rsquo;,&lsquo;痰&rsquo;,&lsquo;3&rsquo;,&rsquo; &lsquo;,&rsquo; &lsquo;,&rsquo; &lsquo;,&rsquo; &lsquo;,&lsquo;刘云&rsquo;,&rsquo; &lsquo;,&lsquo;NULL&rsquo;,&lsquo;2024/6/28 9:17&rsquo;,&lsquo;谢艳红&rsquo;,&lsquo;2024/6/29 11:17&rsquo;,&rsquo; &lsquo;,&lsquo;NULL&rsquo;,&lsquo;0&rsquo;,&lsquo;NULL&rsquo;,&lsquo;NULL&rsquo;,&lsquo;NULL&rsquo;,&lsquo;NULL&rsquo;)</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span> <span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;DataBase&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;3000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;DSN=DL96A&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFDL96A&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;SELECT * FROM lis_result  WHERE DATE(UpdateDate) = CURDATE()#ID#&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;DataBase&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;3000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;DSN=DL96a&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFDL96A2&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;SELECT * FROM lis_result  WHERE DATE(UpdateDate) = CURDATE()#ID#&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">Class</span> <span class="n">MI</span><span class="o">.</span><span class="n">MIFDL96A</span> <span class="n">Extends</span> <span class="o">%</span><span class="n">RegisteredObject</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFDL96E02).fileMTHD(&#34;22&#34;,&#34;4185~33122416~~~□肺炎链球菌(S.pneumoniae)□G+球菌□□[spn]□(优势菌2)~~~~~A;PEN;;＝8;耐药;;B;CLI;;≥8;耐药;;A;SXT;;≥8/152;耐药;;B;CRO;;＝1;敏感;;A;ERY;;≥16;耐药;;B;VA;;≤1;敏感;;B;LEV;;＝2;敏感;;B;TET;;＝32;耐药;;B;MRP;;≤0.25;敏感;;C;CXM;;≥4;耐药;;C;RIF;;≤0.5;敏感;;C;AMC;;≤1.0/0.5;敏感;;C;LNZ;;≤2;敏感;;~~~~~对左氧氟沙星敏感的菌株可预报其对吉米沙星和莫西沙星敏感。[13][10]对四环素敏感的菌株对多西环素和米诺环素也敏感。[13][10]利福平不单独用于抗菌治疗。[13][10]红霉素可预报阿奇霉素、克拉霉素和地红霉素的敏感和耐药性。[13][10]~~~~普通细菌培养+药敏~2020-12-25□8:33:23~2020-12-27□8:33:23~1~&#34;,&#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">fileMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(record) q </span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ItemDeli</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span> 				<span class="o">//</span><span class="err">项目分隔符</span><span class="mi">92</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ResultDeli</span><span class="o">=$</span><span class="n">c</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span> 			<span class="o">//</span><span class="err">结果分隔符</span><span class="mi">44</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AntDeli</span><span class="o">=</span><span class="s2">&#34;]&#34;</span> 					<span class="o">//</span><span class="err">抗生素分隔符</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SenDeli</span><span class="o">=</span><span class="s2">&#34;[&#34;</span> 					<span class="o">//</span><span class="err">药敏结果分隔符</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;record&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">surname</span><span class="p">,</span><span class="n">rec</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">fresult</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">xBugs</span><span class="p">,</span><span class="n">AntLIST</span><span class="p">,</span><span class="n">expertRules</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">处理阴性结果</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;~&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">code</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">   	<span class="o">//</span><span class="mi">7417</span><span class="o">~</span><span class="mi">6987</span><span class="o">~</span><span class="mi">3259</span><span class="o">~</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="o">*</span><span class="err">□</span><span class="o">|~</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="o">*</span><span class="err">□</span><span class="o">|~~</span><span class="err">□</span><span class="p">,</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="err">大肠埃希菌</span><span class="p">(</span><span class="n">Escherichia</span><span class="err">□</span><span class="n">Coli</span><span class="p">),</span><span class="n">eco</span><span class="p">,</span><span class="o">-</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="err">□</span><span class="o">|~~</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">AMP</span><span class="p">,</span><span class="err">≥</span><span class="mi">32</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="o">&amp;</span><span class="mi">16</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">32</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">GEN</span><span class="p">,</span><span class="err">≤</span><span class="mi">1</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">2</span><span class="o">&amp;</span><span class="mi">4</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">8</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">SAM</span><span class="p">,</span><span class="mi">16</span><span class="o">/</span><span class="mi">8</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="o">/</span><span class="mi">4</span><span class="o">&amp;</span><span class="mi">16</span><span class="o">/</span><span class="mi">8</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">32</span><span class="o">/</span><span class="mi">16</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">TZP</span><span class="p">,</span><span class="err">≤</span><span class="mi">4</span><span class="o">/</span><span class="mi">4</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">16</span><span class="o">/</span><span class="mi">4</span><span class="o">&amp;</span><span class="mi">32</span><span class="o">/</span><span class="mi">4</span><span class="o">-</span><span class="mi">64</span><span class="o">/</span><span class="mi">4</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">128</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">CSL</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="o">/</span><span class="mi">4</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">16</span><span class="o">/</span><span class="mi">8</span><span class="o">&amp;</span><span class="mi">32</span><span class="o">/</span><span class="mi">16</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">64</span><span class="o">/</span><span class="mi">32</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">CCV</span><span class="p">,</span><span class="err">≤</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="err">□</span><span class="p">,</span><span class="err">□</span><span class="p">,</span><span class="err">□</span><span class="o">&amp;</span><span class="err">□</span><span class="o">&amp;</span><span class="err">□</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">CTC</span><span class="p">,</span><span class="err">≤</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="err">□</span><span class="p">,</span><span class="err">□</span><span class="p">,</span><span class="err">□</span><span class="o">&amp;</span><span class="err">□</span><span class="o">&amp;</span><span class="err">□</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">CZO</span><span class="p">,</span><span class="err">≤</span><span class="mi">2</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">2</span><span class="o">&amp;</span><span class="mi">4</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">8</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">FEP</span><span class="p">,</span><span class="err">≤</span><span class="mf">0.12</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">2</span><span class="o">&amp;</span><span class="mi">4</span><span class="o">-</span><span class="mi">8</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">16</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">FOX</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="o">&amp;</span><span class="mi">16</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">32</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">CXM</span><span class="p">,</span><span class="err">≤</span><span class="mi">4</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="o">&amp;</span><span class="mi">16</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">32</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">CXM</span><span class="p">,</span><span class="err">≤</span><span class="mi">4</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">4</span><span class="o">&amp;</span><span class="mi">8</span><span class="o">-</span><span class="mi">16</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">32</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">LVX</span><span class="p">,</span><span class="err">≤</span><span class="mf">0.12</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mf">0.5</span><span class="o">&amp;</span><span class="mi">1</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">2</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">SXT</span><span class="p">,</span><span class="err">≥</span><span class="mi">8</span><span class="o">/</span><span class="mi">152</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="err">≤</span><span class="mi">2</span><span class="o">/</span><span class="mi">38</span><span class="o">&amp;</span><span class="err">□</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">4</span><span class="o">/</span><span class="mi">76</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">CTX</span><span class="p">,</span><span class="err">≤</span><span class="mf">0.12</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">1</span><span class="o">&amp;</span><span class="mi">2</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">4</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">IPM</span><span class="p">,</span><span class="err">≤</span><span class="mf">0.25</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">1</span><span class="o">&amp;</span><span class="mi">2</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">4</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">CAZ</span><span class="p">,</span><span class="err">≤</span><span class="mf">0.5</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">4</span><span class="o">&amp;</span><span class="mi">8</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">16</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">CHL</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="o">&amp;</span><span class="mi">16</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">32</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">MEM</span><span class="p">,</span><span class="err">≤</span><span class="mf">0.06</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">1</span><span class="o">&amp;</span><span class="mi">2</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">4</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">AMK</span><span class="p">,</span><span class="err">≤</span><span class="mi">4</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">4</span><span class="o">&amp;</span><span class="mi">8</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">16</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">NIT</span><span class="p">,</span><span class="err">≤</span><span class="mi">16</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">32</span><span class="o">&amp;</span><span class="mi">64</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">128</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">ETP</span><span class="p">,</span><span class="err">≤</span><span class="mf">0.015</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mf">0.5</span><span class="o">&amp;</span><span class="mi">1</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">2</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">MNO</span><span class="p">,</span><span class="err">≤</span><span class="mi">1</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">4</span><span class="o">&amp;</span><span class="mi">8</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">16</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">TGC</span><span class="p">,</span><span class="err">≤</span><span class="mf">0.25</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="err">□</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">1</span><span class="o">&amp;</span><span class="mi">2</span><span class="o">&amp;&gt;</span><span class="mi">2</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">POL</span><span class="p">,</span><span class="err">≤</span><span class="mi">1</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="err">□</span><span class="o">&amp;</span><span class="err">≤</span><span class="mi">2</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">4</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">AZM</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="err">□</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="err">□</span><span class="o">&amp;</span><span class="err">□</span><span class="o">&amp;</span><span class="err">□</span><span class="p">,</span><span class="n">Y</span><span class="o">|~</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">MDR</span><span class="o">|~</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="o">*</span><span class="n">MDR</span><span class="err">：多重耐药菌株。</span><span class="o">*</span><span class="err">头孢西丁的折点基于至少</span><span class="mi">8</span><span class="n">g</span><span class="err">□</span><span class="n">qd的给药方案</span><span class="err">。</span><span class="o">*</span><span class="err">头孢吡肟的敏感折点基于</span><span class="mi">1</span><span class="n">g</span><span class="err">□</span><span class="n">q12h的给药方案</span><span class="err">。</span><span class="o">*</span><span class="err">亚胺培南的折点基于</span><span class="mi">500</span><span class="n">mg</span><span class="err">□</span><span class="n">q6h或1g</span><span class="err">□</span><span class="n">q8h的给药方案</span><span class="err">。</span><span class="o">*</span><span class="err">厄他培南的折点基于</span><span class="mi">1</span><span class="n">g</span><span class="err">□</span><span class="n">qd的给药方案</span><span class="err">。</span><span class="o">*</span><span class="err">多黏菌素</span><span class="n">B应与一种或多种活性抗生素联合使用</span><span class="err">，建议咨询感染诊治专家。</span><span class="o">*</span><span class="err">头孢呋辛（注射）的折点基于</span><span class="mf">1.5</span><span class="n">g</span><span class="err">□</span><span class="n">q8h的给药方案</span><span class="err">。</span><span class="o">*</span><span class="err">氨苄西林的结果可用于预报阿莫西林的敏感性。</span><span class="o">*</span><span class="err">环丙沙星折点基于静脉注射</span><span class="mi">400</span><span class="n">mg</span><span class="err">□</span><span class="n">q12h或口服500mg</span><span class="err">□</span><span class="n">q12h给药方案</span><span class="err">。</span><span class="o">*</span><span class="err">多黏菌素</span><span class="n">B应给予负荷剂量和最大推荐剂量</span><span class="err">。</span><span class="o">*</span><span class="err">治疗非复杂泌尿道以外感染的头孢唑林折点是基于</span><span class="mi">2</span><span class="n">g</span><span class="err">□</span><span class="n">q8h的给药方案</span><span class="err">。</span><span class="o">*</span><span class="err">头孢噻肟的折点基于</span><span class="mi">1</span><span class="n">g</span><span class="err">□</span><span class="n">q8h的给药方案</span><span class="err">。</span><span class="o">*</span><span class="err">美罗培南的折点基于</span><span class="mi">1</span><span class="n">g</span><span class="err">□</span><span class="n">q8h的给药方案</span><span class="err">。</span><span class="o">*</span><span class="err">对于肺炎即使黏菌素或多黏菌素</span><span class="n">B全身给药</span><span class="err">，亦很可能无效。</span><span class="o">*</span><span class="err">此报告采用的折点标准来源为</span><span class="n">CLSIM100</span><span class="err">□</span><span class="mi">2023</span><span class="err">，其中替加环素为</span><span class="n">EUCAST</span><span class="err">□</span><span class="mi">2018</span><span class="err">，头孢哌酮</span><span class="o">/</span><span class="err">舒巴坦为</span><span class="n">CHINET技术要求</span><span class="err">□</span><span class="mi">2022</span><span class="err">，哌拉西林</span><span class="o">/</span><span class="err">他唑巴坦为</span><span class="n">CLSIM100</span><span class="err">□</span><span class="mi">2021</span><span class="err">。</span><span class="o">|~~~~~</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="mi">2024</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">23</span><span class="err">□</span><span class="mi">09</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">15</span><span class="o">|~~~</span><span class="mi">1</span><span class="o">~</span><span class="mi">2024</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">23</span><span class="err">□</span><span class="mi">10</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">54</span><span class="o">~</span><span class="err">□</span><span class="o">~</span><span class="err">□</span><span class="p">,</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="err">大肠埃希菌</span><span class="p">(</span><span class="n">Escherichia</span><span class="err">□</span><span class="n">Coli</span><span class="p">),</span><span class="n">eco</span><span class="p">,</span><span class="n">G</span><span class="o">-</span><span class="err">杆菌</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="err">□</span><span class="o">|~</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">MDR</span><span class="o">|~~~~</span>
</span></span><span class="line"><span class="cl">    <span class="o">///</span><span class="err">□</span><span class="p">,</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="err">大肠埃希菌</span><span class="p">(</span><span class="n">Escherichia</span><span class="err">□</span><span class="n">Coli</span><span class="p">),</span><span class="n">eco</span><span class="p">,</span><span class="o">-</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="err">□</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">    <span class="o">///</span><span class="mi">7602</span><span class="o">~</span><span class="mi">0</span><span class="o">~</span><span class="mi">4786</span><span class="o">~~~~~</span><span class="p">,</span><span class="n">A2</span><span class="p">,</span><span class="err">兽类气单胞菌</span><span class="p">(</span><span class="n">Aeromonas</span><span class="err">□</span><span class="n">bestiarum</span><span class="p">),</span><span class="err">□</span><span class="p">,</span><span class="mf">44.12</span><span class="p">,</span><span class="err">□</span><span class="p">,</span><span class="n">aer</span><span class="p">,</span><span class="err">□</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="err">□</span><span class="o">|~~~~~~~~~~~</span><span class="mi">1</span><span class="o">~</span><span class="mi">2024</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">06</span><span class="err">□</span><span class="mi">16</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">22</span><span class="o">~~</span><span class="err">□</span><span class="p">,</span><span class="err">□</span><span class="p">,</span><span class="mi">4786</span><span class="o">+</span><span class="n">A2</span><span class="p">,</span><span class="err">兽类气单胞菌</span><span class="p">(</span><span class="n">Aeromonas</span><span class="err">□</span><span class="n">bestiarum</span><span class="p">),</span><span class="n">aer</span><span class="p">,</span><span class="o">-</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="err">□</span><span class="o">|~~~~~</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">s</span> <span class="n">xBugs</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;~&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;(&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">xBugs</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;~&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">xBugs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">6</span> <span class="n">s</span> <span class="n">xBugs</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;~&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">xBugs</span><span class="p">,</span><span class="s2">&#34;xBugs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">antStr</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;~&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">expertRules</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;~&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">),</span><span class="s2">&#34;*&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">*</span><span class="p">),</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">s</span> <span class="n">expertRules</span><span class="o">=$</span><span class="n">replace</span><span class="p">(</span><span class="n">expertRules</span><span class="p">,</span><span class="s2">&#34;*&#34;</span><span class="p">,</span><span class="s2">&#34;$r$n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">expertRules</span><span class="p">,</span><span class="s2">&#34;expertRules&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">expertRules</span><span class="p">[</span><span class="s2">&#34;*&#34;</span> <span class="n">s</span> <span class="n">expertRules</span><span class="o">=..</span><span class="n">RExpertRules</span><span class="p">(</span><span class="n">expertRules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">^</span><span class="n">DL96A</span><span class="p">(</span><span class="s2">&#34;ZJGZ&#34;</span><span class="p">,</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">code</span><span class="p">)</span><span class="o">=</span><span class="n">expertRules</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">antStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.//</span><span class="n">I</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2E10405500</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">E2</span><span class="p">,</span><span class="n">eco</span><span class="p">,</span><span class="n">AMP</span><span class="p">,</span><span class="err">≥</span><span class="mi">32</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">ml</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="o">&amp;</span><span class="mi">16</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">32</span><span class="p">,</span><span class="n">Y</span>
</span></span><span class="line"><span class="cl">    <span class="o">.//</span><span class="n">I</span><span class="o">-</span><span class="mi">2565</span><span class="p">,</span><span class="mi">2</span><span class="n">R10131374</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">STREP3</span><span class="p">,</span><span class="n">efa</span><span class="p">,</span><span class="n">AMP</span><span class="p">,</span><span class="o">=</span><span class="mf">0.5</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">mL</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="o">&amp;</span><span class="err">□</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">16</span><span class="p">,</span><span class="n">Y</span>
</span></span><span class="line"><span class="cl">    <span class="o">.//</span><span class="n">efa</span><span class="p">,</span><span class="n">AMP</span><span class="p">,</span><span class="o">=</span><span class="mf">0.5</span><span class="err">μ</span><span class="n">g</span><span class="o">/</span><span class="n">mL</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="err">≤</span><span class="mi">8</span><span class="o">&amp;</span><span class="err">□</span><span class="o">&amp;</span><span class="err">≥</span><span class="mi">16</span><span class="p">,</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">-</span><span class="mi">2565</span><span class="p">,</span><span class="mi">2</span><span class="n">R10131374</span><span class="p">,</span><span class="n">DL</span><span class="o">-</span><span class="mi">120</span><span class="err">□</span><span class="n">STREP3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">antList</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">antStr</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AntGroup</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">antList</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>  						<span class="o">//</span><span class="err">抗生素分组</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">xANT</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">antList</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span> <span class="n">q</span><span class="p">:</span><span class="n">xANT</span><span class="o">=</span><span class="s2">&#34;&#34;</span> 		<span class="o">//</span><span class="err">抗生素</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">xMIC</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">antList</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="s2">&#34;μg/ml &#34;</span><span class="p">)</span> 			<span class="o">//</span><span class="n">MIC</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">xRES</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">antList</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="s2">&#34; &#34;</span><span class="p">)</span> 					<span class="o">//</span><span class="err">耐药</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="n">xRES</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">s</span> <span class="n">xRES</span><span class="o">=</span><span class="s2">&#34;/&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AntLIST</span><span class="o">=</span><span class="n">AntLIST_xANT_AntDeli_xRES_AntDeli_xMIC_AntDeli_AntDeli_AntGroup_SenDeli</span> 
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">AntLIST</span><span class="p">,</span><span class="s2">&#34;AntLIST&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">xBugs</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AntLIST</span><span class="p">)</span> <span class="n">d</span> 
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">fresult</span><span class="o">=</span><span class="n">xBugs_ItemDeli_AntLIST_ItemDeli_code_ResultDeli</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">fresult</span><span class="p">,</span><span class="s2">&#34;fresult&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(fresult) q 0</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(epis) q 0</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">Save</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">code_ItemDeli_xBugs_ItemDeli_ItemDeli_ItemDeli_ResultDeli</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">SaveAnt</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">fresult</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">h</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">s</span> <span class="n">ret</span><span class="o">=..</span><span class="n">SaveZJGZ</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">expertRules</span><span class="p">)</span>   <span class="o">//</span><span class="err">对于专家规则在同表的，保证药敏结果先存生成报告，再存专家规则</span> <span class="mi">0704</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">ret</span><span class="p">,</span><span class="s2">&#34;专家规则保存ret&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">fresult</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">,</span><span class="n">AntLIST</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFDL96A2).RExpertRules(&#34;sadsa*da*dasds*sad &#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="mi">20240802</span>    <span class="err">格式化专家规则</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">RExpertRules</span><span class="p">(</span><span class="n">expertRules</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">expertRules</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">expertRules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">expertRules</span><span class="p">[</span><span class="s2">&#34;*&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">expertRules</span><span class="o">=</span><span class="s2">&#34;1、&#34;</span><span class="n">_expertRules</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">expertRules</span><span class="p">,</span><span class="s2">&#34;*&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">expertRules</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">expertRules</span><span class="p">,</span><span class="s2">&#34;*&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_i_</span><span class="s2">&#34;、&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">expertRules</span><span class="p">,</span><span class="s2">&#34;*&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">expertRules</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">保存专家规则</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="mi">20240704</span> 
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFDL96A2).SaveZJGZ(&#34;6633&#34;,&#34;40&#34;,1,&#34;多黏菌素B应与一种或多种活性抗生素联合使用，建议咨询感染诊治专家。*头孢噻肟的折点基于1g□q8h的给药方案。*亚胺培南的折点基于500mg□q6h或1g□q8h的给药方案。*美罗培南的折点基于1g□q8h的给药方案。*头孢唑啉的结果可预报非复杂性的泌尿系统感染的大肠埃希菌对口服头孢拉定、头孢地尼、头孢克罗、头孢丙烯、头孢泊肟、头孢呋辛的敏感性。*头孢西丁的折点基于至少8g□qd的给药方案。*仅肠沙门菌伤寒血清型和志贺菌属具有阿奇霉素的临床推荐折点。*氨苄西林的结果可用于预报阿莫西林的敏感性。*环丙沙星折点基于静脉注射400mg□q12h或口服500mg□q12h给药方案。*头孢吡肟的敏感折点基于1g□q12h的给药方案。*头孢呋辛（注射）的折点基于1.5g□q8h的给药方案。*治疗非复杂泌尿道感染的头孢唑林折点是基于1g□q12h的给药方案。*治疗非复杂泌尿道以外感染的头孢唑林折点是基于2g□q8h的给药方案。*多黏菌素B应给予负荷剂量和最大推荐剂量。*厄他培南的折点基于1g□qd的给药方案。*对于肺炎即使黏菌素或多黏菌素B全身给药，亦很可能无效。&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveZJGZ</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">isolate</span><span class="p">,</span> <span class="n">ExpertRules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="o">^</span><span class="n">GYN</span><span class="p">(</span><span class="s2">&#34;Rule&#34;</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">isolate</span><span class="p">,</span> <span class="n">ExpertRules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">//</span><span class="n">TestCodeDR</span> <span class="err">细菌一，细菌二，细菌三</span> <span class="mi">570</span><span class="p">,</span><span class="mi">586</span><span class="p">,</span><span class="mi">575</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">ExpertRules</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ExpertRules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">TestCodeDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">isolate</span><span class="o">=</span><span class="mi">1</span> <span class="n">s</span> <span class="n">TestCodeDR</span><span class="o">=</span><span class="mi">261</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(mi) q 0</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(epis) d Trace^MI.MIF000(mi,&#34;流水号不能为空&#34;,&#34;保存检测结论返回&#34;)  q 0</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">报告可能核收到微生物培养的四个小组</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WGM</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexMicNo&#34;</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="s2">&#34; &#34;</span><span class="n">_epis</span><span class="p">))</span> <span class="n">s</span> <span class="n">WGM</span><span class="o">=</span><span class="mi">15</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(WGM) q 0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">transmitDate</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">transmitDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexMicNo&#34;</span><span class="p">,</span><span class="n">WGM</span><span class="p">,</span><span class="s2">&#34; &#34;</span><span class="n">_epis</span><span class="p">,</span><span class="n">transmitDate</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">transmitDate</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexMicNo&#34;</span><span class="p">,</span><span class="n">WGM</span><span class="p">,</span><span class="s2">&#34; &#34;</span><span class="n">_epis</span><span class="p">,</span><span class="n">transmitDate</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span> 
</span></span><span class="line"><span class="cl">	<span class="o">..//</span><span class="n">IndexReportItem</span> <span class="n">On</span> <span class="p">(</span><span class="n">VisitNumberReportDR</span><span class="p">,</span> <span class="n">TestCodeDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberReportResultI(&#34;IndexReportItem&#34;,ReportDR,TestCodeDR)) q</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">ResultDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportResultI</span><span class="p">(</span><span class="s2">&#34;IndexReportItem&#34;</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">,</span><span class="n">TestCodeDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">objRep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReportResult).%OpenId(ResultDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">EXPRlues</span><span class="o">=</span><span class="n">objRep</span><span class="o">.</span><span class="n">ExpertRule</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="n">EXPRlues</span><span class="o">=</span><span class="n">ExpertRules</span> <span class="n">q</span>  <span class="o">//</span><span class="err">专家规则不再变化，不存</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">objRep</span><span class="o">.</span><span class="n">ExpertRule</span><span class="o">=</span><span class="n">ExpertRules</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objRep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) d Trace^MI.MIF000(mi,&#34;保存检测结论失败&#34;,&#34;保存检测结论失败返回&#34;) q</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">ExpertRules</span><span class="p">,</span><span class="s2">&#34;保存检测结论成功返回&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">sc</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFDL96E02).SaveExpertRules(&#34;26&#34;, &#34;52772&#34;,&#34;ceshi&#34;, &#34;1&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveExpertRules</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">expertRules</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">expertRules</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">expertRules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">code</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">AcceptDate</span><span class="p">,</span><span class="n">ReportDr</span><span class="p">,</span><span class="n">TestCodeDR</span><span class="p">,</span><span class="n">ReportResultDR</span><span class="p">,</span><span class="n">CodeDR</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">b</span> <span class="p">;</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AcceptDate</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AcceptDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexAcceptDate&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">AcceptDate</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">AcceptDate</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ReportDr</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">ReportDr</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexAcceptDate&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">AcceptDate</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(epis),ReportDr)) q:ReportDr=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">TestCodeDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">TestCodeDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportResultI</span><span class="p">(</span><span class="s2">&#34;IndexReportItem&#34;</span><span class="p">,</span><span class="n">ReportDr</span><span class="p">,</span><span class="n">TestCodeDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">TestCodeDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">ReportResultDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">ReportResultDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportResultI</span><span class="p">(</span><span class="s2">&#34;IndexReportItem&#34;</span><span class="p">,</span><span class="n">ReportDr</span><span class="p">,</span><span class="n">TestCodeDR</span><span class="p">,</span><span class="n">ReportResultDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">ReportResultDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">....</span><span class="n">s</span> <span class="n">CodeDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportResultD</span><span class="p">(</span><span class="n">ReportResultDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">....</span><span class="n">b</span> <span class="p">;</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="o">....</span><span class="n">i</span> <span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="mi">655</span><span class="o">=</span><span class="n">CodeDR</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.....//</span><span class="n">b</span> <span class="p">;</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="o">.....</span><span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReportResult).%OpenId(ReportResultDR)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.....</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">ExpertRule</span><span class="o">=</span><span class="n">expertRules</span>
</span></span><span class="line"><span class="cl">    <span class="o">.....</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFLISMonitorTest)SaveImageMTHD(&#34;7&#34;,&#34;9999&#34;, &#34;&#34;,&#34;175&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">mi</span><span class="p">:</span><span class="err">仪器</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">epis</span><span class="err">：流水号，如果是监听图片模式该位置放图片名称，自己在保存前提取流水</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">ImageClass</span><span class="p">:</span><span class="err">图片类别，如果是监听图片模式该位置放图片名称，自己在保存前提取图片类型</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">FileName</span><span class="p">:</span><span class="err">保存在文件服务的相对路径，默认不动</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">FullName</span><span class="p">:</span><span class="err">文件全路径，如果是监听图片模式该位置放图片全路径名称，满足有的图片名称无法得到流水和图片类别的情况</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveImageMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">ImageClass</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">FullName</span><span class="p">,</span> <span class="n">SaveImageRetName</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">通过</span><span class="n">OtherPara配置取图的在这里通过epis和ImageClass的图片名字提取出流水号和图片类别</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ImageClass</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ImageClass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FileName</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FullName</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">FullName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SaveImageRetName</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">SaveImageRetName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="c1">##Class(MI.Common.MIFBase).Trace(mi,epis_&#34;:&#34;_ImageClass_&#34;:&#34;_FileName,&#34;H&lt;--M&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span> <span class="n">ImageOrder</span><span class="p">,</span> <span class="n">Caption</span><span class="p">,</span> <span class="n">DisplayRatio</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">加上当前时间，防止浏览器缓存</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">FileName</span><span class="o">=</span><span class="n">FileName_</span><span class="s2">&#34;?&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">OtherPara用</span><span class="o">^</span><span class="err">分隔第四位指定</span><span class="n">SaveImageRetName的话在这里改FileName为新名称</span><span class="err">。同时让方法返回新图片名字</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">NewFileName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">SaveImageRetName</span><span class="o">=</span><span class="s2">&#34;SaveImageRetName&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.//</span><span class="err">图片新名字</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="p">;</span><span class="n">s</span> <span class="n">NewFileName</span><span class="o">=</span><span class="n">epis_</span><span class="s2">&#34;-&#34;</span><span class="n">_ImageClass_</span><span class="s2">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.//</span><span class="err">路径新名字</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">NewPathName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">SPLen</span><span class="o">=$</span><span class="n">l</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">f</span> <span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">SPLen</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">ii</span><span class="o">&lt;</span><span class="n">SPLen</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">NewPathName</span><span class="o">=</span><span class="n">NewPathName_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="n">ii</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;/&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">ii</span><span class="o">=</span><span class="n">SPLen</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">NewFileName</span><span class="o">=</span><span class="n">NewFileName_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">,</span><span class="n">ii</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">NewPathName</span><span class="o">=</span><span class="n">NewPathName_NewFileName</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">FileName</span><span class="o">=</span><span class="n">NewPathName</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">最后返回</span><span class="n">NewFileName</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">返回值控制图片名称模式</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">SaveImageRetName</span><span class="o">=</span><span class="s2">&#34;SaveImageRetName&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">NewFileName</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">返回给监听当前上传文件路径名称，默认不要动</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFLISMonitorTest).GetFtpMTHD(&#34;7&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">mi</span><span class="p">:</span><span class="err">仪器</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetFtpMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">文件服务模式必须改的地方，老的</span><span class="n">FTP模式这么改了也没问题</span><span class="err">，所以建议都这样</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="c1">##Class(MI.Common.MIFBase).GetMiFtpPath(mi)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Creator</span><span class="err">：</span>      <span class="err">查询患者信息，监听配置上传前处理类后会定时调用这个</span><span class="n">query查询数据进行上传操作</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">CreatDate</span><span class="err">：</span>    <span class="mi">20140919</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="p">:</span><span class="err">：</span> 
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>    
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="n">mi</span><span class="err">：仪器主键</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Others</span><span class="err">：</span>   
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">QryLabInfo</span><span class="p">(</span><span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Query</span><span class="p">(</span><span class="n">ROWSPEC</span> <span class="o">=</span> <span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Query的执行方法</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(%ResultSet).RunQuery(&#34;MI.MIFDL96A&#34;,&#34;QryLabInfo&#34;,&#34;56&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoExecute</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">i</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">flag</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">LabnoList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">控制输出</span><span class="n">Excel</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(&#34;D:\\OUT\\上传.xls&#34;,&#34;张三[0][1]男[0][1]28岁[0][1]&#34;_$h,&#34;900001&#34;,&#34;1&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">Set</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">控制输出</span><span class="n">Excel</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">查最近</span><span class="mi">8</span><span class="err">天</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="mi">20</span><span class="err">秒以内的先不上传，防止没接收完</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="p">(</span><span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)),((</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">AddTime</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">测试类型</span><span class="mi">0</span><span class="err">：文本，</span><span class="mi">1</span><span class="err">：数据库</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">文本双向上传开始</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;^&#34;</span><span class="n">_chl</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo($zd($h,8)_labno_&#34;.order&#34;,txtInfo,labno,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">labno</span><span class="o">=</span><span class="n">labnoOld_</span><span class="s2">&#34;^&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_labno_</span><span class="s2">&#34;.ok&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo($zd($h,8)_labno_&#34;.ok&#34;,txtInfo,labno,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">文本双向上传结束</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">数据库双向上传开始</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">控制执行</span><span class="n">sql</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="n">Insert</span> <span class="n">into</span> <span class="n">liscontroller</span><span class="o">.</span><span class="n">lis_application</span> <span class="p">(</span><span class="n">SPEC_NUM</span><span class="p">,</span><span class="n">BTBarcode</span><span class="p">,</span><span class="n">ASTBarcode</span><span class="p">,</span><span class="n">PATIENT_ID</span><span class="p">,</span><span class="n">MSPosition</span><span class="p">,</span><span class="n">PatientNo</span><span class="p">,</span><span class="n">FULL_NAME</span><span class="p">,</span><span class="n">FIRST_NAME</span><span class="p">,</span><span class="n">LAST_NAME</span><span class="p">,</span><span class="n">Birth</span><span class="p">,</span><span class="n">AGE</span><span class="p">,</span><span class="n">SEX</span><span class="p">,</span><span class="n">Purpose</span><span class="p">,</span><span class="n">WARD</span><span class="p">,</span><span class="n">Specimen</span><span class="p">,</span><span class="n">BedNo</span><span class="p">,</span><span class="n">Diagnosis</span><span class="p">,</span><span class="n">SpRequest</span><span class="p">,</span><span class="n">Medication</span><span class="p">,</span><span class="n">SuspectedBact</span><span class="p">,</span><span class="n">Doctor</span><span class="p">,</span><span class="n">AdviceNo</span><span class="p">,</span><span class="n">ApplyDate</span><span class="p">,</span><span class="n">SendDate</span><span class="p">,</span><span class="n">Collector</span><span class="p">,</span><span class="n">SPEC_DATE</span><span class="p">,</span><span class="n">CollectPosition</span><span class="p">,</span><span class="n">IdResult</span><span class="p">,</span><span class="n">Updated</span><span class="p">,</span><span class="n">UpdateDate</span><span class="p">,</span><span class="n">CARSS_ReadDate</span><span class="p">,</span><span class="n">StainType</span><span class="p">,</span><span class="n">StructVersion</span><span class="p">)</span> <span class="n">values</span> 
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="p">(</span><span class="s1">&#39;9999&#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="s1">&#39;199732&#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;测试&#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;85y&#39;</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="s1">&#39;普通细菌培养+药敏&#39;</span><span class="p">,</span><span class="s1">&#39;三病室&#39;</span><span class="p">,</span><span class="s1">&#39;痰&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;刘云&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="s1">&#39;2024/6/28 9:17&#39;</span><span class="p">,</span><span class="s1">&#39;谢艳红&#39;</span><span class="p">,</span><span class="s1">&#39;2024/6/29 11:17&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">PatInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;PatInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="mi">16</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">48</span><span class="p">,</span><span class="n">Mejer600</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">2406290091</span><span class="p">,,,</span><span class="n">mnwk</span><span class="o">-</span><span class="err">泌尿外科</span><span class="p">,</span><span class="err">刘乐</span><span class="p">,</span><span class="err">唐云</span><span class="p">,</span><span class="mi">0000628089</span><span class="p">,</span><span class="err">周田香</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="err">住院</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">43</span><span class="p">,,</span><span class="mi">2406290091</span><span class="p">,</span><span class="mi">2024</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">29</span> <span class="mi">11</span><span class="p">:</span><span class="mi">15</span><span class="p">,,,,,</span><span class="err">肾积水伴肾输尿管结石</span><span class="p">,,,,</span><span class="mi">2024</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">29</span> <span class="mi">06</span><span class="p">:</span><span class="mi">48</span><span class="p">,,</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">EPIS</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span>   <span class="o">//</span><span class="err">鉴定号</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">DTTime</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span>   <span class="o">//</span><span class="err">核收时间</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Name</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>   <span class="o">//</span><span class="err">姓名</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Sex</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>   <span class="o">//</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;m&#34;</span> 
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;f&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>   <span class="o">//</span><span class="err">年龄</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">MediNo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">29</span><span class="p">)</span>   <span class="o">//</span><span class="err">病案号</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Location</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>   <span class="o">//</span><span class="err">科室</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="n">Location</span><span class="p">[</span><span class="s2">&#34;-&#34;</span> <span class="n">s</span> <span class="n">Location</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">Location</span><span class="p">,</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">//</span><span class="n">jzwkszwk</span><span class="o">-</span><span class="err">脊柱外科</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Speciman</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">30</span><span class="p">)</span>   <span class="o">//</span><span class="err">标本类型</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>   <span class="o">//</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Doctor</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>   <span class="o">//</span><span class="err">医生</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">CollectUser</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">PatInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>   <span class="o">//</span><span class="err">采集者</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="n">s</span> <span class="n">DTTime</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="s2">&#34;/&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>  <span class="o">//</span><span class="mi">2024</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span><span class="mi">28</span> <span class="mi">9</span><span class="p">:</span><span class="mi">17</span>   <span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">*-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">SqlStr</span><span class="o">=</span><span class="s2">&#34;Insert into liscontroller.lis_application (SPEC_NUM,BTBarcode,ASTBarcode,PATIENT_ID,MSPosition,PatientNo,FULL_NAME,FIRST_NAME,LAST_NAME,Birth,AGE,SEX,Purpose,WARD,Specimen,BedNo,Diagnosis,SpRequest,Medication,SuspectedBact,Doctor,AdviceNo,ApplyDate,SendDate,Collector,SPEC_DATE,CollectPosition,IdResult,Updated,UpdateDate,CARSS_ReadDate,StainType,StructVersion) values &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">ValueStr</span><span class="o">=</span><span class="s2">&#34;(&#39;&#34;</span><span class="n">_EPIS_</span><span class="s2">&#34;&#39;,&#39;NULL&#39;,&#39;NULL&#39;,&#39;&#34;</span><span class="n">_MediNo_</span><span class="s2">&#34;&#39;,&#39;NULL&#39;,&#39; &#39;,&#39;&#34;</span><span class="n">_Name_</span><span class="s2">&#34;&#39;,&#39;NULL&#39;,&#39;NULL&#39;,&#39;&#39;,&#39;&#34;</span><span class="n">_Age_</span><span class="s2">&#34;&#39;,&#39;&#34;</span><span class="n">_Sex_</span><span class="s2">&#34;&#39;,&#39;普通细菌培养+药敏&#39;,&#39;&#34;</span><span class="n">_Location_</span><span class="s2">&#34;&#39;,&#39;&#34;</span><span class="n">_Speciman_</span><span class="s2">&#34;&#39;,&#39;&#34;</span><span class="n">_BedNo_</span><span class="s2">&#34;&#39;,&#39; &#39;,&#39; &#39;,&#39; &#39;,&#39; &#39;,&#39;&#34;</span><span class="n">_Doctor_</span><span class="s2">&#34;&#39;,&#39; &#39;,&#39;NULL&#39;,&#39;&#34;</span><span class="n">_DTTime_</span><span class="s2">&#34;&#39;,&#39;&#34;</span><span class="n">_CollectUser_</span><span class="s2">&#34;&#39;,&#39;&#34;</span><span class="n">_DTTime_</span><span class="s2">&#34;&#39;,&#39; &#39;,&#39;NULL&#39;,&#39;0&#39;,&#39;NULL&#39;,&#39;NULL&#39;,&#39;NULL&#39;,&#39;NULL&#39;)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">SqlStr</span><span class="o">=</span><span class="n">SqlStr_ValueStr</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">SqlStr</span><span class="p">,</span><span class="s2">&#34;SqlStr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="o">^</span><span class="n">DL96</span><span class="p">(</span><span class="s2">&#34;Send&#34;</span><span class="p">,</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span>  <span class="o">//</span><span class="err">上传标识置为</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">多条命令组装多个</span><span class="n">SQL语句输出</span><span class="o">.</span><span class="n">SQL包含</span><span class="o">$</span><span class="n">StoredProcedure就当存储过程执行</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutDBInfo(&#34;DSN=DL96A&#34;,SqlStr,labno)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">数据库双向上传结束</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ColFields</span><span class="o">=</span><span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span><span class="o">=</span><span class="c1">##Class(LIS.Util.Common).TransListNull(Data,ColFields)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">quit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoClose</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Kill</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoFetch</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">Row</span> <span class="n">As</span> <span class="o">%</span><span class="n">List</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">AtEnd</span> <span class="n">As</span> <span class="o">%</span><span class="n">Integer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">If</span> <span class="n">ind</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Else</span>      <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">AtEnd</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">获取项目通道号</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_chl_</span><span class="s2">&#34;+&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">tcx</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span> <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_tcx_</span><span class="s2">&#34;|&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">tcx</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFDL96A2).GetEPIS(&#34;40&#34;,&#34;2407210719&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">IndexReportID</span> <span class="n">On</span> <span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">,</span> <span class="n">WorkGroupMachineDR</span><span class="p">,</span> <span class="n">OrderNo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">labno</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">EPIS</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">WGMDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WGMDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WGMDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">EPIS</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AcceptDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AcceptDate</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">AcceptDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">AcceptDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">AcceptDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AcceptTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">AcceptDT</span><span class="o">=</span><span class="n">AcceptDate_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">AcceptTime</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">EPIS_</span><span class="s2">&#34;^&#34;</span><span class="n">_AcceptDT</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFDL96A2).GetPatInfo(&#34;40&#34;,&#34;L0116440&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">labno</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">标本信息</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">TransmitDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RPVisitNumberData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">IndexEpisodeNo</span> <span class="n">On</span> <span class="p">(</span><span class="n">TransmitDate</span><span class="p">,</span> <span class="n">WorkGroupMachineDR</span><span class="p">,</span> <span class="n">EpisodeNo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">MedicalRecordNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">SpecimenDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">Specimen</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">EPIS</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">MedicalRecordNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>   <span class="o">//</span><span class="err">病案号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SpecimenDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">56</span><span class="p">)</span>       <span class="o">//</span><span class="err">标本类型</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">EPIS</span><span class="o">=..</span><span class="n">GetEPIS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span>                  <span class="o">//</span><span class="err">鉴定号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AcceptDT</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">EPIS</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">EPIS</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">EPIS</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpecimenDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Specimen</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpecimenD</span><span class="p">(</span><span class="n">SpecimenDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">LocationDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">),</span><span class="n">Location</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Location</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">Location</span><span class="p">[</span><span class="s2">&#34;ICU&#34;</span> <span class="n">s</span> <span class="n">Location</span><span class="o">=</span><span class="s2">&#34;重症监护室&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">DoctorDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">Doctor</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Doctor</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDoctorD</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReceiveUserDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">68</span><span class="p">),</span><span class="n">ReceiveUser</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">ReceiveUser</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">SYSUserD</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RegNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SurName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">GivenName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">SurName</span><span class="o">=</span><span class="n">GivenName</span> <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName_GivenName</span>  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">SpeciesDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span><span class="n">Species</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AdmTypeDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">AdmType</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AdmType</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAdmissionTypeD</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AgeUnitDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span><span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">AgeUnitDR</span><span class="o">=</span><span class="mi">1</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;y&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">AgeUnitDR</span><span class="o">=</span><span class="mi">2</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;m&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">AgeUnitDR</span><span class="o">=</span><span class="mi">3</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;d&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">AgeUnitDR</span><span class="o">=</span><span class="mi">4</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;h&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAgeUnitD</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">Age</span><span class="o">=</span><span class="n">Age_AgeUnit</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">CollectDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">51</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">CollectTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Diagnose</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;，&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampleda</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Instrument</span> <span class="o">=</span> <span class="s2">&#34;XN&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">s</span> <span class="n">Instrument</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampleno</span><span class="o">=</span><span class="n">labno</span>   <span class="o">//</span><span class="err">检测号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sampletype</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Feetype</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">;</span><span class="err">费别</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Srcdepno</span><span class="o">=</span><span class="n">Location</span>  <span class="p">;</span><span class="err">送检科室</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Srcdocno</span><span class="o">=</span><span class="n">Doctor</span>   <span class="p">;</span><span class="err">送检医生</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Userno</span><span class="o">=</span><span class="n">ReceiveUser</span> <span class="p">;</span><span class="err">检验医生</span><span class="p">(</span><span class="err">录入者</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patno</span><span class="o">=</span><span class="n">RegNo</span> <span class="p">;</span><span class="err">登记号</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">BarCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patna</span><span class="o">=</span><span class="n">PatName</span>   <span class="p">;</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="mi">1</span>  <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;男&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>     <span class="p">;</span><span class="mi">1</span><span class="p">:</span><span class="err">男</span> <span class="err">，</span><span class="mi">2</span> <span class="err">女</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">Species</span> <span class="o">=</span><span class="s2">&#34;女&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Pattype</span><span class="o">=</span><span class="n">AdmType</span>   <span class="p">;</span><span class="err">病人类型</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Bedno</span> <span class="o">=</span> <span class="n">BedNo</span>    <span class="p">;</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patage</span><span class="o">=</span><span class="n">Age</span>  <span class="p">;</span><span class="err">年龄</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Ageunit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">年龄单位</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reqno</span><span class="o">=</span><span class="n">labno</span>  <span class="p">;</span><span class="err">申请号</span> <span class="o">=</span> <span class="err">检验号</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reqda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Reqda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">ReceiveTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span><span class="err">送检日期</span> <span class="o">=</span> <span class="err">接收时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reportda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">报告日期</span>  <span class="o">=</span> <span class="err">初审</span><span class="p">(</span><span class="err">保存结果</span><span class="p">)</span><span class="err">时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Printflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">打印标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Resultflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">结果标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Errflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">错误标志</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Diagnose</span> <span class="o">=</span> <span class="n">Diagnose</span>   <span class="p">;</span><span class="err">诊断</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Description</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">备注</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Reserve</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">保留字段</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Patnamn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">姓名拼音码</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Getda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">CollectTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">s</span> <span class="n">Getda</span><span class="o">=</span><span class="n">Reqda</span> <span class="p">;</span><span class="err">接收时间</span><span class="o">/</span><span class="err">采样日期</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Wardno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">病区</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">Sampleda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Instrument_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampleno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sampletype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Feetype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdepno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Srcdocno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Userno_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patna_</span><span class="s2">&#34;,&#34;</span><span class="n">_Sex_</span><span class="s2">&#34;,&#34;</span><span class="n">_Pattype_</span><span class="s2">&#34;,&#34;</span><span class="n">_Bedno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Patage_</span><span class="s2">&#34;,&#34;</span><span class="n">_Ageunit_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqno_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reqda_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Reportda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Printflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Resultflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Errflag_</span><span class="s2">&#34;,&#34;</span><span class="n">_Diagnose_</span><span class="s2">&#34;,&#34;</span><span class="n">_Description_</span><span class="s2">&#34;,&#34;</span><span class="n">_Reserve_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_Patnamn_</span><span class="s2">&#34;,&#34;</span><span class="n">_Getda_</span><span class="s2">&#34;,&#34;</span><span class="n">_Wardno_</span><span class="s2">&#34;,&#34;</span><span class="n">_BarCode_</span><span class="s2">&#34;,&#34;</span><span class="n">_MedicalRecordNo_</span><span class="s2">&#34;,&#34;</span><span class="n">_Specimen_</span><span class="s2">&#34;,&#34;</span><span class="n">_EPIS_</span><span class="s2">&#34;,&#34;</span><span class="n">_AcceptDT</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">RetString</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">监听做上传操作后调用改方法设置标本上传表状态</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveSDFMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">epis</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="n">filename</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="" ></a></p>

</section>


    <footer class="article-footer">
    <section>
        页面浏览量<span id="busuanzi_value_page_pv">Loading</span>
    </section>
</footer>


    
</article>

<div class="post-password">
	
</div>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E4%BB%AA%E5%99%A8%E5%85%AC%E5%85%B1%E6%96%B9%E6%B3%95-648d4901f4/">
        
        
            <div class="article-image">
                <img src="/p/%E4%BB%AA%E5%99%A8%E5%85%AC%E5%85%B1%E6%96%B9%E6%B3%95-648d4901f4/assets/image-20250813195117-i4t8mzw.514ebadd6aa316fd35a7a0649a9afb40_hu_cdb4225cba05a436.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 仪器公共方法"
                        data-key="仪器公共方法 648d4901f4" 
                        data-hash="md5-UU663WqjFv01p6Bkmpr7QA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">仪器公共方法</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%BB%AA%E5%99%A8%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-d32f758247/">
        
        
            <div class="article-image">
                
                    <img src="/img/title.jpg" loading="lazy" data-key="仪器报警信息 d32f758247" data-hash="/img/title.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">仪器报警信息</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E9%80%9A%E7%94%A8%E4%BC%A0%E8%BE%93%E6%8E%A5%E5%8F%A3-5ce4a28788/">
        
        
            <div class="article-image">
                
                    <img src="/img/title.jpg" loading="lazy" data-key="通用传输接口 5ce4a28788" data-hash="/img/title.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">通用传输接口</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%B8%87%E6%B3%B0wan200-da9f234969/">
        
        
            <div class="article-image">
                
                    <img src="/img/title.jpg" loading="lazy" data-key="万泰WAN200 da9f234969" data-hash="/img/title.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">万泰WAN200</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%B8%AD%E5%85%83%E5%B0%BF%E6%9C%BA1600-fe923b78ec/">
        
        
            <div class="article-image">
                
                    <img src="/img/title.jpg" loading="lazy" data-key="中元尿机1600 fe923b78ec" data-hash="/img/title.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">中元尿机1600</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"lang":"zh-CN","locale":{"admin":"Admin","placeholder":null},"requiredMeta":["name","email","url"],"serverURL":"https://waline.717170.xyz"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 muziyang
    </section>
    
    <section class="powerby">
        
            网站总访客数：<span id='busuanzi_value_site_uv'>Loading</span><br/>网站总访问量：<span id='busuanzi_value_site_pv'>Loading</span> <br/>
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>


<script defer src="https://cn.vercount.one/js"></script>

    </body>
</html>

<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="接口说明 仪器厂商 罗氏流水线RS600\n仪器型号 罗氏流水线RS600\n通讯方式 单向|双向|主动上传☑\n仪器类型 医院名称 程序名称 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：串口|网口|监听文件☑|数据库|其他 连接方式：HL7协议|ASTM协议|监听文件☑|数据库|其他 仪器接口说明 对于数据上传增加业务内容修改，仅作参考 串口盒子配置 波特率： 9600 数据位：8 停止位： 1 校验位： N 仪器图片 仪器配置 数据格式 项目通道号 修改记录 序号 日期 操作人 说明 1 2025-08-29 14:23:27\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;Z:\\\\ResultExport\\\\&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFLICA800&#34;,&#34;Para&#34;:&#34;.csv&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UpPara&#34;:&#34;Z:\\\\Imports\\\\&#34;}] Class MI.MIFRS600 Extends %RegisteredObject { /// D ##class(MI.MIFInfinity).fileMTHD(&#34;7&#34;,&#34;MSH|^~\\&amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#&#34;,&#34;&#34;) /// seen: [VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR] /// result: [VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR] /// D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;&#34;,&#34;&#34;) /// seen: D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]&#34;,&#34;&#34;) /// result:D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]&#34;,&#34;&#34;) ClassMethod fileMTHD(mi, record, epis, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;0&#34; s HospitalDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),4) i &#39;$l(record) q &#34;0&#34; i &#39;$d(^TMPLIS(&#34;RS600&#34;,mi,&#34;ERR&#34;)) s ^TMPLIS(&#34;RS600&#34;,mi,&#34;ERR&#34;)=&#34;&#34; d Trace^MI.MIF000(mi,record,&#34;H&lt;--M&#34;) s miold=mi s recordbak=record //仪器临时结果映射 s TMPMachResMap=&#34;&#34; //解析多行合并数据 f i=1:1:$l(recordbak,&#34;#enter#&#34;) d .s record=$p(recordbak,&#34;#enter#&#34;,i) .d Trace^MI.MIF000(mi,&#34;解析行数据:&#34;_record,&#34;H&lt;--M&#34;) .i &#39;$l(record) q .s mi=miold .//识别前处理上机信息 .//取出第一位命令类型 .s type=$p(record,&#34;|&#34;,1) .//解析EQU命令 .i type=&#34;EQU&#34; d ..//前处理Seen命令 ..s commandchild=$p($p(record,&#34;|&#34;,3),&#34;^&#34;,7) ..d Trace^MI.MIF000(mi,&#34;前处理命令为:&#34;_commandchild,&#34;H&lt;--M&#34;) .//解析SAC命令 .i type=&#34;SAC&#34; d ..//解析上前处理信息 ..//取出流水号 ..s epis=$p(record,&#34;|&#34;,5) ..//取出前处理或仪器信息 ..s machCode=$p(record,&#34;|&#34;,11) ..//取出位置信息 ..s positioninfo=$p(record,&#34;|&#34;,12) ..//-----------------------------------------------------------------------------------------------&gt;根据前处理命令处理 ..i commandchild=&#34;SEEN&#34; d //自动核收 ...//得到当前工作小组 ...s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) ...s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) ...s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) ...//得到仪器工作小组的核收类型 ...s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13) ...//如果是前处理小组，就认为上前处理 ...//************************************************************************************************ ...i AcceptFlag=&#34;1&#34; d ....d Trace^MI.MIF000(mi,&#34;上前处理，鉴定号:&#34;_epis_&#34;的标本在:&#34;_curMachName_&#34;,样本所在:&#34;_positioninfo,&#34;H&lt;--M&#34;) ....d Trace^MI.MIF000(mi,&#34;执行核收到前处理&#34;,&#34;H&lt;--M&#34;) ....//此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 ....s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,epis,&#34;&#34;) ....d Trace^MI.MIF000(mi,epis_&#34;核收到前处理返回信息:&#34;_dealret,&#34;H&lt;--M&#34;) ....//记录位置信息到报告位置号 ....d ..SaveRackNo(epis,positioninfo,mi) ....i dealret[&#34;标本已核收&#34; q ....i dealret=&#34;1&#34; d .....//写标本操作日志 .....d ..SaveRecord(epis,machCode,mi,&#34;5&#34;) ....e d .....s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .....s perUser = &#34;WG-&#34;_CurWorkGroupDR .....s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_epis_&#34;前处理核收失败:&#34;_dealret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) .....//写标本操作日志 .....d ..SaveRecord(epis,dealret,mi,&#34;100&#34;) .....//************************************************************************************************ ...e d ....d Trace^MI.MIF000(mi,&#34;上仪器，鉴定号:&#34;_epis_&#34;的标本在:&#34;_curMachName_&#34;,样本所在:&#34;_positioninfo,&#34;H&lt;--M&#34;) ....//核收操作，记录位置号5984@1 ....//标本操作，类型：已上机，备注：C8000A 5984@1 ....//上机提示（仪器项目上传日志，增加流水号索引） ....//此处调核收逻辑核收到仪器，标本从前处理小组进入仪器的小组 ....s dealret=##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(mi,epis,&#34;&#34;,&#34;&#34;,&#34;LSHS&#34;) ....;s RetLL=$$SaveLastMachine^MI.MIF000(mi,epis,&#34;1&#34;) ....;d Trace^MI.MIF000(mi,RetLL,&#34;最后仪器&#34;) ....d Trace^MI.MIF000(mi,epis_&#34;核收到仪器返回:&#34;_dealret,&#34;H&lt;--M&#34;) ....d Trace^MI.MIF000(mi,epis_&#34;执行记录位置号:&#34;_positioninfo,&#34;H&lt;--M&#34;) ....//不管接收是否成功，记录位置信息到报告位置号 ....d ..SaveRackNo(epis,&#34;已上机:&#34;_positioninfo,mi) ....d Trace^MI.MIF000(mi,epis_&#34;记录位置号完成&#34;,&#34;H&lt;--M&#34;) ....i dealret[&#34;标本已核收&#34; q ....i dealret=&#34;1&#34; d .....//写标本操作日志 .....d ..SaveRecord(epis,&#34;仪器:&#34;_curMachName_&#34;,位置:&#34;_positioninfo_&#34;核收&#34;,mi,&#34;5&#34;) .....d ..SaveRecord(epis,&#34;已上流水线:&#34;_positioninfo,mi,&#34;5&#34;) ....e d .....s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .....s perUser = &#34;WG-&#34;_CurWorkGroupDR .....s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_epis_&#34;前处理核收失败:&#34;_dealret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) .....//写标本操作日志 .....d ..SaveRecord(epis,dealret,mi,&#34;100&#34;) ..//-----------------------------------------------------------------------------------------------&gt;根据前处理命令处理 ..i commandchild=&#34;RESULT&#34; d //处理分类信息 ...//通过仪器对照码取仪器 ...s curMachName=machCode ...//此处存标本全部审核报告的位置号 ...d Trace^MI.MIF000(mi,&#34;分类信息，标本号:&#34;_epis_&#34;的样本所在仪器:&#34;_curMachName_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) ...d Trace^MI.MIF000(mi,epis_&#34;执行记录分类信息:&#34;_positioninfo,&#34;H&lt;--M&#34;) ...//保存分类信息到架子号 ...d ..SaveCARCH(epis,curMachName_&#34;: &#34;_positioninfo,mi,curMachName) ...d Trace^MI.MIF000(mi,epis_&#34;记录分类信息完成&#34;,&#34;H&lt;--M&#34;) ...//写标本操作日志 ...d ..SaveRecord(epis,&#34;上机位置:&#34;_positioninfo,mi,&#34;6&#34;) ..//-----------------------------------------------------------------------------------------------&gt;根据前处理命令处理 ..i commandchild=&#34;ARCHIVE&#34; d //处理归档信息 ...//通过仪器对照码取仪器 ...s curMachName=machCode ...//此处存标本全部审核报告的位置号 ...d Trace^MI.MIF000(mi,&#34;归档信息，标本号:&#34;_epis_&#34;的样本所在仪器:&#34;_curMachName_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) ...d Trace^MI.MIF000(mi,epis_&#34;执行记录分类信息:&#34;_positioninfo,&#34;H&lt;--M&#34;) ...//保存归档信息到架子号 ...d ..SaveCARCH(epis,&#34;归档:&#34;_positioninfo,mi,&#34;归档&#34;) ...d Trace^MI.MIF000(mi,epis_&#34;记录归档信息完成&#34;,&#34;H&lt;--M&#34;) ...//写标本操作日志 ...d ..SaveRecord(epis,&#34;归档位置:&#34;_positioninfo,mi,&#34;101&#34;) .//-----------------------------------------------------------------------------------------------&gt;处理结果数据 .//解析质控数据,P业务数据，Q质控数据 .i (type[&#34;MSH&#34;) d ..s ^TMP(&#34;RS600&#34;,mi,&#34;MSH&#34;)=$p(record,&#34;|&#34;,10) ..//取日期串 ..s DateStr=$p(record,&#34;|&#34;,7) ..//解析保存日期串 ..i $l(DateStr)=14 s ^TMP(&#34;RS600&#34;,mi,&#34;DATE&#34;)=$e(DateStr,1,8)_&#34;,&#34;_(($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60)) .i type=&#34;OBR&#34; s ^TMP(&#34;RS600&#34;,mi,&#34;OBR&#34;)=$p(record,&#34;|&#34;,3) .i type=&#34;ORC&#34; s ^TMP(&#34;RS600&#34;,mi,&#34;ORC&#34;)=$p(record,&#34;|&#34;,3) .//仪器警告 .i type=&#34;NTE&#34; d\t..s WaringStr=$p(record,&#34;|&#34;,4) ..d Trace^MI.MIF000(mi,&#34;仪器报警信息:&#34;_WaringStr,&#34;H&lt;--M&#34;) ..s WaringCode=$p(WaringStr,&#34; &#34;,2) ..i $l(WaringCode) d ...i WaringCode=&#34;5&#34; s WaringStr=&#34;&gt;ABS(超出ABS)&#34; ...e i WaringCode=&#34;43&#34; s WaringStr=&#34;Cal.E(校准结果异常)&#34; ...e i WaringCode=&#34;2&#34; s WaringStr=&#34;&gt;Cuvet(反应杯空白异常)&#34; ...e i WaringCode=&#34;42&#34; s WaringStr=&#34;Edit(实验结果已被编辑)&#34; ...e i WaringCode=&#34;23&#34; s WaringStr=&#34;&gt;ISE(超出ISE范围)&#34; ...e i WaringCode=&#34;19&#34; s WaringStr=&#34;ISE.E(ISE电压级错误)&#34; ...e i WaringCode=&#34;56&#34; s WaringStr=&#34;&gt;Kin(Prozone错误2/运动不稳)&#34; ...e i WaringCode=&#34;10&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; ...e i WaringCode=&#34;11&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; ...e i WaringCode=&#34;6&#34; s WaringStr=&#34;&gt;Prozone(Prozone错误1)&#34; ...e i WaringCode=&#34;4&#34; s WaringStr=&#34;Reag.S(试剂不足)&#34; ...e i WaringCode=&#34;44&#34; s WaringStr=&#34;&gt;Rept(高出原倍复查范围)&#34; ...e i WaringCode=&#34;45&#34; s WaringStr=&#34;&lt;Rept(低于原倍复查范围)&#34; ...e i WaringCode=&#34;46&#34; s WaringStr=&#34;Samp.？(高出ABS最大值)&#34; ...e i WaringCode=&#34;68&#34; s WaringStr=&#34;Samp.B(样本中有气泡)&#34; ...e i WaringCode=&#34;72&#34; s WaringStr=&#34;Samp.C(样本中有凝块)&#34; ...e i WaringCode=&#34;26&#34; s WaringStr=&#34;&gt;Test(高出线性范围)&#34; ...e i WaringCode=&#34;27&#34; s WaringStr=&#34;&lt;Test(低于线性范围)&#34; ..//保存仪器报警信息到组内报告评价 ..d ..SaveResultWarned(epis,WaringStr,mi) .d ##class(MI.Special.RecordGlobal).RecordData(epis,recordbak,&#34;MI.MIFRS600&#34;,1,10)\t//YHR 20230828 记录十天的数据 .i type=&#34;OBX&#34; d ..s (sample,result,date,time,QC)=&#34;&#34; ..s epis=^TMP(&#34;RS600&#34;,mi,&#34;OBR&#34;) ..s machCode=$p($p($p($p(record,&#34;|&#34;,16),&#34;^&#34;,1),&#34;:&#34;,1),&#34;^&#34;,1) ..d Trace^MI.MIF000(mi,&#34;解析仪器对照码:&#34;_machCode,&#34;H&lt;--M&#34;) ..//通过仪器对照码取仪器 ..s code=$p($p(record,&#34;|&#34;,4),&#34;^&#34;,1) ;AHBS^6012 ..s reswaring=$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2) ..s res=$p($p(record,&#34;|&#34;,6),&#34;^&#34;,1) ;[&#34;&#34;一般|-1阴性+定量|1阳性+定量|0临界值] ..s CallThePolice=$p($p(record,&#34;|&#34;,9),&#34;^&#34;,2) ..i $l(CallThePolice) d ...try{d ..SaveAlarmInformation(mi,epis,CallThePolice)}catch {} //YHR 20230828 保存报警信息 ..//i res=-1 s res=&#34;阴性&#34;_$c(92)_$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2)_$c(92)_$c(92)_reswaring ..//e i res=1 s res=&#34;阳性&#34;_$c(92)_$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2)_$c(92)_$c(92)_reswaring ..//e i res=0 s res=&#34;临界值&#34;_$c(92)_$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2)_$c(92)_$c(92)_reswaring ..//e s res=&#34;临界值&#34;_$c(92)_$c(92)_$c(92)_reswaring ..i res=&#34;SORTED&#34; q ..i res=&#34;N/I&#34; q ..//标本质量数据当做仪器报警，不让自动审核 ..i code=&#34;SQ-D&#34; d ...//保存仪器报警信息到报告评价 ...//d ..SaveResultWarned(epis,res,mi) ...d ..SaveQuality(epis,res,mi) ..//计算肾小球滤过率 ..i code=&#34;8690&#34; d ...s x1=&#34;Cur&#34; ...s x2=##class(MI.Special.GetSxqlgl).GeteGFRResultLast(mi,epis,res) ...i $l(x2) s result=result_x1_$c(92)_x2_$c(44) ..s result=result_code_$c(92)_res_$c(44) ..d Trace^MI.MIF000(mi,epis_&#34;:&#34;_result,&#34;H&lt;--M&#34;) ..d Trace^MI.MIF000(mi,&#34;按对照仪器保存数据:&#34;_machCode,&#34;H&lt;--M&#34;) ..//统一保存结果 ..i $l(epis),$l(result) d ...d Trace^MI.MIF000(mi,epis_&#34;$$&#34;_result,&#34;H&lt;--M&#34;) ...s DateStr=&#34;&#34; ...i $d(^TMP(&#34;RS600&#34;,mi,&#34;DATE&#34;)) s DateStr=^TMP(&#34;RS600&#34;,mi,&#34;DATE&#34;) ...i $l(DateStr) d ....s date=$p(DateStr,&#34;,&#34;,1) ....s time=$p(DateStr,&#34;,&#34;,2) ...d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) q &#34;1&#34; } // 记录标本日志 // D ##class(MI.MIFRS600).SaveRecord(&#34;&#34;,&#34;&#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi) s OperateTypeCode=$g(OperateTypeCode) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,&#34;,&#34;,2),&#34;&#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,&#34;&#34;) } // 保存仪器报警信息 // D ##class(MI.MIFRS600).SaveResultWarned(&#34;&#34;,&#34;&#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.ResultWarned) s objrep.ResultWarned=objrep.ResultWarned_&#34;,&#34;_conclusion .....e s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存仪器报警信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // 保存仪器报警信息(标本质量) // D ##class(MI.MIFRS600).SaveQuality(&#34;&#34;,&#34;&#34;) ClassMethod SaveQuality(labno, conclusion, predealMI) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_&#34;,&#34;_conclusion .....e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // 保存架子号 // D ##class(MI.MIFRS600).SaveRackNo(&#34;&#34;,&#34;&#34;) ClassMethod SaveRackNo(labno, positioninfo, mi) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s CanDoTS=0 .....i $d(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,ReportDR)) d ......s TestSetDR=&#34;&#34; f s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,ReportDR,TestSetDR)) q:TestSetDR=&#34;&#34; d .......i $d(^dbo.BTTestSetWorkGroupMachineI(&#34;IndexWorkGroupMachine&#34;,curWorkGroupMachineDR,TestSetDR)) d ........s CanDoTS=1 .....i CanDoTS=0 q .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,&#34;-1^存位置信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // 保存归档和分类信息 // D ##class(MI.MIFRS600).SaveCARCH(&#34;1000100990&#34;,&#34;2@2&#34;,57,&#34;归档&#34;) ClassMethod SaveCARCH(labno, positioninfo, mi, typename) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo) d ......i $p(objrep.RackNo,&#34;-&gt;&#34;,*)[typename d .......s positioninfo=$p(objrep.RackNo,typename,1)_positioninfo ......e d .......s positioninfo=objrep.RackNo_&#34;-&gt;&#34;_positioninfo .....s objrep.RackNo=positioninfo .....s objrep.LastMachineLName=&#34;&#34; .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,&#34;-1^存&#34;_typename_&#34;信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0 d Trace^MI.MIF000(mi,labno_&#34;:没有找到&#34;_typename_&#34;的报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // D ##class(MI.MIFRS600).SaveImageMTHD(&#34;8&#34;,&#34;1000001727&#34;,&#34;07&#34;,&#34;/LIS/IT3000/20180823/SerumQ0001_orig_64_1000001727_8170_4_0__04.jpg&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) // 保存标本图片 // D ##class(MI.MIFRS600).SaveImageMTHD(&#34;57&#34;,&#34;1000100990&#34;,&#34;P&#34;,&#34;/iLISLIS080/demo.png&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //s ^TMP(&#34;zlzi&#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=&#34;1&#34; i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=&#34;&#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis),&#34;&#34;)) .i $d(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=&#34;&#34; f s RowID=$o(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=&#34;&#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i &#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=&#34;SerumQ&#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (&#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= &#34;-1^保存报告图片失败:&#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_&#34;:&#34;_ImageClass_&#34;:&#34;_FileName,&#34;H&lt;--M&#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=&#34;&#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // w ##class(MI.MIFRS600).GetFtpMTHD(&#34;24&#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = &#34;labno,labnoInfo,patInfo&#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(&#34;MI.MIFRS600&#34;,&#34;QryLabInfo&#34;,&#34;57&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; s LabnoList=&#34;&#34; s VisitNumberDR=&#34;&#34; //*--------------------------------&gt;*申请项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..b ;VisitNumberDR ..i &#39;$l(VisitNumberDR) q ..;i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=&#34;0&#34; ..i TestType=&#34;0&#34; d ...b ;1 ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@C&#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ...s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ...d Trace^MI.MIF000(mi,txtInfo,&#34;上传信息&#34;) ...d OutputRow ...//文本双向上传结束****************************************************** ////*--------------------------------&gt;*复查结果上传 s AddDate=$zd($p($h,&#34;,&#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;)) ..b ;F101 ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..b ;VisitNumberDR ..i &#39;$l(VisitNumberDR) q ..i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=&#34;0&#34; ..i TestType=&#34;0&#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ...s labnoInfo=labno_&#34;,&#34;_$replace(TCList,&#34;\\&#34;,&#34;+&#34;)_&#34;|@U&#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ...s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ...d Trace^MI.MIF000(mi,txtInfo,&#34;上传信息&#34;) ...d OutputRow ...//文本双向上传结束****************************************************** //*--------------------------------&gt;*取消项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime,&#34;&#34;)) ..b ;101 ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..b ;VisitNumberDR ..i &#39;$l(VisitNumberDR) q ..;i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=&#34;0&#34; ..i TestType=&#34;0&#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@R&#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ...s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ...d Trace^MI.MIF000(mi,txtInfo,&#34;上传信息&#34;) ...d OutputRow ...//文本双向上传结束****************************************************** Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=&#34;labno,labnoInfo,patInfo&#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=&#34;&#34; { Set AtEnd=1 Set Row=&#34;&#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 获取申请名称和内容 /// 申请名称： /// 发送申请：order_2012051718302501_9999999901NW.HL7 /// 取消申请：order_2012051718302501_9999999901CA.HL7 /// 项目复查：order_2012051718302501_9999999901XO.HL7 /// w ##class(MI.MIFRS600).GetLisOrderMTHD(&#34;8&#34;,&#34;POS@C@1&#34;,&#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08 -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34; ,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod GetLabnoInfoN(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s VT=&#34;[11]&#34;,FS=&#34;[28]&#34;,CR=&#34;[13]&#34; s labNo=$p(patInfo,&#34;,&#34;,16) s Sampleno=$p(patInfo,&#34;,&#34;,3) //i labNo=&#34;74623177&#34; s ^TMP(&#34;zlzit3000d&#34;)=$lb(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s location=$p(patInfo,&#34;,&#34;,6) s docName=$p(patInfo,&#34;,&#34;,7) s regNo=$p(patInfo,&#34;,&#34;,9) s patName=$p(patInfo,&#34;,&#34;,10) s sex=$p(patInfo,&#34;,&#34;,11) i sex=&#34;1&#34; s sex=&#34;M&#34; i sex=&#34;2&#34; s sex=&#34;F&#34; i (sex&#39;=&#34;M&#34;)&amp;&amp;(sex&#39;=&#34;F&#34;) s sex=&#34;U&#34; s birthDate=$p(patInfo,&#34;,&#34;,29) s collectTime=$p(patInfo,&#34;,&#34;,17) ;2017-08-14 11:57 s collectTime=$tr(collectTime,&#34;- :&#34;,&#34;&#34;)_&#34;00&#34; s status=$p(labnoInfo,&#34;@&#34;,2) s labnoInfo=$p(labnoInfo,&#34;@&#34;,1) s curTime=$zd($h,8)_$tr($zt($p($h,&#34;,&#34;,2)),&#34;:&#34;,&#34;&#34;) s PatType=$p(patInfo,&#34;,&#34;,12) s Wardno=$p(patInfo,&#34;,&#34;,27) s Diagnose=$p(patInfo,&#34;,&#34;,22) S patTypeFlag=&#34;RO&#34; //门诊=RO,住院=RI,体检=RC,急诊=RS I PatType=&#34;住院&#34; { S patTypeFlag=&#34;RI&#34; } I PatType=&#34;门诊&#34; { S patTypeFlag=&#34;RO&#34; } I PatType=&#34;急诊&#34; { S patTypeFlag=&#34;RS&#34; } I PatType=&#34;体检&#34; { S patTypeFlag=&#34;RC&#34; } I PatType=&#34;干诊&#34; { S patTypeFlag=&#34;RC&#34; } s MSN=&#34;MSH|^\\&amp;|HL7SND|FAC1|HL7REC|FAC2|&#34;_curTime_&#34;||OML^O21|&#34;_curTime_&#34;_&#34;_labNo_&#34;|P|2.3|||ER|ER||8859/1&#34; i status=&#34;S&#34; s MSN=&#34;MSH|^\\&amp;|HL7SND|FAC1|HL7REC|FAC2|&#34;_curTime_&#34;||RESULTS|&#34;_curTime_&#34;_&#34;_labNo_&#34;|P|2.3|||ER|ER||8859/1&#34; s PID=&#34;PID|1||&#34;_Sampleno_&#34;||&#34;_&#34;^&#34;_patName_&#34;||&#34;_birthDate_&#34;|&#34;_sex s PV1=&#34;PV1|||&#34;_Wardno_&#34;||||||||||||||||^^^^^^^^&#34;_location_&#34;|&#34; s DG1=&#34;DG1|||&#34;_Diagnose s orcF1=&#34;NW&#34;,orcF2=&#34;&#34; i status=&#34;R&#34; s orcF1=&#34;CA&#34; //i status=&#34;U&#34; s orcF1=&#34;XO&#34; s orcF2=&#34;SC&#34; i status=&#34;U&#34; s orcF1=&#34;XO&#34; s orcF2=&#34;RP&#34; s ORC=&#34;ORC|&#34;_orcF1_&#34;|&#34;_labNo_&#34;|||||&#34;_patTypeFlag_&#34;||&#34;_curTime_&#34;||&#34;_docName_&#34;|&#34;_Wardno_&#34;|||||||&#34; s obrF1=&#34;A&#34; i status=&#34;U&#34; s obrF1=&#34;G&#34; s OBR=&#34;OBR||&#34;_labNo_&#34;||AA|||&#34;_collectTime_&#34;||||&#34;_obrF1\ts OBRs=&#34;&#34; i $p(labnoInfo,&#34;@&#34;,1)=&#34;POS&#34; d .s OBRs=&#34;OBR||&#34;_labNo_&#34;||POS|||&#34;_collectTime_&#34;||||&#34;_obrF1 e d .d GetOBRs\t//s orderTxt=VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS s orderTxt=VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS q orderTxt GetOBRs s items=$tr($p(labnoInfo,&#34;,&#34;,2),&#34;|&#34;,&#34;&#34;) f i=1:1:$l(items,&#34;+&#34;) d .s item=$p(items,&#34;+&#34;,i) .s splitStr=$p(OBR,&#34;|&#34;,5) .s curOBR=$p(OBR,splitStr,1)_item_$p(OBR,splitStr,2) .s OBRs=OBRs_curOBR_CR q } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=&#34;&#34; s chl=&#34;&#34; f s chl=$o(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) q:chl=&#34;&#34; d .s tcx=tcx_chl_&#34;+&#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) i $l(tcx) s tcx=labno_&#34;,&#34;_tcx_&#34;|&#34; d Trace^MI.MIF000(mi,tcx,&#34;H--&gt;M&#34;) d Trace^MI.MIF000(56,&#34;共&#34;_$l(tcx,&#34;+&#34;)_&#34;个项目。&#34;_tcx,&#34;H--&gt;M&#34;) //YHR 20230816 将上传信息存入罗氏infinity仪器 q tcx } /// w ##Class(MI.MIFRS600).GetPatInfo(57,9000001912) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q &#34;&#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) i &#39;$l(VisitNumberDR) q &#34;&#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=&#34;&#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=&#34;&#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=&#34;&#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName\ts SpeciesDR=$lg(RPVisitNumberData,15),Species=&#34;&#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=&#34;&#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=&#34;&#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,&#34;,&#34;,1),3)_&#34; &#34;_$zt($p($h,&#34;,&#34;,2)) s Instrument = &#34;XN&#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) i $l(Instrument) s Instrument=$tr(Instrument,&#34;,&#34;,&#34;^&#34;) s Sampleno=$lg(RPVisitNumberData,6) //病案号 s Sampletype=&#34;&#34; s Feetype=&#34;&#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 &#34;&#34; s BarCode=&#34;&#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=&#34;男&#34; s Sex=&#34;1&#34; ;1:男 ，2 女 i Species =&#34;女&#34; s Sex=&#34;2&#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=&#34;&#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=&#34;&#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_&#34;-&#34;_$e(ReceiveDate,5,6)_&#34;-&#34;_$e(ReceiveDate,7,8)_&#34; &#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=&#34;&#34; ;报告日期 = 初审(保存结果)时间 s Printflag=&#34;&#34; ;打印标志 s Resultflag=&#34;&#34; ;结果标志 s Errflag=&#34;&#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=&#34;&#34; ;备注 s Reserve=&#34;&#34; ;保留字段 s Patnamn=&#34;&#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_&#34;-&#34;_$e(CollectDate,5,6)_&#34;-&#34;_$e(CollectDate,7,8)_&#34; &#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=&#34;&#34; s WardnoDR=$lg(RPVisitNumberData,26) ;病区 i $l(WardnoDR) s Wardno=$lg($g(^dbo.BTWardD(WardnoDR)),3) s RetString=&#34;&#34; s RetString=$tr(Sampleda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Instrument,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampleno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampletype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Feetype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdepno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdocno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Userno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patna,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sex,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Pattype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Bedno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patage,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Ageunit,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Reportda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Printflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Resultflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Errflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Diagnose,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Description,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reserve,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patnamn,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Getda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Wardno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BarCode,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BirthDate,&#34;,&#34;,&#34;&#34;) q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename) q } /// 流水号特殊处理 /// w ##class(MI.MIFRS600).GetEpis() ClassMethod GetEpis() { s sign=1 while sign=1 { s maxEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByRowIDMTHD(&#34;5&#34;) //YHR 20230810 罗氏流水线规则 s ret=$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,67,maxEpis)) i ret&#39;=0 s sign=1 e d s sign=0 } q maxEpis } /// 保存报警提示信息 /// YHR 20230828 /// w ##Class(MI.MIFRS600).SaveAlarmInformation(57,9000001960,&#34;CSCSCS&#34;) ClassMethod SaveAlarmInformation(mi, epis, expertRules) { s mi=$g(mi) s epis=$g(epis) s expertRules=$g(expertRules) s ReportDR=$$GetReportID(mi,epis) s obj=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) s obj.MinorConclusion=expertRules s ret=obj.%Save() q ret GetReportID(mi,epis) i $l(epis)&lt;10 d .s AssayNo=epis e d .s AssayNo=$$GetEpisByLabno(mi,epis) s WGMachineID=$lg(^dbo.BTMIMachineParameterD(mi),6) s WGMachineID1=$lg(^dbo.BTMIMachineParameterD(mi),6) s ReportID=&#34;&#34; i $D(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WGMachineID,AssayNo)) d .s TransmitDate=$O(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WGMachineID,AssayNo,&#34;&#34;)) .s ReportID=$O(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WGMachineID,AssayNo,TransmitDate,&#34;&#34;)) q ReportID GetEpisByLabno(mi,Epis) ;Index IndexVisitNumber On VisitNumber [ SqlName = Index_VisitNumber, Type = index, Unique ]; ;Index IndexReportID On (VisitNumberDR, WorkGroupMachineDR, OrderNo) [ SqlName = Index_ReportID, Type = index, Unique ]; s ret=&#34;&#34;,mi=$g(mi),Epis=$g(Epis) i &#39;$l(mi) q Epis s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,Epis)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,Epis,&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitnumberDR,WGMachineID,1)) d ..s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitnumberDR,WGMachineID,1,&#34;&#34;)) ..s ret=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),8) q ret } } 附录 仪器文档提取数据格式 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 第十章LIS 10.1Order格式 [VT] MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||OML^O21|20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR] PID|1||00943729|9009|^Test||19811002|F[CR] PV1|||041||||||||||||||||^^^^^^^^产六科|[CR] DG1|||宫内孕37+5天[CR] ORC|NW|121092103669|||||RI||20210922075000|医保|10001|041|||||||[CR] OBR||121092103669||YLCSC|||||||A[CR] OBR||121092103669||ATPO|||||||A[CR] OBR||121092103669||FT4|||||||A[CR] OBR||121092103669||TSH|||||||A[CR] [FS] [CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 OML^O21：message type Order的消息类型，Order发送必须用OML^O21 20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复） 00943729：病人的门诊或住院号 9009：样本号 ^Test：病人姓名 19811002：出生年月日 F：性别（F = Female；M = Male；U = Unknown） 宫内孕37+5天：临床诊断(如果有代码就用临床诊断得代码，没有就用文字描述) NW：Action code (NW:新建；XO：修改；CA：删除) 121092103669：条码号 RI：病人类别（门诊；住院；急诊；体检……） 20180201101033：时间戳(精确到秒无需毫秒) 医保：病人收费类别 10001：申请医生代码 041：申请科室代码 121092103669：条码号 YLCSC：测试项目代号 10.2Result格式 [VT] MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||RESULTS |20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR] PID|1||00943729|9009|^Test||19811002|F[CR] PV1|||041||||||||||||||||^^^^^^^^产六科|[CR] DG1|||宫内孕37+5天[CR] ORC|NW|121092103669|9009||||RI||20210922075000|医保|10001|041|||||||[CR] OBR||121092103669||YLCSC|||||||A[CR] OBX|1|NM|YLCSC||1.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||ATPO|||||||A[CR] OBX|1|NM|ATPO||2.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||FT4|||||||A[CR] OBX|1|NM|FT4||3.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||TSH|||||||A[CR] OBX|1|NM|TSH||6.1||||||F|||20210922101033|c6000^E11[CR] [FS] [CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 RESULTS：message type Order的消息类型，结果回传必须用RESULTS 20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复） 00943729：病人的门诊或住院号 9009：样本号 ^Test：病人姓名 19811002：出生年月日 F：性别（F = Female；M = Male；U = Unknown） NW：Action code (NW:新建；XO：修改；CA：删除) 121092103669：条码号 RI：病人类别（门诊；住院；急诊；体检……） 20210922075000：时间戳(精确到秒无需毫秒) 医保：病人收费类别 10001：申请医生代码 041：申请科室代码 121092103669：条码号 NM：Value Type (NM = Numeric；ST = String data) YLCSC：测试项目代号 1.1：项目测试结果 c6000^E11：分析仪名称和模块名称 10.3Seen格式 01前处理条码扫描消息格式 [VT] MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR] SAC|||0800150242|0800150242||20220908183340|01||P|MILESTON1|0@0[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^SEEN：消息类型 0800150242：条码号 MILESTON1：前处理名称 0@0：架子号和位置号 20220908183340：消息产生的时间 02前处理分类Distribution消息格式 [VT] MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^RESULT|20220908183340|SORTED[CR] SAC|||0800150242|0800150242||20220908183340|01||R|c6000|0@0[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^RESULT：消息类型 0800150242：条码号 MILESTON1：前处理名称 c6000：分析仪名称 0@0：架子号和位置号 20220908183340：消息产生的时间 03前处理归档消息格式 [VT] MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^ARCHIVE|20220908183340|SORTED[CR] SAC|||0800150242|0800150242||20220908183340|01||R|MILESTON1|23@1[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^ARCHIVE：消息类型 0800150242：条码号 MILESTON1：前处理名称 23@1：架子号和位置号 20220908183340：消息产生的时间 特殊处理 标本拒收更改标本上传状态为R\n">
<title>罗氏流水线RS600</title>

<link rel='canonical' href='https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/'>

<link rel="stylesheet" href="/scss/style.min.f2d7dc6e4260dd59fff8a52da7389f1eff957cf4cb673472fcac4ed793e45a6e.css"><meta property='og:title' content="罗氏流水线RS600">
<meta property='og:description' content="接口说明 仪器厂商 罗氏流水线RS600\n仪器型号 罗氏流水线RS600\n通讯方式 单向|双向|主动上传☑\n仪器类型 医院名称 程序名称 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：串口|网口|监听文件☑|数据库|其他 连接方式：HL7协议|ASTM协议|监听文件☑|数据库|其他 仪器接口说明 对于数据上传增加业务内容修改，仅作参考 串口盒子配置 波特率： 9600 数据位：8 停止位： 1 校验位： N 仪器图片 仪器配置 数据格式 项目通道号 修改记录 序号 日期 操作人 说明 1 2025-08-29 14:23:27\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;Z:\\\\ResultExport\\\\&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFLICA800&#34;,&#34;Para&#34;:&#34;.csv&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UpPara&#34;:&#34;Z:\\\\Imports\\\\&#34;}] Class MI.MIFRS600 Extends %RegisteredObject { /// D ##class(MI.MIFInfinity).fileMTHD(&#34;7&#34;,&#34;MSH|^~\\&amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#&#34;,&#34;&#34;) /// seen: [VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR] /// result: [VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR] /// D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;&#34;,&#34;&#34;) /// seen: D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]&#34;,&#34;&#34;) /// result:D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]&#34;,&#34;&#34;) ClassMethod fileMTHD(mi, record, epis, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;0&#34; s HospitalDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),4) i &#39;$l(record) q &#34;0&#34; i &#39;$d(^TMPLIS(&#34;RS600&#34;,mi,&#34;ERR&#34;)) s ^TMPLIS(&#34;RS600&#34;,mi,&#34;ERR&#34;)=&#34;&#34; d Trace^MI.MIF000(mi,record,&#34;H&lt;--M&#34;) s miold=mi s recordbak=record //仪器临时结果映射 s TMPMachResMap=&#34;&#34; //解析多行合并数据 f i=1:1:$l(recordbak,&#34;#enter#&#34;) d .s record=$p(recordbak,&#34;#enter#&#34;,i) .d Trace^MI.MIF000(mi,&#34;解析行数据:&#34;_record,&#34;H&lt;--M&#34;) .i &#39;$l(record) q .s mi=miold .//识别前处理上机信息 .//取出第一位命令类型 .s type=$p(record,&#34;|&#34;,1) .//解析EQU命令 .i type=&#34;EQU&#34; d ..//前处理Seen命令 ..s commandchild=$p($p(record,&#34;|&#34;,3),&#34;^&#34;,7) ..d Trace^MI.MIF000(mi,&#34;前处理命令为:&#34;_commandchild,&#34;H&lt;--M&#34;) .//解析SAC命令 .i type=&#34;SAC&#34; d ..//解析上前处理信息 ..//取出流水号 ..s epis=$p(record,&#34;|&#34;,5) ..//取出前处理或仪器信息 ..s machCode=$p(record,&#34;|&#34;,11) ..//取出位置信息 ..s positioninfo=$p(record,&#34;|&#34;,12) ..//-----------------------------------------------------------------------------------------------&gt;根据前处理命令处理 ..i commandchild=&#34;SEEN&#34; d //自动核收 ...//得到当前工作小组 ...s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) ...s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) ...s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) ...//得到仪器工作小组的核收类型 ...s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13) ...//如果是前处理小组，就认为上前处理 ...//************************************************************************************************ ...i AcceptFlag=&#34;1&#34; d ....d Trace^MI.MIF000(mi,&#34;上前处理，鉴定号:&#34;_epis_&#34;的标本在:&#34;_curMachName_&#34;,样本所在:&#34;_positioninfo,&#34;H&lt;--M&#34;) ....d Trace^MI.MIF000(mi,&#34;执行核收到前处理&#34;,&#34;H&lt;--M&#34;) ....//此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 ....s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,epis,&#34;&#34;) ....d Trace^MI.MIF000(mi,epis_&#34;核收到前处理返回信息:&#34;_dealret,&#34;H&lt;--M&#34;) ....//记录位置信息到报告位置号 ....d ..SaveRackNo(epis,positioninfo,mi) ....i dealret[&#34;标本已核收&#34; q ....i dealret=&#34;1&#34; d .....//写标本操作日志 .....d ..SaveRecord(epis,machCode,mi,&#34;5&#34;) ....e d .....s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .....s perUser = &#34;WG-&#34;_CurWorkGroupDR .....s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_epis_&#34;前处理核收失败:&#34;_dealret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) .....//写标本操作日志 .....d ..SaveRecord(epis,dealret,mi,&#34;100&#34;) .....//************************************************************************************************ ...e d ....d Trace^MI.MIF000(mi,&#34;上仪器，鉴定号:&#34;_epis_&#34;的标本在:&#34;_curMachName_&#34;,样本所在:&#34;_positioninfo,&#34;H&lt;--M&#34;) ....//核收操作，记录位置号5984@1 ....//标本操作，类型：已上机，备注：C8000A 5984@1 ....//上机提示（仪器项目上传日志，增加流水号索引） ....//此处调核收逻辑核收到仪器，标本从前处理小组进入仪器的小组 ....s dealret=##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(mi,epis,&#34;&#34;,&#34;&#34;,&#34;LSHS&#34;) ....;s RetLL=$$SaveLastMachine^MI.MIF000(mi,epis,&#34;1&#34;) ....;d Trace^MI.MIF000(mi,RetLL,&#34;最后仪器&#34;) ....d Trace^MI.MIF000(mi,epis_&#34;核收到仪器返回:&#34;_dealret,&#34;H&lt;--M&#34;) ....d Trace^MI.MIF000(mi,epis_&#34;执行记录位置号:&#34;_positioninfo,&#34;H&lt;--M&#34;) ....//不管接收是否成功，记录位置信息到报告位置号 ....d ..SaveRackNo(epis,&#34;已上机:&#34;_positioninfo,mi) ....d Trace^MI.MIF000(mi,epis_&#34;记录位置号完成&#34;,&#34;H&lt;--M&#34;) ....i dealret[&#34;标本已核收&#34; q ....i dealret=&#34;1&#34; d .....//写标本操作日志 .....d ..SaveRecord(epis,&#34;仪器:&#34;_curMachName_&#34;,位置:&#34;_positioninfo_&#34;核收&#34;,mi,&#34;5&#34;) .....d ..SaveRecord(epis,&#34;已上流水线:&#34;_positioninfo,mi,&#34;5&#34;) ....e d .....s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .....s perUser = &#34;WG-&#34;_CurWorkGroupDR .....s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_epis_&#34;前处理核收失败:&#34;_dealret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) .....//写标本操作日志 .....d ..SaveRecord(epis,dealret,mi,&#34;100&#34;) ..//-----------------------------------------------------------------------------------------------&gt;根据前处理命令处理 ..i commandchild=&#34;RESULT&#34; d //处理分类信息 ...//通过仪器对照码取仪器 ...s curMachName=machCode ...//此处存标本全部审核报告的位置号 ...d Trace^MI.MIF000(mi,&#34;分类信息，标本号:&#34;_epis_&#34;的样本所在仪器:&#34;_curMachName_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) ...d Trace^MI.MIF000(mi,epis_&#34;执行记录分类信息:&#34;_positioninfo,&#34;H&lt;--M&#34;) ...//保存分类信息到架子号 ...d ..SaveCARCH(epis,curMachName_&#34;: &#34;_positioninfo,mi,curMachName) ...d Trace^MI.MIF000(mi,epis_&#34;记录分类信息完成&#34;,&#34;H&lt;--M&#34;) ...//写标本操作日志 ...d ..SaveRecord(epis,&#34;上机位置:&#34;_positioninfo,mi,&#34;6&#34;) ..//-----------------------------------------------------------------------------------------------&gt;根据前处理命令处理 ..i commandchild=&#34;ARCHIVE&#34; d //处理归档信息 ...//通过仪器对照码取仪器 ...s curMachName=machCode ...//此处存标本全部审核报告的位置号 ...d Trace^MI.MIF000(mi,&#34;归档信息，标本号:&#34;_epis_&#34;的样本所在仪器:&#34;_curMachName_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) ...d Trace^MI.MIF000(mi,epis_&#34;执行记录分类信息:&#34;_positioninfo,&#34;H&lt;--M&#34;) ...//保存归档信息到架子号 ...d ..SaveCARCH(epis,&#34;归档:&#34;_positioninfo,mi,&#34;归档&#34;) ...d Trace^MI.MIF000(mi,epis_&#34;记录归档信息完成&#34;,&#34;H&lt;--M&#34;) ...//写标本操作日志 ...d ..SaveRecord(epis,&#34;归档位置:&#34;_positioninfo,mi,&#34;101&#34;) .//-----------------------------------------------------------------------------------------------&gt;处理结果数据 .//解析质控数据,P业务数据，Q质控数据 .i (type[&#34;MSH&#34;) d ..s ^TMP(&#34;RS600&#34;,mi,&#34;MSH&#34;)=$p(record,&#34;|&#34;,10) ..//取日期串 ..s DateStr=$p(record,&#34;|&#34;,7) ..//解析保存日期串 ..i $l(DateStr)=14 s ^TMP(&#34;RS600&#34;,mi,&#34;DATE&#34;)=$e(DateStr,1,8)_&#34;,&#34;_(($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60)) .i type=&#34;OBR&#34; s ^TMP(&#34;RS600&#34;,mi,&#34;OBR&#34;)=$p(record,&#34;|&#34;,3) .i type=&#34;ORC&#34; s ^TMP(&#34;RS600&#34;,mi,&#34;ORC&#34;)=$p(record,&#34;|&#34;,3) .//仪器警告 .i type=&#34;NTE&#34; d\t..s WaringStr=$p(record,&#34;|&#34;,4) ..d Trace^MI.MIF000(mi,&#34;仪器报警信息:&#34;_WaringStr,&#34;H&lt;--M&#34;) ..s WaringCode=$p(WaringStr,&#34; &#34;,2) ..i $l(WaringCode) d ...i WaringCode=&#34;5&#34; s WaringStr=&#34;&gt;ABS(超出ABS)&#34; ...e i WaringCode=&#34;43&#34; s WaringStr=&#34;Cal.E(校准结果异常)&#34; ...e i WaringCode=&#34;2&#34; s WaringStr=&#34;&gt;Cuvet(反应杯空白异常)&#34; ...e i WaringCode=&#34;42&#34; s WaringStr=&#34;Edit(实验结果已被编辑)&#34; ...e i WaringCode=&#34;23&#34; s WaringStr=&#34;&gt;ISE(超出ISE范围)&#34; ...e i WaringCode=&#34;19&#34; s WaringStr=&#34;ISE.E(ISE电压级错误)&#34; ...e i WaringCode=&#34;56&#34; s WaringStr=&#34;&gt;Kin(Prozone错误2/运动不稳)&#34; ...e i WaringCode=&#34;10&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; ...e i WaringCode=&#34;11&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; ...e i WaringCode=&#34;6&#34; s WaringStr=&#34;&gt;Prozone(Prozone错误1)&#34; ...e i WaringCode=&#34;4&#34; s WaringStr=&#34;Reag.S(试剂不足)&#34; ...e i WaringCode=&#34;44&#34; s WaringStr=&#34;&gt;Rept(高出原倍复查范围)&#34; ...e i WaringCode=&#34;45&#34; s WaringStr=&#34;&lt;Rept(低于原倍复查范围)&#34; ...e i WaringCode=&#34;46&#34; s WaringStr=&#34;Samp.？(高出ABS最大值)&#34; ...e i WaringCode=&#34;68&#34; s WaringStr=&#34;Samp.B(样本中有气泡)&#34; ...e i WaringCode=&#34;72&#34; s WaringStr=&#34;Samp.C(样本中有凝块)&#34; ...e i WaringCode=&#34;26&#34; s WaringStr=&#34;&gt;Test(高出线性范围)&#34; ...e i WaringCode=&#34;27&#34; s WaringStr=&#34;&lt;Test(低于线性范围)&#34; ..//保存仪器报警信息到组内报告评价 ..d ..SaveResultWarned(epis,WaringStr,mi) .d ##class(MI.Special.RecordGlobal).RecordData(epis,recordbak,&#34;MI.MIFRS600&#34;,1,10)\t//YHR 20230828 记录十天的数据 .i type=&#34;OBX&#34; d ..s (sample,result,date,time,QC)=&#34;&#34; ..s epis=^TMP(&#34;RS600&#34;,mi,&#34;OBR&#34;) ..s machCode=$p($p($p($p(record,&#34;|&#34;,16),&#34;^&#34;,1),&#34;:&#34;,1),&#34;^&#34;,1) ..d Trace^MI.MIF000(mi,&#34;解析仪器对照码:&#34;_machCode,&#34;H&lt;--M&#34;) ..//通过仪器对照码取仪器 ..s code=$p($p(record,&#34;|&#34;,4),&#34;^&#34;,1) ;AHBS^6012 ..s reswaring=$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2) ..s res=$p($p(record,&#34;|&#34;,6),&#34;^&#34;,1) ;[&#34;&#34;一般|-1阴性+定量|1阳性+定量|0临界值] ..s CallThePolice=$p($p(record,&#34;|&#34;,9),&#34;^&#34;,2) ..i $l(CallThePolice) d ...try{d ..SaveAlarmInformation(mi,epis,CallThePolice)}catch {} //YHR 20230828 保存报警信息 ..//i res=-1 s res=&#34;阴性&#34;_$c(92)_$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2)_$c(92)_$c(92)_reswaring ..//e i res=1 s res=&#34;阳性&#34;_$c(92)_$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2)_$c(92)_$c(92)_reswaring ..//e i res=0 s res=&#34;临界值&#34;_$c(92)_$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2)_$c(92)_$c(92)_reswaring ..//e s res=&#34;临界值&#34;_$c(92)_$c(92)_$c(92)_reswaring ..i res=&#34;SORTED&#34; q ..i res=&#34;N/I&#34; q ..//标本质量数据当做仪器报警，不让自动审核 ..i code=&#34;SQ-D&#34; d ...//保存仪器报警信息到报告评价 ...//d ..SaveResultWarned(epis,res,mi) ...d ..SaveQuality(epis,res,mi) ..//计算肾小球滤过率 ..i code=&#34;8690&#34; d ...s x1=&#34;Cur&#34; ...s x2=##class(MI.Special.GetSxqlgl).GeteGFRResultLast(mi,epis,res) ...i $l(x2) s result=result_x1_$c(92)_x2_$c(44) ..s result=result_code_$c(92)_res_$c(44) ..d Trace^MI.MIF000(mi,epis_&#34;:&#34;_result,&#34;H&lt;--M&#34;) ..d Trace^MI.MIF000(mi,&#34;按对照仪器保存数据:&#34;_machCode,&#34;H&lt;--M&#34;) ..//统一保存结果 ..i $l(epis),$l(result) d ...d Trace^MI.MIF000(mi,epis_&#34;$$&#34;_result,&#34;H&lt;--M&#34;) ...s DateStr=&#34;&#34; ...i $d(^TMP(&#34;RS600&#34;,mi,&#34;DATE&#34;)) s DateStr=^TMP(&#34;RS600&#34;,mi,&#34;DATE&#34;) ...i $l(DateStr) d ....s date=$p(DateStr,&#34;,&#34;,1) ....s time=$p(DateStr,&#34;,&#34;,2) ...d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) q &#34;1&#34; } // 记录标本日志 // D ##class(MI.MIFRS600).SaveRecord(&#34;&#34;,&#34;&#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi) s OperateTypeCode=$g(OperateTypeCode) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,&#34;,&#34;,2),&#34;&#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,&#34;&#34;) } // 保存仪器报警信息 // D ##class(MI.MIFRS600).SaveResultWarned(&#34;&#34;,&#34;&#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.ResultWarned) s objrep.ResultWarned=objrep.ResultWarned_&#34;,&#34;_conclusion .....e s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存仪器报警信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // 保存仪器报警信息(标本质量) // D ##class(MI.MIFRS600).SaveQuality(&#34;&#34;,&#34;&#34;) ClassMethod SaveQuality(labno, conclusion, predealMI) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_&#34;,&#34;_conclusion .....e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // 保存架子号 // D ##class(MI.MIFRS600).SaveRackNo(&#34;&#34;,&#34;&#34;) ClassMethod SaveRackNo(labno, positioninfo, mi) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s CanDoTS=0 .....i $d(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,ReportDR)) d ......s TestSetDR=&#34;&#34; f s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,ReportDR,TestSetDR)) q:TestSetDR=&#34;&#34; d .......i $d(^dbo.BTTestSetWorkGroupMachineI(&#34;IndexWorkGroupMachine&#34;,curWorkGroupMachineDR,TestSetDR)) d ........s CanDoTS=1 .....i CanDoTS=0 q .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,&#34;-1^存位置信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // 保存归档和分类信息 // D ##class(MI.MIFRS600).SaveCARCH(&#34;1000100990&#34;,&#34;2@2&#34;,57,&#34;归档&#34;) ClassMethod SaveCARCH(labno, positioninfo, mi, typename) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo) d ......i $p(objrep.RackNo,&#34;-&gt;&#34;,*)[typename d .......s positioninfo=$p(objrep.RackNo,typename,1)_positioninfo ......e d .......s positioninfo=objrep.RackNo_&#34;-&gt;&#34;_positioninfo .....s objrep.RackNo=positioninfo .....s objrep.LastMachineLName=&#34;&#34; .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,&#34;-1^存&#34;_typename_&#34;信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0 d Trace^MI.MIF000(mi,labno_&#34;:没有找到&#34;_typename_&#34;的报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // D ##class(MI.MIFRS600).SaveImageMTHD(&#34;8&#34;,&#34;1000001727&#34;,&#34;07&#34;,&#34;/LIS/IT3000/20180823/SerumQ0001_orig_64_1000001727_8170_4_0__04.jpg&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) // 保存标本图片 // D ##class(MI.MIFRS600).SaveImageMTHD(&#34;57&#34;,&#34;1000100990&#34;,&#34;P&#34;,&#34;/iLISLIS080/demo.png&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //s ^TMP(&#34;zlzi&#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=&#34;1&#34; i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=&#34;&#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis),&#34;&#34;)) .i $d(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=&#34;&#34; f s RowID=$o(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=&#34;&#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i &#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=&#34;SerumQ&#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (&#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= &#34;-1^保存报告图片失败:&#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_&#34;:&#34;_ImageClass_&#34;:&#34;_FileName,&#34;H&lt;--M&#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=&#34;&#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // w ##class(MI.MIFRS600).GetFtpMTHD(&#34;24&#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = &#34;labno,labnoInfo,patInfo&#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(&#34;MI.MIFRS600&#34;,&#34;QryLabInfo&#34;,&#34;57&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; s LabnoList=&#34;&#34; s VisitNumberDR=&#34;&#34; //*--------------------------------&gt;*申请项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..b ;VisitNumberDR ..i &#39;$l(VisitNumberDR) q ..;i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=&#34;0&#34; ..i TestType=&#34;0&#34; d ...b ;1 ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@C&#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ...s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ...d Trace^MI.MIF000(mi,txtInfo,&#34;上传信息&#34;) ...d OutputRow ...//文本双向上传结束****************************************************** ////*--------------------------------&gt;*复查结果上传 s AddDate=$zd($p($h,&#34;,&#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;)) ..b ;F101 ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..b ;VisitNumberDR ..i &#39;$l(VisitNumberDR) q ..i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=&#34;0&#34; ..i TestType=&#34;0&#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ...s labnoInfo=labno_&#34;,&#34;_$replace(TCList,&#34;\\&#34;,&#34;+&#34;)_&#34;|@U&#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ...s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ...d Trace^MI.MIF000(mi,txtInfo,&#34;上传信息&#34;) ...d OutputRow ...//文本双向上传结束****************************************************** //*--------------------------------&gt;*取消项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime,&#34;&#34;)) ..b ;101 ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..b ;VisitNumberDR ..i &#39;$l(VisitNumberDR) q ..;i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=&#34;0&#34; ..i TestType=&#34;0&#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@R&#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ...s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ...d Trace^MI.MIF000(mi,txtInfo,&#34;上传信息&#34;) ...d OutputRow ...//文本双向上传结束****************************************************** Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=&#34;labno,labnoInfo,patInfo&#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=&#34;&#34; { Set AtEnd=1 Set Row=&#34;&#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 获取申请名称和内容 /// 申请名称： /// 发送申请：order_2012051718302501_9999999901NW.HL7 /// 取消申请：order_2012051718302501_9999999901CA.HL7 /// 项目复查：order_2012051718302501_9999999901XO.HL7 /// w ##class(MI.MIFRS600).GetLisOrderMTHD(&#34;8&#34;,&#34;POS@C@1&#34;,&#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08 -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34; ,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod GetLabnoInfoN(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s VT=&#34;[11]&#34;,FS=&#34;[28]&#34;,CR=&#34;[13]&#34; s labNo=$p(patInfo,&#34;,&#34;,16) s Sampleno=$p(patInfo,&#34;,&#34;,3) //i labNo=&#34;74623177&#34; s ^TMP(&#34;zlzit3000d&#34;)=$lb(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s location=$p(patInfo,&#34;,&#34;,6) s docName=$p(patInfo,&#34;,&#34;,7) s regNo=$p(patInfo,&#34;,&#34;,9) s patName=$p(patInfo,&#34;,&#34;,10) s sex=$p(patInfo,&#34;,&#34;,11) i sex=&#34;1&#34; s sex=&#34;M&#34; i sex=&#34;2&#34; s sex=&#34;F&#34; i (sex&#39;=&#34;M&#34;)&amp;&amp;(sex&#39;=&#34;F&#34;) s sex=&#34;U&#34; s birthDate=$p(patInfo,&#34;,&#34;,29) s collectTime=$p(patInfo,&#34;,&#34;,17) ;2017-08-14 11:57 s collectTime=$tr(collectTime,&#34;- :&#34;,&#34;&#34;)_&#34;00&#34; s status=$p(labnoInfo,&#34;@&#34;,2) s labnoInfo=$p(labnoInfo,&#34;@&#34;,1) s curTime=$zd($h,8)_$tr($zt($p($h,&#34;,&#34;,2)),&#34;:&#34;,&#34;&#34;) s PatType=$p(patInfo,&#34;,&#34;,12) s Wardno=$p(patInfo,&#34;,&#34;,27) s Diagnose=$p(patInfo,&#34;,&#34;,22) S patTypeFlag=&#34;RO&#34; //门诊=RO,住院=RI,体检=RC,急诊=RS I PatType=&#34;住院&#34; { S patTypeFlag=&#34;RI&#34; } I PatType=&#34;门诊&#34; { S patTypeFlag=&#34;RO&#34; } I PatType=&#34;急诊&#34; { S patTypeFlag=&#34;RS&#34; } I PatType=&#34;体检&#34; { S patTypeFlag=&#34;RC&#34; } I PatType=&#34;干诊&#34; { S patTypeFlag=&#34;RC&#34; } s MSN=&#34;MSH|^\\&amp;|HL7SND|FAC1|HL7REC|FAC2|&#34;_curTime_&#34;||OML^O21|&#34;_curTime_&#34;_&#34;_labNo_&#34;|P|2.3|||ER|ER||8859/1&#34; i status=&#34;S&#34; s MSN=&#34;MSH|^\\&amp;|HL7SND|FAC1|HL7REC|FAC2|&#34;_curTime_&#34;||RESULTS|&#34;_curTime_&#34;_&#34;_labNo_&#34;|P|2.3|||ER|ER||8859/1&#34; s PID=&#34;PID|1||&#34;_Sampleno_&#34;||&#34;_&#34;^&#34;_patName_&#34;||&#34;_birthDate_&#34;|&#34;_sex s PV1=&#34;PV1|||&#34;_Wardno_&#34;||||||||||||||||^^^^^^^^&#34;_location_&#34;|&#34; s DG1=&#34;DG1|||&#34;_Diagnose s orcF1=&#34;NW&#34;,orcF2=&#34;&#34; i status=&#34;R&#34; s orcF1=&#34;CA&#34; //i status=&#34;U&#34; s orcF1=&#34;XO&#34; s orcF2=&#34;SC&#34; i status=&#34;U&#34; s orcF1=&#34;XO&#34; s orcF2=&#34;RP&#34; s ORC=&#34;ORC|&#34;_orcF1_&#34;|&#34;_labNo_&#34;|||||&#34;_patTypeFlag_&#34;||&#34;_curTime_&#34;||&#34;_docName_&#34;|&#34;_Wardno_&#34;|||||||&#34; s obrF1=&#34;A&#34; i status=&#34;U&#34; s obrF1=&#34;G&#34; s OBR=&#34;OBR||&#34;_labNo_&#34;||AA|||&#34;_collectTime_&#34;||||&#34;_obrF1\ts OBRs=&#34;&#34; i $p(labnoInfo,&#34;@&#34;,1)=&#34;POS&#34; d .s OBRs=&#34;OBR||&#34;_labNo_&#34;||POS|||&#34;_collectTime_&#34;||||&#34;_obrF1 e d .d GetOBRs\t//s orderTxt=VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS s orderTxt=VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS q orderTxt GetOBRs s items=$tr($p(labnoInfo,&#34;,&#34;,2),&#34;|&#34;,&#34;&#34;) f i=1:1:$l(items,&#34;+&#34;) d .s item=$p(items,&#34;+&#34;,i) .s splitStr=$p(OBR,&#34;|&#34;,5) .s curOBR=$p(OBR,splitStr,1)_item_$p(OBR,splitStr,2) .s OBRs=OBRs_curOBR_CR q } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=&#34;&#34; s chl=&#34;&#34; f s chl=$o(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) q:chl=&#34;&#34; d .s tcx=tcx_chl_&#34;+&#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) i $l(tcx) s tcx=labno_&#34;,&#34;_tcx_&#34;|&#34; d Trace^MI.MIF000(mi,tcx,&#34;H--&gt;M&#34;) d Trace^MI.MIF000(56,&#34;共&#34;_$l(tcx,&#34;+&#34;)_&#34;个项目。&#34;_tcx,&#34;H--&gt;M&#34;) //YHR 20230816 将上传信息存入罗氏infinity仪器 q tcx } /// w ##Class(MI.MIFRS600).GetPatInfo(57,9000001912) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q &#34;&#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) i &#39;$l(VisitNumberDR) q &#34;&#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=&#34;&#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=&#34;&#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=&#34;&#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName\ts SpeciesDR=$lg(RPVisitNumberData,15),Species=&#34;&#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=&#34;&#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=&#34;&#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,&#34;,&#34;,1),3)_&#34; &#34;_$zt($p($h,&#34;,&#34;,2)) s Instrument = &#34;XN&#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) i $l(Instrument) s Instrument=$tr(Instrument,&#34;,&#34;,&#34;^&#34;) s Sampleno=$lg(RPVisitNumberData,6) //病案号 s Sampletype=&#34;&#34; s Feetype=&#34;&#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 &#34;&#34; s BarCode=&#34;&#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=&#34;男&#34; s Sex=&#34;1&#34; ;1:男 ，2 女 i Species =&#34;女&#34; s Sex=&#34;2&#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=&#34;&#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=&#34;&#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_&#34;-&#34;_$e(ReceiveDate,5,6)_&#34;-&#34;_$e(ReceiveDate,7,8)_&#34; &#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=&#34;&#34; ;报告日期 = 初审(保存结果)时间 s Printflag=&#34;&#34; ;打印标志 s Resultflag=&#34;&#34; ;结果标志 s Errflag=&#34;&#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=&#34;&#34; ;备注 s Reserve=&#34;&#34; ;保留字段 s Patnamn=&#34;&#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_&#34;-&#34;_$e(CollectDate,5,6)_&#34;-&#34;_$e(CollectDate,7,8)_&#34; &#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=&#34;&#34; s WardnoDR=$lg(RPVisitNumberData,26) ;病区 i $l(WardnoDR) s Wardno=$lg($g(^dbo.BTWardD(WardnoDR)),3) s RetString=&#34;&#34; s RetString=$tr(Sampleda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Instrument,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampleno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampletype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Feetype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdepno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdocno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Userno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patna,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sex,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Pattype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Bedno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patage,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Ageunit,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Reportda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Printflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Resultflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Errflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Diagnose,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Description,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reserve,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patnamn,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Getda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Wardno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BarCode,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BirthDate,&#34;,&#34;,&#34;&#34;) q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename) q } /// 流水号特殊处理 /// w ##class(MI.MIFRS600).GetEpis() ClassMethod GetEpis() { s sign=1 while sign=1 { s maxEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByRowIDMTHD(&#34;5&#34;) //YHR 20230810 罗氏流水线规则 s ret=$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,67,maxEpis)) i ret&#39;=0 s sign=1 e d s sign=0 } q maxEpis } /// 保存报警提示信息 /// YHR 20230828 /// w ##Class(MI.MIFRS600).SaveAlarmInformation(57,9000001960,&#34;CSCSCS&#34;) ClassMethod SaveAlarmInformation(mi, epis, expertRules) { s mi=$g(mi) s epis=$g(epis) s expertRules=$g(expertRules) s ReportDR=$$GetReportID(mi,epis) s obj=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) s obj.MinorConclusion=expertRules s ret=obj.%Save() q ret GetReportID(mi,epis) i $l(epis)&lt;10 d .s AssayNo=epis e d .s AssayNo=$$GetEpisByLabno(mi,epis) s WGMachineID=$lg(^dbo.BTMIMachineParameterD(mi),6) s WGMachineID1=$lg(^dbo.BTMIMachineParameterD(mi),6) s ReportID=&#34;&#34; i $D(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WGMachineID,AssayNo)) d .s TransmitDate=$O(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WGMachineID,AssayNo,&#34;&#34;)) .s ReportID=$O(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WGMachineID,AssayNo,TransmitDate,&#34;&#34;)) q ReportID GetEpisByLabno(mi,Epis) ;Index IndexVisitNumber On VisitNumber [ SqlName = Index_VisitNumber, Type = index, Unique ]; ;Index IndexReportID On (VisitNumberDR, WorkGroupMachineDR, OrderNo) [ SqlName = Index_ReportID, Type = index, Unique ]; s ret=&#34;&#34;,mi=$g(mi),Epis=$g(Epis) i &#39;$l(mi) q Epis s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,Epis)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,Epis,&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitnumberDR,WGMachineID,1)) d ..s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitnumberDR,WGMachineID,1,&#34;&#34;)) ..s ret=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),8) q ret } } 附录 仪器文档提取数据格式 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 第十章LIS 10.1Order格式 [VT] MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||OML^O21|20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR] PID|1||00943729|9009|^Test||19811002|F[CR] PV1|||041||||||||||||||||^^^^^^^^产六科|[CR] DG1|||宫内孕37+5天[CR] ORC|NW|121092103669|||||RI||20210922075000|医保|10001|041|||||||[CR] OBR||121092103669||YLCSC|||||||A[CR] OBR||121092103669||ATPO|||||||A[CR] OBR||121092103669||FT4|||||||A[CR] OBR||121092103669||TSH|||||||A[CR] [FS] [CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 OML^O21：message type Order的消息类型，Order发送必须用OML^O21 20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复） 00943729：病人的门诊或住院号 9009：样本号 ^Test：病人姓名 19811002：出生年月日 F：性别（F = Female；M = Male；U = Unknown） 宫内孕37+5天：临床诊断(如果有代码就用临床诊断得代码，没有就用文字描述) NW：Action code (NW:新建；XO：修改；CA：删除) 121092103669：条码号 RI：病人类别（门诊；住院；急诊；体检……） 20180201101033：时间戳(精确到秒无需毫秒) 医保：病人收费类别 10001：申请医生代码 041：申请科室代码 121092103669：条码号 YLCSC：测试项目代号 10.2Result格式 [VT] MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||RESULTS |20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR] PID|1||00943729|9009|^Test||19811002|F[CR] PV1|||041||||||||||||||||^^^^^^^^产六科|[CR] DG1|||宫内孕37+5天[CR] ORC|NW|121092103669|9009||||RI||20210922075000|医保|10001|041|||||||[CR] OBR||121092103669||YLCSC|||||||A[CR] OBX|1|NM|YLCSC||1.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||ATPO|||||||A[CR] OBX|1|NM|ATPO||2.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||FT4|||||||A[CR] OBX|1|NM|FT4||3.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||TSH|||||||A[CR] OBX|1|NM|TSH||6.1||||||F|||20210922101033|c6000^E11[CR] [FS] [CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 RESULTS：message type Order的消息类型，结果回传必须用RESULTS 20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复） 00943729：病人的门诊或住院号 9009：样本号 ^Test：病人姓名 19811002：出生年月日 F：性别（F = Female；M = Male；U = Unknown） NW：Action code (NW:新建；XO：修改；CA：删除) 121092103669：条码号 RI：病人类别（门诊；住院；急诊；体检……） 20210922075000：时间戳(精确到秒无需毫秒) 医保：病人收费类别 10001：申请医生代码 041：申请科室代码 121092103669：条码号 NM：Value Type (NM = Numeric；ST = String data) YLCSC：测试项目代号 1.1：项目测试结果 c6000^E11：分析仪名称和模块名称 10.3Seen格式 01前处理条码扫描消息格式 [VT] MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR] SAC|||0800150242|0800150242||20220908183340|01||P|MILESTON1|0@0[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^SEEN：消息类型 0800150242：条码号 MILESTON1：前处理名称 0@0：架子号和位置号 20220908183340：消息产生的时间 02前处理分类Distribution消息格式 [VT] MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^RESULT|20220908183340|SORTED[CR] SAC|||0800150242|0800150242||20220908183340|01||R|c6000|0@0[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^RESULT：消息类型 0800150242：条码号 MILESTON1：前处理名称 c6000：分析仪名称 0@0：架子号和位置号 20220908183340：消息产生的时间 03前处理归档消息格式 [VT] MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^ARCHIVE|20220908183340|SORTED[CR] SAC|||0800150242|0800150242||20220908183340|01||R|MILESTON1|23@1[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^ARCHIVE：消息类型 0800150242：条码号 MILESTON1：前处理名称 23@1：架子号和位置号 20220908183340：消息产生的时间 特殊处理 标本拒收更改标本上传状态为R\n">
<meta property='og:url' content='https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/'>
<meta property='og:site_name' content='木子洋'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='罗氏仪器' /><meta property='article:published_time' content='2025-09-03T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-09-03T23:20:57&#43;00:00'/><meta property='og:image' content='https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713171820668-20250317141249-oljkc64.png' />
<meta name="twitter:title" content="罗氏流水线RS600">
<meta name="twitter:description" content="接口说明 仪器厂商 罗氏流水线RS600\n仪器型号 罗氏流水线RS600\n通讯方式 单向|双向|主动上传☑\n仪器类型 医院名称 程序名称 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：串口|网口|监听文件☑|数据库|其他 连接方式：HL7协议|ASTM协议|监听文件☑|数据库|其他 仪器接口说明 对于数据上传增加业务内容修改，仅作参考 串口盒子配置 波特率： 9600 数据位：8 停止位： 1 校验位： N 仪器图片 仪器配置 数据格式 项目通道号 修改记录 序号 日期 操作人 说明 1 2025-08-29 14:23:27\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;Z:\\\\ResultExport\\\\&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFLICA800&#34;,&#34;Para&#34;:&#34;.csv&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UpPara&#34;:&#34;Z:\\\\Imports\\\\&#34;}] Class MI.MIFRS600 Extends %RegisteredObject { /// D ##class(MI.MIFInfinity).fileMTHD(&#34;7&#34;,&#34;MSH|^~\\&amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#&#34;,&#34;&#34;) /// seen: [VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR] /// result: [VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR] /// D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;&#34;,&#34;&#34;) /// seen: D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]&#34;,&#34;&#34;) /// result:D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]&#34;,&#34;&#34;) ClassMethod fileMTHD(mi, record, epis, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;0&#34; s HospitalDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),4) i &#39;$l(record) q &#34;0&#34; i &#39;$d(^TMPLIS(&#34;RS600&#34;,mi,&#34;ERR&#34;)) s ^TMPLIS(&#34;RS600&#34;,mi,&#34;ERR&#34;)=&#34;&#34; d Trace^MI.MIF000(mi,record,&#34;H&lt;--M&#34;) s miold=mi s recordbak=record //仪器临时结果映射 s TMPMachResMap=&#34;&#34; //解析多行合并数据 f i=1:1:$l(recordbak,&#34;#enter#&#34;) d .s record=$p(recordbak,&#34;#enter#&#34;,i) .d Trace^MI.MIF000(mi,&#34;解析行数据:&#34;_record,&#34;H&lt;--M&#34;) .i &#39;$l(record) q .s mi=miold .//识别前处理上机信息 .//取出第一位命令类型 .s type=$p(record,&#34;|&#34;,1) .//解析EQU命令 .i type=&#34;EQU&#34; d ..//前处理Seen命令 ..s commandchild=$p($p(record,&#34;|&#34;,3),&#34;^&#34;,7) ..d Trace^MI.MIF000(mi,&#34;前处理命令为:&#34;_commandchild,&#34;H&lt;--M&#34;) .//解析SAC命令 .i type=&#34;SAC&#34; d ..//解析上前处理信息 ..//取出流水号 ..s epis=$p(record,&#34;|&#34;,5) ..//取出前处理或仪器信息 ..s machCode=$p(record,&#34;|&#34;,11) ..//取出位置信息 ..s positioninfo=$p(record,&#34;|&#34;,12) ..//-----------------------------------------------------------------------------------------------&gt;根据前处理命令处理 ..i commandchild=&#34;SEEN&#34; d //自动核收 ...//得到当前工作小组 ...s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) ...s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) ...s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) ...//得到仪器工作小组的核收类型 ...s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13) ...//如果是前处理小组，就认为上前处理 ...//************************************************************************************************ ...i AcceptFlag=&#34;1&#34; d ....d Trace^MI.MIF000(mi,&#34;上前处理，鉴定号:&#34;_epis_&#34;的标本在:&#34;_curMachName_&#34;,样本所在:&#34;_positioninfo,&#34;H&lt;--M&#34;) ....d Trace^MI.MIF000(mi,&#34;执行核收到前处理&#34;,&#34;H&lt;--M&#34;) ....//此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 ....s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,epis,&#34;&#34;) ....d Trace^MI.MIF000(mi,epis_&#34;核收到前处理返回信息:&#34;_dealret,&#34;H&lt;--M&#34;) ....//记录位置信息到报告位置号 ....d ..SaveRackNo(epis,positioninfo,mi) ....i dealret[&#34;标本已核收&#34; q ....i dealret=&#34;1&#34; d .....//写标本操作日志 .....d ..SaveRecord(epis,machCode,mi,&#34;5&#34;) ....e d .....s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .....s perUser = &#34;WG-&#34;_CurWorkGroupDR .....s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_epis_&#34;前处理核收失败:&#34;_dealret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) .....//写标本操作日志 .....d ..SaveRecord(epis,dealret,mi,&#34;100&#34;) .....//************************************************************************************************ ...e d ....d Trace^MI.MIF000(mi,&#34;上仪器，鉴定号:&#34;_epis_&#34;的标本在:&#34;_curMachName_&#34;,样本所在:&#34;_positioninfo,&#34;H&lt;--M&#34;) ....//核收操作，记录位置号5984@1 ....//标本操作，类型：已上机，备注：C8000A 5984@1 ....//上机提示（仪器项目上传日志，增加流水号索引） ....//此处调核收逻辑核收到仪器，标本从前处理小组进入仪器的小组 ....s dealret=##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(mi,epis,&#34;&#34;,&#34;&#34;,&#34;LSHS&#34;) ....;s RetLL=$$SaveLastMachine^MI.MIF000(mi,epis,&#34;1&#34;) ....;d Trace^MI.MIF000(mi,RetLL,&#34;最后仪器&#34;) ....d Trace^MI.MIF000(mi,epis_&#34;核收到仪器返回:&#34;_dealret,&#34;H&lt;--M&#34;) ....d Trace^MI.MIF000(mi,epis_&#34;执行记录位置号:&#34;_positioninfo,&#34;H&lt;--M&#34;) ....//不管接收是否成功，记录位置信息到报告位置号 ....d ..SaveRackNo(epis,&#34;已上机:&#34;_positioninfo,mi) ....d Trace^MI.MIF000(mi,epis_&#34;记录位置号完成&#34;,&#34;H&lt;--M&#34;) ....i dealret[&#34;标本已核收&#34; q ....i dealret=&#34;1&#34; d .....//写标本操作日志 .....d ..SaveRecord(epis,&#34;仪器:&#34;_curMachName_&#34;,位置:&#34;_positioninfo_&#34;核收&#34;,mi,&#34;5&#34;) .....d ..SaveRecord(epis,&#34;已上流水线:&#34;_positioninfo,mi,&#34;5&#34;) ....e d .....s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .....s perUser = &#34;WG-&#34;_CurWorkGroupDR .....s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_epis_&#34;前处理核收失败:&#34;_dealret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) .....//写标本操作日志 .....d ..SaveRecord(epis,dealret,mi,&#34;100&#34;) ..//-----------------------------------------------------------------------------------------------&gt;根据前处理命令处理 ..i commandchild=&#34;RESULT&#34; d //处理分类信息 ...//通过仪器对照码取仪器 ...s curMachName=machCode ...//此处存标本全部审核报告的位置号 ...d Trace^MI.MIF000(mi,&#34;分类信息，标本号:&#34;_epis_&#34;的样本所在仪器:&#34;_curMachName_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) ...d Trace^MI.MIF000(mi,epis_&#34;执行记录分类信息:&#34;_positioninfo,&#34;H&lt;--M&#34;) ...//保存分类信息到架子号 ...d ..SaveCARCH(epis,curMachName_&#34;: &#34;_positioninfo,mi,curMachName) ...d Trace^MI.MIF000(mi,epis_&#34;记录分类信息完成&#34;,&#34;H&lt;--M&#34;) ...//写标本操作日志 ...d ..SaveRecord(epis,&#34;上机位置:&#34;_positioninfo,mi,&#34;6&#34;) ..//-----------------------------------------------------------------------------------------------&gt;根据前处理命令处理 ..i commandchild=&#34;ARCHIVE&#34; d //处理归档信息 ...//通过仪器对照码取仪器 ...s curMachName=machCode ...//此处存标本全部审核报告的位置号 ...d Trace^MI.MIF000(mi,&#34;归档信息，标本号:&#34;_epis_&#34;的样本所在仪器:&#34;_curMachName_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) ...d Trace^MI.MIF000(mi,epis_&#34;执行记录分类信息:&#34;_positioninfo,&#34;H&lt;--M&#34;) ...//保存归档信息到架子号 ...d ..SaveCARCH(epis,&#34;归档:&#34;_positioninfo,mi,&#34;归档&#34;) ...d Trace^MI.MIF000(mi,epis_&#34;记录归档信息完成&#34;,&#34;H&lt;--M&#34;) ...//写标本操作日志 ...d ..SaveRecord(epis,&#34;归档位置:&#34;_positioninfo,mi,&#34;101&#34;) .//-----------------------------------------------------------------------------------------------&gt;处理结果数据 .//解析质控数据,P业务数据，Q质控数据 .i (type[&#34;MSH&#34;) d ..s ^TMP(&#34;RS600&#34;,mi,&#34;MSH&#34;)=$p(record,&#34;|&#34;,10) ..//取日期串 ..s DateStr=$p(record,&#34;|&#34;,7) ..//解析保存日期串 ..i $l(DateStr)=14 s ^TMP(&#34;RS600&#34;,mi,&#34;DATE&#34;)=$e(DateStr,1,8)_&#34;,&#34;_(($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60)) .i type=&#34;OBR&#34; s ^TMP(&#34;RS600&#34;,mi,&#34;OBR&#34;)=$p(record,&#34;|&#34;,3) .i type=&#34;ORC&#34; s ^TMP(&#34;RS600&#34;,mi,&#34;ORC&#34;)=$p(record,&#34;|&#34;,3) .//仪器警告 .i type=&#34;NTE&#34; d\t..s WaringStr=$p(record,&#34;|&#34;,4) ..d Trace^MI.MIF000(mi,&#34;仪器报警信息:&#34;_WaringStr,&#34;H&lt;--M&#34;) ..s WaringCode=$p(WaringStr,&#34; &#34;,2) ..i $l(WaringCode) d ...i WaringCode=&#34;5&#34; s WaringStr=&#34;&gt;ABS(超出ABS)&#34; ...e i WaringCode=&#34;43&#34; s WaringStr=&#34;Cal.E(校准结果异常)&#34; ...e i WaringCode=&#34;2&#34; s WaringStr=&#34;&gt;Cuvet(反应杯空白异常)&#34; ...e i WaringCode=&#34;42&#34; s WaringStr=&#34;Edit(实验结果已被编辑)&#34; ...e i WaringCode=&#34;23&#34; s WaringStr=&#34;&gt;ISE(超出ISE范围)&#34; ...e i WaringCode=&#34;19&#34; s WaringStr=&#34;ISE.E(ISE电压级错误)&#34; ...e i WaringCode=&#34;56&#34; s WaringStr=&#34;&gt;Kin(Prozone错误2/运动不稳)&#34; ...e i WaringCode=&#34;10&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; ...e i WaringCode=&#34;11&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; ...e i WaringCode=&#34;6&#34; s WaringStr=&#34;&gt;Prozone(Prozone错误1)&#34; ...e i WaringCode=&#34;4&#34; s WaringStr=&#34;Reag.S(试剂不足)&#34; ...e i WaringCode=&#34;44&#34; s WaringStr=&#34;&gt;Rept(高出原倍复查范围)&#34; ...e i WaringCode=&#34;45&#34; s WaringStr=&#34;&lt;Rept(低于原倍复查范围)&#34; ...e i WaringCode=&#34;46&#34; s WaringStr=&#34;Samp.？(高出ABS最大值)&#34; ...e i WaringCode=&#34;68&#34; s WaringStr=&#34;Samp.B(样本中有气泡)&#34; ...e i WaringCode=&#34;72&#34; s WaringStr=&#34;Samp.C(样本中有凝块)&#34; ...e i WaringCode=&#34;26&#34; s WaringStr=&#34;&gt;Test(高出线性范围)&#34; ...e i WaringCode=&#34;27&#34; s WaringStr=&#34;&lt;Test(低于线性范围)&#34; ..//保存仪器报警信息到组内报告评价 ..d ..SaveResultWarned(epis,WaringStr,mi) .d ##class(MI.Special.RecordGlobal).RecordData(epis,recordbak,&#34;MI.MIFRS600&#34;,1,10)\t//YHR 20230828 记录十天的数据 .i type=&#34;OBX&#34; d ..s (sample,result,date,time,QC)=&#34;&#34; ..s epis=^TMP(&#34;RS600&#34;,mi,&#34;OBR&#34;) ..s machCode=$p($p($p($p(record,&#34;|&#34;,16),&#34;^&#34;,1),&#34;:&#34;,1),&#34;^&#34;,1) ..d Trace^MI.MIF000(mi,&#34;解析仪器对照码:&#34;_machCode,&#34;H&lt;--M&#34;) ..//通过仪器对照码取仪器 ..s code=$p($p(record,&#34;|&#34;,4),&#34;^&#34;,1) ;AHBS^6012 ..s reswaring=$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2) ..s res=$p($p(record,&#34;|&#34;,6),&#34;^&#34;,1) ;[&#34;&#34;一般|-1阴性+定量|1阳性+定量|0临界值] ..s CallThePolice=$p($p(record,&#34;|&#34;,9),&#34;^&#34;,2) ..i $l(CallThePolice) d ...try{d ..SaveAlarmInformation(mi,epis,CallThePolice)}catch {} //YHR 20230828 保存报警信息 ..//i res=-1 s res=&#34;阴性&#34;_$c(92)_$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2)_$c(92)_$c(92)_reswaring ..//e i res=1 s res=&#34;阳性&#34;_$c(92)_$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2)_$c(92)_$c(92)_reswaring ..//e i res=0 s res=&#34;临界值&#34;_$c(92)_$p($p(record,&#34;|&#34;,6),&#34;^&#34;,2)_$c(92)_$c(92)_reswaring ..//e s res=&#34;临界值&#34;_$c(92)_$c(92)_$c(92)_reswaring ..i res=&#34;SORTED&#34; q ..i res=&#34;N/I&#34; q ..//标本质量数据当做仪器报警，不让自动审核 ..i code=&#34;SQ-D&#34; d ...//保存仪器报警信息到报告评价 ...//d ..SaveResultWarned(epis,res,mi) ...d ..SaveQuality(epis,res,mi) ..//计算肾小球滤过率 ..i code=&#34;8690&#34; d ...s x1=&#34;Cur&#34; ...s x2=##class(MI.Special.GetSxqlgl).GeteGFRResultLast(mi,epis,res) ...i $l(x2) s result=result_x1_$c(92)_x2_$c(44) ..s result=result_code_$c(92)_res_$c(44) ..d Trace^MI.MIF000(mi,epis_&#34;:&#34;_result,&#34;H&lt;--M&#34;) ..d Trace^MI.MIF000(mi,&#34;按对照仪器保存数据:&#34;_machCode,&#34;H&lt;--M&#34;) ..//统一保存结果 ..i $l(epis),$l(result) d ...d Trace^MI.MIF000(mi,epis_&#34;$$&#34;_result,&#34;H&lt;--M&#34;) ...s DateStr=&#34;&#34; ...i $d(^TMP(&#34;RS600&#34;,mi,&#34;DATE&#34;)) s DateStr=^TMP(&#34;RS600&#34;,mi,&#34;DATE&#34;) ...i $l(DateStr) d ....s date=$p(DateStr,&#34;,&#34;,1) ....s time=$p(DateStr,&#34;,&#34;,2) ...d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) q &#34;1&#34; } // 记录标本日志 // D ##class(MI.MIFRS600).SaveRecord(&#34;&#34;,&#34;&#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi) s OperateTypeCode=$g(OperateTypeCode) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,&#34;,&#34;,2),&#34;&#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,&#34;&#34;) } // 保存仪器报警信息 // D ##class(MI.MIFRS600).SaveResultWarned(&#34;&#34;,&#34;&#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.ResultWarned) s objrep.ResultWarned=objrep.ResultWarned_&#34;,&#34;_conclusion .....e s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存仪器报警信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // 保存仪器报警信息(标本质量) // D ##class(MI.MIFRS600).SaveQuality(&#34;&#34;,&#34;&#34;) ClassMethod SaveQuality(labno, conclusion, predealMI) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_&#34;,&#34;_conclusion .....e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // 保存架子号 // D ##class(MI.MIFRS600).SaveRackNo(&#34;&#34;,&#34;&#34;) ClassMethod SaveRackNo(labno, positioninfo, mi) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s CanDoTS=0 .....i $d(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,ReportDR)) d ......s TestSetDR=&#34;&#34; f s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,ReportDR,TestSetDR)) q:TestSetDR=&#34;&#34; d .......i $d(^dbo.BTTestSetWorkGroupMachineI(&#34;IndexWorkGroupMachine&#34;,curWorkGroupMachineDR,TestSetDR)) d ........s CanDoTS=1 .....i CanDoTS=0 q .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,&#34;-1^存位置信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // 保存归档和分类信息 // D ##class(MI.MIFRS600).SaveCARCH(&#34;1000100990&#34;,&#34;2@2&#34;,57,&#34;归档&#34;) ClassMethod SaveCARCH(labno, positioninfo, mi, typename) { s labno=$g(labno) s positioninfo=$g(positioninfo) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo) d ......i $p(objrep.RackNo,&#34;-&gt;&#34;,*)[typename d .......s positioninfo=$p(objrep.RackNo,typename,1)_positioninfo ......e d .......s positioninfo=objrep.RackNo_&#34;-&gt;&#34;_positioninfo .....s objrep.RackNo=positioninfo .....s objrep.LastMachineLName=&#34;&#34; .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,&#34;-1^存&#34;_typename_&#34;信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0 d Trace^MI.MIF000(mi,labno_&#34;:没有找到&#34;_typename_&#34;的报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } // D ##class(MI.MIFRS600).SaveImageMTHD(&#34;8&#34;,&#34;1000001727&#34;,&#34;07&#34;,&#34;/LIS/IT3000/20180823/SerumQ0001_orig_64_1000001727_8170_4_0__04.jpg&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) // 保存标本图片 // D ##class(MI.MIFRS600).SaveImageMTHD(&#34;57&#34;,&#34;1000100990&#34;,&#34;P&#34;,&#34;/iLISLIS080/demo.png&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //s ^TMP(&#34;zlzi&#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=&#34;1&#34; i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=&#34;&#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis),&#34;&#34;)) .i $d(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=&#34;&#34; f s RowID=$o(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=&#34;&#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i &#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=&#34;SerumQ&#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (&#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= &#34;-1^保存报告图片失败:&#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_&#34;:&#34;_ImageClass_&#34;:&#34;_FileName,&#34;H&lt;--M&#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=&#34;&#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // w ##class(MI.MIFRS600).GetFtpMTHD(&#34;24&#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = &#34;labno,labnoInfo,patInfo&#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(&#34;MI.MIFRS600&#34;,&#34;QryLabInfo&#34;,&#34;57&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; s LabnoList=&#34;&#34; s VisitNumberDR=&#34;&#34; //*--------------------------------&gt;*申请项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..b ;VisitNumberDR ..i &#39;$l(VisitNumberDR) q ..;i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=&#34;0&#34; ..i TestType=&#34;0&#34; d ...b ;1 ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@C&#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ...s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ...d Trace^MI.MIF000(mi,txtInfo,&#34;上传信息&#34;) ...d OutputRow ...//文本双向上传结束****************************************************** ////*--------------------------------&gt;*复查结果上传 s AddDate=$zd($p($h,&#34;,&#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;)) ..b ;F101 ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..b ;VisitNumberDR ..i &#39;$l(VisitNumberDR) q ..i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=&#34;0&#34; ..i TestType=&#34;0&#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ...s labnoInfo=labno_&#34;,&#34;_$replace(TCList,&#34;\\&#34;,&#34;+&#34;)_&#34;|@U&#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ...s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ...d Trace^MI.MIF000(mi,txtInfo,&#34;上传信息&#34;) ...d OutputRow ...//文本双向上传结束****************************************************** //*--------------------------------&gt;*取消项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime,&#34;&#34;)) ..b ;101 ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..b ;12 ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..b ;VisitNumberDR ..i &#39;$l(VisitNumberDR) q ..;i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//测试类型0：文本，1：数据库 ..s TestType=&#34;0&#34; ..i TestType=&#34;0&#34; d ...//文本双向上传开始****************************************************** ...//控制输出文本的内容 ...s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@R&#34; ...s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ...s now=$now() ...s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ...s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ...s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ...d Trace^MI.MIF000(mi,txtInfo,&#34;上传信息&#34;) ...d OutputRow ...//文本双向上传结束****************************************************** Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=&#34;labno,labnoInfo,patInfo&#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=&#34;&#34; { Set AtEnd=1 Set Row=&#34;&#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 获取申请名称和内容 /// 申请名称： /// 发送申请：order_2012051718302501_9999999901NW.HL7 /// 取消申请：order_2012051718302501_9999999901CA.HL7 /// 项目复查：order_2012051718302501_9999999901XO.HL7 /// w ##class(MI.MIFRS600).GetLisOrderMTHD(&#34;8&#34;,&#34;POS@C@1&#34;,&#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08 -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34; ,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod GetLabnoInfoN(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s VT=&#34;[11]&#34;,FS=&#34;[28]&#34;,CR=&#34;[13]&#34; s labNo=$p(patInfo,&#34;,&#34;,16) s Sampleno=$p(patInfo,&#34;,&#34;,3) //i labNo=&#34;74623177&#34; s ^TMP(&#34;zlzit3000d&#34;)=$lb(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s location=$p(patInfo,&#34;,&#34;,6) s docName=$p(patInfo,&#34;,&#34;,7) s regNo=$p(patInfo,&#34;,&#34;,9) s patName=$p(patInfo,&#34;,&#34;,10) s sex=$p(patInfo,&#34;,&#34;,11) i sex=&#34;1&#34; s sex=&#34;M&#34; i sex=&#34;2&#34; s sex=&#34;F&#34; i (sex&#39;=&#34;M&#34;)&amp;&amp;(sex&#39;=&#34;F&#34;) s sex=&#34;U&#34; s birthDate=$p(patInfo,&#34;,&#34;,29) s collectTime=$p(patInfo,&#34;,&#34;,17) ;2017-08-14 11:57 s collectTime=$tr(collectTime,&#34;- :&#34;,&#34;&#34;)_&#34;00&#34; s status=$p(labnoInfo,&#34;@&#34;,2) s labnoInfo=$p(labnoInfo,&#34;@&#34;,1) s curTime=$zd($h,8)_$tr($zt($p($h,&#34;,&#34;,2)),&#34;:&#34;,&#34;&#34;) s PatType=$p(patInfo,&#34;,&#34;,12) s Wardno=$p(patInfo,&#34;,&#34;,27) s Diagnose=$p(patInfo,&#34;,&#34;,22) S patTypeFlag=&#34;RO&#34; //门诊=RO,住院=RI,体检=RC,急诊=RS I PatType=&#34;住院&#34; { S patTypeFlag=&#34;RI&#34; } I PatType=&#34;门诊&#34; { S patTypeFlag=&#34;RO&#34; } I PatType=&#34;急诊&#34; { S patTypeFlag=&#34;RS&#34; } I PatType=&#34;体检&#34; { S patTypeFlag=&#34;RC&#34; } I PatType=&#34;干诊&#34; { S patTypeFlag=&#34;RC&#34; } s MSN=&#34;MSH|^\\&amp;|HL7SND|FAC1|HL7REC|FAC2|&#34;_curTime_&#34;||OML^O21|&#34;_curTime_&#34;_&#34;_labNo_&#34;|P|2.3|||ER|ER||8859/1&#34; i status=&#34;S&#34; s MSN=&#34;MSH|^\\&amp;|HL7SND|FAC1|HL7REC|FAC2|&#34;_curTime_&#34;||RESULTS|&#34;_curTime_&#34;_&#34;_labNo_&#34;|P|2.3|||ER|ER||8859/1&#34; s PID=&#34;PID|1||&#34;_Sampleno_&#34;||&#34;_&#34;^&#34;_patName_&#34;||&#34;_birthDate_&#34;|&#34;_sex s PV1=&#34;PV1|||&#34;_Wardno_&#34;||||||||||||||||^^^^^^^^&#34;_location_&#34;|&#34; s DG1=&#34;DG1|||&#34;_Diagnose s orcF1=&#34;NW&#34;,orcF2=&#34;&#34; i status=&#34;R&#34; s orcF1=&#34;CA&#34; //i status=&#34;U&#34; s orcF1=&#34;XO&#34; s orcF2=&#34;SC&#34; i status=&#34;U&#34; s orcF1=&#34;XO&#34; s orcF2=&#34;RP&#34; s ORC=&#34;ORC|&#34;_orcF1_&#34;|&#34;_labNo_&#34;|||||&#34;_patTypeFlag_&#34;||&#34;_curTime_&#34;||&#34;_docName_&#34;|&#34;_Wardno_&#34;|||||||&#34; s obrF1=&#34;A&#34; i status=&#34;U&#34; s obrF1=&#34;G&#34; s OBR=&#34;OBR||&#34;_labNo_&#34;||AA|||&#34;_collectTime_&#34;||||&#34;_obrF1\ts OBRs=&#34;&#34; i $p(labnoInfo,&#34;@&#34;,1)=&#34;POS&#34; d .s OBRs=&#34;OBR||&#34;_labNo_&#34;||POS|||&#34;_collectTime_&#34;||||&#34;_obrF1 e d .d GetOBRs\t//s orderTxt=VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS s orderTxt=VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS q orderTxt GetOBRs s items=$tr($p(labnoInfo,&#34;,&#34;,2),&#34;|&#34;,&#34;&#34;) f i=1:1:$l(items,&#34;+&#34;) d .s item=$p(items,&#34;+&#34;,i) .s splitStr=$p(OBR,&#34;|&#34;,5) .s curOBR=$p(OBR,splitStr,1)_item_$p(OBR,splitStr,2) .s OBRs=OBRs_curOBR_CR q } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=&#34;&#34; s chl=&#34;&#34; f s chl=$o(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) q:chl=&#34;&#34; d .s tcx=tcx_chl_&#34;+&#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) i $l(tcx) s tcx=labno_&#34;,&#34;_tcx_&#34;|&#34; d Trace^MI.MIF000(mi,tcx,&#34;H--&gt;M&#34;) d Trace^MI.MIF000(56,&#34;共&#34;_$l(tcx,&#34;+&#34;)_&#34;个项目。&#34;_tcx,&#34;H--&gt;M&#34;) //YHR 20230816 将上传信息存入罗氏infinity仪器 q tcx } /// w ##Class(MI.MIFRS600).GetPatInfo(57,9000001912) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q &#34;&#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) i &#39;$l(VisitNumberDR) q &#34;&#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=&#34;&#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=&#34;&#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=&#34;&#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName\ts SpeciesDR=$lg(RPVisitNumberData,15),Species=&#34;&#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=&#34;&#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=&#34;&#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,&#34;,&#34;,1),3)_&#34; &#34;_$zt($p($h,&#34;,&#34;,2)) s Instrument = &#34;XN&#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) i $l(Instrument) s Instrument=$tr(Instrument,&#34;,&#34;,&#34;^&#34;) s Sampleno=$lg(RPVisitNumberData,6) //病案号 s Sampletype=&#34;&#34; s Feetype=&#34;&#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 &#34;&#34; s BarCode=&#34;&#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=&#34;男&#34; s Sex=&#34;1&#34; ;1:男 ，2 女 i Species =&#34;女&#34; s Sex=&#34;2&#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=&#34;&#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=&#34;&#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_&#34;-&#34;_$e(ReceiveDate,5,6)_&#34;-&#34;_$e(ReceiveDate,7,8)_&#34; &#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=&#34;&#34; ;报告日期 = 初审(保存结果)时间 s Printflag=&#34;&#34; ;打印标志 s Resultflag=&#34;&#34; ;结果标志 s Errflag=&#34;&#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=&#34;&#34; ;备注 s Reserve=&#34;&#34; ;保留字段 s Patnamn=&#34;&#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_&#34;-&#34;_$e(CollectDate,5,6)_&#34;-&#34;_$e(CollectDate,7,8)_&#34; &#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=&#34;&#34; s WardnoDR=$lg(RPVisitNumberData,26) ;病区 i $l(WardnoDR) s Wardno=$lg($g(^dbo.BTWardD(WardnoDR)),3) s RetString=&#34;&#34; s RetString=$tr(Sampleda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Instrument,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampleno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampletype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Feetype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdepno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdocno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Userno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patna,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sex,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Pattype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Bedno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patage,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Ageunit,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Reportda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Printflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Resultflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Errflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Diagnose,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Description,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reserve,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patnamn,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Getda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Wardno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BarCode,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BirthDate,&#34;,&#34;,&#34;&#34;) q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename) q } /// 流水号特殊处理 /// w ##class(MI.MIFRS600).GetEpis() ClassMethod GetEpis() { s sign=1 while sign=1 { s maxEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByRowIDMTHD(&#34;5&#34;) //YHR 20230810 罗氏流水线规则 s ret=$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,67,maxEpis)) i ret&#39;=0 s sign=1 e d s sign=0 } q maxEpis } /// 保存报警提示信息 /// YHR 20230828 /// w ##Class(MI.MIFRS600).SaveAlarmInformation(57,9000001960,&#34;CSCSCS&#34;) ClassMethod SaveAlarmInformation(mi, epis, expertRules) { s mi=$g(mi) s epis=$g(epis) s expertRules=$g(expertRules) s ReportDR=$$GetReportID(mi,epis) s obj=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) s obj.MinorConclusion=expertRules s ret=obj.%Save() q ret GetReportID(mi,epis) i $l(epis)&lt;10 d .s AssayNo=epis e d .s AssayNo=$$GetEpisByLabno(mi,epis) s WGMachineID=$lg(^dbo.BTMIMachineParameterD(mi),6) s WGMachineID1=$lg(^dbo.BTMIMachineParameterD(mi),6) s ReportID=&#34;&#34; i $D(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WGMachineID,AssayNo)) d .s TransmitDate=$O(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WGMachineID,AssayNo,&#34;&#34;)) .s ReportID=$O(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WGMachineID,AssayNo,TransmitDate,&#34;&#34;)) q ReportID GetEpisByLabno(mi,Epis) ;Index IndexVisitNumber On VisitNumber [ SqlName = Index_VisitNumber, Type = index, Unique ]; ;Index IndexReportID On (VisitNumberDR, WorkGroupMachineDR, OrderNo) [ SqlName = Index_ReportID, Type = index, Unique ]; s ret=&#34;&#34;,mi=$g(mi),Epis=$g(Epis) i &#39;$l(mi) q Epis s WGMachineID=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,Epis)) d .s VisitnumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,Epis,&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitnumberDR,WGMachineID,1)) d ..s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitnumberDR,WGMachineID,1,&#34;&#34;)) ..s ret=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),8) q ret } } 附录 仪器文档提取数据格式 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 第十章LIS 10.1Order格式 [VT] MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||OML^O21|20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR] PID|1||00943729|9009|^Test||19811002|F[CR] PV1|||041||||||||||||||||^^^^^^^^产六科|[CR] DG1|||宫内孕37+5天[CR] ORC|NW|121092103669|||||RI||20210922075000|医保|10001|041|||||||[CR] OBR||121092103669||YLCSC|||||||A[CR] OBR||121092103669||ATPO|||||||A[CR] OBR||121092103669||FT4|||||||A[CR] OBR||121092103669||TSH|||||||A[CR] [FS] [CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 OML^O21：message type Order的消息类型，Order发送必须用OML^O21 20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复） 00943729：病人的门诊或住院号 9009：样本号 ^Test：病人姓名 19811002：出生年月日 F：性别（F = Female；M = Male；U = Unknown） 宫内孕37+5天：临床诊断(如果有代码就用临床诊断得代码，没有就用文字描述) NW：Action code (NW:新建；XO：修改；CA：删除) 121092103669：条码号 RI：病人类别（门诊；住院；急诊；体检……） 20180201101033：时间戳(精确到秒无需毫秒) 医保：病人收费类别 10001：申请医生代码 041：申请科室代码 121092103669：条码号 YLCSC：测试项目代号 10.2Result格式 [VT] MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||RESULTS |20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR] PID|1||00943729|9009|^Test||19811002|F[CR] PV1|||041||||||||||||||||^^^^^^^^产六科|[CR] DG1|||宫内孕37+5天[CR] ORC|NW|121092103669|9009||||RI||20210922075000|医保|10001|041|||||||[CR] OBR||121092103669||YLCSC|||||||A[CR] OBX|1|NM|YLCSC||1.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||ATPO|||||||A[CR] OBX|1|NM|ATPO||2.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||FT4|||||||A[CR] OBX|1|NM|FT4||3.1||||||F|||20210922101033|c6000^E11[CR] OBR||121092103669||TSH|||||||A[CR] OBX|1|NM|TSH||6.1||||||F|||20210922101033|c6000^E11[CR] [FS] [CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 RESULTS：message type Order的消息类型，结果回传必须用RESULTS 20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复） 00943729：病人的门诊或住院号 9009：样本号 ^Test：病人姓名 19811002：出生年月日 F：性别（F = Female；M = Male；U = Unknown） NW：Action code (NW:新建；XO：修改；CA：删除) 121092103669：条码号 RI：病人类别（门诊；住院；急诊；体检……） 20210922075000：时间戳(精确到秒无需毫秒) 医保：病人收费类别 10001：申请医生代码 041：申请科室代码 121092103669：条码号 NM：Value Type (NM = Numeric；ST = String data) YLCSC：测试项目代号 1.1：项目测试结果 c6000^E11：分析仪名称和模块名称 10.3Seen格式 01前处理条码扫描消息格式 [VT] MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR] SAC|||0800150242|0800150242||20220908183340|01||P|MILESTON1|0@0[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^SEEN：消息类型 0800150242：条码号 MILESTON1：前处理名称 0@0：架子号和位置号 20220908183340：消息产生的时间 02前处理分类Distribution消息格式 [VT] MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^RESULT|20220908183340|SORTED[CR] SAC|||0800150242|0800150242||20220908183340|01||R|c6000|0@0[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^RESULT：消息类型 0800150242：条码号 MILESTON1：前处理名称 c6000：分析仪名称 0@0：架子号和位置号 20220908183340：消息产生的时间 03前处理归档消息格式 [VT] MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR] EQU||^^^MILESTONE1^^SAMPLEEVENT^ARCHIVE|20220908183340|SORTED[CR] SAC|||0800150242|0800150242||20220908183340|01||R|MILESTON1|23@1[CR] [FS][CR] [VT][FS] ：开始和结束字符 [CR] ：回车符 SAMPLEEVENT^ARCHIVE：消息类型 0800150242：条码号 MILESTON1：前处理名称 23@1：架子号和位置号 20220908183340：消息产生的时间 特殊处理 标本拒收更改标本上传状态为R\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713171820668-20250317141249-oljkc64.png' />
    <link rel="shortcut icon" href="/favicon.ico" />




<script src="/js/mammoth.browser.min.js"></script>
<script src="/js/xlsx.full.min.js"></script>
<script src="/js/pdf.min.js"></script>


<script src="/js/optimized-parsing.js"></script>


<script>
    
    window.WORKER_PATH = '/js/parser.worker.js';
</script>
    
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/touxiang_hu_3261c9b36eb249a9.jpg" width="300"
                            height="285" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">木子洋</a></h1>
            <h2 class="site-description">To be or not to be.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/muziyangg'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://gitee.com/muziyangg'
                        target="_blank"
                        title="Gitee"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1756364241553" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1459" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M739.76 462H484.2a22.22 22.22 0 0 0-22.2 22.21v55.56A22.24 22.24 0 0 0 484.19 562h155.57A22.22 22.22 0 0 1 662 584.22v11.11A66.67 66.67 0 0 1 595.31 662H384.19A22.22 22.22 0 0 1 362 639.79V428.68A66.67 66.67 0 0 1 428.64 362h311.07a22.21 22.21 0 0 0 22.22-22.2v-55.56A22.22 22.22 0 0 0 739.79 262h-311.1A166.67 166.67 0 0 0 262 428.68v311.1A22.22 22.22 0 0 0 284.22 762H612a150 150 0 0 0 150-150V484.23A22.23 22.23 0 0 0 739.77 462z m0 0" fill="#231815" p-id="1460"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>首页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/link/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                <div class="widget search-widget">
    <div class="search-box">
        <form class="search-form widget">
            <p>
                <input type="text" class="search-input" placeholder="搜索本页内容..." />
                <button type="button" title="搜索" class="search-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.33" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </p>
        </form>
        <div class="search-results" style="display: none !important;"></div>
        <div class="search-stats"></div>
    </div>
    
    <div class="search-navigation">
        <button class="nav-button" id="prev-match" aria-label="上一个匹配项">
            <img src="/icons/up.svg" alt="上一个匹配项" width="16" height="16">
        </button>
        <span id="match-counter"></span>
        <button class="nav-button" id="next-match" aria-label="下一个匹配项">
            <img src="/icons/down.svg" alt="下一个匹配项" width="16" height="16">
        </button>
    </div>
</div>

<style>
 
.search-widget {
    margin-bottom: 20px;
}

.search-box {
    position: relative;
}

.search-form {
    position: relative;
    --button-size: 80px;
    margin-bottom: 1rem;
}

.search-form.widget {
    --button-size: 60px;
}

.search-form.widget input {
    padding: 15px 20px;
    height: auto;
}

.search-form p {
    position: relative;
    margin: 0;
    display: flex;
    flex-direction: column;
}

.search-input {
    padding: 15px 20px;
    border-radius: 12px;
    background-color: var(--card-background);
    box-shadow: var(--shadow-l1);
    color: var(--card-text-color-main);
    width: 100%;
    border: 1px solid var(--card-border-color);
    -webkit-appearance: none;
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
    font-size: 1.5rem !important;
    min-height: 48px;
}

.search-input::placeholder {
    font-size: 1.5rem;
    color: var(--card-text-color-tertiary);
    opacity: 1;
}

.search-input:focus {
    outline: 0;
    box-shadow: var(--shadow-l2);
    border-color: var(--primary-color);
}

.search-button {
    position: absolute;
    right: 0;
    top: 24px;
    height: 48px;
    width: var(--button-size);
    cursor: pointer;
    background-color: transparent;
    border: 0;
    padding: 0 10px;
}

.search-button:focus svg {
    stroke-width: 2;
    color: var(--accent-color);
}

.search-button svg {
    color: var(--card-text-color-secondary);
    stroke-width: 1.33;
    transition: all 0.3s ease;
    width: 20px;
    height: 20px;
}

.search-stats {
    margin-top: 8px;
    font-size: 14px;
    color: var(--card-text-color-tertiary);
}

.search-navigation {
    display: none;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding: 8px;
    background: var(--card-background-secondary);
    border-radius: var(--card-border-radius);
}

.nav-button {
    padding: 5px 10px;
    background: #2c559c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
}

.nav-button:hover {
    background: #1e3d76;
}

.nav-button:disabled {
    background: var(--card-text-color-tertiary);
    cursor: not-allowed;
}

.nav-button img {
    filter: invert(70%);
    transition: all 0.2s ease;
}

.nav-button:hover img {
    opacity: 0.9;
}

.nav-button:disabled img {
    filter: invert(40%);
}

#match-counter {
    font-size: 14px;
    color: var(--card-text-color-tertiary);
}

.search-highlight {
    background-color: #ffeb3b;
    padding: 0 2px;
    border-radius: 3px;
    transition: background-color 0.2s ease;
}

.search-highlight.current {
    background-color: #ff9800;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('.search-widget .search-input');
    const searchResults = document.querySelector('.search-widget .search-results');
    const searchStats = document.querySelector('.search-widget .search-stats');
    const searchNav = document.querySelector('.search-widget .search-navigation');
    const prevButton = document.querySelector('.search-widget #prev-match');
    const nextButton = document.querySelector('.search-widget #next-match');
    const matchCounter = document.querySelector('.search-widget #match-counter');
    const searchForm = document.querySelector('.search-form');
    const searchButton = document.querySelector('.search-button');
    
    let currentMatches = [];
    let currentMatchIndex = -1;
    let searchDebounceTimer = null;
    const DEBOUNCE_DELAY = 1000;
    
    
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
    });
    
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            handleSearchInput(searchTerm);
        }, DEBOUNCE_DELAY);
    });
    
    
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); 
            const searchTerm = this.value.trim();
            
            
            clearTimeout(searchDebounceTimer);
            
            
            if (currentMatches.length > 0) {
                currentMatchIndex = (currentMatchIndex + 1) % currentMatches.length;
                navigateToMatch();
            } 
            
            else if (searchTerm.length >= 1) {
                handleSearchInput(searchTerm);
            }
        }
    });
    
    
    searchButton.addEventListener('click', function() {
        clearTimeout(searchDebounceTimer);
        const searchTerm = searchInput.value.trim();
        handleSearchInput(searchTerm);
    });
    
    
    function handleSearchInput(term) {
        if (term.length < 1) {
            resetSearch();
            return;
        }
        performSearch(term);
    }
    
    
    function resetSearch() {
        searchResults.style.display = 'none';
        searchNav.style.display = 'none';
        clearHighlights();
        currentMatches = [];
        currentMatchIndex = -1;
        searchStats.textContent = '';
    }
    
    
    function performSearch(term) {
        clearHighlights();
        currentMatches = [];
        currentMatchIndex = -1;
        
        const articleContent = document.querySelector('.article-content');
        if (!articleContent) return;
        
        const textNodes = getTextNodes(articleContent);
        
        textNodes.forEach(node => {
            const text = node.textContent;
            const regex = new RegExp(term, 'gi');
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                if (match.index >= 0 && match.index + match[0].length <= text.length) {
                    currentMatches.push({
                        node: node,
                        offset: match.index,
                        length: match[0].length,
                        text: match[0]
                    });
                }
                if (match.index === regex.lastIndex) {
                    regex.lastIndex++;
                }
            }
        });
        
        displaySearchResults(term);
        highlightMatches();
        updateNavigation();
        
        
        if (currentMatches.length > 0) {
            currentMatchIndex = 0;
            navigateToMatch();
        }
    }
    
    
    function getTextNodes(element) {
        const textNodes = [];
        const walker = document.createTreeWalker(
            element, 
            NodeFilter.SHOW_TEXT, 
            {
                acceptNode: function(node) {
                    if (node.parentNode.classList.contains('search-highlight') ||
                        node.parentNode.tagName === 'CODE' || 
                        node.parentNode.tagName === 'PRE') {
                        return NodeFilter.FILTER_REJECT;
                    }
                    if (node.textContent.trim().length === 0) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    return NodeFilter.FILTER_ACCEPT;
                }
            }
        );
        
        let node;
        while ((node = walker.nextNode())) {
            textNodes.push(node);
        }
        
        return textNodes;
    }
    
    
    function displaySearchResults(term) {
        if (currentMatches.length === 0) {
            searchStats.textContent = `未找到"${term}"的匹配结果`;
            searchNav.style.display = 'none';
            return;
        }
        
        searchStats.textContent = `找到${currentMatches.length}个"${term}"的匹配结果`;
        searchNav.style.display = 'flex';
    }
    
    
    function highlightMatches() {
        currentMatches.forEach(match => {
            try {
                const node = match.node;
                const textLength = node.textContent.length;
                
                if (match.offset < 0 || match.offset >= textLength) {
                    console.warn('无效的匹配偏移量', match);
                    return;
                }
                
                const endOffset = Math.min(match.offset + match.length, textLength);
                
                const range = document.createRange();
                range.setStart(node, match.offset);
                range.setEnd(node, endOffset);
                
                const highlight = document.createElement('span');
                highlight.className = 'search-highlight';
                range.surroundContents(highlight);
            } catch (e) {
                console.error('高亮匹配项失败:', e, match);
            }
        });
    }
    
    
    function clearHighlights() {
        const highlights = document.querySelectorAll('.search-highlight');
        highlights.forEach(highlight => {
            const parent = highlight.parentNode;
            const textNode = document.createTextNode(highlight.textContent);
            parent.replaceChild(textNode, highlight);
            parent.normalize();
        });
    }
    
    
    function updateNavigation() {
        matchCounter.textContent = currentMatches.length > 0 ? 
            `${currentMatchIndex + 1} / ${currentMatches.length}` : 
            '无匹配结果';
        
        prevButton.disabled = currentMatches.length === 0;
        nextButton.disabled = currentMatches.length === 0;
    }
    
    
    nextButton.addEventListener('click', function() {
        if (currentMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex + 1) % currentMatches.length;
        navigateToMatch();
    });
    
    
    prevButton.addEventListener('click', function() {
        if (currentMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex - 1 + currentMatches.length) % currentMatches.length;
        navigateToMatch();
    });
    
    
    function navigateToMatch() {
        if (currentMatchIndex < 0 || currentMatchIndex >= currentMatches.length) return;
        
        const highlights = document.querySelectorAll('.search-highlight');
        if (highlights.length > 0 && currentMatchIndex < highlights.length) {
            highlights.forEach(h => h.classList.remove('current'));
            highlights[currentMatchIndex].classList.add('current');
            highlights[currentMatchIndex].scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }
        
        updateNavigation();
    }
    
    
    searchNav.style.display = 'none';
});
</script>
    
            
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#接口说明">接口说明</a></li>
    <li><a href="#仪器上接口标示和接口类型"><strong>仪器上接口标示和接口类型</strong></a></li>
    <li><a href="#仪器接口说明">仪器接口说明</a></li>
    <li><a href="#串口盒子配置">串口盒子配置</a></li>
    <li><a href="#仪器图片">仪器图片</a></li>
    <li><a href="#仪器配置">仪器配置</a></li>
    <li><a href="#数据格式"><strong>数据格式</strong></a></li>
    <li><a href="#项目通道号"><strong>项目通道号</strong></a></li>
    <li><a href="#修改记录">修改记录</a></li>
    <li><a href="#仪器接口程序">仪器接口程序</a></li>
    <li><a href="#附录">附录</a>
      <ol>
        <li><a href="#仪器文档提取数据格式">仪器文档提取数据格式</a></li>
        <li><a href="#特殊处理">特殊处理</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/">
                <img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713171820668-20250317141249-oljkc64_hu_9961604c6273517c.png"
                        srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713171820668-20250317141249-oljkc64_hu_9961604c6273517c.png 800w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713171820668-20250317141249-oljkc64_hu_c7030e9873101ba9.png 1600w"
                        width="800" 
                        height="337" 
                        loading="lazy"
                        alt="Featured image of post 罗氏流水线RS600" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/2.%E4%BB%AA%E5%99%A8%E6%8E%A5%E5%8F%A3%E8%AE%B0%E5%BD%95/" >
                2.仪器接口记录
            </a>
        
            <a href="/categories/%E7%BB%BC%E5%90%88%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F/" >
                综合接口程序
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/">罗氏流水线RS600</a>
        </h2>
    
        
    </div>

        
        <footer class="article-time">
            
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                    <time class="article-time--published">2025-09-03</time>
                </div>
            

            
            
                        最后更新于
                        <time class="article-time--updated" datetime="2025-09-03 23:20:57 &#43;0000 UTC" title="2025-09-03 23:20:57 &#43;0000 UTC">
                            2025-09-03 23:20:57
                        </time>
			
			
			
				<div>
					<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



					<time class="article-words">
						13944字
					</time>
				</div>
			
			

            
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                    <time class="article-time--reading">
                        阅读时长: 28 分钟
                    </time>
                </div>
            
        </footer>
    


    
</div>
</header>



    <section class="article-content">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2 id="接口说明">接口说明
</h2><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">仪器厂商</th>
          <th style="text-align: left">罗氏流水线RS600<br /></th>
          <th style="text-align: left">仪器型号</th>
          <th style="text-align: left">罗氏流水线RS600<br /></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">通讯方式</td>
          <td style="text-align: left">单向|双向|主动上传☑<br /></td>
          <td style="text-align: left">仪器类型</td>
          <td style="text-align: left"><br /></td>
      </tr>
      <tr>
          <td style="text-align: left">医院名称</td>
          <td style="text-align: left"><br /></td>
          <td style="text-align: left">程序名称</td>
          <td style="text-align: left"><br /></td>
      </tr>
      <tr>
          <td style="text-align: left">终端服务器地址</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">终端服务器端口号</td>
          <td></td>
      </tr>
  </tbody>
</table></div>
<h2 id="仪器上接口标示和接口类型"><strong>仪器上接口标示和接口类型</strong>
</h2><ol>
<li>接口类型：串口|网口|监听文件☑|数据库|其他</li>
<li>连接方式：HL7协议|ASTM协议|监听文件☑|数据库|其他</li>
</ol>
<h2 id="仪器接口说明">仪器接口说明
</h2><ul>
<li>对于数据上传增加业务内容修改，仅作参考</li>
</ul>
<h2 id="串口盒子配置">串口盒子配置
</h2><ul>
<li><strong>波特率：</strong> 9600</li>
<li><strong>数据位：8</strong></li>
<li><strong>停止位：</strong> 1</li>
<li><strong>校验位：</strong> N</li>
</ul>
<h2 id="仪器图片">仪器图片
</h2><h2 id="仪器配置">仪器配置
</h2><h2 id="数据格式"><strong>数据格式</strong>
</h2><h2 id="项目通道号"><strong>项目通道号</strong>
</h2><h2 id="修改记录">修改记录
</h2><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>序号</th>
          <th>日期</th>
          <th>操作人</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td>2025-08-29 14:23:27<br /></td>
          <td>杨浩然</td>
          <td><br /></td>
      </tr>
  </tbody>
</table></div>
<h2 id="仪器接口程序">仪器接口程序
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span><span class="lnt">737
</span><span class="lnt">738
</span><span class="lnt">739
</span><span class="lnt">740
</span><span class="lnt">741
</span><span class="lnt">742
</span><span class="lnt">743
</span><span class="lnt">744
</span><span class="lnt">745
</span><span class="lnt">746
</span><span class="lnt">747
</span><span class="lnt">748
</span><span class="lnt">749
</span><span class="lnt">750
</span><span class="lnt">751
</span><span class="lnt">752
</span><span class="lnt">753
</span><span class="lnt">754
</span><span class="lnt">755
</span><span class="lnt">756
</span><span class="lnt">757
</span><span class="lnt">758
</span><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span><span class="lnt">798
</span><span class="lnt">799
</span><span class="lnt">800
</span><span class="lnt">801
</span><span class="lnt">802
</span><span class="lnt">803
</span><span class="lnt">804
</span><span class="lnt">805
</span><span class="lnt">806
</span><span class="lnt">807
</span><span class="lnt">808
</span><span class="lnt">809
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span> <span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;Drect&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;3000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;Z:</span><span class="se">\\</span><span class="s2">ResultExport</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFLICA800&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;.csv&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UpPara&#34;</span><span class="p">:</span><span class="s2">&#34;Z:</span><span class="se">\\</span><span class="s2">Imports</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">																																																																																															  
</span></span><span class="line"><span class="cl"><span class="n">Class</span> <span class="n">MI</span><span class="o">.</span><span class="n">MIFRS600</span> <span class="n">Extends</span> <span class="o">%</span><span class="n">RegisteredObject</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFInfinity).fileMTHD(&#34;7&#34;,&#34;MSH|^~\&amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">seen</span><span class="p">:</span> <span class="p">[</span><span class="n">VT</span><span class="p">]</span><span class="c1">#enter#MSH|^~\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">result</span><span class="p">:</span> <span class="p">[</span><span class="n">VT</span><span class="p">]</span><span class="c1">#enter#MSH|^~\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">seen</span><span class="p">:</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">result</span><span class="p">:</span><span class="n">D</span> <span class="c1">##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">fileMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  	<span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;0&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">HospitalDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(record) q &#34;0&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$d(^TMPLIS(&#34;RS600&#34;,mi,&#34;ERR&#34;)) s ^TMPLIS(&#34;RS600&#34;,mi,&#34;ERR&#34;)=&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">miold</span><span class="o">=</span><span class="n">mi</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">recordbak</span><span class="o">=</span><span class="n">record</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="err">仪器临时结果映射</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">TMPMachResMap</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="err">解析多行合并数据</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">recordbak</span><span class="p">,</span><span class="s2">&#34;#enter#&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">record</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">recordbak</span><span class="p">,</span><span class="s2">&#34;#enter#&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;解析行数据:&#34;</span><span class="n">_record</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(record) q</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">mi</span><span class="o">=</span><span class="n">miold</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="err">识别前处理上机信息</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="err">取出第一位命令类型</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">type</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="err">解析</span><span class="n">EQU命令</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;EQU&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">前处理</span><span class="n">Seen命令</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">commandchild</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;前处理命令为:&#34;</span><span class="n">_commandchild</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="err">解析</span><span class="n">SAC命令</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;SAC&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">解析上前处理信息</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">取出流水号</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">取出前处理或仪器信息</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">machCode</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">取出位置信息</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">positioninfo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//-----------------------------------------------------------------------------------------------&gt;</span><span class="err">根据前处理命令处理</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="n">commandchild</span><span class="o">=</span><span class="s2">&#34;SEEN&#34;</span> <span class="n">d</span> <span class="o">//</span><span class="err">自动核收</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">得到当前工作小组</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">s</span> <span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">s</span> <span class="n">CurWorkGroupDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">s</span> <span class="n">curMachName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">得到仪器工作小组的核收类型</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">s</span> <span class="n">AcceptFlag</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">)),</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">如果是前处理小组，就认为上前处理</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//************************************************************************************************</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">i</span> <span class="n">AcceptFlag</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;上前处理，鉴定号:&#34;</span><span class="n">_epis_</span><span class="s2">&#34;的标本在:&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34;,样本所在:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;执行核收到前处理&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....//</span><span class="err">此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">s</span> <span class="n">dealret</span><span class="o">=</span><span class="c1">##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,epis,&#34;&#34;) </span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;核收到前处理返回信息:&#34;</span><span class="n">_dealret</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....//</span><span class="err">记录位置信息到报告位置号</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRackNo</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">i</span> <span class="n">dealret</span><span class="p">[</span><span class="s2">&#34;标本已核收&#34;</span> <span class="n">q</span> 
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">i</span> <span class="n">dealret</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....//</span><span class="err">写标本操作日志</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">machCode</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;5&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....</span><span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.....</span><span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_CurWorkGroupDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">.....</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_epis_</span><span class="s2">&#34;前处理核收失败:&#34;</span><span class="n">_dealret_</span><span class="s2">&#34;,仪器【&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34;】！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....//</span><span class="err">写标本操作日志</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">dealret</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;100&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....//************************************************************************************************</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;上仪器，鉴定号:&#34;</span><span class="n">_epis_</span><span class="s2">&#34;的标本在:&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34;,样本所在:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....//</span><span class="err">核收操作，记录位置号</span><span class="mi">5984</span><span class="err">@</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....//</span><span class="err">标本操作，类型：已上机，备注：</span><span class="n">C8000A</span> <span class="mi">5984</span><span class="err">@</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....//</span><span class="err">上机提示（仪器项目上传日志，增加流水号索引）</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....//</span><span class="err">此处调核收逻辑核收到仪器，标本从前处理小组进入仪器的小组</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">s</span> <span class="n">dealret</span><span class="o">=</span><span class="c1">##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(mi,epis,&#34;&#34;,&#34;&#34;,&#34;LSHS&#34;) </span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="p">;</span><span class="n">s</span> <span class="n">RetLL</span><span class="o">=$$</span><span class="n">SaveLastMachine</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">....</span><span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">RetLL</span><span class="p">,</span><span class="s2">&#34;最后仪器&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;核收到仪器返回:&#34;</span><span class="n">_dealret</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;执行记录位置号:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....//</span><span class="err">不管接收是否成功，记录位置信息到报告位置号</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRackNo</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;已上机:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;记录位置号完成&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">i</span> <span class="n">dealret</span><span class="p">[</span><span class="s2">&#34;标本已核收&#34;</span> <span class="n">q</span> 
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">i</span> <span class="n">dealret</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....//</span><span class="err">写标本操作日志</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;仪器:&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34;,位置:&#34;</span><span class="n">_positioninfo_</span><span class="s2">&#34;核收&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;5&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;已上流水线:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;5&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....</span><span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.....</span><span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_CurWorkGroupDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">.....</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_epis_</span><span class="s2">&#34;前处理核收失败:&#34;</span><span class="n">_dealret_</span><span class="s2">&#34;,仪器【&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34;】！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....//</span><span class="err">写标本操作日志</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.....</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">dealret</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;100&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//-----------------------------------------------------------------------------------------------&gt;</span><span class="err">根据前处理命令处理</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="n">commandchild</span><span class="o">=</span><span class="s2">&#34;RESULT&#34;</span> <span class="n">d</span> <span class="o">//</span><span class="err">处理分类信息</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">通过仪器对照码取仪器</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">s</span> <span class="n">curMachName</span><span class="o">=</span><span class="n">machCode</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">此处存标本全部审核报告的位置号</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;分类信息，标本号:&#34;</span><span class="n">_epis_</span><span class="s2">&#34;的样本所在仪器:&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34; &#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;执行记录分类信息:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">保存分类信息到架子号</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveCARCH</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">curMachName_</span><span class="s2">&#34;: &#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">curMachName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;记录分类信息完成&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">写标本操作日志</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;上机位置:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//-----------------------------------------------------------------------------------------------&gt;</span><span class="err">根据前处理命令处理</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="n">commandchild</span><span class="o">=</span><span class="s2">&#34;ARCHIVE&#34;</span> <span class="n">d</span> <span class="o">//</span><span class="err">处理归档信息</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">通过仪器对照码取仪器</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">s</span> <span class="n">curMachName</span><span class="o">=</span><span class="n">machCode</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">此处存标本全部审核报告的位置号</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;归档信息，标本号:&#34;</span><span class="n">_epis_</span><span class="s2">&#34;的样本所在仪器:&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34; &#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;执行记录分类信息:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">保存归档信息到架子号</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveCARCH</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;归档:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;归档&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;记录归档信息完成&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">写标本操作日志</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;归档位置:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//-----------------------------------------------------------------------------------------------&gt;</span><span class="err">处理结果数据</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="err">解析质控数据</span><span class="p">,</span><span class="n">P业务数据</span><span class="err">，</span><span class="n">Q质控数据</span>
</span></span><span class="line"><span class="cl"> 	
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="s2">&#34;MSH&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;RS600&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;MSH&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">取日期串</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">DateStr</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">解析保存日期串</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DateStr</span><span class="p">)</span><span class="o">=</span><span class="mi">14</span> <span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;RS600&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;DATE&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="p">((</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;OBR&#34;</span> <span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;RS600&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;OBR&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;ORC&#34;</span> <span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;RS600&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;ORC&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="err">仪器警告</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;NTE&#34;</span> <span class="n">d</span>	
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">WaringStr</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;仪器报警信息:&#34;</span><span class="n">_WaringStr</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">WaringCode</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">WaringStr</span><span class="p">,</span><span class="s2">&#34; &#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">WaringCode</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;5&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;ABS(超出ABS)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;43&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Cal.E(校准结果异常)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;2&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Cuvet(反应杯空白异常)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;42&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Edit(实验结果已被编辑)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;23&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;ISE(超出ISE范围)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;19&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;ISE.E(ISE电压级错误)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;56&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Kin(Prozone错误2/运动不稳)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;10&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Lin(线性异常)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;11&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Lin(线性异常)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;6&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Prozone(Prozone错误1)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;4&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Reag.S(试剂不足)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;44&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Rept(高出原倍复查范围)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;45&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&lt;Rept(低于原倍复查范围)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;46&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Samp.？(高出ABS最大值)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;68&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Samp.B(样本中有气泡)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;72&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Samp.C(样本中有凝块)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;26&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Test(高出线性范围)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">e</span>  <span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;27&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&lt;Test(低于线性范围)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">保存仪器报警信息到组内报告评价</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveResultWarned</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">WaringStr</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">d</span> <span class="c1">##class(MI.Special.RecordGlobal).RecordData(epis,recordbak,&#34;MI.MIFRS600&#34;,1,10)	//YHR 20230828 记录十天的数据</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;OBX&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">epis</span><span class="o">=^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;RS600&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;OBR&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">machCode</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">16</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;解析仪器对照码:&#34;</span><span class="n">_machCode</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">通过仪器对照码取仪器</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">code</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span><span class="n">AHBS</span><span class="o">^</span><span class="mi">6012</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">reswaring</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">res</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;[</span><span class="s2">&#34;&#34;</span><span class="err">一般</span><span class="o">|-</span><span class="mi">1</span><span class="err">阴性</span><span class="o">+</span><span class="err">定量</span><span class="o">|</span><span class="mi">1</span><span class="err">阳性</span><span class="o">+</span><span class="err">定量</span><span class="o">|</span><span class="mi">0</span><span class="err">临界值</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">CallThePolice</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">CallThePolice</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">try</span><span class="p">{</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveAlarmInformation</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">CallThePolice</span><span class="p">)}</span><span class="n">catch</span> <span class="p">{}</span> <span class="o">//</span><span class="n">YHR</span> <span class="mi">20230828</span> <span class="err">保存报警信息</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="n">i</span> <span class="n">res</span><span class="o">=-</span><span class="mi">1</span> <span class="n">s</span> <span class="n">res</span><span class="o">=</span><span class="s2">&#34;阴性&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_reswaring</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="n">e</span>  <span class="n">i</span> <span class="n">res</span><span class="o">=</span><span class="mi">1</span> <span class="n">s</span> <span class="n">res</span><span class="o">=</span><span class="s2">&#34;阳性&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_reswaring</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="n">e</span>  <span class="n">i</span> <span class="n">res</span><span class="o">=</span><span class="mi">0</span> <span class="n">s</span> <span class="n">res</span><span class="o">=</span><span class="s2">&#34;临界值&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_reswaring</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="n">e</span>  <span class="n">s</span> <span class="n">res</span><span class="o">=</span><span class="s2">&#34;临界值&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_reswaring</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="n">res</span><span class="o">=</span><span class="s2">&#34;SORTED&#34;</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="n">res</span><span class="o">=</span><span class="s2">&#34;N/I&#34;</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">标本质量数据当做仪器报警，不让自动审核</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="n">code</span><span class="o">=</span><span class="s2">&#34;SQ-D&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="err">保存仪器报警信息到报告评价</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...//</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveResultWarned</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveQuality</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">计算肾小球滤过率</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="n">code</span><span class="o">=</span><span class="s2">&#34;8690&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">s</span> <span class="n">x1</span><span class="o">=</span><span class="s2">&#34;Cur&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">s</span> <span class="n">x2</span><span class="o">=</span><span class="c1">##class(MI.Special.GetSxqlgl).GeteGFRResultLast(mi,epis,res)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_x1_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_x2_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_code_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_res_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span> 	
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;:&#34;</span><span class="n">_result</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;按对照仪器保存数据:&#34;</span><span class="n">_machCode</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..//</span><span class="err">统一保存结果</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_result</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">s</span> <span class="n">DateStr</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;RS600&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;DATE&#34;</span><span class="p">))</span> <span class="n">s</span> <span class="n">DateStr</span><span class="o">=^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;RS600&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;DATE&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DateStr</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">....</span><span class="n">s</span> <span class="n">time</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">...</span><span class="n">d</span> <span class="c1">##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">记录标本日志</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).SaveRecord(&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveRecord</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span> <span class="n">OperateNotes</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">OperateTypeCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">OperateNotes</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">OperateNotes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">OperateTypeCode</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">OperateTypeCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.//</span><span class="err">标本</span><span class="n">ID</span><span class="p">,</span><span class="err">操作时间</span><span class="p">,</span><span class="err">操作者</span><span class="p">,</span><span class="err">操作说明</span><span class="p">,</span><span class="err">操作类型</span><span class="p">,</span><span class="err">工作组</span><span class="p">,</span><span class="err">标本拒收类型</span>
</span></span><span class="line"><span class="cl">	<span class="o">.//</span><span class="n">BTOperatorType</span> <span class="err">标本操作类型表</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">d</span> <span class="c1">##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,&#34;,&#34;,2),&#34;&#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">保存仪器报警信息</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).SaveResultWarned(&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveResultWarned</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span> <span class="n">conclusion</span><span class="p">,</span> <span class="n">predealMI</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">conclusion</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">conclusion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">predealMI</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">predealMI</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">predealMI</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">s</span> <span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">Status</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">22</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="n">Status</span><span class="o">=</span><span class="s2">&#34;3&#34;</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">objrep</span><span class="o">.</span><span class="n">ResultWarned</span><span class="p">)</span> <span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">ResultWarned</span><span class="o">=</span><span class="n">objrep</span><span class="o">.</span><span class="n">ResultWarned_</span><span class="s2">&#34;,&#34;</span><span class="n">_conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">e</span>  <span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">ResultWarned</span><span class="o">=</span><span class="n">conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">predealMI</span><span class="p">,</span><span class="s2">&#34;-1^存仪器报警信息失败:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">),</span><span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">ResultWarned</span><span class="o">=</span><span class="n">conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">predealMI</span><span class="p">,</span><span class="n">labno_</span><span class="s2">&#34;:没有找到报告&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">保存仪器报警信息</span><span class="p">(</span><span class="err">标本质量</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).SaveQuality(&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveQuality</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span> <span class="n">conclusion</span><span class="p">,</span> <span class="n">predealMI</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">conclusion</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">conclusion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">predealMI</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">predealMI</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">predealMI</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">s</span> <span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">Status</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">22</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="n">Status</span><span class="o">=</span><span class="s2">&#34;3&#34;</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">objrep</span><span class="o">.</span><span class="n">MinorConclusion</span><span class="p">)</span> <span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">MinorConclusion</span><span class="o">=</span><span class="n">objrep</span><span class="o">.</span><span class="n">MinorConclusion_</span><span class="s2">&#34;,&#34;</span><span class="n">_conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">e</span>  <span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">MinorConclusion</span><span class="o">=</span><span class="n">conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">predealMI</span><span class="p">,</span><span class="s2">&#34;-1^存标本质量信息失败:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">),</span><span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">MinorConclusion</span><span class="o">=</span><span class="n">conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">predealMI</span><span class="p">,</span><span class="n">labno_</span><span class="s2">&#34;:没有找到报告&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">保存架子号</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).SaveRackNo(&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveRackNo</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span> <span class="n">positioninfo</span><span class="p">,</span> <span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">positioninfo</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">positioninfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">s</span> <span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">CanDoTS</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="o">.....</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberTestSetI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span><span class="n">s</span> <span class="n">TestSetDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">TestSetDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberTestSetI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">TestSetDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.......</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTTestSetWorkGroupMachineI</span><span class="p">(</span><span class="s2">&#34;IndexWorkGroupMachine&#34;</span><span class="p">,</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">........</span><span class="n">s</span> <span class="n">CanDoTS</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">.....</span><span class="n">i</span> <span class="n">CanDoTS</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">RackNo</span><span class="o">=</span><span class="n">positioninfo</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;-1^存位置信息失败:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">RackNo</span><span class="o">=</span><span class="n">positioninfo</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno_</span><span class="s2">&#34;:没有找到报告&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">保存归档和分类信息</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).SaveCARCH(&#34;1000100990&#34;,&#34;2@2&#34;,57,&#34;归档&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveCARCH</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span> <span class="n">positioninfo</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">typename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">positioninfo</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">positioninfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">s</span> <span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">Status</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">22</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">objrep</span><span class="o">.</span><span class="n">RackNo</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">i</span> <span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">objrep</span><span class="o">.</span><span class="n">RackNo</span><span class="p">,</span><span class="s2">&#34;-&gt;&#34;</span><span class="p">,</span><span class="o">*</span><span class="p">)[</span><span class="n">typename</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.......</span><span class="n">s</span> <span class="n">positioninfo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">objrep</span><span class="o">.</span><span class="n">RackNo</span><span class="p">,</span><span class="n">typename</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_positioninfo</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.......</span><span class="n">s</span> <span class="n">positioninfo</span><span class="o">=</span><span class="n">objrep</span><span class="o">.</span><span class="n">RackNo_</span><span class="s2">&#34;-&gt;&#34;</span><span class="n">_positioninfo</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">RackNo</span><span class="o">=</span><span class="n">positioninfo</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">LastMachineLName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;-1^存&#34;</span><span class="n">_typename_</span><span class="s2">&#34;信息失败:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno_</span><span class="s2">&#34;:没有找到&#34;</span><span class="n">_typename_</span><span class="s2">&#34;的报告&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).SaveImageMTHD(&#34;8&#34;,&#34;1000001727&#34;,&#34;07&#34;,&#34;/LIS/IT3000/20180823/SerumQ0001_orig_64_1000001727_8170_4_0__04.jpg&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">保存标本图片</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).SaveImageMTHD(&#34;57&#34;,&#34;1000100990&#34;,&#34;P&#34;,&#34;/iLISLIS080/demo.png&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveImageMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">ImageClass</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;zlzi&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">ImageClass</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=</span><span class="n">mi</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="o">//</span><span class="err">标本血清质量特殊处理</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(epis))) d </span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(epis),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberImageI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">RowID</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">RowID</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberImageI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPVisitNumberImage).%OpenId(RowID)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">VisitNumberDR</span><span class="o">=</span><span class="n">VisitNumberDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">ImageClass</span><span class="o">=</span><span class="s2">&#34;SerumQ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">ImageID</span><span class="o">=</span><span class="n">ImageClass</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">FileName</span><span class="o">=</span><span class="n">FileName</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span> <span class="s2">&#34;-1^保存报告图片失败:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;:&#34;</span><span class="n">_ImageClass_</span><span class="s2">&#34;:&#34;</span><span class="n">_FileName</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span> <span class="n">ImageOrder</span><span class="p">,</span> <span class="n">Caption</span><span class="p">,</span> <span class="n">DisplayRatio</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">w</span> <span class="c1">##class(MI.MIFRS600).GetFtpMTHD(&#34;24&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetFtpMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">文件服务模式必须改的地方，老的</span><span class="n">FTP模式这么改了也没问题</span><span class="err">，所以建议都这样</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="c1">##Class(MI.Common.MIFBase).GetMiFtpPath(mi)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Creator</span><span class="err">：</span>      <span class="err">查询患者信息，监听配置上传前处理类后会定时调用这个</span><span class="n">query查询数据进行上传操作</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">CreatDate</span><span class="err">：</span>    <span class="mi">20140919</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="p">:</span><span class="err">：</span> 
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>        
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="n">mi</span><span class="err">：仪器主键</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Others</span><span class="err">：</span>       
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">QryLabInfo</span><span class="p">(</span><span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Query</span><span class="p">(</span><span class="n">ROWSPEC</span> <span class="o">=</span> <span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Query的执行方法</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(%ResultSet).RunQuery(&#34;MI.MIFRS600&#34;,&#34;QryLabInfo&#34;,&#34;57&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoExecute</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">i</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">flag</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">LabnoList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">//*--------------------------------&gt;*</span><span class="err">申请项目</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">EpisNo</span><span class="o">=$$</span><span class="n">getEpis</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">i</span> <span class="s1">&#39;$l(EpisNo) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">b</span> <span class="p">;</span><span class="mi">12</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">b</span> <span class="p">;</span><span class="n">VisitNumberDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">测试类型</span><span class="mi">0</span><span class="err">：文本，</span><span class="mi">1</span><span class="err">：数据库</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">b</span> <span class="p">;</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">文本双向上传开始</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=..</span><span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;@C&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">文本双向上传结束</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">////*--------------------------------&gt;*</span><span class="err">复查结果上传</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">b</span> <span class="p">;</span><span class="n">F101</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">EpisNo</span><span class="o">=$$</span><span class="n">getEpis</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">i</span> <span class="s1">&#39;$l(EpisNo) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">b</span> <span class="p">;</span><span class="mi">12</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">b</span> <span class="p">;</span><span class="n">VisitNumberDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">测试类型</span><span class="mi">0</span><span class="err">：文本，</span><span class="mi">1</span><span class="err">：数据库</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">文本双向上传开始</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">replace</span><span class="p">(</span><span class="n">TCList</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,&#34;</span><span class="o">+</span><span class="s2">&#34;)_&#34;</span><span class="o">|</span><span class="err">@</span><span class="sa">U</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">文本双向上传结束</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">//*--------------------------------&gt;*</span><span class="err">取消项目</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">b</span> <span class="p">;</span><span class="mi">101</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">EpisNo</span><span class="o">=$$</span><span class="n">getEpis</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">i</span> <span class="s1">&#39;$l(EpisNo) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">b</span> <span class="p">;</span><span class="mi">12</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">b</span> <span class="p">;</span><span class="n">VisitNumberDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">测试类型</span><span class="mi">0</span><span class="err">：文本，</span><span class="mi">1</span><span class="err">：数据库</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="n">TestType</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">文本双向上传开始</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=..</span><span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;@R&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">...//</span><span class="err">文本双向上传结束</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ColFields</span><span class="o">=</span><span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span><span class="o">=</span><span class="c1">##Class(LIS.Util.Common).TransListNull(Data,ColFields)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">quit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoClose</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Kill</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoFetch</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">Row</span> <span class="n">As</span> <span class="o">%</span><span class="n">List</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">AtEnd</span> <span class="n">As</span> <span class="o">%</span><span class="n">Integer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">If</span> <span class="n">ind</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Else</span>      <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">AtEnd</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">获取申请名称和内容</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">申请名称：</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">发送申请：</span><span class="n">order_2012051718302501_9999999901NW</span><span class="o">.</span><span class="n">HL7</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">取消申请：</span><span class="n">order_2012051718302501_9999999901CA</span><span class="o">.</span><span class="n">HL7</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">项目复查：</span><span class="n">order_2012051718302501_9999999901XO</span><span class="o">.</span><span class="n">HL7</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFRS600).GetLisOrderMTHD(&#34;8&#34;,&#34;POS@C@1&#34;,&#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08              -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;        ,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labnoInfo</span><span class="p">,</span> <span class="n">patInfo</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">VT</span><span class="o">=</span><span class="s2">&#34;[11]&#34;</span><span class="p">,</span><span class="n">FS</span><span class="o">=</span><span class="s2">&#34;[28]&#34;</span><span class="p">,</span><span class="n">CR</span><span class="o">=</span><span class="s2">&#34;[13]&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labNo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sampleno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">i</span> <span class="n">labNo</span><span class="o">=</span><span class="s2">&#34;74623177&#34;</span> <span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;zlzit3000d&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labnoInfo</span><span class="p">,</span> <span class="n">patInfo</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">location</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">docName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">regNo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">patName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">sex</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="n">s</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;M&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span> <span class="n">s</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;F&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="p">(</span><span class="n">sex</span><span class="s1">&#39;=&#34;M&#34;)&amp;&amp;(sex&#39;</span><span class="o">=</span><span class="s2">&#34;F&#34;</span><span class="p">)</span> <span class="n">s</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;U&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">birthDate</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">29</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">collectTime</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span> <span class="p">;</span><span class="mi">2017</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">14</span> <span class="mi">11</span><span class="p">:</span><span class="mi">57</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">collectTime</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">collectTime</span><span class="p">,</span><span class="s2">&#34;- :&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;00&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">status</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">labnoInfo</span><span class="p">,</span><span class="s2">&#34;@&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">labnoInfo</span><span class="p">,</span><span class="s2">&#34;@&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">curTime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">PatType</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Wardno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RO&#34;</span>  <span class="o">//</span><span class="err">门诊</span><span class="o">=</span><span class="n">RO</span><span class="p">,</span><span class="err">住院</span><span class="o">=</span><span class="n">RI</span><span class="p">,</span><span class="err">体检</span><span class="o">=</span><span class="n">RC</span><span class="p">,</span><span class="err">急诊</span><span class="o">=</span><span class="n">RS</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="n">PatType</span><span class="o">=</span><span class="s2">&#34;住院&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RI&#34;</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="n">PatType</span><span class="o">=</span><span class="s2">&#34;门诊&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RO&#34;</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="n">PatType</span><span class="o">=</span><span class="s2">&#34;急诊&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RS&#34;</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="n">PatType</span><span class="o">=</span><span class="s2">&#34;体检&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RC&#34;</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="n">PatType</span><span class="o">=</span><span class="s2">&#34;干诊&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   		<span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RC&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">MSN</span><span class="o">=</span><span class="s2">&#34;MSH|^\&amp;|HL7SND|FAC1|HL7REC|FAC2|&#34;</span><span class="n">_curTime_</span><span class="s2">&#34;||OML^O21|&#34;</span><span class="n">_curTime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labNo_</span><span class="s2">&#34;|P|2.3|||ER|ER||8859/1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;S&#34;</span> <span class="n">s</span> <span class="n">MSN</span><span class="o">=</span><span class="s2">&#34;MSH|^\&amp;|HL7SND|FAC1|HL7REC|FAC2|&#34;</span><span class="n">_curTime_</span><span class="s2">&#34;||RESULTS|&#34;</span><span class="n">_curTime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labNo_</span><span class="s2">&#34;|P|2.3|||ER|ER||8859/1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">PID</span><span class="o">=</span><span class="s2">&#34;PID|1||&#34;</span><span class="n">_Sampleno_</span><span class="s2">&#34;||&#34;</span><span class="n">_</span><span class="s2">&#34;^&#34;</span><span class="n">_patName_</span><span class="s2">&#34;||&#34;</span><span class="n">_birthDate_</span><span class="s2">&#34;|&#34;</span><span class="n">_sex</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">PV1</span><span class="o">=</span><span class="s2">&#34;PV1|||&#34;</span><span class="n">_Wardno_</span><span class="s2">&#34;||||||||||||||||^^^^^^^^&#34;</span><span class="n">_location_</span><span class="s2">&#34;|&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">DG1</span><span class="o">=</span><span class="s2">&#34;DG1|||&#34;</span><span class="n">_Diagnose</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">orcF1</span><span class="o">=</span><span class="s2">&#34;NW&#34;</span><span class="p">,</span><span class="n">orcF2</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;R&#34;</span> <span class="n">s</span> <span class="n">orcF1</span><span class="o">=</span><span class="s2">&#34;CA&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">i</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;U&#34;</span> <span class="n">s</span> <span class="n">orcF1</span><span class="o">=</span><span class="s2">&#34;XO&#34;</span> <span class="n">s</span> <span class="n">orcF2</span><span class="o">=</span><span class="s2">&#34;SC&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;U&#34;</span> <span class="n">s</span> <span class="n">orcF1</span><span class="o">=</span><span class="s2">&#34;XO&#34;</span> <span class="n">s</span> <span class="n">orcF2</span><span class="o">=</span><span class="s2">&#34;RP&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ORC</span><span class="o">=</span><span class="s2">&#34;ORC|&#34;</span><span class="n">_orcF1_</span><span class="s2">&#34;|&#34;</span><span class="n">_labNo_</span><span class="s2">&#34;|||||&#34;</span><span class="n">_patTypeFlag_</span><span class="s2">&#34;||&#34;</span><span class="n">_curTime_</span><span class="s2">&#34;||&#34;</span><span class="n">_docName_</span><span class="s2">&#34;|&#34;</span><span class="n">_Wardno_</span><span class="s2">&#34;|||||||&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">obrF1</span><span class="o">=</span><span class="s2">&#34;A&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;U&#34;</span> <span class="n">s</span> <span class="n">obrF1</span><span class="o">=</span><span class="s2">&#34;G&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">OBR</span><span class="o">=</span><span class="s2">&#34;OBR||&#34;</span><span class="n">_labNo_</span><span class="s2">&#34;||AA|||&#34;</span><span class="n">_collectTime_</span><span class="s2">&#34;||||&#34;</span><span class="n">_obrF1</span>	
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">OBRs</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">labnoInfo</span><span class="p">,</span><span class="s2">&#34;@&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;POS&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">OBRs</span><span class="o">=</span><span class="s2">&#34;OBR||&#34;</span><span class="n">_labNo_</span><span class="s2">&#34;||POS|||&#34;</span><span class="n">_collectTime_</span><span class="s2">&#34;||||&#34;</span><span class="n">_obrF1</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">d</span> <span class="n">GetOBRs</span>	
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">s</span> <span class="n">orderTxt</span><span class="o">=</span><span class="n">VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">orderTxt</span><span class="o">=</span><span class="n">VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">orderTxt</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="n">GetOBRs</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">items</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">labnoInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="s2">&#34;+&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">item</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="s2">&#34;+&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">splitStr</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">OBR</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">curOBR</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">OBR</span><span class="p">,</span><span class="n">splitStr</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_item_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">OBR</span><span class="p">,</span><span class="n">splitStr</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">OBRs</span><span class="o">=</span><span class="n">OBRs_curOBR_CR</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">获取项目通道号</span>
</span></span><span class="line"><span class="cl">   	<span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">   	<span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_chl_</span><span class="s2">&#34;+&#34;</span>   	
</span></span><span class="line"><span class="cl">   	<span class="n">s</span> <span class="n">tcx</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="n">k</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span> <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_tcx_</span><span class="s2">&#34;|&#34;</span>
</span></span><span class="line"><span class="cl">   	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tcx</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span><span class="s2">&#34;共&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="s2">&#34;+&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;个项目。&#34;</span><span class="n">_tcx</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span> <span class="o">//</span><span class="n">YHR</span> <span class="mi">20230816</span> <span class="err">将上传信息存入罗氏</span><span class="n">infinity仪器</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">tcx</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFRS600).GetPatInfo(57,9000001912)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">VisitNumberDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">标本信息</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RPVisitNumberData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LocationDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">),</span><span class="n">Location</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Location</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">DoctorDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">Doctor</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Doctor</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDoctorD</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveUserDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">68</span><span class="p">),</span><span class="n">ReceiveUser</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">ReceiveUser</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">SYSUserD</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RegNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SurName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">GivenName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">SurName</span><span class="o">=</span><span class="n">GivenName</span> <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName_GivenName</span>	
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SpeciesDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span><span class="n">Species</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AdmTypeDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">AdmType</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AdmType</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAdmissionTypeD</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BirthDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AgeUnitDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span><span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAgeUnitD</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CollectDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">51</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CollectTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Sampleda</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Instrument</span> <span class="o">=</span> <span class="s2">&#34;XN&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">s</span> <span class="n">Instrument</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">Instrument</span><span class="p">)</span> <span class="n">s</span> <span class="n">Instrument</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">Instrument</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sampleno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>   <span class="o">//</span><span class="err">病案号</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sampletype</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">Feetype</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">;</span><span class="err">费别</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Srcdepno</span><span class="o">=</span><span class="n">Location</span>  <span class="p">;</span><span class="err">送检科室</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Srcdocno</span><span class="o">=</span><span class="n">Doctor</span>   <span class="p">;</span><span class="err">送检医生</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Userno</span><span class="o">=</span><span class="n">ReceiveUser</span> <span class="p">;</span><span class="err">检验医生</span><span class="p">(</span><span class="err">录入者</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Patno</span><span class="o">=</span><span class="n">RegNo</span> <span class="p">;</span><span class="err">登记号</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BarCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Patna</span><span class="o">=</span><span class="n">PatName</span>   <span class="p">;</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="mi">1</span>  <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;男&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>     <span class="p">;</span><span class="mi">1</span><span class="p">:</span><span class="err">男</span> <span class="err">，</span><span class="mi">2</span> <span class="err">女</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">Species</span> <span class="o">=</span><span class="s2">&#34;女&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Pattype</span><span class="o">=</span><span class="n">AdmType</span>   <span class="p">;</span><span class="err">病人类型</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Bedno</span> <span class="o">=</span> <span class="n">BedNo</span>    <span class="p">;</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Patage</span><span class="o">=</span><span class="n">Age</span>  <span class="p">;</span><span class="err">年龄</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Ageunit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">年龄单位</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Reqno</span><span class="o">=</span><span class="n">labno</span>  <span class="p">;</span><span class="err">申请号</span> <span class="o">=</span> <span class="err">检验号</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reqda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Reqda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">ReceiveTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span><span class="err">送检日期</span> <span class="o">=</span> <span class="err">接收时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reportda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">报告日期</span>  <span class="o">=</span> <span class="err">初审</span><span class="p">(</span><span class="err">保存结果</span><span class="p">)</span><span class="err">时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Printflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">打印标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Resultflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">结果标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Errflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">错误标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span> <span class="o">=</span> <span class="n">Diagnose</span>   <span class="p">;</span><span class="err">诊断</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Description</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">备注</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reserve</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">保留字段</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Patnamn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">姓名拼音码</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Getda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">CollectTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">s</span> <span class="n">Getda</span><span class="o">=</span><span class="n">Reqda</span> <span class="p">;</span><span class="err">接收时间</span><span class="o">/</span><span class="err">采样日期</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Wardno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WardnoDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">26</span><span class="p">)</span>  <span class="p">;</span><span class="err">病区</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">WardnoDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Wardno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWardD</span><span class="p">(</span><span class="n">WardnoDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">Sampleda</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Instrument</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Sampleno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Sampletype</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Feetype</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Srcdepno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Srcdocno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Userno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Patno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Patna</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Sex</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Pattype</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Bedno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Patage</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Ageunit</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Reqno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Reqda</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Reportda</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Printflag</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Resultflag</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Errflag</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Diagnose</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Reserve</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Patnamn</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Getda</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Wardno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">BarCode</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">BirthDate</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">RetString</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">监听做上传操作后调用改方法设置标本上传表状态</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveSDFMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">epis</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="n">filename</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">流水号特殊处理</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFRS600).GetEpis()</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetEpis</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="nb">sign</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="nb">sign</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">maxEpis</span><span class="o">=</span><span class="c1">##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByRowIDMTHD(&#34;5&#34;) //YHR 20230810 罗氏流水线规则</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">ret</span><span class="o">=$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexMicNo&#34;</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="n">maxEpis</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">i</span> <span class="n">ret</span><span class="s1">&#39;=0 s sign=1</span>
</span></span><span class="line"><span class="cl">		<span class="n">e</span>  <span class="n">d</span>  <span class="n">s</span> <span class="nb">sign</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">maxEpis</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">保存报警提示信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">YHR</span> <span class="mi">20230828</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFRS600).SaveAlarmInformation(57,9000001960,&#34;CSCSCS&#34;) </span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveAlarmInformation</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">expertRules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">expertRules</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">expertRules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$$</span><span class="n">GetReportID</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">MinorConclusion</span><span class="o">=</span><span class="n">expertRules</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">GetReportID</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">10</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AssayNo</span><span class="o">=</span><span class="n">epis</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AssayNo</span><span class="o">=$$</span><span class="n">GetEpisByLabno</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WGMachineID</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WGMachineID1</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ReportID</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">D</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexMicNo&#34;</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="n">AssayNo</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">TransmitDate</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexMicNo&#34;</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="n">AssayNo</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ReportID</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexMicNo&#34;</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="n">AssayNo</span><span class="p">,</span><span class="n">TransmitDate</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ReportID</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="n">GetEpisByLabno</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">Epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">Index</span> <span class="n">IndexVisitNumber</span> <span class="n">On</span> <span class="n">VisitNumber</span> <span class="p">[</span> <span class="n">SqlName</span> <span class="o">=</span> <span class="n">Index_VisitNumber</span><span class="p">,</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">Unique</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">Index</span> <span class="n">IndexReportID</span> <span class="n">On</span> <span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">,</span> <span class="n">WorkGroupMachineDR</span><span class="p">,</span> <span class="n">OrderNo</span><span class="p">)</span> <span class="p">[</span> <span class="n">SqlName</span> <span class="o">=</span> <span class="n">Index_ReportID</span><span class="p">,</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">Unique</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">Epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">Epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(mi) q Epis</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WGMachineID</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">Epis</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitnumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">Epis</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitnumberDR</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitnumberDR</span><span class="p">,</span><span class="n">WGMachineID</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">ret</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="附录">附录
</h2><h3 id="仪器文档提取数据格式">仪器文档提取数据格式
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">第十章LIS
</span></span><span class="line"><span class="cl">10.1Order格式
</span></span><span class="line"><span class="cl">[VT]
</span></span><span class="line"><span class="cl">MSH|^~\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||OML^O21|20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR]
</span></span><span class="line"><span class="cl">PID|1||00943729|9009|^Test||19811002|F[CR]
</span></span><span class="line"><span class="cl">PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]
</span></span><span class="line"><span class="cl">DG1|||宫内孕37+5天[CR]
</span></span><span class="line"><span class="cl">ORC|NW|121092103669|||||RI||20210922075000|医保|10001|041|||||||[CR]
</span></span><span class="line"><span class="cl">OBR||121092103669||YLCSC|||||||A[CR]
</span></span><span class="line"><span class="cl">OBR||121092103669||ATPO|||||||A[CR]
</span></span><span class="line"><span class="cl">OBR||121092103669||FT4|||||||A[CR]
</span></span><span class="line"><span class="cl">OBR||121092103669||TSH|||||||A[CR]
</span></span><span class="line"><span class="cl">[FS] [CR]
</span></span><span class="line"><span class="cl">[VT][FS] ：开始和结束字符
</span></span><span class="line"><span class="cl">[CR] ：回车符
</span></span><span class="line"><span class="cl">OML^O21：message type Order的消息类型，Order发送必须用OML^O21
</span></span><span class="line"><span class="cl">20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复）
</span></span><span class="line"><span class="cl">00943729：病人的门诊或住院号
</span></span><span class="line"><span class="cl">9009：样本号
</span></span><span class="line"><span class="cl">^Test：病人姓名
</span></span><span class="line"><span class="cl">19811002：出生年月日
</span></span><span class="line"><span class="cl">F：性别（F = Female；M = Male；U = Unknown）
</span></span><span class="line"><span class="cl">宫内孕37+5天：临床诊断(如果有代码就用临床诊断得代码，没有就用文字描述)
</span></span><span class="line"><span class="cl">NW：Action code (NW:新建；XO：修改；CA：删除)
</span></span><span class="line"><span class="cl">121092103669：条码号
</span></span><span class="line"><span class="cl">RI：病人类别（门诊；住院；急诊；体检……）
</span></span><span class="line"><span class="cl">20180201101033：时间戳(精确到秒无需毫秒)
</span></span><span class="line"><span class="cl">医保：病人收费类别
</span></span><span class="line"><span class="cl">10001：申请医生代码
</span></span><span class="line"><span class="cl">041：申请科室代码
</span></span><span class="line"><span class="cl">121092103669：条码号
</span></span><span class="line"><span class="cl">YLCSC：测试项目代号
</span></span><span class="line"><span class="cl">10.2Result格式
</span></span><span class="line"><span class="cl">[VT]
</span></span><span class="line"><span class="cl">MSH|^~\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_121092103669||RESULTS |20210922075000975_121092103669|P|2.3|||ER|ER||8859/1[CR]
</span></span><span class="line"><span class="cl">PID|1||00943729|9009|^Test||19811002|F[CR]
</span></span><span class="line"><span class="cl">PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]
</span></span><span class="line"><span class="cl">DG1|||宫内孕37+5天[CR]
</span></span><span class="line"><span class="cl">ORC|NW|121092103669|9009||||RI||20210922075000|医保|10001|041|||||||[CR]
</span></span><span class="line"><span class="cl">OBR||121092103669||YLCSC|||||||A[CR]
</span></span><span class="line"><span class="cl">OBX|1|NM|YLCSC||1.1||||||F|||20210922101033|c6000^E11[CR]
</span></span><span class="line"><span class="cl">OBR||121092103669||ATPO|||||||A[CR]
</span></span><span class="line"><span class="cl">OBX|1|NM|ATPO||2.1||||||F|||20210922101033|c6000^E11[CR]
</span></span><span class="line"><span class="cl">OBR||121092103669||FT4|||||||A[CR]
</span></span><span class="line"><span class="cl">OBX|1|NM|FT4||3.1||||||F|||20210922101033|c6000^E11[CR]
</span></span><span class="line"><span class="cl">OBR||121092103669||TSH|||||||A[CR]
</span></span><span class="line"><span class="cl">OBX|1|NM|TSH||6.1||||||F|||20210922101033|c6000^E11[CR]
</span></span><span class="line"><span class="cl">[FS] [CR]
</span></span><span class="line"><span class="cl">[VT][FS] ：开始和结束字符
</span></span><span class="line"><span class="cl">[CR] ：回车符
</span></span><span class="line"><span class="cl">RESULTS：message type Order的消息类型，结果回传必须用RESULTS
</span></span><span class="line"><span class="cl">20210922075000975_121092103669：Control ID （YYYYMMDDHHSSMM+任意随机数，唯一不能重复）
</span></span><span class="line"><span class="cl">00943729：病人的门诊或住院号
</span></span><span class="line"><span class="cl">9009：样本号
</span></span><span class="line"><span class="cl">^Test：病人姓名
</span></span><span class="line"><span class="cl">19811002：出生年月日
</span></span><span class="line"><span class="cl">F：性别（F = Female；M = Male；U = Unknown）
</span></span><span class="line"><span class="cl">NW：Action code (NW:新建；XO：修改；CA：删除)
</span></span><span class="line"><span class="cl">121092103669：条码号
</span></span><span class="line"><span class="cl">RI：病人类别（门诊；住院；急诊；体检……）
</span></span><span class="line"><span class="cl">20210922075000：时间戳(精确到秒无需毫秒)
</span></span><span class="line"><span class="cl">医保：病人收费类别
</span></span><span class="line"><span class="cl">10001：申请医生代码
</span></span><span class="line"><span class="cl">041：申请科室代码
</span></span><span class="line"><span class="cl">121092103669：条码号
</span></span><span class="line"><span class="cl">NM：Value Type (NM = Numeric；ST = String data)
</span></span><span class="line"><span class="cl">YLCSC：测试项目代号
</span></span><span class="line"><span class="cl">1.1：项目测试结果
</span></span><span class="line"><span class="cl">c6000^E11：分析仪名称和模块名称
</span></span><span class="line"><span class="cl">10.3Seen格式
</span></span><span class="line"><span class="cl">01前处理条码扫描消息格式
</span></span><span class="line"><span class="cl">[VT]
</span></span><span class="line"><span class="cl">MSH|^~\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]
</span></span><span class="line"><span class="cl">EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]
</span></span><span class="line"><span class="cl">SAC|||0800150242|0800150242||20220908183340|01||P|MILESTON1|0@0[CR]
</span></span><span class="line"><span class="cl">[FS][CR]
</span></span><span class="line"><span class="cl">[VT][FS] ：开始和结束字符
</span></span><span class="line"><span class="cl">[CR] ：回车符
</span></span><span class="line"><span class="cl">SAMPLEEVENT^SEEN：消息类型
</span></span><span class="line"><span class="cl">0800150242：条码号
</span></span><span class="line"><span class="cl">MILESTON1：前处理名称
</span></span><span class="line"><span class="cl">0@0：架子号和位置号
</span></span><span class="line"><span class="cl">20220908183340：消息产生的时间
</span></span><span class="line"><span class="cl">02前处理分类Distribution消息格式
</span></span><span class="line"><span class="cl">[VT]
</span></span><span class="line"><span class="cl">MSH|^~\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]
</span></span><span class="line"><span class="cl">EQU||^^^MILESTONE1^^SAMPLEEVENT^RESULT|20220908183340|SORTED[CR]
</span></span><span class="line"><span class="cl">SAC|||0800150242|0800150242||20220908183340|01||R|c6000|0@0[CR]
</span></span><span class="line"><span class="cl">[FS][CR]
</span></span><span class="line"><span class="cl">[VT][FS] ：开始和结束字符
</span></span><span class="line"><span class="cl">[CR] ：回车符
</span></span><span class="line"><span class="cl">SAMPLEEVENT^RESULT：消息类型
</span></span><span class="line"><span class="cl">0800150242：条码号
</span></span><span class="line"><span class="cl">MILESTON1：前处理名称
</span></span><span class="line"><span class="cl">c6000：分析仪名称
</span></span><span class="line"><span class="cl">0@0：架子号和位置号
</span></span><span class="line"><span class="cl">20220908183340：消息产生的时间
</span></span><span class="line"><span class="cl">03前处理归档消息格式
</span></span><span class="line"><span class="cl"> [VT]
</span></span><span class="line"><span class="cl">MSH|^~\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]
</span></span><span class="line"><span class="cl">EQU||^^^MILESTONE1^^SAMPLEEVENT^ARCHIVE|20220908183340|SORTED[CR]
</span></span><span class="line"><span class="cl">SAC|||0800150242|0800150242||20220908183340|01||R|MILESTON1|23@1[CR]
</span></span><span class="line"><span class="cl">[FS][CR]
</span></span><span class="line"><span class="cl">[VT][FS] ：开始和结束字符
</span></span><span class="line"><span class="cl">[CR] ：回车符
</span></span><span class="line"><span class="cl">SAMPLEEVENT^ARCHIVE：消息类型
</span></span><span class="line"><span class="cl">0800150242：条码号
</span></span><span class="line"><span class="cl">MILESTON1：前处理名称
</span></span><span class="line"><span class="cl">23@1：架子号和位置号
</span></span><span class="line"><span class="cl">20220908183340：消息产生的时间
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="特殊处理">特殊处理
</h3><p>标本拒收更改标本上传状态为R</p>
<p>LISSP.DHCRPVisitNumber——RejectVisitNumber</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">MachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">fLabno</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">S</span> <span class="n">RowID</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">fLabno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>  <span class="o">//</span><span class="n">q</span>
</span></span><span class="line"><span class="cl">         	<span class="o">.</span><span class="n">S</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%OpenId(RowID)</span>
</span></span><span class="line"><span class="cl">	        <span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;R&#34;</span>
</span></span><span class="line"><span class="cl">	        <span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713171820668-20250317141249-oljkc64.png"
	width="1652"
	height="695"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713171820668-20250317141249-oljkc64_hu_b8087366f4760903.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713171820668-20250317141249-oljkc64_hu_e86355faa0d04df2.png 1024w"
	loading="lazy"
	
		alt="image-20230713171820668"
	
	
		class="gallery-image" 
		data-flex-grow="237"
		data-flex-basis="570px"
	
></p>
<p>更新拒收状态后回传文件之后删除该条上传信息，避免签收会无法签收</p>
<p>MI.MachineUpload——SetSendFlag</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="p">:</span><span class="err">：</span> <span class="err">记录上传标志</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>        
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="err">仪器</span><span class="n">DR</span><span class="p">,</span><span class="err">检验号</span><span class="p">,</span><span class="err">标记</span><span class="p">(</span><span class="n">C</span><span class="p">:</span><span class="err">创建</span> <span class="n">S</span><span class="p">:</span><span class="err">发送</span> <span class="n">F</span><span class="p">:</span><span class="err">失败</span><span class="p">),</span><span class="n">Comments</span><span class="p">:</span><span class="err">备注信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">无</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="mi">1</span><span class="p">:</span><span class="err">成功</span>  <span class="err">其他</span><span class="p">:</span><span class="err">失败</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span>  <span class="n">w</span> <span class="c1">##Class(MI.MachineUpload).SetSendFlag(6,1001367,&#34;S&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SetSendFlag</span><span class="p">(</span><span class="n">MachineDR</span><span class="p">,</span> <span class="n">Labno</span><span class="p">,</span> <span class="n">SendStatus</span><span class="p">,</span> <span class="n">Comments</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">MachineDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">MachineDR</span><span class="p">),</span><span class="n">Labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">Labno</span><span class="p">),</span><span class="n">SendStatus</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">SendStatus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Labno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RowID</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(SendStatus) s SendStatus=&#34;C&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(RowID) q 100</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">TCList</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">RowID</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">oldSendStatus</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">RowID</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">oldSendStatus</span><span class="o">=</span><span class="s2">&#34;R&#34;</span> <span class="n">k</span> <span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">RowID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%OpenId(RowID)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="o">=</span><span class="n">SendStatus</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddTime</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713172038065-20250317141249-g9h52te.png"
	width="1651"
	height="688"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713172038065-20250317141249-g9h52te_hu_ef3aed44d1b24bf8.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713172038065-20250317141249-g9h52te_hu_4a1161e7ae6533f0.png 1024w"
	loading="lazy"
	
		alt="image-20230713172038065"
	
	
		class="gallery-image" 
		data-flex-grow="239"
		data-flex-basis="575px"
	
></p>
<p>签收标本特殊处理，避免造成同一医嘱在不同主动上传仪器生成上传标本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="p">:</span><span class="err">：</span> <span class="err">上传标本记录</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>    
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="err">标本号</span><span class="p">,</span><span class="err">检验套</span><span class="n">DR</span><span class="p">,</span><span class="err">工作小组</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">无</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="mi">1</span><span class="p">:</span><span class="err">成功</span>  <span class="err">其他</span><span class="p">:</span><span class="err">失败</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span>  <span class="n">w</span> <span class="c1">##Class(MI.MachineUpload).Upload(&#34;1000100990&#34;,39,57)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">Upload</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span> <span class="n">TestSetDR</span><span class="p">,</span> <span class="n">WorkGroupMachineDR</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">Labno</span><span class="p">),</span><span class="n">TestSetDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">TestSetDR</span><span class="p">),</span><span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(Labno) q 100</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(TestSetDR),&#39;</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span> <span class="n">q</span> <span class="mi">100</span> 
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">接收或核收操作标识</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RecFlag</span><span class="o">=</span><span class="s2">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">RecFlag</span><span class="o">=</span><span class="s2">&#34;H&#34;</span> <span class="o">//</span><span class="err">无工作小组认为是核收操作，不增加入参</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">D</span> <span class="n">UploadTC</span> 
</span></span><span class="line"><span class="cl">	<span class="n">E</span>  <span class="n">D</span> <span class="o">//</span><span class="err">不传工作小组时遍历关联的所有主动上传仪器</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">LinkWGMDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">F</span>  <span class="n">S</span> <span class="n">LinkWGMDR</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTTestSetWorkGroupMachineI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">,</span><span class="n">LinkWGMDR</span><span class="p">))</span> <span class="n">Q</span><span class="p">:</span><span class="n">LinkWGMDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">D</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">S</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="n">LinkWGMDR</span>
</span></span><span class="line"><span class="cl">	<span class="o">..//</span><span class="err">标本接收医院</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">VisHosDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">)),</span><span class="mi">78</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">..//</span><span class="err">工作小组所在医院</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">CKWGDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">LinkWGMDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">CkDepartDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupD</span><span class="p">(</span><span class="n">CKWGDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">S</span> <span class="n">CkHosDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDepartmentD</span><span class="p">(</span><span class="n">CkDepartDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">I</span> <span class="n">CkHosDR</span><span class="s1">&#39;=VisHosDR Q //非本医院标本不生成工单</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">D</span> <span class="n">UploadTCN</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">UploadTC</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CommDirection</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">临时处理老年医院流水线标本上传</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">i</span> <span class="n">CommDirection</span><span class="s1">&#39;=&#34;UP&#34;,CommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">s</span> <span class="o">^</span><span class="n">DHCUploadAll</span><span class="p">(</span><span class="n">Labno</span><span class="p">)</span><span class="o">=</span><span class="n">WorkGroupMachineDR</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">CommDirection</span><span class="s1">&#39;=&#34;UP&#34;,CommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">q</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">装载列表接收不生成工单</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">CommDirection</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span><span class="p">,</span><span class="n">RecFlag</span><span class="o">=</span><span class="s2">&#34;C&#34;</span> <span class="n">q</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl">	<span class="n">f</span>  <span class="n">s</span> <span class="n">MachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterI</span><span class="p">(</span><span class="s2">&#34;IndexWorkGroupMachine&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">miCommDirection</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">MachineDR</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">miCommDirection</span><span class="s1">&#39;=&#34;UP&#34;,miCommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">Labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">   	<span class="o">..</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=</span><span class="n">TCList_chl_</span><span class="s2">&#34;</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">TCList</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">TCList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(TCList) s ret=Labno_&#34;没有上传项目&#34; q  </span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">s</span> <span class="n">RowID</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Labno))) S RowID=$O(^dbo.RPMachineUploadI(&#34;IndexMaster&#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))  //q</span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">RowID</span><span class="p">)</span> <span class="n">S</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%OpenId(RowID)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">e</span>  <span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%New()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="p">),</span><span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="s1">&#39;=&#34;C&#34;  Q //已读取标本不再上传</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">MachineParameterDR</span><span class="o">=</span><span class="n">MachineDR</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">VisitNumber</span><span class="o">=</span><span class="n">Labno</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddTime</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">TCList</span><span class="o">=</span><span class="n">TCList</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">UploadTCN</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CommDirection</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">临时处理老年医院流水线标本上传</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">i</span> <span class="n">CommDirection</span><span class="s1">&#39;=&#34;UP&#34;,CommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">s</span> <span class="o">^</span><span class="n">DHCUploadAll</span><span class="p">(</span><span class="n">Labno</span><span class="p">)</span><span class="o">=</span><span class="n">WorkGroupMachineDR</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">CommDirection</span><span class="s1">&#39;=&#34;UP&#34;,CommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">q</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">装载列表接收不生成工单</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">CommDirection</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span><span class="p">,</span><span class="n">RecFlag</span><span class="o">=</span><span class="s2">&#34;C&#34;</span> <span class="n">q</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl">	<span class="n">f</span>  <span class="n">s</span> <span class="n">MachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterI</span><span class="p">(</span><span class="s2">&#34;IndexWorkGroupMachine&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">MachineDR</span><span class="s1">&#39;=57 q //上传标本信息接收标本特殊处理</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">miCommDirection</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">MachineDR</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">miCommDirection</span><span class="s1">&#39;=&#34;UP&#34;,miCommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">Labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">   	<span class="o">..</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=</span><span class="n">TCList_chl_</span><span class="s2">&#34;</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">TCList</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">TCList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(TCList) s ret=Labno_&#34;没有上传项目&#34; q  </span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">s</span> <span class="n">RowID</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Labno))) S RowID=$O(^dbo.RPMachineUploadI(&#34;IndexMaster&#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))  //q</span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">RowID</span><span class="p">)</span> <span class="n">S</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%OpenId(RowID)</span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="p">),</span><span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="s1">&#39;=&#34;C&#34;  d</span>
</span></span><span class="line"><span class="cl">  	<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="o">..</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>  <span class="o">//</span><span class="err">签收强制重新上传</span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%New()</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">MachineParameterDR</span><span class="o">=</span><span class="n">MachineDR</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">VisitNumber</span><span class="o">=</span><span class="n">Labno</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddTime</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">TCList</span><span class="o">=</span><span class="n">TCList</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713172254767-20250317141249-inxdych.png"
	width="1653"
	height="673"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713172254767-20250317141249-inxdych_hu_130b8be4c7479932.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713172254767-20250317141249-inxdych_hu_e3f1d0d5fcc6e9fc.png 1024w"
	loading="lazy"
	
		alt="image-20230713172254767"
	
	
		class="gallery-image" 
		data-flex-grow="245"
		data-flex-basis="589px"
	
></p>
<p>通过规则设置流水号</p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230714154951148-20250317141249-iig9eaw.png"
	width="1647"
	height="667"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230714154951148-20250317141249-iig9eaw_hu_f1048ee422f02938.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230714154951148-20250317141249-iig9eaw_hu_4d19b2357b7748e3.png 1024w"
	loading="lazy"
	
		alt="image-20230714154951148"
	
	
		class="gallery-image" 
		data-flex-grow="246"
		data-flex-basis="592px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">i &#39;$l(RuleCode)
</span></span><span class="line"><span class="cl">	        {
</span></span><span class="line"><span class="cl">		        s RuleCode=$lg($g(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR)),2)
</span></span><span class="line"><span class="cl">		    }
</span></span><span class="line"><span class="cl">		    // 罗氏流水线流水号通过规则生成流水号
</span></span><span class="line"><span class="cl">	        i RuleCode=&#34;LSHS&#34; d
</span></span><span class="line"><span class="cl">		    .s maxEpis=##class(MI.MIFRS600).GetEpis() //YHR 20230810 罗氏流水线规则
</span></span><span class="line"><span class="cl">		    e  d
</span></span><span class="line"><span class="cl">	        .s maxEpis=##Class(LIS.Common.DHCVisitNumber).GetRuleCodeEpisodeNo(RuleCode,.SYSRuleNoBaseDR)
</span></span></code></pre></td></tr></table>
</div>
</div><p>增加项目，删除项目，复查项目生成工单</p>
<p>LISSP.DHCRPVisitNumberReport</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Creator</span><span class="err">：</span>      <span class="err">杨浩然</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">CreatDate</span><span class="err">：</span>    <span class="mi">20230714</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="p">:</span><span class="err">：</span> <span class="err">主动上传生成项目工单</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>        
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="err">标本号，工作小组</span><span class="n">ID</span><span class="err">，报告</span><span class="n">ID</span><span class="err">，项目</span><span class="n">ID主键</span><span class="err">，工单类型（</span><span class="n">R</span> <span class="err">删除，</span><span class="n">U</span> <span class="err">复查，</span><span class="n">C</span> <span class="err">增加）</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">成功</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="err">生成上传工单</span> 
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Others</span>         <span class="n">w</span> <span class="c1">##class(LIS.Common.DHCVisitNumber).GenerateUploadRecordMTHD(&#34;1000100990&#34;,&#34;67&#34;,&#34;59396&#34;,&#34;^61^284&#34;,&#34;U&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GenerateUploadRecordMTHD</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span> <span class="n">WorkGroupMachineDR</span><span class="p">,</span> <span class="n">ReportDR</span><span class="p">,</span> <span class="n">RepeatTCList</span><span class="p">,</span> <span class="n">SendStatus</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">Labno</span><span class="p">),</span><span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;CreateUploadRecordMTHD&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">LB</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span> <span class="n">WorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">Labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">Labno</span><span class="p">),</span><span class="n">ReportDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">),</span><span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="n">RepeatTCList</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">RepeatTCList</span><span class="p">),</span><span class="n">SendStatus</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">SendStatus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(Labno) q 100</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(ReportDR) q 100 </span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(WorkGroupMachineDR) q 100</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(SendStatus) q 100</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CommDirection</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">临时处理老年医院流水线标本上传</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">i</span> <span class="n">CommDirection</span><span class="s1">&#39;=&#34;UP&#34;,CommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">s</span> <span class="o">^</span><span class="n">DHCUploadAll</span><span class="p">(</span><span class="n">Labno</span><span class="p">)</span><span class="o">=</span><span class="n">WorkGroupMachineDR</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">CommDirection</span><span class="s1">&#39;=&#34;UP&#34;,CommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">q</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">TCList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl">	<span class="n">f</span>  <span class="n">s</span> <span class="n">MachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterI</span><span class="p">(</span><span class="s2">&#34;IndexWorkGroupMachine&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="p">;</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">Labno</span><span class="p">))</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">miCommDirection</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">MachineDR</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">miCommDirection</span><span class="s1">&#39;=&#34;UP&#34;,CommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">RepeatTCList</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">TestCodeID</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">RepeatTCList</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="n">TestCodeID</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="o">..//</span><span class="err">如果是复查或者删除项目则判断该项目是不是该报告的</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">i</span> <span class="p">(</span><span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;U&#34;</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;R&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportResultI</span><span class="p">(</span><span class="s2">&#34;IndexReportItem&#34;</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">,</span><span class="n">TestCodeID</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">....</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineTestCodeI</span><span class="p">(</span><span class="s2">&#34;IndexUPChannel&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">TestCodeID</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">UPChannel</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineTestCodeI</span><span class="p">(</span><span class="s2">&#34;IndexUPChannel&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">TestCodeID</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="n">UPChannel</span><span class="o">=-</span><span class="mi">100000000000000</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">b</span> <span class="p">;</span><span class="mi">102</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=</span><span class="n">TCList_UPChannel_</span><span class="s2">&#34;</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">e</span>  <span class="n">i</span> <span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;C&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineTestCodeI</span><span class="p">(</span><span class="s2">&#34;IndexUPChannel&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">TestCodeID</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">UPChannel</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineTestCodeI</span><span class="p">(</span><span class="s2">&#34;IndexUPChannel&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">TestCodeID</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">i</span> <span class="n">UPChannel</span><span class="o">=-</span><span class="mi">100000000000000</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">b</span> <span class="p">;</span><span class="mi">102</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=</span><span class="n">TCList_UPChannel_</span><span class="s2">&#34;</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">b</span> <span class="p">;</span><span class="mi">101</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">TCList</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">TCList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(TCList) s ret=Labno_&#34;没有上传项目&#34; q </span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">S</span> <span class="n">RowID</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Labno))) s RowID=$O(^dbo.RPMachineUploadI(&#34;IndexMaster&#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">RowID</span><span class="p">)</span> <span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%OpenId(RowID)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">e</span>  <span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%New()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">MachineParameterDR</span><span class="o">=</span><span class="n">MachineDR</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">VisitNumber</span><span class="o">=</span><span class="n">Labno</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="o">=</span><span class="n">SendStatus</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddTime</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">TCList</span><span class="o">=</span><span class="n">TCList</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">Q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>增加 AddReportTCRes</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##class(LIS.Common.DHCVisitNumber).GenerateUploadRecordMTHD(LabNo,WGMDR,ReportDR,RepeatTCList,&#34;C&#34;)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>删除 DeleteReportTC</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##class(LIS.Common.DHCVisitNumber).GenerateUploadRecordMTHD(LabNo,WGMDR,ReportDR,RepeatTCList,&#34;R&#34;)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>复查 RepeatReportTC</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">S</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##class(LIS.Common.DHCVisitNumber).CreateUploadRecordMTHD(LabNo,WGMDR,ReportDR,RepeatTCList)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>编号规则</p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230910162537354-20250317141249-4kv6wo3.png"
	width="1351"
	height="333"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230910162537354-20250317141249-4kv6wo3_hu_c1f38adedf3b2896.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230910162537354-20250317141249-4kv6wo3_hu_7c5ed4de0c61508a.png 1024w"
	loading="lazy"
	
		alt="image-20230910162537354"
	
	
		class="gallery-image" 
		data-flex-grow="405"
		data-flex-basis="973px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[[&#34;&#34;1&#34;&#34;],[&#34;&#34;0&#34;&#34;,&#34;&#34;1&#34;&#34;,&#34;&#34;2&#34;&#34;,&#34;&#34;3&#34;&#34;,&#34;&#34;4&#34;&#34;,&#34;&#34;5&#34;&#34;,&#34;&#34;6&#34;&#34;,&#34;&#34;7&#34;&#34;,&#34;&#34;8&#34;&#34;,&#34;&#34;9&#34;&#34;],[&#34;&#34;0&#34;&#34;,&#34;&#34;1&#34;&#34;,&#34;&#34;2&#34;&#34;,&#34;&#34;3&#34;&#34;,&#34;&#34;4&#34;&#34;,&#34;&#34;5&#34;&#34;,&#34;&#34;6&#34;&#34;,&#34;&#34;7&#34;&#34;,&#34;&#34;8&#34;&#34;,&#34;&#34;9&#34;&#34;],[&#34;&#34;0&#34;&#34;,&#34;&#34;1&#34;&#34;,&#34;&#34;2&#34;&#34;,&#34;&#34;3&#34;&#34;,&#34;&#34;4&#34;&#34;,&#34;&#34;5&#34;&#34;,&#34;&#34;6&#34;&#34;,&#34;&#34;7&#34;&#34;,&#34;&#34;8&#34;&#34;,&#34;&#34;9&#34;&#34;],[&#34;&#34;0&#34;&#34;,&#34;&#34;1&#34;&#34;,&#34;&#34;2&#34;&#34;,&#34;&#34;3&#34;&#34;,&#34;&#34;4&#34;&#34;,&#34;&#34;5&#34;&#34;,&#34;&#34;6&#34;&#34;,&#34;&#34;7&#34;&#34;,&#34;&#34;8&#34;&#34;,&#34;&#34;9&#34;&#34;]]
</span></span></code></pre></td></tr></table>
</div>
</div>
    
    
    
    
</section>


<style>
   
  .document-link {
    color: #007bff;
    text-decoration: none;
    position: relative;
    padding: 0 2px;
  }
  
   
  .docx-link::after { content: "📄"; font-size: 0.8em; margin-left: 4px; }
  .doc-link::after { content: "📄"; font-size: 0.8em; margin-left: 4px; }
  .pdf-link::after { content: "📄"; font-size: 0.8em; margin-left: 4px; }
  .xls-link::after { content: "📊"; font-size: 0.8em; margin-left: 4px; }
  .xlsx-link::after { content: "📊"; font-size: 0.8em; margin-left: 4px; }
  .ppt-link::after { content: "📽️"; font-size: 0.8em; margin-left: 4px; }
  .pptx-link::after { content: "📽️"; font-size: 0.8em; margin-left: 4px; }
   
  .other-link::after { content: "📎"; font-size: 0.8em; margin-left: 4px; }


   
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  
  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  .modal-container {
    background: white;
    width: 90%;
    max-width: 1000px;
    height: 80vh;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: translateY(20px);
    transition: transform 0.3s ease;
  }
  
  .modal-overlay.active .modal-container {
    transform: translateY(0);
  }
  
  .modal-header {
    padding: 16px;
    background: #f5f5f5;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .modal-title {
    margin: 0;
    font-size: 1.2rem;
  }
  
  .modal-actions {
    display: flex;
    gap: 10px;
  }
  
  .search-container {
    flex: 1;
    margin: 0 16px;
    position: relative;
  }
  
  .search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  
  .search-input.loading {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cpolyline points='16 12 12 8 8 12'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    padding-right: 32px;
  }
  
  .search-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .nav-button {
    background: transparent;
    border: none;
    border-radius: 4px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
    pointer-events: auto !important;
  }
  
  .nav-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .nav-button:hover:not(:disabled) {
    background: #e0e0e0;
  }
  
  .nav-button:active {
    transform: scale(0.95);
    transition: transform 0.1s;
  }
  
   
  .nav-button .icon {
    width: 16px;
    height: 16px;
    fill: currentColor;
    color: #333;  
    transition: color 0.2s;
  }
  
  .nav-button:hover:not(:disabled) .icon {
    color: #000;  
  }
  
  
  .search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    padding: 8px 12px;
    font-size: 0.8rem;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: space-between;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-5px);
    transition: all 0.2s ease;
    pointer-events: none;
  }
  
  .search-results.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }
  
  .modal-body {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
  }
  
  .modal-footer {
    padding: 12px 16px;
    background: #f5f5f5;
    border-top: 1px solid #ddd;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  
  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s ease;
  }
  
  .btn-primary {
    background: #007bff;
    color: white;
  }
  
  .btn-primary:hover {
    background: #0056b3;
  }
  
  .btn-secondary {
    background: #6c757d;
    color: white;
  }
  
  .btn-secondary:hover {
    background: #5a6268;
  }
  
  .btn-close {
    background: #6c757d;
    color: white;
  }
  
  .btn-close:hover {
    background: #5a6268;
  }
  
  .highlight {
    background-color: #fff3cd !important;
    padding: 0 2px;
    border-radius: 2px;
  }
  
  .highlight.active {
    background-color: #ffeeba !important;
    outline: 2px solid #ffc107;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0% { outline-color: #ffc107; }
    50% { outline-color: #ffecb5; }
    100% { outline-color: #ffc107; }
  }


   
  .table-wrapper {
    overflow-x: auto;
    margin: 16px 0;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
    background-color: white;
  }
  
  table th, 
  table td {
    padding: 12px 15px;
    text-align: left;
    border: 1px solid #e0e0e0;
    word-wrap: break-word;
    vertical-align: top;
  }
  
  table th {
    background-color: #f8f9fa;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  table tr:nth-child(even) {
    background-color: #f8f9fa;
  }
  
  table tr:hover {
    background-color: #f1f3f5;
  }
  
   
  table .highlight {
    display: inline;
    margin: 0 -2px;
    padding: 0 2px;
  }
  
   
  table [id^="search-match-"] {
    position: relative;
  }
  
   
  .pdf-container {
    width: 100%;
    height: 100%;
    position: relative;
  }
  
  .pdf-viewer {
    width: 100%;
    height: calc(100% - 40px);
    overflow: auto;
    text-align: center;
    background-color: #f5f5f5;
    position: relative;
  }
  
  .pdf-toolbar {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 10px;
    background-color: #f5f5f5;
    border-bottom: 1px solid #ddd;
  }
  
  .pdf-page {
    display: inline-block;
    margin: 10px auto;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
  }
  
  .pdf-page canvas {
    display: block;
  }
  
  .pdf-navigation {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .page-number {
    width: 60px;
    text-align: center;
  }
  
  .pdf-zoom {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .pdf-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }
  
  .pdf-error {
    color: #dc3545;
    padding: 20px;
    text-align: center;
  }
  
   
  .office-embed-container {
    width: 100%;
    height: 100%;
    border: none;
  }
  
   
  .office-view-container {
    width: 100%;
    height: 100%;
    border: none;
  }
  
   
  .text-layer {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
    pointer-events: none;
    user-select: none;
  }
  
  .text-layer span {
    color: transparent;
    position: absolute;
    white-space: pre;
    cursor: text;
    transform-origin: 0% 0%;
  }
  
   
  @media (max-width: 768px) {
    .table-wrapper {
      margin: 12px 0;
      border-radius: 2px;
    }
    
    table th, 
    table td {
      padding: 8px 10px;
      font-size: 0.9rem;
    }
    
     
    .nav-button .icon {
      width: 14px;
      height: 14px;
    }
    
    .pdf-toolbar {
      flex-wrap: wrap;
      height: auto;
      padding: 5px;
      gap: 5px;
    }
    
    .pdf-navigation, .pdf-zoom {
      flex: 1;
      justify-content: center;
    }
  }

   
  .xlsx-content, .pptx-content {
      line-height: 1.6;
  }

  .worksheet-container {
      margin-bottom: 20px;
  }

  .slide {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 4px;
  }

  .slide-text {
      margin: 8px 0;
      padding: 4px 0;
  }

  .slide-text.level-0 { font-size: 1.2em; font-weight: bold; }
  .slide-text.level-1 { font-size: 1.1em; font-weight: 600; }
  .slide-text.level-2 { font-size: 1em; }

  .error-message {
      color: #dc3545;
      padding: 10px;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      background-color: #f8d7da;
  }

  .no-content {
      color: #6c757d;
      font-style: italic;
  }
</style>


<div class="modal-overlay" id="document-modal">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title" id="modal-title">文档预览</h3>
      <div class="modal-actions">
        
        <div class="search-container" id="search-container">
          <input type="text" class="search-input" id="search-input" placeholder="搜索文档内容...">
          <div class="search-results" id="search-results">
            <span id="match-count">未搜索</span>
            <div class="search-controls">
              <button class="nav-button" id="prev-match-popup" title="上一个匹配项 (Shift+Enter)">
                
                <img src="/icons/up.svg" alt="上一个匹配项" class="icon" />
              </button>
              <button class="nav-button" id="next-match-popup" title="下一个匹配项 (Enter)">
                
                <img src="/icons/down.svg" alt="下一个匹配项" class="icon" />
              </button>
            </div>
          </div>
        </div>
        <button class="btn btn-close" id="close-modal">关闭</button>
      </div>
    </div>
    <div class="modal-body" id="document-preview">
      
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="open-new-tab">新标签页打开</button>
      <a href="" class="btn btn-primary" id="download-link" download>下载文档</a>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.17/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptx-parser@0.1.6/dist/pptx-parser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script>

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

document.addEventListener('DOMContentLoaded', () => {
    
    const documentConfig = {
        defaultAction: "map[action:modal search:false]",
        docx: { action: "mammoth" },
        doc: { action: "officeViewmodal" },
        pdf: { action: "modal" },
        xls: { action: "officeViewmodal" },
        xlsx: { action: "mammoth" },
        ppt: { action: "officeEmbed" },
        pptx: { action: "officeEmbed" }
    };


    
    const modal = document.getElementById('document-modal');
    const modalTitle = document.getElementById('modal-title');
    const previewContainer = document.querySelector('#document-modal #document-preview');
    const closeModalBtn = document.getElementById('close-modal');
    const downloadLink = document.getElementById('download-link');
    const openNewTabBtn = document.getElementById('open-new-tab');
    const searchInput = document.getElementById('search-input');
    const searchContainer = document.getElementById('search-container');
    const searchResults = document.getElementById('search-results');
    const matchCount = document.getElementById('match-count');
    const prevMatchBtn = document.getElementById('prev-match-popup');
    const nextMatchBtn = document.getElementById('next-match-popup');
    
    
    let currentDocContent = null;
    let currentDocType = null;
    let currentDocUrl = null;
    let currentSearchTerm = '';
    let matchCountTotal = 0;
    let currentMatchIndex = -1;
    let isSearching = false;
    let searchTimeout = null;
    let currentAction = null; 
    const SEARCH_DELAY = 300;
    const MATCH_ID_PREFIX = 'search-match-';
    const MAMMOTH_SUPPORTED_TYPES = ['docx', 'xlsx', 'pptx']; 
    
    
    let pdfDoc = null;
    let currentPage = 1;
    let zoom = 1.0;
    let pdfSearchResults = [];
    let pdfCurrentSearchIndex = -1;
    
    
    if (!modal || !previewContainer || !searchResults || !prevMatchBtn || !nextMatchBtn) {
        console.error('关键元素未找到，请检查HTML结构');
        return;
    }


    
    function openModal() {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        previewContainer.innerHTML = '';
        updateSearchUI();
    }


    
    function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        resetSearch();
        previewContainer.innerHTML = '';
        currentDocContent = null;
        currentDocType = null;
        currentDocUrl = null;
        currentAction = null;
        
        
        pdfDoc = null;
        currentPage = 1;
        zoom = 1.0;
        pdfSearchResults = [];
        pdfCurrentSearchIndex = -1;
    }


    
    function resetSearch() {
        if (searchTimeout) {
            clearTimeout(searchTimeout);
            searchTimeout = null;
        }
        
        searchInput.classList.remove('loading');
        searchInput.value = '';
        currentSearchTerm = '';
        matchCountTotal = 0;
        currentMatchIndex = -1;
        
        
        if (previewContainer) {
            const highlights = previewContainer.querySelectorAll('.highlight');
            highlights.forEach(el => {
                const textNode = document.createTextNode(el.textContent);
                el.parentNode.replaceChild(textNode, el);
            });
        }
        
        
        pdfSearchResults = [];
        pdfCurrentSearchIndex = -1;
        
        updateSearchUI();
    }


    
    function updateSearchUI() {
        
        
        
        
		const showSearch = currentAction === 'mammoth' && MAMMOTH_SUPPORTED_TYPES.includes(currentDocType);		
        searchContainer.style.display = showSearch ? 'block' : 'none';
        
        
        if (currentSearchTerm === '' && matchCountTotal === 0) {
            searchResults.classList.remove('visible');
        } else {
            searchResults.classList.add('visible');
        }
        
        
        if (currentSearchTerm === '') {
            matchCount.textContent = '未搜索';
        } else if (matchCountTotal === 0) {
            matchCount.textContent = '未找到匹配项';
        } else {
            matchCount.textContent = `找到 ${matchCountTotal} 个匹配项 (${currentMatchIndex + 1}/${matchCountTotal})`;
        }
        
        
        const hasMatches = matchCountTotal > 0;
        prevMatchBtn.disabled = !hasMatches;
        nextMatchBtn.disabled = !hasMatches;
    }


    
    async function performSearch(text) {
        
        if (currentDocType === 'pdf' && pdfDoc) {
            return performPdfSearch(text);
        }
        
        
        if (isSearching || currentAction !== 'mammoth' || 
            !MAMMOTH_SUPPORTED_TYPES.includes(currentDocType)) {
            return;
        }
        
        if (!text || text.trim() === '' || !currentDocContent) {
            resetSearch();
            return;
        }
        
        isSearching = true;
        searchInput.classList.add('loading');
        currentSearchTerm = text.trim();
        updateSearchUI();
        
        try {
            await new Promise(resolve => {
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(resolve, { timeout: 1000 });
                } else {
                    setTimeout(resolve, 0);
                }
            });
            
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentDocContent;
            
            
            const term = currentSearchTerm.toLowerCase();
            const newMatchCount = findAndMarkMatches(tempDiv, term);
            
            
            const tables = tempDiv.querySelectorAll('table');
            tables.forEach(table => {
                if (!table.parentNode.classList.contains('table-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-wrapper';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                }
            });
            
            
            matchCountTotal = newMatchCount;
            currentMatchIndex = newMatchCount > 0 ? 0 : -1;
            
            
            previewContainer.innerHTML = tempDiv.innerHTML;
            
            
            if (matchCountTotal > 0) {
                scrollToMatch(0);
            }
            
        } catch (error) {
            console.error('搜索出错:', error);
            matchCount.textContent = '搜索出错';
        } finally {
            isSearching = false;
            searchInput.classList.remove('loading');
            updateSearchUI();
        }
    }


    
    async function performPdfSearch(text) {
        if (isSearching || !pdfDoc || !text || text.trim() === '') {
            resetSearch();
            return;
        }
        
        isSearching = true;
        searchInput.classList.add('loading');
        currentSearchTerm = text.trim();
        pdfSearchResults = [];
        pdfCurrentSearchIndex = -1;
        matchCountTotal = 0;
        
        try {
            
            const pages = previewContainer.querySelectorAll('.pdf-page');
            pages.forEach(page => {
                const highlightLayer = page.querySelector('.text-layer');
                if (highlightLayer) {
                    const highlights = highlightLayer.querySelectorAll('.highlight');
                    highlights.forEach(highlight => {
                        highlight.classList.remove('highlight', 'active');
                    });
                }
            });
            
            
            const numPages = pdfDoc.numPages;
            for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                const page = await pdfDoc.getPage(pageNum);
                const content = await page.getTextContent();
                
                
                const searchTerm = currentSearchTerm.toLowerCase();
                content.items.forEach((item, index) => {
                    if (typeof item.str === 'string' && item.str.toLowerCase().includes(searchTerm)) {
                        
                        pdfSearchResults.push({
                            pageNum,
                            itemIndex: index,
                            text: item.str,
                            transform: item.transform,
                            width: item.width,
                            height: item.height
                        });
                    }
                });
            }
            
            
            matchCountTotal = pdfSearchResults.length;
            pdfCurrentSearchIndex = matchCountTotal > 0 ? 0 : -1;
            currentMatchIndex = pdfCurrentSearchIndex;
            
            
            if (matchCountTotal > 0) {
                await scrollToPdfMatch(0);
            }
            
        } catch (error) {
            console.error('PDF搜索出错:', error);
            matchCount.textContent = '搜索出错';
        } finally {
            isSearching = false;
            searchInput.classList.remove('loading');
            updateSearchUI();
        }
    }


    
    function findAndMarkMatches(element, term) {
        if (!term) return 0;
        
        let matchNumber = 0;
        
        function processNode(node) {
            if (node.nodeType === Node.ELEMENT_NODE) {
                
                if (['SCRIPT', 'STYLE', 'NOSCRIPT', 'IMG', 'VIDEO', 'AUDIO'].includes(node.tagName)) {
                    return;
                }
                
                
                const children = Array.from(node.childNodes);
                children.forEach(processNode);
            } else if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent;
                const lowerText = text.toLowerCase();
                let index = 0;
                const termLength = term.length;
                
                while ((index = lowerText.indexOf(term, index)) !== -1) {
                    
                    const parent = node.parentNode;
                    if (!parent) {
                        index += termLength;
                        continue;
                    }
                    
                    const currentNode = node;
                    const beforeNode = currentNode.splitText(index);
                    const matchNode = beforeNode.splitText(termLength);
                    
                    
                    const highlight = document.createElement('span');
                    highlight.className = 'highlight';
                    highlight.id = `${MATCH_ID_PREFIX}${matchNumber}`;
                    highlight.textContent = beforeNode.textContent;
                    
                    parent.replaceChild(highlight, beforeNode);
                    matchNumber++;
                    
                    
                    index += termLength;
                    node = matchNode;
                }
            }
        }
        
        processNode(element);
        return matchNumber;
    }


    
    function scrollToMatch(index) {
        
        if (matchCountTotal === 0 || index < 0 || index >= matchCountTotal) {
            console.warn('无效的匹配项索引:', index);
            return;
        }
        
        
        document.querySelectorAll('.highlight.active').forEach(el => {
            el.classList.remove('active');
        });
        
        
        const matchId = `${MATCH_ID_PREFIX}${index}`;
        const matchElement = document.getElementById(matchId);
        
        if (!matchElement) {
            console.warn(`匹配项ID ${matchId} 未找到在DOM中`);
            restoreMatches();
            return;
        }
        
        
        currentMatchIndex = index;
        matchElement.classList.add('active');
        
        
        matchElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center',
            inline: 'center'
        });
        
        
        const tableWrapper = matchElement.closest('.table-wrapper');
        if (tableWrapper) {
            const tableRect = matchElement.getBoundingClientRect();
            const wrapperRect = tableWrapper.getBoundingClientRect();
            
            
            if (tableRect.left < wrapperRect.left || tableRect.right > wrapperRect.right) {
                
                tableWrapper.scrollLeft += (tableRect.left - wrapperRect.left) - (wrapperRect.width / 4);
            }
        }
        
        updateSearchUI();
    }


    
    async function scrollToPdfMatch(index) {
        if (pdfSearchResults.length === 0 || index < 0 || index >= pdfSearchResults.length) {
            return;
        }
        
        const match = pdfSearchResults[index];
        pdfCurrentSearchIndex = index;
        currentMatchIndex = index;
        
        
        const pages = previewContainer.querySelectorAll('.pdf-page');
        pages.forEach(page => {
            const highlightLayer = page.querySelector('.text-layer');
            if (highlightLayer) {
                const highlights = highlightLayer.querySelectorAll('.highlight');
                highlights.forEach(highlight => {
                    highlight.classList.remove('highlight', 'active');
                });
            }
        });
        
        
        await renderPage(match.pageNum);
        
        
        const currentPageEl = previewContainer.querySelector(`.pdf-page[data-page="${match.pageNum}"]`);
        if (currentPageEl) {
            const textLayer = currentPageEl.querySelector('.text-layer');
            if (textLayer) {
                
                const textElements = textLayer.querySelectorAll('.text');
                
                
                if (textElements[match.itemIndex]) {
                    textElements[match.itemIndex].classList.add('highlight', 'active');
                    
                    
                    textElements[match.itemIndex].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }
        }
        
        updateSearchUI();
    }


    
    function restoreMatches() {
        console.log('尝试恢复匹配项索引');
        
        const matches = document.querySelectorAll(`[id^="${MATCH_ID_PREFIX}"]`);
        matchCountTotal = matches.length;
        
        if (matchCountTotal > 0) {
            currentMatchIndex = 0;
            updateSearchUI();
            scrollToMatch(0);
        } else {
            if (currentSearchTerm) {
                performSearch(currentSearchTerm);
            }
        }
    }


    
    function goToNextMatch() {
        if (matchCountTotal === 0) {
            return;
        }
        
        
        if (currentDocType === 'pdf' && pdfDoc) {
            const nextIndex = (pdfCurrentSearchIndex + 1) % matchCountTotal;
            scrollToPdfMatch(nextIndex);
            return;
        }
        
        const nextIndex = (currentMatchIndex + 1) % matchCountTotal;
        scrollToMatch(nextIndex);
    }


    
    function goToPrevMatch() {
        if (matchCountTotal === 0) {
            return;
        }
        
        
        if (currentDocType === 'pdf' && pdfDoc) {
            const prevIndex = (pdfCurrentSearchIndex - 1 + matchCountTotal) % matchCountTotal;
            scrollToPdfMatch(prevIndex);
            return;
        }
        
        const prevIndex = (currentMatchIndex - 1 + matchCountTotal) % matchCountTotal;
        scrollToMatch(prevIndex);
    }


    
    searchInput.addEventListener('input', (e) => {
        const searchText = e.target.value;
        
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        if (searchText.trim() === '') {
            resetSearch();
            return;
        }
        
        searchTimeout = setTimeout(() => {
            performSearch(searchText);
        }, SEARCH_DELAY);
    });


    
    prevMatchBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        goToPrevMatch();
    });
    
    nextMatchBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        goToNextMatch();
    });


    
    searchInput.addEventListener('keydown', (e) => {
        if ((e.key === 'Enter') && !e.shiftKey) {
            e.preventDefault();
            goToNextMatch();
        }
        
        if (e.key === 'Enter' && e.shiftKey) {
            e.preventDefault();
            goToPrevMatch();
        }
        
        if ((e.key === 'ArrowDown') && !e.shiftKey) {
            e.preventDefault();
            goToNextMatch();
        }
        
        if (e.key === 'ArrowUp' && !e.shiftKey) {
            e.preventDefault();
            goToPrevMatch();
        }
    });


    
    function openInNewTab(url, docType, title) {
        const action = getDocumentAction(docType);
        
        
        switch(action) {
            case 'mammoth':
                
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    
                    let additionalLibraries = '';
                    if (docType === 'xlsx') {
                        additionalLibraries = '\x3Cscript src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js">\x3C/script>';
                    } else if (docType === 'pptx') {
                        additionalLibraries = '\x3Cscript src="https://cdn.jsdelivr.net/npm/pptx-parser@0.1.6/dist/pptx-parser.min.js">\x3C/script>';
                    } else if (docType === 'pdf') {
                        additionalLibraries = '\x3Cscript src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js">\x3C/script>';
                    }
                    
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>${title || '文档预览'}</title>
                            \x3Cscript src="https://cdn.jsdelivr.net/npm/mammoth@1.4.17/mammoth.browser.min.js">\x3C/script>
                            ${additionalLibraries}
                            <style>
                                body { margin: 0; padding: 20px; max-width: 1000px; margin: 0 auto; }
                                .loading { text-align: center; padding: 50px; }
                                .error { color: #dc3545; text-align: center; padding: 50px; }
                                .table-wrapper { overflow-x: auto; margin: 16px 0; }
                                table { border-collapse: collapse; width: 100%; }
                                table th, table td { border: 1px solid #ddd; padding: 8px 12px; }
                                table th { background-color: #f8f9fa; }
                                /* Excel和PowerPoint预览样式 */
                                .xlsx-content, .pptx-content { line-height: 1.6; }
                                .worksheet-container { margin-bottom: 20px; }
                                .slide { margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 4px; }
                                .slide-text { margin: 8px 0; padding: 4px 0; }
                                .slide-text.level-0 { font-size: 1.2em; font-weight: bold; }
                                .slide-text.level-1 { font-size: 1.1em; font-weight: 600; }
                                .slide-text.level-2 { font-size: 1em; }
                            </style>
                        </head>
                        <body>
                            <div class="loading">
                                <p>正在加载文档...</p>
                            </div>
                            \x3Cscript>
                                // 辅助函数：转义HTML特殊字符
                                function escapeHtml(unsafe) {
                                    if (!unsafe) return '';
                                    return unsafe
                                        .replace(/&/g, "&amp;")
                                        .replace(/</g, "&lt;")
                                        .replace(/>/g, "&gt;")
                                        .replace(/"/g, "&quot;")
                                        .replace(/'/g, "&#039;");
                                }
                                
                                // 解析XLSX文件
                                async function parseXlsx(arrayBuffer) {
                                    try {
                                        // 使用xlsx库解析Excel文件
                                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                                        
                                        let htmlContent = '<div class="xlsx-content">';
                                        htmlContent += \`<h3>Excel文档: \${workbook.SheetNames.length} 个工作表</h3>\`;
                                        
                                        // 遍历所有工作表
                                        workbook.SheetNames.forEach((sheetName, index) => {
                                            // 将工作表转换为HTML
                                            const worksheet = workbook.Sheets[sheetName];
                                            const html = XLSX.utils.sheet_to_html(worksheet);
                                            
                                            // 添加工作表标题和内容
                                            htmlContent += \`
                                                <div class="worksheet-container">
                                                    <h4>工作表 \${index + 1}: \${sheetName}</h4>
                                                    <div class="table-wrapper">\${html}</div>
                                                </div>
                                                <hr>
                                            \`;
                                        });
                                        
                                        htmlContent += '</div>';
                                        
                                        return { value: htmlContent };
                                    } catch (error) {
                                        console.error('XLSX解析错误:', error);
                                        return { 
                                            value: \`<div class="error-message">
                                                <p>无法解析Excel文件</p>
                                                <p>错误: \${error.message}</p>
                                            </div>\` 
                                        };
                                    }
                                }
                                
                                // 解析PPTX文件
                                async function parsePptx(arrayBuffer) {
                                    try {
                                        // 将ArrayBuffer转换为Uint8Array
                                        const uint8Array = new Uint8Array(arrayBuffer);
                                        
                                        // 使用pptx-parser解析PowerPoint文件
                                        const presentation = await PptxParser.parse(uint8Array);
                                        
                                        let htmlContent = '<div class="pptx-content">';
                                        htmlContent += \`<h3>PowerPoint文档: \${presentation.slides.length} 张幻灯片</h3>\`;
                                        
                                        // 遍历所有幻灯片
                                        presentation.slides.forEach((slide, index) => {
                                            htmlContent += \`<div class="slide slide-\${index + 1}">\`;
                                            htmlContent += \`<h4>幻灯片 \${index + 1}</h4>\`;
                                            
                                            // 处理幻灯片内容
                                            if (slide.text && slide.text.length > 0) {
                                                htmlContent += '<div class="slide-content">';
                                                
                                                // 处理文本内容
                                                slide.text.forEach(text => {
                                                    // 根据文本级别使用适当的标题或段落标签
                                                    const tag = text.level === 0 ? 'h5' : 
                                                               text.level === 1 ? 'h6' : 'p';
                                                    htmlContent += \`<\${tag} class="slide-text level-\${text.level}">\${escapeHtml(text.content)}</\${tag}>\`;
                                                });
                                                
                                                htmlContent += '</div>';
                                            } else {
                                                htmlContent += '<p class="no-content">此幻灯片没有可提取的文本内容</p>';
                                            }
                                            
                                            htmlContent += '</div><hr>';
                                        });
                                        
                                        htmlContent += '</div>';
                                        
                                        return { value: htmlContent };
                                    } catch (error) {
                                        console.error('PPTX解析错误:', error);
                                        return { 
                                            value: \`<div class="error-message">
                                                <p>无法解析PowerPoint文件</p>
                                                <p>错误: \${error.message}</p>
                                            </div>\` 
                                        };
                                    }
                                }
                                
                                // 解析文档并显示
                                async function loadDocument() {
                                    try {
                                        const response = await fetch('${url}');
                                        if (!response.ok) throw new Error('加载失败');
                                        
                                        const arrayBuffer = await response.arrayBuffer();
                                        let result;
                                        
                                        // 根据文档类型使用不同的解析方式
                                        switch('${docType}') {
                                            case 'docx':
                                                result = await mammoth.convertToHtml({ arrayBuffer });
                                                break;
                                            case 'xlsx':
                                                // 对于Excel文件，使用xlsx库解析
                                                result = await parseXlsx(arrayBuffer);
                                                break;
                                            case 'pptx':
                                                // 对于PowerPoint文件，使用pptx-parser解析
                                                result = await parsePptx(arrayBuffer);
                                                break;
                                            case 'pdf':
                                                // 对于PDF文件，使用pdf.js
                                                if (typeof pdfjsLib !== 'undefined') {
                                                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
                                                    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                                                    let htmlContent = '<div class="pdf-container">';
                                                    htmlContent += \`<h3>PDF文档: \${pdfDoc.numPages} 页</h3>\`;
                                                    htmlContent += '<div class="pdf-viewer">';
                                                    
                                                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                                                        const page = await pdfDoc.getPage(i);
                                                        const viewport = page.getViewport({ scale: 1.0 });
                                                        htmlContent += \`<div class="pdf-page" style="width: \${viewport.width}px; height: \${viewport.height}px;">\`;
                                                        htmlContent += \`<canvas id="page-\${i}" width="\${viewport.width}" height="\${viewport.height}"></canvas>\`;
                                                        htmlContent += '</div>';
                                                    }
                                                    
                                                    htmlContent += '</div></div>';
                                                    
                                                    document.body.innerHTML = htmlContent;
                                                    
                                                    // 渲染PDF页面
                                                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                                                        const page = await pdfDoc.getPage(i);
                                                        const viewport = page.getViewport({ scale: 1.0 });
                                                        const canvas = document.getElementById(\`page-\${i}\`);
                                                        const context = canvas.getContext('2d');
                                                        await page.render({ canvasContext: context, viewport }).promise;
                                                    }
                                                    
                                                    return;
                                                } else {
                                                    throw new Error('PDF.js库未加载');
                                                }
                                                break;
                                            default:
                                                throw new Error(\`不支持的文档类型: \${'${docType}'}\`);
                                        }
                                        
                                        // 处理表格，添加响应式包装器
                                        const tempDiv = document.createElement('div');
                                        tempDiv.innerHTML = result.value;
                                        
                                        // 为所有表格添加包装容器
                                        const tables = tempDiv.querySelectorAll('table');
                                        tables.forEach(table => {
                                            if (!table.parentNode.classList.contains('table-wrapper')) {
                                                const wrapper = document.createElement('div');
                                                wrapper.className = 'table-wrapper';
                                                table.parentNode.insertBefore(wrapper, table);
                                                wrapper.appendChild(table);
                                            }
                                        });
                                        
                                        document.body.innerHTML = tempDiv.innerHTML;
                                    } catch (err) {
                                        document.body.innerHTML = \`
                                            <div class="error">
                                                <p>文档加载失败</p>
                                                <p>\${err.message}</p>
                                                <p><a href="${url}" download class="btn btn-primary">下载文档</a></p>
                                            </div>
                                        \`;
                                    }
                                }
                                
                                loadDocument();
                            \x3C/script>
                        </body>
                        </html>
                    `);
                    newWindow.document.close();
                }
                break;
                
            case 'officeView':
            case 'officeViewmodal':
                
                const officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(url)}`;
                window.open(officeViewerUrl, '_blank');
                break;
                
            case 'officeEmbed':
            case 'officeEmbednewTab':
                
                const officeEmbedUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
                window.open(officeEmbedUrl, '_blank');
                break;
                
            case 'modal':
                
                window.open(url, '_blank');
                break;
                
            case 'download':
                
                const a = document.createElement('a');
                a.href = url;
                a.download = title;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                break;
                
            case 'newTab':
            default:
                
                window.open(url, '_blank');
                break;
        }
    }


    
    openNewTabBtn.addEventListener('click', () => {
        if (currentDocUrl && currentDocType) {
            openInNewTab(currentDocUrl, currentDocType, modalTitle.textContent);
        }
    });


    
    function getDocumentAction(docType) {
        
        if (documentConfig[docType] && documentConfig[docType].action) {
            return documentConfig[docType].action;
        }
        return documentConfig.defaultAction;
    }


    
    function handleOfficeView(url) {
        const officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(url)}`;
        window.open(officeViewerUrl, '_blank');
    }


    
    function handleOfficeViewModal(url, title) {
        openModal();
        modalTitle.textContent = title;
        
        
        const iframe = document.createElement('iframe');
        iframe.src = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(url)}`;
        iframe.className = 'office-view-container';
        iframe.title = title;
        
        previewContainer.innerHTML = '';
        previewContainer.appendChild(iframe);
    }


    
    function handleOfficeEmbed(url, title) {
        openModal();
        modalTitle.textContent = title;
        
        
        const iframe = document.createElement('iframe');
        iframe.src = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
        iframe.className = 'office-embed-container';
        iframe.title = title;
        
        previewContainer.innerHTML = '';
        previewContainer.appendChild(iframe);
    }


    
    function handleOfficeEmbedNewTab(url) {
        const officeEmbedUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
        window.open(officeEmbedUrl, '_blank');
    }


    
    async function handlePdfPreview(url, title) {
        openModal();
        modalTitle.textContent = title;
        
        
        previewContainer.innerHTML = `
            <div class="pdf-container">
                <div class="pdf-toolbar">
                    <div class="pdf-navigation">
                        <button class="btn" id="prev-page">上一页</button>
                        <span id="page-num">1</span> / <span id="page-count">加载中...</span>
                        <button class="btn" id="next-page">下一页</button>
                    </div>
                    <div class="pdf-zoom">
                        <button class="btn" id="zoom-out">缩小</button>
                        <span id="zoom-level">100%</span>
                        <button class="btn" id="zoom-in">放大</button>
                    </div>
                </div>
                <div class="pdf-viewer">
                    <div class="pdf-loading">
                        <p>正在加载PDF文档...</p>
                    </div>
                </div>
            </div>
        `;
        
        try {
            
            const pdfViewer = previewContainer.querySelector('.pdf-viewer');
            const loadingIndicator = previewContainer.querySelector('.pdf-loading');
            
            
            const response = await fetch(url);
            const data = await response.arrayBuffer();
            
            
            pdfDoc = await pdfjsLib.getDocument({ data }).promise;
            
            
            document.getElementById('page-count').textContent = pdfDoc.numPages;
            
            
            await renderPage(1);
            
            
            loadingIndicator.style.display = 'none';
            
            
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage <= 1) return;
                renderPage(currentPage - 1);
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                if (currentPage >= pdfDoc.numPages) return;
                renderPage(currentPage + 1);
            });
            
            document.getElementById('zoom-in').addEventListener('click', () => {
                zoom += 0.1;
                renderPage(currentPage);
                document.getElementById('zoom-level').textContent = `${Math.round(zoom * 100)}%`;
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                if (zoom <= 0.5) return;
                zoom -= 0.1;
                renderPage(currentPage);
                document.getElementById('zoom-level').textContent = `${Math.round(zoom * 100)}%`;
            });
            
            
            previewContainer.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                    if (currentPage > 1) renderPage(currentPage - 1);
                } else if (e.key === 'ArrowRight') {
                    if (currentPage < pdfDoc.numPages) renderPage(currentPage + 1);
                } else if (e.key === '+') {
                    zoom += 0.1;
                    renderPage(currentPage);
                    document.getElementById('zoom-level').textContent = `${Math.round(zoom * 100)}%`;
                } else if (e.key === '-') {
                    if (zoom > 0.5) {
                        zoom -= 0.1;
                        renderPage(currentPage);
                        document.getElementById('zoom-level').textContent = `${Math.round(zoom * 100)}%`;
                    }
                }
            });
            
        } catch (error) {
            console.error('PDF加载错误:', error);
            previewContainer.innerHTML = `
                <div class="pdf-error">
                    <p>无法加载PDF文档</p>
                    <p>错误: ${error.message}</p>
                    <p><a href="${url}" class="btn btn-primary" download>下载PDF</a></p>
                </div>
            `;
        }
    }


    
    async function renderPage(num) {
        if (!pdfDoc) return;
        
        currentPage = num;
        document.getElementById('page-num').textContent = num;
        
        const pdfViewer = previewContainer.querySelector('.pdf-viewer');
        const page = await pdfDoc.getPage(num);
        
        
        pdfViewer.innerHTML = '';
        
        
        const pageContainer = document.createElement('div');
        pageContainer.className = 'pdf-page';
        pageContainer.dataset.page = num;
        pdfViewer.appendChild(pageContainer);
        
        
        const viewport = page.getViewport({ scale: zoom });
        
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        pageContainer.appendChild(canvas);
        
        
        const textLayerDiv = document.createElement('div');
        textLayerDiv.className = 'text-layer';
        textLayerDiv.style.width = `${viewport.width}px`;
        textLayerDiv.style.height = `${viewport.height}px`;
        textLayerDiv.style.transform = `scale(${zoom})`;
        textLayerDiv.style.transformOrigin = '0 0';
        pageContainer.appendChild(textLayerDiv);
        
        
        const renderContext = {
            canvasContext: context,
            viewport: viewport
        };
        
        const renderTask = page.render(renderContext);
        await renderTask.promise;
        
        
        const textContent = await page.getTextContent();
        renderTextLayer(textContent, textLayerDiv, viewport);
        
        
        pageContainer.style.width = `${viewport.width}px`;
        pageContainer.style.height = `${viewport.height}px`;
        
        
        if (pdfSearchResults.length > 0) {
            const currentMatch = pdfSearchResults.find(match => match.pageNum === num);
            if (currentMatch) {
                const textElements = textLayerDiv.querySelectorAll('.text');
                if (textElements[currentMatch.itemIndex]) {
                    textElements[currentMatch.itemIndex].classList.add('highlight');
                    if (pdfCurrentSearchIndex === pdfSearchResults.indexOf(currentMatch)) {
                        textElements[currentMatch.itemIndex].classList.add('active');
                    }
                }
            }
        }
    }


    
    function renderTextLayer(textContent, textLayerDiv, viewport) {
        
        textLayerDiv.innerHTML = '';
        
        const textItems = textContent.items;
        const scale = viewport.scale;
        
        
        const sortedItems = [...textItems].sort((a, b) => {
            
            if (Math.abs(a.transform[5] - b.transform[5]) > 1) {
                return a.transform[5] - b.transform[5];
            }
            
            return a.transform[4] - b.transform[4];
        });
        
        sortedItems.forEach((item, index) => {
            const span = document.createElement('span');
            span.className = 'text';
            span.textContent = item.str;
            span.dataset.index = index;
            
            
            const x = item.transform[4] / scale;
            const y = item.transform[5] / scale;
            
            
            Object.assign(span.style, {
                left: `${x}px`,
                top: `${y}px`,
                fontSize: `${item.height / scale}px`,
                height: `${item.height / scale}px`,
                width: `${item.width / scale}px`,
                transform: `scale(${1/scale})`,
                transformOrigin: '0 0',
                position: 'absolute',
                whiteSpace: 'pre'
            });
            
            textLayerDiv.appendChild(span);
        });
    }


    
    async function handleMammothParse(url, title, docType) {
        if (!MAMMOTH_SUPPORTED_TYPES.includes(docType)) {
            console.warn(`不支持对${docType}类型使用mammoth解析`);
            return false;
        }
        
        try {
            openModal();
            previewContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fa fa-spinner fa-spin"></i> 正在解析文档...</div>';
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`请求失败: ${response.status}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            let result;
            
            
            switch(docType) {
                case 'docx':
                    result = await mammoth.convertToHtml({ arrayBuffer });
                    break;
                case 'xlsx':
                    
                    result = await parseXlsx(arrayBuffer);
                    break;
                case 'pptx':
                    
                    result = await parsePptx(arrayBuffer);
                    break;
                default:
                    throw new Error(`不支持的文档类型: ${docType}`);
            }
            
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = result.value;
            
            
            const tables = tempDiv.querySelectorAll('table');
            tables.forEach(table => {
                if (!table.parentNode.classList.contains('table-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-wrapper';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                }
            });
            
            currentDocContent = tempDiv.innerHTML;
            previewContainer.innerHTML = currentDocContent;
            resetSearch();
            return true;
            
        } catch (err) {
            previewContainer.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">
                解析失败，请<a href="${url}" class="btn btn-primary">下载文档</a>查看
                <p class="error-message">错误: ${err.message}</p>
            </div>`;
            console.error('解析错误：', err);
            return false;
        }
    }


    
	async function parseXlsx(arrayBuffer) {
		try {
			
			const workbook = XLSX.read(arrayBuffer, { type: 'array' });
			
			let htmlContent = '<div class="xlsx-content">';
			htmlContent += `<h3>Excel文档: ${workbook.SheetNames.length} 个工作表</h3>`;
			
			
			workbook.SheetNames.forEach((sheetName, index) => {
				
				const worksheet = workbook.Sheets[sheetName];
				const html = XLSX.utils.sheet_to_html(worksheet);
				
				
				htmlContent += `
					<div class="worksheet-container">
						<h4>工作表 ${index + 1}: ${sheetName}</h4>
						<div class="table-wrapper">${html}</div>
					</div>
					<hr>
				`;
			});
			
			htmlContent += '</div>';
			
			return { value: htmlContent };
		} catch (error) {
			console.error('XLSX解析错误:', error);
			return { 
				value: `<div class="error-message">
					<p>无法解析Excel文件</p>
					<p>错误: ${error.message}</p>
				</div>` 
			};
		}
	}

	
	async function parsePptx(arrayBuffer) {
		try {
			
			const uint8Array = new Uint8Array(arrayBuffer);
			
			
			const presentation = await PptxParser.parse(uint8Array);
			
			let htmlContent = '<div class="pptx-content">';
			htmlContent += `<h3>PowerPoint文档: ${presentation.slides.length} 张幻灯片</h3>`;
			
			
			presentation.slides.forEach((slide, index) => {
				htmlContent += `<div class="slide slide-${index + 1}">`;
				htmlContent += `<h4>幻灯片 ${index + 1}</h4>`;
				
				
				if (slide.text && slide.text.length > 0) {
					htmlContent += '<div class="slide-content">';
					
					
					slide.text.forEach(text => {
						
						const tag = text.level === 0 ? 'h5' : 
								   text.level === 1 ? 'h6' : 'p';
						htmlContent += `<${tag} class="slide-text level-${text.level}">${escapeHtml(text.content)}</${tag}>`;
					});
					
					htmlContent += '</div>';
				} else {
					htmlContent += '<p class="no-content">此幻灯片没有可提取的文本内容</p>';
				}
				
				htmlContent += '</div><hr>';
			});
			
			htmlContent += '</div>';
			
			return { value: htmlContent };
		} catch (error) {
			console.error('PPTX解析错误:', error);
			return { 
				value: `<div class="error-message">
					<p>无法解析PowerPoint文件</p>
					<p>错误: ${error.message}</p>
				</div>` 
			};
		}
	}

	
	function escapeHtml(unsafe) {
		if (!unsafe) return '';
		return unsafe
			.replace(/&/g, "&amp;")
			.replace(/</g, "&lt;")
			.replace(/>/g, "&gt;")
			.replace(/"/g, "&quot;")
			.replace(/'/g, "&#039;");
	}


    
    document.querySelectorAll('.document-link').forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            const docUrl = link.href;
            const docTitle = link.textContent.trim();
            const docType = link.getAttribute('data-type');
            const action = getDocumentAction(docType);
            
            
            currentDocUrl = docUrl;
            currentDocType = docType;
            currentAction = action;
            modalTitle.textContent = docTitle;
            downloadLink.href = docUrl;
			
			
			let fileName = docTitle;
			
			const extRegex = new RegExp(`\\.${docType}$`, 'i');
			if (!extRegex.test(fileName)) {
				
				fileName += `.${docType}`;
			}
			
			downloadLink.download = fileName;
            
            
            switch(action) {
                case 'newTab':
                    
                    window.open(docUrl, '_blank');
                    break;
                    
                case 'mammoth':
                    
                    await handleMammothParse(docUrl, docTitle, docType);
                    break;
                    
                case 'officeView':
                    
                    handleOfficeView(docUrl);
                    break;
                    
                case 'officeViewmodal':
                    
                    handleOfficeViewModal(docUrl, docTitle);
                    break;
                    
                case 'officeEmbed':
                    
                    handleOfficeEmbed(docUrl, docTitle);
                    break;
                    
                case 'officeEmbednewTab':
                    
                    handleOfficeEmbedNewTab(docUrl);
                    break;
                    
                case 'download':
                    
                    link.click();
                    break;
                    
                case 'modal':
                default:
                    
                    if (docType === 'pdf') {
                        await handlePdfPreview(docUrl, docTitle);
                    } else {
                        
                        openModal();
                        
                        const iframe = document.createElement('iframe');
                        iframe.src = docUrl;
                        iframe.className = 'pdf-container';
                        iframe.title = docTitle;
                        previewContainer.appendChild(iframe);
                    }
                    break;
            }
        });
    });


    
    closeModalBtn.addEventListener('click', closeModal);
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });


    
    updateSearchUI();
});
</script>


    <footer class="article-footer">
    <section>
        页面浏览量<span id="busuanzi_value_page_pv">Loading</span>
    </section>
</footer>


    
</article>

<div class="post-password">
	
</div>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E7%BD%97%E6%B0%8Fe601-c082da15b5/">
        
        
            <div class="article-image">
                
                    <img src="/img/title.jpg" loading="lazy" data-key="罗氏E601 c082da15b5" data-hash="/img/title.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">罗氏E601</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/">
        
        
            <div class="article-image">
                <img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403125731-kgqb3bk.5157a0afd5413c0de413a1eb70a0a315_hu_4323a1d21f517d15.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 罗氏流水线IT3000"
                        data-key="罗氏流水线IT3000 4f6183cee7" 
                        data-hash="md5-UVegr9VBPA3kE6HrcKCjFQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">罗氏流水线IT3000</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%B8%9C%E8%8A%9Dtba-fx8-b8432f890a/">
        
        
            <div class="article-image">
                <img src="/p/%E4%B8%9C%E8%8A%9Dtba-fx8-b8432f890a/assets/87deac1ff37cce38e2e4f082839b3b41-20250821171124-ncnt2un.d17316f3a6574c24357d46e73c6629e0_hu_716f411378cd479d.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 东芝TBA-FX8"
                        data-key="东芝TBA-FX8 b8432f890a" 
                        data-hash="md5-0XMW86ZXTCQ1fUbnPGYp4A==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">东芝TBA-FX8</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%B8%87%E6%B3%B0wan200-da9f234969/">
        
        
            <div class="article-image">
                
                    <img src="/img/title.jpg" loading="lazy" data-key="万泰WAN200 da9f234969" data-hash="/img/title.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">万泰WAN200</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%B8%AD%E5%85%83%E5%B0%BF%E6%9C%BA1600-fe923b78ec/">
        
        
            <div class="article-image">
                
                    <img src="/img/title.jpg" loading="lazy" data-key="中元尿机1600 fe923b78ec" data-hash="/img/title.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">中元尿机1600</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"lang":"zh-CN","locale":{"admin":"Admin","placeholder":null},"requiredMeta":["name","email","url"],"serverURL":"https://waline.717170.xyz"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 muziyang
    </section>
    
    <section class="powerby">
        
            网站总访客数：<span id='busuanzi_value_site_uv'>Loading</span><br/>网站总访问量：<span id='busuanzi_value_site_pv'>Loading</span> <br/>
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.bb1eaf11044be5d45e9944395f8f492bb3f7541cae00b1624d206eac7546462c.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<style>
  
    
    
    
    
    
    
      
      
      
        
          
          
            @font-face {
              font-family: 'Jnbbh jnbbhbold fontFont Jnbbh jnbbhbold fontFont';
              src: url(https://work.717170.xyz/font/JNBBH/JNBBHBold.ttf) format('truetype');
              font-weight: 700;
              font-style: italic;
            }
          
        
      

      :root {
        
          
            --base-font-family: 'Jnbbh jnbbhbold fontFont Jnbbh jnbbhbold fontFont', sans-serif;
            --code-font-family: 'Jnbbh jnbbhbold fontFont Jnbbh jnbbhbold fontFont', monospace;
          
        
      }
    
  
  
  
</style>




  
  
    
    
    
    
    

    
    
      
      
      
        
      
    

    
    
      
    

    
      <style>
        body {
          background-image: url(https://work.717170.xyz/background/img/%E4%B8%AD%E5%9B%BD%E9%A3%8E%E6%B0%B4%E5%A2%A8%E5%B1%B1%E6%B0%B4%E9%A3%9E%E9%B8%9F%E8%83%8C%E6%99%AF.gif);
          background-repeat: no-repeat;
          background-position: center top;
          background-size: cover;
          
            background-attachment: fixed;
          
        }
      </style>
    
  

    
    
	



  
    
      <div id="particles-js"></div>
      <script src=https://work.717170.xyz/background/particles.min.js></script>
      <script>
        particlesJS.load('particles-js', "https://work.717170.xyz/background/particlesjs-config.json", function() {
          console.log('particles.js loaded - callback');
        });
      </script>
      <style>
        #particles-js {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: -1;
          pointer-events: none;
        }
        
        .main-content {
          position: relative;
          z-index: 1;
        }
      </style>
    
  


<script defer src="https://cn.vercount.one/js"></script>

    </body>
</html>

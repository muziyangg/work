<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="接口说明 仪器厂商 罗氏流水线\n仪器型号 IT3000\n通讯方式 主动上传\n仪器类型 生化发光流水线 医院名称 厦门翔安医院 程序名称 MI.MIFIT3000 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：监听文件 连接方式：抓取RESULT结果文件和SEEN处理文件 .hl7文件，上传ORDERS .hl7文件 仪器接口说明 罗氏流水线与lis交互分为处理文件 SEEN 和结果文件 RESULT 两种以及血清图片，处理文件过多，lis读取文件和解析文件同时进行，造成结果文件无法及时解析，造成仪器传了结果但是未及时读取造成无法及时发报告。针对这一问题，详细在问题处理中无法及时读取文件处理造成获取结果过慢记录。 接口中包含多种功能，包含血清图片，自动核收，报警信息存储等。详细在仪器个性功能中展示。 数据格式 修改记录 序号 日期 操作人 说明 1 2025-04-03 10:15:50\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848 849 850 851 852 853 854 855 856 857 858 859 860 861 862 863 864 865 866 867 868 869 870 871 872 873 874 875 876 877 878 879 880 881 882 883 884 885 886 887 888 889 890 891 892 893 894 895 896 897 898 899 900 901 902 903 904 905 906 907 908 909 910 911 912 913 914 915 916 917 918 919 920 921 922 923 924 925 926 927 928 929 930 931 932 933 934 935 936 937 938 939 940 941 942 943 944 945 946 947 948 949 950 951 952 953 954 955 956 957 958 959 960 961 962 963 964 965 966 967 968 969 970 971 972 973 974 975 976 977 978 979 980 981 982 983 984 985 986 987 988 989 990 991 992 993 994 995 996 997 998 999 1000 1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 1011 1012 1013 1014 1015 1016 1017 1018 1019 1020 1021 1022 1023 1024 1025 1026 1027 1028 1029 1030 1031 1032 1033 1034 1035 1036 1037 1038 1039 1040 1041 1042 1043 1044 1045 1046 1047 1048 1049 1050 1051 1052 1053 1054 1055 1056 1057 1058 1059 1060 1061 1062 1063 1064 1065 1066 1067 1068 1069 1070 1071 1072 1073 1074 1075 1076 1077 1078 1079 1080 1081 1082 1083 1084 1085 1086 1087 1088 1089 1090 1091 1092 1093 1094 1095 1096 1097 1098 1099 1100 1101 1102 1103 1104 1105 1106 1107 1108 1109 1110 1111 1112 1113 1114 1115 1116 1117 1118 1119 1120 1121 1122 1123 1124 1125 /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;Z:\\\\ResultExport\\\\&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFLICA800&#34;,&#34;Para&#34;:&#34;.csv&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UpPara&#34;:&#34;Z:\\\\Imports\\\\&#34;}] Class MI.MIFIT3000N1 Extends %RegisteredObject { /// D ##class(MI.MIFInfinity).fileMTHD(&#34;7&#34;,&#34;MSH|^~\\&amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#&#34;,&#34;&#34;) /// seen: [VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR] /// result: [VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR] /// D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;&#34;,&#34;&#34;) /// seen: D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]&#34;,&#34;&#34;) /// result:D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]&#34;,&#34;&#34;) /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\Results,E:\\\\Temp\\\\Temp\\\\Interface\\\\Seens&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFXAIT3000&#34;,&#34;Para&#34;:&#34;.hl7&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoMAll,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealImage,PreDeal&#34;,&#34;UpPara&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\ORDERS\\\\&#34;}] /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\Results,E:\\\\Temp\\\\Temp\\\\Interface\\\\Seens&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFXAIT3000&#34;,&#34;Para&#34;:&#34;.hl7&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoMAll,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UpPara&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\ORDERS\\\\&#34;}] /// D ##class(MI.MIFIT300N).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250317162926||ORU^R01^ORU_R01|20250317162926573175|P|2.5|||AL|ER[13][10]PID|1||0000486028||^郑龙怡||20000126|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^感染性疾病科[13][10]ORC|SC|1003777033|||CM||||20250317160618[13][10]OBR|1|1003777033|||||||||||||||||||||||F[13][10]OBX|1|NM|TRAB^TRAB||&lt;0.800|||LIMTL|||F|||20250317170643|E1^MU1-e801-1-2@5503[13][10]NTE|1||LIMTL[13][10]NTE|1||LIMTL[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250320102229||ORU^R01^ORU_R01|20250320102229442999|P|2.5|||AL|ER[13][10]PID|1||0000481255||^杨建利||19880623|M[13][10]PV1|1|U||||||||109|||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003782597|||CM||||20250320084145||||||||109[13][10]OBR|1|1003782597|||||||||||||||||||||||F[13][10]OBX|1|NM|GLU^GLU||8.830||||||F|||20250320100301|C2^MU1-c702-2-2@5607[13][10]OBX|2|NM|UREA^UREA||4.330||||||F|||20250320100306|C2^MU1-c702-2-1@5607[13][10]OBX|3|NM|UA^UA||434.900||||||F|||20250320100254|C2^MU1-c702-2-2@5607[13][10]OBX|4|NM|TP^TP||79.900||||||F|||20250320095858|C1^MU1-c702-1-1@5607[13][10]OBX|5|NM|ALB^ALB||46.000||||||F|||20250320095348|C1^MU1-c702-1-2@5607[13][10]OBX|6|NM|TBIL^TBIL||6.000||||||F|||20250320095923|C1^MU1-c702-1-1@5607[13][10]OBX|7|NM|DBIL^DBIL||1.800||||||F|||20250320095901|C1^MU1-c702-1-1@5607[13][10]OBX|8|NM|ALT^ALT||107.000||||||F|||20250320095900|C1^MU1-c702-1-2@5607[13][10]OBX|9|NM|AST^AST||62.300||||||F|||20250320095909|C1^MU1-c702-1-1@5607[13][10]OBX|10|NM|RGT^RGT||68.800||||||F|||20250320100259|C2^MU1-c702-2-1@5607[13][10]OBX|11|NM|ALP^ALP||83.700||||||F|||20250320095907|C1^MU1-c702-1-2@5607[13][10]OBX|12|NM|TRIGL^TRIGL||8.810||||||F|||20250320100304|C2^MU1-c702-2-2@5607[13][10]OBX|13|NM|TC^TC||4.910||||||F|||20250320100257|C2^MU1-c702-2-2@5607[13][10]OBX|14|NM|SCRE^SCRE||66.400||||||F|||20250320100313|C2^MU1-c702-2-1@5607[13][10]OBX|15|NM|9CYSC^CYSC_NEW||0.89||||||F|||20250320095916|C1^MU1-c702-1-1@5607[13][10]OBX|16|NM|9HDL^HDL_NEW||0.69||||||F|||20250320095914|C1^MU1-c702-1-2@5607[13][10]OBX|17|NM|9LDL^LDL_NEW||2.06||||||F|||20250320095921|C1^MU1-c702-1-2@5607[13][10]OBX|18|ST|XYZL^DM_SERQ||Z:脂血||||||F|||20250320083356[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250320151725||ORU^R01^ORU_R01|20250320151725880554|P|2.5|||AL|ER[13][10]PID|1||0000095425||^姚程成||19980712|M[13][10]PV1|1|U|||||||||||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003784045|||CM||||20250320104114[13][10]OBR|1|1003784045|||||||||||||||||||||||F[13][10]OBX|1|NM|TP^TP||73.600||||||F|||20250320115059|C1^MU1-c702-1-1@5095[13][10]OBX|2|NM|ALB^ALB||49.600||||||F|||20250320114553|C1^MU1-c702-1-2@5095[13][10]OBX|3|NM|TBIL^TBIL||16.400||||||F|||20250320115110|C1^MU1-c702-1-1@5095[13][10]OBX|4|NM|DBIL^DBIL||4.400||||||F|||20250320115056|C1^MU1-c702-1-1@5095[13][10]OBX|5|NM|ALT^ALT||18.100||||||F|||20250320115057|C1^MU1-c702-1-2@5095[13][10]OBX|6|NM|AST^AST||22.900||||||F|||20250320115103|C1^MU1-c702-1-1@5095[13][10]OBX|7|NM|RGT^RGT||8.900||||||F|||20250320115522|C2^MU1-c702-2-1@5095[13][10]OBX|8|NM|ALP^ALP||78.100||||||F|||20250320115105|C1^MU1-c702-1-2@5095[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250321083434||ACK^^ACK|20250321083434378641|P|2.5|||NE|NE[13][10]EQU||^^^c702^^SAMPLEEVENT^SEEN|20250321083434[13][10]SAC|||1003775669|1003775669||20250321083433|01||P|c702|5719@4[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250328191032||ORU^R01^ORU_R01|20250328191032737830|P|2.5|||AL|ER[13][10]PID|1||0000531818||^郑苹||19811117|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^心血管内科[13][10]ORC|SC|1003802907|||CM||||20250328191358[13][10]OBR|1|1003802907|||||||||||||||||||||||F[13][10]OBX|1|NM|U-CR^U-CR||5924.00||||||F|||20250328200846|C2^MU1-c702-2-1@4003|||||||||5924.00[13][10]OBX|2|NM|UR-MALB^UR-MALB||15.30|||OBS.RR|||F|||20250328200852|C2^MU1-c702-2-2@4003|||||||||15.30[13][10]NTE|1||OBS.RR[13][10]&#34;) /// 非流水线分区代码 Parameter FQCode = &#34;WANTAI,XINCHANYE,LINJIAN,XIEGUANG&#34;; ClassMethod fileMTHD(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),record=$g(record),epis=$g(epis),filename=$g(filename),P4=$g(P4),P5=$g(P5),P6=$g(P6),P7=$g(P7),P8=$g(P8),P9=$g(P9),P10=$g(P10),P11=$g(P11),P12=$g(P12),P13=$g(P13),Sessions=$g(Sessions) i filename[&#34;Results&#34; j ..ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) q &#34;&#34; e d ..ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) q &#34;&#34; } ClassMethod ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;0&#34; s HospitalDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),4) i &#39;$l(record) q &#34;0&#34; i filename[&#34;Seens&#34; d Trace^MI.MIF000(mi,record,&#34;SeensRecord&#34;) e i filename[&#34;Results&#34; d Trace^MI.MIF000(mi,record,&#34;ResultsRecord&#34;) e d Trace^MI.MIF000(mi,record,&#34;AllRecord&#34;) s recordbak=record\t//仪器数据备份 s commandName=&#34;&#34;\t//前处理名称初始化 s commandchild=&#34;&#34; //前处理命令初始化 s DealDateStr=&#34;&#34; //MSH 时间初始化 s (sample,result,date,time,QC)=&#34;&#34; //解析多行合并数据 f i=1:1:$l(recordbak,&#34;[13][10]&#34;){ s record=$p(recordbak,&#34;[13][10]&#34;,i) ;d Trace^MI.MIF000(mi,record,&#34;解析行数据&#34;) i &#39;$l(record) q s type=$p(record,&#34;|&#34;,1)\t//取出消息头命令类型 //解析MSH命令 i type=&#34;MSH&#34;{ s DateStr=$p(record,&#34;|&#34;,7)\t//取日期串 i $l(DateStr)=14 s DealDateStr=$e(DateStr,1,8)_&#34;,&#34;_(($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60))\t//解析保存日期串 } //解析EQU命令\t包含前处理后处理指令，根据指令记录对应事件 i type=&#34;EQU&#34;{ //前处理名称\tRSA1 流水线处理信息，e801、P501_701\t仪器处理信息 s commandName=$p($p(record,&#34;|&#34;,3),&#34;^&#34;,4) //获取前处理命令，SEEN 上机事件，RESULT 前处理分区事件，RSA1 未知事件，ARCHIVE 归档事件 s commandchild=$p($p(record,&#34;|&#34;,3),&#34;^&#34;,7) ;d Trace^MI.MIF000(mi,commandchild,&#34;前处理命令&#34;) } //解析SAC命令\t根据EQU命令重获取到的前处理事件，进行LIS相关处理 //本接口包括 SEEN 自动核收，ARCHIVE 记录归档位置 i type=&#34;SAC&#34;{ s epis=$p(record,&#34;|&#34;,5)\t//取出流水号 s machCode=$p(record,&#34;|&#34;,11)\t//取出前处理分区信息或仪器信息 s positioninfo=$p(record,&#34;|&#34;,12)\t//取出位置信息 //前处理SEEN 自动核收 i commandchild=&#34;SEEN&#34;{ ;d Trace^MI.MIF000(mi,&#34;分区信息，标本号:&#34;_epis_&#34;的样本所在分区:&#34;_machCode_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) i commandName=&#34;RSA1&#34; j ..SaveRecord(epis,&#34;分区位置:&#34;_machCode_&#34;-&#34;_positioninfo,mi,&#34;100&#34;)\t//前处理分区 e j ..SaveRecord(epis,&#34;上机位置:&#34;_commandName_&#34;-&#34;_positioninfo,mi,&#34;6&#34;)\t//上机 try{d ..ZDHS(mi,epis,machCode,positioninfo)}catch ex{d Trace^MI.MIF000(mi,ex.Data,&#34;自动核收提示&#34;)}\t//自动核收 i commandName=&#34;RSA1&#34; d .i (&#34;,&#34;_..#FQCode_&#34;,&#34;)&#39;[(&#34;,&#34;_machCode_&#34;,&#34;) d\t//$TS$ 只有流水线仪器记录分区架子号 ..j ..SaveRackNo(epis,machCode_&#34;-&#34;_positioninfo,mi,&#34;分区&#34;) e j ..SaveRackNo(epis,commandName_&#34;-&#34;_positioninfo,mi,&#34;上机&#34;) } //前处理RESULT 处理分区信息 i commandchild=&#34;RESULT&#34;{ s curMachName=machCode\t//通过仪器对照码取仪器 //此处存标本全部分区预处理的位置号\t针对非流水线标本分拣 i commandName=&#34;RSA1&#34; j ..SaveRecord(epis,&#34;分区位置:&#34;_positioninfo,mi,&#34;100&#34;)\t//前处理分区 i commandName=&#34;RSA1&#34; j ..SaveRackNo(epis,positioninfo,mi,&#34;分区&#34;) } //前处理ARCHIVE 处理归档信息 i commandchild=&#34;ARCHIVE&#34;{ s curMachName=machCode\t//通过仪器对照码取仪器 //此处存标本全部审核报告的位置号 ;d Trace^MI.MIF000(mi,&#34;归档信息，标本号:&#34;_epis_&#34;的样本所在仪器:&#34;_curMachName_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) ;d Trace^MI.MIF000(mi,epis_&#34;执行记录分类信息:&#34;_positioninfo,&#34;H&lt;--M&#34;) i commandName=&#34;RSA1&#34; d .j ..SaveRackNo(epis,positioninfo,mi,&#34;归档&#34;)\t//保存归档信息到架子号 .j ..SaveRecord(epis,&#34;冰箱归档位置:&#34;_positioninfo,mi,&#34;62&#34;)\t//冰箱归档 e d .j ..SaveRackNo(epis,positioninfo,mi,&#34;归档中&#34;)\t//保存归档信息到架子号 .j ..SaveRecord(epis,&#34;归档中位置:&#34;_positioninfo,mi,&#34;62&#34;)\t//归档 ;d Trace^MI.MIF000(mi,epis_&#34;记录归档信息完成&#34;,&#34;H&lt;--M&#34;) } } //解析质控数据,P业务数据，Q质控数据 i type=&#34;ORC&#34;{ s epis=$p(record,&#34;|&#34;,3) } i type=&#34;OBR&#34;{ s epis=$p(record,&#34;|&#34;,3) } //仪器报警信息 i type=&#34;NTE&#34;{ s WaringStr=$p(record,&#34;|&#34;,4) s WaringCode=$p(WaringStr,&#34; &#34;,2) ;d Trace^MI.MIF000(mi,&#34;仪器报警信息:&#34;_WaringStr,&#34;H&lt;--M&#34;) //保存仪器报警信息到组内报告评价 ;d ..SaveResultWarned(epis,WaringStr,mi) } try{j ##class(MI.Special.Record).RecordData(epis,recordbak,&#34;LSLSXGET&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 i type=&#34;OBX&#34;{ s machCode=$p(record,&#34;|&#34;,16)\t//仪器信息和架子号信息 s code=$p($p(record,&#34;|&#34;,4),&#34;^&#34;,1) s res=$p(record,&#34;|&#34;,6) s CallThePolice=$p(record,&#34;|&#34;,9)\t//项目报警信息 s res=..ConvertResult(code,res)\t//结果特殊转换 i $l(CallThePolice) d .s result=result_code_$c(92)_res_$c(92)_$c(92)_CallThePolice_$c(44)\t//YHR 20250328 将报警信息存入到其他结果字段 .try{j ..SaveResultWarned(epis,&#34;存在仪器报警信息&#34;,mi,&#34;41&#34;)}catch{}\t//YHR 20250329 存储报警信息标志，此处41为常规生化工作小组$TS$ e s result=result_code_$c(92)_res_$c(44) } } i $l(result) d Trace^MI.MIF000(mi,epis_&#34;$$&#34;_result,&#34;H&lt;--M&#34;) //统一保存结果 i $l(epis),$l(result){ i $l(DealDateStr){\t//如果记录到时间，则根据仪器时间存储结果。 s date=$p(DealDateStr,&#34;,&#34;,1) s time=$p(DealDateStr,&#34;,&#34;,2) i $l(date)&#39;=8 s date=&#34;&#34;,time=&#34;&#34; } d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) } q &#34;&#34; } /// 结果特殊转换 /// $TS$ /// W ##CLASS(MI.MIFIT3000N1).ConvertResult(&#34;9PA&#34;,&#34;&lt;0.070&#34;) ClassMethod ConvertResult(code, res) { i code=&#34;9PA&#34; d .i $e(res)=&#34;&lt;&#34;,+$e(res,2,*)=&#34;.07&#34; d ..s res=&#34;&lt;70&#34; q res } /// 报警信息转换 ClassMethod ConvertPoliceInfo(WaringCode) { s WaringStr=&#34;&#34; i WaringCode=&#34;5&#34; s WaringStr=&#34;&gt;ABS(超出ABS)&#34; i WaringCode=&#34;43&#34; s WaringStr=&#34;Cal.E(校准结果异常)&#34; i WaringCode=&#34;2&#34; s WaringStr=&#34;&gt;Cuvet(反应杯空白异常)&#34; i WaringCode=&#34;42&#34; s WaringStr=&#34;Edit(实验结果已被编辑)&#34; i WaringCode=&#34;23&#34; s WaringStr=&#34;&gt;ISE(超出ISE范围)&#34; i WaringCode=&#34;19&#34; s WaringStr=&#34;ISE.E(ISE电压级错误)&#34; i WaringCode=&#34;56&#34; s WaringStr=&#34;&gt;Kin(Prozone错误2/运动不稳)&#34; i WaringCode=&#34;10&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; i WaringCode=&#34;11&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; i WaringCode=&#34;6&#34; s WaringStr=&#34;&gt;Prozone(Prozone错误1)&#34; i WaringCode=&#34;4&#34; s WaringStr=&#34;Reag.S(试剂不足)&#34; i WaringCode=&#34;44&#34; s WaringStr=&#34;&gt;Rept(高出原倍复查范围)&#34; i WaringCode=&#34;45&#34; s WaringStr=&#34;&lt;Rept(低于原倍复查范围)&#34; i WaringCode=&#34;46&#34; s WaringStr=&#34;Samp.？(高出ABS最大值)&#34; i WaringCode=&#34;68&#34; s WaringStr=&#34;Samp.B(样本中有气泡)&#34; i WaringCode=&#34;72&#34; s WaringStr=&#34;Samp.C(样本中有凝块)&#34; i WaringCode=&#34;26&#34; s WaringStr=&#34;&gt;Test(高出线性范围)&#34; i WaringCode=&#34;27&#34; s WaringStr=&#34;&lt;Test(低于线性范围)&#34; q WaringStr } /// 记录标本日志 /// D ##class(MI.MIFRS600).SaveRecord(&#34;&#34;,&#34;&#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode, curWorkGroupMachineDR) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s OperateTypeCode=$g(OperateTypeCode) i &#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,&#34;,&#34;,2),&#34;&#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,&#34;&#34;) } /// 保存报告表报警信息标志 /// D ##class(MI.MIFIT3000N1).SaveResultWarned(&#34;1003803130&#34;,&#34;1&#34;,&#34;34&#34;,&#34;41&#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI, curWorkGroupMachineDR) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) i &#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) i $l(conclusion)&gt;20 s conclusion=$e(conclusion,1,20)_&#34;...&#34; s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } /// 保存评价信息(标本质量) /// D ##class(MI.MIFRS600).SaveConclusion(&#34;&#34;,&#34;&#34;) ClassMethod SaveConclusion(labno, conclusion, predealMI, curWorkGroupMachineDR, IsPrint) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s IsPrint=$g(IsPrint) i IsPrint&#39;=1 s IsPrint=&#34;0&#34;\t//1 打印主评价，0 不打印次评价 i &#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i IsPrint=1 d ......i $l(objrep.MajorConclusion) s objrep.MajorConclusion=objrep.MajorConclusion_&#34;,&#34;_conclusion ......e s objrep.MajorConclusion=conclusion ......e d ......i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_&#34;,&#34;_conclusion ......e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i IsPrint=1 d ..s objrep.MajorConclusion=conclusion .e s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } /// 保存归档,分类信息,架子号,新增保存类型和参数工作小组ID，针对仪器不在对应的工作小组也可以保存架子号。 /// D ##class(MI.Special.Common).SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) /// D ##class(MI.Special.Common).SaveRackNo(&#34;1003775669&#34;,&#34;c702-5719@4&#34;,&#34;34&#34;,&#34;上机&#34;) ClassMethod SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) { s labno=$g(labno) s positioninfo=$g(positioninfo) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),typename=$g(typename) i &#39;$L(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $l(typename) s positioninfo=typename_&#34;:&#34;_positioninfo s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo) j ..SaveRecord(labno,&#34;架子号位置更新:&#34;_objrep.RackNo_&#34;--&gt;&#34;_positioninfo,mi,&#34;101&#34;)\t//架子号更新 .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,&#34;-1^存&#34;_typename_&#34;信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i $l(objrep.RackNo) j ..SaveRecord(labno,&#34;架子号位置更新:&#34;_objrep.RackNo_&#34;--&gt;&#34;_positioninfo,mi,&#34;101&#34;)\t//架子号更新 .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q hasFindRep } /// 保存标本图片 /// D ##class(MI.MIFRS600).SaveImageMTHD(&#34;57&#34;,&#34;1000100990&#34;,&#34;P&#34;,&#34;/iLISLIS080/demo.png&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) /// D ##class(MI.MIFIT3000N1).SaveImageMTHD(&#34;34&#34;,&#34;1003783657_01&#34;,&#34;1003783657_01&#34;,&#34;/iLISLIS032/20250321/1003783657_01.jpg&#34;,&#34;C:\\LISDATA\\DATA\\1003783657_01.jpg&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s ^YHR(&#34;MI.MIFIT3000&#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=&#34;1&#34; s epis=$p(epis,&#34;_&#34;,1) s ImageClass=&#34;P&#34;_+$p(ImageClass,&#34;_&#34;,2) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=&#34;&#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis),&#34;&#34;)) .i $d(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=&#34;&#34; f s RowID=$o(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=&#34;&#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i &#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=&#34;SerumQ&#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (&#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= &#34;-1^保存报告图片失败:&#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_&#34;:&#34;_ImageClass_&#34;:&#34;_FileName,&#34;H&lt;--M&#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=&#34;&#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // w ##class(MI.MIFRS600).GetFtpMTHD(&#34;24&#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = &#34;labno,labnoInfo,patInfo&#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(&#34;MI.MIFIT3000N1&#34;,&#34;QryLabInfo&#34;,&#34;34&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; s LabnoList=&#34;&#34; s VisitNumberDR=&#34;&#34; s OutPutNum=0 //*--------------------------------&gt;*申请项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:(AddDate=&#34;&#34;)||(OutPutNum&gt;6) d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:(AddTime=&#34;&#34;)||(OutPutNum&gt;6) d ..s OutPutNum=OutPutNum+1 ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..i &#39;$d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno)) q ..s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..s ReceiveTime=$lg($g(^dbo.RPVisitNumberD(VisitNumberDR)),67) ..i ((+$p($h,&#34;,&#34;,2))-ReceiveTime&gt;=-2)&amp;&amp;((+$p($h,&#34;,&#34;,2))-ReceiveTime&lt;5) d Trace^MI.MIF000(mi,labno_&#34;标本接收时间低于5秒不上传&#34;,&#34;等待上传&#34;) q ..//得到通道号 ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@C&#34;\t//重新获取通道号 避免因为接收造成漏项目 ..;s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..;s labnoInfo=labno_&#34;,&#34;_$replace(TCList,&#34;\\&#34;,&#34;+&#34;)_&#34;|@U&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;申请上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;C@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** //*--------------------------------&gt;*复查结果上传 s AddDate=$zd($p($h,&#34;,&#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i &#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..s labnoInfo=labno_&#34;,&#34;_$replace(TCList,&#34;\\&#34;,&#34;+&#34;)_&#34;|@U&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;复查上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;U@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** //*--------------------------------&gt;*取消项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i &#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@R&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;取消上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;R@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i &#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=labno_&#34;,&#34;_&#34;DM_OVER&#34;_&#34;@C&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;审核上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;T@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=&#34;labno,labnoInfo,patInfo&#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=&#34;&#34; { Set AtEnd=1 Set Row=&#34;&#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 获取申请名称和内容 /// 申请名称： /// 发送申请：order_2012051718302501_9999999901NW.HL7 /// 取消申请：order_2012051718302501_9999999901CA.HL7 /// 项目复查：order_2012051718302501_9999999901XO.HL7 /// w ##class(MI.MIFRS600).GetLisOrderMTHD(&#34;8&#34;,&#34;POS@C@1&#34;,&#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08 -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34; ,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) /// w ##class(MI.MIFIT300N).GetLabnoInfoN(&#34;34&#34;,&#34;1003779663,DM_OVER@C&#34;,&#34;2025-03-18□19:07:07,IT3000,,,,急诊内科,测试医生(勿选）,检验管理员,0000243381,陈耀明,1,急诊,,34,,1003779663,2025-03-18□18:24,,,,,眩晕,,,,2025-03-18□18:24,,,19900920&#34;) ClassMethod GetLabnoInfoN(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s VT=&#34;[11]&#34;,FS=&#34;[28]&#34;,CR=&#34;[13]&#34; s labNo=$p(patInfo,&#34;,&#34;,16) s Sampleno=$p(patInfo,&#34;,&#34;,3) //i labNo=&#34;74623177&#34; s ^TMP(&#34;zlzit3000d&#34;)=$lb(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s location=$p(patInfo,&#34;,&#34;,6) s docName=$p(patInfo,&#34;,&#34;,7) s regNo=$p(patInfo,&#34;,&#34;,9) s patName=$p(patInfo,&#34;,&#34;,10) s sex=$p(patInfo,&#34;,&#34;,11) i sex=&#34;1&#34; s sex=&#34;M&#34; i sex=&#34;2&#34; s sex=&#34;F&#34; i (sex&#39;=&#34;M&#34;)&amp;&amp;(sex&#39;=&#34;F&#34;) s sex=&#34;U&#34; s birthDate=$p(patInfo,&#34;,&#34;,29) s collectTime=$p(patInfo,&#34;,&#34;,17) ;2017-08-14 11:57 s collectTime=$tr(collectTime,&#34;- :&#34;,&#34;&#34;)_&#34;00&#34; s status=$p(labnoInfo,&#34;@&#34;,2) s labnoInfo=$p(labnoInfo,&#34;@&#34;,1) s curTime=$zd($h,8)_$tr($zt($p($h,&#34;,&#34;,2)),&#34;:&#34;,&#34;&#34;) s PatType=$p(patInfo,&#34;,&#34;,12) s Wardno=$p(patInfo,&#34;,&#34;,27) s Diagnose=$p(patInfo,&#34;,&#34;,22) S patTypeFlag=&#34;RO&#34; //门诊=RO,住院=RI,体检=RC,急诊=RS I PatType=&#34;住院&#34; { S patTypeFlag=&#34;RI&#34; } I PatType=&#34;门诊&#34; { S patTypeFlag=&#34;RO&#34; } I PatType=&#34;急诊&#34; { S patTypeFlag=&#34;RS&#34; } I PatType=&#34;体检&#34; { S patTypeFlag=&#34;RC&#34; } I PatType=&#34;干诊&#34; { S patTypeFlag=&#34;RC&#34; } s AssayNo=..GetReportAssayNoMTHD(mi,labNo) s MSN=&#34;MSH|^~\\&amp;|DHC-LIS|IT3000|||||OML^O21|&#34;_$tr($zdt($h,3),&#34; &#34;&#34;:&#34;&#34;-&#34;)_&#34;SND&#34;_labNo_&#34;|P|2.3|||NE|NE||&#34; s PID=&#34;PID|1||&#34;_regNo_&#34;|&#34;_docName_&#34;|^&#34;_patName_&#34;||&#34;_birthDate_&#34;|&#34;_sex //_location s PV1=&#34;PV1|||?|||||||||||||||||&#34; s DG1=&#34;DG1|||00000^default|||F&#34; ;s IN1=&#34;IN1|||China-Bank&#34; ;s ORC=&#34;ORC|NW|&#34;_labNo_&#34;|&#34;_regNo_&#34;||||R||&#34;_$zd($h,8)_$tr($zt($h),&#34;:&#34;,&#34;&#34;)_&#34;|&#34;_docName s orcF1=&#34;NW&#34;,orcF2=&#34;&#34; i status=&#34;R&#34; s orcF1=&#34;CA&#34; i status=&#34;U&#34; s orcF1=&#34;XO&#34; s orcF2=&#34;SC&#34; s ORC=&#34;ORC|&#34;_orcF1_&#34;|&#34;_labNo_&#34;|&#34;_AssayNo_&#34;||&#34;_orcF2_&#34;||&#34;_patTypeFlag_&#34;|&#34;_location_&#34;|&#34;_..GetReceiveDateTime(labNo) //change by sch20210421 //s:orcF1&#39;=&#34;XO&#34; ORC=&#34;ORC|&#34;_orcF1_&#34;|&#34;_labNo_&#34;|&#34;_AssayNo_&#34;||&#34;_orcF2_&#34;||&#34;_patFLAG_&#34;||&#34;_$tr($zdt($h,3),&#34; &#34;&#34;:&#34;&#34;-&#34;) //_&#34;|&#34;_docName //&#34;_regNo_&#34; ;s NTE=&#34; NTE||I|Code: C1 Comment: Sample comment 1|&#34; s obrF1=&#34;A&#34; i status=&#34;U&#34; s obrF1=&#34;G&#34; //OBR||2012081501||ROCHE_AFP|||20120814160023|||9999|A s OBR=&#34;OBR||&#34;_labNo_&#34;||GLU|||||||&#34;_obrF1 //&#34;_collectTime_&#34; ;s OBX=&#34;OBX|2|ST|AHBS^6012^||45.290^Instrument flag!|mol/L| - ^^||5221^1||F|||20170816152751|356^COBAS8000B:E602C2|DATOS_PRJ^16-8月 -17^^|&#34; s OBRs=&#34;&#34; i $p(labnoInfo,&#34;@&#34;,1)=&#34;POS&#34; d .s OBRs=&#34;OBR||&#34;_labNo_&#34;||POS|||&#34;_collectTime_&#34;||||&#34;_obrF1 e d .d GetOBRs //s orderTxt=VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS s orderTxt=VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS q orderTxt GetOBRs s items=$tr($p(labnoInfo,&#34;,&#34;,2),&#34;|&#34;,&#34;&#34;) f i=1:1:$l(items,&#34;+&#34;) d .s item=$p(items,&#34;+&#34;,i) .s splitStr=$p(OBR,&#34;|&#34;,5) .s curOBR=$p(OBR,splitStr,1)_item_$p(OBR,splitStr,2) .s OBRs=OBRs_curOBR_CR q } // w ##Class(MI.MIFIT3000).GetReportAssayNoMTHD(8,&#34;1905074122&#34;) ClassMethod GetReportAssayNoMTHD(mi, labno, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { S mi= $G(mi) S labno= $G(labno) i &#39;$l(labno) q &#34;&#34; i &#39;$l(mi) q &#34;&#34; s (orderno,VisitNumberDR)=&#34;&#34; s labno=&#34;&#34;_labno s WGMDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i &#39;$l(WGMDR) q &#34;&#34; S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) s orderno=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WGMDR,&#34;&#34;)) i &#39;$l(orderno) q &#34;&#34; s reportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WGMDR,orderno,&#34;&#34;)) s AssayNo =$lg($g(^dbo.RPVisitNumberReportD(reportDR)),8) Q AssayNo } /// W ##class(MI.MIFIT300N).GetReceiveDateTime(&#34;1003775372&#34;) ClassMethod GetReceiveDateTime(Labnum) { q:&#39;$l(Labnum) &#34;&#34; s VisitnumberDR=&#34;&#34;,ReceiveDate=&#34;&#34;,ReceiveTime=&#34;&#34;,ReceiveDateTime=&#34;&#34; s VisitnumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,&#34;&#34;_Labnum,&#34;&#34;)) s:$l(VisitnumberDR) ReceiveDate=$lg(^dbo.RPVisitNumberD(VisitnumberDR),66) s:$l(VisitnumberDR) ReceiveTime=$lg(^dbo.RPVisitNumberD(VisitnumberDR),67) s:$l(ReceiveDate)&amp;$l(ReceiveTime) ReceiveDateTime=ReceiveDate_$tr($zt(ReceiveTime),&#34;:&#34;) q ReceiveDateTime } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) /// w ##Class(MI.MIFIT3000N1).GetLabnoInfo(34,&#34;8000001003&#34;) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=&#34;&#34; s chl=&#34;&#34; f s chl=$o(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) q:chl=&#34;&#34; d .s tcx=tcx_chl_&#34;+&#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) i $l(tcx) s tcx=labno_&#34;,&#34;_tcx_&#34;|&#34; d Trace^MI.MIF000(mi,tcx,&#34;H--&gt;M&#34;) d Trace^MI.MIF000(56,&#34;共&#34;_$l(tcx,&#34;+&#34;)_&#34;个项目。&#34;_tcx,&#34;H--&gt;M&#34;) //YHR 20230816 将上传信息存入罗氏infinity仪器 q tcx } /// w ##Class(MI.MIFRS600).GetPatInfo(57,9000001912) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q &#34;&#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) i &#39;$l(VisitNumberDR) q &#34;&#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=&#34;&#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=&#34;&#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=&#34;&#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=&#34;&#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=&#34;&#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=&#34;&#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,&#34;,&#34;,1),3)_&#34; &#34;_$zt($p($h,&#34;,&#34;,2)) s Instrument = &#34;XN&#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) i $l(Instrument) s Instrument=$tr(Instrument,&#34;,&#34;,&#34;^&#34;) s Sampleno=$lg(RPVisitNumberData,6) //病案号 s Sampletype=&#34;&#34; s Feetype=&#34;&#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 &#34;&#34; s BarCode=&#34;&#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=&#34;男&#34; s Sex=&#34;1&#34; ;1:男 ，2 女 i Species =&#34;女&#34; s Sex=&#34;2&#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=&#34;&#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=&#34;&#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_&#34;-&#34;_$e(ReceiveDate,5,6)_&#34;-&#34;_$e(ReceiveDate,7,8)_&#34; &#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=&#34;&#34; ;报告日期 = 初审(保存结果)时间 s Printflag=&#34;&#34; ;打印标志 s Resultflag=&#34;&#34; ;结果标志 s Errflag=&#34;&#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=&#34;&#34; ;备注 s Reserve=&#34;&#34; ;保留字段 s Patnamn=&#34;&#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_&#34;-&#34;_$e(CollectDate,5,6)_&#34;-&#34;_$e(CollectDate,7,8)_&#34; &#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=&#34;&#34; s WardnoDR=$lg(RPVisitNumberData,26) ;病区 i $l(WardnoDR) s Wardno=$lg($g(^dbo.BTWardD(WardnoDR)),3) s RetString=&#34;&#34; s RetString=$tr(Sampleda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Instrument,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampleno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampletype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Feetype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdepno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdocno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Userno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patna,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sex,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Pattype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Bedno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patage,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Ageunit,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Reportda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Printflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Resultflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Errflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Diagnose,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Description,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reserve,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patnamn,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Getda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Wardno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BarCode,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BirthDate,&#34;,&#34;,&#34;&#34;) q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename) q } /********************************************自动核收开始****************************************************/ /// 仪器主键，条码号，前处理标本分区标识，仪器信息(位置) /// w ##class(MI.MIFIT3000N1).ZDHS(&#34;34&#34;,&#34;8000000352&#34;,&#34;WANTAI&#34;) /// w ##class(MI.MIFIT300N).ZDHS(&#34;34&#34;,&#34;1003779663&#34;,&#34;RSA1&#34;) ClassMethod ZDHS(mi, Labno, MachineCode, positioninfo) { s mi=$g(mi),Labno=$g(Labno),machCode=$g(MachineCode),positioninfo=$g(positioninfo) i &#39;$l(Labno) q &#34;&#34; /*----------&gt;判断该标本是否已接收未核收 开始&lt;----------*/ s QuitFlag=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##class(LIS.Util.Common).IndexData(Labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##class(LIS.Util.Common).IndexData(Labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) s QuitFlag=1 i QuitFlag=1 q &#34;&#34; /*----------&gt;判断该标本是否已接收未核收 结束&lt;----------*/ s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)\t//得到当前仪器关联工作小组信息 s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13)\t//得到仪器工作小组的核收类型 //AcceptFlag为1认为是前处理工作小组，如果是前处理小组，就认为上前处理\t本接口未设置前处理工作小组，未对此流程进行测试 i AcceptFlag=&#34;1&#34; d QCLZDHS e d ZDHS q &#34;&#34; ZDHS d Trace^MI.MIF000(mi,&#34;上仪器,标本号:&#34;_Labno_&#34;的标本在:&#34;_curMachName_&#34;,分区位置:&#34;_MachineCode_&#34;,样本所在:&#34;_positioninfo,&#34;自动核收&#34;) //根据前处理标本分区进行分区自动核收，并且根据分区代码是否核收进行区分 //本接口认为 默认认为罗氏流水线核收，如果分区代码中包含 【BHS】则认为标本不核收，此块代码将仪器传过来的分区代码进行归类 //本接口关联标本分区， WANTAI 万泰--&gt;W，XINCHANYE 新产业--&gt;X，LINJIAN 临检凝血--&gt;L，XIEGUANG 携光--&gt;R，罗氏--&gt;Y，不核收--&gt;N s HsFlag=&#34;Y&#34;,WorkGroupMachineDR=&#34;&#34; i (MachineCode[&#34;WANTAI&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;WANTAI&#34;,&#34;&#34;) .s HsFlag=&#34;W&#34; .s WorkGroupMachineDR=48\t//未核收且分区是WANTAI i (MachineCode[&#34;XINCHANYE&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;XINCHANYE&#34;,&#34;&#34;) .s HsFlag=&#34;X&#34; .s WorkGroupMachineDR=50\t//未核收且分区是XINCHANYE i (MachineCode[&#34;LINJIAN&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;LINJIAN&#34;,&#34;&#34;) .s HsFlag=&#34;L&#34; .s WorkGroupMachineDR=9\t//未核收且分区是LINJIAN i (MachineCode[&#34;XIEGUANG&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;XIEGUANG&#34;,&#34;&#34;) .s HsFlag=&#34;R&#34; .s WorkGroupMachineDR=67\t//未核收且分区是XIEGUANG i (MachineCode[&#34;BHS_&#34;) d\t;BHS_WANTAI .S MachineCode=$REPLACE(MachineCode,&#34;BHS_&#34;,&#34;&#34;) .s HsFlag=&#34;N&#34; i MachineCode=&#34;C_C8K886&#34; s MachineCode=&#34;C801&#34; i MachineCode=&#34;C_C8K77&#34; s MachineCode=&#34;C701&#34; i MachineCode=&#34;C8K886&#34; s MachineCode=&#34;C801&#34; i MachineCode=&#34;C8K77&#34; s MachineCode=&#34;C701&#34; i HsFlag=&#34;Y&#34; d .s WorkGroupMachineDR=41\t//未核收且分区不包含BHS_\t默认核收到罗氏流水线 i &#39;$l(WorkGroupMachineDR) q s ret=..ReceiveLabNoByWGM(WorkGroupMachineDR,Labno,$zd(+$h,8)) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) i ret&#39;=&#34;1&#34; d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = &#34;WG-&#34;_WorkGroupDR\t//自动核收出错显示再对应的工作组 .s SendRet=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收失败&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_Labno_&#34;前处理核收失败:&#34;_ret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) j ..SaveRecord(Labno,&#34;自动核收:&#34;_ret,&#34;&#34;,&#34;14&#34;,WorkGroupMachineDR) q ret QCLZDHS d Trace^MI.MIF000(mi,&#34;上前处理，鉴定号:&#34;_Labno_&#34;的标本在:&#34;_curMachName_&#34;,样本所在:&#34;_positioninfo,&#34;DealInfo&#34;) d Trace^MI.MIF000(mi,&#34;执行核收到前处理&#34;,&#34;DealInfo&#34;) //此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,Labno,&#34;&#34;) d Trace^MI.MIF000(mi,Labno_&#34;核收到前处理返回信息:&#34;_dealret,&#34;DealInfo&#34;) //记录位置信息到报告位置号 d ..SaveRackNo(Labno,positioninfo,mi) i dealret[&#34;标本已核收&#34; q i dealret=&#34;1&#34; d .//写标本操作日志 .d ..SaveRecord(Labno,machCode,mi,&#34;5&#34;) e d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = &#34;WG-&#34;_CurWorkGroupDR .s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收失败&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_Labno_&#34;前处理核收失败:&#34;_dealret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) .//写标本操作日志 .d ..SaveRecord(Labno,dealret,mi,&#34;100&#34;) q } /// Others w ##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(&#34;3&#34;,&#34;1000004476&#34;,&#34;20191105&#34;) /// 按工作小组核收医嘱 /// INPUT: MachID:仪器主键，LabNo：条码号，TransmitDate：上机日期（不传默认当天） /// OutPut: RetValue:1成功 ClassMethod ReceiveLabNoByWGM(WorkGroupMachineDR As %String, LabNo As %String, TransmitDate, RackNo, RuleCode) As %String { s WorkGroupMachineDR=$g(WorkGroupMachineDR) s LabNo=$g(LabNo) s TransmitDate=$g(TransmitDate) s RuleCode=$g(RuleCode) s RackNo=$g(RackNo) s NowDate=$zd($h,8) s RetValue=1 i &#39;$l(TransmitDate) s TransmitDate=NowDate i &#39;$l(WorkGroupMachineDR) q 100 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s WorkGroupMachineName=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) s DepartmentDR=$lg(^dbo.BTWorkGroupD(WorkGroupDR),4) s HospitalDR=$lg(^dbo.BTDepartmentD(DepartmentDR),4) s WorkGroupMachineDesc=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s IndexOperateType=##class(LIS.Util.Common).IndexData(&#34;H&#34;) s AutoDR=$O(^dbo.RPWGMachineAutoI(&#34;IndexOperateType&#34;,IndexOperateType,WorkGroupMachineDR,&#34;&#34;)) i &#39;$l(AutoDR) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未设置自动核收&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未设置自动核收！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未设置自动核收！&#34; } s MachineAutoData=$g(^dbo.RPWGMachineAutoD(AutoDR)) s IsOpen=$LG(MachineAutoData,4) i IsOpen&#39;=1 { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未开启自动核收&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未开启自动核收！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未开启自动核收！&#34; } s CurrentDate = $p($h,&#34;,&#34;,1) s Currenttime = $p($h,&#34;,&#34;,2) //开始时间 s StartDate=$lg(MachineAutoData,5) i $l(StartDate) s StartDate= $zdh(StartDate,8) s StartTime=$lg(MachineAutoData,6) //结束时间 s EndDate=$lg(MachineAutoData,7) i $l(EndDate) s EndDate= $zdh(EndDate,8) s EndTime=$lg(MachineAutoData,8) //时间类型 s TimeType=$lg(MachineAutoData,9) i TimeType=&#34;CT&#34; //连续 { i (CurrentDate&lt;StartDate)||(($l(StartTime))&amp;&amp;(CurrentDate=StartDate)&amp;&amp;(Currenttime&lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期未生效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期未生效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期未生效！&#34; } i (CurrentDate&gt;EndDate)||(($l(EndTime))&amp;&amp;(CurrentDate=EndDate)&amp;&amp;(Currenttime&gt;EndTime) ) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期已失效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期已失效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期已失效！&#34; } } i TimeType=&#34;TS&#34; //时间段 { i (CurrentDate&lt;StartDate)||(($l(StartTime))&amp;&amp;(Currenttime&lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期未生效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期未生效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期未生效！&#34; } i (CurrentDate&gt;EndDate)||(($l(EndTime))&amp;&amp;(Currenttime&gt;EndTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期已失效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期已失效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期已失效！&#34; } } s AcceptUserDR=&#34;&#34; i $l(AutoDR) s AcceptUserDR=$LG($g(^dbo.RPWGMachineAutoD(AutoDR)),10) i &#39;$l(AcceptUserDR) d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = &#34;WG-&#34;_WorkGroupDR .s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未设置负责人&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未设置核收负责人！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) i &#39;$l(AcceptUserDR) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未设置核收负责人！&#34; s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///判断医嘱是否核收 S AcceptFlag=0 s IsSpecialFlag=0 s CheckItemList=&#34;&#34; s PreReportDR=&#34;&#34; k TestSetList s LabNoType=##Class(LISSP.DHCRPVisitNumber).GetLabNoType(LabNo) s WebNamespace=##Class(OTH.SYSParameter).GetWebNamespace() i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo))){ s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo),&#34;&#34;)) S TestSetDR=&#34;&#34; f { s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR)) q:TestSetDR=&#34;&#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR,&#34;&#34;)) i $l(RowID){ s TestSetGroup=&#34;Default&#34; //工作小组下分组类型 s WGMDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),5) i &#39;$l(WGMDR) s CheckItemList=TestSetDR_CheckItemList S AccpetReportDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11) I $L(AccpetReportDR) s AccpetWGMDR=$LG($G(^dbo.RPVisitNumberReportD(AccpetReportDR)),4) I $LG($g(^dbo.BTWorkGroupMachineD(AccpetWGMDR)),13)&#39;=1 continue s AcceptFlag=0 I $L(WGMDR) S AcceptFlag=$LG($g(^dbo.BTWorkGroupMachineD(WGMDR)),13) //是否是前处理小组 I AcceptFlag=1 S PreReportDR= $LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11),IsSpecialFlag=1 I AcceptFlag=1,$D(^dbo.BTTestSetWorkGroupMachineI(&#34;IndexMaster&#34;,TestSetDR,WorkGroupMachineDR)) { //处理报告分组信息 i $d(^dbo.BTWorkGroupMachineRuleTSI(&#34;IndexTestSet&#34;,TestSetDR)) { s WorkGroupMachineRuleDR=&#34;&#34; f{ s WorkGroupMachineRuleDR=$o(^dbo.BTWorkGroupMachineRuleTSI(&#34;IndexTestSet&#34;,TestSetDR,WorkGroupMachineRuleDR)) q:WorkGroupMachineRuleDR=&#34;&#34; s GroupWGMDR=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),4) s IsShow=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),5) i WorkGroupMachineDR&#39;=GroupWGMDR continue i IsShow=&#34;1&#34; continue s TestSetGroup=WorkGroupMachineRuleDR } } s TestSetList(TestSetGroup,TestSetDR)=&#34;&#34; } } } } s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo),&#34;&#34;)) //前处理标本核收 i IsSpecialFlag=1 { I &#39;$D(TestSetList) s RetValue=&#34;-1^无可核收医嘱&#34; q RetValue s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) Set $ZTrap = &#34;ErrorHandle&#34; TSTART s MajorConclusion=&#34;&#34;,OldEpi=&#34;&#34;,MiniConclusion=&#34;&#34; i $l(PreReportDR) s MajorConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),40),MiniConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),41),OldEpi=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),8) s maxEpis=OldEpi s TestSetGroup=&#34;&#34; f{ s TestSetGroup=$o(TestSetList(TestSetGroup)) q:TestSetGroup=&#34;&#34; s objVisitNumberReport=##class(dbo.RPVisitNumberReport).%New() s objVisitNumberReport.VisitNumberDR=VisitNumberDR s objVisitNumberReport.TransmitDate=TransmitDate s objVisitNumberReport.WorkGroupMachineDR=WorkGroupMachineDR S objVisitNumberReport.MajorConclusion=MajorConclusion s objVisitNumberReport.MinorConclusion=MiniConclusion S OrderNo=1 if $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,&#34;1&#34;)) { s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,&#34;&#34;),-1) s OrderNo=(OrderNo +1) } s AssayNo=&#34;&#34; s objVisitNumberReport.OrderNo=OrderNo i ((CommDirection=&#34;UP&#34;)||(CommDirection=&#34;BI&#34;)) s AssayNo=LabNo i &#39;$l(AssayNo) s AssayNo=maxEpis s objVisitNumberReport.AccessionNo=&#34;&#34; ///细菌分离号 s objVisitNumberReport.AssayNo=AssayNo s objVisitNumberReport.EpisodeNo=maxEpis i $l(maxEpis) s ^DHCLABWGMEPSIDERECORD(&#34;WGM&#34;,WorkGroupMachineDR,TransmitDate,maxEpis)=&#34;&#34; s objVisitNumberReport.AcceptDate=$tr($zd(+$h,3),&#34;-&#34;) s objVisitNumberReport.AcceptTime=$p($h,&#34;,&#34;,2) s objVisitNumberReport.AcceptUserDR=AcceptUserDR i $l(RackNo) s objVisitNumberReport.RackNo=RackNo s objVisitNumberReport.Status=1 //报告状态(1登记，2初审，3审核，4复查，5取消审核，6作废，O其他) s ret=objVisitNumberReport.%Save() If ($SYSTEM.Status.IsOK(ret)) {s RetValue=1 } Else {s err=&#34;报告生成失败:&#34;_$SYSTEM.Status.GetErrorText(ret) s RetValue=&#34;-1^&#34;_err q } I &#39;$D(TestSetList(TestSetGroup)) s RetValue=&#34;-1^无可核收医嘱&#34; q s TestSetDR=&#34;&#34; F { s TestSetDR=$o(TestSetList(TestSetGroup,TestSetDR)) q:TestSetDR=&#34;&#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR,&#34;&#34;)) i $l(RowID){ //修改标本医嘱核收工作小组 s objTestSets=##class(dbo.RPVisitNumberTestSet).%OpenId(RowID) s objTestSets.VisitNumberReportDR=objVisitNumberReport.RowID s objTestSets.WorkGroupMachineDR=WorkGroupMachineDR s sc=objTestSets.%Save() If (&#39;$SYSTEM.Status.IsOK(sc)) { s RetValue=$SYSTEM.Status.GetErrorText(sc) Quit } //按医嘱生成报告项目结果 s RetValue=##Class(LISSP.DHCRPVisitNumberReport).SaveReportTestCode(objVisitNumberReport.RowID,TestSetDR) i RetValue&#39;=1 q } } } i RetValue&#39;=1 TROLLBACK Quit RetValue //删除前处理报告 i $l(PreReportDR),&#39;$d(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,PreReportDR)){ s sc=##class(dbo.RPVisitNumberReport).%DeleteId(PreReportDR) If (&#39;$SYSTEM.Status.IsOK(sc)){s RetValue=&#34;删除报告信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc) } } i RetValue&#39;=1 TROLLBACK Quit RetValue TCOMMIT i $l(WorkGroupMachineDR),$l(maxEpis) s ret=##Class(HIS.DHCCommon).SaveWorkGroupMachineEpis(WorkGroupMachineDR,TransmitDate,maxEpis,&#34;&#34;) } else { //普通标本核收 s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) s Flag=1\t//YHR 20250319 仪器自动核收标志，为1的话，不影响工作小组手动核收序号 s Param=&#34;&lt;Data&gt;&lt;P0&gt;H&lt;/P0&gt;&#34; s Param=Param_&#34;&lt;P1&gt;&#34;_LabNo_&#34;&lt;/P1&gt;&lt;P2&gt;&lt;/P2&gt;&#34; s Param=Param_&#34;&lt;P3&gt;&#34;_maxEpis_&#34;&lt;/P3&gt;&#34; s Param=Param_&#34;&lt;P4&gt;&#34;_AcceptUserDR_&#34;&lt;/P4&gt;&lt;P5&gt;&lt;/P5&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P7&gt;&lt;/P7&gt;&#34; s Param=Param_&#34;&lt;P8&gt;&#34;_WorkGroupMachineDR_&#34;&lt;/P8&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P12&gt;&#34;_RackNo_&#34;&lt;/P12&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P14&gt;@@1@@&#34;_Flag_&#34;&lt;/P14&gt;&lt;/Data&gt;&#34; s Sessions=AcceptUserDR_&#34;^&#34;_WorkGroupDR_&#34;^^^&#34;_HospitalDR b ;a KSZDHS s ret=##Class(LISSP.DHCRPVisitNumber).ReceiveVisitNumber(LabNo,Param,Sessions) i $p(ret,&#34;^&#34;,1)&#39;=&#34;1&#34; s RetValue=ret } q RetValue ErrorHandle TROLLBACK s RetValue=&#34;-1^错误&#34;_$tr($ZERROR,&#34;^&#34;,&#34;--&#34;)_&#34;.错误代码:&#34;_$ECODE Quit RetValue } /// Creator： YHR /// CreatDate： 20250320 /// Description： 通过编号规则获取工作小组最大流水号 /// Table： dbo.RPVisitNumberReport /// Input： 工作小组，日期(只能获取当天的，编号规则隔天后会刷新) /// Output： 无 /// Return： 失败:&#34;&#34; 成功:流水号 /// Others\t【原】w ##Class(LIS.Common.DHCVisitNumber).GetMaxMiEpisodeNo(&#34;41&#34;,&#34;20250319&#34;) /// k ^TMP(&#34;MI.MIFIT3000N1.1&#34;,&#34;WGMEpis&#34;,&#34;41&#34;) /// w ##Class(MI.MIFIT3000N1).GetMaxMiEpisodeNo(&#34;41&#34;,&#34;20250319&#34;) ClassMethod GetMaxMiEpisodeNo(WorkGroupMachineDR As %String, TransmitDate As %String) As %String { S TransmitDate=$g(TransmitDate) S WorkGroupMachineDR=$G(WorkGroupMachineDR) S RetValue=&#34;&#34; i &#39;$l(WorkGroupMachineDR) q RetValue i &#39;$l(TransmitDate) s TransmitDate=$zd($h,8) s TransmitDate=$tr(TransmitDate,&#34;-&#34;) //记录该工作小组当天最大的流水号，如果有记录，则优先判断是否核收成功，如果未核收成功仍旧使用该号码 i $d(^TMP($zn,&#34;WGMEpis&#34;,WorkGroupMachineDR,TransmitDate)) d .s JLEpis=$g(^TMP($zn,&#34;WGMEpis&#34;,WorkGroupMachineDR,TransmitDate)) .i &#39;$l(JLEpis) q .i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,JLEpis,TransmitDate)) d ..s RetValue=JLEpis i $l(RetValue) q RetValue //通过编号规则获取当天流水号，编号规则代码设置为工作小组同样代码，通过代码获取工作小组对应的编号规则 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) //YHR 20230810 罗氏流水线规则 i $l(ZDHSEpis) d .i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ..s RetValue=ZDHSEpis .e d ..f Num=1:1:1000 d\t//避免死循环，每次进行一千次增号判断 ...s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) ...i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ....s RetValue=ZDHSEpis ....s Num=1001 i $l(RetValue) s ^TMP($zn,&#34;WGMEpis&#34;,WorkGroupMachineDR,TransmitDate)=RetValue q RetValue //未查询到编号规则，则获取当前工作小组最大流水号 s Parameter=&#34;&lt;Data&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P0&gt;&#34;_TransmitDate_&#34;&lt;/P0&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P5&gt;&lt;/P5&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P7&gt;&lt;/P7&gt;&lt;/Data&gt;&#34; s WGMEpisNo=##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(WorkGroupMachineDR,Parameter) //YHR 20250317 获取最大流水号报错问题处理 i $l(WGMEpisNo) s RetValue=WGMEpisNo q RetValue } /********************************************自动核收结束****************************************************/ } 个性化功能记录 本节点无特殊功能，可直接在其他接口使用类似功能。\n">
<title>罗氏流水线IT3000</title>

<link rel='canonical' href='https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/'>

<link rel="stylesheet" href="/scss/style.min.f2d7dc6e4260dd59fff8a52da7389f1eff957cf4cb673472fcac4ed793e45a6e.css"><meta property='og:title' content="罗氏流水线IT3000">
<meta property='og:description' content="接口说明 仪器厂商 罗氏流水线\n仪器型号 IT3000\n通讯方式 主动上传\n仪器类型 生化发光流水线 医院名称 厦门翔安医院 程序名称 MI.MIFIT3000 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：监听文件 连接方式：抓取RESULT结果文件和SEEN处理文件 .hl7文件，上传ORDERS .hl7文件 仪器接口说明 罗氏流水线与lis交互分为处理文件 SEEN 和结果文件 RESULT 两种以及血清图片，处理文件过多，lis读取文件和解析文件同时进行，造成结果文件无法及时解析，造成仪器传了结果但是未及时读取造成无法及时发报告。针对这一问题，详细在问题处理中无法及时读取文件处理造成获取结果过慢记录。 接口中包含多种功能，包含血清图片，自动核收，报警信息存储等。详细在仪器个性功能中展示。 数据格式 修改记录 序号 日期 操作人 说明 1 2025-04-03 10:15:50\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848 849 850 851 852 853 854 855 856 857 858 859 860 861 862 863 864 865 866 867 868 869 870 871 872 873 874 875 876 877 878 879 880 881 882 883 884 885 886 887 888 889 890 891 892 893 894 895 896 897 898 899 900 901 902 903 904 905 906 907 908 909 910 911 912 913 914 915 916 917 918 919 920 921 922 923 924 925 926 927 928 929 930 931 932 933 934 935 936 937 938 939 940 941 942 943 944 945 946 947 948 949 950 951 952 953 954 955 956 957 958 959 960 961 962 963 964 965 966 967 968 969 970 971 972 973 974 975 976 977 978 979 980 981 982 983 984 985 986 987 988 989 990 991 992 993 994 995 996 997 998 999 1000 1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 1011 1012 1013 1014 1015 1016 1017 1018 1019 1020 1021 1022 1023 1024 1025 1026 1027 1028 1029 1030 1031 1032 1033 1034 1035 1036 1037 1038 1039 1040 1041 1042 1043 1044 1045 1046 1047 1048 1049 1050 1051 1052 1053 1054 1055 1056 1057 1058 1059 1060 1061 1062 1063 1064 1065 1066 1067 1068 1069 1070 1071 1072 1073 1074 1075 1076 1077 1078 1079 1080 1081 1082 1083 1084 1085 1086 1087 1088 1089 1090 1091 1092 1093 1094 1095 1096 1097 1098 1099 1100 1101 1102 1103 1104 1105 1106 1107 1108 1109 1110 1111 1112 1113 1114 1115 1116 1117 1118 1119 1120 1121 1122 1123 1124 1125 /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;Z:\\\\ResultExport\\\\&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFLICA800&#34;,&#34;Para&#34;:&#34;.csv&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UpPara&#34;:&#34;Z:\\\\Imports\\\\&#34;}] Class MI.MIFIT3000N1 Extends %RegisteredObject { /// D ##class(MI.MIFInfinity).fileMTHD(&#34;7&#34;,&#34;MSH|^~\\&amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#&#34;,&#34;&#34;) /// seen: [VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR] /// result: [VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR] /// D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;&#34;,&#34;&#34;) /// seen: D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]&#34;,&#34;&#34;) /// result:D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]&#34;,&#34;&#34;) /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\Results,E:\\\\Temp\\\\Temp\\\\Interface\\\\Seens&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFXAIT3000&#34;,&#34;Para&#34;:&#34;.hl7&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoMAll,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealImage,PreDeal&#34;,&#34;UpPara&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\ORDERS\\\\&#34;}] /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\Results,E:\\\\Temp\\\\Temp\\\\Interface\\\\Seens&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFXAIT3000&#34;,&#34;Para&#34;:&#34;.hl7&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoMAll,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UpPara&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\ORDERS\\\\&#34;}] /// D ##class(MI.MIFIT300N).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250317162926||ORU^R01^ORU_R01|20250317162926573175|P|2.5|||AL|ER[13][10]PID|1||0000486028||^郑龙怡||20000126|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^感染性疾病科[13][10]ORC|SC|1003777033|||CM||||20250317160618[13][10]OBR|1|1003777033|||||||||||||||||||||||F[13][10]OBX|1|NM|TRAB^TRAB||&lt;0.800|||LIMTL|||F|||20250317170643|E1^MU1-e801-1-2@5503[13][10]NTE|1||LIMTL[13][10]NTE|1||LIMTL[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250320102229||ORU^R01^ORU_R01|20250320102229442999|P|2.5|||AL|ER[13][10]PID|1||0000481255||^杨建利||19880623|M[13][10]PV1|1|U||||||||109|||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003782597|||CM||||20250320084145||||||||109[13][10]OBR|1|1003782597|||||||||||||||||||||||F[13][10]OBX|1|NM|GLU^GLU||8.830||||||F|||20250320100301|C2^MU1-c702-2-2@5607[13][10]OBX|2|NM|UREA^UREA||4.330||||||F|||20250320100306|C2^MU1-c702-2-1@5607[13][10]OBX|3|NM|UA^UA||434.900||||||F|||20250320100254|C2^MU1-c702-2-2@5607[13][10]OBX|4|NM|TP^TP||79.900||||||F|||20250320095858|C1^MU1-c702-1-1@5607[13][10]OBX|5|NM|ALB^ALB||46.000||||||F|||20250320095348|C1^MU1-c702-1-2@5607[13][10]OBX|6|NM|TBIL^TBIL||6.000||||||F|||20250320095923|C1^MU1-c702-1-1@5607[13][10]OBX|7|NM|DBIL^DBIL||1.800||||||F|||20250320095901|C1^MU1-c702-1-1@5607[13][10]OBX|8|NM|ALT^ALT||107.000||||||F|||20250320095900|C1^MU1-c702-1-2@5607[13][10]OBX|9|NM|AST^AST||62.300||||||F|||20250320095909|C1^MU1-c702-1-1@5607[13][10]OBX|10|NM|RGT^RGT||68.800||||||F|||20250320100259|C2^MU1-c702-2-1@5607[13][10]OBX|11|NM|ALP^ALP||83.700||||||F|||20250320095907|C1^MU1-c702-1-2@5607[13][10]OBX|12|NM|TRIGL^TRIGL||8.810||||||F|||20250320100304|C2^MU1-c702-2-2@5607[13][10]OBX|13|NM|TC^TC||4.910||||||F|||20250320100257|C2^MU1-c702-2-2@5607[13][10]OBX|14|NM|SCRE^SCRE||66.400||||||F|||20250320100313|C2^MU1-c702-2-1@5607[13][10]OBX|15|NM|9CYSC^CYSC_NEW||0.89||||||F|||20250320095916|C1^MU1-c702-1-1@5607[13][10]OBX|16|NM|9HDL^HDL_NEW||0.69||||||F|||20250320095914|C1^MU1-c702-1-2@5607[13][10]OBX|17|NM|9LDL^LDL_NEW||2.06||||||F|||20250320095921|C1^MU1-c702-1-2@5607[13][10]OBX|18|ST|XYZL^DM_SERQ||Z:脂血||||||F|||20250320083356[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250320151725||ORU^R01^ORU_R01|20250320151725880554|P|2.5|||AL|ER[13][10]PID|1||0000095425||^姚程成||19980712|M[13][10]PV1|1|U|||||||||||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003784045|||CM||||20250320104114[13][10]OBR|1|1003784045|||||||||||||||||||||||F[13][10]OBX|1|NM|TP^TP||73.600||||||F|||20250320115059|C1^MU1-c702-1-1@5095[13][10]OBX|2|NM|ALB^ALB||49.600||||||F|||20250320114553|C1^MU1-c702-1-2@5095[13][10]OBX|3|NM|TBIL^TBIL||16.400||||||F|||20250320115110|C1^MU1-c702-1-1@5095[13][10]OBX|4|NM|DBIL^DBIL||4.400||||||F|||20250320115056|C1^MU1-c702-1-1@5095[13][10]OBX|5|NM|ALT^ALT||18.100||||||F|||20250320115057|C1^MU1-c702-1-2@5095[13][10]OBX|6|NM|AST^AST||22.900||||||F|||20250320115103|C1^MU1-c702-1-1@5095[13][10]OBX|7|NM|RGT^RGT||8.900||||||F|||20250320115522|C2^MU1-c702-2-1@5095[13][10]OBX|8|NM|ALP^ALP||78.100||||||F|||20250320115105|C1^MU1-c702-1-2@5095[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250321083434||ACK^^ACK|20250321083434378641|P|2.5|||NE|NE[13][10]EQU||^^^c702^^SAMPLEEVENT^SEEN|20250321083434[13][10]SAC|||1003775669|1003775669||20250321083433|01||P|c702|5719@4[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250328191032||ORU^R01^ORU_R01|20250328191032737830|P|2.5|||AL|ER[13][10]PID|1||0000531818||^郑苹||19811117|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^心血管内科[13][10]ORC|SC|1003802907|||CM||||20250328191358[13][10]OBR|1|1003802907|||||||||||||||||||||||F[13][10]OBX|1|NM|U-CR^U-CR||5924.00||||||F|||20250328200846|C2^MU1-c702-2-1@4003|||||||||5924.00[13][10]OBX|2|NM|UR-MALB^UR-MALB||15.30|||OBS.RR|||F|||20250328200852|C2^MU1-c702-2-2@4003|||||||||15.30[13][10]NTE|1||OBS.RR[13][10]&#34;) /// 非流水线分区代码 Parameter FQCode = &#34;WANTAI,XINCHANYE,LINJIAN,XIEGUANG&#34;; ClassMethod fileMTHD(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),record=$g(record),epis=$g(epis),filename=$g(filename),P4=$g(P4),P5=$g(P5),P6=$g(P6),P7=$g(P7),P8=$g(P8),P9=$g(P9),P10=$g(P10),P11=$g(P11),P12=$g(P12),P13=$g(P13),Sessions=$g(Sessions) i filename[&#34;Results&#34; j ..ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) q &#34;&#34; e d ..ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) q &#34;&#34; } ClassMethod ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;0&#34; s HospitalDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),4) i &#39;$l(record) q &#34;0&#34; i filename[&#34;Seens&#34; d Trace^MI.MIF000(mi,record,&#34;SeensRecord&#34;) e i filename[&#34;Results&#34; d Trace^MI.MIF000(mi,record,&#34;ResultsRecord&#34;) e d Trace^MI.MIF000(mi,record,&#34;AllRecord&#34;) s recordbak=record\t//仪器数据备份 s commandName=&#34;&#34;\t//前处理名称初始化 s commandchild=&#34;&#34; //前处理命令初始化 s DealDateStr=&#34;&#34; //MSH 时间初始化 s (sample,result,date,time,QC)=&#34;&#34; //解析多行合并数据 f i=1:1:$l(recordbak,&#34;[13][10]&#34;){ s record=$p(recordbak,&#34;[13][10]&#34;,i) ;d Trace^MI.MIF000(mi,record,&#34;解析行数据&#34;) i &#39;$l(record) q s type=$p(record,&#34;|&#34;,1)\t//取出消息头命令类型 //解析MSH命令 i type=&#34;MSH&#34;{ s DateStr=$p(record,&#34;|&#34;,7)\t//取日期串 i $l(DateStr)=14 s DealDateStr=$e(DateStr,1,8)_&#34;,&#34;_(($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60))\t//解析保存日期串 } //解析EQU命令\t包含前处理后处理指令，根据指令记录对应事件 i type=&#34;EQU&#34;{ //前处理名称\tRSA1 流水线处理信息，e801、P501_701\t仪器处理信息 s commandName=$p($p(record,&#34;|&#34;,3),&#34;^&#34;,4) //获取前处理命令，SEEN 上机事件，RESULT 前处理分区事件，RSA1 未知事件，ARCHIVE 归档事件 s commandchild=$p($p(record,&#34;|&#34;,3),&#34;^&#34;,7) ;d Trace^MI.MIF000(mi,commandchild,&#34;前处理命令&#34;) } //解析SAC命令\t根据EQU命令重获取到的前处理事件，进行LIS相关处理 //本接口包括 SEEN 自动核收，ARCHIVE 记录归档位置 i type=&#34;SAC&#34;{ s epis=$p(record,&#34;|&#34;,5)\t//取出流水号 s machCode=$p(record,&#34;|&#34;,11)\t//取出前处理分区信息或仪器信息 s positioninfo=$p(record,&#34;|&#34;,12)\t//取出位置信息 //前处理SEEN 自动核收 i commandchild=&#34;SEEN&#34;{ ;d Trace^MI.MIF000(mi,&#34;分区信息，标本号:&#34;_epis_&#34;的样本所在分区:&#34;_machCode_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) i commandName=&#34;RSA1&#34; j ..SaveRecord(epis,&#34;分区位置:&#34;_machCode_&#34;-&#34;_positioninfo,mi,&#34;100&#34;)\t//前处理分区 e j ..SaveRecord(epis,&#34;上机位置:&#34;_commandName_&#34;-&#34;_positioninfo,mi,&#34;6&#34;)\t//上机 try{d ..ZDHS(mi,epis,machCode,positioninfo)}catch ex{d Trace^MI.MIF000(mi,ex.Data,&#34;自动核收提示&#34;)}\t//自动核收 i commandName=&#34;RSA1&#34; d .i (&#34;,&#34;_..#FQCode_&#34;,&#34;)&#39;[(&#34;,&#34;_machCode_&#34;,&#34;) d\t//$TS$ 只有流水线仪器记录分区架子号 ..j ..SaveRackNo(epis,machCode_&#34;-&#34;_positioninfo,mi,&#34;分区&#34;) e j ..SaveRackNo(epis,commandName_&#34;-&#34;_positioninfo,mi,&#34;上机&#34;) } //前处理RESULT 处理分区信息 i commandchild=&#34;RESULT&#34;{ s curMachName=machCode\t//通过仪器对照码取仪器 //此处存标本全部分区预处理的位置号\t针对非流水线标本分拣 i commandName=&#34;RSA1&#34; j ..SaveRecord(epis,&#34;分区位置:&#34;_positioninfo,mi,&#34;100&#34;)\t//前处理分区 i commandName=&#34;RSA1&#34; j ..SaveRackNo(epis,positioninfo,mi,&#34;分区&#34;) } //前处理ARCHIVE 处理归档信息 i commandchild=&#34;ARCHIVE&#34;{ s curMachName=machCode\t//通过仪器对照码取仪器 //此处存标本全部审核报告的位置号 ;d Trace^MI.MIF000(mi,&#34;归档信息，标本号:&#34;_epis_&#34;的样本所在仪器:&#34;_curMachName_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) ;d Trace^MI.MIF000(mi,epis_&#34;执行记录分类信息:&#34;_positioninfo,&#34;H&lt;--M&#34;) i commandName=&#34;RSA1&#34; d .j ..SaveRackNo(epis,positioninfo,mi,&#34;归档&#34;)\t//保存归档信息到架子号 .j ..SaveRecord(epis,&#34;冰箱归档位置:&#34;_positioninfo,mi,&#34;62&#34;)\t//冰箱归档 e d .j ..SaveRackNo(epis,positioninfo,mi,&#34;归档中&#34;)\t//保存归档信息到架子号 .j ..SaveRecord(epis,&#34;归档中位置:&#34;_positioninfo,mi,&#34;62&#34;)\t//归档 ;d Trace^MI.MIF000(mi,epis_&#34;记录归档信息完成&#34;,&#34;H&lt;--M&#34;) } } //解析质控数据,P业务数据，Q质控数据 i type=&#34;ORC&#34;{ s epis=$p(record,&#34;|&#34;,3) } i type=&#34;OBR&#34;{ s epis=$p(record,&#34;|&#34;,3) } //仪器报警信息 i type=&#34;NTE&#34;{ s WaringStr=$p(record,&#34;|&#34;,4) s WaringCode=$p(WaringStr,&#34; &#34;,2) ;d Trace^MI.MIF000(mi,&#34;仪器报警信息:&#34;_WaringStr,&#34;H&lt;--M&#34;) //保存仪器报警信息到组内报告评价 ;d ..SaveResultWarned(epis,WaringStr,mi) } try{j ##class(MI.Special.Record).RecordData(epis,recordbak,&#34;LSLSXGET&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 i type=&#34;OBX&#34;{ s machCode=$p(record,&#34;|&#34;,16)\t//仪器信息和架子号信息 s code=$p($p(record,&#34;|&#34;,4),&#34;^&#34;,1) s res=$p(record,&#34;|&#34;,6) s CallThePolice=$p(record,&#34;|&#34;,9)\t//项目报警信息 s res=..ConvertResult(code,res)\t//结果特殊转换 i $l(CallThePolice) d .s result=result_code_$c(92)_res_$c(92)_$c(92)_CallThePolice_$c(44)\t//YHR 20250328 将报警信息存入到其他结果字段 .try{j ..SaveResultWarned(epis,&#34;存在仪器报警信息&#34;,mi,&#34;41&#34;)}catch{}\t//YHR 20250329 存储报警信息标志，此处41为常规生化工作小组$TS$ e s result=result_code_$c(92)_res_$c(44) } } i $l(result) d Trace^MI.MIF000(mi,epis_&#34;$$&#34;_result,&#34;H&lt;--M&#34;) //统一保存结果 i $l(epis),$l(result){ i $l(DealDateStr){\t//如果记录到时间，则根据仪器时间存储结果。 s date=$p(DealDateStr,&#34;,&#34;,1) s time=$p(DealDateStr,&#34;,&#34;,2) i $l(date)&#39;=8 s date=&#34;&#34;,time=&#34;&#34; } d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) } q &#34;&#34; } /// 结果特殊转换 /// $TS$ /// W ##CLASS(MI.MIFIT3000N1).ConvertResult(&#34;9PA&#34;,&#34;&lt;0.070&#34;) ClassMethod ConvertResult(code, res) { i code=&#34;9PA&#34; d .i $e(res)=&#34;&lt;&#34;,+$e(res,2,*)=&#34;.07&#34; d ..s res=&#34;&lt;70&#34; q res } /// 报警信息转换 ClassMethod ConvertPoliceInfo(WaringCode) { s WaringStr=&#34;&#34; i WaringCode=&#34;5&#34; s WaringStr=&#34;&gt;ABS(超出ABS)&#34; i WaringCode=&#34;43&#34; s WaringStr=&#34;Cal.E(校准结果异常)&#34; i WaringCode=&#34;2&#34; s WaringStr=&#34;&gt;Cuvet(反应杯空白异常)&#34; i WaringCode=&#34;42&#34; s WaringStr=&#34;Edit(实验结果已被编辑)&#34; i WaringCode=&#34;23&#34; s WaringStr=&#34;&gt;ISE(超出ISE范围)&#34; i WaringCode=&#34;19&#34; s WaringStr=&#34;ISE.E(ISE电压级错误)&#34; i WaringCode=&#34;56&#34; s WaringStr=&#34;&gt;Kin(Prozone错误2/运动不稳)&#34; i WaringCode=&#34;10&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; i WaringCode=&#34;11&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; i WaringCode=&#34;6&#34; s WaringStr=&#34;&gt;Prozone(Prozone错误1)&#34; i WaringCode=&#34;4&#34; s WaringStr=&#34;Reag.S(试剂不足)&#34; i WaringCode=&#34;44&#34; s WaringStr=&#34;&gt;Rept(高出原倍复查范围)&#34; i WaringCode=&#34;45&#34; s WaringStr=&#34;&lt;Rept(低于原倍复查范围)&#34; i WaringCode=&#34;46&#34; s WaringStr=&#34;Samp.？(高出ABS最大值)&#34; i WaringCode=&#34;68&#34; s WaringStr=&#34;Samp.B(样本中有气泡)&#34; i WaringCode=&#34;72&#34; s WaringStr=&#34;Samp.C(样本中有凝块)&#34; i WaringCode=&#34;26&#34; s WaringStr=&#34;&gt;Test(高出线性范围)&#34; i WaringCode=&#34;27&#34; s WaringStr=&#34;&lt;Test(低于线性范围)&#34; q WaringStr } /// 记录标本日志 /// D ##class(MI.MIFRS600).SaveRecord(&#34;&#34;,&#34;&#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode, curWorkGroupMachineDR) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s OperateTypeCode=$g(OperateTypeCode) i &#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,&#34;,&#34;,2),&#34;&#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,&#34;&#34;) } /// 保存报告表报警信息标志 /// D ##class(MI.MIFIT3000N1).SaveResultWarned(&#34;1003803130&#34;,&#34;1&#34;,&#34;34&#34;,&#34;41&#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI, curWorkGroupMachineDR) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) i &#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) i $l(conclusion)&gt;20 s conclusion=$e(conclusion,1,20)_&#34;...&#34; s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } /// 保存评价信息(标本质量) /// D ##class(MI.MIFRS600).SaveConclusion(&#34;&#34;,&#34;&#34;) ClassMethod SaveConclusion(labno, conclusion, predealMI, curWorkGroupMachineDR, IsPrint) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s IsPrint=$g(IsPrint) i IsPrint&#39;=1 s IsPrint=&#34;0&#34;\t//1 打印主评价，0 不打印次评价 i &#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i IsPrint=1 d ......i $l(objrep.MajorConclusion) s objrep.MajorConclusion=objrep.MajorConclusion_&#34;,&#34;_conclusion ......e s objrep.MajorConclusion=conclusion ......e d ......i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_&#34;,&#34;_conclusion ......e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i IsPrint=1 d ..s objrep.MajorConclusion=conclusion .e s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } /// 保存归档,分类信息,架子号,新增保存类型和参数工作小组ID，针对仪器不在对应的工作小组也可以保存架子号。 /// D ##class(MI.Special.Common).SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) /// D ##class(MI.Special.Common).SaveRackNo(&#34;1003775669&#34;,&#34;c702-5719@4&#34;,&#34;34&#34;,&#34;上机&#34;) ClassMethod SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) { s labno=$g(labno) s positioninfo=$g(positioninfo) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),typename=$g(typename) i &#39;$L(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $l(typename) s positioninfo=typename_&#34;:&#34;_positioninfo s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo) j ..SaveRecord(labno,&#34;架子号位置更新:&#34;_objrep.RackNo_&#34;--&gt;&#34;_positioninfo,mi,&#34;101&#34;)\t//架子号更新 .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,&#34;-1^存&#34;_typename_&#34;信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i $l(objrep.RackNo) j ..SaveRecord(labno,&#34;架子号位置更新:&#34;_objrep.RackNo_&#34;--&gt;&#34;_positioninfo,mi,&#34;101&#34;)\t//架子号更新 .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q hasFindRep } /// 保存标本图片 /// D ##class(MI.MIFRS600).SaveImageMTHD(&#34;57&#34;,&#34;1000100990&#34;,&#34;P&#34;,&#34;/iLISLIS080/demo.png&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) /// D ##class(MI.MIFIT3000N1).SaveImageMTHD(&#34;34&#34;,&#34;1003783657_01&#34;,&#34;1003783657_01&#34;,&#34;/iLISLIS032/20250321/1003783657_01.jpg&#34;,&#34;C:\\LISDATA\\DATA\\1003783657_01.jpg&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s ^YHR(&#34;MI.MIFIT3000&#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=&#34;1&#34; s epis=$p(epis,&#34;_&#34;,1) s ImageClass=&#34;P&#34;_+$p(ImageClass,&#34;_&#34;,2) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=&#34;&#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis),&#34;&#34;)) .i $d(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=&#34;&#34; f s RowID=$o(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=&#34;&#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i &#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=&#34;SerumQ&#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (&#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= &#34;-1^保存报告图片失败:&#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_&#34;:&#34;_ImageClass_&#34;:&#34;_FileName,&#34;H&lt;--M&#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=&#34;&#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // w ##class(MI.MIFRS600).GetFtpMTHD(&#34;24&#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = &#34;labno,labnoInfo,patInfo&#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(&#34;MI.MIFIT3000N1&#34;,&#34;QryLabInfo&#34;,&#34;34&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; s LabnoList=&#34;&#34; s VisitNumberDR=&#34;&#34; s OutPutNum=0 //*--------------------------------&gt;*申请项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:(AddDate=&#34;&#34;)||(OutPutNum&gt;6) d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:(AddTime=&#34;&#34;)||(OutPutNum&gt;6) d ..s OutPutNum=OutPutNum+1 ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..i &#39;$d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno)) q ..s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..s ReceiveTime=$lg($g(^dbo.RPVisitNumberD(VisitNumberDR)),67) ..i ((+$p($h,&#34;,&#34;,2))-ReceiveTime&gt;=-2)&amp;&amp;((+$p($h,&#34;,&#34;,2))-ReceiveTime&lt;5) d Trace^MI.MIF000(mi,labno_&#34;标本接收时间低于5秒不上传&#34;,&#34;等待上传&#34;) q ..//得到通道号 ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@C&#34;\t//重新获取通道号 避免因为接收造成漏项目 ..;s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..;s labnoInfo=labno_&#34;,&#34;_$replace(TCList,&#34;\\&#34;,&#34;+&#34;)_&#34;|@U&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;申请上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;C@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** //*--------------------------------&gt;*复查结果上传 s AddDate=$zd($p($h,&#34;,&#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i &#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..s labnoInfo=labno_&#34;,&#34;_$replace(TCList,&#34;\\&#34;,&#34;+&#34;)_&#34;|@U&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;复查上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;U@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** //*--------------------------------&gt;*取消项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i &#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@R&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;取消上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;R@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i &#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=labno_&#34;,&#34;_&#34;DM_OVER&#34;_&#34;@C&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;审核上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;T@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=&#34;labno,labnoInfo,patInfo&#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=&#34;&#34; { Set AtEnd=1 Set Row=&#34;&#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 获取申请名称和内容 /// 申请名称： /// 发送申请：order_2012051718302501_9999999901NW.HL7 /// 取消申请：order_2012051718302501_9999999901CA.HL7 /// 项目复查：order_2012051718302501_9999999901XO.HL7 /// w ##class(MI.MIFRS600).GetLisOrderMTHD(&#34;8&#34;,&#34;POS@C@1&#34;,&#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08 -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34; ,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) /// w ##class(MI.MIFIT300N).GetLabnoInfoN(&#34;34&#34;,&#34;1003779663,DM_OVER@C&#34;,&#34;2025-03-18□19:07:07,IT3000,,,,急诊内科,测试医生(勿选）,检验管理员,0000243381,陈耀明,1,急诊,,34,,1003779663,2025-03-18□18:24,,,,,眩晕,,,,2025-03-18□18:24,,,19900920&#34;) ClassMethod GetLabnoInfoN(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s VT=&#34;[11]&#34;,FS=&#34;[28]&#34;,CR=&#34;[13]&#34; s labNo=$p(patInfo,&#34;,&#34;,16) s Sampleno=$p(patInfo,&#34;,&#34;,3) //i labNo=&#34;74623177&#34; s ^TMP(&#34;zlzit3000d&#34;)=$lb(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s location=$p(patInfo,&#34;,&#34;,6) s docName=$p(patInfo,&#34;,&#34;,7) s regNo=$p(patInfo,&#34;,&#34;,9) s patName=$p(patInfo,&#34;,&#34;,10) s sex=$p(patInfo,&#34;,&#34;,11) i sex=&#34;1&#34; s sex=&#34;M&#34; i sex=&#34;2&#34; s sex=&#34;F&#34; i (sex&#39;=&#34;M&#34;)&amp;&amp;(sex&#39;=&#34;F&#34;) s sex=&#34;U&#34; s birthDate=$p(patInfo,&#34;,&#34;,29) s collectTime=$p(patInfo,&#34;,&#34;,17) ;2017-08-14 11:57 s collectTime=$tr(collectTime,&#34;- :&#34;,&#34;&#34;)_&#34;00&#34; s status=$p(labnoInfo,&#34;@&#34;,2) s labnoInfo=$p(labnoInfo,&#34;@&#34;,1) s curTime=$zd($h,8)_$tr($zt($p($h,&#34;,&#34;,2)),&#34;:&#34;,&#34;&#34;) s PatType=$p(patInfo,&#34;,&#34;,12) s Wardno=$p(patInfo,&#34;,&#34;,27) s Diagnose=$p(patInfo,&#34;,&#34;,22) S patTypeFlag=&#34;RO&#34; //门诊=RO,住院=RI,体检=RC,急诊=RS I PatType=&#34;住院&#34; { S patTypeFlag=&#34;RI&#34; } I PatType=&#34;门诊&#34; { S patTypeFlag=&#34;RO&#34; } I PatType=&#34;急诊&#34; { S patTypeFlag=&#34;RS&#34; } I PatType=&#34;体检&#34; { S patTypeFlag=&#34;RC&#34; } I PatType=&#34;干诊&#34; { S patTypeFlag=&#34;RC&#34; } s AssayNo=..GetReportAssayNoMTHD(mi,labNo) s MSN=&#34;MSH|^~\\&amp;|DHC-LIS|IT3000|||||OML^O21|&#34;_$tr($zdt($h,3),&#34; &#34;&#34;:&#34;&#34;-&#34;)_&#34;SND&#34;_labNo_&#34;|P|2.3|||NE|NE||&#34; s PID=&#34;PID|1||&#34;_regNo_&#34;|&#34;_docName_&#34;|^&#34;_patName_&#34;||&#34;_birthDate_&#34;|&#34;_sex //_location s PV1=&#34;PV1|||?|||||||||||||||||&#34; s DG1=&#34;DG1|||00000^default|||F&#34; ;s IN1=&#34;IN1|||China-Bank&#34; ;s ORC=&#34;ORC|NW|&#34;_labNo_&#34;|&#34;_regNo_&#34;||||R||&#34;_$zd($h,8)_$tr($zt($h),&#34;:&#34;,&#34;&#34;)_&#34;|&#34;_docName s orcF1=&#34;NW&#34;,orcF2=&#34;&#34; i status=&#34;R&#34; s orcF1=&#34;CA&#34; i status=&#34;U&#34; s orcF1=&#34;XO&#34; s orcF2=&#34;SC&#34; s ORC=&#34;ORC|&#34;_orcF1_&#34;|&#34;_labNo_&#34;|&#34;_AssayNo_&#34;||&#34;_orcF2_&#34;||&#34;_patTypeFlag_&#34;|&#34;_location_&#34;|&#34;_..GetReceiveDateTime(labNo) //change by sch20210421 //s:orcF1&#39;=&#34;XO&#34; ORC=&#34;ORC|&#34;_orcF1_&#34;|&#34;_labNo_&#34;|&#34;_AssayNo_&#34;||&#34;_orcF2_&#34;||&#34;_patFLAG_&#34;||&#34;_$tr($zdt($h,3),&#34; &#34;&#34;:&#34;&#34;-&#34;) //_&#34;|&#34;_docName //&#34;_regNo_&#34; ;s NTE=&#34; NTE||I|Code: C1 Comment: Sample comment 1|&#34; s obrF1=&#34;A&#34; i status=&#34;U&#34; s obrF1=&#34;G&#34; //OBR||2012081501||ROCHE_AFP|||20120814160023|||9999|A s OBR=&#34;OBR||&#34;_labNo_&#34;||GLU|||||||&#34;_obrF1 //&#34;_collectTime_&#34; ;s OBX=&#34;OBX|2|ST|AHBS^6012^||45.290^Instrument flag!|mol/L| - ^^||5221^1||F|||20170816152751|356^COBAS8000B:E602C2|DATOS_PRJ^16-8月 -17^^|&#34; s OBRs=&#34;&#34; i $p(labnoInfo,&#34;@&#34;,1)=&#34;POS&#34; d .s OBRs=&#34;OBR||&#34;_labNo_&#34;||POS|||&#34;_collectTime_&#34;||||&#34;_obrF1 e d .d GetOBRs //s orderTxt=VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS s orderTxt=VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS q orderTxt GetOBRs s items=$tr($p(labnoInfo,&#34;,&#34;,2),&#34;|&#34;,&#34;&#34;) f i=1:1:$l(items,&#34;+&#34;) d .s item=$p(items,&#34;+&#34;,i) .s splitStr=$p(OBR,&#34;|&#34;,5) .s curOBR=$p(OBR,splitStr,1)_item_$p(OBR,splitStr,2) .s OBRs=OBRs_curOBR_CR q } // w ##Class(MI.MIFIT3000).GetReportAssayNoMTHD(8,&#34;1905074122&#34;) ClassMethod GetReportAssayNoMTHD(mi, labno, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { S mi= $G(mi) S labno= $G(labno) i &#39;$l(labno) q &#34;&#34; i &#39;$l(mi) q &#34;&#34; s (orderno,VisitNumberDR)=&#34;&#34; s labno=&#34;&#34;_labno s WGMDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i &#39;$l(WGMDR) q &#34;&#34; S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) s orderno=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WGMDR,&#34;&#34;)) i &#39;$l(orderno) q &#34;&#34; s reportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WGMDR,orderno,&#34;&#34;)) s AssayNo =$lg($g(^dbo.RPVisitNumberReportD(reportDR)),8) Q AssayNo } /// W ##class(MI.MIFIT300N).GetReceiveDateTime(&#34;1003775372&#34;) ClassMethod GetReceiveDateTime(Labnum) { q:&#39;$l(Labnum) &#34;&#34; s VisitnumberDR=&#34;&#34;,ReceiveDate=&#34;&#34;,ReceiveTime=&#34;&#34;,ReceiveDateTime=&#34;&#34; s VisitnumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,&#34;&#34;_Labnum,&#34;&#34;)) s:$l(VisitnumberDR) ReceiveDate=$lg(^dbo.RPVisitNumberD(VisitnumberDR),66) s:$l(VisitnumberDR) ReceiveTime=$lg(^dbo.RPVisitNumberD(VisitnumberDR),67) s:$l(ReceiveDate)&amp;$l(ReceiveTime) ReceiveDateTime=ReceiveDate_$tr($zt(ReceiveTime),&#34;:&#34;) q ReceiveDateTime } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) /// w ##Class(MI.MIFIT3000N1).GetLabnoInfo(34,&#34;8000001003&#34;) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=&#34;&#34; s chl=&#34;&#34; f s chl=$o(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) q:chl=&#34;&#34; d .s tcx=tcx_chl_&#34;+&#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) i $l(tcx) s tcx=labno_&#34;,&#34;_tcx_&#34;|&#34; d Trace^MI.MIF000(mi,tcx,&#34;H--&gt;M&#34;) d Trace^MI.MIF000(56,&#34;共&#34;_$l(tcx,&#34;+&#34;)_&#34;个项目。&#34;_tcx,&#34;H--&gt;M&#34;) //YHR 20230816 将上传信息存入罗氏infinity仪器 q tcx } /// w ##Class(MI.MIFRS600).GetPatInfo(57,9000001912) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q &#34;&#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) i &#39;$l(VisitNumberDR) q &#34;&#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=&#34;&#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=&#34;&#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=&#34;&#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=&#34;&#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=&#34;&#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=&#34;&#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,&#34;,&#34;,1),3)_&#34; &#34;_$zt($p($h,&#34;,&#34;,2)) s Instrument = &#34;XN&#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) i $l(Instrument) s Instrument=$tr(Instrument,&#34;,&#34;,&#34;^&#34;) s Sampleno=$lg(RPVisitNumberData,6) //病案号 s Sampletype=&#34;&#34; s Feetype=&#34;&#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 &#34;&#34; s BarCode=&#34;&#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=&#34;男&#34; s Sex=&#34;1&#34; ;1:男 ，2 女 i Species =&#34;女&#34; s Sex=&#34;2&#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=&#34;&#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=&#34;&#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_&#34;-&#34;_$e(ReceiveDate,5,6)_&#34;-&#34;_$e(ReceiveDate,7,8)_&#34; &#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=&#34;&#34; ;报告日期 = 初审(保存结果)时间 s Printflag=&#34;&#34; ;打印标志 s Resultflag=&#34;&#34; ;结果标志 s Errflag=&#34;&#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=&#34;&#34; ;备注 s Reserve=&#34;&#34; ;保留字段 s Patnamn=&#34;&#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_&#34;-&#34;_$e(CollectDate,5,6)_&#34;-&#34;_$e(CollectDate,7,8)_&#34; &#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=&#34;&#34; s WardnoDR=$lg(RPVisitNumberData,26) ;病区 i $l(WardnoDR) s Wardno=$lg($g(^dbo.BTWardD(WardnoDR)),3) s RetString=&#34;&#34; s RetString=$tr(Sampleda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Instrument,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampleno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampletype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Feetype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdepno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdocno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Userno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patna,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sex,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Pattype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Bedno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patage,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Ageunit,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Reportda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Printflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Resultflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Errflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Diagnose,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Description,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reserve,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patnamn,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Getda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Wardno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BarCode,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BirthDate,&#34;,&#34;,&#34;&#34;) q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename) q } /********************************************自动核收开始****************************************************/ /// 仪器主键，条码号，前处理标本分区标识，仪器信息(位置) /// w ##class(MI.MIFIT3000N1).ZDHS(&#34;34&#34;,&#34;8000000352&#34;,&#34;WANTAI&#34;) /// w ##class(MI.MIFIT300N).ZDHS(&#34;34&#34;,&#34;1003779663&#34;,&#34;RSA1&#34;) ClassMethod ZDHS(mi, Labno, MachineCode, positioninfo) { s mi=$g(mi),Labno=$g(Labno),machCode=$g(MachineCode),positioninfo=$g(positioninfo) i &#39;$l(Labno) q &#34;&#34; /*----------&gt;判断该标本是否已接收未核收 开始&lt;----------*/ s QuitFlag=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##class(LIS.Util.Common).IndexData(Labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##class(LIS.Util.Common).IndexData(Labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) s QuitFlag=1 i QuitFlag=1 q &#34;&#34; /*----------&gt;判断该标本是否已接收未核收 结束&lt;----------*/ s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)\t//得到当前仪器关联工作小组信息 s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13)\t//得到仪器工作小组的核收类型 //AcceptFlag为1认为是前处理工作小组，如果是前处理小组，就认为上前处理\t本接口未设置前处理工作小组，未对此流程进行测试 i AcceptFlag=&#34;1&#34; d QCLZDHS e d ZDHS q &#34;&#34; ZDHS d Trace^MI.MIF000(mi,&#34;上仪器,标本号:&#34;_Labno_&#34;的标本在:&#34;_curMachName_&#34;,分区位置:&#34;_MachineCode_&#34;,样本所在:&#34;_positioninfo,&#34;自动核收&#34;) //根据前处理标本分区进行分区自动核收，并且根据分区代码是否核收进行区分 //本接口认为 默认认为罗氏流水线核收，如果分区代码中包含 【BHS】则认为标本不核收，此块代码将仪器传过来的分区代码进行归类 //本接口关联标本分区， WANTAI 万泰--&gt;W，XINCHANYE 新产业--&gt;X，LINJIAN 临检凝血--&gt;L，XIEGUANG 携光--&gt;R，罗氏--&gt;Y，不核收--&gt;N s HsFlag=&#34;Y&#34;,WorkGroupMachineDR=&#34;&#34; i (MachineCode[&#34;WANTAI&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;WANTAI&#34;,&#34;&#34;) .s HsFlag=&#34;W&#34; .s WorkGroupMachineDR=48\t//未核收且分区是WANTAI i (MachineCode[&#34;XINCHANYE&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;XINCHANYE&#34;,&#34;&#34;) .s HsFlag=&#34;X&#34; .s WorkGroupMachineDR=50\t//未核收且分区是XINCHANYE i (MachineCode[&#34;LINJIAN&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;LINJIAN&#34;,&#34;&#34;) .s HsFlag=&#34;L&#34; .s WorkGroupMachineDR=9\t//未核收且分区是LINJIAN i (MachineCode[&#34;XIEGUANG&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;XIEGUANG&#34;,&#34;&#34;) .s HsFlag=&#34;R&#34; .s WorkGroupMachineDR=67\t//未核收且分区是XIEGUANG i (MachineCode[&#34;BHS_&#34;) d\t;BHS_WANTAI .S MachineCode=$REPLACE(MachineCode,&#34;BHS_&#34;,&#34;&#34;) .s HsFlag=&#34;N&#34; i MachineCode=&#34;C_C8K886&#34; s MachineCode=&#34;C801&#34; i MachineCode=&#34;C_C8K77&#34; s MachineCode=&#34;C701&#34; i MachineCode=&#34;C8K886&#34; s MachineCode=&#34;C801&#34; i MachineCode=&#34;C8K77&#34; s MachineCode=&#34;C701&#34; i HsFlag=&#34;Y&#34; d .s WorkGroupMachineDR=41\t//未核收且分区不包含BHS_\t默认核收到罗氏流水线 i &#39;$l(WorkGroupMachineDR) q s ret=..ReceiveLabNoByWGM(WorkGroupMachineDR,Labno,$zd(+$h,8)) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) i ret&#39;=&#34;1&#34; d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = &#34;WG-&#34;_WorkGroupDR\t//自动核收出错显示再对应的工作组 .s SendRet=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收失败&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_Labno_&#34;前处理核收失败:&#34;_ret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) j ..SaveRecord(Labno,&#34;自动核收:&#34;_ret,&#34;&#34;,&#34;14&#34;,WorkGroupMachineDR) q ret QCLZDHS d Trace^MI.MIF000(mi,&#34;上前处理，鉴定号:&#34;_Labno_&#34;的标本在:&#34;_curMachName_&#34;,样本所在:&#34;_positioninfo,&#34;DealInfo&#34;) d Trace^MI.MIF000(mi,&#34;执行核收到前处理&#34;,&#34;DealInfo&#34;) //此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,Labno,&#34;&#34;) d Trace^MI.MIF000(mi,Labno_&#34;核收到前处理返回信息:&#34;_dealret,&#34;DealInfo&#34;) //记录位置信息到报告位置号 d ..SaveRackNo(Labno,positioninfo,mi) i dealret[&#34;标本已核收&#34; q i dealret=&#34;1&#34; d .//写标本操作日志 .d ..SaveRecord(Labno,machCode,mi,&#34;5&#34;) e d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = &#34;WG-&#34;_CurWorkGroupDR .s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收失败&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_Labno_&#34;前处理核收失败:&#34;_dealret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) .//写标本操作日志 .d ..SaveRecord(Labno,dealret,mi,&#34;100&#34;) q } /// Others w ##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(&#34;3&#34;,&#34;1000004476&#34;,&#34;20191105&#34;) /// 按工作小组核收医嘱 /// INPUT: MachID:仪器主键，LabNo：条码号，TransmitDate：上机日期（不传默认当天） /// OutPut: RetValue:1成功 ClassMethod ReceiveLabNoByWGM(WorkGroupMachineDR As %String, LabNo As %String, TransmitDate, RackNo, RuleCode) As %String { s WorkGroupMachineDR=$g(WorkGroupMachineDR) s LabNo=$g(LabNo) s TransmitDate=$g(TransmitDate) s RuleCode=$g(RuleCode) s RackNo=$g(RackNo) s NowDate=$zd($h,8) s RetValue=1 i &#39;$l(TransmitDate) s TransmitDate=NowDate i &#39;$l(WorkGroupMachineDR) q 100 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s WorkGroupMachineName=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) s DepartmentDR=$lg(^dbo.BTWorkGroupD(WorkGroupDR),4) s HospitalDR=$lg(^dbo.BTDepartmentD(DepartmentDR),4) s WorkGroupMachineDesc=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s IndexOperateType=##class(LIS.Util.Common).IndexData(&#34;H&#34;) s AutoDR=$O(^dbo.RPWGMachineAutoI(&#34;IndexOperateType&#34;,IndexOperateType,WorkGroupMachineDR,&#34;&#34;)) i &#39;$l(AutoDR) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未设置自动核收&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未设置自动核收！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未设置自动核收！&#34; } s MachineAutoData=$g(^dbo.RPWGMachineAutoD(AutoDR)) s IsOpen=$LG(MachineAutoData,4) i IsOpen&#39;=1 { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未开启自动核收&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未开启自动核收！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未开启自动核收！&#34; } s CurrentDate = $p($h,&#34;,&#34;,1) s Currenttime = $p($h,&#34;,&#34;,2) //开始时间 s StartDate=$lg(MachineAutoData,5) i $l(StartDate) s StartDate= $zdh(StartDate,8) s StartTime=$lg(MachineAutoData,6) //结束时间 s EndDate=$lg(MachineAutoData,7) i $l(EndDate) s EndDate= $zdh(EndDate,8) s EndTime=$lg(MachineAutoData,8) //时间类型 s TimeType=$lg(MachineAutoData,9) i TimeType=&#34;CT&#34; //连续 { i (CurrentDate&lt;StartDate)||(($l(StartTime))&amp;&amp;(CurrentDate=StartDate)&amp;&amp;(Currenttime&lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期未生效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期未生效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期未生效！&#34; } i (CurrentDate&gt;EndDate)||(($l(EndTime))&amp;&amp;(CurrentDate=EndDate)&amp;&amp;(Currenttime&gt;EndTime) ) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期已失效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期已失效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期已失效！&#34; } } i TimeType=&#34;TS&#34; //时间段 { i (CurrentDate&lt;StartDate)||(($l(StartTime))&amp;&amp;(Currenttime&lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期未生效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期未生效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期未生效！&#34; } i (CurrentDate&gt;EndDate)||(($l(EndTime))&amp;&amp;(Currenttime&gt;EndTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期已失效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期已失效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期已失效！&#34; } } s AcceptUserDR=&#34;&#34; i $l(AutoDR) s AcceptUserDR=$LG($g(^dbo.RPWGMachineAutoD(AutoDR)),10) i &#39;$l(AcceptUserDR) d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = &#34;WG-&#34;_WorkGroupDR .s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未设置负责人&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未设置核收负责人！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) i &#39;$l(AcceptUserDR) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未设置核收负责人！&#34; s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///判断医嘱是否核收 S AcceptFlag=0 s IsSpecialFlag=0 s CheckItemList=&#34;&#34; s PreReportDR=&#34;&#34; k TestSetList s LabNoType=##Class(LISSP.DHCRPVisitNumber).GetLabNoType(LabNo) s WebNamespace=##Class(OTH.SYSParameter).GetWebNamespace() i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo))){ s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo),&#34;&#34;)) S TestSetDR=&#34;&#34; f { s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR)) q:TestSetDR=&#34;&#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR,&#34;&#34;)) i $l(RowID){ s TestSetGroup=&#34;Default&#34; //工作小组下分组类型 s WGMDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),5) i &#39;$l(WGMDR) s CheckItemList=TestSetDR_CheckItemList S AccpetReportDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11) I $L(AccpetReportDR) s AccpetWGMDR=$LG($G(^dbo.RPVisitNumberReportD(AccpetReportDR)),4) I $LG($g(^dbo.BTWorkGroupMachineD(AccpetWGMDR)),13)&#39;=1 continue s AcceptFlag=0 I $L(WGMDR) S AcceptFlag=$LG($g(^dbo.BTWorkGroupMachineD(WGMDR)),13) //是否是前处理小组 I AcceptFlag=1 S PreReportDR= $LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11),IsSpecialFlag=1 I AcceptFlag=1,$D(^dbo.BTTestSetWorkGroupMachineI(&#34;IndexMaster&#34;,TestSetDR,WorkGroupMachineDR)) { //处理报告分组信息 i $d(^dbo.BTWorkGroupMachineRuleTSI(&#34;IndexTestSet&#34;,TestSetDR)) { s WorkGroupMachineRuleDR=&#34;&#34; f{ s WorkGroupMachineRuleDR=$o(^dbo.BTWorkGroupMachineRuleTSI(&#34;IndexTestSet&#34;,TestSetDR,WorkGroupMachineRuleDR)) q:WorkGroupMachineRuleDR=&#34;&#34; s GroupWGMDR=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),4) s IsShow=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),5) i WorkGroupMachineDR&#39;=GroupWGMDR continue i IsShow=&#34;1&#34; continue s TestSetGroup=WorkGroupMachineRuleDR } } s TestSetList(TestSetGroup,TestSetDR)=&#34;&#34; } } } } s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo),&#34;&#34;)) //前处理标本核收 i IsSpecialFlag=1 { I &#39;$D(TestSetList) s RetValue=&#34;-1^无可核收医嘱&#34; q RetValue s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) Set $ZTrap = &#34;ErrorHandle&#34; TSTART s MajorConclusion=&#34;&#34;,OldEpi=&#34;&#34;,MiniConclusion=&#34;&#34; i $l(PreReportDR) s MajorConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),40),MiniConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),41),OldEpi=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),8) s maxEpis=OldEpi s TestSetGroup=&#34;&#34; f{ s TestSetGroup=$o(TestSetList(TestSetGroup)) q:TestSetGroup=&#34;&#34; s objVisitNumberReport=##class(dbo.RPVisitNumberReport).%New() s objVisitNumberReport.VisitNumberDR=VisitNumberDR s objVisitNumberReport.TransmitDate=TransmitDate s objVisitNumberReport.WorkGroupMachineDR=WorkGroupMachineDR S objVisitNumberReport.MajorConclusion=MajorConclusion s objVisitNumberReport.MinorConclusion=MiniConclusion S OrderNo=1 if $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,&#34;1&#34;)) { s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,&#34;&#34;),-1) s OrderNo=(OrderNo +1) } s AssayNo=&#34;&#34; s objVisitNumberReport.OrderNo=OrderNo i ((CommDirection=&#34;UP&#34;)||(CommDirection=&#34;BI&#34;)) s AssayNo=LabNo i &#39;$l(AssayNo) s AssayNo=maxEpis s objVisitNumberReport.AccessionNo=&#34;&#34; ///细菌分离号 s objVisitNumberReport.AssayNo=AssayNo s objVisitNumberReport.EpisodeNo=maxEpis i $l(maxEpis) s ^DHCLABWGMEPSIDERECORD(&#34;WGM&#34;,WorkGroupMachineDR,TransmitDate,maxEpis)=&#34;&#34; s objVisitNumberReport.AcceptDate=$tr($zd(+$h,3),&#34;-&#34;) s objVisitNumberReport.AcceptTime=$p($h,&#34;,&#34;,2) s objVisitNumberReport.AcceptUserDR=AcceptUserDR i $l(RackNo) s objVisitNumberReport.RackNo=RackNo s objVisitNumberReport.Status=1 //报告状态(1登记，2初审，3审核，4复查，5取消审核，6作废，O其他) s ret=objVisitNumberReport.%Save() If ($SYSTEM.Status.IsOK(ret)) {s RetValue=1 } Else {s err=&#34;报告生成失败:&#34;_$SYSTEM.Status.GetErrorText(ret) s RetValue=&#34;-1^&#34;_err q } I &#39;$D(TestSetList(TestSetGroup)) s RetValue=&#34;-1^无可核收医嘱&#34; q s TestSetDR=&#34;&#34; F { s TestSetDR=$o(TestSetList(TestSetGroup,TestSetDR)) q:TestSetDR=&#34;&#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR,&#34;&#34;)) i $l(RowID){ //修改标本医嘱核收工作小组 s objTestSets=##class(dbo.RPVisitNumberTestSet).%OpenId(RowID) s objTestSets.VisitNumberReportDR=objVisitNumberReport.RowID s objTestSets.WorkGroupMachineDR=WorkGroupMachineDR s sc=objTestSets.%Save() If (&#39;$SYSTEM.Status.IsOK(sc)) { s RetValue=$SYSTEM.Status.GetErrorText(sc) Quit } //按医嘱生成报告项目结果 s RetValue=##Class(LISSP.DHCRPVisitNumberReport).SaveReportTestCode(objVisitNumberReport.RowID,TestSetDR) i RetValue&#39;=1 q } } } i RetValue&#39;=1 TROLLBACK Quit RetValue //删除前处理报告 i $l(PreReportDR),&#39;$d(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,PreReportDR)){ s sc=##class(dbo.RPVisitNumberReport).%DeleteId(PreReportDR) If (&#39;$SYSTEM.Status.IsOK(sc)){s RetValue=&#34;删除报告信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc) } } i RetValue&#39;=1 TROLLBACK Quit RetValue TCOMMIT i $l(WorkGroupMachineDR),$l(maxEpis) s ret=##Class(HIS.DHCCommon).SaveWorkGroupMachineEpis(WorkGroupMachineDR,TransmitDate,maxEpis,&#34;&#34;) } else { //普通标本核收 s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) s Flag=1\t//YHR 20250319 仪器自动核收标志，为1的话，不影响工作小组手动核收序号 s Param=&#34;&lt;Data&gt;&lt;P0&gt;H&lt;/P0&gt;&#34; s Param=Param_&#34;&lt;P1&gt;&#34;_LabNo_&#34;&lt;/P1&gt;&lt;P2&gt;&lt;/P2&gt;&#34; s Param=Param_&#34;&lt;P3&gt;&#34;_maxEpis_&#34;&lt;/P3&gt;&#34; s Param=Param_&#34;&lt;P4&gt;&#34;_AcceptUserDR_&#34;&lt;/P4&gt;&lt;P5&gt;&lt;/P5&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P7&gt;&lt;/P7&gt;&#34; s Param=Param_&#34;&lt;P8&gt;&#34;_WorkGroupMachineDR_&#34;&lt;/P8&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P12&gt;&#34;_RackNo_&#34;&lt;/P12&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P14&gt;@@1@@&#34;_Flag_&#34;&lt;/P14&gt;&lt;/Data&gt;&#34; s Sessions=AcceptUserDR_&#34;^&#34;_WorkGroupDR_&#34;^^^&#34;_HospitalDR b ;a KSZDHS s ret=##Class(LISSP.DHCRPVisitNumber).ReceiveVisitNumber(LabNo,Param,Sessions) i $p(ret,&#34;^&#34;,1)&#39;=&#34;1&#34; s RetValue=ret } q RetValue ErrorHandle TROLLBACK s RetValue=&#34;-1^错误&#34;_$tr($ZERROR,&#34;^&#34;,&#34;--&#34;)_&#34;.错误代码:&#34;_$ECODE Quit RetValue } /// Creator： YHR /// CreatDate： 20250320 /// Description： 通过编号规则获取工作小组最大流水号 /// Table： dbo.RPVisitNumberReport /// Input： 工作小组，日期(只能获取当天的，编号规则隔天后会刷新) /// Output： 无 /// Return： 失败:&#34;&#34; 成功:流水号 /// Others\t【原】w ##Class(LIS.Common.DHCVisitNumber).GetMaxMiEpisodeNo(&#34;41&#34;,&#34;20250319&#34;) /// k ^TMP(&#34;MI.MIFIT3000N1.1&#34;,&#34;WGMEpis&#34;,&#34;41&#34;) /// w ##Class(MI.MIFIT3000N1).GetMaxMiEpisodeNo(&#34;41&#34;,&#34;20250319&#34;) ClassMethod GetMaxMiEpisodeNo(WorkGroupMachineDR As %String, TransmitDate As %String) As %String { S TransmitDate=$g(TransmitDate) S WorkGroupMachineDR=$G(WorkGroupMachineDR) S RetValue=&#34;&#34; i &#39;$l(WorkGroupMachineDR) q RetValue i &#39;$l(TransmitDate) s TransmitDate=$zd($h,8) s TransmitDate=$tr(TransmitDate,&#34;-&#34;) //记录该工作小组当天最大的流水号，如果有记录，则优先判断是否核收成功，如果未核收成功仍旧使用该号码 i $d(^TMP($zn,&#34;WGMEpis&#34;,WorkGroupMachineDR,TransmitDate)) d .s JLEpis=$g(^TMP($zn,&#34;WGMEpis&#34;,WorkGroupMachineDR,TransmitDate)) .i &#39;$l(JLEpis) q .i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,JLEpis,TransmitDate)) d ..s RetValue=JLEpis i $l(RetValue) q RetValue //通过编号规则获取当天流水号，编号规则代码设置为工作小组同样代码，通过代码获取工作小组对应的编号规则 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) //YHR 20230810 罗氏流水线规则 i $l(ZDHSEpis) d .i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ..s RetValue=ZDHSEpis .e d ..f Num=1:1:1000 d\t//避免死循环，每次进行一千次增号判断 ...s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) ...i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ....s RetValue=ZDHSEpis ....s Num=1001 i $l(RetValue) s ^TMP($zn,&#34;WGMEpis&#34;,WorkGroupMachineDR,TransmitDate)=RetValue q RetValue //未查询到编号规则，则获取当前工作小组最大流水号 s Parameter=&#34;&lt;Data&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P0&gt;&#34;_TransmitDate_&#34;&lt;/P0&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P5&gt;&lt;/P5&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P7&gt;&lt;/P7&gt;&lt;/Data&gt;&#34; s WGMEpisNo=##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(WorkGroupMachineDR,Parameter) //YHR 20250317 获取最大流水号报错问题处理 i $l(WGMEpisNo) s RetValue=WGMEpisNo q RetValue } /********************************************自动核收结束****************************************************/ } 个性化功能记录 本节点无特殊功能，可直接在其他接口使用类似功能。\n">
<meta property='og:url' content='https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/'>
<meta property='og:site_name' content='木子洋'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='罗氏仪器' /><meta property='article:published_time' content='2025-09-03T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-09-03T23:20:57&#43;00:00'/><meta property='og:image' content='https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403125731-kgqb3bk.png' />
<meta name="twitter:title" content="罗氏流水线IT3000">
<meta name="twitter:description" content="接口说明 仪器厂商 罗氏流水线\n仪器型号 IT3000\n通讯方式 主动上传\n仪器类型 生化发光流水线 医院名称 厦门翔安医院 程序名称 MI.MIFIT3000 终端服务器地址 终端服务器端口号 仪器上接口标示和接口类型 接口类型：监听文件 连接方式：抓取RESULT结果文件和SEEN处理文件 .hl7文件，上传ORDERS .hl7文件 仪器接口说明 罗氏流水线与lis交互分为处理文件 SEEN 和结果文件 RESULT 两种以及血清图片，处理文件过多，lis读取文件和解析文件同时进行，造成结果文件无法及时解析，造成仪器传了结果但是未及时读取造成无法及时发报告。针对这一问题，详细在问题处理中无法及时读取文件处理造成获取结果过慢记录。 接口中包含多种功能，包含血清图片，自动核收，报警信息存储等。详细在仪器个性功能中展示。 数据格式 修改记录 序号 日期 操作人 说明 1 2025-04-03 10:15:50\n杨浩然 仪器接口程序 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848 849 850 851 852 853 854 855 856 857 858 859 860 861 862 863 864 865 866 867 868 869 870 871 872 873 874 875 876 877 878 879 880 881 882 883 884 885 886 887 888 889 890 891 892 893 894 895 896 897 898 899 900 901 902 903 904 905 906 907 908 909 910 911 912 913 914 915 916 917 918 919 920 921 922 923 924 925 926 927 928 929 930 931 932 933 934 935 936 937 938 939 940 941 942 943 944 945 946 947 948 949 950 951 952 953 954 955 956 957 958 959 960 961 962 963 964 965 966 967 968 969 970 971 972 973 974 975 976 977 978 979 980 981 982 983 984 985 986 987 988 989 990 991 992 993 994 995 996 997 998 999 1000 1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 1011 1012 1013 1014 1015 1016 1017 1018 1019 1020 1021 1022 1023 1024 1025 1026 1027 1028 1029 1030 1031 1032 1033 1034 1035 1036 1037 1038 1039 1040 1041 1042 1043 1044 1045 1046 1047 1048 1049 1050 1051 1052 1053 1054 1055 1056 1057 1058 1059 1060 1061 1062 1063 1064 1065 1066 1067 1068 1069 1070 1071 1072 1073 1074 1075 1076 1077 1078 1079 1080 1081 1082 1083 1084 1085 1086 1087 1088 1089 1090 1091 1092 1093 1094 1095 1096 1097 1098 1099 1100 1101 1102 1103 1104 1105 1106 1107 1108 1109 1110 1111 1112 1113 1114 1115 1116 1117 1118 1119 1120 1121 1122 1123 1124 1125 /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;Z:\\\\ResultExport\\\\&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFLICA800&#34;,&#34;Para&#34;:&#34;.csv&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UpPara&#34;:&#34;Z:\\\\Imports\\\\&#34;}] Class MI.MIFIT3000N1 Extends %RegisteredObject { /// D ##class(MI.MIFInfinity).fileMTHD(&#34;7&#34;,&#34;MSH|^~\\&amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#&#34;,&#34;&#34;) /// seen: [VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR] /// result: [VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR] /// D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;&#34;,&#34;&#34;) /// seen: D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]&#34;,&#34;&#34;) /// result:D ##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]&#34;,&#34;&#34;) /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\Results,E:\\\\Temp\\\\Temp\\\\Interface\\\\Seens&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFXAIT3000&#34;,&#34;Para&#34;:&#34;.hl7&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoMAll,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealImage,PreDeal&#34;,&#34;UpPara&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\ORDERS\\\\&#34;}] /// [{&#34;MachID&#34;:&#34;#RowID&#34;,&#34;Type&#34;:&#34;Drect&#34;,&#34;UpTime&#34;:&#34;3000&#34;,&#34;Address&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\Results,E:\\\\Temp\\\\Temp\\\\Interface\\\\Seens&#34;,&#34;UpCDF&#34;:&#34;&#34;,&#34;UpREF&#34;:&#34;&#34;,&#34;DealProcess&#34;:&#34;MI.MIFXAIT3000&#34;,&#34;Para&#34;:&#34;.hl7&#34;,&#34;PreDealClass&#34;:&#34;PreDeal.DealDemoMAll,PreDeal&#34;,&#34;UPPreDealClass&#34;:&#34;PreDeal.DealDemoM,PreDeal&#34;,&#34;UpPara&#34;:&#34;E:\\\\Temp\\\\Temp\\\\Interface\\\\ORDERS\\\\&#34;}] /// D ##class(MI.MIFIT300N).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250317162926||ORU^R01^ORU_R01|20250317162926573175|P|2.5|||AL|ER[13][10]PID|1||0000486028||^郑龙怡||20000126|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^感染性疾病科[13][10]ORC|SC|1003777033|||CM||||20250317160618[13][10]OBR|1|1003777033|||||||||||||||||||||||F[13][10]OBX|1|NM|TRAB^TRAB||&lt;0.800|||LIMTL|||F|||20250317170643|E1^MU1-e801-1-2@5503[13][10]NTE|1||LIMTL[13][10]NTE|1||LIMTL[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250320102229||ORU^R01^ORU_R01|20250320102229442999|P|2.5|||AL|ER[13][10]PID|1||0000481255||^杨建利||19880623|M[13][10]PV1|1|U||||||||109|||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003782597|||CM||||20250320084145||||||||109[13][10]OBR|1|1003782597|||||||||||||||||||||||F[13][10]OBX|1|NM|GLU^GLU||8.830||||||F|||20250320100301|C2^MU1-c702-2-2@5607[13][10]OBX|2|NM|UREA^UREA||4.330||||||F|||20250320100306|C2^MU1-c702-2-1@5607[13][10]OBX|3|NM|UA^UA||434.900||||||F|||20250320100254|C2^MU1-c702-2-2@5607[13][10]OBX|4|NM|TP^TP||79.900||||||F|||20250320095858|C1^MU1-c702-1-1@5607[13][10]OBX|5|NM|ALB^ALB||46.000||||||F|||20250320095348|C1^MU1-c702-1-2@5607[13][10]OBX|6|NM|TBIL^TBIL||6.000||||||F|||20250320095923|C1^MU1-c702-1-1@5607[13][10]OBX|7|NM|DBIL^DBIL||1.800||||||F|||20250320095901|C1^MU1-c702-1-1@5607[13][10]OBX|8|NM|ALT^ALT||107.000||||||F|||20250320095900|C1^MU1-c702-1-2@5607[13][10]OBX|9|NM|AST^AST||62.300||||||F|||20250320095909|C1^MU1-c702-1-1@5607[13][10]OBX|10|NM|RGT^RGT||68.800||||||F|||20250320100259|C2^MU1-c702-2-1@5607[13][10]OBX|11|NM|ALP^ALP||83.700||||||F|||20250320095907|C1^MU1-c702-1-2@5607[13][10]OBX|12|NM|TRIGL^TRIGL||8.810||||||F|||20250320100304|C2^MU1-c702-2-2@5607[13][10]OBX|13|NM|TC^TC||4.910||||||F|||20250320100257|C2^MU1-c702-2-2@5607[13][10]OBX|14|NM|SCRE^SCRE||66.400||||||F|||20250320100313|C2^MU1-c702-2-1@5607[13][10]OBX|15|NM|9CYSC^CYSC_NEW||0.89||||||F|||20250320095916|C1^MU1-c702-1-1@5607[13][10]OBX|16|NM|9HDL^HDL_NEW||0.69||||||F|||20250320095914|C1^MU1-c702-1-2@5607[13][10]OBX|17|NM|9LDL^LDL_NEW||2.06||||||F|||20250320095921|C1^MU1-c702-1-2@5607[13][10]OBX|18|ST|XYZL^DM_SERQ||Z:脂血||||||F|||20250320083356[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250320151725||ORU^R01^ORU_R01|20250320151725880554|P|2.5|||AL|ER[13][10]PID|1||0000095425||^姚程成||19980712|M[13][10]PV1|1|U|||||||||||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003784045|||CM||||20250320104114[13][10]OBR|1|1003784045|||||||||||||||||||||||F[13][10]OBX|1|NM|TP^TP||73.600||||||F|||20250320115059|C1^MU1-c702-1-1@5095[13][10]OBX|2|NM|ALB^ALB||49.600||||||F|||20250320114553|C1^MU1-c702-1-2@5095[13][10]OBX|3|NM|TBIL^TBIL||16.400||||||F|||20250320115110|C1^MU1-c702-1-1@5095[13][10]OBX|4|NM|DBIL^DBIL||4.400||||||F|||20250320115056|C1^MU1-c702-1-1@5095[13][10]OBX|5|NM|ALT^ALT||18.100||||||F|||20250320115057|C1^MU1-c702-1-2@5095[13][10]OBX|6|NM|AST^AST||22.900||||||F|||20250320115103|C1^MU1-c702-1-1@5095[13][10]OBX|7|NM|RGT^RGT||8.900||||||F|||20250320115522|C2^MU1-c702-2-1@5095[13][10]OBX|8|NM|ALP^ALP||78.100||||||F|||20250320115105|C1^MU1-c702-1-2@5095[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250321083434||ACK^^ACK|20250321083434378641|P|2.5|||NE|NE[13][10]EQU||^^^c702^^SAMPLEEVENT^SEEN|20250321083434[13][10]SAC|||1003775669|1003775669||20250321083433|01||P|c702|5719@4[13][10]&#34;) /// D ##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\\&amp;|LIS||HOST||20250328191032||ORU^R01^ORU_R01|20250328191032737830|P|2.5|||AL|ER[13][10]PID|1||0000531818||^郑苹||19811117|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^心血管内科[13][10]ORC|SC|1003802907|||CM||||20250328191358[13][10]OBR|1|1003802907|||||||||||||||||||||||F[13][10]OBX|1|NM|U-CR^U-CR||5924.00||||||F|||20250328200846|C2^MU1-c702-2-1@4003|||||||||5924.00[13][10]OBX|2|NM|UR-MALB^UR-MALB||15.30|||OBS.RR|||F|||20250328200852|C2^MU1-c702-2-2@4003|||||||||15.30[13][10]NTE|1||OBS.RR[13][10]&#34;) /// 非流水线分区代码 Parameter FQCode = &#34;WANTAI,XINCHANYE,LINJIAN,XIEGUANG&#34;; ClassMethod fileMTHD(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),record=$g(record),epis=$g(epis),filename=$g(filename),P4=$g(P4),P5=$g(P5),P6=$g(P6),P7=$g(P7),P8=$g(P8),P9=$g(P9),P10=$g(P10),P11=$g(P11),P12=$g(P12),P13=$g(P13),Sessions=$g(Sessions) i filename[&#34;Results&#34; j ..ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) q &#34;&#34; e d ..ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) q &#34;&#34; } ClassMethod ResultDo(mi, record, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi) s epis=$g(epis) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;0&#34; s HospitalDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),4) i &#39;$l(record) q &#34;0&#34; i filename[&#34;Seens&#34; d Trace^MI.MIF000(mi,record,&#34;SeensRecord&#34;) e i filename[&#34;Results&#34; d Trace^MI.MIF000(mi,record,&#34;ResultsRecord&#34;) e d Trace^MI.MIF000(mi,record,&#34;AllRecord&#34;) s recordbak=record\t//仪器数据备份 s commandName=&#34;&#34;\t//前处理名称初始化 s commandchild=&#34;&#34; //前处理命令初始化 s DealDateStr=&#34;&#34; //MSH 时间初始化 s (sample,result,date,time,QC)=&#34;&#34; //解析多行合并数据 f i=1:1:$l(recordbak,&#34;[13][10]&#34;){ s record=$p(recordbak,&#34;[13][10]&#34;,i) ;d Trace^MI.MIF000(mi,record,&#34;解析行数据&#34;) i &#39;$l(record) q s type=$p(record,&#34;|&#34;,1)\t//取出消息头命令类型 //解析MSH命令 i type=&#34;MSH&#34;{ s DateStr=$p(record,&#34;|&#34;,7)\t//取日期串 i $l(DateStr)=14 s DealDateStr=$e(DateStr,1,8)_&#34;,&#34;_(($e(DateStr,9,10)*3600)+($e(DateStr,11,12)*60))\t//解析保存日期串 } //解析EQU命令\t包含前处理后处理指令，根据指令记录对应事件 i type=&#34;EQU&#34;{ //前处理名称\tRSA1 流水线处理信息，e801、P501_701\t仪器处理信息 s commandName=$p($p(record,&#34;|&#34;,3),&#34;^&#34;,4) //获取前处理命令，SEEN 上机事件，RESULT 前处理分区事件，RSA1 未知事件，ARCHIVE 归档事件 s commandchild=$p($p(record,&#34;|&#34;,3),&#34;^&#34;,7) ;d Trace^MI.MIF000(mi,commandchild,&#34;前处理命令&#34;) } //解析SAC命令\t根据EQU命令重获取到的前处理事件，进行LIS相关处理 //本接口包括 SEEN 自动核收，ARCHIVE 记录归档位置 i type=&#34;SAC&#34;{ s epis=$p(record,&#34;|&#34;,5)\t//取出流水号 s machCode=$p(record,&#34;|&#34;,11)\t//取出前处理分区信息或仪器信息 s positioninfo=$p(record,&#34;|&#34;,12)\t//取出位置信息 //前处理SEEN 自动核收 i commandchild=&#34;SEEN&#34;{ ;d Trace^MI.MIF000(mi,&#34;分区信息，标本号:&#34;_epis_&#34;的样本所在分区:&#34;_machCode_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) i commandName=&#34;RSA1&#34; j ..SaveRecord(epis,&#34;分区位置:&#34;_machCode_&#34;-&#34;_positioninfo,mi,&#34;100&#34;)\t//前处理分区 e j ..SaveRecord(epis,&#34;上机位置:&#34;_commandName_&#34;-&#34;_positioninfo,mi,&#34;6&#34;)\t//上机 try{d ..ZDHS(mi,epis,machCode,positioninfo)}catch ex{d Trace^MI.MIF000(mi,ex.Data,&#34;自动核收提示&#34;)}\t//自动核收 i commandName=&#34;RSA1&#34; d .i (&#34;,&#34;_..#FQCode_&#34;,&#34;)&#39;[(&#34;,&#34;_machCode_&#34;,&#34;) d\t//$TS$ 只有流水线仪器记录分区架子号 ..j ..SaveRackNo(epis,machCode_&#34;-&#34;_positioninfo,mi,&#34;分区&#34;) e j ..SaveRackNo(epis,commandName_&#34;-&#34;_positioninfo,mi,&#34;上机&#34;) } //前处理RESULT 处理分区信息 i commandchild=&#34;RESULT&#34;{ s curMachName=machCode\t//通过仪器对照码取仪器 //此处存标本全部分区预处理的位置号\t针对非流水线标本分拣 i commandName=&#34;RSA1&#34; j ..SaveRecord(epis,&#34;分区位置:&#34;_positioninfo,mi,&#34;100&#34;)\t//前处理分区 i commandName=&#34;RSA1&#34; j ..SaveRackNo(epis,positioninfo,mi,&#34;分区&#34;) } //前处理ARCHIVE 处理归档信息 i commandchild=&#34;ARCHIVE&#34;{ s curMachName=machCode\t//通过仪器对照码取仪器 //此处存标本全部审核报告的位置号 ;d Trace^MI.MIF000(mi,&#34;归档信息，标本号:&#34;_epis_&#34;的样本所在仪器:&#34;_curMachName_&#34; &#34;_positioninfo,&#34;H&lt;--M&#34;) ;d Trace^MI.MIF000(mi,epis_&#34;执行记录分类信息:&#34;_positioninfo,&#34;H&lt;--M&#34;) i commandName=&#34;RSA1&#34; d .j ..SaveRackNo(epis,positioninfo,mi,&#34;归档&#34;)\t//保存归档信息到架子号 .j ..SaveRecord(epis,&#34;冰箱归档位置:&#34;_positioninfo,mi,&#34;62&#34;)\t//冰箱归档 e d .j ..SaveRackNo(epis,positioninfo,mi,&#34;归档中&#34;)\t//保存归档信息到架子号 .j ..SaveRecord(epis,&#34;归档中位置:&#34;_positioninfo,mi,&#34;62&#34;)\t//归档 ;d Trace^MI.MIF000(mi,epis_&#34;记录归档信息完成&#34;,&#34;H&lt;--M&#34;) } } //解析质控数据,P业务数据，Q质控数据 i type=&#34;ORC&#34;{ s epis=$p(record,&#34;|&#34;,3) } i type=&#34;OBR&#34;{ s epis=$p(record,&#34;|&#34;,3) } //仪器报警信息 i type=&#34;NTE&#34;{ s WaringStr=$p(record,&#34;|&#34;,4) s WaringCode=$p(WaringStr,&#34; &#34;,2) ;d Trace^MI.MIF000(mi,&#34;仪器报警信息:&#34;_WaringStr,&#34;H&lt;--M&#34;) //保存仪器报警信息到组内报告评价 ;d ..SaveResultWarned(epis,WaringStr,mi) } try{j ##class(MI.Special.Record).RecordData(epis,recordbak,&#34;LSLSXGET&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 i type=&#34;OBX&#34;{ s machCode=$p(record,&#34;|&#34;,16)\t//仪器信息和架子号信息 s code=$p($p(record,&#34;|&#34;,4),&#34;^&#34;,1) s res=$p(record,&#34;|&#34;,6) s CallThePolice=$p(record,&#34;|&#34;,9)\t//项目报警信息 s res=..ConvertResult(code,res)\t//结果特殊转换 i $l(CallThePolice) d .s result=result_code_$c(92)_res_$c(92)_$c(92)_CallThePolice_$c(44)\t//YHR 20250328 将报警信息存入到其他结果字段 .try{j ..SaveResultWarned(epis,&#34;存在仪器报警信息&#34;,mi,&#34;41&#34;)}catch{}\t//YHR 20250329 存储报警信息标志，此处41为常规生化工作小组$TS$ e s result=result_code_$c(92)_res_$c(44) } } i $l(result) d Trace^MI.MIF000(mi,epis_&#34;$$&#34;_result,&#34;H&lt;--M&#34;) //统一保存结果 i $l(epis),$l(result){ i $l(DealDateStr){\t//如果记录到时间，则根据仪器时间存储结果。 s date=$p(DealDateStr,&#34;,&#34;,1) s time=$p(DealDateStr,&#34;,&#34;,2) i $l(date)&#39;=8 s date=&#34;&#34;,time=&#34;&#34; } d ##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC) } q &#34;&#34; } /// 结果特殊转换 /// $TS$ /// W ##CLASS(MI.MIFIT3000N1).ConvertResult(&#34;9PA&#34;,&#34;&lt;0.070&#34;) ClassMethod ConvertResult(code, res) { i code=&#34;9PA&#34; d .i $e(res)=&#34;&lt;&#34;,+$e(res,2,*)=&#34;.07&#34; d ..s res=&#34;&lt;70&#34; q res } /// 报警信息转换 ClassMethod ConvertPoliceInfo(WaringCode) { s WaringStr=&#34;&#34; i WaringCode=&#34;5&#34; s WaringStr=&#34;&gt;ABS(超出ABS)&#34; i WaringCode=&#34;43&#34; s WaringStr=&#34;Cal.E(校准结果异常)&#34; i WaringCode=&#34;2&#34; s WaringStr=&#34;&gt;Cuvet(反应杯空白异常)&#34; i WaringCode=&#34;42&#34; s WaringStr=&#34;Edit(实验结果已被编辑)&#34; i WaringCode=&#34;23&#34; s WaringStr=&#34;&gt;ISE(超出ISE范围)&#34; i WaringCode=&#34;19&#34; s WaringStr=&#34;ISE.E(ISE电压级错误)&#34; i WaringCode=&#34;56&#34; s WaringStr=&#34;&gt;Kin(Prozone错误2/运动不稳)&#34; i WaringCode=&#34;10&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; i WaringCode=&#34;11&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34; i WaringCode=&#34;6&#34; s WaringStr=&#34;&gt;Prozone(Prozone错误1)&#34; i WaringCode=&#34;4&#34; s WaringStr=&#34;Reag.S(试剂不足)&#34; i WaringCode=&#34;44&#34; s WaringStr=&#34;&gt;Rept(高出原倍复查范围)&#34; i WaringCode=&#34;45&#34; s WaringStr=&#34;&lt;Rept(低于原倍复查范围)&#34; i WaringCode=&#34;46&#34; s WaringStr=&#34;Samp.？(高出ABS最大值)&#34; i WaringCode=&#34;68&#34; s WaringStr=&#34;Samp.B(样本中有气泡)&#34; i WaringCode=&#34;72&#34; s WaringStr=&#34;Samp.C(样本中有凝块)&#34; i WaringCode=&#34;26&#34; s WaringStr=&#34;&gt;Test(高出线性范围)&#34; i WaringCode=&#34;27&#34; s WaringStr=&#34;&lt;Test(低于线性范围)&#34; q WaringStr } /// 记录标本日志 /// D ##class(MI.MIFRS600).SaveRecord(&#34;&#34;,&#34;&#34;) ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode, curWorkGroupMachineDR) { s labno=$g(labno) s OperateNotes=$g(OperateNotes) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s OperateTypeCode=$g(OperateTypeCode) i &#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型 .//BTOperatorType 标本操作类型表 .d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,&#34;,&#34;,2),&#34;&#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,&#34;&#34;) } /// 保存报告表报警信息标志 /// D ##class(MI.MIFIT3000N1).SaveResultWarned(&#34;1003803130&#34;,&#34;1&#34;,&#34;34&#34;,&#34;41&#34;) ClassMethod SaveResultWarned(labno, conclusion, predealMI, curWorkGroupMachineDR) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) i &#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) i $l(conclusion)&gt;20 s conclusion=$e(conclusion,1,20)_&#34;...&#34; s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....s objrep.ResultWarned=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .s objrep.ResultWarned=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } /// 保存评价信息(标本质量) /// D ##class(MI.MIFRS600).SaveConclusion(&#34;&#34;,&#34;&#34;) ClassMethod SaveConclusion(labno, conclusion, predealMI, curWorkGroupMachineDR, IsPrint) { s labno=$g(labno) s conclusion=$g(conclusion) s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR) s IsPrint=$g(IsPrint) i IsPrint&#39;=1 s IsPrint=&#34;0&#34;\t//1 打印主评价，0 不打印次评价 i &#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6) s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) .....i Status=&#34;3&#34; q .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i IsPrint=1 d ......i $l(objrep.MajorConclusion) s objrep.MajorConclusion=objrep.MajorConclusion_&#34;,&#34;_conclusion ......e s objrep.MajorConclusion=conclusion ......e d ......i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_&#34;,&#34;_conclusion ......e s objrep.MinorConclusion=conclusion .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i IsPrint=1 d ..s objrep.MajorConclusion=conclusion .e s objrep.MinorConclusion=conclusion .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q &#34;1&#34; } /// 保存归档,分类信息,架子号,新增保存类型和参数工作小组ID，针对仪器不在对应的工作小组也可以保存架子号。 /// D ##class(MI.Special.Common).SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) /// D ##class(MI.Special.Common).SaveRackNo(&#34;1003775669&#34;,&#34;c702-5719@4&#34;,&#34;34&#34;,&#34;上机&#34;) ClassMethod SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR) { s labno=$g(labno) s positioninfo=$g(positioninfo) s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),typename=$g(typename) i &#39;$L(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i $l(typename) s positioninfo=typename_&#34;:&#34;_positioninfo s hasFindRep=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d ..s WorkGroupMachineDR=&#34;&#34; f s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34; d ...s OrderNo=&#34;&#34; f s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34; d ....s ReportDR=&#34;&#34; f s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34; d .....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) .....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .....i $l(objrep.RackNo) j ..SaveRecord(labno,&#34;架子号位置更新:&#34;_objrep.RackNo_&#34;--&gt;&#34;_positioninfo,mi,&#34;101&#34;)\t//架子号更新 .....s objrep.RackNo=positioninfo .....s sc=objrep.%Save() .....s hasFindRep=1 .....i (&#39;$SYSTEM.Status.IsOK(sc)) d ......d Trace^MI.MIF000(mi,&#34;-1^存&#34;_typename_&#34;信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;) i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d .s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) .s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR) .i $l(objrep.RackNo) j ..SaveRecord(labno,&#34;架子号位置更新:&#34;_objrep.RackNo_&#34;--&gt;&#34;_positioninfo,mi,&#34;101&#34;)\t//架子号更新 .s objrep.RackNo=positioninfo .s sc=objrep.%Save() .s hasFindRep=1 i hasFindRep=0 d Trace^MI.MIF000(mi,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;) q hasFindRep } /// 保存标本图片 /// D ##class(MI.MIFRS600).SaveImageMTHD(&#34;57&#34;,&#34;1000100990&#34;,&#34;P&#34;,&#34;/iLISLIS080/demo.png&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) /// D ##class(MI.MIFIT3000N1).SaveImageMTHD(&#34;34&#34;,&#34;1003783657_01&#34;,&#34;1003783657_01&#34;,&#34;/iLISLIS032/20250321/1003783657_01.jpg&#34;,&#34;C:\\LISDATA\\DATA\\1003783657_01.jpg&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s ^YHR(&#34;MI.MIFIT3000&#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s mi=$g(mi) s mi=mi s ret=&#34;1&#34; s epis=$p(epis,&#34;_&#34;,1) s ImageClass=&#34;P&#34;_+$p(ImageClass,&#34;_&#34;,2) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //标本血清质量特殊处理 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis))) d .s obj=&#34;&#34; .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis),&#34;&#34;)) .i $d(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d ..s RowID=&#34;&#34; f s RowID=$o(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=&#34;&#34; d ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID) .i &#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New() .s obj.VisitNumberDR=VisitNumberDR .s obj.ImageClass=&#34;SerumQ&#34; .s obj.ImageID=ImageClass .s obj.FileName=FileName .s sc=obj.%Save() .i (&#39;$SYSTEM.Status.IsOK(sc)) d ..s ret= &#34;-1^保存报告图片失败:&#34;_$SYSTEM.Status.GetErrorText(sc) e d .d Trace^MI.MIF000(mi,epis_&#34;:&#34;_ImageClass_&#34;:&#34;_FileName,&#34;H&lt;--M&#34;) .s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=&#34;&#34; .s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence) q ret } // w ##class(MI.MIFRS600).GetFtpMTHD(&#34;24&#34;) ClassMethod GetFtpMTHD(mi, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { //文件服务模式必须改的地方，老的FTP模式这么改了也没问题，所以建议都这样 s mi=$g(mi) q ##Class(MI.Common.MIFBase).GetMiFtpPath(mi) } /// Creator： 查询患者信息，监听配置上传前处理类后会定时调用这个query查询数据进行上传操作 /// CreatDate： 20140919 /// Description:： /// Table： /// Input： mi：仪器主键 /// Output： 仪器信息 /// Return： 仪器信息 /// Others： Query QryLabInfo(mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Query(ROWSPEC = &#34;labno,labnoInfo,patInfo&#34;) { } /// Query的执行方法 /// d ##class(%ResultSet).RunQuery(&#34;MI.MIFIT3000N1&#34;,&#34;QryLabInfo&#34;,&#34;34&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) ClassMethod QryLabInfoExecute(ByRef qHandle As %Binary, mi As %String, P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %Status { Set repid=$i(^CacheTemp) Set ind=1 s mi=$g(mi),flag=$g(flag) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; s LabnoList=&#34;&#34; s VisitNumberDR=&#34;&#34; s OutPutNum=0 //*--------------------------------&gt;*申请项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:(AddDate=&#34;&#34;)||(OutPutNum&gt;6) d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:(AddTime=&#34;&#34;)||(OutPutNum&gt;6) d ..s OutPutNum=OutPutNum+1 ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..;s EpisNo=$$getEpis^MI.MIF000(labno,mi) ..;i &#39;$l(EpisNo) q ..i &#39;$l(labno) q ..i &#39;$d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno)) q ..s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..s ReceiveTime=$lg($g(^dbo.RPVisitNumberD(VisitNumberDR)),67) ..i ((+$p($h,&#34;,&#34;,2))-ReceiveTime&gt;=-2)&amp;&amp;((+$p($h,&#34;,&#34;,2))-ReceiveTime&lt;5) d Trace^MI.MIF000(mi,labno_&#34;标本接收时间低于5秒不上传&#34;,&#34;等待上传&#34;) q ..//得到通道号 ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@C&#34;\t//重新获取通道号 避免因为接收造成漏项目 ..;s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..;s labnoInfo=labno_&#34;,&#34;_$replace(TCList,&#34;\\&#34;,&#34;+&#34;)_&#34;|@U&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;申请上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;C@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** //*--------------------------------&gt;*复查结果上传 s AddDate=$zd($p($h,&#34;,&#34;,1)-2,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i &#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s TCList=$lg(^dbo.RPMachineUploadD(MiUploadDR),7) ..s labnoInfo=labno_&#34;,&#34;_$replace(TCList,&#34;\\&#34;,&#34;+&#34;)_&#34;|@U&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;复查上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;U@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** //*--------------------------------&gt;*取消项目 s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i &#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=..GetLabnoInfo(mi,labno)_&#34;@R&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;取消上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;R@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 ..//文本双向上传结束****************************************************** s AddDate=$zd($p($h,&#34;,&#34;,1)-1,8) f s AddDate=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate)) q:AddDate=&#34;&#34; d .s AddTime=&#34;&#34; f s AddTime=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34; d ..s MiUploadDR=$o(^dbo.RPMachineUploadI(&#34;IndexSendStatus&#34;,mi,##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate,AddTime,&#34;&#34;)) ..s labno=$lg(^dbo.RPMachineUploadD(MiUploadDR),3) ..i &#39;$l(labno) q ..i $l(labno) S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) ..i &#39;$l(VisitNumberDR) q ..//得到通道号 ..s chl=$lg($g(^dbo.RPMachineUploadD(MiUploadDR)),7) ..s patInfo=..GetPatInfo(mi,labno) ..s PatName=$p(patInfo,&#34;,&#34;,10) ..//文本双向上传开始****************************************************** ..//控制输出文本的内容 ..s labnoInfo=labno_&#34;,&#34;_&#34;DM_OVER&#34;_&#34;@C&#34; ..s txtInfo=..GetLabnoInfoN(mi,labnoInfo,patInfo) ..s now=$now() ..s filenametime=$zd($p(now,&#34;,&#34;,1),8)_$tr($zt($p(now,&#34;,&#34;,2)),&#34;:&#34;)_$p(now,&#34;.&#34;,2) ..s filename=filenametime_&#34;_&#34;_labno_&#34;.hl7&#34; ..s Data=##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;) ..d Trace^MI.MIF000(mi,txtInfo,&#34;审核上传信息&#34;) ..d OutputRow ..try{d ##class(MI.Special.Record).RecordData(labno,&#34;T@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}\t//YHR 20230828 记录十天的数据 Set qHandle=$lb(0,repid,0) Quit $$$OK OutputRow Set ColFields=&#34;labno,labnoInfo,patInfo&#34; Set ^CacheTemp(repid,ind)=##Class(LIS.Util.Common).TransListNull(Data,ColFields) Set ind=ind+1 quit } ClassMethod QryLabInfoClose(ByRef qHandle As %Binary) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set repid=$LIST(qHandle,2) Kill ^CacheTemp(repid) Quit $$$OK } ClassMethod QryLabInfoFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = 0) As %Status [ PlaceAfter = QryLabInfoExecute ] { Set AtEnd=$LIST(qHandle,1) Set repid=$LIST(qHandle,2) Set ind=$LIST(qHandle,3) Set ind=$o(^CacheTemp(repid,ind)) If ind=&#34;&#34; { Set AtEnd=1 Set Row=&#34;&#34; } Else { Set Row=^CacheTemp(repid,ind) } s qHandle=$lb(AtEnd,repid,ind) Quit $$$OK } /// 获取申请名称和内容 /// 申请名称： /// 发送申请：order_2012051718302501_9999999901NW.HL7 /// 取消申请：order_2012051718302501_9999999901CA.HL7 /// 项目复查：order_2012051718302501_9999999901XO.HL7 /// w ##class(MI.MIFRS600).GetLisOrderMTHD(&#34;8&#34;,&#34;POS@C@1&#34;,&#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08 -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34; ,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;) /// w ##class(MI.MIFIT300N).GetLabnoInfoN(&#34;34&#34;,&#34;1003779663,DM_OVER@C&#34;,&#34;2025-03-18□19:07:07,IT3000,,,,急诊内科,测试医生(勿选）,检验管理员,0000243381,陈耀明,1,急诊,,34,,1003779663,2025-03-18□18:24,,,,,眩晕,,,,2025-03-18□18:24,,,19900920&#34;) ClassMethod GetLabnoInfoN(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s VT=&#34;[11]&#34;,FS=&#34;[28]&#34;,CR=&#34;[13]&#34; s labNo=$p(patInfo,&#34;,&#34;,16) s Sampleno=$p(patInfo,&#34;,&#34;,3) //i labNo=&#34;74623177&#34; s ^TMP(&#34;zlzit3000d&#34;)=$lb(mi, labnoInfo, patInfo, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions) s location=$p(patInfo,&#34;,&#34;,6) s docName=$p(patInfo,&#34;,&#34;,7) s regNo=$p(patInfo,&#34;,&#34;,9) s patName=$p(patInfo,&#34;,&#34;,10) s sex=$p(patInfo,&#34;,&#34;,11) i sex=&#34;1&#34; s sex=&#34;M&#34; i sex=&#34;2&#34; s sex=&#34;F&#34; i (sex&#39;=&#34;M&#34;)&amp;&amp;(sex&#39;=&#34;F&#34;) s sex=&#34;U&#34; s birthDate=$p(patInfo,&#34;,&#34;,29) s collectTime=$p(patInfo,&#34;,&#34;,17) ;2017-08-14 11:57 s collectTime=$tr(collectTime,&#34;- :&#34;,&#34;&#34;)_&#34;00&#34; s status=$p(labnoInfo,&#34;@&#34;,2) s labnoInfo=$p(labnoInfo,&#34;@&#34;,1) s curTime=$zd($h,8)_$tr($zt($p($h,&#34;,&#34;,2)),&#34;:&#34;,&#34;&#34;) s PatType=$p(patInfo,&#34;,&#34;,12) s Wardno=$p(patInfo,&#34;,&#34;,27) s Diagnose=$p(patInfo,&#34;,&#34;,22) S patTypeFlag=&#34;RO&#34; //门诊=RO,住院=RI,体检=RC,急诊=RS I PatType=&#34;住院&#34; { S patTypeFlag=&#34;RI&#34; } I PatType=&#34;门诊&#34; { S patTypeFlag=&#34;RO&#34; } I PatType=&#34;急诊&#34; { S patTypeFlag=&#34;RS&#34; } I PatType=&#34;体检&#34; { S patTypeFlag=&#34;RC&#34; } I PatType=&#34;干诊&#34; { S patTypeFlag=&#34;RC&#34; } s AssayNo=..GetReportAssayNoMTHD(mi,labNo) s MSN=&#34;MSH|^~\\&amp;|DHC-LIS|IT3000|||||OML^O21|&#34;_$tr($zdt($h,3),&#34; &#34;&#34;:&#34;&#34;-&#34;)_&#34;SND&#34;_labNo_&#34;|P|2.3|||NE|NE||&#34; s PID=&#34;PID|1||&#34;_regNo_&#34;|&#34;_docName_&#34;|^&#34;_patName_&#34;||&#34;_birthDate_&#34;|&#34;_sex //_location s PV1=&#34;PV1|||?|||||||||||||||||&#34; s DG1=&#34;DG1|||00000^default|||F&#34; ;s IN1=&#34;IN1|||China-Bank&#34; ;s ORC=&#34;ORC|NW|&#34;_labNo_&#34;|&#34;_regNo_&#34;||||R||&#34;_$zd($h,8)_$tr($zt($h),&#34;:&#34;,&#34;&#34;)_&#34;|&#34;_docName s orcF1=&#34;NW&#34;,orcF2=&#34;&#34; i status=&#34;R&#34; s orcF1=&#34;CA&#34; i status=&#34;U&#34; s orcF1=&#34;XO&#34; s orcF2=&#34;SC&#34; s ORC=&#34;ORC|&#34;_orcF1_&#34;|&#34;_labNo_&#34;|&#34;_AssayNo_&#34;||&#34;_orcF2_&#34;||&#34;_patTypeFlag_&#34;|&#34;_location_&#34;|&#34;_..GetReceiveDateTime(labNo) //change by sch20210421 //s:orcF1&#39;=&#34;XO&#34; ORC=&#34;ORC|&#34;_orcF1_&#34;|&#34;_labNo_&#34;|&#34;_AssayNo_&#34;||&#34;_orcF2_&#34;||&#34;_patFLAG_&#34;||&#34;_$tr($zdt($h,3),&#34; &#34;&#34;:&#34;&#34;-&#34;) //_&#34;|&#34;_docName //&#34;_regNo_&#34; ;s NTE=&#34; NTE||I|Code: C1 Comment: Sample comment 1|&#34; s obrF1=&#34;A&#34; i status=&#34;U&#34; s obrF1=&#34;G&#34; //OBR||2012081501||ROCHE_AFP|||20120814160023|||9999|A s OBR=&#34;OBR||&#34;_labNo_&#34;||GLU|||||||&#34;_obrF1 //&#34;_collectTime_&#34; ;s OBX=&#34;OBX|2|ST|AHBS^6012^||45.290^Instrument flag!|mol/L| - ^^||5221^1||F|||20170816152751|356^COBAS8000B:E602C2|DATOS_PRJ^16-8月 -17^^|&#34; s OBRs=&#34;&#34; i $p(labnoInfo,&#34;@&#34;,1)=&#34;POS&#34; d .s OBRs=&#34;OBR||&#34;_labNo_&#34;||POS|||&#34;_collectTime_&#34;||||&#34;_obrF1 e d .d GetOBRs //s orderTxt=VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS s orderTxt=VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS q orderTxt GetOBRs s items=$tr($p(labnoInfo,&#34;,&#34;,2),&#34;|&#34;,&#34;&#34;) f i=1:1:$l(items,&#34;+&#34;) d .s item=$p(items,&#34;+&#34;,i) .s splitStr=$p(OBR,&#34;|&#34;,5) .s curOBR=$p(OBR,splitStr,1)_item_$p(OBR,splitStr,2) .s OBRs=OBRs_curOBR_CR q } // w ##Class(MI.MIFIT3000).GetReportAssayNoMTHD(8,&#34;1905074122&#34;) ClassMethod GetReportAssayNoMTHD(mi, labno, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { S mi= $G(mi) S labno= $G(labno) i &#39;$l(labno) q &#34;&#34; i &#39;$l(mi) q &#34;&#34; s (orderno,VisitNumberDR)=&#34;&#34; s labno=&#34;&#34;_labno s WGMDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6) i &#39;$l(WGMDR) q &#34;&#34; S VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno,&#34;&#34;)) s orderno=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WGMDR,&#34;&#34;)) i &#39;$l(orderno) q &#34;&#34; s reportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WGMDR,orderno,&#34;&#34;)) s AssayNo =$lg($g(^dbo.RPVisitNumberReportD(reportDR)),8) Q AssayNo } /// W ##class(MI.MIFIT300N).GetReceiveDateTime(&#34;1003775372&#34;) ClassMethod GetReceiveDateTime(Labnum) { q:&#39;$l(Labnum) &#34;&#34; s VisitnumberDR=&#34;&#34;,ReceiveDate=&#34;&#34;,ReceiveTime=&#34;&#34;,ReceiveDateTime=&#34;&#34; s VisitnumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,&#34;&#34;_Labnum,&#34;&#34;)) s:$l(VisitnumberDR) ReceiveDate=$lg(^dbo.RPVisitNumberD(VisitnumberDR),66) s:$l(VisitnumberDR) ReceiveTime=$lg(^dbo.RPVisitNumberD(VisitnumberDR),67) s:$l(ReceiveDate)&amp;$l(ReceiveTime) ReceiveDateTime=ReceiveDate_$tr($zt(ReceiveTime),&#34;:&#34;) q ReceiveDateTime } /// w ##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367) /// w ##Class(MI.MIFIT3000N1).GetLabnoInfo(34,&#34;8000001003&#34;) ClassMethod GetLabnoInfo(mi, labno) As %String { s mi=$g(mi),labno=$g(labno) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34; //获取项目通道号 d ScanOne^MI.MIF000(mi,labno) s tcx=&#34;&#34; s chl=&#34;&#34; f s chl=$o(^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno,chl)) q:chl=&#34;&#34; d .s tcx=tcx_chl_&#34;+&#34; s tcx=$e(tcx,1,$l(tcx)-1) k ^TMP(&#34;MIFTESTCODE&#34;,$j,mi,labno) i $l(tcx) s tcx=labno_&#34;,&#34;_tcx_&#34;|&#34; d Trace^MI.MIF000(mi,tcx,&#34;H--&gt;M&#34;) d Trace^MI.MIF000(56,&#34;共&#34;_$l(tcx,&#34;+&#34;)_&#34;个项目。&#34;_tcx,&#34;H--&gt;M&#34;) //YHR 20230816 将上传信息存入罗氏infinity仪器 q tcx } /// w ##Class(MI.MIFRS600).GetPatInfo(57,9000001912) ClassMethod GetPatInfo(mi, labno) As %String { s labno = $g(labno),mi=$g(mi) i $l(labno)=0 q &#34;&#34; s VisitNumberDR = $o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;)) i &#39;$l(VisitNumberDR) q &#34;&#34; //标本信息 s RPVisitNumberData=$g(^dbo.RPVisitNumberD(VisitNumberDR)) s LocationDR=$lg(RPVisitNumberData,22),Location=&#34;&#34; i $l(LocationDR) s Location=$lg($g(^dbo.BTLocationD(LocationDR)),3) s DoctorDR=$lg(RPVisitNumberData,23),Doctor=&#34;&#34; i $l(DoctorDR) s Doctor=$lg($g(^dbo.BTDoctorD(DoctorDR)),3) s ReceiveDate=$lg(RPVisitNumberData,66) s ReceiveTime=$lg(RPVisitNumberData,67) s ReceiveUserDR=$lg(RPVisitNumberData,68),ReceiveUser=&#34;&#34; i $l(ReceiveUserDR) s ReceiveUser=$lg($g(^dbo.SYSUserD(ReceiveUserDR)),3) s RegNo=$lg(RPVisitNumberData,3) s SurName=$lg(RPVisitNumberData,13) s GivenName=$lg(RPVisitNumberData,14) i SurName=GivenName s PatName=SurName e s PatName=SurName_GivenName s SpeciesDR=$lg(RPVisitNumberData,15),Species=&#34;&#34; i $l(SpeciesDR) s Species=$lg($g(^dbo.BTSpeciesD(SpeciesDR)),3) s AdmTypeDR=$lg(RPVisitNumberData,4),AdmType=&#34;&#34; i $l(AdmTypeDR) s AdmType=$lg($g(^dbo.BTAdmissionTypeD(AdmTypeDR)),3) s BedNo=$lg(RPVisitNumberData,27) s Age=$lg(RPVisitNumberData,18) s BirthDate=$lg(RPVisitNumberData,16) s AgeUnitDR=$lg(RPVisitNumberData,19),AgeUnit=&#34;&#34; i $l(AgeUnitDR) s AgeUnit=$lg($g(^dbo.BTAgeUnitD(AgeUnitDR)),3) s CollectDate=$lg(RPVisitNumberData,51) s CollectTime=$lg(RPVisitNumberData,52) s Diagnose=$lg(RPVisitNumberData,28) s Sampleda=$zd($p($h,&#34;,&#34;,1),3)_&#34; &#34;_$zt($p($h,&#34;,&#34;,2)) s Instrument = &#34;XN&#34; i $l(mi) s Instrument=$lg(^dbo.BTMIMachineParameterD(mi),22) i $l(Instrument) s Instrument=$tr(Instrument,&#34;,&#34;,&#34;^&#34;) s Sampleno=$lg(RPVisitNumberData,6) //病案号 s Sampletype=&#34;&#34; s Feetype=&#34;&#34; ;费别 s Srcdepno=Location ;送检科室 s Srcdocno=Doctor ;送检医生 s Userno=ReceiveUser ;检验医生(录入者) s Patno=RegNo ;登记号 &#34;&#34; s BarCode=&#34;&#34; s Patna=PatName ;病人姓名 s Sex=1 ;性别 i Species=&#34;男&#34; s Sex=&#34;1&#34; ;1:男 ，2 女 i Species =&#34;女&#34; s Sex=&#34;2&#34; s Pattype=AdmType ;病人类型 s Bedno = BedNo ;床号 s Patage=Age ;年龄 s Ageunit=&#34;&#34; ;年龄单位 s Reqno=labno ;申请号 = 检验号 s Reqda=&#34;&#34; i $l(ReceiveDate) s Reqda=$e(ReceiveDate,1,4)_&#34;-&#34;_$e(ReceiveDate,5,6)_&#34;-&#34;_$e(ReceiveDate,7,8)_&#34; &#34;_$zt(ReceiveTime,2) ;送检日期 = 接收时间 s Reportda=&#34;&#34; ;报告日期 = 初审(保存结果)时间 s Printflag=&#34;&#34; ;打印标志 s Resultflag=&#34;&#34; ;结果标志 s Errflag=&#34;&#34; ;错误标志 s Diagnose = Diagnose ;诊断 s Description=&#34;&#34; ;备注 s Reserve=&#34;&#34; ;保留字段 s Patnamn=&#34;&#34; ;姓名拼音码 i $l(CollectDate) s Getda=$e(CollectDate,1,4)_&#34;-&#34;_$e(CollectDate,5,6)_&#34;-&#34;_$e(CollectDate,7,8)_&#34; &#34;_$zt(CollectTime,2) e s Getda=Reqda ;接收时间/采样日期 s Wardno=&#34;&#34; s WardnoDR=$lg(RPVisitNumberData,26) ;病区 i $l(WardnoDR) s Wardno=$lg($g(^dbo.BTWardD(WardnoDR)),3) s RetString=&#34;&#34; s RetString=$tr(Sampleda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Instrument,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampleno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sampletype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Feetype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdepno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Srcdocno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Userno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patna,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Sex,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Pattype,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Bedno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Patage,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Ageunit,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reqda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Reportda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Printflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Resultflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Errflag,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Diagnose,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Description,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Reserve,&#34;,&#34;,&#34;&#34;)_&#34;,&#34; s RetString=RetString_$tr(Patnamn,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Getda,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(Wardno,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BarCode,&#34;,&#34;,&#34;&#34;)_&#34;,&#34;_$tr(BirthDate,&#34;,&#34;,&#34;&#34;) q RetString } /// 监听做上传操作后调用改方法设置标本上传表状态 ClassMethod SaveSDFMTHD(mi, labno, epis, filename, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String { s mi=$g(mi),labno=$g(labno),epis = $g(epis),filename=$g(filename) i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q s ret=##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename) q } /********************************************自动核收开始****************************************************/ /// 仪器主键，条码号，前处理标本分区标识，仪器信息(位置) /// w ##class(MI.MIFIT3000N1).ZDHS(&#34;34&#34;,&#34;8000000352&#34;,&#34;WANTAI&#34;) /// w ##class(MI.MIFIT300N).ZDHS(&#34;34&#34;,&#34;1003779663&#34;,&#34;RSA1&#34;) ClassMethod ZDHS(mi, Labno, MachineCode, positioninfo) { s mi=$g(mi),Labno=$g(Labno),machCode=$g(MachineCode),positioninfo=$g(positioninfo) i &#39;$l(Labno) q &#34;&#34; /*----------&gt;判断该标本是否已接收未核收 开始&lt;----------*/ s QuitFlag=0 i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##class(LIS.Util.Common).IndexData(Labno))) d .s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##class(LIS.Util.Common).IndexData(Labno),&#34;&#34;)) .i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) s QuitFlag=1 i QuitFlag=1 q &#34;&#34; /*----------&gt;判断该标本是否已接收未核收 结束&lt;----------*/ s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)\t//得到当前仪器关联工作小组信息 s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4) s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5) s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13)\t//得到仪器工作小组的核收类型 //AcceptFlag为1认为是前处理工作小组，如果是前处理小组，就认为上前处理\t本接口未设置前处理工作小组，未对此流程进行测试 i AcceptFlag=&#34;1&#34; d QCLZDHS e d ZDHS q &#34;&#34; ZDHS d Trace^MI.MIF000(mi,&#34;上仪器,标本号:&#34;_Labno_&#34;的标本在:&#34;_curMachName_&#34;,分区位置:&#34;_MachineCode_&#34;,样本所在:&#34;_positioninfo,&#34;自动核收&#34;) //根据前处理标本分区进行分区自动核收，并且根据分区代码是否核收进行区分 //本接口认为 默认认为罗氏流水线核收，如果分区代码中包含 【BHS】则认为标本不核收，此块代码将仪器传过来的分区代码进行归类 //本接口关联标本分区， WANTAI 万泰--&gt;W，XINCHANYE 新产业--&gt;X，LINJIAN 临检凝血--&gt;L，XIEGUANG 携光--&gt;R，罗氏--&gt;Y，不核收--&gt;N s HsFlag=&#34;Y&#34;,WorkGroupMachineDR=&#34;&#34; i (MachineCode[&#34;WANTAI&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;WANTAI&#34;,&#34;&#34;) .s HsFlag=&#34;W&#34; .s WorkGroupMachineDR=48\t//未核收且分区是WANTAI i (MachineCode[&#34;XINCHANYE&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;XINCHANYE&#34;,&#34;&#34;) .s HsFlag=&#34;X&#34; .s WorkGroupMachineDR=50\t//未核收且分区是XINCHANYE i (MachineCode[&#34;LINJIAN&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;LINJIAN&#34;,&#34;&#34;) .s HsFlag=&#34;L&#34; .s WorkGroupMachineDR=9\t//未核收且分区是LINJIAN i (MachineCode[&#34;XIEGUANG&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d .S MachineCode=$REPLACE(MachineCode,&#34;XIEGUANG&#34;,&#34;&#34;) .s HsFlag=&#34;R&#34; .s WorkGroupMachineDR=67\t//未核收且分区是XIEGUANG i (MachineCode[&#34;BHS_&#34;) d\t;BHS_WANTAI .S MachineCode=$REPLACE(MachineCode,&#34;BHS_&#34;,&#34;&#34;) .s HsFlag=&#34;N&#34; i MachineCode=&#34;C_C8K886&#34; s MachineCode=&#34;C801&#34; i MachineCode=&#34;C_C8K77&#34; s MachineCode=&#34;C701&#34; i MachineCode=&#34;C8K886&#34; s MachineCode=&#34;C801&#34; i MachineCode=&#34;C8K77&#34; s MachineCode=&#34;C701&#34; i HsFlag=&#34;Y&#34; d .s WorkGroupMachineDR=41\t//未核收且分区不包含BHS_\t默认核收到罗氏流水线 i &#39;$l(WorkGroupMachineDR) q s ret=..ReceiveLabNoByWGM(WorkGroupMachineDR,Labno,$zd(+$h,8)) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) i ret&#39;=&#34;1&#34; d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = &#34;WG-&#34;_WorkGroupDR\t//自动核收出错显示再对应的工作组 .s SendRet=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收失败&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_Labno_&#34;前处理核收失败:&#34;_ret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) j ..SaveRecord(Labno,&#34;自动核收:&#34;_ret,&#34;&#34;,&#34;14&#34;,WorkGroupMachineDR) q ret QCLZDHS d Trace^MI.MIF000(mi,&#34;上前处理，鉴定号:&#34;_Labno_&#34;的标本在:&#34;_curMachName_&#34;,样本所在:&#34;_positioninfo,&#34;DealInfo&#34;) d Trace^MI.MIF000(mi,&#34;执行核收到前处理&#34;,&#34;DealInfo&#34;) //此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志 s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,Labno,&#34;&#34;) d Trace^MI.MIF000(mi,Labno_&#34;核收到前处理返回信息:&#34;_dealret,&#34;DealInfo&#34;) //记录位置信息到报告位置号 d ..SaveRackNo(Labno,positioninfo,mi) i dealret[&#34;标本已核收&#34; q i dealret=&#34;1&#34; d .//写标本操作日志 .d ..SaveRecord(Labno,machCode,mi,&#34;5&#34;) e d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = &#34;WG-&#34;_CurWorkGroupDR .s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收失败&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_Labno_&#34;前处理核收失败:&#34;_dealret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) .//写标本操作日志 .d ..SaveRecord(Labno,dealret,mi,&#34;100&#34;) q } /// Others w ##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(&#34;3&#34;,&#34;1000004476&#34;,&#34;20191105&#34;) /// 按工作小组核收医嘱 /// INPUT: MachID:仪器主键，LabNo：条码号，TransmitDate：上机日期（不传默认当天） /// OutPut: RetValue:1成功 ClassMethod ReceiveLabNoByWGM(WorkGroupMachineDR As %String, LabNo As %String, TransmitDate, RackNo, RuleCode) As %String { s WorkGroupMachineDR=$g(WorkGroupMachineDR) s LabNo=$g(LabNo) s TransmitDate=$g(TransmitDate) s RuleCode=$g(RuleCode) s RackNo=$g(RackNo) s NowDate=$zd($h,8) s RetValue=1 i &#39;$l(TransmitDate) s TransmitDate=NowDate i &#39;$l(WorkGroupMachineDR) q 100 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s WorkGroupMachineName=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4) s DepartmentDR=$lg(^dbo.BTWorkGroupD(WorkGroupDR),4) s HospitalDR=$lg(^dbo.BTDepartmentD(DepartmentDR),4) s WorkGroupMachineDesc=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3) s IndexOperateType=##class(LIS.Util.Common).IndexData(&#34;H&#34;) s AutoDR=$O(^dbo.RPWGMachineAutoI(&#34;IndexOperateType&#34;,IndexOperateType,WorkGroupMachineDR,&#34;&#34;)) i &#39;$l(AutoDR) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未设置自动核收&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未设置自动核收！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未设置自动核收！&#34; } s MachineAutoData=$g(^dbo.RPWGMachineAutoD(AutoDR)) s IsOpen=$LG(MachineAutoData,4) i IsOpen&#39;=1 { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未开启自动核收&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未开启自动核收！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未开启自动核收！&#34; } s CurrentDate = $p($h,&#34;,&#34;,1) s Currenttime = $p($h,&#34;,&#34;,2) //开始时间 s StartDate=$lg(MachineAutoData,5) i $l(StartDate) s StartDate= $zdh(StartDate,8) s StartTime=$lg(MachineAutoData,6) //结束时间 s EndDate=$lg(MachineAutoData,7) i $l(EndDate) s EndDate= $zdh(EndDate,8) s EndTime=$lg(MachineAutoData,8) //时间类型 s TimeType=$lg(MachineAutoData,9) i TimeType=&#34;CT&#34; //连续 { i (CurrentDate&lt;StartDate)||(($l(StartTime))&amp;&amp;(CurrentDate=StartDate)&amp;&amp;(Currenttime&lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期未生效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期未生效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期未生效！&#34; } i (CurrentDate&gt;EndDate)||(($l(EndTime))&amp;&amp;(CurrentDate=EndDate)&amp;&amp;(Currenttime&gt;EndTime) ) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期已失效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期已失效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期已失效！&#34; } } i TimeType=&#34;TS&#34; //时间段 { i (CurrentDate&lt;StartDate)||(($l(StartTime))&amp;&amp;(Currenttime&lt;StartTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期未生效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期未生效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期未生效！&#34; } i (CurrentDate&gt;EndDate)||(($l(EndTime))&amp;&amp;(Currenttime&gt;EndTime)) { s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() s perUser = &#34;WG-&#34;_WorkGroupDR s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期已失效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期已失效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期已失效！&#34; } } s AcceptUserDR=&#34;&#34; i $l(AutoDR) s AcceptUserDR=$LG($g(^dbo.RPWGMachineAutoD(AutoDR)),10) i &#39;$l(AcceptUserDR) d .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New() .s perUser = &#34;WG-&#34;_WorkGroupDR .s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未设置负责人&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未设置核收负责人！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser) i &#39;$l(AcceptUserDR) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未设置核收负责人！&#34; s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11) ///判断医嘱是否核收 S AcceptFlag=0 s IsSpecialFlag=0 s CheckItemList=&#34;&#34; s PreReportDR=&#34;&#34; k TestSetList s LabNoType=##Class(LISSP.DHCRPVisitNumber).GetLabNoType(LabNo) s WebNamespace=##Class(OTH.SYSParameter).GetWebNamespace() i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo))){ s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo),&#34;&#34;)) S TestSetDR=&#34;&#34; f { s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR)) q:TestSetDR=&#34;&#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR,&#34;&#34;)) i $l(RowID){ s TestSetGroup=&#34;Default&#34; //工作小组下分组类型 s WGMDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),5) i &#39;$l(WGMDR) s CheckItemList=TestSetDR_CheckItemList S AccpetReportDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11) I $L(AccpetReportDR) s AccpetWGMDR=$LG($G(^dbo.RPVisitNumberReportD(AccpetReportDR)),4) I $LG($g(^dbo.BTWorkGroupMachineD(AccpetWGMDR)),13)&#39;=1 continue s AcceptFlag=0 I $L(WGMDR) S AcceptFlag=$LG($g(^dbo.BTWorkGroupMachineD(WGMDR)),13) //是否是前处理小组 I AcceptFlag=1 S PreReportDR= $LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11),IsSpecialFlag=1 I AcceptFlag=1,$D(^dbo.BTTestSetWorkGroupMachineI(&#34;IndexMaster&#34;,TestSetDR,WorkGroupMachineDR)) { //处理报告分组信息 i $d(^dbo.BTWorkGroupMachineRuleTSI(&#34;IndexTestSet&#34;,TestSetDR)) { s WorkGroupMachineRuleDR=&#34;&#34; f{ s WorkGroupMachineRuleDR=$o(^dbo.BTWorkGroupMachineRuleTSI(&#34;IndexTestSet&#34;,TestSetDR,WorkGroupMachineRuleDR)) q:WorkGroupMachineRuleDR=&#34;&#34; s GroupWGMDR=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),4) s IsShow=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),5) i WorkGroupMachineDR&#39;=GroupWGMDR continue i IsShow=&#34;1&#34; continue s TestSetGroup=WorkGroupMachineRuleDR } } s TestSetList(TestSetGroup,TestSetDR)=&#34;&#34; } } } } s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo),&#34;&#34;)) //前处理标本核收 i IsSpecialFlag=1 { I &#39;$D(TestSetList) s RetValue=&#34;-1^无可核收医嘱&#34; q RetValue s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) Set $ZTrap = &#34;ErrorHandle&#34; TSTART s MajorConclusion=&#34;&#34;,OldEpi=&#34;&#34;,MiniConclusion=&#34;&#34; i $l(PreReportDR) s MajorConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),40),MiniConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),41),OldEpi=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),8) s maxEpis=OldEpi s TestSetGroup=&#34;&#34; f{ s TestSetGroup=$o(TestSetList(TestSetGroup)) q:TestSetGroup=&#34;&#34; s objVisitNumberReport=##class(dbo.RPVisitNumberReport).%New() s objVisitNumberReport.VisitNumberDR=VisitNumberDR s objVisitNumberReport.TransmitDate=TransmitDate s objVisitNumberReport.WorkGroupMachineDR=WorkGroupMachineDR S objVisitNumberReport.MajorConclusion=MajorConclusion s objVisitNumberReport.MinorConclusion=MiniConclusion S OrderNo=1 if $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,&#34;1&#34;)) { s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,&#34;&#34;),-1) s OrderNo=(OrderNo +1) } s AssayNo=&#34;&#34; s objVisitNumberReport.OrderNo=OrderNo i ((CommDirection=&#34;UP&#34;)||(CommDirection=&#34;BI&#34;)) s AssayNo=LabNo i &#39;$l(AssayNo) s AssayNo=maxEpis s objVisitNumberReport.AccessionNo=&#34;&#34; ///细菌分离号 s objVisitNumberReport.AssayNo=AssayNo s objVisitNumberReport.EpisodeNo=maxEpis i $l(maxEpis) s ^DHCLABWGMEPSIDERECORD(&#34;WGM&#34;,WorkGroupMachineDR,TransmitDate,maxEpis)=&#34;&#34; s objVisitNumberReport.AcceptDate=$tr($zd(+$h,3),&#34;-&#34;) s objVisitNumberReport.AcceptTime=$p($h,&#34;,&#34;,2) s objVisitNumberReport.AcceptUserDR=AcceptUserDR i $l(RackNo) s objVisitNumberReport.RackNo=RackNo s objVisitNumberReport.Status=1 //报告状态(1登记，2初审，3审核，4复查，5取消审核，6作废，O其他) s ret=objVisitNumberReport.%Save() If ($SYSTEM.Status.IsOK(ret)) {s RetValue=1 } Else {s err=&#34;报告生成失败:&#34;_$SYSTEM.Status.GetErrorText(ret) s RetValue=&#34;-1^&#34;_err q } I &#39;$D(TestSetList(TestSetGroup)) s RetValue=&#34;-1^无可核收医嘱&#34; q s TestSetDR=&#34;&#34; F { s TestSetDR=$o(TestSetList(TestSetGroup,TestSetDR)) q:TestSetDR=&#34;&#34; s RowID=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR,&#34;&#34;)) i $l(RowID){ //修改标本医嘱核收工作小组 s objTestSets=##class(dbo.RPVisitNumberTestSet).%OpenId(RowID) s objTestSets.VisitNumberReportDR=objVisitNumberReport.RowID s objTestSets.WorkGroupMachineDR=WorkGroupMachineDR s sc=objTestSets.%Save() If (&#39;$SYSTEM.Status.IsOK(sc)) { s RetValue=$SYSTEM.Status.GetErrorText(sc) Quit } //按医嘱生成报告项目结果 s RetValue=##Class(LISSP.DHCRPVisitNumberReport).SaveReportTestCode(objVisitNumberReport.RowID,TestSetDR) i RetValue&#39;=1 q } } } i RetValue&#39;=1 TROLLBACK Quit RetValue //删除前处理报告 i $l(PreReportDR),&#39;$d(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,PreReportDR)){ s sc=##class(dbo.RPVisitNumberReport).%DeleteId(PreReportDR) If (&#39;$SYSTEM.Status.IsOK(sc)){s RetValue=&#34;删除报告信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc) } } i RetValue&#39;=1 TROLLBACK Quit RetValue TCOMMIT i $l(WorkGroupMachineDR),$l(maxEpis) s ret=##Class(HIS.DHCCommon).SaveWorkGroupMachineEpis(WorkGroupMachineDR,TransmitDate,maxEpis,&#34;&#34;) } else { //普通标本核收 s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate) s Flag=1\t//YHR 20250319 仪器自动核收标志，为1的话，不影响工作小组手动核收序号 s Param=&#34;&lt;Data&gt;&lt;P0&gt;H&lt;/P0&gt;&#34; s Param=Param_&#34;&lt;P1&gt;&#34;_LabNo_&#34;&lt;/P1&gt;&lt;P2&gt;&lt;/P2&gt;&#34; s Param=Param_&#34;&lt;P3&gt;&#34;_maxEpis_&#34;&lt;/P3&gt;&#34; s Param=Param_&#34;&lt;P4&gt;&#34;_AcceptUserDR_&#34;&lt;/P4&gt;&lt;P5&gt;&lt;/P5&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P7&gt;&lt;/P7&gt;&#34; s Param=Param_&#34;&lt;P8&gt;&#34;_WorkGroupMachineDR_&#34;&lt;/P8&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P12&gt;&#34;_RackNo_&#34;&lt;/P12&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P14&gt;@@1@@&#34;_Flag_&#34;&lt;/P14&gt;&lt;/Data&gt;&#34; s Sessions=AcceptUserDR_&#34;^&#34;_WorkGroupDR_&#34;^^^&#34;_HospitalDR b ;a KSZDHS s ret=##Class(LISSP.DHCRPVisitNumber).ReceiveVisitNumber(LabNo,Param,Sessions) i $p(ret,&#34;^&#34;,1)&#39;=&#34;1&#34; s RetValue=ret } q RetValue ErrorHandle TROLLBACK s RetValue=&#34;-1^错误&#34;_$tr($ZERROR,&#34;^&#34;,&#34;--&#34;)_&#34;.错误代码:&#34;_$ECODE Quit RetValue } /// Creator： YHR /// CreatDate： 20250320 /// Description： 通过编号规则获取工作小组最大流水号 /// Table： dbo.RPVisitNumberReport /// Input： 工作小组，日期(只能获取当天的，编号规则隔天后会刷新) /// Output： 无 /// Return： 失败:&#34;&#34; 成功:流水号 /// Others\t【原】w ##Class(LIS.Common.DHCVisitNumber).GetMaxMiEpisodeNo(&#34;41&#34;,&#34;20250319&#34;) /// k ^TMP(&#34;MI.MIFIT3000N1.1&#34;,&#34;WGMEpis&#34;,&#34;41&#34;) /// w ##Class(MI.MIFIT3000N1).GetMaxMiEpisodeNo(&#34;41&#34;,&#34;20250319&#34;) ClassMethod GetMaxMiEpisodeNo(WorkGroupMachineDR As %String, TransmitDate As %String) As %String { S TransmitDate=$g(TransmitDate) S WorkGroupMachineDR=$G(WorkGroupMachineDR) S RetValue=&#34;&#34; i &#39;$l(WorkGroupMachineDR) q RetValue i &#39;$l(TransmitDate) s TransmitDate=$zd($h,8) s TransmitDate=$tr(TransmitDate,&#34;-&#34;) //记录该工作小组当天最大的流水号，如果有记录，则优先判断是否核收成功，如果未核收成功仍旧使用该号码 i $d(^TMP($zn,&#34;WGMEpis&#34;,WorkGroupMachineDR,TransmitDate)) d .s JLEpis=$g(^TMP($zn,&#34;WGMEpis&#34;,WorkGroupMachineDR,TransmitDate)) .i &#39;$l(JLEpis) q .i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,JLEpis,TransmitDate)) d ..s RetValue=JLEpis i $l(RetValue) q RetValue //通过编号规则获取当天流水号，编号规则代码设置为工作小组同样代码，通过代码获取工作小组对应的编号规则 s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2) s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) //YHR 20230810 罗氏流水线规则 i $l(ZDHSEpis) d .i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ..s RetValue=ZDHSEpis .e d ..f Num=1:1:1000 d\t//避免死循环，每次进行一千次增号判断 ...s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) ...i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d ....s RetValue=ZDHSEpis ....s Num=1001 i $l(RetValue) s ^TMP($zn,&#34;WGMEpis&#34;,WorkGroupMachineDR,TransmitDate)=RetValue q RetValue //未查询到编号规则，则获取当前工作小组最大流水号 s Parameter=&#34;&lt;Data&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P0&gt;&#34;_TransmitDate_&#34;&lt;/P0&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P5&gt;&lt;/P5&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P7&gt;&lt;/P7&gt;&lt;/Data&gt;&#34; s WGMEpisNo=##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(WorkGroupMachineDR,Parameter) //YHR 20250317 获取最大流水号报错问题处理 i $l(WGMEpisNo) s RetValue=WGMEpisNo q RetValue } /********************************************自动核收结束****************************************************/ } 个性化功能记录 本节点无特殊功能，可直接在其他接口使用类似功能。\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://work.717170.xyz/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403125731-kgqb3bk.png' />
    <link rel="shortcut icon" href="/favicon.ico" />




<script src="/js/mammoth.browser.min.js"></script>
<script src="/js/xlsx.full.min.js"></script>
<script src="/js/pdf.min.js"></script>


<script src="/js/optimized-parsing.js"></script>


<script>
    
    window.WORKER_PATH = '/js/parser.worker.js';
</script>
    
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/touxiang_hu_3261c9b36eb249a9.jpg" width="300"
                            height="285" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">木子洋</a></h1>
            <h2 class="site-description">To be or not to be.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/muziyangg'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://gitee.com/muziyangg'
                        target="_blank"
                        title="Gitee"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1756364241553" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1459" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M739.76 462H484.2a22.22 22.22 0 0 0-22.2 22.21v55.56A22.24 22.24 0 0 0 484.19 562h155.57A22.22 22.22 0 0 1 662 584.22v11.11A66.67 66.67 0 0 1 595.31 662H384.19A22.22 22.22 0 0 1 362 639.79V428.68A66.67 66.67 0 0 1 428.64 362h311.07a22.21 22.21 0 0 0 22.22-22.2v-55.56A22.22 22.22 0 0 0 739.79 262h-311.1A166.67 166.67 0 0 0 262 428.68v311.1A22.22 22.22 0 0 0 284.22 762H612a150 150 0 0 0 150-150V484.23A22.23 22.23 0 0 0 739.77 462z m0 0" fill="#231815" p-id="1460"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>首页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/link/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                <div class="widget search-widget">
    <div class="search-box">
        <form class="search-form widget">
            <p>
                <input type="text" class="search-input" placeholder="搜索本页内容..." />
                <button type="button" title="搜索" class="search-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.33" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </p>
        </form>
        <div class="search-results" style="display: none !important;"></div>
        <div class="search-stats"></div>
    </div>
    
    <div class="search-navigation">
        <button class="nav-button" id="prev-match" aria-label="上一个匹配项">
            <img src="/icons/up.svg" alt="上一个匹配项" width="16" height="16">
        </button>
        <span id="match-counter"></span>
        <button class="nav-button" id="next-match" aria-label="下一个匹配项">
            <img src="/icons/down.svg" alt="下一个匹配项" width="16" height="16">
        </button>
    </div>
</div>

<style>
 
.search-widget {
    margin-bottom: 20px;
}

.search-box {
    position: relative;
}

.search-form {
    position: relative;
    --button-size: 80px;
    margin-bottom: 1rem;
}

.search-form.widget {
    --button-size: 60px;
}

.search-form.widget input {
    padding: 15px 20px;
    height: auto;
}

.search-form p {
    position: relative;
    margin: 0;
    display: flex;
    flex-direction: column;
}

.search-input {
    padding: 15px 20px;
    border-radius: 12px;
    background-color: var(--card-background);
    box-shadow: var(--shadow-l1);
    color: var(--card-text-color-main);
    width: 100%;
    border: 1px solid var(--card-border-color);
    -webkit-appearance: none;
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
    font-size: 1.5rem !important;
    min-height: 48px;
}

.search-input::placeholder {
    font-size: 1.5rem;
    color: var(--card-text-color-tertiary);
    opacity: 1;
}

.search-input:focus {
    outline: 0;
    box-shadow: var(--shadow-l2);
    border-color: var(--primary-color);
}

.search-button {
    position: absolute;
    right: 0;
    top: 24px;
    height: 48px;
    width: var(--button-size);
    cursor: pointer;
    background-color: transparent;
    border: 0;
    padding: 0 10px;
}

.search-button:focus svg {
    stroke-width: 2;
    color: var(--accent-color);
}

.search-button svg {
    color: var(--card-text-color-secondary);
    stroke-width: 1.33;
    transition: all 0.3s ease;
    width: 20px;
    height: 20px;
}

.search-stats {
    margin-top: 8px;
    font-size: 14px;
    color: var(--card-text-color-tertiary);
}

.search-navigation {
    display: none;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding: 8px;
    background: var(--card-background-secondary);
    border-radius: var(--card-border-radius);
}

.nav-button {
    padding: 5px 10px;
    background: #2c559c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
}

.nav-button:hover {
    background: #1e3d76;
}

.nav-button:disabled {
    background: var(--card-text-color-tertiary);
    cursor: not-allowed;
}

.nav-button img {
    filter: invert(70%);
    transition: all 0.2s ease;
}

.nav-button:hover img {
    opacity: 0.9;
}

.nav-button:disabled img {
    filter: invert(40%);
}

#match-counter {
    font-size: 14px;
    color: var(--card-text-color-tertiary);
}

.search-highlight {
    background-color: #ffeb3b;
    padding: 0 2px;
    border-radius: 3px;
    transition: background-color 0.2s ease;
}

.search-highlight.current {
    background-color: #ff9800;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('.search-widget .search-input');
    const searchResults = document.querySelector('.search-widget .search-results');
    const searchStats = document.querySelector('.search-widget .search-stats');
    const searchNav = document.querySelector('.search-widget .search-navigation');
    const prevButton = document.querySelector('.search-widget #prev-match');
    const nextButton = document.querySelector('.search-widget #next-match');
    const matchCounter = document.querySelector('.search-widget #match-counter');
    const searchForm = document.querySelector('.search-form');
    const searchButton = document.querySelector('.search-button');
    
    let currentMatches = [];
    let currentMatchIndex = -1;
    let searchDebounceTimer = null;
    const DEBOUNCE_DELAY = 1000;
    
    
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
    });
    
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            handleSearchInput(searchTerm);
        }, DEBOUNCE_DELAY);
    });
    
    
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); 
            const searchTerm = this.value.trim();
            
            
            clearTimeout(searchDebounceTimer);
            
            
            if (currentMatches.length > 0) {
                currentMatchIndex = (currentMatchIndex + 1) % currentMatches.length;
                navigateToMatch();
            } 
            
            else if (searchTerm.length >= 1) {
                handleSearchInput(searchTerm);
            }
        }
    });
    
    
    searchButton.addEventListener('click', function() {
        clearTimeout(searchDebounceTimer);
        const searchTerm = searchInput.value.trim();
        handleSearchInput(searchTerm);
    });
    
    
    function handleSearchInput(term) {
        if (term.length < 1) {
            resetSearch();
            return;
        }
        performSearch(term);
    }
    
    
    function resetSearch() {
        searchResults.style.display = 'none';
        searchNav.style.display = 'none';
        clearHighlights();
        currentMatches = [];
        currentMatchIndex = -1;
        searchStats.textContent = '';
    }
    
    
    function performSearch(term) {
        clearHighlights();
        currentMatches = [];
        currentMatchIndex = -1;
        
        const articleContent = document.querySelector('.article-content');
        if (!articleContent) return;
        
        const textNodes = getTextNodes(articleContent);
        
        textNodes.forEach(node => {
            const text = node.textContent;
            const regex = new RegExp(term, 'gi');
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                if (match.index >= 0 && match.index + match[0].length <= text.length) {
                    currentMatches.push({
                        node: node,
                        offset: match.index,
                        length: match[0].length,
                        text: match[0]
                    });
                }
                if (match.index === regex.lastIndex) {
                    regex.lastIndex++;
                }
            }
        });
        
        displaySearchResults(term);
        highlightMatches();
        updateNavigation();
        
        
        if (currentMatches.length > 0) {
            currentMatchIndex = 0;
            navigateToMatch();
        }
    }
    
    
    function getTextNodes(element) {
        const textNodes = [];
        const walker = document.createTreeWalker(
            element, 
            NodeFilter.SHOW_TEXT, 
            {
                acceptNode: function(node) {
                    if (node.parentNode.classList.contains('search-highlight') ||
                        node.parentNode.tagName === 'CODE' || 
                        node.parentNode.tagName === 'PRE') {
                        return NodeFilter.FILTER_REJECT;
                    }
                    if (node.textContent.trim().length === 0) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    return NodeFilter.FILTER_ACCEPT;
                }
            }
        );
        
        let node;
        while ((node = walker.nextNode())) {
            textNodes.push(node);
        }
        
        return textNodes;
    }
    
    
    function displaySearchResults(term) {
        if (currentMatches.length === 0) {
            searchStats.textContent = `未找到"${term}"的匹配结果`;
            searchNav.style.display = 'none';
            return;
        }
        
        searchStats.textContent = `找到${currentMatches.length}个"${term}"的匹配结果`;
        searchNav.style.display = 'flex';
    }
    
    
    function highlightMatches() {
        currentMatches.forEach(match => {
            try {
                const node = match.node;
                const textLength = node.textContent.length;
                
                if (match.offset < 0 || match.offset >= textLength) {
                    console.warn('无效的匹配偏移量', match);
                    return;
                }
                
                const endOffset = Math.min(match.offset + match.length, textLength);
                
                const range = document.createRange();
                range.setStart(node, match.offset);
                range.setEnd(node, endOffset);
                
                const highlight = document.createElement('span');
                highlight.className = 'search-highlight';
                range.surroundContents(highlight);
            } catch (e) {
                console.error('高亮匹配项失败:', e, match);
            }
        });
    }
    
    
    function clearHighlights() {
        const highlights = document.querySelectorAll('.search-highlight');
        highlights.forEach(highlight => {
            const parent = highlight.parentNode;
            const textNode = document.createTextNode(highlight.textContent);
            parent.replaceChild(textNode, highlight);
            parent.normalize();
        });
    }
    
    
    function updateNavigation() {
        matchCounter.textContent = currentMatches.length > 0 ? 
            `${currentMatchIndex + 1} / ${currentMatches.length}` : 
            '无匹配结果';
        
        prevButton.disabled = currentMatches.length === 0;
        nextButton.disabled = currentMatches.length === 0;
    }
    
    
    nextButton.addEventListener('click', function() {
        if (currentMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex + 1) % currentMatches.length;
        navigateToMatch();
    });
    
    
    prevButton.addEventListener('click', function() {
        if (currentMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex - 1 + currentMatches.length) % currentMatches.length;
        navigateToMatch();
    });
    
    
    function navigateToMatch() {
        if (currentMatchIndex < 0 || currentMatchIndex >= currentMatches.length) return;
        
        const highlights = document.querySelectorAll('.search-highlight');
        if (highlights.length > 0 && currentMatchIndex < highlights.length) {
            highlights.forEach(h => h.classList.remove('current'));
            highlights[currentMatchIndex].classList.add('current');
            highlights[currentMatchIndex].scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }
        
        updateNavigation();
    }
    
    
    searchNav.style.display = 'none';
});
</script>
    
            
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#接口说明">接口说明</a></li>
    <li><a href="#仪器上接口标示和接口类型"><strong>仪器上接口标示和接口类型</strong></a></li>
    <li><a href="#仪器接口说明">仪器接口说明</a></li>
    <li><a href="#数据格式"><strong>数据格式</strong></a></li>
    <li><a href="#修改记录">修改记录</a></li>
    <li><a href="#仪器接口程序">仪器接口程序</a></li>
    <li><a href="#个性化功能记录">个性化功能记录</a>
      <ol>
        <li><a href="#自动核收功能">自动核收功能</a></li>
        <li><a href="#20250403122745-22nhmpf">通过编号规则获取自动核收对应的流水号</a></li>
        <li><a href="#记录标本操作日志">记录标本操作日志</a></li>
        <li><a href="#存储报警信息标志">存储报警信息标志</a>
          <ol>
            <li><a href="#报警信息存储记录展示">报警信息存储记录展示</a></li>
            <li><a href="#报告处理增加筛选功能">报告处理增加筛选功能</a></li>
          </ol>
        </li>
        <li><a href="#存放报警信息或者评价信息">存放报警信息或者评价信息</a></li>
        <li><a href="#存储架子号信息以及标本操作日志记录">存储架子号信息以及标本操作日志记录</a></li>
        <li><a href="#存储标本图片">存储标本图片</a>
          <ol>
            <li><a href="#血清标本显示">血清标本显示</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#特殊处理记录">特殊处理记录</a>
      <ol>
        <li><a href="#监听配置有多条监听配置">监听配置，有多条监听配置</a></li>
        <li><a href="#自动核收调用核收方法按照工作小组主键入参">自动核收调用核收方法，按照工作小组主键入参。</a></li>
        <li><a href="#自动核收前处理">自动核收前处理</a></li>
        <li><a href="#特殊结果的转换">特殊结果的转换</a></li>
        <li><a href="#报警信息转换">报警信息转换</a></li>
        <li><a href="#新增标本操作日志记录类型">新增标本操作日志记录类型</a></li>
        <li><a href="#主动上传特殊处理">主动上传特殊处理</a>
          <ol>
            <li><a href="#回退和审核更新状态">回退和审核更新状态</a></li>
            <li><a href="#标本上传处理修改显示">标本上传处理修改显示</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#问题处理记录">问题处理记录</a>
      <ol>
        <li><a href="#20250403102148-sh95o3i">无法及时读取文件处理造成获取结果过慢</a></li>
        <li><a href="#仪器未获取到项目问题">仪器未获取到项目问题</a></li>
        <li><a href="#报警信息过长保存到其他结果字段时造成无法保存仪器结果">报警信息过长保存到其他结果字段时造成无法保存仪器结果</a></li>
        <li><a href="#同时存在大量标本查询速度过慢造成堆积无法正常上传项目">同时存在大量标本，查询速度过慢，造成堆积无法正常上传项目</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/">
                <img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403125731-kgqb3bk_hu_5e75fdc1838f2a8d.png"
                        srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403125731-kgqb3bk_hu_5e75fdc1838f2a8d.png 800w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403125731-kgqb3bk_hu_c5a5dd2dd04fd3a7.png 1600w"
                        width="800" 
                        height="300" 
                        loading="lazy"
                        alt="Featured image of post 罗氏流水线IT3000" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/2.%E4%BB%AA%E5%99%A8%E6%8E%A5%E5%8F%A3%E8%AE%B0%E5%BD%95/" >
                2.仪器接口记录
            </a>
        
            <a href="/categories/%E7%BB%BC%E5%90%88%E6%8E%A5%E5%8F%A3%E7%A8%8B%E5%BA%8F/" >
                综合接口程序
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/">罗氏流水线IT3000</a>
        </h2>
    
        
    </div>

        
        <footer class="article-time">
            
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                    <time class="article-time--published">2025-09-03</time>
                </div>
            

            
            
                        最后更新于
                        <time class="article-time--updated" datetime="2025-09-03 23:20:57 &#43;0000 UTC" title="2025-09-03 23:20:57 &#43;0000 UTC">
                            2025-09-03 23:20:57
                        </time>
			
			
			
				<div>
					<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



					<time class="article-words">
						32404字
					</time>
				</div>
			
			

            
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                    <time class="article-time--reading">
                        阅读时长: 65 分钟
                    </time>
                </div>
            
        </footer>
    


    
</div>
</header>



    <section class="article-content">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <h2 id="接口说明">接口说明
</h2><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">仪器厂商</th>
          <th style="text-align: left">罗氏流水线<br /></th>
          <th style="text-align: left">仪器型号</th>
          <th style="text-align: left">IT3000<br /></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">通讯方式</td>
          <td style="text-align: left">主动上传<br /></td>
          <td style="text-align: left">仪器类型</td>
          <td style="text-align: left">生化发光流水线</td>
      </tr>
      <tr>
          <td style="text-align: left">医院名称</td>
          <td style="text-align: left">厦门翔安医院</td>
          <td style="text-align: left">程序名称</td>
          <td style="text-align: left">MI.MIFIT3000</td>
      </tr>
      <tr>
          <td style="text-align: left">终端服务器地址</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">终端服务器端口号</td>
          <td></td>
      </tr>
  </tbody>
</table></div>
<h2 id="仪器上接口标示和接口类型"><strong>仪器上接口标示和接口类型</strong>
</h2><ol>
<li>接口类型：监听文件</li>
<li>连接方式：抓取RESULT结果文件和SEEN处理文件 .hl7文件，上传ORDERS .hl7文件</li>
</ol>
<h2 id="仪器接口说明">仪器接口说明
</h2><ul>
<li>罗氏流水线与lis交互分为处理文件 SEEN 和结果文件 RESULT 两种以及血清图片，处理文件过多，lis读取文件和解析文件同时进行，造成结果文件无法及时解析，造成仪器传了结果但是未及时读取造成无法及时发报告。针对这一问题，详细在问题处理中<a class="link" href="#20250403102148-sh95o3i" >无法及时读取文件处理造成获取结果过慢</a>记录。</li>
<li>接口中包含多种功能，包含血清图片，自动核收，报警信息存储等。详细在仪器个性功能中展示。</li>
</ul>
<h2 id="数据格式"><strong>数据格式</strong>
</h2><h2 id="修改记录">修改记录
</h2><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>序号</th>
          <th>日期</th>
          <th>操作人</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td>2025-04-03 10:15:50<br /></td>
          <td>杨浩然</td>
          <td><br /></td>
      </tr>
  </tbody>
</table></div>
<h2 id="仪器接口程序">仪器接口程序
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">   1
</span><span class="lnt">   2
</span><span class="lnt">   3
</span><span class="lnt">   4
</span><span class="lnt">   5
</span><span class="lnt">   6
</span><span class="lnt">   7
</span><span class="lnt">   8
</span><span class="lnt">   9
</span><span class="lnt">  10
</span><span class="lnt">  11
</span><span class="lnt">  12
</span><span class="lnt">  13
</span><span class="lnt">  14
</span><span class="lnt">  15
</span><span class="lnt">  16
</span><span class="lnt">  17
</span><span class="lnt">  18
</span><span class="lnt">  19
</span><span class="lnt">  20
</span><span class="lnt">  21
</span><span class="lnt">  22
</span><span class="lnt">  23
</span><span class="lnt">  24
</span><span class="lnt">  25
</span><span class="lnt">  26
</span><span class="lnt">  27
</span><span class="lnt">  28
</span><span class="lnt">  29
</span><span class="lnt">  30
</span><span class="lnt">  31
</span><span class="lnt">  32
</span><span class="lnt">  33
</span><span class="lnt">  34
</span><span class="lnt">  35
</span><span class="lnt">  36
</span><span class="lnt">  37
</span><span class="lnt">  38
</span><span class="lnt">  39
</span><span class="lnt">  40
</span><span class="lnt">  41
</span><span class="lnt">  42
</span><span class="lnt">  43
</span><span class="lnt">  44
</span><span class="lnt">  45
</span><span class="lnt">  46
</span><span class="lnt">  47
</span><span class="lnt">  48
</span><span class="lnt">  49
</span><span class="lnt">  50
</span><span class="lnt">  51
</span><span class="lnt">  52
</span><span class="lnt">  53
</span><span class="lnt">  54
</span><span class="lnt">  55
</span><span class="lnt">  56
</span><span class="lnt">  57
</span><span class="lnt">  58
</span><span class="lnt">  59
</span><span class="lnt">  60
</span><span class="lnt">  61
</span><span class="lnt">  62
</span><span class="lnt">  63
</span><span class="lnt">  64
</span><span class="lnt">  65
</span><span class="lnt">  66
</span><span class="lnt">  67
</span><span class="lnt">  68
</span><span class="lnt">  69
</span><span class="lnt">  70
</span><span class="lnt">  71
</span><span class="lnt">  72
</span><span class="lnt">  73
</span><span class="lnt">  74
</span><span class="lnt">  75
</span><span class="lnt">  76
</span><span class="lnt">  77
</span><span class="lnt">  78
</span><span class="lnt">  79
</span><span class="lnt">  80
</span><span class="lnt">  81
</span><span class="lnt">  82
</span><span class="lnt">  83
</span><span class="lnt">  84
</span><span class="lnt">  85
</span><span class="lnt">  86
</span><span class="lnt">  87
</span><span class="lnt">  88
</span><span class="lnt">  89
</span><span class="lnt">  90
</span><span class="lnt">  91
</span><span class="lnt">  92
</span><span class="lnt">  93
</span><span class="lnt">  94
</span><span class="lnt">  95
</span><span class="lnt">  96
</span><span class="lnt">  97
</span><span class="lnt">  98
</span><span class="lnt">  99
</span><span class="lnt"> 100
</span><span class="lnt"> 101
</span><span class="lnt"> 102
</span><span class="lnt"> 103
</span><span class="lnt"> 104
</span><span class="lnt"> 105
</span><span class="lnt"> 106
</span><span class="lnt"> 107
</span><span class="lnt"> 108
</span><span class="lnt"> 109
</span><span class="lnt"> 110
</span><span class="lnt"> 111
</span><span class="lnt"> 112
</span><span class="lnt"> 113
</span><span class="lnt"> 114
</span><span class="lnt"> 115
</span><span class="lnt"> 116
</span><span class="lnt"> 117
</span><span class="lnt"> 118
</span><span class="lnt"> 119
</span><span class="lnt"> 120
</span><span class="lnt"> 121
</span><span class="lnt"> 122
</span><span class="lnt"> 123
</span><span class="lnt"> 124
</span><span class="lnt"> 125
</span><span class="lnt"> 126
</span><span class="lnt"> 127
</span><span class="lnt"> 128
</span><span class="lnt"> 129
</span><span class="lnt"> 130
</span><span class="lnt"> 131
</span><span class="lnt"> 132
</span><span class="lnt"> 133
</span><span class="lnt"> 134
</span><span class="lnt"> 135
</span><span class="lnt"> 136
</span><span class="lnt"> 137
</span><span class="lnt"> 138
</span><span class="lnt"> 139
</span><span class="lnt"> 140
</span><span class="lnt"> 141
</span><span class="lnt"> 142
</span><span class="lnt"> 143
</span><span class="lnt"> 144
</span><span class="lnt"> 145
</span><span class="lnt"> 146
</span><span class="lnt"> 147
</span><span class="lnt"> 148
</span><span class="lnt"> 149
</span><span class="lnt"> 150
</span><span class="lnt"> 151
</span><span class="lnt"> 152
</span><span class="lnt"> 153
</span><span class="lnt"> 154
</span><span class="lnt"> 155
</span><span class="lnt"> 156
</span><span class="lnt"> 157
</span><span class="lnt"> 158
</span><span class="lnt"> 159
</span><span class="lnt"> 160
</span><span class="lnt"> 161
</span><span class="lnt"> 162
</span><span class="lnt"> 163
</span><span class="lnt"> 164
</span><span class="lnt"> 165
</span><span class="lnt"> 166
</span><span class="lnt"> 167
</span><span class="lnt"> 168
</span><span class="lnt"> 169
</span><span class="lnt"> 170
</span><span class="lnt"> 171
</span><span class="lnt"> 172
</span><span class="lnt"> 173
</span><span class="lnt"> 174
</span><span class="lnt"> 175
</span><span class="lnt"> 176
</span><span class="lnt"> 177
</span><span class="lnt"> 178
</span><span class="lnt"> 179
</span><span class="lnt"> 180
</span><span class="lnt"> 181
</span><span class="lnt"> 182
</span><span class="lnt"> 183
</span><span class="lnt"> 184
</span><span class="lnt"> 185
</span><span class="lnt"> 186
</span><span class="lnt"> 187
</span><span class="lnt"> 188
</span><span class="lnt"> 189
</span><span class="lnt"> 190
</span><span class="lnt"> 191
</span><span class="lnt"> 192
</span><span class="lnt"> 193
</span><span class="lnt"> 194
</span><span class="lnt"> 195
</span><span class="lnt"> 196
</span><span class="lnt"> 197
</span><span class="lnt"> 198
</span><span class="lnt"> 199
</span><span class="lnt"> 200
</span><span class="lnt"> 201
</span><span class="lnt"> 202
</span><span class="lnt"> 203
</span><span class="lnt"> 204
</span><span class="lnt"> 205
</span><span class="lnt"> 206
</span><span class="lnt"> 207
</span><span class="lnt"> 208
</span><span class="lnt"> 209
</span><span class="lnt"> 210
</span><span class="lnt"> 211
</span><span class="lnt"> 212
</span><span class="lnt"> 213
</span><span class="lnt"> 214
</span><span class="lnt"> 215
</span><span class="lnt"> 216
</span><span class="lnt"> 217
</span><span class="lnt"> 218
</span><span class="lnt"> 219
</span><span class="lnt"> 220
</span><span class="lnt"> 221
</span><span class="lnt"> 222
</span><span class="lnt"> 223
</span><span class="lnt"> 224
</span><span class="lnt"> 225
</span><span class="lnt"> 226
</span><span class="lnt"> 227
</span><span class="lnt"> 228
</span><span class="lnt"> 229
</span><span class="lnt"> 230
</span><span class="lnt"> 231
</span><span class="lnt"> 232
</span><span class="lnt"> 233
</span><span class="lnt"> 234
</span><span class="lnt"> 235
</span><span class="lnt"> 236
</span><span class="lnt"> 237
</span><span class="lnt"> 238
</span><span class="lnt"> 239
</span><span class="lnt"> 240
</span><span class="lnt"> 241
</span><span class="lnt"> 242
</span><span class="lnt"> 243
</span><span class="lnt"> 244
</span><span class="lnt"> 245
</span><span class="lnt"> 246
</span><span class="lnt"> 247
</span><span class="lnt"> 248
</span><span class="lnt"> 249
</span><span class="lnt"> 250
</span><span class="lnt"> 251
</span><span class="lnt"> 252
</span><span class="lnt"> 253
</span><span class="lnt"> 254
</span><span class="lnt"> 255
</span><span class="lnt"> 256
</span><span class="lnt"> 257
</span><span class="lnt"> 258
</span><span class="lnt"> 259
</span><span class="lnt"> 260
</span><span class="lnt"> 261
</span><span class="lnt"> 262
</span><span class="lnt"> 263
</span><span class="lnt"> 264
</span><span class="lnt"> 265
</span><span class="lnt"> 266
</span><span class="lnt"> 267
</span><span class="lnt"> 268
</span><span class="lnt"> 269
</span><span class="lnt"> 270
</span><span class="lnt"> 271
</span><span class="lnt"> 272
</span><span class="lnt"> 273
</span><span class="lnt"> 274
</span><span class="lnt"> 275
</span><span class="lnt"> 276
</span><span class="lnt"> 277
</span><span class="lnt"> 278
</span><span class="lnt"> 279
</span><span class="lnt"> 280
</span><span class="lnt"> 281
</span><span class="lnt"> 282
</span><span class="lnt"> 283
</span><span class="lnt"> 284
</span><span class="lnt"> 285
</span><span class="lnt"> 286
</span><span class="lnt"> 287
</span><span class="lnt"> 288
</span><span class="lnt"> 289
</span><span class="lnt"> 290
</span><span class="lnt"> 291
</span><span class="lnt"> 292
</span><span class="lnt"> 293
</span><span class="lnt"> 294
</span><span class="lnt"> 295
</span><span class="lnt"> 296
</span><span class="lnt"> 297
</span><span class="lnt"> 298
</span><span class="lnt"> 299
</span><span class="lnt"> 300
</span><span class="lnt"> 301
</span><span class="lnt"> 302
</span><span class="lnt"> 303
</span><span class="lnt"> 304
</span><span class="lnt"> 305
</span><span class="lnt"> 306
</span><span class="lnt"> 307
</span><span class="lnt"> 308
</span><span class="lnt"> 309
</span><span class="lnt"> 310
</span><span class="lnt"> 311
</span><span class="lnt"> 312
</span><span class="lnt"> 313
</span><span class="lnt"> 314
</span><span class="lnt"> 315
</span><span class="lnt"> 316
</span><span class="lnt"> 317
</span><span class="lnt"> 318
</span><span class="lnt"> 319
</span><span class="lnt"> 320
</span><span class="lnt"> 321
</span><span class="lnt"> 322
</span><span class="lnt"> 323
</span><span class="lnt"> 324
</span><span class="lnt"> 325
</span><span class="lnt"> 326
</span><span class="lnt"> 327
</span><span class="lnt"> 328
</span><span class="lnt"> 329
</span><span class="lnt"> 330
</span><span class="lnt"> 331
</span><span class="lnt"> 332
</span><span class="lnt"> 333
</span><span class="lnt"> 334
</span><span class="lnt"> 335
</span><span class="lnt"> 336
</span><span class="lnt"> 337
</span><span class="lnt"> 338
</span><span class="lnt"> 339
</span><span class="lnt"> 340
</span><span class="lnt"> 341
</span><span class="lnt"> 342
</span><span class="lnt"> 343
</span><span class="lnt"> 344
</span><span class="lnt"> 345
</span><span class="lnt"> 346
</span><span class="lnt"> 347
</span><span class="lnt"> 348
</span><span class="lnt"> 349
</span><span class="lnt"> 350
</span><span class="lnt"> 351
</span><span class="lnt"> 352
</span><span class="lnt"> 353
</span><span class="lnt"> 354
</span><span class="lnt"> 355
</span><span class="lnt"> 356
</span><span class="lnt"> 357
</span><span class="lnt"> 358
</span><span class="lnt"> 359
</span><span class="lnt"> 360
</span><span class="lnt"> 361
</span><span class="lnt"> 362
</span><span class="lnt"> 363
</span><span class="lnt"> 364
</span><span class="lnt"> 365
</span><span class="lnt"> 366
</span><span class="lnt"> 367
</span><span class="lnt"> 368
</span><span class="lnt"> 369
</span><span class="lnt"> 370
</span><span class="lnt"> 371
</span><span class="lnt"> 372
</span><span class="lnt"> 373
</span><span class="lnt"> 374
</span><span class="lnt"> 375
</span><span class="lnt"> 376
</span><span class="lnt"> 377
</span><span class="lnt"> 378
</span><span class="lnt"> 379
</span><span class="lnt"> 380
</span><span class="lnt"> 381
</span><span class="lnt"> 382
</span><span class="lnt"> 383
</span><span class="lnt"> 384
</span><span class="lnt"> 385
</span><span class="lnt"> 386
</span><span class="lnt"> 387
</span><span class="lnt"> 388
</span><span class="lnt"> 389
</span><span class="lnt"> 390
</span><span class="lnt"> 391
</span><span class="lnt"> 392
</span><span class="lnt"> 393
</span><span class="lnt"> 394
</span><span class="lnt"> 395
</span><span class="lnt"> 396
</span><span class="lnt"> 397
</span><span class="lnt"> 398
</span><span class="lnt"> 399
</span><span class="lnt"> 400
</span><span class="lnt"> 401
</span><span class="lnt"> 402
</span><span class="lnt"> 403
</span><span class="lnt"> 404
</span><span class="lnt"> 405
</span><span class="lnt"> 406
</span><span class="lnt"> 407
</span><span class="lnt"> 408
</span><span class="lnt"> 409
</span><span class="lnt"> 410
</span><span class="lnt"> 411
</span><span class="lnt"> 412
</span><span class="lnt"> 413
</span><span class="lnt"> 414
</span><span class="lnt"> 415
</span><span class="lnt"> 416
</span><span class="lnt"> 417
</span><span class="lnt"> 418
</span><span class="lnt"> 419
</span><span class="lnt"> 420
</span><span class="lnt"> 421
</span><span class="lnt"> 422
</span><span class="lnt"> 423
</span><span class="lnt"> 424
</span><span class="lnt"> 425
</span><span class="lnt"> 426
</span><span class="lnt"> 427
</span><span class="lnt"> 428
</span><span class="lnt"> 429
</span><span class="lnt"> 430
</span><span class="lnt"> 431
</span><span class="lnt"> 432
</span><span class="lnt"> 433
</span><span class="lnt"> 434
</span><span class="lnt"> 435
</span><span class="lnt"> 436
</span><span class="lnt"> 437
</span><span class="lnt"> 438
</span><span class="lnt"> 439
</span><span class="lnt"> 440
</span><span class="lnt"> 441
</span><span class="lnt"> 442
</span><span class="lnt"> 443
</span><span class="lnt"> 444
</span><span class="lnt"> 445
</span><span class="lnt"> 446
</span><span class="lnt"> 447
</span><span class="lnt"> 448
</span><span class="lnt"> 449
</span><span class="lnt"> 450
</span><span class="lnt"> 451
</span><span class="lnt"> 452
</span><span class="lnt"> 453
</span><span class="lnt"> 454
</span><span class="lnt"> 455
</span><span class="lnt"> 456
</span><span class="lnt"> 457
</span><span class="lnt"> 458
</span><span class="lnt"> 459
</span><span class="lnt"> 460
</span><span class="lnt"> 461
</span><span class="lnt"> 462
</span><span class="lnt"> 463
</span><span class="lnt"> 464
</span><span class="lnt"> 465
</span><span class="lnt"> 466
</span><span class="lnt"> 467
</span><span class="lnt"> 468
</span><span class="lnt"> 469
</span><span class="lnt"> 470
</span><span class="lnt"> 471
</span><span class="lnt"> 472
</span><span class="lnt"> 473
</span><span class="lnt"> 474
</span><span class="lnt"> 475
</span><span class="lnt"> 476
</span><span class="lnt"> 477
</span><span class="lnt"> 478
</span><span class="lnt"> 479
</span><span class="lnt"> 480
</span><span class="lnt"> 481
</span><span class="lnt"> 482
</span><span class="lnt"> 483
</span><span class="lnt"> 484
</span><span class="lnt"> 485
</span><span class="lnt"> 486
</span><span class="lnt"> 487
</span><span class="lnt"> 488
</span><span class="lnt"> 489
</span><span class="lnt"> 490
</span><span class="lnt"> 491
</span><span class="lnt"> 492
</span><span class="lnt"> 493
</span><span class="lnt"> 494
</span><span class="lnt"> 495
</span><span class="lnt"> 496
</span><span class="lnt"> 497
</span><span class="lnt"> 498
</span><span class="lnt"> 499
</span><span class="lnt"> 500
</span><span class="lnt"> 501
</span><span class="lnt"> 502
</span><span class="lnt"> 503
</span><span class="lnt"> 504
</span><span class="lnt"> 505
</span><span class="lnt"> 506
</span><span class="lnt"> 507
</span><span class="lnt"> 508
</span><span class="lnt"> 509
</span><span class="lnt"> 510
</span><span class="lnt"> 511
</span><span class="lnt"> 512
</span><span class="lnt"> 513
</span><span class="lnt"> 514
</span><span class="lnt"> 515
</span><span class="lnt"> 516
</span><span class="lnt"> 517
</span><span class="lnt"> 518
</span><span class="lnt"> 519
</span><span class="lnt"> 520
</span><span class="lnt"> 521
</span><span class="lnt"> 522
</span><span class="lnt"> 523
</span><span class="lnt"> 524
</span><span class="lnt"> 525
</span><span class="lnt"> 526
</span><span class="lnt"> 527
</span><span class="lnt"> 528
</span><span class="lnt"> 529
</span><span class="lnt"> 530
</span><span class="lnt"> 531
</span><span class="lnt"> 532
</span><span class="lnt"> 533
</span><span class="lnt"> 534
</span><span class="lnt"> 535
</span><span class="lnt"> 536
</span><span class="lnt"> 537
</span><span class="lnt"> 538
</span><span class="lnt"> 539
</span><span class="lnt"> 540
</span><span class="lnt"> 541
</span><span class="lnt"> 542
</span><span class="lnt"> 543
</span><span class="lnt"> 544
</span><span class="lnt"> 545
</span><span class="lnt"> 546
</span><span class="lnt"> 547
</span><span class="lnt"> 548
</span><span class="lnt"> 549
</span><span class="lnt"> 550
</span><span class="lnt"> 551
</span><span class="lnt"> 552
</span><span class="lnt"> 553
</span><span class="lnt"> 554
</span><span class="lnt"> 555
</span><span class="lnt"> 556
</span><span class="lnt"> 557
</span><span class="lnt"> 558
</span><span class="lnt"> 559
</span><span class="lnt"> 560
</span><span class="lnt"> 561
</span><span class="lnt"> 562
</span><span class="lnt"> 563
</span><span class="lnt"> 564
</span><span class="lnt"> 565
</span><span class="lnt"> 566
</span><span class="lnt"> 567
</span><span class="lnt"> 568
</span><span class="lnt"> 569
</span><span class="lnt"> 570
</span><span class="lnt"> 571
</span><span class="lnt"> 572
</span><span class="lnt"> 573
</span><span class="lnt"> 574
</span><span class="lnt"> 575
</span><span class="lnt"> 576
</span><span class="lnt"> 577
</span><span class="lnt"> 578
</span><span class="lnt"> 579
</span><span class="lnt"> 580
</span><span class="lnt"> 581
</span><span class="lnt"> 582
</span><span class="lnt"> 583
</span><span class="lnt"> 584
</span><span class="lnt"> 585
</span><span class="lnt"> 586
</span><span class="lnt"> 587
</span><span class="lnt"> 588
</span><span class="lnt"> 589
</span><span class="lnt"> 590
</span><span class="lnt"> 591
</span><span class="lnt"> 592
</span><span class="lnt"> 593
</span><span class="lnt"> 594
</span><span class="lnt"> 595
</span><span class="lnt"> 596
</span><span class="lnt"> 597
</span><span class="lnt"> 598
</span><span class="lnt"> 599
</span><span class="lnt"> 600
</span><span class="lnt"> 601
</span><span class="lnt"> 602
</span><span class="lnt"> 603
</span><span class="lnt"> 604
</span><span class="lnt"> 605
</span><span class="lnt"> 606
</span><span class="lnt"> 607
</span><span class="lnt"> 608
</span><span class="lnt"> 609
</span><span class="lnt"> 610
</span><span class="lnt"> 611
</span><span class="lnt"> 612
</span><span class="lnt"> 613
</span><span class="lnt"> 614
</span><span class="lnt"> 615
</span><span class="lnt"> 616
</span><span class="lnt"> 617
</span><span class="lnt"> 618
</span><span class="lnt"> 619
</span><span class="lnt"> 620
</span><span class="lnt"> 621
</span><span class="lnt"> 622
</span><span class="lnt"> 623
</span><span class="lnt"> 624
</span><span class="lnt"> 625
</span><span class="lnt"> 626
</span><span class="lnt"> 627
</span><span class="lnt"> 628
</span><span class="lnt"> 629
</span><span class="lnt"> 630
</span><span class="lnt"> 631
</span><span class="lnt"> 632
</span><span class="lnt"> 633
</span><span class="lnt"> 634
</span><span class="lnt"> 635
</span><span class="lnt"> 636
</span><span class="lnt"> 637
</span><span class="lnt"> 638
</span><span class="lnt"> 639
</span><span class="lnt"> 640
</span><span class="lnt"> 641
</span><span class="lnt"> 642
</span><span class="lnt"> 643
</span><span class="lnt"> 644
</span><span class="lnt"> 645
</span><span class="lnt"> 646
</span><span class="lnt"> 647
</span><span class="lnt"> 648
</span><span class="lnt"> 649
</span><span class="lnt"> 650
</span><span class="lnt"> 651
</span><span class="lnt"> 652
</span><span class="lnt"> 653
</span><span class="lnt"> 654
</span><span class="lnt"> 655
</span><span class="lnt"> 656
</span><span class="lnt"> 657
</span><span class="lnt"> 658
</span><span class="lnt"> 659
</span><span class="lnt"> 660
</span><span class="lnt"> 661
</span><span class="lnt"> 662
</span><span class="lnt"> 663
</span><span class="lnt"> 664
</span><span class="lnt"> 665
</span><span class="lnt"> 666
</span><span class="lnt"> 667
</span><span class="lnt"> 668
</span><span class="lnt"> 669
</span><span class="lnt"> 670
</span><span class="lnt"> 671
</span><span class="lnt"> 672
</span><span class="lnt"> 673
</span><span class="lnt"> 674
</span><span class="lnt"> 675
</span><span class="lnt"> 676
</span><span class="lnt"> 677
</span><span class="lnt"> 678
</span><span class="lnt"> 679
</span><span class="lnt"> 680
</span><span class="lnt"> 681
</span><span class="lnt"> 682
</span><span class="lnt"> 683
</span><span class="lnt"> 684
</span><span class="lnt"> 685
</span><span class="lnt"> 686
</span><span class="lnt"> 687
</span><span class="lnt"> 688
</span><span class="lnt"> 689
</span><span class="lnt"> 690
</span><span class="lnt"> 691
</span><span class="lnt"> 692
</span><span class="lnt"> 693
</span><span class="lnt"> 694
</span><span class="lnt"> 695
</span><span class="lnt"> 696
</span><span class="lnt"> 697
</span><span class="lnt"> 698
</span><span class="lnt"> 699
</span><span class="lnt"> 700
</span><span class="lnt"> 701
</span><span class="lnt"> 702
</span><span class="lnt"> 703
</span><span class="lnt"> 704
</span><span class="lnt"> 705
</span><span class="lnt"> 706
</span><span class="lnt"> 707
</span><span class="lnt"> 708
</span><span class="lnt"> 709
</span><span class="lnt"> 710
</span><span class="lnt"> 711
</span><span class="lnt"> 712
</span><span class="lnt"> 713
</span><span class="lnt"> 714
</span><span class="lnt"> 715
</span><span class="lnt"> 716
</span><span class="lnt"> 717
</span><span class="lnt"> 718
</span><span class="lnt"> 719
</span><span class="lnt"> 720
</span><span class="lnt"> 721
</span><span class="lnt"> 722
</span><span class="lnt"> 723
</span><span class="lnt"> 724
</span><span class="lnt"> 725
</span><span class="lnt"> 726
</span><span class="lnt"> 727
</span><span class="lnt"> 728
</span><span class="lnt"> 729
</span><span class="lnt"> 730
</span><span class="lnt"> 731
</span><span class="lnt"> 732
</span><span class="lnt"> 733
</span><span class="lnt"> 734
</span><span class="lnt"> 735
</span><span class="lnt"> 736
</span><span class="lnt"> 737
</span><span class="lnt"> 738
</span><span class="lnt"> 739
</span><span class="lnt"> 740
</span><span class="lnt"> 741
</span><span class="lnt"> 742
</span><span class="lnt"> 743
</span><span class="lnt"> 744
</span><span class="lnt"> 745
</span><span class="lnt"> 746
</span><span class="lnt"> 747
</span><span class="lnt"> 748
</span><span class="lnt"> 749
</span><span class="lnt"> 750
</span><span class="lnt"> 751
</span><span class="lnt"> 752
</span><span class="lnt"> 753
</span><span class="lnt"> 754
</span><span class="lnt"> 755
</span><span class="lnt"> 756
</span><span class="lnt"> 757
</span><span class="lnt"> 758
</span><span class="lnt"> 759
</span><span class="lnt"> 760
</span><span class="lnt"> 761
</span><span class="lnt"> 762
</span><span class="lnt"> 763
</span><span class="lnt"> 764
</span><span class="lnt"> 765
</span><span class="lnt"> 766
</span><span class="lnt"> 767
</span><span class="lnt"> 768
</span><span class="lnt"> 769
</span><span class="lnt"> 770
</span><span class="lnt"> 771
</span><span class="lnt"> 772
</span><span class="lnt"> 773
</span><span class="lnt"> 774
</span><span class="lnt"> 775
</span><span class="lnt"> 776
</span><span class="lnt"> 777
</span><span class="lnt"> 778
</span><span class="lnt"> 779
</span><span class="lnt"> 780
</span><span class="lnt"> 781
</span><span class="lnt"> 782
</span><span class="lnt"> 783
</span><span class="lnt"> 784
</span><span class="lnt"> 785
</span><span class="lnt"> 786
</span><span class="lnt"> 787
</span><span class="lnt"> 788
</span><span class="lnt"> 789
</span><span class="lnt"> 790
</span><span class="lnt"> 791
</span><span class="lnt"> 792
</span><span class="lnt"> 793
</span><span class="lnt"> 794
</span><span class="lnt"> 795
</span><span class="lnt"> 796
</span><span class="lnt"> 797
</span><span class="lnt"> 798
</span><span class="lnt"> 799
</span><span class="lnt"> 800
</span><span class="lnt"> 801
</span><span class="lnt"> 802
</span><span class="lnt"> 803
</span><span class="lnt"> 804
</span><span class="lnt"> 805
</span><span class="lnt"> 806
</span><span class="lnt"> 807
</span><span class="lnt"> 808
</span><span class="lnt"> 809
</span><span class="lnt"> 810
</span><span class="lnt"> 811
</span><span class="lnt"> 812
</span><span class="lnt"> 813
</span><span class="lnt"> 814
</span><span class="lnt"> 815
</span><span class="lnt"> 816
</span><span class="lnt"> 817
</span><span class="lnt"> 818
</span><span class="lnt"> 819
</span><span class="lnt"> 820
</span><span class="lnt"> 821
</span><span class="lnt"> 822
</span><span class="lnt"> 823
</span><span class="lnt"> 824
</span><span class="lnt"> 825
</span><span class="lnt"> 826
</span><span class="lnt"> 827
</span><span class="lnt"> 828
</span><span class="lnt"> 829
</span><span class="lnt"> 830
</span><span class="lnt"> 831
</span><span class="lnt"> 832
</span><span class="lnt"> 833
</span><span class="lnt"> 834
</span><span class="lnt"> 835
</span><span class="lnt"> 836
</span><span class="lnt"> 837
</span><span class="lnt"> 838
</span><span class="lnt"> 839
</span><span class="lnt"> 840
</span><span class="lnt"> 841
</span><span class="lnt"> 842
</span><span class="lnt"> 843
</span><span class="lnt"> 844
</span><span class="lnt"> 845
</span><span class="lnt"> 846
</span><span class="lnt"> 847
</span><span class="lnt"> 848
</span><span class="lnt"> 849
</span><span class="lnt"> 850
</span><span class="lnt"> 851
</span><span class="lnt"> 852
</span><span class="lnt"> 853
</span><span class="lnt"> 854
</span><span class="lnt"> 855
</span><span class="lnt"> 856
</span><span class="lnt"> 857
</span><span class="lnt"> 858
</span><span class="lnt"> 859
</span><span class="lnt"> 860
</span><span class="lnt"> 861
</span><span class="lnt"> 862
</span><span class="lnt"> 863
</span><span class="lnt"> 864
</span><span class="lnt"> 865
</span><span class="lnt"> 866
</span><span class="lnt"> 867
</span><span class="lnt"> 868
</span><span class="lnt"> 869
</span><span class="lnt"> 870
</span><span class="lnt"> 871
</span><span class="lnt"> 872
</span><span class="lnt"> 873
</span><span class="lnt"> 874
</span><span class="lnt"> 875
</span><span class="lnt"> 876
</span><span class="lnt"> 877
</span><span class="lnt"> 878
</span><span class="lnt"> 879
</span><span class="lnt"> 880
</span><span class="lnt"> 881
</span><span class="lnt"> 882
</span><span class="lnt"> 883
</span><span class="lnt"> 884
</span><span class="lnt"> 885
</span><span class="lnt"> 886
</span><span class="lnt"> 887
</span><span class="lnt"> 888
</span><span class="lnt"> 889
</span><span class="lnt"> 890
</span><span class="lnt"> 891
</span><span class="lnt"> 892
</span><span class="lnt"> 893
</span><span class="lnt"> 894
</span><span class="lnt"> 895
</span><span class="lnt"> 896
</span><span class="lnt"> 897
</span><span class="lnt"> 898
</span><span class="lnt"> 899
</span><span class="lnt"> 900
</span><span class="lnt"> 901
</span><span class="lnt"> 902
</span><span class="lnt"> 903
</span><span class="lnt"> 904
</span><span class="lnt"> 905
</span><span class="lnt"> 906
</span><span class="lnt"> 907
</span><span class="lnt"> 908
</span><span class="lnt"> 909
</span><span class="lnt"> 910
</span><span class="lnt"> 911
</span><span class="lnt"> 912
</span><span class="lnt"> 913
</span><span class="lnt"> 914
</span><span class="lnt"> 915
</span><span class="lnt"> 916
</span><span class="lnt"> 917
</span><span class="lnt"> 918
</span><span class="lnt"> 919
</span><span class="lnt"> 920
</span><span class="lnt"> 921
</span><span class="lnt"> 922
</span><span class="lnt"> 923
</span><span class="lnt"> 924
</span><span class="lnt"> 925
</span><span class="lnt"> 926
</span><span class="lnt"> 927
</span><span class="lnt"> 928
</span><span class="lnt"> 929
</span><span class="lnt"> 930
</span><span class="lnt"> 931
</span><span class="lnt"> 932
</span><span class="lnt"> 933
</span><span class="lnt"> 934
</span><span class="lnt"> 935
</span><span class="lnt"> 936
</span><span class="lnt"> 937
</span><span class="lnt"> 938
</span><span class="lnt"> 939
</span><span class="lnt"> 940
</span><span class="lnt"> 941
</span><span class="lnt"> 942
</span><span class="lnt"> 943
</span><span class="lnt"> 944
</span><span class="lnt"> 945
</span><span class="lnt"> 946
</span><span class="lnt"> 947
</span><span class="lnt"> 948
</span><span class="lnt"> 949
</span><span class="lnt"> 950
</span><span class="lnt"> 951
</span><span class="lnt"> 952
</span><span class="lnt"> 953
</span><span class="lnt"> 954
</span><span class="lnt"> 955
</span><span class="lnt"> 956
</span><span class="lnt"> 957
</span><span class="lnt"> 958
</span><span class="lnt"> 959
</span><span class="lnt"> 960
</span><span class="lnt"> 961
</span><span class="lnt"> 962
</span><span class="lnt"> 963
</span><span class="lnt"> 964
</span><span class="lnt"> 965
</span><span class="lnt"> 966
</span><span class="lnt"> 967
</span><span class="lnt"> 968
</span><span class="lnt"> 969
</span><span class="lnt"> 970
</span><span class="lnt"> 971
</span><span class="lnt"> 972
</span><span class="lnt"> 973
</span><span class="lnt"> 974
</span><span class="lnt"> 975
</span><span class="lnt"> 976
</span><span class="lnt"> 977
</span><span class="lnt"> 978
</span><span class="lnt"> 979
</span><span class="lnt"> 980
</span><span class="lnt"> 981
</span><span class="lnt"> 982
</span><span class="lnt"> 983
</span><span class="lnt"> 984
</span><span class="lnt"> 985
</span><span class="lnt"> 986
</span><span class="lnt"> 987
</span><span class="lnt"> 988
</span><span class="lnt"> 989
</span><span class="lnt"> 990
</span><span class="lnt"> 991
</span><span class="lnt"> 992
</span><span class="lnt"> 993
</span><span class="lnt"> 994
</span><span class="lnt"> 995
</span><span class="lnt"> 996
</span><span class="lnt"> 997
</span><span class="lnt"> 998
</span><span class="lnt"> 999
</span><span class="lnt">1000
</span><span class="lnt">1001
</span><span class="lnt">1002
</span><span class="lnt">1003
</span><span class="lnt">1004
</span><span class="lnt">1005
</span><span class="lnt">1006
</span><span class="lnt">1007
</span><span class="lnt">1008
</span><span class="lnt">1009
</span><span class="lnt">1010
</span><span class="lnt">1011
</span><span class="lnt">1012
</span><span class="lnt">1013
</span><span class="lnt">1014
</span><span class="lnt">1015
</span><span class="lnt">1016
</span><span class="lnt">1017
</span><span class="lnt">1018
</span><span class="lnt">1019
</span><span class="lnt">1020
</span><span class="lnt">1021
</span><span class="lnt">1022
</span><span class="lnt">1023
</span><span class="lnt">1024
</span><span class="lnt">1025
</span><span class="lnt">1026
</span><span class="lnt">1027
</span><span class="lnt">1028
</span><span class="lnt">1029
</span><span class="lnt">1030
</span><span class="lnt">1031
</span><span class="lnt">1032
</span><span class="lnt">1033
</span><span class="lnt">1034
</span><span class="lnt">1035
</span><span class="lnt">1036
</span><span class="lnt">1037
</span><span class="lnt">1038
</span><span class="lnt">1039
</span><span class="lnt">1040
</span><span class="lnt">1041
</span><span class="lnt">1042
</span><span class="lnt">1043
</span><span class="lnt">1044
</span><span class="lnt">1045
</span><span class="lnt">1046
</span><span class="lnt">1047
</span><span class="lnt">1048
</span><span class="lnt">1049
</span><span class="lnt">1050
</span><span class="lnt">1051
</span><span class="lnt">1052
</span><span class="lnt">1053
</span><span class="lnt">1054
</span><span class="lnt">1055
</span><span class="lnt">1056
</span><span class="lnt">1057
</span><span class="lnt">1058
</span><span class="lnt">1059
</span><span class="lnt">1060
</span><span class="lnt">1061
</span><span class="lnt">1062
</span><span class="lnt">1063
</span><span class="lnt">1064
</span><span class="lnt">1065
</span><span class="lnt">1066
</span><span class="lnt">1067
</span><span class="lnt">1068
</span><span class="lnt">1069
</span><span class="lnt">1070
</span><span class="lnt">1071
</span><span class="lnt">1072
</span><span class="lnt">1073
</span><span class="lnt">1074
</span><span class="lnt">1075
</span><span class="lnt">1076
</span><span class="lnt">1077
</span><span class="lnt">1078
</span><span class="lnt">1079
</span><span class="lnt">1080
</span><span class="lnt">1081
</span><span class="lnt">1082
</span><span class="lnt">1083
</span><span class="lnt">1084
</span><span class="lnt">1085
</span><span class="lnt">1086
</span><span class="lnt">1087
</span><span class="lnt">1088
</span><span class="lnt">1089
</span><span class="lnt">1090
</span><span class="lnt">1091
</span><span class="lnt">1092
</span><span class="lnt">1093
</span><span class="lnt">1094
</span><span class="lnt">1095
</span><span class="lnt">1096
</span><span class="lnt">1097
</span><span class="lnt">1098
</span><span class="lnt">1099
</span><span class="lnt">1100
</span><span class="lnt">1101
</span><span class="lnt">1102
</span><span class="lnt">1103
</span><span class="lnt">1104
</span><span class="lnt">1105
</span><span class="lnt">1106
</span><span class="lnt">1107
</span><span class="lnt">1108
</span><span class="lnt">1109
</span><span class="lnt">1110
</span><span class="lnt">1111
</span><span class="lnt">1112
</span><span class="lnt">1113
</span><span class="lnt">1114
</span><span class="lnt">1115
</span><span class="lnt">1116
</span><span class="lnt">1117
</span><span class="lnt">1118
</span><span class="lnt">1119
</span><span class="lnt">1120
</span><span class="lnt">1121
</span><span class="lnt">1122
</span><span class="lnt">1123
</span><span class="lnt">1124
</span><span class="lnt">1125
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span> <span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;Drect&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;3000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;Z:</span><span class="se">\\</span><span class="s2">ResultExport</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFLICA800&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;.csv&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UpPara&#34;</span><span class="p">:</span><span class="s2">&#34;Z:</span><span class="se">\\</span><span class="s2">Imports</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="n">Class</span> <span class="n">MI</span><span class="o">.</span><span class="n">MIFIT3000N1</span> <span class="n">Extends</span> <span class="o">%</span><span class="n">RegisteredObject</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFInfinity).fileMTHD(&#34;7&#34;,&#34;MSH|^~\&amp;|PACMAN|PACMAN-LAB|PSM|PSM-LAB|20181122074821||ORU^R01|93113761|Q|2.4||||NE||8859/1|#enter#PID|1|#enter#ORC|1|T1|||IP|#enter#OBR|1|||||||||||||||||||503|#enter#OBX|||TNT-HS^3256^||0.145^|g/L|^^||||F|||20181122074817|503^COBASE602:#2#1|#enter#NTE|1|I|Code:0 Comment:No Alarm|#enter#&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">seen</span><span class="p">:</span> <span class="p">[</span><span class="n">VT</span><span class="p">]</span><span class="c1">#enter#MSH|^~\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">result</span><span class="p">:</span> <span class="p">[</span><span class="n">VT</span><span class="p">]</span><span class="c1">#enter#MSH|^~\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">seen</span><span class="p">:</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\&amp;|LIS||HOST||20220908183340||ACK^^ACK|b6a6bb63-774a-46a5-adf3-0d409dd058ad|P|2.5|||ER|ER||8859/1[CR]#enter#EQU||^^^MILESTONE1^^SAMPLEEVENT^SEEN|20220908183340|[CR]#enter#SAC|||1000100990|1000100990||20220908183340|01||P|MILESTON1|0@0[CR]#enter#[FS][CR]&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">result</span><span class="p">:</span><span class="n">D</span> <span class="c1">##class(MI.MIFRS600).fileMTHD(&#34;56&#34;,&#34;[VT]#enter#MSH|^~\&amp;|HL7SND|FAC1|HL7REC|FAC2|20210922075000975_1000100990||RESULTS□|20210922075000975_1000100990|P|2.3|||ER|ER||8859/1[CR]#enter#PID|1||1000100990|1000100990|^Test||19811002|F[CR]#enter#PV1|||041||||||||||||||||^^^^^^^^产六科|[CR]#enter#DG1|||宫内孕37+5天[CR]#enter#ORC|NW|1000100990|1000100990||||RI||20210922075000|医保|10001|041|||||||[CR]#enter#OBR||1000100990||GLU|||||||A[CR]#enter#OBX|1|NM|GLU||1.1||||||F|||20210922101033|c6000^E11[CR]#enter#[FS]□[CR]&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;Drect&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;3000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;E:</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Interface</span><span class="se">\\</span><span class="s2">Results,E:</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Interface</span><span class="se">\\</span><span class="s2">Seens&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFXAIT3000&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;.hl7&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoMAll,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealImage,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UpPara&#34;</span><span class="p">:</span><span class="s2">&#34;E:</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Interface</span><span class="se">\\</span><span class="s2">ORDERS</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="p">[{</span><span class="s2">&#34;MachID&#34;</span><span class="p">:</span><span class="s2">&#34;#RowID&#34;</span><span class="p">,</span><span class="s2">&#34;Type&#34;</span><span class="p">:</span><span class="s2">&#34;Drect&#34;</span><span class="p">,</span><span class="s2">&#34;UpTime&#34;</span><span class="p">:</span><span class="s2">&#34;3000&#34;</span><span class="p">,</span><span class="s2">&#34;Address&#34;</span><span class="p">:</span><span class="s2">&#34;E:</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Interface</span><span class="se">\\</span><span class="s2">Results,E:</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Interface</span><span class="se">\\</span><span class="s2">Seens&#34;</span><span class="p">,</span><span class="s2">&#34;UpCDF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;UpREF&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;DealProcess&#34;</span><span class="p">:</span><span class="s2">&#34;MI.MIFXAIT3000&#34;</span><span class="p">,</span><span class="s2">&#34;Para&#34;</span><span class="p">:</span><span class="s2">&#34;.hl7&#34;</span><span class="p">,</span><span class="s2">&#34;PreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoMAll,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UPPreDealClass&#34;</span><span class="p">:</span><span class="s2">&#34;PreDeal.DealDemoM,PreDeal&#34;</span><span class="p">,</span><span class="s2">&#34;UpPara&#34;</span><span class="p">:</span><span class="s2">&#34;E:</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">Interface</span><span class="se">\\</span><span class="s2">ORDERS</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFIT300N).fileMTHD(&#34;34&#34;,&#34;MSH|^~\&amp;|LIS||HOST||20250317162926||ORU^R01^ORU_R01|20250317162926573175|P|2.5|||AL|ER[13][10]PID|1||0000486028||^郑龙怡||20000126|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^感染性疾病科[13][10]ORC|SC|1003777033|||CM||||20250317160618[13][10]OBR|1|1003777033|||||||||||||||||||||||F[13][10]OBX|1|NM|TRAB^TRAB||&lt;0.800|||LIMTL|||F|||20250317170643|E1^MU1-e801-1-2@5503[13][10]NTE|1||LIMTL[13][10]NTE|1||LIMTL[13][10]&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\&amp;|LIS||HOST||20250320102229||ORU^R01^ORU_R01|20250320102229442999|P|2.5|||AL|ER[13][10]PID|1||0000481255||^杨建利||19880623|M[13][10]PV1|1|U||||||||109|||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003782597|||CM||||20250320084145||||||||109[13][10]OBR|1|1003782597|||||||||||||||||||||||F[13][10]OBX|1|NM|GLU^GLU||8.830||||||F|||20250320100301|C2^MU1-c702-2-2@5607[13][10]OBX|2|NM|UREA^UREA||4.330||||||F|||20250320100306|C2^MU1-c702-2-1@5607[13][10]OBX|3|NM|UA^UA||434.900||||||F|||20250320100254|C2^MU1-c702-2-2@5607[13][10]OBX|4|NM|TP^TP||79.900||||||F|||20250320095858|C1^MU1-c702-1-1@5607[13][10]OBX|5|NM|ALB^ALB||46.000||||||F|||20250320095348|C1^MU1-c702-1-2@5607[13][10]OBX|6|NM|TBIL^TBIL||6.000||||||F|||20250320095923|C1^MU1-c702-1-1@5607[13][10]OBX|7|NM|DBIL^DBIL||1.800||||||F|||20250320095901|C1^MU1-c702-1-1@5607[13][10]OBX|8|NM|ALT^ALT||107.000||||||F|||20250320095900|C1^MU1-c702-1-2@5607[13][10]OBX|9|NM|AST^AST||62.300||||||F|||20250320095909|C1^MU1-c702-1-1@5607[13][10]OBX|10|NM|RGT^RGT||68.800||||||F|||20250320100259|C2^MU1-c702-2-1@5607[13][10]OBX|11|NM|ALP^ALP||83.700||||||F|||20250320095907|C1^MU1-c702-1-2@5607[13][10]OBX|12|NM|TRIGL^TRIGL||8.810||||||F|||20250320100304|C2^MU1-c702-2-2@5607[13][10]OBX|13|NM|TC^TC||4.910||||||F|||20250320100257|C2^MU1-c702-2-2@5607[13][10]OBX|14|NM|SCRE^SCRE||66.400||||||F|||20250320100313|C2^MU1-c702-2-1@5607[13][10]OBX|15|NM|9CYSC^CYSC_NEW||0.89||||||F|||20250320095916|C1^MU1-c702-1-1@5607[13][10]OBX|16|NM|9HDL^HDL_NEW||0.69||||||F|||20250320095914|C1^MU1-c702-1-2@5607[13][10]OBX|17|NM|9LDL^LDL_NEW||2.06||||||F|||20250320095921|C1^MU1-c702-1-2@5607[13][10]OBX|18|ST|XYZL^DM_SERQ||Z:脂血||||||F|||20250320083356[13][10]&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\&amp;|LIS||HOST||20250320151725||ORU^R01^ORU_R01|20250320151725880554|P|2.5|||AL|ER[13][10]PID|1||0000095425||^姚程成||19980712|M[13][10]PV1|1|U|||||||||||||||||^^^RC^^^^^健康管理中心[13][10]ORC|SC|1003784045|||CM||||20250320104114[13][10]OBR|1|1003784045|||||||||||||||||||||||F[13][10]OBX|1|NM|TP^TP||73.600||||||F|||20250320115059|C1^MU1-c702-1-1@5095[13][10]OBX|2|NM|ALB^ALB||49.600||||||F|||20250320114553|C1^MU1-c702-1-2@5095[13][10]OBX|3|NM|TBIL^TBIL||16.400||||||F|||20250320115110|C1^MU1-c702-1-1@5095[13][10]OBX|4|NM|DBIL^DBIL||4.400||||||F|||20250320115056|C1^MU1-c702-1-1@5095[13][10]OBX|5|NM|ALT^ALT||18.100||||||F|||20250320115057|C1^MU1-c702-1-2@5095[13][10]OBX|6|NM|AST^AST||22.900||||||F|||20250320115103|C1^MU1-c702-1-1@5095[13][10]OBX|7|NM|RGT^RGT||8.900||||||F|||20250320115522|C2^MU1-c702-2-1@5095[13][10]OBX|8|NM|ALP^ALP||78.100||||||F|||20250320115105|C1^MU1-c702-1-2@5095[13][10]&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\&amp;|LIS||HOST||20250321083434||ACK^^ACK|20250321083434378641|P|2.5|||NE|NE[13][10]EQU||^^^c702^^SAMPLEEVENT^SEEN|20250321083434[13][10]SAC|||1003775669|1003775669||20250321083433|01||P|c702|5719@4[13][10]&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFIT3000N1).fileMTHD(&#34;34&#34;,&#34;MSH|^~\&amp;|LIS||HOST||20250328191032||ORU^R01^ORU_R01|20250328191032737830|P|2.5|||AL|ER[13][10]PID|1||0000531818||^郑苹||19811117|F[13][10]PV1|1|U|||||||||||||||||^^^RI^^^^^心血管内科[13][10]ORC|SC|1003802907|||CM||||20250328191358[13][10]OBR|1|1003802907|||||||||||||||||||||||F[13][10]OBX|1|NM|U-CR^U-CR||5924.00||||||F|||20250328200846|C2^MU1-c702-2-1@4003|||||||||5924.00[13][10]OBX|2|NM|UR-MALB^UR-MALB||15.30|||OBS.RR|||F|||20250328200852|C2^MU1-c702-2-2@4003|||||||||15.30[13][10]NTE|1||OBS.RR[13][10]&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">非流水线分区代码</span>
</span></span><span class="line"><span class="cl"><span class="n">Parameter</span> <span class="n">FQCode</span> <span class="o">=</span> <span class="s2">&#34;WANTAI,XINCHANYE,LINJIAN,XIEGUANG&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">fileMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">record</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">record</span><span class="p">),</span><span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="n">filename</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="n">P4</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">P4</span><span class="p">),</span><span class="n">P5</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">P5</span><span class="p">),</span><span class="n">P6</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">P6</span><span class="p">),</span><span class="n">P7</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">P7</span><span class="p">),</span><span class="n">P8</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">P8</span><span class="p">),</span><span class="n">P9</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">P9</span><span class="p">),</span><span class="n">P10</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">P10</span><span class="p">),</span><span class="n">P11</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">P11</span><span class="p">),</span><span class="n">P12</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">P12</span><span class="p">),</span><span class="n">P13</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">P13</span><span class="p">),</span><span class="n">Sessions</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">Sessions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">filename</span><span class="p">[</span><span class="s2">&#34;Results&#34;</span> <span class="n">j</span> <span class="o">..</span><span class="n">ResultDo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">)</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">d</span> <span class="o">..</span><span class="n">ResultDo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">)</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">ResultDo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  	<span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;0&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">HospitalDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(record) q &#34;0&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">filename</span><span class="p">[</span><span class="s2">&#34;Seens&#34;</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;SeensRecord&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">i</span> <span class="n">filename</span><span class="p">[</span><span class="s2">&#34;Results&#34;</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;ResultsRecord&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;AllRecord&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">recordbak</span><span class="o">=</span><span class="n">record</span>		<span class="o">//</span><span class="err">仪器数据备份</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">commandName</span><span class="o">=</span><span class="s2">&#34;&#34;</span>	<span class="o">//</span><span class="err">前处理名称初始化</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">commandchild</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="o">//</span><span class="err">前处理命令初始化</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">DealDateStr</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="o">//</span><span class="n">MSH</span> <span class="err">时间初始化</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">QC</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="err">解析多行合并数据</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">recordbak</span><span class="p">,</span><span class="s2">&#34;[13][10]&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">s</span> <span class="n">record</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">recordbak</span><span class="p">,</span><span class="s2">&#34;[13][10]&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;解析行数据&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">i</span> <span class="s1">&#39;$l(record) q</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">s</span> <span class="n">type</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>	<span class="o">//</span><span class="err">取出消息头命令类型</span>
</span></span><span class="line"><span class="cl">		<span class="o">//</span><span class="err">解析</span><span class="n">MSH命令</span>
</span></span><span class="line"><span class="cl">		<span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;MSH&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">DateStr</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>	<span class="o">//</span><span class="err">取日期串</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DateStr</span><span class="p">)</span><span class="o">=</span><span class="mi">14</span> <span class="n">s</span> <span class="n">DealDateStr</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="p">((</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">DateStr</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span><span class="p">))</span>	<span class="o">//</span><span class="err">解析保存日期串</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	 	<span class="o">//</span><span class="err">解析</span><span class="n">EQU命令</span>	<span class="err">包含前处理后处理指令，根据指令记录对应事件</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;EQU&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 	<span class="o">//</span><span class="err">前处理名称</span>	<span class="n">RSA1</span> <span class="err">流水线处理信息，</span><span class="n">e801</span><span class="err">、</span><span class="n">P501_701</span>	<span class="err">仪器处理信息</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">commandName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		 	<span class="o">//</span><span class="err">获取前处理命令，</span><span class="n">SEEN</span> <span class="err">上机事件，</span><span class="n">RESULT</span> <span class="err">前处理分区事件，</span><span class="n">RSA1</span> <span class="err">未知事件，</span><span class="n">ARCHIVE</span> <span class="err">归档事件</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">commandchild</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		 	<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">commandchild</span><span class="p">,</span><span class="s2">&#34;前处理命令&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	 	<span class="o">//</span><span class="err">解析</span><span class="n">SAC命令</span>	<span class="err">根据</span><span class="n">EQU命令重获取到的前处理事件</span><span class="err">，进行</span><span class="n">LIS相关处理</span>
</span></span><span class="line"><span class="cl">	 	<span class="o">//</span><span class="err">本接口包括</span> <span class="n">SEEN</span> <span class="err">自动核收，</span><span class="n">ARCHIVE</span> <span class="err">记录归档位置</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;SAC&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>	<span class="o">//</span><span class="err">取出流水号</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">machCode</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>	<span class="o">//</span><span class="err">取出前处理分区信息或仪器信息</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">positioninfo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>	<span class="o">//</span><span class="err">取出位置信息</span>
</span></span><span class="line"><span class="cl">		 	<span class="o">//</span><span class="err">前处理</span><span class="n">SEEN</span> <span class="err">自动核收</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">i</span> <span class="n">commandchild</span><span class="o">=</span><span class="s2">&#34;SEEN&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			 	<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;分区信息，标本号:&#34;</span><span class="n">_epis_</span><span class="s2">&#34;的样本所在分区:&#34;</span><span class="n">_machCode_</span><span class="s2">&#34; &#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">i</span> <span class="n">commandName</span><span class="o">=</span><span class="s2">&#34;RSA1&#34;</span> <span class="n">j</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;分区位置:&#34;</span><span class="n">_machCode_</span><span class="s2">&#34;-&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;100&#34;</span><span class="p">)</span>	<span class="o">//</span><span class="err">前处理分区</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">e</span>  <span class="n">j</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;上机位置:&#34;</span><span class="n">_commandName_</span><span class="s2">&#34;-&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;6&#34;</span><span class="p">)</span>	<span class="o">//</span><span class="err">上机</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">try</span><span class="p">{</span><span class="n">d</span> <span class="o">..</span><span class="n">ZDHS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis</span><span class="p">,</span><span class="n">machCode</span><span class="p">,</span><span class="n">positioninfo</span><span class="p">)}</span><span class="n">catch</span> <span class="n">ex</span><span class="p">{</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">ex</span><span class="o">.</span><span class="n">Data</span><span class="p">,</span><span class="s2">&#34;自动核收提示&#34;</span><span class="p">)}</span>		<span class="o">//</span><span class="err">自动核收</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">i</span> <span class="n">commandName</span><span class="o">=</span><span class="s2">&#34;RSA1&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">			 	<span class="o">.</span><span class="n">i</span> <span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">..</span><span class="c1">#FQCode_&#34;,&#34;)&#39;[(&#34;,&#34;_machCode_&#34;,&#34;) d	//$TS$ 只有流水线仪器记录分区架子号</span>
</span></span><span class="line"><span class="cl">			 	<span class="o">..</span><span class="n">j</span> <span class="o">..</span><span class="n">SaveRackNo</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">machCode_</span><span class="s2">&#34;-&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;分区&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">e</span>  <span class="n">j</span> <span class="o">..</span><span class="n">SaveRackNo</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">commandName_</span><span class="s2">&#34;-&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;上机&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">		 	<span class="o">//</span><span class="err">前处理</span><span class="n">RESULT</span> <span class="err">处理分区信息</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">i</span> <span class="n">commandchild</span><span class="o">=</span><span class="s2">&#34;RESULT&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">s</span> <span class="n">curMachName</span><span class="o">=</span><span class="n">machCode</span>	<span class="o">//</span><span class="err">通过仪器对照码取仪器</span>
</span></span><span class="line"><span class="cl">			 	<span class="o">//</span><span class="err">此处存标本全部分区预处理的位置号</span>	<span class="err">针对非流水线标本分拣</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">i</span> <span class="n">commandName</span><span class="o">=</span><span class="s2">&#34;RSA1&#34;</span> <span class="n">j</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;分区位置:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;100&#34;</span><span class="p">)</span>	<span class="o">//</span><span class="err">前处理分区</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">i</span> <span class="n">commandName</span><span class="o">=</span><span class="s2">&#34;RSA1&#34;</span> <span class="n">j</span> <span class="o">..</span><span class="n">SaveRackNo</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;分区&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">		 	<span class="o">//</span><span class="err">前处理</span><span class="n">ARCHIVE</span> <span class="err">处理归档信息</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">i</span> <span class="n">commandchild</span><span class="o">=</span><span class="s2">&#34;ARCHIVE&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">s</span> <span class="n">curMachName</span><span class="o">=</span><span class="n">machCode</span>	<span class="o">//</span><span class="err">通过仪器对照码取仪器</span>
</span></span><span class="line"><span class="cl">			 	<span class="o">//</span><span class="err">此处存标本全部审核报告的位置号</span>
</span></span><span class="line"><span class="cl">			 	<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;归档信息，标本号:&#34;</span><span class="n">_epis_</span><span class="s2">&#34;的样本所在仪器:&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34; &#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			 	<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;执行记录分类信息:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">i</span> <span class="n">commandName</span><span class="o">=</span><span class="s2">&#34;RSA1&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">			 	<span class="o">.</span><span class="n">j</span> <span class="o">..</span><span class="n">SaveRackNo</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;归档&#34;</span><span class="p">)</span>	<span class="o">//</span><span class="err">保存归档信息到架子号</span>
</span></span><span class="line"><span class="cl">			 	<span class="o">.</span><span class="n">j</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;冰箱归档位置:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;62&#34;</span><span class="p">)</span>	<span class="o">//</span><span class="err">冰箱归档</span>
</span></span><span class="line"><span class="cl">			 	<span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">			 	<span class="o">.</span><span class="n">j</span> <span class="o">..</span><span class="n">SaveRackNo</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;归档中&#34;</span><span class="p">)</span>	<span class="o">//</span><span class="err">保存归档信息到架子号</span>
</span></span><span class="line"><span class="cl">			 	<span class="o">.</span><span class="n">j</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;归档中位置:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;62&#34;</span><span class="p">)</span>	<span class="o">//</span><span class="err">归档</span>
</span></span><span class="line"><span class="cl">			 	<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;记录归档信息完成&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			 
</span></span><span class="line"><span class="cl">			 
</span></span><span class="line"><span class="cl">		 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	 
</span></span><span class="line"><span class="cl">	 	<span class="o">//</span><span class="err">解析质控数据</span><span class="p">,</span><span class="n">P业务数据</span><span class="err">，</span><span class="n">Q质控数据</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;ORC&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	 
</span></span><span class="line"><span class="cl">	 	<span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;OBR&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	 	<span class="o">//</span><span class="err">仪器报警信息</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;NTE&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">WaringStr</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">WaringCode</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">WaringStr</span><span class="p">,</span><span class="s2">&#34; &#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		 	<span class="p">;</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;仪器报警信息:&#34;</span><span class="n">_WaringStr</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		 	<span class="o">//</span><span class="err">保存仪器报警信息到组内报告评价</span>
</span></span><span class="line"><span class="cl">		 	<span class="p">;</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveResultWarned</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="n">WaringStr</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">try</span><span class="p">{</span><span class="n">j</span> <span class="c1">##class(MI.Special.Record).RecordData(epis,recordbak,&#34;LSLSXGET&#34;,1,1,10)}catch{}	//YHR 20230828 记录十天的数据</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">i</span> <span class="n">type</span><span class="o">=</span><span class="s2">&#34;OBX&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">machCode</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>	<span class="o">//</span><span class="err">仪器信息和架子号信息</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">code</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">res</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">CallThePolice</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>	<span class="o">//</span><span class="err">项目报警信息</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">s</span> <span class="n">res</span><span class="o">=..</span><span class="n">ConvertResult</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>		<span class="o">//</span><span class="err">结果特殊转换</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">CallThePolice</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		 	<span class="o">.</span><span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_code_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_res_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_CallThePolice_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>		<span class="o">//</span><span class="n">YHR</span> <span class="mi">20250328</span> <span class="err">将报警信息存入到其他结果字段</span>
</span></span><span class="line"><span class="cl">		 	<span class="o">.</span><span class="n">try</span><span class="p">{</span><span class="n">j</span> <span class="o">..</span><span class="n">SaveResultWarned</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;存在仪器报警信息&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;41&#34;</span><span class="p">)}</span><span class="n">catch</span><span class="p">{}</span>		<span class="o">//</span><span class="n">YHR</span> <span class="mi">20250329</span> <span class="err">存储报警信息标志，此处</span><span class="mi">41</span><span class="err">为常规生化工作小组</span><span class="o">$</span><span class="n">TS</span><span class="o">$</span>
</span></span><span class="line"><span class="cl">		 	<span class="n">e</span>  <span class="n">s</span> <span class="n">result</span><span class="o">=</span><span class="n">result_code_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="n">_res_</span><span class="o">$</span><span class="n">c</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="p">}</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;$$&#34;</span><span class="n">_result</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="err">统一保存结果</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">result</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DealDateStr</span><span class="p">){</span>	<span class="o">//</span><span class="err">如果记录到时间，则根据仪器时间存储结果。</span>
</span></span><span class="line"><span class="cl">	 		<span class="n">s</span> <span class="n">date</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">DealDateStr</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 		<span class="n">s</span> <span class="n">time</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">DealDateStr</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	 		<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="s1">&#39;=8 s date=&#34;&#34;,time=&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	 	
</span></span><span class="line"><span class="cl">	 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">d</span> <span class="c1">##Class(MI.Common.MIFBase).Save(mi, epis, result, date, time, QC)</span>
</span></span><span class="line"><span class="cl"> 	<span class="p">}</span>
</span></span><span class="line"><span class="cl">		 
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">结果特殊转换</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="o">$</span><span class="n">TS</span><span class="o">$</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">W</span> <span class="c1">##CLASS(MI.MIFIT3000N1).ConvertResult(&#34;9PA&#34;,&#34;&lt;0.070&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">ConvertResult</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">code</span><span class="o">=</span><span class="s2">&#34;9PA&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&lt;&#34;</span><span class="p">,</span><span class="o">+$</span><span class="n">e</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;.07&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">res</span><span class="o">=</span><span class="s2">&#34;&lt;70&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">报警信息转换</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">ConvertPoliceInfo</span><span class="p">(</span><span class="n">WaringCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;5&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;ABS(超出ABS)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;43&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Cal.E(校准结果异常)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;2&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Cuvet(反应杯空白异常)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;42&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Edit(实验结果已被编辑)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;23&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;ISE(超出ISE范围)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;19&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;ISE.E(ISE电压级错误)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;56&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Kin(Prozone错误2/运动不稳)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;10&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Lin(线性异常)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;11&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Lin(线性异常)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;6&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Prozone(Prozone错误1)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;4&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Reag.S(试剂不足)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;44&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Rept(高出原倍复查范围)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;45&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&lt;Rept(低于原倍复查范围)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;46&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Samp.？(高出ABS最大值)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;68&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Samp.B(样本中有气泡)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;72&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;Samp.C(样本中有凝块)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;26&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&gt;Test(高出线性范围)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">WaringCode</span><span class="o">=</span><span class="s2">&#34;27&#34;</span> <span class="n">s</span> <span class="n">WaringStr</span><span class="o">=</span><span class="s2">&#34;&lt;Test(低于线性范围)&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">q</span> <span class="n">WaringStr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">记录标本日志</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).SaveRecord(&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveRecord</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span> <span class="n">OperateNotes</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">OperateTypeCode</span><span class="p">,</span> <span class="n">curWorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">OperateNotes</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">OperateNotes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">OperateTypeCode</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">OperateTypeCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.//</span><span class="err">标本</span><span class="n">ID</span><span class="p">,</span><span class="err">操作时间</span><span class="p">,</span><span class="err">操作者</span><span class="p">,</span><span class="err">操作说明</span><span class="p">,</span><span class="err">操作类型</span><span class="p">,</span><span class="err">工作组</span><span class="p">,</span><span class="err">标本拒收类型</span>
</span></span><span class="line"><span class="cl">	<span class="o">.//</span><span class="n">BTOperatorType</span> <span class="err">标本操作类型表</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">d</span> <span class="c1">##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,&#34;,&#34;,2),&#34;&#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">保存报告表报警信息标志</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFIT3000N1).SaveResultWarned(&#34;1003803130&#34;,&#34;1&#34;,&#34;34&#34;,&#34;41&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveResultWarned</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span> <span class="n">conclusion</span><span class="p">,</span> <span class="n">predealMI</span><span class="p">,</span> <span class="n">curWorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">conclusion</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">conclusion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">predealMI</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">predealMI</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">conclusion</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">20</span> <span class="n">s</span> <span class="n">conclusion</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">conclusion</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;...&#34;</span> 
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">s</span> <span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">Status</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">22</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="n">Status</span><span class="o">=</span><span class="s2">&#34;3&#34;</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">ResultWarned</span><span class="o">=</span><span class="n">conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">predealMI</span><span class="p">,</span><span class="s2">&#34;-1^存标本质量信息失败:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">),</span><span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">ResultWarned</span><span class="o">=</span><span class="n">conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">predealMI</span><span class="p">,</span><span class="n">labno_</span><span class="s2">&#34;:没有找到报告&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">保存评价信息</span><span class="p">(</span><span class="err">标本质量</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).SaveConclusion(&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveConclusion</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span> <span class="n">conclusion</span><span class="p">,</span> <span class="n">predealMI</span><span class="p">,</span> <span class="n">curWorkGroupMachineDR</span><span class="p">,</span> <span class="n">IsPrint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">conclusion</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">conclusion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">predealMI</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">predealMI</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">IsPrint</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">IsPrint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">IsPrint</span><span class="s1">&#39;=1 s IsPrint=&#34;0&#34;	//1 打印主评价，0 不打印次评价</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">s</span> <span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">Status</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">22</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="n">Status</span><span class="o">=</span><span class="s2">&#34;3&#34;</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="n">IsPrint</span><span class="o">=</span><span class="mi">1</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">objrep</span><span class="o">.</span><span class="n">MajorConclusion</span><span class="p">)</span> <span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">MajorConclusion</span><span class="o">=</span><span class="n">objrep</span><span class="o">.</span><span class="n">MajorConclusion_</span><span class="s2">&#34;,&#34;</span><span class="n">_conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">e</span>  <span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">MajorConclusion</span><span class="o">=</span><span class="n">conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">objrep</span><span class="o">.</span><span class="n">MinorConclusion</span><span class="p">)</span> <span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">MinorConclusion</span><span class="o">=</span><span class="n">objrep</span><span class="o">.</span><span class="n">MinorConclusion_</span><span class="s2">&#34;,&#34;</span><span class="n">_conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">e</span>  <span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">MinorConclusion</span><span class="o">=</span><span class="n">conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">predealMI</span><span class="p">,</span><span class="s2">&#34;-1^存标本质量信息失败:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">),</span><span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">IsPrint</span><span class="o">=</span><span class="mi">1</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">MajorConclusion</span><span class="o">=</span><span class="n">conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">e</span>  <span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">MinorConclusion</span><span class="o">=</span><span class="n">conclusion</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">predealMI</span><span class="p">,</span><span class="n">labno_</span><span class="s2">&#34;:没有找到报告&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">保存归档</span><span class="p">,</span><span class="err">分类信息</span><span class="p">,</span><span class="err">架子号</span><span class="p">,</span><span class="err">新增保存类型和参数工作小组</span><span class="n">ID</span><span class="err">，针对仪器不在对应的工作小组也可以保存架子号。</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.Special.Common).SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.Special.Common).SaveRackNo(&#34;1003775669&#34;,&#34;c702-5719@4&#34;,&#34;34&#34;,&#34;上机&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveRackNo</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span> <span class="n">positioninfo</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">typename</span><span class="p">,</span> <span class="n">curWorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">positioninfo</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">positioninfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">),</span><span class="n">typename</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">typename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$L(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">typename</span><span class="p">)</span> <span class="n">s</span> <span class="n">positioninfo</span><span class="o">=</span><span class="n">typename_</span><span class="s2">&#34;:&#34;</span><span class="n">_positioninfo</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">s</span> <span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">OrderNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">OrderNo</span><span class="p">,</span><span class="n">ReportDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">ReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">ReportDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">objrep</span><span class="o">.</span><span class="n">RackNo</span><span class="p">)</span> <span class="n">j</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;架子号位置更新:&#34;</span><span class="n">_objrep</span><span class="o">.</span><span class="n">RackNo_</span><span class="s2">&#34;--&gt;&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">)</span>	<span class="o">//</span><span class="err">架子号更新</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">RackNo</span><span class="o">=</span><span class="n">positioninfo</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;-1^存&#34;</span><span class="n">_typename_</span><span class="s2">&#34;信息失败:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexEpisodeNo&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">curWorkGroupMachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">=</span><span class="c1">##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">objrep</span><span class="o">.</span><span class="n">RackNo</span><span class="p">)</span> <span class="n">j</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;架子号位置更新:&#34;</span><span class="n">_objrep</span><span class="o">.</span><span class="n">RackNo_</span><span class="s2">&#34;--&gt;&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;101&#34;</span><span class="p">)</span>	<span class="o">//</span><span class="err">架子号更新</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">objrep</span><span class="o">.</span><span class="n">RackNo</span><span class="o">=</span><span class="n">positioninfo</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objrep</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">hasFindRep</span><span class="o">=</span><span class="mi">0</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno_</span><span class="s2">&#34;:没有找到报告&#34;</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">hasFindRep</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">保存标本图片</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFRS600).SaveImageMTHD(&#34;57&#34;,&#34;1000100990&#34;,&#34;P&#34;,&#34;/iLISLIS080/demo.png&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">D</span> <span class="c1">##class(MI.MIFIT3000N1).SaveImageMTHD(&#34;34&#34;,&#34;1003783657_01&#34;,&#34;1003783657_01&#34;,&#34;/iLISLIS032/20250321/1003783657_01.jpg&#34;,&#34;C:\LISDATA\DATA\1003783657_01.jpg&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveImageMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">ImageClass</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">^</span><span class="n">YHR</span><span class="p">(</span><span class="s2">&#34;MI.MIFIT3000&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">ImageClass</span><span class="p">,</span> <span class="n">FileName</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=</span><span class="n">mi</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">epis</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">epis</span><span class="p">,</span><span class="s2">&#34;_&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ImageClass</span><span class="o">=</span><span class="s2">&#34;P&#34;</span><span class="n">_</span><span class="o">+$</span><span class="n">p</span><span class="p">(</span><span class="n">ImageClass</span><span class="p">,</span><span class="s2">&#34;_&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  	<span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="o">//</span><span class="err">标本血清质量特殊处理</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(epis))) d </span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(epis),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberImageI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">RowID</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">RowID</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberImageI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span><span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPVisitNumberImage).%OpenId(RowID)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">VisitNumberDR</span><span class="o">=</span><span class="n">VisitNumberDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">ImageClass</span><span class="o">=</span><span class="s2">&#34;SerumQ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">ImageID</span><span class="o">=</span><span class="n">ImageClass</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">FileName</span><span class="o">=</span><span class="n">FileName</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span> <span class="s2">&#34;-1^保存报告图片失败:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">epis_</span><span class="s2">&#34;:&#34;</span><span class="n">_ImageClass_</span><span class="s2">&#34;:&#34;</span><span class="n">_FileName</span><span class="p">,</span><span class="s2">&#34;H&lt;--M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span> <span class="n">ImageOrder</span><span class="p">,</span> <span class="n">Caption</span><span class="p">,</span> <span class="n">DisplayRatio</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">w</span> <span class="c1">##class(MI.MIFRS600).GetFtpMTHD(&#34;24&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetFtpMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">文件服务模式必须改的地方，老的</span><span class="n">FTP模式这么改了也没问题</span><span class="err">，所以建议都这样</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="c1">##Class(MI.Common.MIFBase).GetMiFtpPath(mi)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Creator</span><span class="err">：</span>      <span class="err">查询患者信息，监听配置上传前处理类后会定时调用这个</span><span class="n">query查询数据进行上传操作</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">CreatDate</span><span class="err">：</span>    <span class="mi">20140919</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="p">:</span><span class="err">：</span> 
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>      
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="n">mi</span><span class="err">：仪器主键</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Others</span><span class="err">：</span>     
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">QryLabInfo</span><span class="p">(</span><span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Query</span><span class="p">(</span><span class="n">ROWSPEC</span> <span class="o">=</span> <span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Query的执行方法</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(%ResultSet).RunQuery(&#34;MI.MIFIT3000N1&#34;,&#34;QryLabInfo&#34;,&#34;34&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoExecute</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">i</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">flag</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">LabnoList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">OutPutNum</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="o">//*--------------------------------&gt;*</span><span class="err">申请项目</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:(AddDate=&#34;&#34;)||(OutPutNum&gt;6)  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:(AddTime=&#34;&#34;)||(OutPutNum&gt;6)  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">OutPutNum</span><span class="o">=</span><span class="n">OutPutNum</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">EpisNo</span><span class="o">=$$</span><span class="n">getEpis</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">i</span> <span class="s1">&#39;$l(EpisNo) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno)) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">)),</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="p">((</span><span class="o">+$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ReceiveTime</span><span class="o">&gt;=-</span><span class="mi">2</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">((</span><span class="o">+$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ReceiveTime</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno_</span><span class="s2">&#34;标本接收时间低于5秒不上传&#34;</span><span class="p">,</span><span class="s2">&#34;等待上传&#34;</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">文本双向上传开始</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=..</span><span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;@C&#34;</span>		<span class="o">//</span><span class="err">重新获取通道号</span> <span class="err">避免因为接收造成漏项目</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">replace</span><span class="p">(</span><span class="n">TCList</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,&#34;</span><span class="o">+</span><span class="s2">&#34;)_&#34;</span><span class="o">|</span><span class="err">@</span><span class="sa">U</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;申请上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">try</span><span class="p">{</span><span class="n">d</span> <span class="c1">##class(MI.Special.Record).RecordData(labno,&#34;C@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}	//YHR 20230828 记录十天的数据</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">文本双向上传结束</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">//*--------------------------------&gt;*</span><span class="err">复查结果上传</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">文本双向上传开始</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">replace</span><span class="p">(</span><span class="n">TCList</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,&#34;</span><span class="o">+</span><span class="s2">&#34;)_&#34;</span><span class="o">|</span><span class="err">@</span><span class="sa">U</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;复查上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">try</span><span class="p">{</span><span class="n">d</span> <span class="c1">##class(MI.Special.Record).RecordData(labno,&#34;U@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}	//YHR 20230828 记录十天的数据</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">文本双向上传结束</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">//*--------------------------------&gt;*</span><span class="err">取消项目</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">文本双向上传开始</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=..</span><span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;@R&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;取消上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">try</span><span class="p">{</span><span class="n">d</span> <span class="c1">##class(MI.Special.Record).RecordData(labno,&#34;R@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}	//YHR 20230828 记录十天的数据</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">文本双向上传结束</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">文本双向上传开始</span><span class="o">******************************************************</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="s2">&#34;DM_OVER&#34;</span><span class="n">_</span><span class="s2">&#34;@C&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;审核上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">try</span><span class="p">{</span><span class="n">d</span> <span class="c1">##class(MI.Special.Record).RecordData(labno,&#34;T@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}	//YHR 20230828 记录十天的数据</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ColFields</span><span class="o">=</span><span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span><span class="o">=</span><span class="c1">##Class(LIS.Util.Common).TransListNull(Data,ColFields)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">quit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoClose</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Kill</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoFetch</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">Row</span> <span class="n">As</span> <span class="o">%</span><span class="n">List</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">AtEnd</span> <span class="n">As</span> <span class="o">%</span><span class="n">Integer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">If</span> <span class="n">ind</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Else</span>      <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">AtEnd</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">获取申请名称和内容</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">申请名称：</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">发送申请：</span><span class="n">order_2012051718302501_9999999901NW</span><span class="o">.</span><span class="n">HL7</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">取消申请：</span><span class="n">order_2012051718302501_9999999901CA</span><span class="o">.</span><span class="n">HL7</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">项目复查：</span><span class="n">order_2012051718302501_9999999901XO</span><span class="o">.</span><span class="n">HL7</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFRS600).GetLisOrderMTHD(&#34;8&#34;,&#34;POS@C@1&#34;,&#34;2018-08-21 10:35:37,RSA_CC,RSA_CE,1000001551,,,ebhk-耳鼻咽喉科,于何,穆润清,0022000108,杜娇,2,住院,24182,18,,1000001551,2018-08              -18 11:12,,,,,慢性化脓性中耳炎,,,,2018-08-18 11:12,,,19991011&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;        ,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFIT300N).GetLabnoInfoN(&#34;34&#34;,&#34;1003779663,DM_OVER@C&#34;,&#34;2025-03-18□19:07:07,IT3000,,,,急诊内科,测试医生(勿选）,检验管理员,0000243381,陈耀明,1,急诊,,34,,1003779663,2025-03-18□18:24,,,,,眩晕,,,,2025-03-18□18:24,,,19900920&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labnoInfo</span><span class="p">,</span> <span class="n">patInfo</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">VT</span><span class="o">=</span><span class="s2">&#34;[11]&#34;</span><span class="p">,</span><span class="n">FS</span><span class="o">=</span><span class="s2">&#34;[28]&#34;</span><span class="p">,</span><span class="n">CR</span><span class="o">=</span><span class="s2">&#34;[13]&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labNo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sampleno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">i</span> <span class="n">labNo</span><span class="o">=</span><span class="s2">&#34;74623177&#34;</span> <span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;zlzit3000d&#34;</span><span class="p">)</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labnoInfo</span><span class="p">,</span> <span class="n">patInfo</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">location</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">docName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">regNo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">patName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">sex</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="n">s</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;M&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span> <span class="n">s</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;F&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="p">(</span><span class="n">sex</span><span class="s1">&#39;=&#34;M&#34;)&amp;&amp;(sex&#39;</span><span class="o">=</span><span class="s2">&#34;F&#34;</span><span class="p">)</span> <span class="n">s</span> <span class="n">sex</span><span class="o">=</span><span class="s2">&#34;U&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">birthDate</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">29</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">collectTime</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span> <span class="p">;</span><span class="mi">2017</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">14</span> <span class="mi">11</span><span class="p">:</span><span class="mi">57</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">collectTime</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">collectTime</span><span class="p">,</span><span class="s2">&#34;- :&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;00&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">status</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">labnoInfo</span><span class="p">,</span><span class="s2">&#34;@&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">labnoInfo</span><span class="p">,</span><span class="s2">&#34;@&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">curTime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">PatType</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Wardno</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RO&#34;</span>  <span class="o">//</span><span class="err">门诊</span><span class="o">=</span><span class="n">RO</span><span class="p">,</span><span class="err">住院</span><span class="o">=</span><span class="n">RI</span><span class="p">,</span><span class="err">体检</span><span class="o">=</span><span class="n">RC</span><span class="p">,</span><span class="err">急诊</span><span class="o">=</span><span class="n">RS</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="n">PatType</span><span class="o">=</span><span class="s2">&#34;住院&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RI&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="n">PatType</span><span class="o">=</span><span class="s2">&#34;门诊&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RO&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="n">PatType</span><span class="o">=</span><span class="s2">&#34;急诊&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RS&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="n">PatType</span><span class="o">=</span><span class="s2">&#34;体检&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RC&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="n">PatType</span><span class="o">=</span><span class="s2">&#34;干诊&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   		<span class="n">S</span> <span class="n">patTypeFlag</span><span class="o">=</span><span class="s2">&#34;RC&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AssayNo</span><span class="o">=..</span><span class="n">GetReportAssayNoMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labNo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">MSN</span><span class="o">=</span><span class="s2">&#34;MSH|^~\&amp;|DHC-LIS|IT3000|||||OML^O21|&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zdt</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34; &#34;&#34;:&#34;&#34;-&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;SND&#34;</span><span class="n">_labNo_</span><span class="s2">&#34;|P|2.3|||NE|NE||&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">PID</span><span class="o">=</span><span class="s2">&#34;PID|1||&#34;</span><span class="n">_regNo_</span><span class="s2">&#34;|&#34;</span><span class="n">_docName_</span><span class="s2">&#34;|^&#34;</span><span class="n">_patName_</span><span class="s2">&#34;||&#34;</span><span class="n">_birthDate_</span><span class="s2">&#34;|&#34;</span><span class="n">_sex</span>  <span class="o">//</span><span class="n">_location</span> 
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">PV1</span><span class="o">=</span><span class="s2">&#34;PV1|||?|||||||||||||||||&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">DG1</span><span class="o">=</span><span class="s2">&#34;DG1|||00000^default|||F&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">s</span> <span class="n">IN1</span><span class="o">=</span><span class="s2">&#34;IN1|||China-Bank&#34;</span> 
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">s</span> <span class="n">ORC</span><span class="o">=</span><span class="s2">&#34;ORC|NW|&#34;</span><span class="n">_labNo_</span><span class="s2">&#34;|&#34;</span><span class="n">_regNo_</span><span class="s2">&#34;||||R||&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">),</span><span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;|&#34;</span><span class="n">_docName</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">orcF1</span><span class="o">=</span><span class="s2">&#34;NW&#34;</span><span class="p">,</span><span class="n">orcF2</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;R&#34;</span> <span class="n">s</span> <span class="n">orcF1</span><span class="o">=</span><span class="s2">&#34;CA&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;U&#34;</span> <span class="n">s</span> <span class="n">orcF1</span><span class="o">=</span><span class="s2">&#34;XO&#34;</span> <span class="n">s</span> <span class="n">orcF2</span><span class="o">=</span><span class="s2">&#34;SC&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ORC</span><span class="o">=</span><span class="s2">&#34;ORC|&#34;</span><span class="n">_orcF1_</span><span class="s2">&#34;|&#34;</span><span class="n">_labNo_</span><span class="s2">&#34;|&#34;</span><span class="n">_AssayNo_</span><span class="s2">&#34;||&#34;</span><span class="n">_orcF2_</span><span class="s2">&#34;||&#34;</span><span class="n">_patTypeFlag_</span><span class="s2">&#34;|&#34;</span><span class="n">_location_</span><span class="s2">&#34;|&#34;</span><span class="n">_</span><span class="o">..</span><span class="n">GetReceiveDateTime</span><span class="p">(</span><span class="n">labNo</span><span class="p">)</span> <span class="o">//</span><span class="n">change</span> <span class="n">by</span> <span class="n">sch20210421</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">s</span><span class="p">:</span><span class="n">orcF1</span><span class="s1">&#39;=&#34;XO&#34; ORC=&#34;ORC|&#34;_orcF1_&#34;|&#34;_labNo_&#34;|&#34;_AssayNo_&#34;||&#34;_orcF2_&#34;||&#34;_patFLAG_&#34;||&#34;_$tr($zdt($h,3),&#34; &#34;&#34;:&#34;&#34;-&#34;) //_&#34;|&#34;_docName //&#34;_regNo_&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">s</span> <span class="n">NTE</span><span class="o">=</span><span class="s2">&#34; NTE||I|Code: C1 Comment: Sample comment 1|&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">obrF1</span><span class="o">=</span><span class="s2">&#34;A&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">status</span><span class="o">=</span><span class="s2">&#34;U&#34;</span> <span class="n">s</span> <span class="n">obrF1</span><span class="o">=</span><span class="s2">&#34;G&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">OBR</span><span class="o">||</span><span class="mi">2012081501</span><span class="o">||</span><span class="n">ROCHE_AFP</span><span class="o">|||</span><span class="mi">20120814160023</span><span class="o">|||</span><span class="mi">9999</span><span class="o">|</span><span class="n">A</span> 
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">OBR</span><span class="o">=</span><span class="s2">&#34;OBR||&#34;</span><span class="n">_labNo_</span><span class="s2">&#34;||GLU|||||||&#34;</span><span class="n">_obrF1</span> <span class="o">//</span><span class="s2">&#34;_collectTime_&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">;</span><span class="n">s</span> <span class="n">OBX</span><span class="o">=</span><span class="s2">&#34;OBX|2|ST|AHBS^6012^||45.290^Instrument flag!|mol/L| - ^^||5221^1||F|||20170816152751|356^COBAS8000B:E602C2|DATOS_PRJ^16-8月 -17^^|&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">OBRs</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">labnoInfo</span><span class="p">,</span><span class="s2">&#34;@&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;POS&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">OBRs</span><span class="o">=</span><span class="s2">&#34;OBR||&#34;</span><span class="n">_labNo_</span><span class="s2">&#34;||POS|||&#34;</span><span class="n">_collectTime_</span><span class="s2">&#34;||||&#34;</span><span class="n">_obrF1</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">d</span> <span class="n">GetOBRs</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="n">s</span> <span class="n">orderTxt</span><span class="o">=</span><span class="n">VT_MSN_CR_PID_CR_PV1_CR_DG1_CR_ORC_CR_OBRs_FS</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">orderTxt</span><span class="o">=</span><span class="n">VT_MSN_CR_PID_CR_ORC_CR_OBRs_FS</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">orderTxt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GetOBRs</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">items</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">labnoInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="s2">&#34;+&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">item</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="s2">&#34;+&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">splitStr</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">OBR</span><span class="p">,</span><span class="s2">&#34;|&#34;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">curOBR</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">OBR</span><span class="p">,</span><span class="n">splitStr</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="n">_item_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">OBR</span><span class="p">,</span><span class="n">splitStr</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">OBRs</span><span class="o">=</span><span class="n">OBRs_curOBR_CR</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFIT3000).GetReportAssayNoMTHD(8,&#34;1905074122&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetReportAssayNoMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">mi</span><span class="o">=</span> <span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">S</span> <span class="n">labno</span><span class="o">=</span> <span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(labno) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(mi) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="p">(</span><span class="n">orderno</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="n">_labno</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">WGMDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(WGMDR) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">orderno</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WGMDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(orderno) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">reportDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WGMDR</span><span class="p">,</span><span class="n">orderno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AssayNo</span> <span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">reportDR</span><span class="p">)),</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="n">AssayNo</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">W</span> <span class="c1">##class(MI.MIFIT300N).GetReceiveDateTime(&#34;1003775372&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetReceiveDateTime</span><span class="p">(</span><span class="n">Labnum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span><span class="p">:</span><span class="s1">&#39;$l(Labnum) &#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">VisitnumberDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">ReceiveDate</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">ReceiveTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">ReceiveDateTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">VisitnumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="n">_Labnum</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">VisitnumberDR</span><span class="p">)</span> <span class="n">ReceiveDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitnumberDR</span><span class="p">),</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">VisitnumberDR</span><span class="p">)</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitnumberDR</span><span class="p">),</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">)</span><span class="o">&amp;$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveTime</span><span class="p">)</span> <span class="n">ReceiveDateTime</span><span class="o">=</span><span class="n">ReceiveDate_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">ReceiveTime</span><span class="p">),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ReceiveDateTime</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFLISMonitorTest).GetLabnoInfo(6,1001367)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFIT3000N1).GetLabnoInfo(34,&#34;8000001003&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">获取项目通道号</span>
</span></span><span class="line"><span class="cl">   	<span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">   	<span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">tcx_chl_</span><span class="s2">&#34;+&#34;</span>   
</span></span><span class="line"><span class="cl">   	<span class="n">s</span> <span class="n">tcx</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="n">k</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span> <span class="n">s</span> <span class="n">tcx</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_tcx_</span><span class="s2">&#34;|&#34;</span>
</span></span><span class="line"><span class="cl">   	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">tcx</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span><span class="s2">&#34;共&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="s2">&#34;+&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;个项目。&#34;</span><span class="n">_tcx</span><span class="p">,</span><span class="s2">&#34;H--&gt;M&#34;</span><span class="p">)</span> <span class="o">//</span><span class="n">YHR</span> <span class="mi">20230816</span> <span class="err">将上传信息存入罗氏</span><span class="n">infinity仪器</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">tcx</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFRS600).GetPatInfo(57,9000001912)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">labno</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">VisitNumberDR</span> <span class="o">=</span> <span class="o">$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">标本信息</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RPVisitNumberData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LocationDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">22</span><span class="p">),</span><span class="n">Location</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Location</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTLocationD</span><span class="p">(</span><span class="n">LocationDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">DoctorDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">Doctor</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Doctor</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDoctorD</span><span class="p">(</span><span class="n">DoctorDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">66</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ReceiveUserDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">68</span><span class="p">),</span><span class="n">ReceiveUser</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">ReceiveUser</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">SYSUserD</span><span class="p">(</span><span class="n">ReceiveUserDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RegNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SurName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">GivenName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">SurName</span><span class="o">=</span><span class="n">GivenName</span> <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName</span>
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">s</span> <span class="n">PatName</span><span class="o">=</span><span class="n">SurName_GivenName</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">SpeciesDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span><span class="n">Species</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Species</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTSpeciesD</span><span class="p">(</span><span class="n">SpeciesDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AdmTypeDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">AdmType</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AdmType</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAdmissionTypeD</span><span class="p">(</span><span class="n">AdmTypeDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BedNo</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Age</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BirthDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">AgeUnitDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span><span class="n">AgeUnit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AgeUnit</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTAgeUnitD</span><span class="p">(</span><span class="n">AgeUnitDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CollectDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">51</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CollectTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Sampleda</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Instrument</span> <span class="o">=</span> <span class="s2">&#34;XN&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="n">s</span> <span class="n">Instrument</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="mi">22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">Instrument</span><span class="p">)</span> <span class="n">s</span> <span class="n">Instrument</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">Instrument</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sampleno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>   <span class="o">//</span><span class="err">病案号</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sampletype</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">Feetype</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">;</span><span class="err">费别</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Srcdepno</span><span class="o">=</span><span class="n">Location</span>  <span class="p">;</span><span class="err">送检科室</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Srcdocno</span><span class="o">=</span><span class="n">Doctor</span>   <span class="p">;</span><span class="err">送检医生</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Userno</span><span class="o">=</span><span class="n">ReceiveUser</span> <span class="p">;</span><span class="err">检验医生</span><span class="p">(</span><span class="err">录入者</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Patno</span><span class="o">=</span><span class="n">RegNo</span> <span class="p">;</span><span class="err">登记号</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">BarCode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Patna</span><span class="o">=</span><span class="n">PatName</span>   <span class="p">;</span><span class="err">病人姓名</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="mi">1</span>  <span class="p">;</span><span class="err">性别</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">Species</span><span class="o">=</span><span class="s2">&#34;男&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>     <span class="p">;</span><span class="mi">1</span><span class="p">:</span><span class="err">男</span> <span class="err">，</span><span class="mi">2</span> <span class="err">女</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">Species</span> <span class="o">=</span><span class="s2">&#34;女&#34;</span> <span class="n">s</span> <span class="n">Sex</span><span class="o">=</span><span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Pattype</span><span class="o">=</span><span class="n">AdmType</span>   <span class="p">;</span><span class="err">病人类型</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Bedno</span> <span class="o">=</span> <span class="n">BedNo</span>    <span class="p">;</span><span class="err">床号</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Patage</span><span class="o">=</span><span class="n">Age</span>  <span class="p">;</span><span class="err">年龄</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Ageunit</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">年龄单位</span>
</span></span><span class="line"><span class="cl">  	<span class="n">s</span> <span class="n">Reqno</span><span class="o">=</span><span class="n">labno</span>  <span class="p">;</span><span class="err">申请号</span> <span class="o">=</span> <span class="err">检验号</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reqda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Reqda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">ReceiveDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">ReceiveTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span><span class="err">送检日期</span> <span class="o">=</span> <span class="err">接收时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reportda</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">报告日期</span>  <span class="o">=</span> <span class="err">初审</span><span class="p">(</span><span class="err">保存结果</span><span class="p">)</span><span class="err">时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Printflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">打印标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Resultflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">结果标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Errflag</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">错误标志</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Diagnose</span> <span class="o">=</span> <span class="n">Diagnose</span>   <span class="p">;</span><span class="err">诊断</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Description</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">备注</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Reserve</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="p">;</span><span class="err">保留字段</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Patnamn</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="p">;</span><span class="err">姓名拼音码</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">Getda</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;-&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">e</span><span class="p">(</span><span class="n">CollectDate</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34; &#34;</span><span class="n">_</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="n">CollectTime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="n">e</span>  <span class="n">s</span> <span class="n">Getda</span><span class="o">=</span><span class="n">Reqda</span> <span class="p">;</span><span class="err">接收时间</span><span class="o">/</span><span class="err">采样日期</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Wardno</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WardnoDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">RPVisitNumberData</span><span class="p">,</span><span class="mi">26</span><span class="p">)</span>  <span class="p">;</span><span class="err">病区</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">WardnoDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">Wardno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWardD</span><span class="p">(</span><span class="n">WardnoDR</span><span class="p">)),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">Sampleda</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Instrument</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Sampleno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Sampletype</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Feetype</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Srcdepno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Srcdocno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Userno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Patno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Patna</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Sex</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Pattype</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Bedno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Patage</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Ageunit</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Reqno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Reqda</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Reportda</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Printflag</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Resultflag</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Errflag</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Diagnose</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Reserve</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetString</span><span class="o">=</span><span class="n">RetString_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Patnamn</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Getda</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">Wardno</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">BarCode</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="n">BirthDate</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">RetString</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">监听做上传操作后调用改方法设置标本上传表状态</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">SaveSDFMTHD</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">labno</span><span class="p">,</span> <span class="n">epis</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">labno</span><span class="p">),</span><span class="n">epis</span> <span class="o">=</span> <span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="n">epis</span><span class="p">),</span><span class="n">filename</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(MI.MachineUpload).SetSendFlag(mi,labno,&#34;S&#34;,filename)</span>
</span></span><span class="line"><span class="cl">    <span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/********************************************</span><span class="err">自动核收开始</span><span class="o">****************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">仪器主键，条码号，前处理标本分区标识，仪器信息</span><span class="p">(</span><span class="err">位置</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFIT3000N1).ZDHS(&#34;34&#34;,&#34;8000000352&#34;,&#34;WANTAI&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##class(MI.MIFIT300N).ZDHS(&#34;34&#34;,&#34;1003779663&#34;,&#34;RSA1&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">ZDHS</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">Labno</span><span class="p">,</span> <span class="n">MachineCode</span><span class="p">,</span> <span class="n">positioninfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">Labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">Labno</span><span class="p">),</span><span class="n">machCode</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">MachineCode</span><span class="p">),</span><span class="n">positioninfo</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">positioninfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="s1">&#39;$l(Labno) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">/*----------&gt;</span><span class="err">判断该标本是否已接收未核收</span> <span class="err">开始</span><span class="o">&lt;----------*/</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">QuitFlag</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##class(LIS.Util.Common).IndexData(Labno))) d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">))</span> <span class="n">s</span> <span class="n">QuitFlag</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">QuitFlag</span><span class="o">=</span><span class="mi">1</span> <span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">/*----------&gt;</span><span class="err">判断该标本是否已接收未核收</span> <span class="err">结束</span><span class="o">&lt;----------*/</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">curWorkGroupMachineDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">6</span><span class="p">)</span>	<span class="o">//</span><span class="err">得到当前仪器关联工作小组信息</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">CurWorkGroupDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">curMachName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">mi</span><span class="p">)),</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">AcceptFlag</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">curWorkGroupMachineDR</span><span class="p">)),</span><span class="mi">13</span><span class="p">)</span>	<span class="o">//</span><span class="err">得到仪器工作小组的核收类型</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="n">AcceptFlag为1认为是前处理工作小组</span><span class="err">，如果是前处理小组，就认为上前处理</span>	<span class="err">本接口未设置前处理工作小组，未对此流程进行测试</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">AcceptFlag</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>  <span class="n">d</span> <span class="n">QCLZDHS</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">e</span>  <span class="n">d</span> <span class="n">ZDHS</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">q</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">ZDHS</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;上仪器,标本号:&#34;</span><span class="n">_Labno_</span><span class="s2">&#34;的标本在:&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34;,分区位置:&#34;</span><span class="n">_MachineCode_</span><span class="s2">&#34;,样本所在:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;自动核收&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">根据前处理标本分区进行分区自动核收，并且根据分区代码是否核收进行区分</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">本接口认为</span> <span class="err">默认认为罗氏流水线核收，如果分区代码中包含</span> <span class="err">【</span><span class="n">BHS</span><span class="err">】则认为标本不核收，此块代码将仪器传过来的分区代码进行归类</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">本接口关联标本分区，</span> <span class="n">WANTAI</span> <span class="err">万泰</span><span class="o">--&gt;</span><span class="n">W</span><span class="err">，</span><span class="n">XINCHANYE</span> <span class="err">新产业</span><span class="o">--&gt;</span><span class="n">X</span><span class="err">，</span><span class="n">LINJIAN</span> <span class="err">临检凝血</span><span class="o">--&gt;</span><span class="n">L</span><span class="err">，</span><span class="n">XIEGUANG</span> <span class="err">携光</span><span class="o">--&gt;</span><span class="n">R</span><span class="err">，罗氏</span><span class="o">--&gt;</span><span class="n">Y</span><span class="err">，不核收</span><span class="o">--&gt;</span><span class="n">N</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">HsFlag</span><span class="o">=</span><span class="s2">&#34;Y&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="p">(</span><span class="n">MachineCode</span><span class="p">[</span><span class="s2">&#34;WANTAI&#34;</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">MachineCode</span><span class="s1">&#39;[&#34;BHS&#34;) d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">S</span> <span class="n">MachineCode</span><span class="o">=$</span><span class="n">REPLACE</span><span class="p">(</span><span class="n">MachineCode</span><span class="p">,</span><span class="s2">&#34;WANTAI&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">HsFlag</span><span class="o">=</span><span class="s2">&#34;W&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="mi">48</span>	<span class="o">//</span><span class="err">未核收且分区是</span><span class="n">WANTAI</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="p">(</span><span class="n">MachineCode</span><span class="p">[</span><span class="s2">&#34;XINCHANYE&#34;</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">MachineCode</span><span class="s1">&#39;[&#34;BHS&#34;) d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">S</span> <span class="n">MachineCode</span><span class="o">=$</span><span class="n">REPLACE</span><span class="p">(</span><span class="n">MachineCode</span><span class="p">,</span><span class="s2">&#34;XINCHANYE&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">HsFlag</span><span class="o">=</span><span class="s2">&#34;X&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="mi">50</span>	<span class="o">//</span><span class="err">未核收且分区是</span><span class="n">XINCHANYE</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="p">(</span><span class="n">MachineCode</span><span class="p">[</span><span class="s2">&#34;LINJIAN&#34;</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">MachineCode</span><span class="s1">&#39;[&#34;BHS&#34;) d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">S</span> <span class="n">MachineCode</span><span class="o">=$</span><span class="n">REPLACE</span><span class="p">(</span><span class="n">MachineCode</span><span class="p">,</span><span class="s2">&#34;LINJIAN&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">HsFlag</span><span class="o">=</span><span class="s2">&#34;L&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="mi">9</span>		<span class="o">//</span><span class="err">未核收且分区是</span><span class="n">LINJIAN</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="p">(</span><span class="n">MachineCode</span><span class="p">[</span><span class="s2">&#34;XIEGUANG&#34;</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">MachineCode</span><span class="s1">&#39;[&#34;BHS&#34;) d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">S</span> <span class="n">MachineCode</span><span class="o">=$</span><span class="n">REPLACE</span><span class="p">(</span><span class="n">MachineCode</span><span class="p">,</span><span class="s2">&#34;XIEGUANG&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">HsFlag</span><span class="o">=</span><span class="s2">&#34;R&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="mi">67</span>	<span class="o">//</span><span class="err">未核收且分区是</span><span class="n">XIEGUANG</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="p">(</span><span class="n">MachineCode</span><span class="p">[</span><span class="s2">&#34;BHS_&#34;</span><span class="p">)</span> <span class="n">d</span>	<span class="p">;</span><span class="n">BHS_WANTAI</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">S</span> <span class="n">MachineCode</span><span class="o">=$</span><span class="n">REPLACE</span><span class="p">(</span><span class="n">MachineCode</span><span class="p">,</span><span class="s2">&#34;BHS_&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">HsFlag</span><span class="o">=</span><span class="s2">&#34;N&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">MachineCode</span><span class="o">=</span><span class="s2">&#34;C_C8K886&#34;</span> <span class="n">s</span> <span class="n">MachineCode</span><span class="o">=</span><span class="s2">&#34;C801&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">MachineCode</span><span class="o">=</span><span class="s2">&#34;C_C8K77&#34;</span> <span class="n">s</span> <span class="n">MachineCode</span><span class="o">=</span><span class="s2">&#34;C701&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">MachineCode</span><span class="o">=</span><span class="s2">&#34;C8K886&#34;</span> <span class="n">s</span> <span class="n">MachineCode</span><span class="o">=</span><span class="s2">&#34;C801&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">MachineCode</span><span class="o">=</span><span class="s2">&#34;C8K77&#34;</span> <span class="n">s</span> <span class="n">MachineCode</span><span class="o">=</span><span class="s2">&#34;C701&#34;</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">HsFlag</span><span class="o">=</span><span class="s2">&#34;Y&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="mi">41</span>	<span class="o">//</span><span class="err">未核收且分区不包含</span><span class="n">BHS_</span>	<span class="err">默认核收到罗氏流水线</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="s1">&#39;$l(WorkGroupMachineDR) q</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">ret</span><span class="o">=..</span><span class="n">ReceiveLabNoByWGM</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">Labno</span><span class="p">,</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">WorkGroupDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">ret</span><span class="s1">&#39;=&#34;1&#34; d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_WorkGroupDR</span>		<span class="o">//</span><span class="err">自动核收出错显示再对应的工作组</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">SendRet</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收失败&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_Labno_</span><span class="s2">&#34;前处理核收失败:&#34;</span><span class="n">_ret_</span><span class="s2">&#34;,仪器【&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34;】！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">j</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span><span class="s2">&#34;自动核收:&#34;</span><span class="n">_ret</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;14&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">QCLZDHS</span>
</span></span><span class="line"><span class="cl">	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;上前处理，鉴定号:&#34;</span><span class="n">_Labno_</span><span class="s2">&#34;的标本在:&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34;,样本所在:&#34;</span><span class="n">_positioninfo</span><span class="p">,</span><span class="s2">&#34;DealInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;执行核收到前处理&#34;</span><span class="p">,</span><span class="s2">&#34;DealInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="err">此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">s</span> <span class="n">dealret</span><span class="o">=</span><span class="c1">##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,Labno,&#34;&#34;) </span>
</span></span><span class="line"><span class="cl"> 	<span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">Labno_</span><span class="s2">&#34;核收到前处理返回信息:&#34;</span><span class="n">_dealret</span><span class="p">,</span><span class="s2">&#34;DealInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">//</span><span class="err">记录位置信息到报告位置号</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">d</span> <span class="o">..</span><span class="n">SaveRackNo</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span><span class="n">positioninfo</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">dealret</span><span class="p">[</span><span class="s2">&#34;标本已核收&#34;</span> <span class="n">q</span> 
</span></span><span class="line"><span class="cl"> 	<span class="n">i</span> <span class="n">dealret</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="err">写标本操作日志</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span><span class="n">machCode</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;5&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_CurWorkGroupDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收失败&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_Labno_</span><span class="s2">&#34;前处理核收失败:&#34;</span><span class="n">_dealret_</span><span class="s2">&#34;,仪器【&#34;</span><span class="n">_curMachName_</span><span class="s2">&#34;】！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.//</span><span class="err">写标本操作日志</span>
</span></span><span class="line"><span class="cl"> 	<span class="o">.</span><span class="n">d</span> <span class="o">..</span><span class="n">SaveRecord</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span><span class="n">dealret</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="s2">&#34;100&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 	<span class="n">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Others</span>  <span class="n">w</span> <span class="c1">##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(&#34;3&#34;,&#34;1000004476&#34;,&#34;20191105&#34;) </span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="err">按工作小组核收医嘱</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">INPUT</span><span class="p">:</span> <span class="n">MachID</span><span class="p">:</span><span class="err">仪器主键，</span><span class="n">LabNo</span><span class="err">：条码号，</span><span class="n">TransmitDate</span><span class="err">：上机日期（不传默认当天）</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">OutPut</span><span class="p">:</span> <span class="n">RetValue</span><span class="p">:</span><span class="mi">1</span><span class="err">成功</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">ReceiveLabNoByWGM</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">LabNo</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">TransmitDate</span><span class="p">,</span> <span class="n">RackNo</span><span class="p">,</span> <span class="n">RuleCode</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LabNo</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">LabNo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">TransmitDate</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">TransmitDate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RuleCode</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">RuleCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RackNo</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">RackNo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">NowDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetValue</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(TransmitDate) s TransmitDate=NowDate</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(WorkGroupMachineDR) q 100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WorkGroupMachineCode</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WorkGroupMachineName</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WorkGroupDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">DepartmentDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupD</span><span class="p">(</span><span class="n">WorkGroupDR</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">HospitalDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTDepartmentD</span><span class="p">(</span><span class="n">DepartmentDR</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">WorkGroupMachineDesc</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">IndexOperateType</span><span class="o">=</span><span class="c1">##class(LIS.Util.Common).IndexData(&#34;H&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AutoDR</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPWGMachineAutoI</span><span class="p">(</span><span class="s2">&#34;IndexOperateType&#34;</span><span class="p">,</span><span class="n">IndexOperateType</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(AutoDR) </span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    	<span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    	<span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_WorkGroupDR</span>
</span></span><span class="line"><span class="cl">    	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未设置自动核收&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_</span><span class="s2">&#34;工作小组【&#34;</span><span class="n">_WorkGroupMachineName_</span><span class="s2">&#34;】未设置自动核收！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="n">q</span> <span class="s2">&#34;-1^该工作小组【&#34;</span><span class="n">_WorkGroupMachineDesc_</span><span class="s2">&#34;】未设置自动核收！&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">MachineAutoData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPWGMachineAutoD</span><span class="p">(</span><span class="n">AutoDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">IsOpen</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="n">MachineAutoData</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">IsOpen</span><span class="s1">&#39;=1 </span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    	<span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_WorkGroupDR</span>
</span></span><span class="line"><span class="cl">    	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未开启自动核收&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_</span><span class="s2">&#34;工作小组【&#34;</span><span class="n">_WorkGroupMachineName_</span><span class="s2">&#34;】未开启自动核收！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	    <span class="n">q</span> <span class="s2">&#34;-1^该工作小组【&#34;</span><span class="n">_WorkGroupMachineDesc_</span><span class="s2">&#34;】未开启自动核收！&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">CurrentDate</span> <span class="o">=</span> <span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Currenttime</span> <span class="o">=</span> <span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">开始时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">StartDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">MachineAutoData</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">StartDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">StartDate</span><span class="o">=</span> <span class="o">$</span><span class="n">zdh</span><span class="p">(</span><span class="n">StartDate</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">StartTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">MachineAutoData</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">结束时间</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">EndDate</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">MachineAutoData</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">EndDate</span><span class="p">)</span> <span class="n">s</span> <span class="n">EndDate</span><span class="o">=</span> <span class="o">$</span><span class="n">zdh</span><span class="p">(</span><span class="n">EndDate</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">EndTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">MachineAutoData</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">时间类型</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">TimeType</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">MachineAutoData</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">TimeType</span><span class="o">=</span><span class="s2">&#34;CT&#34;</span>  <span class="o">//</span><span class="err">连续</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="n">i</span> <span class="p">(</span><span class="n">CurrentDate</span><span class="o">&lt;</span><span class="n">StartDate</span><span class="p">)</span><span class="o">||</span><span class="p">((</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">StartTime</span><span class="p">))</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">CurrentDate</span><span class="o">=</span><span class="n">StartDate</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">Currenttime</span><span class="o">&lt;</span><span class="n">StartTime</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">	    <span class="p">{</span>
</span></span><span class="line"><span class="cl">		    <span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    		<span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_WorkGroupDR</span>
</span></span><span class="line"><span class="cl">    		<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期未生效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_</span><span class="s2">&#34;工作小组【&#34;</span><span class="n">_WorkGroupMachineName_</span><span class="s2">&#34;】自动核收日期未生效！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="n">q</span> <span class="s2">&#34;-1^该工作小组【&#34;</span><span class="n">_WorkGroupMachineDesc_</span><span class="s2">&#34;】自动核收日期未生效！&#34;</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	    <span class="n">i</span> <span class="p">(</span><span class="n">CurrentDate</span><span class="o">&gt;</span><span class="n">EndDate</span><span class="p">)</span><span class="o">||</span><span class="p">((</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">EndTime</span><span class="p">))</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">CurrentDate</span><span class="o">=</span><span class="n">EndDate</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">Currenttime</span><span class="o">&gt;</span><span class="n">EndTime</span><span class="p">)</span> <span class="p">)</span> 
</span></span><span class="line"><span class="cl">	    <span class="p">{</span>
</span></span><span class="line"><span class="cl">		    <span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    		<span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_WorkGroupDR</span>
</span></span><span class="line"><span class="cl">    		<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期已失效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_</span><span class="s2">&#34;工作小组【&#34;</span><span class="n">_WorkGroupMachineName_</span><span class="s2">&#34;】自动核收日期已失效！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="n">q</span> <span class="s2">&#34;-1^该工作小组【&#34;</span><span class="n">_WorkGroupMachineDesc_</span><span class="s2">&#34;】自动核收日期已失效！&#34;</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">TimeType</span><span class="o">=</span><span class="s2">&#34;TS&#34;</span>  <span class="o">//</span><span class="err">时间段</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">i</span> <span class="p">(</span><span class="n">CurrentDate</span><span class="o">&lt;</span><span class="n">StartDate</span><span class="p">)</span><span class="o">||</span><span class="p">((</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">StartTime</span><span class="p">))</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">Currenttime</span><span class="o">&lt;</span><span class="n">StartTime</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    		<span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_WorkGroupDR</span>
</span></span><span class="line"><span class="cl">    		<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期未生效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_</span><span class="s2">&#34;工作小组【&#34;</span><span class="n">_WorkGroupMachineName_</span><span class="s2">&#34;】自动核收日期未生效！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">q</span> <span class="s2">&#34;-1^该工作小组【&#34;</span><span class="n">_WorkGroupMachineDesc_</span><span class="s2">&#34;】自动核收日期未生效！&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	    <span class="n">i</span> <span class="p">(</span><span class="n">CurrentDate</span><span class="o">&gt;</span><span class="n">EndDate</span><span class="p">)</span><span class="o">||</span><span class="p">((</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">EndTime</span><span class="p">))</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">Currenttime</span><span class="o">&gt;</span><span class="n">EndTime</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	    <span class="p">{</span>
</span></span><span class="line"><span class="cl">		    <span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    		<span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_WorkGroupDR</span>
</span></span><span class="line"><span class="cl">    		<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期已失效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_</span><span class="s2">&#34;工作小组【&#34;</span><span class="n">_WorkGroupMachineName_</span><span class="s2">&#34;】自动核收日期已失效！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">q</span> <span class="s2">&#34;-1^该工作小组【&#34;</span><span class="n">_WorkGroupMachineDesc_</span><span class="s2">&#34;】自动核收日期已失效！&#34;</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AcceptUserDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">AutoDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AcceptUserDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPWGMachineAutoD</span><span class="p">(</span><span class="n">AutoDR</span><span class="p">)),</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(AcceptUserDR) d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">retObj</span><span class="o">=</span><span class="c1">##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">perUser</span> <span class="o">=</span> <span class="s2">&#34;WG-&#34;</span><span class="n">_WorkGroupDR</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">retObj</span><span class="o">.</span><span class="n">SendMsg</span><span class="p">(</span><span class="s2">&#34;dhcc&#34;</span><span class="p">,</span><span class="s2">&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未设置负责人&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;</span><span class="n">_</span><span class="s2">&#34;工作小组【&#34;</span><span class="n">_WorkGroupMachineName_</span><span class="s2">&#34;】未设置核收负责人！&#34;</span><span class="n">_</span><span class="s2">&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;</span><span class="p">,</span> <span class="s2">&#34;Crisis&#34;</span><span class="p">,</span> <span class="n">perUser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$l(AcceptUserDR) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未设置核收负责人！&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">CommDirection</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">///</span><span class="err">判断医嘱是否核收</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">AcceptFlag</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">IsSpecialFlag</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CheckItemList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">PreReportDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">k</span> <span class="n">TestSetList</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">LabNoType</span><span class="o">=</span><span class="c1">##Class(LISSP.DHCRPVisitNumber).GetLabNoType(LabNo)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WebNamespace</span><span class="o">=</span><span class="c1">##Class(OTH.SYSParameter).GetWebNamespace()</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(LabNo))){</span>
</span></span><span class="line"><span class="cl">	     
</span></span><span class="line"><span class="cl">           <span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(LabNo),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">           <span class="n">S</span> <span class="n">TestSetDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="n">f</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	          <span class="n">s</span> <span class="n">TestSetDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberTestSetI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	          <span class="n">q</span><span class="p">:</span><span class="n">TestSetDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	          <span class="n">s</span> <span class="n">RowID</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberTestSetI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">              <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">RowID</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	             <span class="n">s</span> <span class="n">TestSetGroup</span><span class="o">=</span><span class="s2">&#34;Default&#34;</span> <span class="o">//</span><span class="err">工作小组下分组类型</span>
</span></span><span class="line"><span class="cl">                 <span class="n">s</span> <span class="n">WGMDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberTestSetD</span><span class="p">(</span><span class="n">RowID</span><span class="p">)),</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="n">i</span> <span class="s1">&#39;$l(WGMDR) s CheckItemList=TestSetDR_CheckItemList</span>
</span></span><span class="line"><span class="cl">                 <span class="n">S</span> <span class="n">AccpetReportDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberTestSetD</span><span class="p">(</span><span class="n">RowID</span><span class="p">)),</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                 <span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">AccpetReportDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">AccpetWGMDR</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">AccpetReportDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span> <span class="n">I</span> <span class="o">$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">AccpetWGMDR</span><span class="p">)),</span><span class="mi">13</span><span class="p">)</span><span class="s1">&#39;=1 continue</span>
</span></span><span class="line"><span class="cl">                 <span class="n">s</span> <span class="n">AcceptFlag</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">                 <span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">WGMDR</span><span class="p">)</span> <span class="n">S</span> <span class="n">AcceptFlag</span><span class="o">=$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WGMDR</span><span class="p">)),</span><span class="mi">13</span><span class="p">)</span> <span class="o">//</span><span class="err">是否是前处理小组</span>
</span></span><span class="line"><span class="cl">                 <span class="n">I</span> <span class="n">AcceptFlag</span><span class="o">=</span><span class="mi">1</span> <span class="n">S</span> <span class="n">PreReportDR</span><span class="o">=</span> <span class="o">$</span><span class="n">LG</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberTestSetD</span><span class="p">(</span><span class="n">RowID</span><span class="p">)),</span><span class="mi">11</span><span class="p">),</span><span class="n">IsSpecialFlag</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">                 <span class="n">I</span> <span class="n">AcceptFlag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">D</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTTestSetWorkGroupMachineI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="p">{</span>
</span></span><span class="line"><span class="cl">	                  <span class="o">//</span><span class="err">处理报告分组信息</span>
</span></span><span class="line"><span class="cl">	                  <span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineRuleTSI</span><span class="p">(</span><span class="s2">&#34;IndexTestSet&#34;</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	                  <span class="p">{</span>
</span></span><span class="line"><span class="cl">		                   <span class="n">s</span> <span class="n">WorkGroupMachineRuleDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		                   <span class="n">f</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			                   <span class="n">s</span> <span class="n">WorkGroupMachineRuleDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineRuleTSI</span><span class="p">(</span><span class="s2">&#34;IndexTestSet&#34;</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">,</span><span class="n">WorkGroupMachineRuleDR</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">			                   <span class="n">q</span><span class="p">:</span><span class="n">WorkGroupMachineRuleDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">			                   <span class="n">s</span> <span class="n">GroupWGMDR</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineRuleD</span><span class="p">(</span><span class="n">WorkGroupMachineRuleDR</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			                   <span class="n">s</span> <span class="n">IsShow</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineRuleD</span><span class="p">(</span><span class="n">WorkGroupMachineRuleDR</span><span class="p">)),</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			                   <span class="n">i</span> <span class="n">WorkGroupMachineDR</span><span class="s1">&#39;=GroupWGMDR continue</span>
</span></span><span class="line"><span class="cl">			                   <span class="n">i</span> <span class="n">IsShow</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">			                   <span class="n">s</span> <span class="n">TestSetGroup</span><span class="o">=</span><span class="n">WorkGroupMachineRuleDR</span>
</span></span><span class="line"><span class="cl">			                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">		              <span class="p">}</span>
</span></span><span class="line"><span class="cl">		              <span class="n">s</span> <span class="n">TestSetList</span><span class="p">(</span><span class="n">TestSetGroup</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	             <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>   
</span></span><span class="line"><span class="cl">	       <span class="p">}</span>   
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(LabNo),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">前处理标本核收</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="n">IsSpecialFlag</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="n">I</span> <span class="s1">&#39;$D(TestSetList) s RetValue=&#34;-1^无可核收医嘱&#34;   q RetValue</span>
</span></span><span class="line"><span class="cl">	    <span class="n">s</span> <span class="n">maxEpis</span><span class="o">=..</span><span class="n">GetMaxMiEpisodeNo</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">TransmitDate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="o">$</span><span class="n">ZTrap</span> <span class="o">=</span> <span class="s2">&#34;ErrorHandle&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">TSTART</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="n">MajorConclusion</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">OldEpi</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="n">MiniConclusion</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">PreReportDR</span><span class="p">)</span> <span class="n">s</span> <span class="n">MajorConclusion</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">PreReportDR</span><span class="p">)),</span><span class="mi">40</span><span class="p">),</span><span class="n">MiniConclusion</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">PreReportDR</span><span class="p">)),</span><span class="mi">41</span><span class="p">),</span><span class="n">OldEpi</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportD</span><span class="p">(</span><span class="n">PreReportDR</span><span class="p">)),</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="n">maxEpis</span><span class="o">=</span><span class="n">OldEpi</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="n">TestSetGroup</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	        <span class="n">s</span> <span class="n">TestSetGroup</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="n">TestSetList</span><span class="p">(</span><span class="n">TestSetGroup</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	        <span class="n">q</span><span class="p">:</span><span class="n">TestSetGroup</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">	        <span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">=</span><span class="c1">##class(dbo.RPVisitNumberReport).%New()</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">VisitNumberDR</span><span class="o">=</span><span class="n">VisitNumberDR</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">TransmitDate</span><span class="o">=</span><span class="n">TransmitDate</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="n">WorkGroupMachineDR</span> 
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">MajorConclusion</span><span class="o">=</span><span class="n">MajorConclusion</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">MinorConclusion</span><span class="o">=</span><span class="n">MiniConclusion</span>
</span></span><span class="line"><span class="cl">			<span class="n">S</span> <span class="n">OrderNo</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="s2">&#34;1&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			  <span class="n">s</span> <span class="n">OrderNo</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			  <span class="n">s</span> <span class="n">OrderNo</span><span class="o">=</span><span class="p">(</span><span class="n">OrderNo</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		    <span class="p">}</span>
</span></span><span class="line"><span class="cl">		    <span class="n">s</span> <span class="n">AssayNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">OrderNo</span><span class="o">=</span><span class="n">OrderNo</span>
</span></span><span class="line"><span class="cl">	        <span class="n">i</span> <span class="p">((</span><span class="n">CommDirection</span><span class="o">=</span><span class="s2">&#34;UP&#34;</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">CommDirection</span><span class="o">=</span><span class="s2">&#34;BI&#34;</span><span class="p">))</span> <span class="n">s</span> <span class="n">AssayNo</span><span class="o">=</span><span class="n">LabNo</span> 
</span></span><span class="line"><span class="cl">	        <span class="n">i</span> <span class="s1">&#39;$l(AssayNo) s AssayNo=maxEpis</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">AccessionNo</span><span class="o">=</span><span class="s2">&#34;&#34;</span>   <span class="o">///</span><span class="err">细菌分离号</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">AssayNo</span><span class="o">=</span><span class="n">AssayNo</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">EpisodeNo</span><span class="o">=</span><span class="n">maxEpis</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">maxEpis</span><span class="p">)</span> <span class="n">s</span> <span class="o">^</span><span class="n">DHCLABWGMEPSIDERECORD</span><span class="p">(</span><span class="s2">&#34;WGM&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">TransmitDate</span><span class="p">,</span><span class="n">maxEpis</span><span class="p">)</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">AcceptDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">AcceptTime</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">AcceptUserDR</span><span class="o">=</span><span class="n">AcceptUserDR</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">RackNo</span><span class="p">)</span> <span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">RackNo</span><span class="o">=</span><span class="n">RackNo</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">Status</span><span class="o">=</span><span class="mi">1</span>  <span class="o">//</span><span class="err">报告状态</span><span class="p">(</span><span class="mi">1</span><span class="err">登记，</span><span class="mi">2</span><span class="err">初审，</span><span class="mi">3</span><span class="err">审核，</span><span class="mi">4</span><span class="err">复查，</span><span class="mi">5</span><span class="err">取消审核，</span><span class="mi">6</span><span class="err">作废，</span><span class="n">O其他</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">objVisitNumberReport</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="n">If</span> <span class="p">(</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">IsOK</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span><span class="n">s</span> <span class="n">RetValue</span><span class="o">=</span><span class="mi">1</span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">Else</span> <span class="p">{</span><span class="n">s</span> <span class="n">err</span><span class="o">=</span><span class="s2">&#34;报告生成失败:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="n">s</span> <span class="n">RetValue</span><span class="o">=</span><span class="s2">&#34;-1^&#34;</span><span class="n">_err</span>   <span class="n">q</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">		    <span class="n">I</span> <span class="s1">&#39;$D(TestSetList(TestSetGroup)) s RetValue=&#34;-1^无可核收医嘱&#34;   q </span>
</span></span><span class="line"><span class="cl">		    <span class="n">s</span> <span class="n">TestSetDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl">		    <span class="n">F</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			    <span class="n">s</span> <span class="n">TestSetDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="n">TestSetList</span><span class="p">(</span><span class="n">TestSetGroup</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl">			    <span class="n">q</span><span class="p">:</span><span class="n">TestSetDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	            <span class="n">s</span> <span class="n">RowID</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberTestSetI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">TestSetDR</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">RowID</span><span class="p">){</span> <span class="o">//</span><span class="err">修改标本医嘱核收工作小组</span>
</span></span><span class="line"><span class="cl">					<span class="n">s</span> <span class="n">objTestSets</span><span class="o">=</span><span class="c1">##class(dbo.RPVisitNumberTestSet).%OpenId(RowID)</span>
</span></span><span class="line"><span class="cl">					<span class="n">s</span> <span class="n">objTestSets</span><span class="o">.</span><span class="n">VisitNumberReportDR</span><span class="o">=</span><span class="n">objVisitNumberReport</span><span class="o">.</span><span class="n">RowID</span>
</span></span><span class="line"><span class="cl">					<span class="n">s</span> <span class="n">objTestSets</span><span class="o">.</span><span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="n">WorkGroupMachineDR</span>
</span></span><span class="line"><span class="cl">					<span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="n">objTestSets</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	                <span class="n">If</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)) {</span>
</span></span><span class="line"><span class="cl">	 	               <span class="n">s</span> <span class="n">RetValue</span><span class="o">=$</span><span class="n">SYSTEM</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">GetErrorText</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>  <span class="n">Quit</span>  
</span></span><span class="line"><span class="cl">	 	            <span class="p">}</span>
</span></span><span class="line"><span class="cl">	 	            <span class="o">//</span><span class="err">按医嘱生成报告项目结果</span>
</span></span><span class="line"><span class="cl">				    <span class="n">s</span> <span class="n">RetValue</span><span class="o">=</span><span class="c1">##Class(LISSP.DHCRPVisitNumberReport).SaveReportTestCode(objVisitNumberReport.RowID,TestSetDR)</span>
</span></span><span class="line"><span class="cl">				    <span class="n">i</span> <span class="n">RetValue</span><span class="s1">&#39;=1   q</span>
</span></span><span class="line"><span class="cl">	 	          
</span></span><span class="line"><span class="cl">				<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	    <span class="n">i</span> <span class="n">RetValue</span><span class="s1">&#39;=1  TROLLBACK  Quit RetValue</span>
</span></span><span class="line"><span class="cl">	    <span class="o">//</span><span class="err">删除前处理报告</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">PreReportDR</span><span class="p">),</span><span class="s1">&#39;$d(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,PreReportDR)){</span>
</span></span><span class="line"><span class="cl">                 <span class="n">s</span> <span class="n">sc</span><span class="o">=</span><span class="c1">##class(dbo.RPVisitNumberReport).%DeleteId(PreReportDR)</span>
</span></span><span class="line"><span class="cl">                 <span class="n">If</span> <span class="p">(</span><span class="s1">&#39;$SYSTEM.Status.IsOK(sc)){s RetValue=&#34;删除报告信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc)    }</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	    <span class="n">i</span> <span class="n">RetValue</span><span class="s1">&#39;=1 TROLLBACK  Quit RetValue </span>
</span></span><span class="line"><span class="cl">	    <span class="n">TCOMMIT</span>
</span></span><span class="line"><span class="cl">	    <span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">maxEpis</span><span class="p">)</span> <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(HIS.DHCCommon).SaveWorkGroupMachineEpis(WorkGroupMachineDR,TransmitDate,maxEpis,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">	  
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>      
</span></span><span class="line"><span class="cl">		<span class="o">//</span><span class="err">普通标本核收</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">maxEpis</span><span class="o">=..</span><span class="n">GetMaxMiEpisodeNo</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">TransmitDate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">Flag</span><span class="o">=</span><span class="mi">1</span>		<span class="o">//</span><span class="n">YHR</span> <span class="mi">20250319</span> <span class="err">仪器自动核收标志，为</span><span class="mi">1</span><span class="err">的话，不影响工作小组手动核收序号</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">Param</span><span class="o">=</span><span class="s2">&#34;&lt;Data&gt;&lt;P0&gt;H&lt;/P0&gt;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">Param</span><span class="o">=</span><span class="n">Param_</span><span class="s2">&#34;&lt;P1&gt;&#34;</span><span class="n">_LabNo_</span><span class="s2">&#34;&lt;/P1&gt;&lt;P2&gt;&lt;/P2&gt;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">Param</span><span class="o">=</span><span class="n">Param_</span><span class="s2">&#34;&lt;P3&gt;&#34;</span><span class="n">_maxEpis_</span><span class="s2">&#34;&lt;/P3&gt;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">Param</span><span class="o">=</span><span class="n">Param_</span><span class="s2">&#34;&lt;P4&gt;&#34;</span><span class="n">_AcceptUserDR_</span><span class="s2">&#34;&lt;/P4&gt;&lt;P5&gt;&lt;/P5&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P7&gt;&lt;/P7&gt;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">Param</span><span class="o">=</span><span class="n">Param_</span><span class="s2">&#34;&lt;P8&gt;&#34;</span><span class="n">_WorkGroupMachineDR_</span><span class="s2">&#34;&lt;/P8&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P12&gt;&#34;</span><span class="n">_RackNo_</span><span class="s2">&#34;&lt;/P12&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P14&gt;@@1@@&#34;</span><span class="n">_Flag_</span><span class="s2">&#34;&lt;/P14&gt;&lt;/Data&gt;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">Sessions</span><span class="o">=</span><span class="n">AcceptUserDR_</span><span class="s2">&#34;^&#34;</span><span class="n">_WorkGroupDR_</span><span class="s2">&#34;^^^&#34;</span><span class="n">_HospitalDR</span>
</span></span><span class="line"><span class="cl">		<span class="n">b</span> <span class="p">;</span><span class="n">a</span> <span class="n">KSZDHS</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="c1">##Class(LISSP.DHCRPVisitNumber).ReceiveVisitNumber(LabNo,Param,Sessions)</span>
</span></span><span class="line"><span class="cl">		<span class="n">i</span> <span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="s1">&#39;=&#34;1&#34; s RetValue=ret</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">RetValue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ErrorHandle</span>
</span></span><span class="line"><span class="cl">	<span class="n">TROLLBACK</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">RetValue</span><span class="o">=</span><span class="s2">&#34;-1^错误&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">ZERROR</span><span class="p">,</span><span class="s2">&#34;^&#34;</span><span class="p">,</span><span class="s2">&#34;--&#34;</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;.错误代码:&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">ECODE</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="n">RetValue</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Creator</span><span class="err">：</span>      <span class="n">YHR</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">CreatDate</span><span class="err">：</span>    <span class="mi">20250320</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="err">：</span>  <span class="err">通过编号规则获取工作小组最大流水号</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>        <span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReport</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="err">工作小组，日期</span><span class="p">(</span><span class="err">只能获取当天的，编号规则隔天后会刷新</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">无</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="err">失败</span><span class="p">:</span><span class="s2">&#34;&#34;</span>  <span class="err">成功</span><span class="p">:</span><span class="err">流水号</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Others</span>		   <span class="err">【原】</span><span class="n">w</span> <span class="c1">##Class(LIS.Common.DHCVisitNumber).GetMaxMiEpisodeNo(&#34;41&#34;,&#34;20250319&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">k</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MI.MIFIT3000N1.1&#34;</span><span class="p">,</span><span class="s2">&#34;WGMEpis&#34;</span><span class="p">,</span><span class="s2">&#34;41&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">w</span> <span class="c1">##Class(MI.MIFIT3000N1).GetMaxMiEpisodeNo(&#34;41&#34;,&#34;20250319&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">GetMaxMiEpisodeNo</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">TransmitDate</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">TransmitDate</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">TransmitDate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">G</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">S</span> <span class="n">RetValue</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(WorkGroupMachineDR) q RetValue</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(TransmitDate) s TransmitDate=$zd($h,8)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">TransmitDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="n">TransmitDate</span><span class="p">,</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">记录该工作小组当天最大的流水号，如果有记录，则优先判断是否核收成功，如果未核收成功仍旧使用该号码</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="s2">&#34;WGMEpis&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">TransmitDate</span><span class="p">))</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">JLEpis</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="s2">&#34;WGMEpis&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">TransmitDate</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(JLEpis) q</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,JLEpis,TransmitDate)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">RetValue</span><span class="o">=</span><span class="n">JLEpis</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">RetValue</span><span class="p">)</span> <span class="n">q</span> <span class="n">RetValue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">通过编号规则获取当天流水号，编号规则代码设置为工作小组同样代码，通过代码获取工作小组对应的编号规则</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WorkGroupMachineCode</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ZDHSEpis</span><span class="o">=</span><span class="c1">##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) //YHR 20230810 罗氏流水线规则</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ZDHSEpis</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">s</span> <span class="n">RetValue</span><span class="o">=</span><span class="n">ZDHSEpis</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">e</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="n">f</span> <span class="n">Num</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1000</span> <span class="n">d</span>		<span class="o">//</span><span class="err">避免死循环，每次进行一千次增号判断</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">s</span> <span class="n">ZDHSEpis</span><span class="o">=</span><span class="c1">##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode)</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">RetValue</span><span class="o">=</span><span class="n">ZDHSEpis</span>
</span></span><span class="line"><span class="cl">	<span class="o">....</span><span class="n">s</span> <span class="n">Num</span><span class="o">=</span><span class="mi">1001</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">RetValue</span><span class="p">)</span> <span class="n">s</span> <span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="o">$</span><span class="n">zn</span><span class="p">,</span><span class="s2">&#34;WGMEpis&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">TransmitDate</span><span class="p">)</span><span class="o">=</span><span class="n">RetValue</span> <span class="n">q</span> <span class="n">RetValue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">未查询到编号规则，则获取当前工作小组最大流水号</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Parameter</span><span class="o">=</span><span class="s2">&#34;&lt;Data&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P0&gt;&#34;</span><span class="n">_TransmitDate_</span><span class="s2">&#34;&lt;/P0&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P5&gt;&lt;/P5&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P7&gt;&lt;/P7&gt;&lt;/Data&gt;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WGMEpisNo</span><span class="o">=</span><span class="c1">##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(WorkGroupMachineDR,Parameter) 			//YHR 20250317 获取最大流水号报错问题处理</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">WGMEpisNo</span><span class="p">)</span> <span class="n">s</span> <span class="n">RetValue</span><span class="o">=</span><span class="n">WGMEpisNo</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="n">RetValue</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/********************************************</span><span class="err">自动核收结束</span><span class="o">****************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="个性化功能记录">个性化功能记录
</h2><blockquote>
<p>本节点无特殊功能，可直接在其他接口使用类似功能。</p></blockquote>
<h3 id="自动核收功能">自动核收功能
</h3><blockquote>
<p>将自动核收单独出来。标准版方法为（##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM），标板使用的功能，是通过仪器对应的工作小组进行核收，流水线仪器为了方便维护以及后续的拓展。此处将仪器主键入参改为了工作小组主键入参。</p>
<p>修改获取流水号逻辑。标本从仪器开始流水号那里获取，如果多个仪器就会造成维护多个不用的仪器。基于标准版有编号规则维护功能，在此基础上，将获取流水号的逻辑放在了这里。具体方法参考 <a class="link" href="#20250403122745-22nhmpf" >通过编号规则获取自动核收对应的流水号</a>。</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/// Others  w ##Class(LIS.Common.DHCVisitNumber).ReceiveLabNoByWGM(&#34;3&#34;,&#34;1000004476&#34;,&#34;20191105&#34;) 
</span></span><span class="line"><span class="cl">/// 按工作小组核收医嘱
</span></span><span class="line"><span class="cl">/// INPUT: MachID:仪器主键，LabNo：条码号，TransmitDate：上机日期（不传默认当天）
</span></span><span class="line"><span class="cl">/// OutPut: RetValue:1成功
</span></span><span class="line"><span class="cl">ClassMethod ReceiveLabNoByWGM(WorkGroupMachineDR As %String, LabNo As %String, TransmitDate, RackNo, RuleCode) As %String
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	s WorkGroupMachineDR=$g(WorkGroupMachineDR)
</span></span><span class="line"><span class="cl">	s LabNo=$g(LabNo)
</span></span><span class="line"><span class="cl">	s TransmitDate=$g(TransmitDate)
</span></span><span class="line"><span class="cl">	s RuleCode=$g(RuleCode)
</span></span><span class="line"><span class="cl">	s RackNo=$g(RackNo)
</span></span><span class="line"><span class="cl">	s NowDate=$zd($h,8)
</span></span><span class="line"><span class="cl">	s RetValue=1
</span></span><span class="line"><span class="cl">	i &#39;$l(TransmitDate) s TransmitDate=NowDate
</span></span><span class="line"><span class="cl">	i &#39;$l(WorkGroupMachineDR) q 100
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	s WorkGroupMachineName=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3)
</span></span><span class="line"><span class="cl">	s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4)
</span></span><span class="line"><span class="cl">	s DepartmentDR=$lg(^dbo.BTWorkGroupD(WorkGroupDR),4)
</span></span><span class="line"><span class="cl">    s HospitalDR=$lg(^dbo.BTDepartmentD(DepartmentDR),4)
</span></span><span class="line"><span class="cl">    s WorkGroupMachineDesc=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),3)
</span></span><span class="line"><span class="cl">    s IndexOperateType=##class(LIS.Util.Common).IndexData(&#34;H&#34;)
</span></span><span class="line"><span class="cl">    s AutoDR=$O(^dbo.RPWGMachineAutoI(&#34;IndexOperateType&#34;,IndexOperateType,WorkGroupMachineDR,&#34;&#34;)) 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    i &#39;$l(AutoDR) 
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">    	s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    	s perUser = &#34;WG-&#34;_WorkGroupDR
</span></span><span class="line"><span class="cl">    	s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未设置自动核收&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未设置自动核收！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser)
</span></span><span class="line"><span class="cl">	    q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未设置自动核收！&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    s MachineAutoData=$g(^dbo.RPWGMachineAutoD(AutoDR))
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    s IsOpen=$LG(MachineAutoData,4)
</span></span><span class="line"><span class="cl">    i IsOpen&#39;=1 
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">	    s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    	s perUser = &#34;WG-&#34;_WorkGroupDR
</span></span><span class="line"><span class="cl">    	s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未开启自动核收&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未开启自动核收！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser)
</span></span><span class="line"><span class="cl">	    q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未开启自动核收！&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    s CurrentDate = $p($h,&#34;,&#34;,1)
</span></span><span class="line"><span class="cl">	s Currenttime = $p($h,&#34;,&#34;,2)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	//开始时间
</span></span><span class="line"><span class="cl">	s StartDate=$lg(MachineAutoData,5)
</span></span><span class="line"><span class="cl">	i $l(StartDate) s StartDate= $zdh(StartDate,8)
</span></span><span class="line"><span class="cl">	s StartTime=$lg(MachineAutoData,6)
</span></span><span class="line"><span class="cl">	//结束时间
</span></span><span class="line"><span class="cl">	s EndDate=$lg(MachineAutoData,7)
</span></span><span class="line"><span class="cl">	i $l(EndDate) s EndDate= $zdh(EndDate,8)
</span></span><span class="line"><span class="cl">	s EndTime=$lg(MachineAutoData,8)
</span></span><span class="line"><span class="cl">	//时间类型
</span></span><span class="line"><span class="cl">	s TimeType=$lg(MachineAutoData,9)
</span></span><span class="line"><span class="cl">	i TimeType=&#34;CT&#34;  //连续
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">	    i (CurrentDate&lt;StartDate)||(($l(StartTime))&amp;&amp;(CurrentDate=StartDate)&amp;&amp;(Currenttime&lt;StartTime)) 
</span></span><span class="line"><span class="cl">	    {
</span></span><span class="line"><span class="cl">		    s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    		s perUser = &#34;WG-&#34;_WorkGroupDR
</span></span><span class="line"><span class="cl">    		s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期未生效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期未生效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser)
</span></span><span class="line"><span class="cl">		    q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期未生效！&#34;
</span></span><span class="line"><span class="cl">	    }
</span></span><span class="line"><span class="cl">	    i (CurrentDate&gt;EndDate)||(($l(EndTime))&amp;&amp;(CurrentDate=EndDate)&amp;&amp;(Currenttime&gt;EndTime) ) 
</span></span><span class="line"><span class="cl">	    {
</span></span><span class="line"><span class="cl">		    s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    		s perUser = &#34;WG-&#34;_WorkGroupDR
</span></span><span class="line"><span class="cl">    		s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期已失效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期已失效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser)
</span></span><span class="line"><span class="cl">		    q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期已失效！&#34;
</span></span><span class="line"><span class="cl">	    }
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	i TimeType=&#34;TS&#34;  //时间段
</span></span><span class="line"><span class="cl">	{
</span></span><span class="line"><span class="cl">		i (CurrentDate&lt;StartDate)||(($l(StartTime))&amp;&amp;(Currenttime&lt;StartTime))
</span></span><span class="line"><span class="cl">		{
</span></span><span class="line"><span class="cl">			s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    		s perUser = &#34;WG-&#34;_WorkGroupDR
</span></span><span class="line"><span class="cl">    		s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期未生效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期未生效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser)
</span></span><span class="line"><span class="cl">			q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期未生效！&#34;
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">	    i (CurrentDate&gt;EndDate)||(($l(EndTime))&amp;&amp;(Currenttime&gt;EndTime))
</span></span><span class="line"><span class="cl">	    {
</span></span><span class="line"><span class="cl">		    s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    		s perUser = &#34;WG-&#34;_WorkGroupDR
</span></span><span class="line"><span class="cl">    		s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收日期已失效&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】自动核收日期已失效！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser)
</span></span><span class="line"><span class="cl">			q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】自动核收日期已失效！&#34;  
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    s AcceptUserDR=&#34;&#34; i $l(AutoDR) s AcceptUserDR=$LG($g(^dbo.RPWGMachineAutoD(AutoDR)),10)
</span></span><span class="line"><span class="cl">    i &#39;$l(AcceptUserDR) d
</span></span><span class="line"><span class="cl">    .s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    .s perUser = &#34;WG-&#34;_WorkGroupDR
</span></span><span class="line"><span class="cl">    .s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;未设置负责人&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_&#34;工作小组【&#34;_WorkGroupMachineName_&#34;】未设置核收负责人！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser)
</span></span><span class="line"><span class="cl">    i &#39;$l(AcceptUserDR) q &#34;-1^该工作小组【&#34;_WorkGroupMachineDesc_&#34;】未设置核收负责人！&#34;
</span></span><span class="line"><span class="cl">    s CommDirection=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),11)
</span></span><span class="line"><span class="cl">	///判断医嘱是否核收
</span></span><span class="line"><span class="cl">	S AcceptFlag=0
</span></span><span class="line"><span class="cl">	s IsSpecialFlag=0
</span></span><span class="line"><span class="cl">	s CheckItemList=&#34;&#34;
</span></span><span class="line"><span class="cl">	s PreReportDR=&#34;&#34;
</span></span><span class="line"><span class="cl">	k TestSetList
</span></span><span class="line"><span class="cl">	s LabNoType=##Class(LISSP.DHCRPVisitNumber).GetLabNoType(LabNo)
</span></span><span class="line"><span class="cl">	s WebNamespace=##Class(OTH.SYSParameter).GetWebNamespace()
</span></span><span class="line"><span class="cl">    i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo))){
</span></span><span class="line"><span class="cl">	   
</span></span><span class="line"><span class="cl">           s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo),&#34;&#34;))
</span></span><span class="line"><span class="cl">           S TestSetDR=&#34;&#34;
</span></span><span class="line"><span class="cl">           f {
</span></span><span class="line"><span class="cl">	          s TestSetDR=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR))
</span></span><span class="line"><span class="cl">	          q:TestSetDR=&#34;&#34;
</span></span><span class="line"><span class="cl">	          s RowID=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR,&#34;&#34;))
</span></span><span class="line"><span class="cl">              i $l(RowID){
</span></span><span class="line"><span class="cl">	             s TestSetGroup=&#34;Default&#34; //工作小组下分组类型
</span></span><span class="line"><span class="cl">                 s WGMDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),5)
</span></span><span class="line"><span class="cl">                 i &#39;$l(WGMDR) s CheckItemList=TestSetDR_CheckItemList
</span></span><span class="line"><span class="cl">                 S AccpetReportDR=$LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11)
</span></span><span class="line"><span class="cl">                 I $L(AccpetReportDR) s AccpetWGMDR=$LG($G(^dbo.RPVisitNumberReportD(AccpetReportDR)),4) I $LG($g(^dbo.BTWorkGroupMachineD(AccpetWGMDR)),13)&#39;=1 continue
</span></span><span class="line"><span class="cl">                 s AcceptFlag=0
</span></span><span class="line"><span class="cl">                 I $L(WGMDR) S AcceptFlag=$LG($g(^dbo.BTWorkGroupMachineD(WGMDR)),13) //是否是前处理小组
</span></span><span class="line"><span class="cl">                 I AcceptFlag=1 S PreReportDR= $LG($g(^dbo.RPVisitNumberTestSetD(RowID)),11),IsSpecialFlag=1
</span></span><span class="line"><span class="cl">                 I AcceptFlag=1,$D(^dbo.BTTestSetWorkGroupMachineI(&#34;IndexMaster&#34;,TestSetDR,WorkGroupMachineDR))
</span></span><span class="line"><span class="cl">                 {
</span></span><span class="line"><span class="cl">	                  //处理报告分组信息
</span></span><span class="line"><span class="cl">	                  i $d(^dbo.BTWorkGroupMachineRuleTSI(&#34;IndexTestSet&#34;,TestSetDR))
</span></span><span class="line"><span class="cl">	                  {
</span></span><span class="line"><span class="cl">		                   s WorkGroupMachineRuleDR=&#34;&#34;
</span></span><span class="line"><span class="cl">		                   f{
</span></span><span class="line"><span class="cl">			                   s WorkGroupMachineRuleDR=$o(^dbo.BTWorkGroupMachineRuleTSI(&#34;IndexTestSet&#34;,TestSetDR,WorkGroupMachineRuleDR)) 
</span></span><span class="line"><span class="cl">			                   q:WorkGroupMachineRuleDR=&#34;&#34;
</span></span><span class="line"><span class="cl">			                   s GroupWGMDR=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),4)
</span></span><span class="line"><span class="cl">			                   s IsShow=$lg($g(^dbo.BTWorkGroupMachineRuleD(WorkGroupMachineRuleDR)),5)
</span></span><span class="line"><span class="cl">			                   i WorkGroupMachineDR&#39;=GroupWGMDR continue
</span></span><span class="line"><span class="cl">			                   i IsShow=&#34;1&#34; continue
</span></span><span class="line"><span class="cl">			                   s TestSetGroup=WorkGroupMachineRuleDR
</span></span><span class="line"><span class="cl">			                }  
</span></span><span class="line"><span class="cl">		              }
</span></span><span class="line"><span class="cl">		              s TestSetList(TestSetGroup,TestSetDR)=&#34;&#34;   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	             }
</span></span><span class="line"><span class="cl">              }   
</span></span><span class="line"><span class="cl">	       }   
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(LabNo),&#34;&#34;))
</span></span><span class="line"><span class="cl">    //前处理标本核收
</span></span><span class="line"><span class="cl">    i IsSpecialFlag=1
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">	    I &#39;$D(TestSetList) s RetValue=&#34;-1^无可核收医嘱&#34;   q RetValue
</span></span><span class="line"><span class="cl">	    s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate)
</span></span><span class="line"><span class="cl">        Set $ZTrap = &#34;ErrorHandle&#34;
</span></span><span class="line"><span class="cl">        TSTART
</span></span><span class="line"><span class="cl">        s MajorConclusion=&#34;&#34;,OldEpi=&#34;&#34;,MiniConclusion=&#34;&#34;
</span></span><span class="line"><span class="cl">        i $l(PreReportDR) s MajorConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),40),MiniConclusion=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),41),OldEpi=$lg($g(^dbo.RPVisitNumberReportD(PreReportDR)),8)
</span></span><span class="line"><span class="cl">        s maxEpis=OldEpi
</span></span><span class="line"><span class="cl">        s TestSetGroup=&#34;&#34;
</span></span><span class="line"><span class="cl">        f{
</span></span><span class="line"><span class="cl">	        s TestSetGroup=$o(TestSetList(TestSetGroup))
</span></span><span class="line"><span class="cl">	        q:TestSetGroup=&#34;&#34;  
</span></span><span class="line"><span class="cl">	        s objVisitNumberReport=##class(dbo.RPVisitNumberReport).%New()
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.VisitNumberDR=VisitNumberDR
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.TransmitDate=TransmitDate
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.WorkGroupMachineDR=WorkGroupMachineDR 
</span></span><span class="line"><span class="cl">			S objVisitNumberReport.MajorConclusion=MajorConclusion
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.MinorConclusion=MiniConclusion
</span></span><span class="line"><span class="cl">			S OrderNo=1
</span></span><span class="line"><span class="cl">			if $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,&#34;1&#34;)) {
</span></span><span class="line"><span class="cl">			  s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,&#34;&#34;),-1)
</span></span><span class="line"><span class="cl">			  s OrderNo=(OrderNo +1)
</span></span><span class="line"><span class="cl">		    }
</span></span><span class="line"><span class="cl">		    s AssayNo=&#34;&#34;
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.OrderNo=OrderNo
</span></span><span class="line"><span class="cl">	        i ((CommDirection=&#34;UP&#34;)||(CommDirection=&#34;BI&#34;)) s AssayNo=LabNo 
</span></span><span class="line"><span class="cl">	        i &#39;$l(AssayNo) s AssayNo=maxEpis
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.AccessionNo=&#34;&#34;   ///细菌分离号
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.AssayNo=AssayNo
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.EpisodeNo=maxEpis
</span></span><span class="line"><span class="cl">			i $l(maxEpis) s ^DHCLABWGMEPSIDERECORD(&#34;WGM&#34;,WorkGroupMachineDR,TransmitDate,maxEpis)=&#34;&#34;
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.AcceptDate=$tr($zd(+$h,3),&#34;-&#34;)
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.AcceptTime=$p($h,&#34;,&#34;,2)
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.AcceptUserDR=AcceptUserDR
</span></span><span class="line"><span class="cl">			i $l(RackNo) s objVisitNumberReport.RackNo=RackNo
</span></span><span class="line"><span class="cl">			s objVisitNumberReport.Status=1  //报告状态(1登记，2初审，3审核，4复查，5取消审核，6作废，O其他)
</span></span><span class="line"><span class="cl">			s ret=objVisitNumberReport.%Save()
</span></span><span class="line"><span class="cl">			If ($SYSTEM.Status.IsOK(ret)) {s RetValue=1  }
</span></span><span class="line"><span class="cl">			Else {s err=&#34;报告生成失败:&#34;_$SYSTEM.Status.GetErrorText(ret) s RetValue=&#34;-1^&#34;_err   q }
</span></span><span class="line"><span class="cl">		    I &#39;$D(TestSetList(TestSetGroup)) s RetValue=&#34;-1^无可核收医嘱&#34;   q 
</span></span><span class="line"><span class="cl">		    s TestSetDR=&#34;&#34; 
</span></span><span class="line"><span class="cl">		    F {
</span></span><span class="line"><span class="cl">			    s TestSetDR=$o(TestSetList(TestSetGroup,TestSetDR))  
</span></span><span class="line"><span class="cl">			    q:TestSetDR=&#34;&#34;
</span></span><span class="line"><span class="cl">	            s RowID=$o(^dbo.RPVisitNumberTestSetI(&#34;IndexMaster&#34;,VisitNumberDR,TestSetDR,&#34;&#34;))
</span></span><span class="line"><span class="cl">			    i $l(RowID){ //修改标本医嘱核收工作小组
</span></span><span class="line"><span class="cl">					s objTestSets=##class(dbo.RPVisitNumberTestSet).%OpenId(RowID)
</span></span><span class="line"><span class="cl">					s objTestSets.VisitNumberReportDR=objVisitNumberReport.RowID
</span></span><span class="line"><span class="cl">					s objTestSets.WorkGroupMachineDR=WorkGroupMachineDR
</span></span><span class="line"><span class="cl">					s sc=objTestSets.%Save()
</span></span><span class="line"><span class="cl">	                If (&#39;$SYSTEM.Status.IsOK(sc)) {
</span></span><span class="line"><span class="cl">	 	               s RetValue=$SYSTEM.Status.GetErrorText(sc)  Quit  
</span></span><span class="line"><span class="cl">	 	            }
</span></span><span class="line"><span class="cl">	 	            //按医嘱生成报告项目结果
</span></span><span class="line"><span class="cl">				    s RetValue=##Class(LISSP.DHCRPVisitNumberReport).SaveReportTestCode(objVisitNumberReport.RowID,TestSetDR)
</span></span><span class="line"><span class="cl">				    i RetValue&#39;=1   q
</span></span><span class="line"><span class="cl">	 	        
</span></span><span class="line"><span class="cl">				}  
</span></span><span class="line"><span class="cl">		    }
</span></span><span class="line"><span class="cl">	    }
</span></span><span class="line"><span class="cl">	    i RetValue&#39;=1  TROLLBACK  Quit RetValue
</span></span><span class="line"><span class="cl">	    //删除前处理报告
</span></span><span class="line"><span class="cl">        i $l(PreReportDR),&#39;$d(^dbo.RPVisitNumberTestSetI(&#34;IndexReportID&#34;,PreReportDR)){
</span></span><span class="line"><span class="cl">                 s sc=##class(dbo.RPVisitNumberReport).%DeleteId(PreReportDR)
</span></span><span class="line"><span class="cl">                 If (&#39;$SYSTEM.Status.IsOK(sc)){s RetValue=&#34;删除报告信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc)    }
</span></span><span class="line"><span class="cl">	    }
</span></span><span class="line"><span class="cl">	    i RetValue&#39;=1 TROLLBACK  Quit RetValue 
</span></span><span class="line"><span class="cl">	    TCOMMIT
</span></span><span class="line"><span class="cl">	    i $l(WorkGroupMachineDR),$l(maxEpis) s ret=##Class(HIS.DHCCommon).SaveWorkGroupMachineEpis(WorkGroupMachineDR,TransmitDate,maxEpis,&#34;&#34;)
</span></span><span class="line"><span class="cl">	  
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	else
</span></span><span class="line"><span class="cl">	{    
</span></span><span class="line"><span class="cl">		//普通标本核收
</span></span><span class="line"><span class="cl">		s maxEpis=..GetMaxMiEpisodeNo(WorkGroupMachineDR,TransmitDate)
</span></span><span class="line"><span class="cl">		s Flag=1		//YHR 20250319 仪器自动核收标志，为1的话，不影响工作小组手动核收序号
</span></span><span class="line"><span class="cl">		s Param=&#34;&lt;Data&gt;&lt;P0&gt;H&lt;/P0&gt;&#34;
</span></span><span class="line"><span class="cl">		s Param=Param_&#34;&lt;P1&gt;&#34;_LabNo_&#34;&lt;/P1&gt;&lt;P2&gt;&lt;/P2&gt;&#34;
</span></span><span class="line"><span class="cl">		s Param=Param_&#34;&lt;P3&gt;&#34;_maxEpis_&#34;&lt;/P3&gt;&#34;
</span></span><span class="line"><span class="cl">		s Param=Param_&#34;&lt;P4&gt;&#34;_AcceptUserDR_&#34;&lt;/P4&gt;&lt;P5&gt;&lt;/P5&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P7&gt;&lt;/P7&gt;&#34;
</span></span><span class="line"><span class="cl">		s Param=Param_&#34;&lt;P8&gt;&#34;_WorkGroupMachineDR_&#34;&lt;/P8&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P12&gt;&#34;_RackNo_&#34;&lt;/P12&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P14&gt;@@1@@&#34;_Flag_&#34;&lt;/P14&gt;&lt;/Data&gt;&#34;
</span></span><span class="line"><span class="cl">		s Sessions=AcceptUserDR_&#34;^&#34;_WorkGroupDR_&#34;^^^&#34;_HospitalDR
</span></span><span class="line"><span class="cl">		s ret=##Class(LISSP.DHCRPVisitNumber).ReceiveVisitNumber(LabNo,Param,Sessions)
</span></span><span class="line"><span class="cl">		i $p(ret,&#34;^&#34;,1)&#39;=&#34;1&#34; s RetValue=ret
</span></span><span class="line"><span class="cl">    } 
</span></span><span class="line"><span class="cl">	q RetValue
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ErrorHandle
</span></span><span class="line"><span class="cl">	TROLLBACK
</span></span><span class="line"><span class="cl">	s RetValue=&#34;-1^错误&#34;_$tr($ZERROR,&#34;^&#34;,&#34;--&#34;)_&#34;.错误代码:&#34;_$ECODE
</span></span><span class="line"><span class="cl">    Quit RetValue
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="20250403122745-22nhmpf">通过编号规则获取自动核收对应的流水号
</h3><blockquote>
<p>本方法通过维护编号规则，编号规则代码与工作小组代码相同时，从编号规则获取对应工作小组流水号。</p>
<p>避免核收失败流水号浪费造成跳号情况，本方法做出以下处理。</p>
<p>1.先进行判断编号规则当前号是否在对应工作小组有报告，如果没有的话则还使用当前的流水号再次进行核收，如果有的话，则进入到下一个获取流水号的逻辑。</p>
<p>2.通过编号规则获取下一个流水号，并进行最大1000次的判断循环取号，避免号重复核收失败。</p>
<p>3.如果未通过编号规则获取到流水号，获取失败或者没有维护对应的编号规则，则获取当前工作小组最大流水号</p></blockquote>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403125731-kgqb3bk.png"
	width="1643"
	height="616"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403125731-kgqb3bk_hu_e222b20ab9dc2740.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403125731-kgqb3bk_hu_82a0375903c677b8.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="266"
		data-flex-basis="640px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[[&#34;0&#34;,&#34;1&#34;,&#34;2&#34;,&#34;3&#34;,&#34;4&#34;,&#34;5&#34;,&#34;6&#34;,&#34;7&#34;,&#34;8&#34;,&#34;9&#34;],[&#34;0&#34;,&#34;1&#34;,&#34;2&#34;,&#34;3&#34;,&#34;4&#34;,&#34;5&#34;,&#34;6&#34;,&#34;7&#34;,&#34;8&#34;,&#34;9&#34;],[&#34;0&#34;,&#34;1&#34;,&#34;2&#34;,&#34;3&#34;,&#34;4&#34;,&#34;5&#34;,&#34;6&#34;,&#34;7&#34;,&#34;8&#34;,&#34;9&#34;],[&#34;0&#34;,&#34;1&#34;,&#34;2&#34;,&#34;3&#34;,&#34;4&#34;,&#34;5&#34;,&#34;6&#34;,&#34;7&#34;,&#34;8&#34;,&#34;9&#34;]
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/// Creator：      YHR
</span></span><span class="line"><span class="cl">/// CreatDate：    20250320
</span></span><span class="line"><span class="cl">/// Description：  通过编号规则获取工作小组最大流水号
</span></span><span class="line"><span class="cl">/// Table：        dbo.RPVisitNumberReport
</span></span><span class="line"><span class="cl">/// Input：        工作小组，日期(只能获取当天的，编号规则隔天后会刷新)
</span></span><span class="line"><span class="cl">/// Output：       无
</span></span><span class="line"><span class="cl">/// Return：       失败:&#34;&#34;  成功:流水号
</span></span><span class="line"><span class="cl">/// Others		   【原】w ##Class(LIS.Common.DHCVisitNumber).GetMaxMiEpisodeNo(&#34;41&#34;,&#34;20250319&#34;)
</span></span><span class="line"><span class="cl">/// k ^TMP(&#34;MI.MIFIT3000N1.1&#34;,&#34;WGMEpis&#34;,&#34;41&#34;)
</span></span><span class="line"><span class="cl">/// w ##Class(MI.MIFIT3000N1).GetMaxMiEpisodeNo(&#34;41&#34;,&#34;20250403&#34;)
</span></span><span class="line"><span class="cl">ClassMethod GetMaxMiEpisodeNo(WorkGroupMachineDR As %String, TransmitDate As %String) As %String
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	S TransmitDate=$g(TransmitDate)
</span></span><span class="line"><span class="cl">	S WorkGroupMachineDR=$G(WorkGroupMachineDR)
</span></span><span class="line"><span class="cl">	S RetValue=&#34;&#34;
</span></span><span class="line"><span class="cl">	i &#39;$l(WorkGroupMachineDR) q RetValue
</span></span><span class="line"><span class="cl">	i &#39;$l(TransmitDate) s TransmitDate=$zd($h,8)
</span></span><span class="line"><span class="cl">	s TransmitDate=$tr(TransmitDate,&#34;-&#34;)
</span></span><span class="line"><span class="cl">	s WorkGroupMachineCode=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),2)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	//记录该工作小组当天最大的流水号，如果有记录，则优先判断是否核收成功，如果未核收成功仍旧使用该号码
</span></span><span class="line"><span class="cl">	i $d(^dbo.SYSRuleNoBaseI(&#34;IndexCode&#34;,WorkGroupMachineCode)) d
</span></span><span class="line"><span class="cl">	.s RuleNoBasDR=$o(^dbo.SYSRuleNoBaseI(&#34;IndexCode&#34;,WorkGroupMachineCode,&#34;&#34;))
</span></span><span class="line"><span class="cl">	.s JLEpis=$lg($g(^dbo.SYSRuleNoBaseD(RuleNoBasDR)),5)
</span></span><span class="line"><span class="cl">	.i &#39;$l(JLEpis) q
</span></span><span class="line"><span class="cl">	.i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,JLEpis,TransmitDate)) d
</span></span><span class="line"><span class="cl">	..s RetValue=JLEpis
</span></span><span class="line"><span class="cl">	i $l(RetValue) q RetValue
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	//通过编号规则获取当天流水号，编号规则代码设置为工作小组同样代码，通过代码获取工作小组对应的编号规则
</span></span><span class="line"><span class="cl">	s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode) //YHR 20230810 罗氏流水线规则
</span></span><span class="line"><span class="cl">	i $l(ZDHSEpis) d
</span></span><span class="line"><span class="cl">	.i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d
</span></span><span class="line"><span class="cl">	..s RetValue=ZDHSEpis
</span></span><span class="line"><span class="cl">	.e  d
</span></span><span class="line"><span class="cl">	..f Num=1:1:1000 d		//避免死循环，每次进行一千次增号判断
</span></span><span class="line"><span class="cl">	...s ZDHSEpis=##class(LIS.WS.BLL.DHCLISRuleNo).GetNextNoByCodeMTHD(WorkGroupMachineCode)
</span></span><span class="line"><span class="cl">	...i &#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexMicNo&#34;,WorkGroupMachineDR,ZDHSEpis,TransmitDate)) d
</span></span><span class="line"><span class="cl">	....s RetValue=ZDHSEpis
</span></span><span class="line"><span class="cl">	....s Num=1001
</span></span><span class="line"><span class="cl">	i $l(RetValue) q RetValue
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	//未查询到编号规则，则获取当前工作小组最大流水号
</span></span><span class="line"><span class="cl">	s Parameter=&#34;&lt;Data&gt;&lt;P3&gt;&lt;/P3&gt;&lt;P12&gt;&lt;/P12&gt;&lt;P4&gt;&lt;/P4&gt;&lt;P0&gt;&#34;_TransmitDate_&#34;&lt;/P0&gt;&lt;P8&gt;&lt;/P8&gt;&lt;P10&gt;&lt;/P10&gt;&lt;P5&gt;&lt;/P5&gt;&lt;P1&gt;&lt;/P1&gt;&lt;P13&gt;&lt;/P13&gt;&lt;P9&gt;&lt;/P9&gt;&lt;P14&gt;&lt;/P14&gt;&lt;P6&gt;&lt;/P6&gt;&lt;P2&gt;&lt;/P2&gt;&lt;P11&gt;&lt;/P11&gt;&lt;P7&gt;&lt;/P7&gt;&lt;/Data&gt;&#34;
</span></span><span class="line"><span class="cl">	s WGMEpisNo=##Class(LISSP.DHCRPVisitNumberReport).GetMaxEpisodeNo(WorkGroupMachineDR,Parameter) 			//YHR 20250317 获取最大流水号报错问题处理
</span></span><span class="line"><span class="cl">	i $l(WGMEpisNo) s RetValue=WGMEpisNo
</span></span><span class="line"><span class="cl">	q RetValue
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="记录标本操作日志">记录标本操作日志
</h3><blockquote>
<p>记录仪器对于标本的操作日志，比如自动核收，上机，归档等信息</p>
<p>示例：j ..SaveRecord(epis,&ldquo;归档中位置:&quot;_positioninfo,mi,&ldquo;62&rdquo;)	//归档</p>
<p>此处62为操作表的Code，操作表为 <code>dbo.BTOperatorType</code>​</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/// 记录标本日志
</span></span><span class="line"><span class="cl">/// D ##class(MI.MIFRS600).SaveRecord(&#34;&#34;,&#34;&#34;)
</span></span><span class="line"><span class="cl">ClassMethod SaveRecord(labno, OperateNotes, mi, OperateTypeCode, curWorkGroupMachineDR)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	s labno=$g(labno)
</span></span><span class="line"><span class="cl">	s OperateNotes=$g(OperateNotes)
</span></span><span class="line"><span class="cl">	s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR)
</span></span><span class="line"><span class="cl">	s OperateTypeCode=$g(OperateTypeCode)
</span></span><span class="line"><span class="cl">	i &#39;$l(curWorkGroupMachineDR),$l(mi) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)
</span></span><span class="line"><span class="cl">	i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d
</span></span><span class="line"><span class="cl">	.s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))
</span></span><span class="line"><span class="cl">	.//标本ID,操作时间,操作者,操作说明,操作类型,工作组,标本拒收类型
</span></span><span class="line"><span class="cl">	.//BTOperatorType 标本操作类型表
</span></span><span class="line"><span class="cl">	.d ##class(HIS.DHCCommon).SaveRecord(VisitNumberDR,$zd($h,8),$p($h,&#34;,&#34;,2),&#34;&#34;,OperateNotes,OperateTypeCode,curWorkGroupMachineDR,&#34;&#34;)
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="存储报警信息标志">存储报警信息标志
</h3><blockquote>
<p>将报警信息存放到报告表中结果报警信息（ResultWarned）中，该字段为自动审核存储报警信息使用，未验证是否冲突。</p></blockquote>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403141420-mntf0zd.png"
	width="1717"
	height="854"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403141420-mntf0zd_hu_8542b01be0d0b045.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403141420-mntf0zd_hu_f6a4047d52b65019.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="201"
		data-flex-basis="482px"
	
></p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403141640-tetyapl.png"
	width="1770"
	height="861"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403141640-tetyapl_hu_f0122fddfee6e1d1.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403141640-tetyapl_hu_4c5c2493c019b54a.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="205"
		data-flex-basis="493px"
	
></p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403153532-0wai8b3.png"
	width="1774"
	height="860"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403153532-0wai8b3_hu_49639aabca5a23b.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403153532-0wai8b3_hu_cc09c6e0a758263f.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="206"
		data-flex-basis="495px"
	
></p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250404103016-a10c7oi.png"
	width="1768"
	height="859"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250404103016-a10c7oi_hu_3bc683c1578f010e.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250404103016-a10c7oi_hu_88b93976511d5cfb.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="205"
		data-flex-basis="493px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/// 保存报告表报警信息标志
</span></span><span class="line"><span class="cl">/// D ##class(MI.MIFIT3000N1).SaveResultWarned(&#34;1003803130&#34;,&#34;1&#34;,&#34;34&#34;,&#34;41&#34;)
</span></span><span class="line"><span class="cl">ClassMethod SaveResultWarned(labno, conclusion, predealMI, curWorkGroupMachineDR)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	s labno=$g(labno)
</span></span><span class="line"><span class="cl">	s conclusion=$g(conclusion)
</span></span><span class="line"><span class="cl">	s predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR)
</span></span><span class="line"><span class="cl">	i &#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6)
</span></span><span class="line"><span class="cl">	i $l(conclusion)&gt;20 s conclusion=$e(conclusion,1,20)_&#34;...&#34; 
</span></span><span class="line"><span class="cl">	s hasFindRep=0
</span></span><span class="line"><span class="cl">	i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d
</span></span><span class="line"><span class="cl">	.s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))
</span></span><span class="line"><span class="cl">	.i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d
</span></span><span class="line"><span class="cl">	..s WorkGroupMachineDR=&#34;&#34; f  s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34;  d
</span></span><span class="line"><span class="cl">	...s OrderNo=&#34;&#34; f  s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34;  d
</span></span><span class="line"><span class="cl">	....s ReportDR=&#34;&#34; f  s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34;  d
</span></span><span class="line"><span class="cl">	.....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) 
</span></span><span class="line"><span class="cl">	.....i Status=&#34;3&#34; q
</span></span><span class="line"><span class="cl">	.....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) 
</span></span><span class="line"><span class="cl">	.....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)
</span></span><span class="line"><span class="cl">	.....s objrep.ResultWarned=conclusion
</span></span><span class="line"><span class="cl">	.....s sc=objrep.%Save()
</span></span><span class="line"><span class="cl">	.....s hasFindRep=1
</span></span><span class="line"><span class="cl">	.....i (&#39;$SYSTEM.Status.IsOK(sc)) d
</span></span><span class="line"><span class="cl">	......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl">	i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d
</span></span><span class="line"><span class="cl">	.s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))
</span></span><span class="line"><span class="cl">	.s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)
</span></span><span class="line"><span class="cl">	.s objrep.ResultWarned=conclusion
</span></span><span class="line"><span class="cl">	.s sc=objrep.%Save()
</span></span><span class="line"><span class="cl">	.s hasFindRep=1
</span></span><span class="line"><span class="cl">	i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl">	q &#34;1&#34;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>基于此功能增加报告列表报警信息展示功能</p>
<h4 id="报警信息存储记录展示">报警信息存储记录展示
</h4><blockquote>
<p>仪器保存到报告表中结果报警信息后，在报告列表进行展示。只有非审核状态标本有此标志，其他状态显示报警信息标志。</p>
<p>d ##Class(%ResultSet).RunQuery(&ldquo;LIS.WS.BLL.DHCRPReportManage&rdquo;,&ldquo;QryWorkList&rdquo;,&ldquo;NoAuth&rdquo;,&ldquo;2022-11-16&rdquo;,&rdquo;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&ldquo;15&rdquo;,&ldquo;N^^0<sup>&rdquo;,&quot;&quot;,&quot;&quot;,&ldquo;8280</sup>4<sup>0</sup>2^1&rdquo;)</p></blockquote>
<p>后台增加输出结果报警信息字段</p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140442-oad74gg.png"
	width="1760"
	height="716"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140442-oad74gg_hu_33b65cbcd011d4c3.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140442-oad74gg_hu_b67d9fd391ccb7.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="245"
		data-flex-basis="589px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">s ResultWarned=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),49)		//YHR 20250329 报警信息
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140240-4lyflla.png"
	width="1788"
	height="913"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140240-4lyflla_hu_af0b1576e22c5341.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140240-4lyflla_hu_aa9194712606c218.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="195"
		data-flex-basis="470px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">if (row.ResultWarned != null &amp;&amp; row.ResultWarned.length &gt; 0 &amp;&amp; !row.Status.includes(&#34;3&#34;) ) retInfo = retInfo + &#39;&lt;img  src=&#34;../../resource/easyui/themes/icons/abnresult.gif&#34; title=&#34;&#39; + escapeHtml(row.ResultWarned) + &#39;&#34;  /&gt;&#39;;		//YHR 20250329 报告列表显示报警信息
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于报警信息进行转义</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">function escapeHtml(unsafe) {
</span></span><span class="line"><span class="cl">  return unsafe
</span></span><span class="line"><span class="cl">    .replace(/&amp;/g, &#34;&amp;amp;&#34;)
</span></span><span class="line"><span class="cl">    .replace(/&lt;/g, &#34;&amp;lt;&#34;)
</span></span><span class="line"><span class="cl">    .replace(/&gt;/g, &#34;&amp;gt;&#34;)
</span></span><span class="line"><span class="cl">    .replace(/&#34;/g, &#34;&amp;quot;&#34;)
</span></span><span class="line"><span class="cl">    .replace(/&#39;/g, &#34;&amp;#039;&#34;);
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="报告处理增加筛选功能">报告处理增加筛选功能
</h4><blockquote>
<p>可以快速对于含有报警信息的报告进行快速筛选</p></blockquote>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140639-hvs4rro.png"
	width="1780"
	height="932"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140639-hvs4rro_hu_61a8c8f0ddef9341.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140639-hvs4rro_hu_7d29bbc0ab577a94.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="190"
		data-flex-basis="458px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;div listranslate=&#34;title~Display expedited report^html~U&amp;报告处理&#34; class=&#34;HISUITheme2&#34; onclick=&#34;SearchReportList(&#39;8&#39;)&#34; style=&#34;background-color: #FFF3E1; color: #AC5919; border: 1px solid #CF8A3B; display: inline-block; border-radius: 4px; width: 16px; height: 16px; text-align: center; line-height: 17px; font-size: 13px; vertical-align: top; cursor: pointer;&#34;  onmouseover=&#34;this.style.cursor=&#39;pointer&#39;&#34; title=&#34;展示含有报警信息报告&#34;&gt;警&lt;/div&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;div listranslate=&#34;title~Display expedited report^html~U&amp;报告处理&#34; class=&#34;HISUITheme&#34; onclick=&#34;SearchReportList(&#39;8&#39;)&#34; style=&#34;background-color: #dd3838; color: #FFF; border: 1px solid #e91b1b; display: inline-block; border-radius: 4px; width: 16px; height: 16px; text-align: center; line-height: 17px; font-size: 13px; vertical-align: top; cursor: pointer;&#34;  onmouseover=&#34;this.style.cursor=&#39;pointer&#39;&#34; title=&#34;展示含有报警信息报告&#34;&gt;警&lt;/div&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140718-vk0w56m.png"
	width="1765"
	height="861"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140718-vk0w56m_hu_276d72f122f92763.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403140718-vk0w56m_hu_de221f0be3e93179.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="204"
		data-flex-basis="491px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> else if (Flag == &#34;8&#34;) {		//YHR 20250331 增加报警信息筛选
</span></span><span class="line"><span class="cl">                //查询已处理危急值
</span></span><span class="line"><span class="cl">                if (obj.ResultWarned.length != 0) {
</span></span><span class="line"><span class="cl">                    rows.push(obj);
</span></span><span class="line"><span class="cl">                }
</span></span><span class="line"><span class="cl">            }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="存放报警信息或者评价信息">存放报警信息或者评价信息
</h3><blockquote>
<p>根据科室实际要求来，本接口只是将报警信息存放到其他结果字段，此方法只是扩展补充，将报警信息存放到主评价或者次评价</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/// 保存评价信息(仪器报警信息等提示信息)
</span></span><span class="line"><span class="cl">/// 条码号或者流水号，存储信息，仪器主键，工作小组(仪器和工作小组非关联使用)，是否打印(1 主评价，0 次评价)
</span></span><span class="line"><span class="cl">/// D ##class(MI.Special.Common).SaveAlarmInformation(&#34;1003791311&#34;,&#34;Lymphopenia：淋巴细胞减少；Anemia：贫血；Reticulocytosis：网织红细胞增多&#34;,&#34;3&#34;)
</span></span><span class="line"><span class="cl">/// D ##class(MI.Special.Common).SaveAlarmInformation(&#34;8000001163&#34;,&#34;Monocytosis：单核细胞增加，Microcytosis：小红细胞症，Anemia：贫血，HGB Defect?：HGB异常？，IG present：幼稚粒细胞存在&#34;,&#34;77&#34;)
</span></span><span class="line"><span class="cl">ClassMethod SaveAlarmInformation(labno, conclusion, predealMI, curWorkGroupMachineDR, IsPrint)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	s labno=$g(labno),conclusion=$g(conclusion),predealMI=$g(predealMI),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),IsPrint=$g(IsPrint)
</span></span><span class="line"><span class="cl">	i &#39;$l(predealMI),&#39;$l(curWorkGroupMachineDR) q &#34;&#34;
</span></span><span class="line"><span class="cl">	i IsPrint&#39;=1 s IsPrint=&#34;0&#34;	//1 打印主评价，0 不打印次评价
</span></span><span class="line"><span class="cl">	i &#39;$l(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(predealMI)),6)
</span></span><span class="line"><span class="cl">	s hasFindRep=0
</span></span><span class="line"><span class="cl">	i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d
</span></span><span class="line"><span class="cl">	.s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))
</span></span><span class="line"><span class="cl">	.i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d
</span></span><span class="line"><span class="cl">	..s WorkGroupMachineDR=&#34;&#34; f  s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34;  d
</span></span><span class="line"><span class="cl">	...s OrderNo=&#34;&#34; f  s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34;  d
</span></span><span class="line"><span class="cl">	....s ReportDR=&#34;&#34; f  s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34;  d
</span></span><span class="line"><span class="cl">	.....s Status=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),22) 
</span></span><span class="line"><span class="cl">	.....;i Status=&#34;3&#34; q	//审核后的标本存储报警信息，测试用
</span></span><span class="line"><span class="cl">	.....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) 
</span></span><span class="line"><span class="cl">	.....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)
</span></span><span class="line"><span class="cl">	.....i IsPrint=1 d
</span></span><span class="line"><span class="cl">	......i $l(objrep.MajorConclusion) s objrep.MajorConclusion=objrep.MajorConclusion_&#34;,&#34;_conclusion
</span></span><span class="line"><span class="cl">	......e  s objrep.MajorConclusion=conclusion
</span></span><span class="line"><span class="cl">	.....e  d
</span></span><span class="line"><span class="cl">	......i $l(objrep.MinorConclusion) s objrep.MinorConclusion=objrep.MinorConclusion_&#34;,&#34;_conclusion
</span></span><span class="line"><span class="cl">	......e  s objrep.MinorConclusion=conclusion
</span></span><span class="line"><span class="cl">	.....s sc=objrep.%Save()
</span></span><span class="line"><span class="cl">	.....s hasFindRep=1
</span></span><span class="line"><span class="cl">	.....i (&#39;$SYSTEM.Status.IsOK(sc)) d
</span></span><span class="line"><span class="cl">	......d Trace^MI.MIF000(predealMI,&#34;-1^存标本质量信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl">	i hasFindRep=0,$l(curWorkGroupMachineDR),$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d
</span></span><span class="line"><span class="cl">	.s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))
</span></span><span class="line"><span class="cl">	.s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)
</span></span><span class="line"><span class="cl">	.i IsPrint=1 d
</span></span><span class="line"><span class="cl">	..s objrep.MajorConclusion=conclusion
</span></span><span class="line"><span class="cl">	.e  s objrep.MinorConclusion=conclusion
</span></span><span class="line"><span class="cl">	.s sc=objrep.%Save()
</span></span><span class="line"><span class="cl">	.s hasFindRep=1
</span></span><span class="line"><span class="cl">	i hasFindRep=0 d Trace^MI.MIF000(predealMI,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl">	try{D ##class(MI.Special.Common).SaveResultWarned(labno,conclusion,predealMI, curWorkGroupMachineDR)}catch{}	//保存至报告表报警信息
</span></span><span class="line"><span class="cl">	q &#34;1&#34;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="存储架子号信息以及标本操作日志记录">存储架子号信息以及标本操作日志记录
</h3><blockquote>
<p>标本在流水线上有分区，上机，标本位置变化和标本归档等操作。之前查询标本位置需要在仪器软件上进行搜索查看，基于流水线本身会传输标本在流水线上的相关信息，因此对于这些信息解析。并将这些信息，存放至标本操作日志，将标本当前位置存放至架子号。</p>
<p>本初增加额外的标本操作类型，101，架子号更新，避免仪器传错信息，仍旧可以有地方记录查看。</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/// 保存归档,分类信息,架子号,新增保存类型和参数工作小组ID，针对仪器不在对应的工作小组也可以保存架子号。
</span></span><span class="line"><span class="cl">/// D ##class(MI.Special.Common).SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR)
</span></span><span class="line"><span class="cl">/// D ##class(MI.Special.Common).SaveRackNo(&#34;1003775669&#34;,&#34;c702-5719@4&#34;,&#34;34&#34;,&#34;上机&#34;)
</span></span><span class="line"><span class="cl">/// D ##class(MI.Special.Common).SaveRackNo(&#34;1003807721&#34;,&#34;新产业-NA024-2&#34;,&#34;45&#34;,&#34;上机&#34;)
</span></span><span class="line"><span class="cl">ClassMethod SaveRackNo(labno, positioninfo, mi, typename, curWorkGroupMachineDR)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	s labno=$g(labno)
</span></span><span class="line"><span class="cl">	s positioninfo=$g(positioninfo)
</span></span><span class="line"><span class="cl">	s mi=$g(mi),curWorkGroupMachineDR=$g(curWorkGroupMachineDR),typename=$g(typename)
</span></span><span class="line"><span class="cl">	i &#39;$L(curWorkGroupMachineDR) s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)
</span></span><span class="line"><span class="cl">	i $l(typename) s positioninfo=typename_&#34;:&#34;_positioninfo
</span></span><span class="line"><span class="cl">	s hasFindRep=0
</span></span><span class="line"><span class="cl">	i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno))) d
</span></span><span class="line"><span class="cl">	.s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))
</span></span><span class="line"><span class="cl">	.i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) d
</span></span><span class="line"><span class="cl">	..s WorkGroupMachineDR=&#34;&#34; f  s WorkGroupMachineDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR)) q:WorkGroupMachineDR=&#34;&#34;  d
</span></span><span class="line"><span class="cl">	...s OrderNo=&#34;&#34; f  s OrderNo=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo)) q:OrderNo=&#34;&#34;  d
</span></span><span class="line"><span class="cl">	....s ReportDR=&#34;&#34; f  s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR,WorkGroupMachineDR,OrderNo,ReportDR)) q:ReportDR=&#34;&#34;  d
</span></span><span class="line"><span class="cl">	.....s WorkGroupMachineDR=$lg($g(^dbo.RPVisitNumberReportD(ReportDR)),4) 
</span></span><span class="line"><span class="cl">	.....s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)
</span></span><span class="line"><span class="cl">	.....i typename[&#34;上机&#34; try{j ..SaveRecord(labno,positioninfo,mi,&#34;6&#34;)}catch{}
</span></span><span class="line"><span class="cl">	.....i $l(objrep.RackNo),objrep.RackNo&#39;=positioninfo try{j ..SaveRecord(labno,&#34;架子号位置更新:&#34;_objrep.RackNo_&#34;--&gt;&#34;_positioninfo,mi,&#34;101&#34;)}catch{}	//架子号更新
</span></span><span class="line"><span class="cl">	.....s objrep.RackNo=positioninfo
</span></span><span class="line"><span class="cl">	.....s sc=objrep.%Save()
</span></span><span class="line"><span class="cl">	.....s hasFindRep=1
</span></span><span class="line"><span class="cl">	.....i (&#39;$SYSTEM.Status.IsOK(sc)) d
</span></span><span class="line"><span class="cl">	......d Trace^MI.MIF000(mi,&#34;-1^存&#34;_typename_&#34;信息失败:&#34;_$SYSTEM.Status.GetErrorText(sc),&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl">	i hasFindRep=0,$d(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno))) d
</span></span><span class="line"><span class="cl">	.s ReportDR=$o(^dbo.RPVisitNumberReportI(&#34;IndexEpisodeNo&#34;,$zd($h,8),curWorkGroupMachineDR,##Class(LIS.Util.Common).IndexData(labno),&#34;&#34;))
</span></span><span class="line"><span class="cl">	.s objrep=##Class(dbo.RPVisitNumberReport).%OpenId(ReportDR)
</span></span><span class="line"><span class="cl">	.i typename[&#34;上机&#34; try{j ..SaveRecord(labno,positioninfo,mi,&#34;6&#34;)}catch{}
</span></span><span class="line"><span class="cl">	.i $l(objrep.RackNo),objrep.RackNo&#39;=positioninfo try{j ..SaveRecord(labno,&#34;架子号位置更新:&#34;_objrep.RackNo_&#34;--&gt;&#34;_positioninfo,mi,&#34;101&#34;)}catch{}	//架子号更新
</span></span><span class="line"><span class="cl">	.s objrep.RackNo=positioninfo
</span></span><span class="line"><span class="cl">	.s sc=objrep.%Save()
</span></span><span class="line"><span class="cl">	.s hasFindRep=1
</span></span><span class="line"><span class="cl">	i hasFindRep=0 d Trace^MI.MIF000(mi,labno_&#34;:没有找到报告&#34;,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl">	q hasFindRep
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="存储标本图片">存储标本图片
</h3><blockquote>
<p>罗氏流水线有血清标本图片，图片命名格式为条码号_第几个，比如1003783657_01，标本重复上线时会出现多个标本图片的情况，此处抓图将多个图片都抓取，按照P1，P2保存至标本图片表，如果找不到哦啊对应标本，则存入仪器图片表。</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/// 保存标本图片
</span></span><span class="line"><span class="cl">/// D ##class(MI.MIFRS600).SaveImageMTHD(&#34;57&#34;,&#34;1000100990&#34;,&#34;P&#34;,&#34;/iLISLIS080/demo.png&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)
</span></span><span class="line"><span class="cl">/// D ##class(MI.MIFIT3000N1).SaveImageMTHD(&#34;34&#34;,&#34;1003783657_01&#34;,&#34;1003783657_01&#34;,&#34;/iLISLIS032/20250321/1003783657_01.jpg&#34;,&#34;C:\LISDATA\DATA\1003783657_01.jpg&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)
</span></span><span class="line"><span class="cl">ClassMethod SaveImageMTHD(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions, Output RowCount As %String) As %String
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">    s ^YHR(&#34;MI.MIFIT3000&#34;)=$lb(mi, epis, ImageClass, FileName, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, Sessions)
</span></span><span class="line"><span class="cl">	s mi=$g(mi)
</span></span><span class="line"><span class="cl">	s mi=mi
</span></span><span class="line"><span class="cl">	s ret=&#34;1&#34;
</span></span><span class="line"><span class="cl">	s epis=$p(epis,&#34;_&#34;,1)
</span></span><span class="line"><span class="cl">	s ImageClass=&#34;P&#34;_+$p(ImageClass,&#34;_&#34;,2)
</span></span><span class="line"><span class="cl">  	i &#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;
</span></span><span class="line"><span class="cl">  	//标本血清质量特殊处理
</span></span><span class="line"><span class="cl">	i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis))) d 
</span></span><span class="line"><span class="cl">	.s obj=&#34;&#34;
</span></span><span class="line"><span class="cl">	.s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##Class(LIS.Util.Common).IndexData(epis),&#34;&#34;))
</span></span><span class="line"><span class="cl">	.i $d(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass))) d
</span></span><span class="line"><span class="cl">	..s RowID=&#34;&#34; f  s RowID=$o(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),##Class(LIS.Util.Common).IndexData(ImageClass),RowID)) q:RowID=&#34;&#34;  d
</span></span><span class="line"><span class="cl">    ...s obj=##class(dbo.RPVisitNumberImage).%OpenId(RowID)
</span></span><span class="line"><span class="cl">    .i &#39;$l(obj) s obj=##class(dbo.RPVisitNumberImage).%New()
</span></span><span class="line"><span class="cl">    .s obj.VisitNumberDR=VisitNumberDR
</span></span><span class="line"><span class="cl">    .s obj.ImageClass=&#34;SerumQ&#34;
</span></span><span class="line"><span class="cl">    .s obj.ImageID=ImageClass
</span></span><span class="line"><span class="cl">    .s obj.FileName=FileName
</span></span><span class="line"><span class="cl">    .s sc=obj.%Save()
</span></span><span class="line"><span class="cl">	.i (&#39;$SYSTEM.Status.IsOK(sc)) d
</span></span><span class="line"><span class="cl">	..s ret= &#34;-1^保存报告图片失败:&#34;_$SYSTEM.Status.GetErrorText(sc)
</span></span><span class="line"><span class="cl">	e  d
</span></span><span class="line"><span class="cl"> 	.d Trace^MI.MIF000(mi,epis_&#34;:&#34;_ImageClass_&#34;:&#34;_FileName,&#34;H&lt;--M&#34;)
</span></span><span class="line"><span class="cl"> 	.s (ReceiveDate, ImageOrder, Caption, DisplayRatio, Height, Width, Sequence)=&#34;&#34;
</span></span><span class="line"><span class="cl">	.s ret=##Class(MI.Common.MachineResult).SaveImage(ReceiveDate, epis, ImageClass, ImageOrder, FileName, mi, Caption, DisplayRatio, Height, Width, Sequence)
</span></span><span class="line"><span class="cl">	q ret
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>基于此功能附加功能</p>
<h4 id="血清标本显示">血清标本显示
</h4><blockquote>
<p>抓取血清图片后，会有多张图片的情况，将最新的图片显示在最上边</p>
<p>修改方法  &ldquo;LIS.WS.BLL.DHCRPVisitNumberReport&rdquo;,&ldquo;QryReportImage&rdquo;</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">k ^LISVisitNumberImage(&#34;Data&#34;)
</span></span><span class="line"><span class="cl">	//获取条码标本质量图形信息
</span></span><span class="line"><span class="cl">	i $d(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;))) D
</span></span><span class="line"><span class="cl">	.s SERUMID=&#34;&#34;
</span></span><span class="line"><span class="cl">	.f  S SERUMID=$O(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),SERUMID)) q:SERUMID=&#34;&#34;  d 
</span></span><span class="line"><span class="cl">	..S SERUMQRowID=$O(^dbo.RPVisitNumberImageI(&#34;IndexMaster&#34;,VisitNumberDR,##Class(LIS.Util.Common).IndexData(&#34;SerumQ&#34;),SERUMID,&#34;&#34;)) 
</span></span><span class="line"><span class="cl">	..S (FileName,MachineParameterDR,Caption,DisplayRatio,Height,Width,Sequence,ImageClassDesc) = &#34;&#34;
</span></span><span class="line"><span class="cl">	..S StrData=$g(^dbo.RPVisitNumberImageD(SERUMQRowID))
</span></span><span class="line"><span class="cl">	..s RowID=SERUMQRowID
</span></span><span class="line"><span class="cl">	..s ImageClassDesc = $lg(StrData,4)
</span></span><span class="line"><span class="cl">	..s FileName = ftp_$lg(StrData,5)
</span></span><span class="line"><span class="cl">	..s ThumbnailWidth=&#34;&#34;,ThumbnailHeight=&#34;&#34;,ThumbnailDeg=&#34;&#34;
</span></span><span class="line"><span class="cl">	..s Caption = &#34;SerumQ&#34;
</span></span><span class="line"><span class="cl">	..s IsImageRes=&#34;&#34;
</span></span><span class="line"><span class="cl">	..s IsExistImgRes=&#34;&#34;
</span></span><span class="line"><span class="cl">	..s Time=$p($h,&#34;,&#34;,2)
</span></span><span class="line"><span class="cl">    ..s FileName=FileName //_&#34;?Version=&#34;_Time //解决图片缓存问题
</span></span><span class="line"><span class="cl">    ..Set Data=$lb(ImageClassDesc,ImageOrder,FileName,MachineParameterDR,Caption,DisplayRatio,Height,Width,Sequence,RowID,IsImageRes,ThumbnailWidth,ThumbnailHeight,ThumbnailDeg)
</span></span><span class="line"><span class="cl">	..s ^LISVisitNumberImage(&#34;Data&#34;,ImageClassDesc)=Data
</span></span><span class="line"><span class="cl">	..;d OutputRow
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	/*----------&gt;设置血清标本只显示最新的开始&lt;----------*/
</span></span><span class="line"><span class="cl">	i $d(^LISVisitNumberImage(&#34;Data&#34;)) d
</span></span><span class="line"><span class="cl">	.s ImageClassDesc=$o(^LISVisitNumberImage(&#34;Data&#34;,&#34;&#34;),-1)
</span></span><span class="line"><span class="cl">	.s Data=$g(^LISVisitNumberImage(&#34;Data&#34;,ImageClassDesc))
</span></span><span class="line"><span class="cl">	.s Caption=$lg(Data,5)
</span></span><span class="line"><span class="cl">	.s ImageClassDescNext=$o(^LISVisitNumberImage(&#34;Data&#34;,ImageClassDesc),-1)
</span></span><span class="line"><span class="cl">	.i $l(ImageClassDescNext) s $li(Data,5)=Caption_&#34;-&#34;_ImageClassDesc
</span></span><span class="line"><span class="cl">	.i &#39;$l(Sequence) s Sequence=999
</span></span><span class="line"><span class="cl">    .i &#39;$l(RowID) q
</span></span><span class="line"><span class="cl"> 	.s ^TMP($zn,repid,$j,Sequence,RowID)=Data
</span></span><span class="line"><span class="cl">	k ^LISVisitNumberImage(&#34;Data&#34;)
</span></span><span class="line"><span class="cl">	/*----------&gt;设置血清标本只显示最新的结束&lt;----------*/
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="特殊处理记录">特殊处理记录
</h2><blockquote>
<p>本节点为该仪器接口特殊处理的部分，可以参考实际修改使用</p></blockquote>
<h3 id="监听配置有多条监听配置">监听配置，有多条监听配置
</h3><blockquote>
<p>主监听配置会获取仪器主键，其他的无法获取只能写死，主键有根据项目实际情况修改</p></blockquote>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403110412-5w6g58q.png"
	width="1809"
	height="362"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403110412-5w6g58q_hu_9c772cc0d177b69d.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403110412-5w6g58q_hu_38826cff9d7148a3.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="499"
		data-flex-basis="1199px"
	
></p>
<h3 id="自动核收调用核收方法按照工作小组主键入参">自动核收调用核收方法，按照工作小组主键入参。
</h3><p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403122315-99avnab.png"
	width="1536"
	height="703"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403122315-99avnab_hu_e7133bcc3789217b.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403122315-99avnab_hu_1a9cfc0ac464633c.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="218"
		data-flex-basis="524px"
	
></p>
<h3 id="自动核收前处理">自动核收前处理
</h3><blockquote>
<p>由于自动核收功能包括罗氏本流水线自动核收，同时还带有分拣功能，对于免疫标本和临检标本分区和自动核收。本部分为特殊处理部分。</p>
<p>本部分分为两块，一块为接收时上传维护，此部分与科室进行核对维护，另一部分为接收分区标识，根据仪器分区进行核收。（注：未通过检验自己维护的项目分区进行核收，一部分是减少调用增加处理速度，另一部分是根据仪器分区，方便科室对应分区找到对应工作小组的标本。）</p></blockquote>
<p>1.生化的标本都会立马拔盖上机去做，对于其他的标本，比如免疫和临检的标本，涉及到是否拔盖和分区的逻辑。仪器分别该标本类型，则需要通过检验上传对应条码的相关信息，因此，在流水线工作组中，对应医嘱维护不同的检测项目，在接收的时候就会获取流水线的医嘱对应的项目，在上传通道号维护对应的标识。</p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403131800-gu6cnty.png"
	width="1136"
	height="560"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403131800-gu6cnty_hu_213ccbb470f9524f.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403131800-gu6cnty_hu_c22be9f53cb8fcb7.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="202"
		data-flex-basis="486px"
	
></p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403131655-vuxmirk.png"
	width="1631"
	height="804"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403131655-vuxmirk_hu_a9fdbd6542a5936c.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403131655-vuxmirk_hu_f2521d66c86daf6e.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="202"
		data-flex-basis="486px"
	
></p>
<p>2.标本上机仪器回传分区标识进行自动核收</p>
<blockquote>
<p>优先判断是否已接收未核收，如果已经核收则直接退出。</p>
<p>根据前处理标本分区标识进行自动核收（此标识跟仪器进行核对不同的分区标识），通过不同的标识获取对应的工作小组，或者BHS_标识只记录分区不进行核收。核收失败进行弹窗提示。</p>
<p>记录自动核收操作日志。</p></blockquote>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250404111639-mxg1ep2.png"
	width="1552"
	height="242"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250404111639-mxg1ep2_hu_1d4c001920f9570.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250404111639-mxg1ep2_hu_c208f72c68e02b4b.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="641"
		data-flex-basis="1539px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/// 仪器主键，条码号，前处理标本分区标识，仪器信息(位置)
</span></span><span class="line"><span class="cl">/// w ##class(MI.MIFIT3000N1).ZDHS(&#34;34&#34;,&#34;8000000352&#34;,&#34;WANTAI&#34;)
</span></span><span class="line"><span class="cl">/// w ##class(MI.MIFIT300N).ZDHS(&#34;34&#34;,&#34;1003779663&#34;,&#34;RSA1&#34;)
</span></span><span class="line"><span class="cl">ClassMethod ZDHS(mi, Labno, MachineCode, positioninfo)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl"> 	s mi=$g(mi),Labno=$g(Labno),machCode=$g(MachineCode),positioninfo=$g(positioninfo)
</span></span><span class="line"><span class="cl"> 	i &#39;$l(Labno) q &#34;&#34;
</span></span><span class="line"><span class="cl"> 	/*----------&gt;判断该标本是否已接收未核收 开始&lt;----------*/
</span></span><span class="line"><span class="cl"> 	s QuitFlag=0
</span></span><span class="line"><span class="cl"> 	i $d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##class(LIS.Util.Common).IndexData(Labno))) d
</span></span><span class="line"><span class="cl"> 	.s VisitNumberDR=$o(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,##class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))
</span></span><span class="line"><span class="cl"> 	.i $d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) s QuitFlag=1
</span></span><span class="line"><span class="cl"> 	i QuitFlag=1 q &#34;&#34;
</span></span><span class="line"><span class="cl"> 	/*----------&gt;判断该标本是否已接收未核收 结束&lt;----------*/
</span></span><span class="line"><span class="cl"> 	s curWorkGroupMachineDR=$lg($g(^dbo.BTMIMachineParameterD(mi)),6)	//得到当前仪器关联工作小组信息
</span></span><span class="line"><span class="cl"> 	s CurWorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR),4)
</span></span><span class="line"><span class="cl"> 	s curMachName=$lg($g(^dbo.BTMIMachineParameterD(mi)),5)
</span></span><span class="line"><span class="cl"> 	s AcceptFlag=$lg($g(^dbo.BTWorkGroupMachineD(curWorkGroupMachineDR)),13)	//得到仪器工作小组的核收类型
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 	//AcceptFlag为1认为是前处理工作小组，如果是前处理小组，就认为上前处理	本接口未设置前处理工作小组，未对此流程进行测试
</span></span><span class="line"><span class="cl"> 	i AcceptFlag=&#34;1&#34;  d QCLZDHS
</span></span><span class="line"><span class="cl"> 	e  d ZDHS
</span></span><span class="line"><span class="cl"> 	q &#34;&#34;
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">ZDHS
</span></span><span class="line"><span class="cl">	d Trace^MI.MIF000(mi,&#34;上仪器,标本号:&#34;_Labno_&#34;的标本在:&#34;_curMachName_&#34;,分区位置:&#34;_MachineCode_&#34;,样本所在:&#34;_positioninfo,&#34;自动核收&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	//根据前处理标本分区进行分区自动核收，并且根据分区代码是否核收进行区分
</span></span><span class="line"><span class="cl">	//本接口认为 默认认为罗氏流水线核收，如果分区代码中包含 【BHS】则认为标本不核收，此块代码将仪器传过来的分区代码进行归类
</span></span><span class="line"><span class="cl">	//本接口关联标本分区， WANTAI 万泰--&gt;W，XINCHANYE 新产业--&gt;X，LINJIAN 临检凝血--&gt;L，XIEGUANG 携光--&gt;R，罗氏--&gt;Y，不核收--&gt;N
</span></span><span class="line"><span class="cl"> 	s HsFlag=&#34;Y&#34;,WorkGroupMachineDR=&#34;&#34;
</span></span><span class="line"><span class="cl"> 	i (MachineCode[&#34;WANTAI&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d
</span></span><span class="line"><span class="cl"> 	.S MachineCode=$REPLACE(MachineCode,&#34;WANTAI&#34;,&#34;&#34;)
</span></span><span class="line"><span class="cl"> 	.s HsFlag=&#34;W&#34;
</span></span><span class="line"><span class="cl"> 	.s WorkGroupMachineDR=48	//未核收且分区是WANTAI
</span></span><span class="line"><span class="cl"> 	i (MachineCode[&#34;XINCHANYE&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d
</span></span><span class="line"><span class="cl"> 	.S MachineCode=$REPLACE(MachineCode,&#34;XINCHANYE&#34;,&#34;&#34;)
</span></span><span class="line"><span class="cl"> 	.s HsFlag=&#34;X&#34;
</span></span><span class="line"><span class="cl"> 	.s WorkGroupMachineDR=50	//未核收且分区是XINCHANYE
</span></span><span class="line"><span class="cl"> 	i (MachineCode[&#34;LINJIAN&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d
</span></span><span class="line"><span class="cl"> 	.S MachineCode=$REPLACE(MachineCode,&#34;LINJIAN&#34;,&#34;&#34;)
</span></span><span class="line"><span class="cl"> 	.s HsFlag=&#34;L&#34;
</span></span><span class="line"><span class="cl"> 	.s WorkGroupMachineDR=9		//未核收且分区是LINJIAN
</span></span><span class="line"><span class="cl"> 	i (MachineCode[&#34;XIEGUANG&#34;)&amp;&amp;(MachineCode&#39;[&#34;BHS&#34;) d
</span></span><span class="line"><span class="cl"> 	.S MachineCode=$REPLACE(MachineCode,&#34;XIEGUANG&#34;,&#34;&#34;)
</span></span><span class="line"><span class="cl"> 	.s HsFlag=&#34;R&#34;
</span></span><span class="line"><span class="cl"> 	.s WorkGroupMachineDR=67	//未核收且分区是XIEGUANG
</span></span><span class="line"><span class="cl"> 	i (MachineCode[&#34;BHS_&#34;) d	;BHS_WANTAI
</span></span><span class="line"><span class="cl"> 	.S MachineCode=$REPLACE(MachineCode,&#34;BHS_&#34;,&#34;&#34;)
</span></span><span class="line"><span class="cl"> 	.s HsFlag=&#34;N&#34;
</span></span><span class="line"><span class="cl"> 	i MachineCode=&#34;C_C8K886&#34; s MachineCode=&#34;C801&#34;
</span></span><span class="line"><span class="cl"> 	i MachineCode=&#34;C_C8K77&#34; s MachineCode=&#34;C701&#34;
</span></span><span class="line"><span class="cl"> 	i MachineCode=&#34;C8K886&#34; s MachineCode=&#34;C801&#34;
</span></span><span class="line"><span class="cl"> 	i MachineCode=&#34;C8K77&#34; s MachineCode=&#34;C701&#34;
</span></span><span class="line"><span class="cl"> 	i HsFlag=&#34;Y&#34; d
</span></span><span class="line"><span class="cl"> 	.s WorkGroupMachineDR=41	//未核收且分区不包含BHS_	默认核收到罗氏流水线
</span></span><span class="line"><span class="cl"> 	i &#39;$l(WorkGroupMachineDR) q
</span></span><span class="line"><span class="cl"> 	s ret=..ReceiveLabNoByWGM(WorkGroupMachineDR,Labno,$zd(+$h,8))
</span></span><span class="line"><span class="cl"> 	s WorkGroupDR=$lg(^dbo.BTWorkGroupMachineD(WorkGroupMachineDR),4)
</span></span><span class="line"><span class="cl"> 	i ret&#39;=&#34;1&#34; d
</span></span><span class="line"><span class="cl"> 	.s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    .s perUser = &#34;WG-&#34;_WorkGroupDR		//自动核收出错显示再对应的工作组
</span></span><span class="line"><span class="cl">    .s SendRet=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收失败&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_Labno_&#34;前处理核收失败:&#34;_ret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser)
</span></span><span class="line"><span class="cl"> 	j ..SaveRecord(Labno,&#34;自动核收:&#34;_ret,&#34;&#34;,&#34;14&#34;,WorkGroupMachineDR)
</span></span><span class="line"><span class="cl">	q ret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">QCLZDHS
</span></span><span class="line"><span class="cl">	d Trace^MI.MIF000(mi,&#34;上前处理，鉴定号:&#34;_Labno_&#34;的标本在:&#34;_curMachName_&#34;,样本所在:&#34;_positioninfo,&#34;DealInfo&#34;)
</span></span><span class="line"><span class="cl"> 	d Trace^MI.MIF000(mi,&#34;执行核收到前处理&#34;,&#34;DealInfo&#34;)
</span></span><span class="line"><span class="cl"> 	//此处核收医嘱导前处理工作小组，不生成项目，写标本操作日志
</span></span><span class="line"><span class="cl"> 	s dealret=##Class(LIS.Common.DHCVisitNumber).PreDealLabNo(mi,Labno,&#34;&#34;) 
</span></span><span class="line"><span class="cl"> 	d Trace^MI.MIF000(mi,Labno_&#34;核收到前处理返回信息:&#34;_dealret,&#34;DealInfo&#34;)
</span></span><span class="line"><span class="cl"> 	//记录位置信息到报告位置号
</span></span><span class="line"><span class="cl"> 	d ..SaveRackNo(Labno,positioninfo,mi)
</span></span><span class="line"><span class="cl"> 	i dealret[&#34;标本已核收&#34; q 
</span></span><span class="line"><span class="cl"> 	i dealret=&#34;1&#34; d
</span></span><span class="line"><span class="cl"> 	.//写标本操作日志
</span></span><span class="line"><span class="cl"> 	.d ..SaveRecord(Labno,machCode,mi,&#34;5&#34;)
</span></span><span class="line"><span class="cl"> 	e  d
</span></span><span class="line"><span class="cl"> 	.s retObj=##Class(wbsLisMsgAsyncHandler.LISMsg.wbsLisMsgAsyncHandlerSoap).%New()
</span></span><span class="line"><span class="cl">    .s perUser = &#34;WG-&#34;_CurWorkGroupDR
</span></span><span class="line"><span class="cl">    .s ret=retObj.SendMsg(&#34;dhcc&#34;,&#34;{ &#34;&#34;type&#34;&#34;: &#34;&#34;自动核收失败&#34;&#34;, &#34;&#34;info&#34;&#34;: &#34;&#34;&#34;_Labno_&#34;前处理核收失败:&#34;_dealret_&#34;,仪器【&#34;_curMachName_&#34;】！&#34;_&#34;&#34;&#34;, &#34;&#34;dealurl&#34;&#34;: &#34;&#34;&#34;&#34; }&#34;, &#34;Crisis&#34;, perUser)
</span></span><span class="line"><span class="cl"> 	.//写标本操作日志
</span></span><span class="line"><span class="cl"> 	.d ..SaveRecord(Labno,dealret,mi,&#34;100&#34;)
</span></span><span class="line"><span class="cl"> 	q
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="特殊结果的转换">特殊结果的转换
</h3><blockquote>
<p>仪器某些结果需要进行转换，固定的大部分都可以通过仪器维护对应项目的系数进行转换，但是对于包含&gt;&lt;的无法进行转换，因此需要在接口里进行特殊处理。</p>
<p>！！！注：系数为除法</p></blockquote>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403134031-z71pfe6.png"
	width="1133"
	height="563"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403134031-z71pfe6_hu_64b19620633ed0da.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403134031-z71pfe6_hu_4e8293567d5216b5.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="201"
		data-flex-basis="482px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/// 结果特殊转换
</span></span><span class="line"><span class="cl">/// $TS$
</span></span><span class="line"><span class="cl">/// W ##CLASS(MI.MIFIT3000N1).ConvertResult(&#34;9PA&#34;,&#34;&lt;0.070&#34;)
</span></span><span class="line"><span class="cl">ClassMethod ConvertResult(code, res)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	i code=&#34;9PA&#34; d
</span></span><span class="line"><span class="cl">	.i $e(res)=&#34;&lt;&#34;,+$e(res,2,*)=&#34;.07&#34; d
</span></span><span class="line"><span class="cl">	..s res=&#34;&lt;70&#34;
</span></span><span class="line"><span class="cl">	q res
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="报警信息转换">报警信息转换
</h3><blockquote>
<p>本接口未使用报警信息转换，仪器传过来的报警信息就是转换后的报警信息，此处只是作为记录。</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/// 报警信息转换
</span></span><span class="line"><span class="cl">ClassMethod ConvertPoliceInfo(WaringCode)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	s WaringStr=&#34;&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;5&#34; s WaringStr=&#34;&gt;ABS(超出ABS)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;43&#34; s WaringStr=&#34;Cal.E(校准结果异常)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;2&#34; s WaringStr=&#34;&gt;Cuvet(反应杯空白异常)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;42&#34; s WaringStr=&#34;Edit(实验结果已被编辑)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;23&#34; s WaringStr=&#34;&gt;ISE(超出ISE范围)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;19&#34; s WaringStr=&#34;ISE.E(ISE电压级错误)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;56&#34; s WaringStr=&#34;&gt;Kin(Prozone错误2/运动不稳)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;10&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;11&#34; s WaringStr=&#34;&gt;Lin(线性异常)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;6&#34; s WaringStr=&#34;&gt;Prozone(Prozone错误1)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;4&#34; s WaringStr=&#34;Reag.S(试剂不足)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;44&#34; s WaringStr=&#34;&gt;Rept(高出原倍复查范围)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;45&#34; s WaringStr=&#34;&lt;Rept(低于原倍复查范围)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;46&#34; s WaringStr=&#34;Samp.？(高出ABS最大值)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;68&#34; s WaringStr=&#34;Samp.B(样本中有气泡)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;72&#34; s WaringStr=&#34;Samp.C(样本中有凝块)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;26&#34; s WaringStr=&#34;&gt;Test(高出线性范围)&#34;
</span></span><span class="line"><span class="cl"> 	i WaringCode=&#34;27&#34; s WaringStr=&#34;&lt;Test(低于线性范围)&#34;
</span></span><span class="line"><span class="cl"> 	q WaringStr
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="新增标本操作日志记录类型">新增标本操作日志记录类型
</h3><blockquote>
<p>新增两个操作类型</p>
<p>100	前处理分区<br>
101	架子号更新</p></blockquote>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403134842-7jog3lr.png"
	width="919"
	height="548"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403134842-7jog3lr_hu_b68f66842f8fa37a.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403134842-7jog3lr_hu_63c23b15c85ea7e4.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="167"
		data-flex-basis="402px"
	
></p>
<h3 id="主动上传特殊处理">主动上传特殊处理
</h3><blockquote>
<p>包含申请项目上传，复查项目上传，回退项目上传和审核项目上传</p>
<p>申请状态为C，复查状态为U，回退状态为R，审核状态为T</p>
<p>申请状态和审核状态进行分批上传，分别同时超过10个就先输出这10个，再次查询时再进行新的查询</p>
<p>申请为重新获取项目，避免漏项目，如果要提升速度，则修改为获取上传表通道号，复查为获取上传表通道号(跟踪后发现也为发送全部为空的数据，并不是只复查需要复查的项目)，回退项目为获取标本对应医嘱所关联的工作小组布局和组合套布局（要求输入全部的项目才能完全删除仪器不做的项目，只传部分的话只删除上传的项目），审核上传为固定的通道项目</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Creator</span><span class="err">：</span>      <span class="err">查询患者信息，监听配置上传前处理类后会定时调用这个</span><span class="n">query查询数据进行上传操作</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">CreatDate</span><span class="err">：</span>    <span class="mi">20140919</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Description</span><span class="p">:</span><span class="err">：</span> 
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Table</span><span class="err">：</span>      
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="ne">Input</span><span class="err">：</span>        <span class="n">mi</span><span class="err">：仪器主键</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Output</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Return</span><span class="err">：</span>       <span class="err">仪器信息</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Others</span><span class="err">：</span>     
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">QryLabInfo</span><span class="p">(</span><span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Query</span><span class="p">(</span><span class="n">ROWSPEC</span> <span class="o">=</span> <span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">Query的执行方法</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(%ResultSet).RunQuery(&#34;MI.MIFIT3000N1&#34;,&#34;QryLabInfo&#34;,&#34;34&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoExecute</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">mi</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">P6</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">P8</span><span class="p">,</span> <span class="n">P9</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">P11</span><span class="p">,</span> <span class="n">P12</span><span class="p">,</span> <span class="n">P13</span><span class="p">,</span> <span class="n">Sessions</span><span class="p">,</span> <span class="n">Output</span> <span class="n">RowCount</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">i</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">mi</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">mi</span><span class="p">),</span><span class="n">flag</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="s1">&#39;$d(^dbo.BTMIMachineParameterD(mi)) q &#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">LabnoList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">OutPutNum</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="o">//*--------------------------------&gt;*</span><span class="err">申请项目</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate)) q:(AddDate=&#34;&#34;)||(OutPutNum&gt;6)  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime)) q:(AddTime=&#34;&#34;)||(OutPutNum&gt;6)  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">OutPutNum</span><span class="o">=</span><span class="n">OutPutNum</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;C&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">EpisNo</span><span class="o">=$$</span><span class="n">getEpis</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">labno</span><span class="p">,</span><span class="n">mi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">i</span> <span class="s1">&#39;$l(EpisNo) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberI(&#34;IndexVisitNumber&#34;,labno)) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">ReceiveTime</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">)),</span><span class="mi">67</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="p">((</span><span class="o">+$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ReceiveTime</span><span class="o">&gt;=-</span><span class="mi">2</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">((</span><span class="o">+$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ReceiveTime</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno_</span><span class="s2">&#34;标本接收时间低于5秒不上传&#34;</span><span class="p">,</span><span class="s2">&#34;等待上传&#34;</span><span class="p">)</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=..</span><span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;@C&#34;</span>		<span class="o">//</span><span class="err">重新获取通道号</span> <span class="err">避免因为接收造成漏项目</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">GetLabnoInfoDelete</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">replace</span><span class="p">(</span><span class="n">TCList</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,&#34;</span><span class="o">+</span><span class="s2">&#34;)_&#34;</span><span class="o">|</span><span class="err">@</span><span class="sa">U</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;申请上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">try</span><span class="p">{</span><span class="n">d</span> <span class="c1">##class(MI.Special.Record).RecordData(labno,&#34;C@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}	//YHR 20230828 记录十天的数据</span>
</span></span><span class="line"><span class="cl">    <span class="o">//*--------------------------------&gt;*</span><span class="err">复查结果上传</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;U&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$d(^dbo.RPVisitNumberReportI(&#34;IndexReportID&#34;,VisitNumberDR)) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">replace</span><span class="p">(</span><span class="n">TCList</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,&#34;</span><span class="o">+</span><span class="s2">&#34;)_&#34;</span><span class="o">|</span><span class="err">@</span><span class="sa">U</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;复查上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">try</span><span class="p">{</span><span class="n">d</span> <span class="c1">##class(MI.Special.Record).RecordData(labno,&#34;U@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}	//YHR 20230828 记录十天的数据</span>
</span></span><span class="line"><span class="cl">    <span class="o">//*--------------------------------&gt;*</span><span class="err">取消项目</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate)) q:AddDate=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime)) q:AddTime=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;R&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="p">;</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=..</span><span class="n">GetLabnoInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span><span class="n">_</span><span class="s2">&#34;@R&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=..</span><span class="n">GetLabnoInfoDelete</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="o">$</span><span class="n">replace</span><span class="p">(</span><span class="n">TCList</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\&#34;</span><span class="s2">,&#34;</span><span class="o">+</span><span class="s2">&#34;)_&#34;</span><span class="err">@</span><span class="sa">R</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;取消上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">try</span><span class="p">{</span><span class="n">d</span> <span class="c1">##class(MI.Special.Record).RecordData(labno,&#34;R@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}	//YHR 20230828 记录十天的数据</span>
</span></span><span class="line"><span class="cl">	<span class="o">//*--------------------------------&gt;*</span><span class="err">审核项目</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">OutPutNum</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddDate</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate)) q:(AddDate=&#34;&#34;)||(OutPutNum&gt;10)  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">AddTime</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">AddTime</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate,AddTime)) q:(AddTime=&#34;&#34;)||(OutPutNum&gt;10)  d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">OutPutNum</span><span class="o">=</span><span class="n">OutPutNum</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">MiUploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(&#34;T&#34;),AddDate,AddTime,&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labno</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(labno) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">labno</span><span class="p">)</span> <span class="n">S</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">labno</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(VisitNumberDR) q</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">得到通道号</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">MiUploadDR</span><span class="p">)),</span><span class="mi">7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">patInfo</span><span class="o">=..</span><span class="n">GetPatInfo</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">PatName</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">patInfo</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..//</span><span class="err">控制输出文本的内容</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">labnoInfo</span><span class="o">=</span><span class="n">labno_</span><span class="s2">&#34;,&#34;</span><span class="n">_</span><span class="s2">&#34;DM_OVER&#34;</span><span class="n">_</span><span class="s2">&#34;@C&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">txtInfo</span><span class="o">=..</span><span class="n">GetLabnoInfoN</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">labnoInfo</span><span class="p">,</span><span class="n">patInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">now</span><span class="o">=$</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filenametime</span><span class="o">=$</span><span class="n">zd</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zt</span><span class="p">(</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&#34;:&#34;</span><span class="p">)</span><span class="n">_</span><span class="o">$</span><span class="n">p</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenametime_</span><span class="s2">&#34;_&#34;</span><span class="n">_labno_</span><span class="s2">&#34;.hl7&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">Data</span><span class="o">=</span><span class="c1">##class(MI.Common.MIFBase).DemoMOutFileInfo(filename,txtInfo,labno,1,&#34;&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">Trace</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span><span class="n">txtInfo</span><span class="p">,</span><span class="s2">&#34;审核上传信息&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">d</span> <span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">try</span><span class="p">{</span><span class="n">d</span> <span class="c1">##class(MI.Special.Record).RecordData(labno,&#34;T@&#34;_##Class(LIS.Util.Common).GetClientIP()_txtInfo,&#34;LSLSXPUT&#34;,1,1,10)}catch{}	//YHR 20230828 记录十天的数据</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">OutputRow</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ColFields</span><span class="o">=</span><span class="s2">&#34;labno,labnoInfo,patInfo&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span><span class="o">=</span><span class="c1">##Class(LIS.Util.Common).TransListNull(Data,ColFields)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">quit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoClose</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Kill</span> <span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">QryLabInfoFetch</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">qHandle</span> <span class="n">As</span> <span class="o">%</span><span class="n">Binary</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">Row</span> <span class="n">As</span> <span class="o">%</span><span class="n">List</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">AtEnd</span> <span class="n">As</span> <span class="o">%</span><span class="n">Integer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="n">Status</span> <span class="p">[</span> <span class="n">PlaceAfter</span> <span class="o">=</span> <span class="n">QryLabInfoExecute</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">repid</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">LIST</span><span class="p">(</span><span class="n">qHandle</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span> <span class="n">ind</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">If</span> <span class="n">ind</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">AtEnd</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Else</span>      <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Set</span> <span class="n">Row</span><span class="o">=^</span><span class="n">CacheTemp</span><span class="p">(</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="n">qHandle</span><span class="o">=$</span><span class="n">lb</span><span class="p">(</span><span class="n">AtEnd</span><span class="p">,</span><span class="n">repid</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">Quit</span> <span class="o">$$$</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>基于此的特殊处理操作</p>
<h4 id="回退和审核更新状态">回退和审核更新状态
</h4><blockquote>
<p>基于复查更新状态进行功能扩展 原方法为<code>d ##class(LIS.WS.BLL.DHCMachineUploadManage).UploadByWGM(&quot;8000000413&quot;,&quot;&quot;,&quot;41&quot;,&quot;U&quot;)</code>​</p>
<p>回退时设置状态为R，上传通道号为END（接收时如果上传表中有数据，则不进行重新上传，避免接收和核收重复上传，基于此过滤判断通道号为END，通道号为END时则重新进行上传。）</p>
<p>审核时设置通道号为DM_OVER</p></blockquote>
<p>拒收调用方法位置  LISSP.DHCRPVisitNumber&ndash;RejectVisitNumber</p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403204616-7tyk5n5.png"
	width="1664"
	height="626"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403204616-7tyk5n5_hu_fbb235d54f43ee4b.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403204616-7tyk5n5_hu_b584ee045001300a.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="265"
		data-flex-basis="637px"
	
></p>
<p>审核和复审时调用方法位置  LISSP.DHCRPVisitNumberReport&ndash;SaveResult</p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403204752-61tazzl.png"
	width="1641"
	height="722"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403204752-61tazzl_hu_b94591dfd72efc03.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403204752-61tazzl_hu_11360a75977b8b4c.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="227"
		data-flex-basis="545px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">///</span> <span class="err">按小组重置上传列表</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(MI.MIFIT3000N1).UploadByWGM(&#34;8000000413&#34;,&#34;&#34;,&#34;41&#34;,&#34;R&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(MI.MIFIT3000N1).UploadByWGM(&#34;8000000413&#34;,&#34;&#34;,41,&#34;T&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="o">///</span> <span class="n">d</span> <span class="c1">##class(MI.MIFIT3000N1).UploadByWGM(&#34;8000000413&#34;,&#34;&#34;,41,&#34;U&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ClassMethod</span> <span class="n">UploadByWGM</span><span class="p">(</span><span class="n">Labno</span><span class="p">,</span> <span class="n">TestSetDR</span><span class="p">,</span> <span class="n">WorkGroupMachineDR</span><span class="p">,</span> <span class="n">SendStatus</span><span class="p">)</span> <span class="n">As</span> <span class="o">%</span><span class="ne">String</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">Labno</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">Labno</span><span class="p">),</span><span class="n">TestSetDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">TestSetDR</span><span class="p">),</span><span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(Labno) q 100</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="s1">&#39;$l(TestSetDR),&#39;</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="n">SendStatus</span><span class="s1">&#39;=&#34;R&#34; q 100 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;R&#34;</span><span class="p">,</span><span class="s1">&#39;$d(^dbo.RPMachineUploadI(&#34;IndexVisitNumber&#34;,Labno)) q</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;R&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">MachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">Labno</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">		<span class="o">.</span><span class="n">s</span> <span class="n">UploadDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">UploadDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="n">Labno</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">UploadDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">UploadDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">		<span class="o">..</span><span class="n">S</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%OpenId(UploadDR)</span>
</span></span><span class="line"><span class="cl">		<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">MachineParameterDR</span><span class="o">=</span><span class="n">MachineDR</span>
</span></span><span class="line"><span class="cl">		<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">VisitNumber</span><span class="o">=</span><span class="n">Labno</span>
</span></span><span class="line"><span class="cl">		<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="o">=</span><span class="n">SendStatus</span>
</span></span><span class="line"><span class="cl">		<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddTime</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">..</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">TCList</span><span class="o">=</span><span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="o">..</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">ReplaceWGMDRData</span><span class="o">=</span><span class="s2">&#34;3,41&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">QuitFlag</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReplaceWGMDRData</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="n">q</span><span class="p">:</span><span class="n">QuitFlag</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">		<span class="o">.</span><span class="n">i</span> <span class="n">WorkGroupMachineDR</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">ReplaceWGMDRData</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		<span class="o">..</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;96&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="o">..</span><span class="n">s</span> <span class="n">QuitFlag</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">i</span> <span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;T&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">ReplaceWGMDRData</span><span class="o">=</span><span class="s2">&#34;1,3,41&#34;</span>		<span class="o">//</span><span class="err">屏蔽所有，这里维护所有可以上传的工作小组</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">WorkGroupMachineDRBAK</span><span class="o">=</span><span class="n">WorkGroupMachineDR</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">QuitFlag</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">ReplaceWGMDRData</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="n">q</span><span class="p">:</span><span class="n">QuitFlag</span><span class="o">=</span><span class="s2">&#34;1&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">			<span class="o">.</span><span class="n">i</span> <span class="n">WorkGroupMachineDRBAK</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">ReplaceWGMDRData</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">			<span class="o">..</span><span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;96&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="o">..</span><span class="n">s</span> <span class="n">QuitFlag</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="n">WorkGroupMachineDR</span><span class="o">=</span><span class="s2">&#34;96&#34;</span>	<span class="o">//</span><span class="err">所有的审核都发送归档标志</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">SendStatus</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="n">SendStatus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">		<span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">		<span class="o">.</span><span class="n">D</span> <span class="n">UploadTC</span> 
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">UploadTC</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">CommDirection</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTWorkGroupMachineD</span><span class="p">(</span><span class="n">WorkGroupMachineDR</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">i</span> <span class="n">CommDirection</span><span class="s1">&#39;=&#34;UP&#34;,CommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">q</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span> 
</span></span><span class="line"><span class="cl">	<span class="n">f</span>  <span class="n">s</span> <span class="n">MachineDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterI</span><span class="p">(</span><span class="s2">&#34;IndexWorkGroupMachine&#34;</span><span class="p">,</span><span class="n">WorkGroupMachineDR</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">MachineDR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">miCommDirection</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">BTMIMachineParameterD</span><span class="p">(</span><span class="n">MachineDR</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">miCommDirection</span><span class="s1">&#39;=&#34;UP&#34;,miCommDirection&#39;</span><span class="o">=</span><span class="s2">&#34;LS&#34;</span> <span class="n">q</span> 
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">d</span> <span class="n">ScanOne</span><span class="o">^</span><span class="n">MI</span><span class="o">.</span><span class="n">MIF000</span><span class="p">(</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">Labno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">chl</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">TMP</span><span class="p">(</span><span class="s2">&#34;MIFTESTCODE&#34;</span><span class="p">,</span><span class="o">$</span><span class="n">j</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="n">Labno</span><span class="p">,</span><span class="n">chl</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">chl</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">   	<span class="o">..</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=</span><span class="n">TCList_chl_</span><span class="s2">&#34;</span><span class="se">\&#34;</span>
</span></span><span class="line"><span class="cl">   	<span class="o">.</span><span class="n">s</span> <span class="n">TCList</span><span class="o">=$</span><span class="n">e</span><span class="p">(</span><span class="n">TCList</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">TCList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="s1">&#39;$l(TCList),SendStatus&#39;</span><span class="o">=</span><span class="s2">&#34;T&#34;</span> <span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">Labno_</span><span class="s2">&#34;没有上传项目&#34;</span> <span class="n">q</span>  
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">s</span> <span class="n">RowID</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">d</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexMaster&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(Labno))) S RowID=$O(^dbo.RPMachineUploadI(&#34;IndexMaster&#34;,MachineDR,##Class(LIS.Util.Common).IndexData(Labno),&#34;&#34;))  //q</span>
</span></span><span class="line"><span class="cl">  	<span class="o">.</span><span class="n">I</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">RowID</span><span class="p">)</span> <span class="n">S</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%OpenId(RowID)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">E</span>  <span class="n">s</span> <span class="n">obj</span><span class="o">=</span><span class="c1">##class(dbo.RPMachineUpload).%New()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.//</span><span class="n">i</span> <span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="p">),</span><span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="s1">&#39;=&#34;C&#34;  Q //已读取标本不再上传</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">MachineParameterDR</span><span class="o">=</span><span class="n">MachineDR</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">VisitNumber</span><span class="o">=</span><span class="n">Labno</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">SendStatus</span><span class="p">)</span> <span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">SendStatus</span><span class="o">=</span><span class="n">SendStatus</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddDate</span><span class="o">=$</span><span class="n">tr</span><span class="p">(</span><span class="o">$</span><span class="n">zd</span><span class="p">(</span><span class="o">+$</span><span class="n">h</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">AddTime</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="o">$</span><span class="n">h</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">i</span> <span class="n">SendStatus</span><span class="o">=</span><span class="s2">&#34;T&#34;</span> <span class="n">s</span> <span class="n">TCList</span><span class="o">=</span><span class="s2">&#34;DM_OVER&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">obj</span><span class="o">.</span><span class="n">TCList</span><span class="o">=</span><span class="n">TCList</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">s</span> <span class="n">ret</span><span class="o">=</span><span class="n">obj</span><span class="o">.%</span><span class="n">Save</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="标本上传处理修改显示">标本上传处理修改显示
</h4><blockquote>
<p>由于仪器和实际工作的工作小组不在一个位置，造成如果为上传成功时，重新上传查询不到标本，修改页面查询query逻辑  &ldquo;LIS.WS.BLL.DHCMachineUploadManage&rdquo;,&ldquo;QrySampleStatus&rdquo;,</p></blockquote>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403205253-vodgc0i.png"
	width="1672"
	height="687"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403205253-vodgc0i_hu_6940d30a3d5261a7.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403205253-vodgc0i_hu_c231a2b79f204c55.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="243"
		data-flex-basis="584px"
	
></p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403205331-yabuxpp.png"
	width="1720"
	height="674"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403205331-yabuxpp_hu_ad34ead049d42bba.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403205331-yabuxpp_hu_83f200450a76279.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="255"
		data-flex-basis="612px"
	
></p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403205428-p2jla4q.png"
	width="1746"
	height="704"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403205428-p2jla4q_hu_2bab6ace5b9fb238.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403205428-p2jla4q_hu_57ec494fbe506ade.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="248"
		data-flex-basis="595px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">i MachineDR=&#34;34&#34; d
</span></span><span class="line"><span class="cl">   	.s WorkGroupMachineDRs=&#34;41,3,48,50,67,7,9&#34;
</span></span><span class="line"><span class="cl">   	e  s WorkGroupMachineDRs=WorkGroupMachineDR
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">QryLSData</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span> <span class="n">WorkGroupMachineDRs</span><span class="o">=</span><span class="s2">&#34;41,3,48,50,67,7,9&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">//</span><span class="err">按仪器或者小组查询</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="n">date</span><span class="o">=</span><span class="n">SttDate</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">EndDate</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">s</span> <span class="n">Curdate</span><span class="o">=$</span><span class="n">TR</span><span class="p">(</span><span class="o">$</span><span class="n">ZD</span><span class="p">(</span><span class="n">date</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="n">f</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">L</span><span class="p">(</span><span class="n">SendStatus</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">s</span> <span class="n">CurSendStatus</span><span class="o">=$</span><span class="n">P</span><span class="p">(</span><span class="n">SendStatus</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">..</span><span class="n">i</span> <span class="s1">&#39;$l(iWorkGroupMachineDR) d</span>
</span></span><span class="line"><span class="cl">  	<span class="o">...</span><span class="n">s</span> <span class="n">Time</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">Time</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(CurSendStatus),Curdate,Time)) q:Time=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">  	<span class="o">....</span><span class="n">s</span> <span class="n">RowID</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="n">f</span>  <span class="n">s</span> <span class="n">RowID</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadI</span><span class="p">(</span><span class="s2">&#34;IndexSendStatus&#34;</span><span class="p">,</span><span class="n">MachineDR</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(CurSendStatus),Curdate,Time,RowID)) q:RowID=&#34;&#34;  d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">loadData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPMachineUploadD</span><span class="p">(</span><span class="n">RowID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">VisitNumber</span><span class="o">=$</span><span class="n">lg</span><span class="p">(</span><span class="n">loadData</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">VisitNumberDR</span><span class="o">=$</span><span class="n">o</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberI</span><span class="p">(</span><span class="s2">&#34;IndexVisitNumber&#34;</span><span class="p">,</span><span class="c1">##Class(LIS.Util.Common).IndexData(VisitNumber),&#34;&#34;))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">s</span> <span class="n">VisitNumberData</span><span class="o">=$</span><span class="n">g</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberD</span><span class="p">(</span><span class="n">VisitNumberDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">i</span> <span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">iVisitNumber</span><span class="p">),</span><span class="n">VisitNumber</span><span class="s1">&#39;[iVisitNumber q</span>
</span></span><span class="line"><span class="cl">	<span class="o">.....</span><span class="n">f</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">$</span><span class="n">l</span><span class="p">(</span><span class="n">WorkGroupMachineDRs</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">s</span> <span class="n">WorkGroupMachineDRsj</span><span class="o">=$</span><span class="n">p</span><span class="p">(</span><span class="n">WorkGroupMachineDRs</span><span class="p">,</span><span class="s2">&#34;,&#34;</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">i</span> <span class="s1">&#39;$l(WorkGroupMachineDRsj) q</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">s</span> <span class="n">order</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span><span class="n">f</span>  <span class="n">s</span> <span class="n">order</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDRsj</span><span class="p">,</span><span class="n">order</span><span class="p">))</span> <span class="n">q</span><span class="p">:</span><span class="n">order</span><span class="o">=</span><span class="s2">&#34;&#34;</span>  <span class="n">d</span>
</span></span><span class="line"><span class="cl">	<span class="o">.......</span><span class="n">s</span> <span class="n">ReportDR</span><span class="o">=$</span><span class="n">O</span><span class="p">(</span><span class="o">^</span><span class="n">dbo</span><span class="o">.</span><span class="n">RPVisitNumberReportI</span><span class="p">(</span><span class="s2">&#34;IndexReportID&#34;</span><span class="p">,</span><span class="n">VisitNumberDR</span><span class="p">,</span><span class="n">WorkGroupMachineDRsj</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.......</span><span class="n">d</span> <span class="n">InsertData</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="问题处理记录">问题处理记录
</h2><blockquote>
<p>本节点为接口使用过程中踩过的雷和遇到过的问题以及处理方案</p></blockquote>
<h3 id="20250403102148-sh95o3i">无法及时读取文件处理造成获取结果过慢
</h3><p>1.修改监听配置，允许同一台电脑上存在多个监听。（新版本监听支持，本接口对应使用软件在附件中）</p>
<p>监听中存在两个配置，<strong>AllowMultiOpen（是否允许多开，1允许，0不允许，默认不允许）</strong> 和<strong>OpenMessageService（多开版本维护为0，如果是1的话会造成系统崩溃！！！如果是正常在用电脑，其中一个维护为1就可以，其他的一定要设置为0）</strong> <img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403103932-qy0x4j8.png"
	width="1401"
	height="369"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403103932-qy0x4j8_hu_7318851fc8593ae5.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403103932-qy0x4j8_hu_756326c8e152e369.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="379"
		data-flex-basis="911px"
	
></p>
<p><img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403104735-3gcculo.png"
	width="1271"
	height="212"
	srcset="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403104735-3gcculo_hu_d97ee41018c47b37.png 480w, /p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFit3000-4f6183cee7/assets/image-20250403104735-3gcculo_hu_d389a90e48fbc3da.png 1024w"
	loading="lazy"
	
		alt="image"
	
	
		class="gallery-image" 
		data-flex-grow="599"
		data-flex-basis="1438px"
	
></p>
<p>在监听配置中，配置多个监听读取。本接口配置多个监听，主监听读取结果，额外配置两个，一个读取流水线处理文件，一个读取图片和上传信息（！！！这两个功能一定要在一起，上传参数  <strong>&quot;UPPreDealClass&quot;:&quot;PreDeal.DealDemoM,PreDeal&quot;</strong> 配置后，就一定会主动上传文件，所以一定一定一定再一起！！！）</p>
<p>2.使用job线程处理。监听固定调用对应接口的fileMTHD方法，读取结果与系统其他方法没有交互，因此将具体的处理方法另外写了方法 <strong>ResultDo</strong> ，通过文件名包含路径进行判断，如果是结果RESULT文件，用job调用存储结果，如果是处理SEEN文件，用do调用处理结果。加快解析读取结果速度。</p>
<h3 id="仪器未获取到项目问题">仪器未获取到项目问题
</h3><p>1.读取结果不能及时时，进行了监听配置配置多个监听，最开始是为了分工明确，设置了四个监听，一个用来读取结果RESULT，一个用来读取处理文件SEEN，一个用来上传信息，一个用来读取图片。读取图片的配置和上传信息的配置处理类是同一个，读取图片多了一个额外的读取图片路径。</p>
<p>最开始认为，读取图片的配置，不配置上传信息的路径，就不会进行上传。后面科室经常说会有漏标本漏项目的情况，经过多次排查核对日志后，发现被读取图片配置的监听上传了文件，因为没有配置上传路径，将上传的文件存在了监听对应的根路径。后面修改为上传信息和读取图片合为一个监听，最终为三个监听，一个读取结果，一个读取处理文件，一个上传信息+读取图片。</p>
<p>2.修改后仍旧有漏项目的情况，确定仪器电脑只有三个监听，三个监听的日志都有认真排查。后面使用获取调用webservice的ip方法 <code>w ##Class(LIS.Util.Common).GetClientIP()</code>，查询到有其他电脑配置了监听，造成被其他电脑抢走了。</p>
<p>3.上传过快造成未接收完标本已经上传，造成漏项目问题，判断接收5s内不上传。遇到偶发问题，上传时间与接收时间为0甚至上传时间比接收时间早1s，判断是事务未完成已经发送。设置上传时间大于-2秒不上传。</p>
<h3 id="报警信息过长保存到其他结果字段时造成无法保存仪器结果">报警信息过长保存到其他结果字段时造成无法保存仪器结果
</h3><p>报警信息存放在结果说明字段，会将结果说明字段发送给临床医生，很多医院要求报警信息不发送给临床医生，因此将报警信息存放至其他结果字段。然而其他结果字段，在<code>dbo.RPMachineResult</code>仪器结果表和<code>dbo.RPMachineResultLog</code>仪器结果日志表中字段<code>OtherRes</code>设置长度较短，就会造成存储时报错但是前台没有任何提示。扩长后可以正常的对应到结果。</p>
<p>如果仪器维护报警结果不传输，如果没有结果，其他结果也不会赋值，因此要根据实际进行判断，如果有报警信息但是没有结果，设置结果为ERR，报警信息就可以正常的保存显示。</p>
<h3 id="同时存在大量标本查询速度过慢造成堆积无法正常上传项目">同时存在大量标本，查询速度过慢，造成堆积无法正常上传项目
</h3><p>批量手工登记，造成同时存在超多标本等待上传，由于主动上传查询query中，包含申请项目上传，复查项目上传，回退项目上传和审核项目上传，造成查询速度过慢</p>
<p>监听查询等待时间为60s，如果超过时间认为查询超时，就不再等待进行上传，会提示查询错误超过50次。因此对于接口进行处理，申请项目上传分批上传，超过10个就停止查询直接输出。</p>
<p>‍</p>

    
    
    
    
</section>


<style>
   
  .document-link {
    color: #007bff;
    text-decoration: none;
    position: relative;
    padding: 0 2px;
  }
  
   
  .docx-link::after { content: "📄"; font-size: 0.8em; margin-left: 4px; }
  .doc-link::after { content: "📄"; font-size: 0.8em; margin-left: 4px; }
  .pdf-link::after { content: "📄"; font-size: 0.8em; margin-left: 4px; }
  .xls-link::after { content: "📊"; font-size: 0.8em; margin-left: 4px; }
  .xlsx-link::after { content: "📊"; font-size: 0.8em; margin-left: 4px; }
  .ppt-link::after { content: "📽️"; font-size: 0.8em; margin-left: 4px; }
  .pptx-link::after { content: "📽️"; font-size: 0.8em; margin-left: 4px; }
   
  .other-link::after { content: "📎"; font-size: 0.8em; margin-left: 4px; }


   
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  
  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  .modal-container {
    background: white;
    width: 90%;
    max-width: 1000px;
    height: 80vh;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: translateY(20px);
    transition: transform 0.3s ease;
  }
  
  .modal-overlay.active .modal-container {
    transform: translateY(0);
  }
  
  .modal-header {
    padding: 16px;
    background: #f5f5f5;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .modal-title {
    margin: 0;
    font-size: 1.2rem;
  }
  
  .modal-actions {
    display: flex;
    gap: 10px;
  }
  
  .search-container {
    flex: 1;
    margin: 0 16px;
    position: relative;
  }
  
  .search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  
  .search-input.loading {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cpolyline points='16 12 12 8 8 12'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    padding-right: 32px;
  }
  
  .search-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .nav-button {
    background: transparent;
    border: none;
    border-radius: 4px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
    pointer-events: auto !important;
  }
  
  .nav-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .nav-button:hover:not(:disabled) {
    background: #e0e0e0;
  }
  
  .nav-button:active {
    transform: scale(0.95);
    transition: transform 0.1s;
  }
  
   
  .nav-button .icon {
    width: 16px;
    height: 16px;
    fill: currentColor;
    color: #333;  
    transition: color 0.2s;
  }
  
  .nav-button:hover:not(:disabled) .icon {
    color: #000;  
  }
  
  
  .search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    padding: 8px 12px;
    font-size: 0.8rem;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: space-between;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-5px);
    transition: all 0.2s ease;
    pointer-events: none;
  }
  
  .search-results.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }
  
  .modal-body {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
  }
  
  .modal-footer {
    padding: 12px 16px;
    background: #f5f5f5;
    border-top: 1px solid #ddd;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  
  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s ease;
  }
  
  .btn-primary {
    background: #007bff;
    color: white;
  }
  
  .btn-primary:hover {
    background: #0056b3;
  }
  
  .btn-secondary {
    background: #6c757d;
    color: white;
  }
  
  .btn-secondary:hover {
    background: #5a6268;
  }
  
  .btn-close {
    background: #6c757d;
    color: white;
  }
  
  .btn-close:hover {
    background: #5a6268;
  }
  
  .highlight {
    background-color: #fff3cd !important;
    padding: 0 2px;
    border-radius: 2px;
  }
  
  .highlight.active {
    background-color: #ffeeba !important;
    outline: 2px solid #ffc107;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0% { outline-color: #ffc107; }
    50% { outline-color: #ffecb5; }
    100% { outline-color: #ffc107; }
  }


   
  .table-wrapper {
    overflow-x: auto;
    margin: 16px 0;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
    background-color: white;
  }
  
  table th, 
  table td {
    padding: 12px 15px;
    text-align: left;
    border: 1px solid #e0e0e0;
    word-wrap: break-word;
    vertical-align: top;
  }
  
  table th {
    background-color: #f8f9fa;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  table tr:nth-child(even) {
    background-color: #f8f9fa;
  }
  
  table tr:hover {
    background-color: #f1f3f5;
  }
  
   
  table .highlight {
    display: inline;
    margin: 0 -2px;
    padding: 0 2px;
  }
  
   
  table [id^="search-match-"] {
    position: relative;
  }
  
   
  .pdf-container {
    width: 100%;
    height: 100%;
    position: relative;
  }
  
  .pdf-viewer {
    width: 100%;
    height: calc(100% - 40px);
    overflow: auto;
    text-align: center;
    background-color: #f5f5f5;
    position: relative;
  }
  
  .pdf-toolbar {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 10px;
    background-color: #f5f5f5;
    border-bottom: 1px solid #ddd;
  }
  
  .pdf-page {
    display: inline-block;
    margin: 10px auto;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
  }
  
  .pdf-page canvas {
    display: block;
  }
  
  .pdf-navigation {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .page-number {
    width: 60px;
    text-align: center;
  }
  
  .pdf-zoom {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .pdf-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }
  
  .pdf-error {
    color: #dc3545;
    padding: 20px;
    text-align: center;
  }
  
   
  .office-embed-container {
    width: 100%;
    height: 100%;
    border: none;
  }
  
   
  .office-view-container {
    width: 100%;
    height: 100%;
    border: none;
  }
  
   
  .text-layer {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
    pointer-events: none;
    user-select: none;
  }
  
  .text-layer span {
    color: transparent;
    position: absolute;
    white-space: pre;
    cursor: text;
    transform-origin: 0% 0%;
  }
  
   
  @media (max-width: 768px) {
    .table-wrapper {
      margin: 12px 0;
      border-radius: 2px;
    }
    
    table th, 
    table td {
      padding: 8px 10px;
      font-size: 0.9rem;
    }
    
     
    .nav-button .icon {
      width: 14px;
      height: 14px;
    }
    
    .pdf-toolbar {
      flex-wrap: wrap;
      height: auto;
      padding: 5px;
      gap: 5px;
    }
    
    .pdf-navigation, .pdf-zoom {
      flex: 1;
      justify-content: center;
    }
  }

   
  .xlsx-content, .pptx-content {
      line-height: 1.6;
  }

  .worksheet-container {
      margin-bottom: 20px;
  }

  .slide {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 4px;
  }

  .slide-text {
      margin: 8px 0;
      padding: 4px 0;
  }

  .slide-text.level-0 { font-size: 1.2em; font-weight: bold; }
  .slide-text.level-1 { font-size: 1.1em; font-weight: 600; }
  .slide-text.level-2 { font-size: 1em; }

  .error-message {
      color: #dc3545;
      padding: 10px;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      background-color: #f8d7da;
  }

  .no-content {
      color: #6c757d;
      font-style: italic;
  }
</style>


<div class="modal-overlay" id="document-modal">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title" id="modal-title">文档预览</h3>
      <div class="modal-actions">
        
        <div class="search-container" id="search-container">
          <input type="text" class="search-input" id="search-input" placeholder="搜索文档内容...">
          <div class="search-results" id="search-results">
            <span id="match-count">未搜索</span>
            <div class="search-controls">
              <button class="nav-button" id="prev-match-popup" title="上一个匹配项 (Shift+Enter)">
                
                <img src="/icons/up.svg" alt="上一个匹配项" class="icon" />
              </button>
              <button class="nav-button" id="next-match-popup" title="下一个匹配项 (Enter)">
                
                <img src="/icons/down.svg" alt="下一个匹配项" class="icon" />
              </button>
            </div>
          </div>
        </div>
        <button class="btn btn-close" id="close-modal">关闭</button>
      </div>
    </div>
    <div class="modal-body" id="document-preview">
      
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="open-new-tab">新标签页打开</button>
      <a href="" class="btn btn-primary" id="download-link" download>下载文档</a>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.17/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptx-parser@0.1.6/dist/pptx-parser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script>

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

document.addEventListener('DOMContentLoaded', () => {
    
    const documentConfig = {
        defaultAction: "map[action:modal search:false]",
        docx: { action: "mammoth" },
        doc: { action: "officeViewmodal" },
        pdf: { action: "modal" },
        xls: { action: "officeViewmodal" },
        xlsx: { action: "mammoth" },
        ppt: { action: "officeEmbed" },
        pptx: { action: "officeEmbed" }
    };


    
    const modal = document.getElementById('document-modal');
    const modalTitle = document.getElementById('modal-title');
    const previewContainer = document.querySelector('#document-modal #document-preview');
    const closeModalBtn = document.getElementById('close-modal');
    const downloadLink = document.getElementById('download-link');
    const openNewTabBtn = document.getElementById('open-new-tab');
    const searchInput = document.getElementById('search-input');
    const searchContainer = document.getElementById('search-container');
    const searchResults = document.getElementById('search-results');
    const matchCount = document.getElementById('match-count');
    const prevMatchBtn = document.getElementById('prev-match-popup');
    const nextMatchBtn = document.getElementById('next-match-popup');
    
    
    let currentDocContent = null;
    let currentDocType = null;
    let currentDocUrl = null;
    let currentSearchTerm = '';
    let matchCountTotal = 0;
    let currentMatchIndex = -1;
    let isSearching = false;
    let searchTimeout = null;
    let currentAction = null; 
    const SEARCH_DELAY = 300;
    const MATCH_ID_PREFIX = 'search-match-';
    const MAMMOTH_SUPPORTED_TYPES = ['docx', 'xlsx', 'pptx']; 
    
    
    let pdfDoc = null;
    let currentPage = 1;
    let zoom = 1.0;
    let pdfSearchResults = [];
    let pdfCurrentSearchIndex = -1;
    
    
    if (!modal || !previewContainer || !searchResults || !prevMatchBtn || !nextMatchBtn) {
        console.error('关键元素未找到，请检查HTML结构');
        return;
    }


    
    function openModal() {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        previewContainer.innerHTML = '';
        updateSearchUI();
    }


    
    function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        resetSearch();
        previewContainer.innerHTML = '';
        currentDocContent = null;
        currentDocType = null;
        currentDocUrl = null;
        currentAction = null;
        
        
        pdfDoc = null;
        currentPage = 1;
        zoom = 1.0;
        pdfSearchResults = [];
        pdfCurrentSearchIndex = -1;
    }


    
    function resetSearch() {
        if (searchTimeout) {
            clearTimeout(searchTimeout);
            searchTimeout = null;
        }
        
        searchInput.classList.remove('loading');
        searchInput.value = '';
        currentSearchTerm = '';
        matchCountTotal = 0;
        currentMatchIndex = -1;
        
        
        if (previewContainer) {
            const highlights = previewContainer.querySelectorAll('.highlight');
            highlights.forEach(el => {
                const textNode = document.createTextNode(el.textContent);
                el.parentNode.replaceChild(textNode, el);
            });
        }
        
        
        pdfSearchResults = [];
        pdfCurrentSearchIndex = -1;
        
        updateSearchUI();
    }


    
    function updateSearchUI() {
        
        
        
        
		const showSearch = currentAction === 'mammoth' && MAMMOTH_SUPPORTED_TYPES.includes(currentDocType);		
        searchContainer.style.display = showSearch ? 'block' : 'none';
        
        
        if (currentSearchTerm === '' && matchCountTotal === 0) {
            searchResults.classList.remove('visible');
        } else {
            searchResults.classList.add('visible');
        }
        
        
        if (currentSearchTerm === '') {
            matchCount.textContent = '未搜索';
        } else if (matchCountTotal === 0) {
            matchCount.textContent = '未找到匹配项';
        } else {
            matchCount.textContent = `找到 ${matchCountTotal} 个匹配项 (${currentMatchIndex + 1}/${matchCountTotal})`;
        }
        
        
        const hasMatches = matchCountTotal > 0;
        prevMatchBtn.disabled = !hasMatches;
        nextMatchBtn.disabled = !hasMatches;
    }


    
    async function performSearch(text) {
        
        if (currentDocType === 'pdf' && pdfDoc) {
            return performPdfSearch(text);
        }
        
        
        if (isSearching || currentAction !== 'mammoth' || 
            !MAMMOTH_SUPPORTED_TYPES.includes(currentDocType)) {
            return;
        }
        
        if (!text || text.trim() === '' || !currentDocContent) {
            resetSearch();
            return;
        }
        
        isSearching = true;
        searchInput.classList.add('loading');
        currentSearchTerm = text.trim();
        updateSearchUI();
        
        try {
            await new Promise(resolve => {
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(resolve, { timeout: 1000 });
                } else {
                    setTimeout(resolve, 0);
                }
            });
            
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentDocContent;
            
            
            const term = currentSearchTerm.toLowerCase();
            const newMatchCount = findAndMarkMatches(tempDiv, term);
            
            
            const tables = tempDiv.querySelectorAll('table');
            tables.forEach(table => {
                if (!table.parentNode.classList.contains('table-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-wrapper';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                }
            });
            
            
            matchCountTotal = newMatchCount;
            currentMatchIndex = newMatchCount > 0 ? 0 : -1;
            
            
            previewContainer.innerHTML = tempDiv.innerHTML;
            
            
            if (matchCountTotal > 0) {
                scrollToMatch(0);
            }
            
        } catch (error) {
            console.error('搜索出错:', error);
            matchCount.textContent = '搜索出错';
        } finally {
            isSearching = false;
            searchInput.classList.remove('loading');
            updateSearchUI();
        }
    }


    
    async function performPdfSearch(text) {
        if (isSearching || !pdfDoc || !text || text.trim() === '') {
            resetSearch();
            return;
        }
        
        isSearching = true;
        searchInput.classList.add('loading');
        currentSearchTerm = text.trim();
        pdfSearchResults = [];
        pdfCurrentSearchIndex = -1;
        matchCountTotal = 0;
        
        try {
            
            const pages = previewContainer.querySelectorAll('.pdf-page');
            pages.forEach(page => {
                const highlightLayer = page.querySelector('.text-layer');
                if (highlightLayer) {
                    const highlights = highlightLayer.querySelectorAll('.highlight');
                    highlights.forEach(highlight => {
                        highlight.classList.remove('highlight', 'active');
                    });
                }
            });
            
            
            const numPages = pdfDoc.numPages;
            for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                const page = await pdfDoc.getPage(pageNum);
                const content = await page.getTextContent();
                
                
                const searchTerm = currentSearchTerm.toLowerCase();
                content.items.forEach((item, index) => {
                    if (typeof item.str === 'string' && item.str.toLowerCase().includes(searchTerm)) {
                        
                        pdfSearchResults.push({
                            pageNum,
                            itemIndex: index,
                            text: item.str,
                            transform: item.transform,
                            width: item.width,
                            height: item.height
                        });
                    }
                });
            }
            
            
            matchCountTotal = pdfSearchResults.length;
            pdfCurrentSearchIndex = matchCountTotal > 0 ? 0 : -1;
            currentMatchIndex = pdfCurrentSearchIndex;
            
            
            if (matchCountTotal > 0) {
                await scrollToPdfMatch(0);
            }
            
        } catch (error) {
            console.error('PDF搜索出错:', error);
            matchCount.textContent = '搜索出错';
        } finally {
            isSearching = false;
            searchInput.classList.remove('loading');
            updateSearchUI();
        }
    }


    
    function findAndMarkMatches(element, term) {
        if (!term) return 0;
        
        let matchNumber = 0;
        
        function processNode(node) {
            if (node.nodeType === Node.ELEMENT_NODE) {
                
                if (['SCRIPT', 'STYLE', 'NOSCRIPT', 'IMG', 'VIDEO', 'AUDIO'].includes(node.tagName)) {
                    return;
                }
                
                
                const children = Array.from(node.childNodes);
                children.forEach(processNode);
            } else if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent;
                const lowerText = text.toLowerCase();
                let index = 0;
                const termLength = term.length;
                
                while ((index = lowerText.indexOf(term, index)) !== -1) {
                    
                    const parent = node.parentNode;
                    if (!parent) {
                        index += termLength;
                        continue;
                    }
                    
                    const currentNode = node;
                    const beforeNode = currentNode.splitText(index);
                    const matchNode = beforeNode.splitText(termLength);
                    
                    
                    const highlight = document.createElement('span');
                    highlight.className = 'highlight';
                    highlight.id = `${MATCH_ID_PREFIX}${matchNumber}`;
                    highlight.textContent = beforeNode.textContent;
                    
                    parent.replaceChild(highlight, beforeNode);
                    matchNumber++;
                    
                    
                    index += termLength;
                    node = matchNode;
                }
            }
        }
        
        processNode(element);
        return matchNumber;
    }


    
    function scrollToMatch(index) {
        
        if (matchCountTotal === 0 || index < 0 || index >= matchCountTotal) {
            console.warn('无效的匹配项索引:', index);
            return;
        }
        
        
        document.querySelectorAll('.highlight.active').forEach(el => {
            el.classList.remove('active');
        });
        
        
        const matchId = `${MATCH_ID_PREFIX}${index}`;
        const matchElement = document.getElementById(matchId);
        
        if (!matchElement) {
            console.warn(`匹配项ID ${matchId} 未找到在DOM中`);
            restoreMatches();
            return;
        }
        
        
        currentMatchIndex = index;
        matchElement.classList.add('active');
        
        
        matchElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center',
            inline: 'center'
        });
        
        
        const tableWrapper = matchElement.closest('.table-wrapper');
        if (tableWrapper) {
            const tableRect = matchElement.getBoundingClientRect();
            const wrapperRect = tableWrapper.getBoundingClientRect();
            
            
            if (tableRect.left < wrapperRect.left || tableRect.right > wrapperRect.right) {
                
                tableWrapper.scrollLeft += (tableRect.left - wrapperRect.left) - (wrapperRect.width / 4);
            }
        }
        
        updateSearchUI();
    }


    
    async function scrollToPdfMatch(index) {
        if (pdfSearchResults.length === 0 || index < 0 || index >= pdfSearchResults.length) {
            return;
        }
        
        const match = pdfSearchResults[index];
        pdfCurrentSearchIndex = index;
        currentMatchIndex = index;
        
        
        const pages = previewContainer.querySelectorAll('.pdf-page');
        pages.forEach(page => {
            const highlightLayer = page.querySelector('.text-layer');
            if (highlightLayer) {
                const highlights = highlightLayer.querySelectorAll('.highlight');
                highlights.forEach(highlight => {
                    highlight.classList.remove('highlight', 'active');
                });
            }
        });
        
        
        await renderPage(match.pageNum);
        
        
        const currentPageEl = previewContainer.querySelector(`.pdf-page[data-page="${match.pageNum}"]`);
        if (currentPageEl) {
            const textLayer = currentPageEl.querySelector('.text-layer');
            if (textLayer) {
                
                const textElements = textLayer.querySelectorAll('.text');
                
                
                if (textElements[match.itemIndex]) {
                    textElements[match.itemIndex].classList.add('highlight', 'active');
                    
                    
                    textElements[match.itemIndex].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }
        }
        
        updateSearchUI();
    }


    
    function restoreMatches() {
        console.log('尝试恢复匹配项索引');
        
        const matches = document.querySelectorAll(`[id^="${MATCH_ID_PREFIX}"]`);
        matchCountTotal = matches.length;
        
        if (matchCountTotal > 0) {
            currentMatchIndex = 0;
            updateSearchUI();
            scrollToMatch(0);
        } else {
            if (currentSearchTerm) {
                performSearch(currentSearchTerm);
            }
        }
    }


    
    function goToNextMatch() {
        if (matchCountTotal === 0) {
            return;
        }
        
        
        if (currentDocType === 'pdf' && pdfDoc) {
            const nextIndex = (pdfCurrentSearchIndex + 1) % matchCountTotal;
            scrollToPdfMatch(nextIndex);
            return;
        }
        
        const nextIndex = (currentMatchIndex + 1) % matchCountTotal;
        scrollToMatch(nextIndex);
    }


    
    function goToPrevMatch() {
        if (matchCountTotal === 0) {
            return;
        }
        
        
        if (currentDocType === 'pdf' && pdfDoc) {
            const prevIndex = (pdfCurrentSearchIndex - 1 + matchCountTotal) % matchCountTotal;
            scrollToPdfMatch(prevIndex);
            return;
        }
        
        const prevIndex = (currentMatchIndex - 1 + matchCountTotal) % matchCountTotal;
        scrollToMatch(prevIndex);
    }


    
    searchInput.addEventListener('input', (e) => {
        const searchText = e.target.value;
        
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        if (searchText.trim() === '') {
            resetSearch();
            return;
        }
        
        searchTimeout = setTimeout(() => {
            performSearch(searchText);
        }, SEARCH_DELAY);
    });


    
    prevMatchBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        goToPrevMatch();
    });
    
    nextMatchBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        goToNextMatch();
    });


    
    searchInput.addEventListener('keydown', (e) => {
        if ((e.key === 'Enter') && !e.shiftKey) {
            e.preventDefault();
            goToNextMatch();
        }
        
        if (e.key === 'Enter' && e.shiftKey) {
            e.preventDefault();
            goToPrevMatch();
        }
        
        if ((e.key === 'ArrowDown') && !e.shiftKey) {
            e.preventDefault();
            goToNextMatch();
        }
        
        if (e.key === 'ArrowUp' && !e.shiftKey) {
            e.preventDefault();
            goToPrevMatch();
        }
    });


    
    function openInNewTab(url, docType, title) {
        const action = getDocumentAction(docType);
        
        
        switch(action) {
            case 'mammoth':
                
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    
                    let additionalLibraries = '';
                    if (docType === 'xlsx') {
                        additionalLibraries = '\x3Cscript src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js">\x3C/script>';
                    } else if (docType === 'pptx') {
                        additionalLibraries = '\x3Cscript src="https://cdn.jsdelivr.net/npm/pptx-parser@0.1.6/dist/pptx-parser.min.js">\x3C/script>';
                    } else if (docType === 'pdf') {
                        additionalLibraries = '\x3Cscript src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js">\x3C/script>';
                    }
                    
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>${title || '文档预览'}</title>
                            \x3Cscript src="https://cdn.jsdelivr.net/npm/mammoth@1.4.17/mammoth.browser.min.js">\x3C/script>
                            ${additionalLibraries}
                            <style>
                                body { margin: 0; padding: 20px; max-width: 1000px; margin: 0 auto; }
                                .loading { text-align: center; padding: 50px; }
                                .error { color: #dc3545; text-align: center; padding: 50px; }
                                .table-wrapper { overflow-x: auto; margin: 16px 0; }
                                table { border-collapse: collapse; width: 100%; }
                                table th, table td { border: 1px solid #ddd; padding: 8px 12px; }
                                table th { background-color: #f8f9fa; }
                                /* Excel和PowerPoint预览样式 */
                                .xlsx-content, .pptx-content { line-height: 1.6; }
                                .worksheet-container { margin-bottom: 20px; }
                                .slide { margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 4px; }
                                .slide-text { margin: 8px 0; padding: 4px 0; }
                                .slide-text.level-0 { font-size: 1.2em; font-weight: bold; }
                                .slide-text.level-1 { font-size: 1.1em; font-weight: 600; }
                                .slide-text.level-2 { font-size: 1em; }
                            </style>
                        </head>
                        <body>
                            <div class="loading">
                                <p>正在加载文档...</p>
                            </div>
                            \x3Cscript>
                                // 辅助函数：转义HTML特殊字符
                                function escapeHtml(unsafe) {
                                    if (!unsafe) return '';
                                    return unsafe
                                        .replace(/&/g, "&amp;")
                                        .replace(/</g, "&lt;")
                                        .replace(/>/g, "&gt;")
                                        .replace(/"/g, "&quot;")
                                        .replace(/'/g, "&#039;");
                                }
                                
                                // 解析XLSX文件
                                async function parseXlsx(arrayBuffer) {
                                    try {
                                        // 使用xlsx库解析Excel文件
                                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                                        
                                        let htmlContent = '<div class="xlsx-content">';
                                        htmlContent += \`<h3>Excel文档: \${workbook.SheetNames.length} 个工作表</h3>\`;
                                        
                                        // 遍历所有工作表
                                        workbook.SheetNames.forEach((sheetName, index) => {
                                            // 将工作表转换为HTML
                                            const worksheet = workbook.Sheets[sheetName];
                                            const html = XLSX.utils.sheet_to_html(worksheet);
                                            
                                            // 添加工作表标题和内容
                                            htmlContent += \`
                                                <div class="worksheet-container">
                                                    <h4>工作表 \${index + 1}: \${sheetName}</h4>
                                                    <div class="table-wrapper">\${html}</div>
                                                </div>
                                                <hr>
                                            \`;
                                        });
                                        
                                        htmlContent += '</div>';
                                        
                                        return { value: htmlContent };
                                    } catch (error) {
                                        console.error('XLSX解析错误:', error);
                                        return { 
                                            value: \`<div class="error-message">
                                                <p>无法解析Excel文件</p>
                                                <p>错误: \${error.message}</p>
                                            </div>\` 
                                        };
                                    }
                                }
                                
                                // 解析PPTX文件
                                async function parsePptx(arrayBuffer) {
                                    try {
                                        // 将ArrayBuffer转换为Uint8Array
                                        const uint8Array = new Uint8Array(arrayBuffer);
                                        
                                        // 使用pptx-parser解析PowerPoint文件
                                        const presentation = await PptxParser.parse(uint8Array);
                                        
                                        let htmlContent = '<div class="pptx-content">';
                                        htmlContent += \`<h3>PowerPoint文档: \${presentation.slides.length} 张幻灯片</h3>\`;
                                        
                                        // 遍历所有幻灯片
                                        presentation.slides.forEach((slide, index) => {
                                            htmlContent += \`<div class="slide slide-\${index + 1}">\`;
                                            htmlContent += \`<h4>幻灯片 \${index + 1}</h4>\`;
                                            
                                            // 处理幻灯片内容
                                            if (slide.text && slide.text.length > 0) {
                                                htmlContent += '<div class="slide-content">';
                                                
                                                // 处理文本内容
                                                slide.text.forEach(text => {
                                                    // 根据文本级别使用适当的标题或段落标签
                                                    const tag = text.level === 0 ? 'h5' : 
                                                               text.level === 1 ? 'h6' : 'p';
                                                    htmlContent += \`<\${tag} class="slide-text level-\${text.level}">\${escapeHtml(text.content)}</\${tag}>\`;
                                                });
                                                
                                                htmlContent += '</div>';
                                            } else {
                                                htmlContent += '<p class="no-content">此幻灯片没有可提取的文本内容</p>';
                                            }
                                            
                                            htmlContent += '</div><hr>';
                                        });
                                        
                                        htmlContent += '</div>';
                                        
                                        return { value: htmlContent };
                                    } catch (error) {
                                        console.error('PPTX解析错误:', error);
                                        return { 
                                            value: \`<div class="error-message">
                                                <p>无法解析PowerPoint文件</p>
                                                <p>错误: \${error.message}</p>
                                            </div>\` 
                                        };
                                    }
                                }
                                
                                // 解析文档并显示
                                async function loadDocument() {
                                    try {
                                        const response = await fetch('${url}');
                                        if (!response.ok) throw new Error('加载失败');
                                        
                                        const arrayBuffer = await response.arrayBuffer();
                                        let result;
                                        
                                        // 根据文档类型使用不同的解析方式
                                        switch('${docType}') {
                                            case 'docx':
                                                result = await mammoth.convertToHtml({ arrayBuffer });
                                                break;
                                            case 'xlsx':
                                                // 对于Excel文件，使用xlsx库解析
                                                result = await parseXlsx(arrayBuffer);
                                                break;
                                            case 'pptx':
                                                // 对于PowerPoint文件，使用pptx-parser解析
                                                result = await parsePptx(arrayBuffer);
                                                break;
                                            case 'pdf':
                                                // 对于PDF文件，使用pdf.js
                                                if (typeof pdfjsLib !== 'undefined') {
                                                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
                                                    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                                                    let htmlContent = '<div class="pdf-container">';
                                                    htmlContent += \`<h3>PDF文档: \${pdfDoc.numPages} 页</h3>\`;
                                                    htmlContent += '<div class="pdf-viewer">';
                                                    
                                                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                                                        const page = await pdfDoc.getPage(i);
                                                        const viewport = page.getViewport({ scale: 1.0 });
                                                        htmlContent += \`<div class="pdf-page" style="width: \${viewport.width}px; height: \${viewport.height}px;">\`;
                                                        htmlContent += \`<canvas id="page-\${i}" width="\${viewport.width}" height="\${viewport.height}"></canvas>\`;
                                                        htmlContent += '</div>';
                                                    }
                                                    
                                                    htmlContent += '</div></div>';
                                                    
                                                    document.body.innerHTML = htmlContent;
                                                    
                                                    // 渲染PDF页面
                                                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                                                        const page = await pdfDoc.getPage(i);
                                                        const viewport = page.getViewport({ scale: 1.0 });
                                                        const canvas = document.getElementById(\`page-\${i}\`);
                                                        const context = canvas.getContext('2d');
                                                        await page.render({ canvasContext: context, viewport }).promise;
                                                    }
                                                    
                                                    return;
                                                } else {
                                                    throw new Error('PDF.js库未加载');
                                                }
                                                break;
                                            default:
                                                throw new Error(\`不支持的文档类型: \${'${docType}'}\`);
                                        }
                                        
                                        // 处理表格，添加响应式包装器
                                        const tempDiv = document.createElement('div');
                                        tempDiv.innerHTML = result.value;
                                        
                                        // 为所有表格添加包装容器
                                        const tables = tempDiv.querySelectorAll('table');
                                        tables.forEach(table => {
                                            if (!table.parentNode.classList.contains('table-wrapper')) {
                                                const wrapper = document.createElement('div');
                                                wrapper.className = 'table-wrapper';
                                                table.parentNode.insertBefore(wrapper, table);
                                                wrapper.appendChild(table);
                                            }
                                        });
                                        
                                        document.body.innerHTML = tempDiv.innerHTML;
                                    } catch (err) {
                                        document.body.innerHTML = \`
                                            <div class="error">
                                                <p>文档加载失败</p>
                                                <p>\${err.message}</p>
                                                <p><a href="${url}" download class="btn btn-primary">下载文档</a></p>
                                            </div>
                                        \`;
                                    }
                                }
                                
                                loadDocument();
                            \x3C/script>
                        </body>
                        </html>
                    `);
                    newWindow.document.close();
                }
                break;
                
            case 'officeView':
            case 'officeViewmodal':
                
                const officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(url)}`;
                window.open(officeViewerUrl, '_blank');
                break;
                
            case 'officeEmbed':
            case 'officeEmbednewTab':
                
                const officeEmbedUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
                window.open(officeEmbedUrl, '_blank');
                break;
                
            case 'modal':
                
                window.open(url, '_blank');
                break;
                
            case 'download':
                
                const a = document.createElement('a');
                a.href = url;
                a.download = title;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                break;
                
            case 'newTab':
            default:
                
                window.open(url, '_blank');
                break;
        }
    }


    
    openNewTabBtn.addEventListener('click', () => {
        if (currentDocUrl && currentDocType) {
            openInNewTab(currentDocUrl, currentDocType, modalTitle.textContent);
        }
    });


    
    function getDocumentAction(docType) {
        
        if (documentConfig[docType] && documentConfig[docType].action) {
            return documentConfig[docType].action;
        }
        return documentConfig.defaultAction;
    }


    
    function handleOfficeView(url) {
        const officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(url)}`;
        window.open(officeViewerUrl, '_blank');
    }


    
    function handleOfficeViewModal(url, title) {
        openModal();
        modalTitle.textContent = title;
        
        
        const iframe = document.createElement('iframe');
        iframe.src = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(url)}`;
        iframe.className = 'office-view-container';
        iframe.title = title;
        
        previewContainer.innerHTML = '';
        previewContainer.appendChild(iframe);
    }


    
    function handleOfficeEmbed(url, title) {
        openModal();
        modalTitle.textContent = title;
        
        
        const iframe = document.createElement('iframe');
        iframe.src = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
        iframe.className = 'office-embed-container';
        iframe.title = title;
        
        previewContainer.innerHTML = '';
        previewContainer.appendChild(iframe);
    }


    
    function handleOfficeEmbedNewTab(url) {
        const officeEmbedUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
        window.open(officeEmbedUrl, '_blank');
    }


    
    async function handlePdfPreview(url, title) {
        openModal();
        modalTitle.textContent = title;
        
        
        previewContainer.innerHTML = `
            <div class="pdf-container">
                <div class="pdf-toolbar">
                    <div class="pdf-navigation">
                        <button class="btn" id="prev-page">上一页</button>
                        <span id="page-num">1</span> / <span id="page-count">加载中...</span>
                        <button class="btn" id="next-page">下一页</button>
                    </div>
                    <div class="pdf-zoom">
                        <button class="btn" id="zoom-out">缩小</button>
                        <span id="zoom-level">100%</span>
                        <button class="btn" id="zoom-in">放大</button>
                    </div>
                </div>
                <div class="pdf-viewer">
                    <div class="pdf-loading">
                        <p>正在加载PDF文档...</p>
                    </div>
                </div>
            </div>
        `;
        
        try {
            
            const pdfViewer = previewContainer.querySelector('.pdf-viewer');
            const loadingIndicator = previewContainer.querySelector('.pdf-loading');
            
            
            const response = await fetch(url);
            const data = await response.arrayBuffer();
            
            
            pdfDoc = await pdfjsLib.getDocument({ data }).promise;
            
            
            document.getElementById('page-count').textContent = pdfDoc.numPages;
            
            
            await renderPage(1);
            
            
            loadingIndicator.style.display = 'none';
            
            
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage <= 1) return;
                renderPage(currentPage - 1);
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                if (currentPage >= pdfDoc.numPages) return;
                renderPage(currentPage + 1);
            });
            
            document.getElementById('zoom-in').addEventListener('click', () => {
                zoom += 0.1;
                renderPage(currentPage);
                document.getElementById('zoom-level').textContent = `${Math.round(zoom * 100)}%`;
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                if (zoom <= 0.5) return;
                zoom -= 0.1;
                renderPage(currentPage);
                document.getElementById('zoom-level').textContent = `${Math.round(zoom * 100)}%`;
            });
            
            
            previewContainer.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                    if (currentPage > 1) renderPage(currentPage - 1);
                } else if (e.key === 'ArrowRight') {
                    if (currentPage < pdfDoc.numPages) renderPage(currentPage + 1);
                } else if (e.key === '+') {
                    zoom += 0.1;
                    renderPage(currentPage);
                    document.getElementById('zoom-level').textContent = `${Math.round(zoom * 100)}%`;
                } else if (e.key === '-') {
                    if (zoom > 0.5) {
                        zoom -= 0.1;
                        renderPage(currentPage);
                        document.getElementById('zoom-level').textContent = `${Math.round(zoom * 100)}%`;
                    }
                }
            });
            
        } catch (error) {
            console.error('PDF加载错误:', error);
            previewContainer.innerHTML = `
                <div class="pdf-error">
                    <p>无法加载PDF文档</p>
                    <p>错误: ${error.message}</p>
                    <p><a href="${url}" class="btn btn-primary" download>下载PDF</a></p>
                </div>
            `;
        }
    }


    
    async function renderPage(num) {
        if (!pdfDoc) return;
        
        currentPage = num;
        document.getElementById('page-num').textContent = num;
        
        const pdfViewer = previewContainer.querySelector('.pdf-viewer');
        const page = await pdfDoc.getPage(num);
        
        
        pdfViewer.innerHTML = '';
        
        
        const pageContainer = document.createElement('div');
        pageContainer.className = 'pdf-page';
        pageContainer.dataset.page = num;
        pdfViewer.appendChild(pageContainer);
        
        
        const viewport = page.getViewport({ scale: zoom });
        
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        pageContainer.appendChild(canvas);
        
        
        const textLayerDiv = document.createElement('div');
        textLayerDiv.className = 'text-layer';
        textLayerDiv.style.width = `${viewport.width}px`;
        textLayerDiv.style.height = `${viewport.height}px`;
        textLayerDiv.style.transform = `scale(${zoom})`;
        textLayerDiv.style.transformOrigin = '0 0';
        pageContainer.appendChild(textLayerDiv);
        
        
        const renderContext = {
            canvasContext: context,
            viewport: viewport
        };
        
        const renderTask = page.render(renderContext);
        await renderTask.promise;
        
        
        const textContent = await page.getTextContent();
        renderTextLayer(textContent, textLayerDiv, viewport);
        
        
        pageContainer.style.width = `${viewport.width}px`;
        pageContainer.style.height = `${viewport.height}px`;
        
        
        if (pdfSearchResults.length > 0) {
            const currentMatch = pdfSearchResults.find(match => match.pageNum === num);
            if (currentMatch) {
                const textElements = textLayerDiv.querySelectorAll('.text');
                if (textElements[currentMatch.itemIndex]) {
                    textElements[currentMatch.itemIndex].classList.add('highlight');
                    if (pdfCurrentSearchIndex === pdfSearchResults.indexOf(currentMatch)) {
                        textElements[currentMatch.itemIndex].classList.add('active');
                    }
                }
            }
        }
    }


    
    function renderTextLayer(textContent, textLayerDiv, viewport) {
        
        textLayerDiv.innerHTML = '';
        
        const textItems = textContent.items;
        const scale = viewport.scale;
        
        
        const sortedItems = [...textItems].sort((a, b) => {
            
            if (Math.abs(a.transform[5] - b.transform[5]) > 1) {
                return a.transform[5] - b.transform[5];
            }
            
            return a.transform[4] - b.transform[4];
        });
        
        sortedItems.forEach((item, index) => {
            const span = document.createElement('span');
            span.className = 'text';
            span.textContent = item.str;
            span.dataset.index = index;
            
            
            const x = item.transform[4] / scale;
            const y = item.transform[5] / scale;
            
            
            Object.assign(span.style, {
                left: `${x}px`,
                top: `${y}px`,
                fontSize: `${item.height / scale}px`,
                height: `${item.height / scale}px`,
                width: `${item.width / scale}px`,
                transform: `scale(${1/scale})`,
                transformOrigin: '0 0',
                position: 'absolute',
                whiteSpace: 'pre'
            });
            
            textLayerDiv.appendChild(span);
        });
    }


    
    async function handleMammothParse(url, title, docType) {
        if (!MAMMOTH_SUPPORTED_TYPES.includes(docType)) {
            console.warn(`不支持对${docType}类型使用mammoth解析`);
            return false;
        }
        
        try {
            openModal();
            previewContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fa fa-spinner fa-spin"></i> 正在解析文档...</div>';
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`请求失败: ${response.status}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            let result;
            
            
            switch(docType) {
                case 'docx':
                    result = await mammoth.convertToHtml({ arrayBuffer });
                    break;
                case 'xlsx':
                    
                    result = await parseXlsx(arrayBuffer);
                    break;
                case 'pptx':
                    
                    result = await parsePptx(arrayBuffer);
                    break;
                default:
                    throw new Error(`不支持的文档类型: ${docType}`);
            }
            
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = result.value;
            
            
            const tables = tempDiv.querySelectorAll('table');
            tables.forEach(table => {
                if (!table.parentNode.classList.contains('table-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-wrapper';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                }
            });
            
            currentDocContent = tempDiv.innerHTML;
            previewContainer.innerHTML = currentDocContent;
            resetSearch();
            return true;
            
        } catch (err) {
            previewContainer.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">
                解析失败，请<a href="${url}" class="btn btn-primary">下载文档</a>查看
                <p class="error-message">错误: ${err.message}</p>
            </div>`;
            console.error('解析错误：', err);
            return false;
        }
    }


    
	async function parseXlsx(arrayBuffer) {
		try {
			
			const workbook = XLSX.read(arrayBuffer, { type: 'array' });
			
			let htmlContent = '<div class="xlsx-content">';
			htmlContent += `<h3>Excel文档: ${workbook.SheetNames.length} 个工作表</h3>`;
			
			
			workbook.SheetNames.forEach((sheetName, index) => {
				
				const worksheet = workbook.Sheets[sheetName];
				const html = XLSX.utils.sheet_to_html(worksheet);
				
				
				htmlContent += `
					<div class="worksheet-container">
						<h4>工作表 ${index + 1}: ${sheetName}</h4>
						<div class="table-wrapper">${html}</div>
					</div>
					<hr>
				`;
			});
			
			htmlContent += '</div>';
			
			return { value: htmlContent };
		} catch (error) {
			console.error('XLSX解析错误:', error);
			return { 
				value: `<div class="error-message">
					<p>无法解析Excel文件</p>
					<p>错误: ${error.message}</p>
				</div>` 
			};
		}
	}

	
	async function parsePptx(arrayBuffer) {
		try {
			
			const uint8Array = new Uint8Array(arrayBuffer);
			
			
			const presentation = await PptxParser.parse(uint8Array);
			
			let htmlContent = '<div class="pptx-content">';
			htmlContent += `<h3>PowerPoint文档: ${presentation.slides.length} 张幻灯片</h3>`;
			
			
			presentation.slides.forEach((slide, index) => {
				htmlContent += `<div class="slide slide-${index + 1}">`;
				htmlContent += `<h4>幻灯片 ${index + 1}</h4>`;
				
				
				if (slide.text && slide.text.length > 0) {
					htmlContent += '<div class="slide-content">';
					
					
					slide.text.forEach(text => {
						
						const tag = text.level === 0 ? 'h5' : 
								   text.level === 1 ? 'h6' : 'p';
						htmlContent += `<${tag} class="slide-text level-${text.level}">${escapeHtml(text.content)}</${tag}>`;
					});
					
					htmlContent += '</div>';
				} else {
					htmlContent += '<p class="no-content">此幻灯片没有可提取的文本内容</p>';
				}
				
				htmlContent += '</div><hr>';
			});
			
			htmlContent += '</div>';
			
			return { value: htmlContent };
		} catch (error) {
			console.error('PPTX解析错误:', error);
			return { 
				value: `<div class="error-message">
					<p>无法解析PowerPoint文件</p>
					<p>错误: ${error.message}</p>
				</div>` 
			};
		}
	}

	
	function escapeHtml(unsafe) {
		if (!unsafe) return '';
		return unsafe
			.replace(/&/g, "&amp;")
			.replace(/</g, "&lt;")
			.replace(/>/g, "&gt;")
			.replace(/"/g, "&quot;")
			.replace(/'/g, "&#039;");
	}


    
    document.querySelectorAll('.document-link').forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            const docUrl = link.href;
            const docTitle = link.textContent.trim();
            const docType = link.getAttribute('data-type');
            const action = getDocumentAction(docType);
            
            
            currentDocUrl = docUrl;
            currentDocType = docType;
            currentAction = action;
            modalTitle.textContent = docTitle;
            downloadLink.href = docUrl;
			
			
			let fileName = docTitle;
			
			const extRegex = new RegExp(`\\.${docType}$`, 'i');
			if (!extRegex.test(fileName)) {
				
				fileName += `.${docType}`;
			}
			
			downloadLink.download = fileName;
            
            
            switch(action) {
                case 'newTab':
                    
                    window.open(docUrl, '_blank');
                    break;
                    
                case 'mammoth':
                    
                    await handleMammothParse(docUrl, docTitle, docType);
                    break;
                    
                case 'officeView':
                    
                    handleOfficeView(docUrl);
                    break;
                    
                case 'officeViewmodal':
                    
                    handleOfficeViewModal(docUrl, docTitle);
                    break;
                    
                case 'officeEmbed':
                    
                    handleOfficeEmbed(docUrl, docTitle);
                    break;
                    
                case 'officeEmbednewTab':
                    
                    handleOfficeEmbedNewTab(docUrl);
                    break;
                    
                case 'download':
                    
                    link.click();
                    break;
                    
                case 'modal':
                default:
                    
                    if (docType === 'pdf') {
                        await handlePdfPreview(docUrl, docTitle);
                    } else {
                        
                        openModal();
                        
                        const iframe = document.createElement('iframe');
                        iframe.src = docUrl;
                        iframe.className = 'pdf-container';
                        iframe.title = docTitle;
                        previewContainer.appendChild(iframe);
                    }
                    break;
            }
        });
    });


    
    closeModalBtn.addEventListener('click', closeModal);
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });


    
    updateSearchUI();
});
</script>


    <footer class="article-footer">
    <section>
        页面浏览量<span id="busuanzi_value_page_pv">Loading</span>
    </section>
</footer>


    
</article>

<div class="post-password">
	
</div>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E7%BD%97%E6%B0%8Fe601-c082da15b5/">
        
        
            <div class="article-image">
                
                    <img src="/img/title.jpg" loading="lazy" data-key="罗氏E601 c082da15b5" data-hash="/img/title.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">罗氏E601</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/">
        
        
            <div class="article-image">
                <img src="/p/%E7%BD%97%E6%B0%8F%E6%B5%81%E6%B0%B4%E7%BA%BFrs600-c224e76cd4/assets/image-20230713171820668-20250317141249-oljkc64.cc576c26b4a865aa2936d4ebc458063a_hu_7ccff2713510a167.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 罗氏流水线RS600"
                        data-key="罗氏流水线RS600 c224e76cd4" 
                        data-hash="md5-zFdsJrSoZaopNtTrxFgGOg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">罗氏流水线RS600</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%B8%9C%E8%8A%9Dtba-fx8-b8432f890a/">
        
        
            <div class="article-image">
                <img src="/p/%E4%B8%9C%E8%8A%9Dtba-fx8-b8432f890a/assets/87deac1ff37cce38e2e4f082839b3b41-20250821171124-ncnt2un.d17316f3a6574c24357d46e73c6629e0_hu_716f411378cd479d.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 东芝TBA-FX8"
                        data-key="东芝TBA-FX8 b8432f890a" 
                        data-hash="md5-0XMW86ZXTCQ1fUbnPGYp4A==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">东芝TBA-FX8</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%B8%87%E6%B3%B0wan200-da9f234969/">
        
        
            <div class="article-image">
                
                    <img src="/img/title.jpg" loading="lazy" data-key="万泰WAN200 da9f234969" data-hash="/img/title.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">万泰WAN200</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%B8%AD%E5%85%83%E5%B0%BF%E6%9C%BA1600-fe923b78ec/">
        
        
            <div class="article-image">
                
                    <img src="/img/title.jpg" loading="lazy" data-key="中元尿机1600 fe923b78ec" data-hash="/img/title.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">中元尿机1600</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo"],"lang":"zh-CN","locale":{"admin":"Admin","placeholder":null},"requiredMeta":["name","email","url"],"serverURL":"https://waline.717170.xyz"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 muziyang
    </section>
    
    <section class="powerby">
        
            网站总访客数：<span id='busuanzi_value_site_uv'>Loading</span><br/>网站总访问量：<span id='busuanzi_value_site_pv'>Loading</span> <br/>
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.bb1eaf11044be5d45e9944395f8f492bb3f7541cae00b1624d206eac7546462c.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<style>
  
    
    
    
    
    
    
      
      
      
        
          
          
            @font-face {
              font-family: 'Jnbbh jnbbhbold fontFont Jnbbh jnbbhbold fontFont';
              src: url(https://work.717170.xyz/font/JNBBH/JNBBHBold.ttf) format('truetype');
              font-weight: 700;
              font-style: italic;
            }
          
        
      

      :root {
        
          
            --base-font-family: 'Jnbbh jnbbhbold fontFont Jnbbh jnbbhbold fontFont', sans-serif;
            --code-font-family: 'Jnbbh jnbbhbold fontFont Jnbbh jnbbhbold fontFont', monospace;
          
        
      }
    
  
  
  
</style>




  
  
    
    
    
    
    

    
    
      
      
      
        
      
    

    
    
      
    

    
      <style>
        body {
          background-image: url(https://work.717170.xyz/background/img/%E4%B8%AD%E5%9B%BD%E9%A3%8E%E6%B0%B4%E5%A2%A8%E5%B1%B1%E6%B0%B4%E9%A3%9E%E9%B8%9F%E8%83%8C%E6%99%AF.gif);
          background-repeat: no-repeat;
          background-position: center top;
          background-size: cover;
          
            background-attachment: fixed;
          
        }
      </style>
    
  

    
    
	



  
    
      <div id="particles-js"></div>
      <script src=https://work.717170.xyz/background/particles.min.js></script>
      <script>
        particlesJS.load('particles-js', "https://work.717170.xyz/background/particlesjs-config.json", function() {
          console.log('particles.js loaded - callback');
        });
      </script>
      <style>
        #particles-js {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: -1;
          pointer-events: none;
        }
        
        .main-content {
          position: relative;
          z-index: 1;
        }
      </style>
    
  


<script defer src="https://cn.vercount.one/js"></script>

    </body>
</html>
